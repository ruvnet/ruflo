{"version":3,"sources":["../../../../src/mcp/recovery/connection-state-manager.ts"],"sourcesContent":["/**\r\n * Connection State Manager for MCP\r\n * Persists connection state across disconnections\r\n */\r\n\r\nimport { promises as fs } from 'node:fs';\r\nimport { join } from 'node:path';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport type { MCPRequest, MCPConfig } from '../../utils/types.js';\r\n\r\nexport interface ConnectionState {\r\n  sessionId: string;\r\n  lastConnected: Date;\r\n  lastDisconnected?: Date;\r\n  pendingRequests: MCPRequest[];\r\n  configuration: MCPConfig;\r\n  metadata: Record<string, unknown>;\r\n}\r\n\r\nexport interface ConnectionEvent {\r\n  timestamp: Date;\r\n  type: 'connect' | 'disconnect' | 'reconnect' | 'error';\r\n  sessionId: string;\r\n  details?: Record<string, unknown>;\r\n  error?: string;\r\n}\r\n\r\nexport interface ConnectionMetrics {\r\n  totalConnections: number;\r\n  totalDisconnections: number;\r\n  totalReconnections: number;\r\n  averageSessionDuration: number;\r\n  averageReconnectionTime: number;\r\n  lastConnectionDuration?: number;\r\n  connectionHistory: ConnectionEvent[];\r\n}\r\n\r\nexport interface StateManagerConfig {\r\n  enablePersistence: boolean;\r\n  stateDirectory: string;\r\n  maxHistorySize: number;\r\n  persistenceInterval: number;\r\n}\r\n\r\nexport class ConnectionStateManager {\r\n  private currentState?: ConnectionState;\r\n  private connectionHistory: ConnectionEvent[] = [];\r\n  private metrics: ConnectionMetrics = {\r\n    totalConnections: 0,\r\n    totalDisconnections: 0,\r\n    totalReconnections: 0,\r\n    averageSessionDuration: 0,\r\n    averageReconnectionTime: 0,\r\n    connectionHistory: [],\r\n  };\r\n\r\n  private persistenceTimer?: NodeJS.Timeout;\r\n  private statePath: string;\r\n  private metricsPath: string;\r\n\r\n  private readonly defaultConfig: StateManagerConfig = {\r\n    enablePersistence: true,\r\n    stateDirectory: '.mcp-state',\r\n    maxHistorySize: 1000,\r\n    persistenceInterval: 60000, // 1 minute\r\n  };\r\n\r\n  constructor(\r\n    private logger: ILogger,\r\n    config?: Partial<StateManagerConfig>,\r\n  ) {\r\n    this.config = { ...this.defaultConfig, ...config };\r\n\r\n    this.statePath = join(this.config.stateDirectory, 'connection-state.json');\r\n    this.metricsPath = join(this.config.stateDirectory, 'connection-metrics.json');\r\n\r\n    this.initialize().catch((error) => {\r\n      this.logger.error('Failed to initialize state manager', error);\r\n    });\r\n  }\r\n\r\n  private config: StateManagerConfig;\r\n\r\n  /**\r\n   * Initialize the state manager\r\n   */\r\n  private async initialize(): Promise<void> {\r\n    if (!this.config.enablePersistence) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Ensure state directory exists\r\n      await fs.mkdir(this.config.stateDirectory, { recursive: true });\r\n\r\n      // Load existing state\r\n      await this.loadState();\r\n      await this.loadMetrics();\r\n\r\n      // Start persistence timer\r\n      this.startPersistenceTimer();\r\n\r\n      this.logger.info('Connection state manager initialized', {\r\n        stateDirectory: this.config.stateDirectory,\r\n      });\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize state manager', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Save current connection state\r\n   */\r\n  saveState(state: ConnectionState): void {\r\n    this.currentState = {\r\n      ...state,\r\n      metadata: {\r\n        ...state.metadata,\r\n        lastSaved: new Date().toISOString(),\r\n      },\r\n    };\r\n\r\n    this.logger.debug('Connection state saved', {\r\n      sessionId: state.sessionId,\r\n      pendingRequests: state.pendingRequests.length,\r\n    });\r\n\r\n    // Persist immediately if critical\r\n    if (state.pendingRequests.length > 0) {\r\n      this.persistState().catch((error) => {\r\n        this.logger.error('Failed to persist critical state', error);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restore previous connection state\r\n   */\r\n  restoreState(): ConnectionState | null {\r\n    if (!this.currentState) {\r\n      this.logger.debug('No state to restore');\r\n      return null;\r\n    }\r\n\r\n    this.logger.info('Restoring connection state', {\r\n      sessionId: this.currentState.sessionId,\r\n      pendingRequests: this.currentState.pendingRequests.length,\r\n    });\r\n\r\n    return { ...this.currentState };\r\n  }\r\n\r\n  /**\r\n   * Record a connection event\r\n   */\r\n  recordEvent(event: Omit<ConnectionEvent, 'timestamp'>): void {\r\n    const fullEvent: ConnectionEvent = {\r\n      ...event,\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    this.connectionHistory.push(fullEvent);\r\n\r\n    // Trim history if needed\r\n    if (this.connectionHistory.length > this.config.maxHistorySize) {\r\n      this.connectionHistory = this.connectionHistory.slice(-this.config.maxHistorySize);\r\n    }\r\n\r\n    // Update metrics\r\n    this.updateMetrics(fullEvent);\r\n\r\n    this.logger.debug('Connection event recorded', {\r\n      type: event.type,\r\n      sessionId: event.sessionId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get connection metrics\r\n   */\r\n  getMetrics(): ConnectionMetrics {\r\n    return {\r\n      ...this.metrics,\r\n      connectionHistory: [...this.connectionHistory],\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear a specific session state\r\n   */\r\n  clearSession(sessionId: string): void {\r\n    if (this.currentState?.sessionId === sessionId) {\r\n      this.currentState = undefined;\r\n\r\n      this.logger.info('Session state cleared', { sessionId });\r\n\r\n      this.persistState().catch((error) => {\r\n        this.logger.error('Failed to persist cleared state', error);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a pending request\r\n   */\r\n  addPendingRequest(request: MCPRequest): void {\r\n    if (!this.currentState) {\r\n      this.logger.warn('No active state to add pending request');\r\n      return;\r\n    }\r\n\r\n    this.currentState.pendingRequests.push(request);\r\n\r\n    this.logger.debug('Pending request added', {\r\n      requestId: request.id,\r\n      method: request.method,\r\n      total: this.currentState.pendingRequests.length,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove a pending request\r\n   */\r\n  removePendingRequest(requestId: string): void {\r\n    if (!this.currentState) {\r\n      return;\r\n    }\r\n\r\n    this.currentState.pendingRequests = this.currentState.pendingRequests.filter(\r\n      (req) => req.id !== requestId,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get pending requests\r\n   */\r\n  getPendingRequests(): MCPRequest[] {\r\n    return this.currentState?.pendingRequests || [];\r\n  }\r\n\r\n  /**\r\n   * Update session metadata\r\n   */\r\n  updateMetadata(metadata: Record<string, unknown>): void {\r\n    if (!this.currentState) {\r\n      return;\r\n    }\r\n\r\n    this.currentState.metadata = {\r\n      ...this.currentState.metadata,\r\n      ...metadata,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculate session duration\r\n   */\r\n  getSessionDuration(sessionId: string): number | null {\r\n    const connectEvent = this.connectionHistory.find(\r\n      (e) => e.sessionId === sessionId && e.type === 'connect',\r\n    );\r\n\r\n    const disconnectEvent = this.connectionHistory.find(\r\n      (e) => e.sessionId === sessionId && e.type === 'disconnect',\r\n    );\r\n\r\n    if (!connectEvent) {\r\n      return null;\r\n    }\r\n\r\n    const endTime = disconnectEvent ? disconnectEvent.timestamp : new Date();\r\n    return endTime.getTime() - connectEvent.timestamp.getTime();\r\n  }\r\n\r\n  /**\r\n   * Get reconnection time for a session\r\n   */\r\n  getReconnectionTime(sessionId: string): number | null {\r\n    const disconnectEvent = this.connectionHistory.find(\r\n      (e) => e.sessionId === sessionId && e.type === 'disconnect',\r\n    );\r\n\r\n    const reconnectEvent = this.connectionHistory.find(\r\n      (e) =>\r\n        e.sessionId === sessionId &&\r\n        e.type === 'reconnect' &&\r\n        e.timestamp > (disconnectEvent?.timestamp || new Date(0)),\r\n    );\r\n\r\n    if (!disconnectEvent || !reconnectEvent) {\r\n      return null;\r\n    }\r\n\r\n    return reconnectEvent.timestamp.getTime() - disconnectEvent.timestamp.getTime();\r\n  }\r\n\r\n  private updateMetrics(event: ConnectionEvent): void {\r\n    switch (event.type) {\r\n      case 'connect':\r\n        this.metrics.totalConnections++;\r\n        break;\r\n\r\n      case 'disconnect':\r\n        this.metrics.totalDisconnections++;\r\n\r\n        // Calculate session duration\r\n        const duration = this.getSessionDuration(event.sessionId);\r\n        if (duration !== null) {\r\n          this.metrics.lastConnectionDuration = duration;\r\n\r\n          // Update average\r\n          const totalDuration =\r\n            this.metrics.averageSessionDuration * (this.metrics.totalDisconnections - 1) + duration;\r\n          this.metrics.averageSessionDuration = totalDuration / this.metrics.totalDisconnections;\r\n        }\r\n        break;\r\n\r\n      case 'reconnect':\r\n        this.metrics.totalReconnections++;\r\n\r\n        // Calculate reconnection time\r\n        const reconnectTime = this.getReconnectionTime(event.sessionId);\r\n        if (reconnectTime !== null) {\r\n          // Update average\r\n          const totalTime =\r\n            this.metrics.averageReconnectionTime * (this.metrics.totalReconnections - 1) +\r\n            reconnectTime;\r\n          this.metrics.averageReconnectionTime = totalTime / this.metrics.totalReconnections;\r\n        }\r\n        break;\r\n    }\r\n  }\r\n\r\n  private async loadState(): Promise<void> {\r\n    try {\r\n      const data = await fs.readFile(this.statePath, 'utf-8');\r\n      const state = JSON.parse(data);\r\n\r\n      // Convert date strings back to Date objects\r\n      state.lastConnected = new Date(state.lastConnected);\r\n      if (state.lastDisconnected) {\r\n        state.lastDisconnected = new Date(state.lastDisconnected);\r\n      }\r\n\r\n      this.currentState = state;\r\n\r\n      this.logger.info('Connection state loaded', {\r\n        sessionId: state.sessionId,\r\n        pendingRequests: state.pendingRequests.length,\r\n      });\r\n    } catch (error) {\r\n      if ((error as any).code !== 'ENOENT') {\r\n        this.logger.error('Failed to load connection state', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async loadMetrics(): Promise<void> {\r\n    try {\r\n      const data = await fs.readFile(this.metricsPath, 'utf-8');\r\n      const loaded = JSON.parse(data);\r\n\r\n      // Convert date strings back to Date objects\r\n      loaded.connectionHistory = loaded.connectionHistory.map((event: any) => ({\r\n        ...event,\r\n        timestamp: new Date(event.timestamp),\r\n      }));\r\n\r\n      this.metrics = loaded;\r\n      this.connectionHistory = loaded.connectionHistory;\r\n\r\n      this.logger.info('Connection metrics loaded', {\r\n        totalConnections: this.metrics.totalConnections,\r\n        historySize: this.connectionHistory.length,\r\n      });\r\n    } catch (error) {\r\n      if ((error as any).code !== 'ENOENT') {\r\n        this.logger.error('Failed to load connection metrics', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async persistState(): Promise<void> {\r\n    if (!this.config.enablePersistence) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (this.currentState) {\r\n        await fs.writeFile(this.statePath, JSON.stringify(this.currentState, null, 2), 'utf-8');\r\n      }\r\n\r\n      // Also persist metrics\r\n      await fs.writeFile(\r\n        this.metricsPath,\r\n        JSON.stringify(\r\n          {\r\n            ...this.metrics,\r\n            connectionHistory: this.connectionHistory,\r\n          },\r\n          null,\r\n          2,\r\n        ),\r\n        'utf-8',\r\n      );\r\n\r\n      this.logger.debug('State and metrics persisted');\r\n    } catch (error) {\r\n      this.logger.error('Failed to persist state', error);\r\n    }\r\n  }\r\n\r\n  private startPersistenceTimer(): void {\r\n    if (this.persistenceTimer) {\r\n      return;\r\n    }\r\n\r\n    this.persistenceTimer = setInterval(() => {\r\n      this.persistState().catch((error) => {\r\n        this.logger.error('Periodic persistence failed', error);\r\n      });\r\n    }, this.config.persistenceInterval);\r\n  }\r\n\r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  async cleanup(): Promise<void> {\r\n    if (this.persistenceTimer) {\r\n      clearInterval(this.persistenceTimer);\r\n      this.persistenceTimer = undefined;\r\n    }\r\n\r\n    // Final persistence\r\n    await this.persistState();\r\n  }\r\n}\r\n"],"names":["promises","fs","join","ConnectionStateManager","currentState","connectionHistory","metrics","totalConnections","totalDisconnections","totalReconnections","averageSessionDuration","averageReconnectionTime","persistenceTimer","statePath","metricsPath","defaultConfig","enablePersistence","stateDirectory","maxHistorySize","persistenceInterval","logger","config","initialize","catch","error","mkdir","recursive","loadState","loadMetrics","startPersistenceTimer","info","saveState","state","metadata","lastSaved","Date","toISOString","debug","sessionId","pendingRequests","length","persistState","restoreState","recordEvent","event","fullEvent","timestamp","push","slice","updateMetrics","type","getMetrics","clearSession","undefined","addPendingRequest","request","warn","requestId","id","method","total","removePendingRequest","filter","req","getPendingRequests","updateMetadata","getSessionDuration","connectEvent","find","e","disconnectEvent","endTime","getTime","getReconnectionTime","reconnectEvent","duration","lastConnectionDuration","totalDuration","reconnectTime","totalTime","data","readFile","JSON","parse","lastConnected","lastDisconnected","code","loaded","map","historySize","writeFile","stringify","setInterval","cleanup","clearInterval"],"mappings":"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"}
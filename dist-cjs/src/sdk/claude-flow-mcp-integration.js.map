{"version":3,"sources":["../../../src/sdk/claude-flow-mcp-integration.ts"],"sourcesContent":["/**\r\n * Claude Flow MCP Integration - SDK + Existing MCP Tools\r\n * Claude-Flow v2.5-alpha.130+\r\n *\r\n * Integrates SDK-powered features WITH existing Claude Flow MCP tools:\r\n * - Uses SDK for session management, forking, checkpoints\r\n * - Uses Claude Flow MCP tools for swarm coordination, neural features\r\n * - Combines both for maximum power\r\n *\r\n * VERIFIED: Real integration of SDK + MCP tools\r\n */\r\n\r\nimport { query, type Query, type Options } from '@anthropic-ai/claude-code';\r\nimport { RealSessionForking } from './session-forking';\r\nimport { RealQueryController } from './query-control';\r\nimport { RealCheckpointManager } from './checkpoint-manager';\r\nimport {\r\n  createMathMcpServer,\r\n  createSessionMcpServer,\r\n  createCheckpointMcpServer,\r\n  createQueryControlMcpServer,\r\n} from './in-process-mcp';\r\n\r\n/**\r\n * Integration Configuration\r\n */\r\nexport interface ClaudeFlowIntegrationConfig {\r\n  // SDK features\r\n  enableSessionForking?: boolean;\r\n  enableQueryControl?: boolean;\r\n  enableCheckpoints?: boolean;\r\n  checkpointInterval?: number;\r\n\r\n  // MCP tool configuration\r\n  mcpToolsConfig?: {\r\n    swarmTopology?: 'hierarchical' | 'mesh' | 'ring' | 'star';\r\n    maxAgents?: number;\r\n    enableNeural?: boolean;\r\n    enableMemory?: boolean;\r\n  };\r\n\r\n  // In-process MCP servers\r\n  inProcessServers?: {\r\n    math?: boolean;\r\n    session?: boolean;\r\n    checkpoint?: boolean;\r\n    queryControl?: boolean;\r\n  };\r\n}\r\n\r\n/**\r\n * Integrated Claude Flow Session\r\n *\r\n * Combines SDK features with Claude Flow MCP tools\r\n */\r\nexport class IntegratedClaudeFlowSession {\r\n  private forking?: RealSessionForking;\r\n  private controller?: RealQueryController;\r\n  private checkpointManager?: RealCheckpointManager;\r\n  private config: ClaudeFlowIntegrationConfig;\r\n\r\n  constructor(config: ClaudeFlowIntegrationConfig = {}) {\r\n    this.config = config;\r\n\r\n    // Initialize SDK features based on config\r\n    if (config.enableSessionForking) {\r\n      this.forking = new RealSessionForking();\r\n    }\r\n\r\n    if (config.enableQueryControl) {\r\n      this.controller = new RealQueryController();\r\n    }\r\n\r\n    if (config.enableCheckpoints) {\r\n      this.checkpointManager = new RealCheckpointManager({\r\n        autoCheckpointInterval: config.checkpointInterval || 10,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a query that uses BOTH SDK features AND Claude Flow MCP tools\r\n   */\r\n  async createIntegratedQuery(\r\n    prompt: string,\r\n    sessionId: string,\r\n    options: Partial<Options> = {}\r\n  ): Promise<Query> {\r\n    // Build MCP servers configuration\r\n    const mcpServers: Record<string, any> = {};\r\n\r\n    // Add in-process servers if enabled\r\n    if (this.config.inProcessServers?.math) {\r\n      mcpServers.math = createMathMcpServer();\r\n    }\r\n    if (this.config.inProcessServers?.session) {\r\n      mcpServers.session = createSessionMcpServer();\r\n    }\r\n    if (this.config.inProcessServers?.checkpoint) {\r\n      mcpServers.checkpoint = createCheckpointMcpServer();\r\n    }\r\n    if (this.config.inProcessServers?.queryControl) {\r\n      mcpServers.queryControl = createQueryControlMcpServer();\r\n    }\r\n\r\n    // Add Claude Flow MCP tools (these use stdio/subprocess)\r\n    // The MCP server is already configured globally via `claude mcp add claude-flow`\r\n    // So we don't need to add it here - it's automatically available\r\n\r\n    // Create the query\r\n    const integratedQuery = query({\r\n      prompt,\r\n      options: {\r\n        ...options,\r\n        mcpServers: Object.keys(mcpServers).length > 0 ? mcpServers : undefined,\r\n      },\r\n    });\r\n\r\n    // Track with SDK features\r\n    if (this.forking) {\r\n      await this.forking.trackSession(sessionId, integratedQuery);\r\n    }\r\n\r\n    if (this.checkpointManager && this.config.enableCheckpoints) {\r\n      await this.checkpointManager.trackSession(\r\n        sessionId,\r\n        integratedQuery,\r\n        true // Auto-checkpoint\r\n      );\r\n    }\r\n\r\n    return integratedQuery;\r\n  }\r\n\r\n  /**\r\n   * Fork a session (SDK) while using Claude Flow MCP tools for coordination\r\n   */\r\n  async forkWithMcpCoordination(\r\n    baseSessionId: string,\r\n    forkDescription: string\r\n  ) {\r\n    if (!this.forking) {\r\n      throw new Error('Session forking not enabled');\r\n    }\r\n\r\n    // Fork using SDK\r\n    const fork = await this.forking.fork(baseSessionId, {\r\n      // In-process servers are inherited\r\n    });\r\n\r\n    // Create checkpoint for fork point\r\n    if (this.checkpointManager) {\r\n      await this.checkpointManager.createCheckpoint(\r\n        baseSessionId,\r\n        `Fork created: ${forkDescription}`\r\n      );\r\n    }\r\n\r\n    return fork;\r\n  }\r\n\r\n  /**\r\n   * Pause a query (SDK) and create checkpoint\r\n   */\r\n  async pauseWithCheckpoint(\r\n    activeQuery: Query,\r\n    sessionId: string,\r\n    originalPrompt: string,\r\n    checkpointDescription: string\r\n  ) {\r\n    if (!this.controller) {\r\n      throw new Error('Query control not enabled');\r\n    }\r\n\r\n    // Request pause\r\n    this.controller.requestPause(sessionId);\r\n\r\n    // Pause query\r\n    const pausePointId = await this.controller.pauseQuery(\r\n      activeQuery,\r\n      sessionId,\r\n      originalPrompt,\r\n      {}\r\n    );\r\n\r\n    // Create checkpoint at pause point\r\n    if (this.checkpointManager) {\r\n      await this.checkpointManager.createCheckpoint(\r\n        sessionId,\r\n        checkpointDescription || `Paused at ${pausePointId}`\r\n      );\r\n    }\r\n\r\n    return pausePointId;\r\n  }\r\n\r\n  /**\r\n   * Resume from checkpoint\r\n   */\r\n  async resumeFromCheckpoint(checkpointId: string, continuePrompt?: string) {\r\n    if (!this.checkpointManager) {\r\n      throw new Error('Checkpoints not enabled');\r\n    }\r\n\r\n    // Rollback to checkpoint using SDK\r\n    return await this.checkpointManager.rollbackToCheckpoint(\r\n      checkpointId,\r\n      continuePrompt\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get comprehensive metrics\r\n   */\r\n  getMetrics() {\r\n    return {\r\n      queryControl: this.controller?.getMetrics(),\r\n      activeSessions: this.forking?.getActiveSessions(),\r\n      checkpoints: this.checkpointManager\r\n        ? {\r\n            // Would need to track total checkpoints across sessions\r\n            enabled: true,\r\n          }\r\n        : { enabled: false },\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Example: Use Claude Flow MCP tools WITH SDK features\r\n */\r\nexport async function exampleClaudeFlowMcpWithSdk() {\r\n  const session = new IntegratedClaudeFlowSession({\r\n    enableSessionForking: true,\r\n    enableQueryControl: true,\r\n    enableCheckpoints: true,\r\n    checkpointInterval: 10,\r\n    mcpToolsConfig: {\r\n      swarmTopology: 'mesh',\r\n      maxAgents: 8,\r\n      enableNeural: true,\r\n      enableMemory: true,\r\n    },\r\n    inProcessServers: {\r\n      math: true,\r\n      session: true,\r\n      checkpoint: true,\r\n      queryControl: true,\r\n    },\r\n  });\r\n\r\n  // Create query that uses BOTH:\r\n  // - In-process MCP servers (SDK)\r\n  // - Claude Flow MCP tools (stdio)\r\n  const mainQuery = await session.createIntegratedQuery(\r\n    `\r\n    Initialize a mesh swarm with 8 agents using Claude Flow MCP tools.\r\n    Then use the math MCP server to calculate factorial of 10.\r\n    Store results in session and create a checkpoint.\r\n    `,\r\n    'integrated-session',\r\n    {}\r\n  );\r\n\r\n  console.log('Created integrated query with:');\r\n  console.log('- SDK: Session forking, checkpoints, query control');\r\n  console.log('- In-process MCP: math, session, checkpoint, queryControl');\r\n  console.log('- Claude Flow MCP tools: swarm_init, agent_spawn, etc.');\r\n\r\n  // Fork the session to try different approaches\r\n  const fork1 = await session.forkWithMcpCoordination(\r\n    'integrated-session',\r\n    'Try hierarchical topology'\r\n  );\r\n\r\n  console.log('Forked session:', fork1.sessionId);\r\n\r\n  // Create checkpoint before major changes\r\n  if (session['checkpointManager']) {\r\n    const cp = await session['checkpointManager'].createCheckpoint(\r\n      'integrated-session',\r\n      'Before swarm initialization'\r\n    );\r\n    console.log('Checkpoint created:', cp);\r\n  }\r\n\r\n  // Get metrics\r\n  const metrics = session.getMetrics();\r\n  console.log('Metrics:', metrics);\r\n}\r\n\r\n/**\r\n * NPX Command Integration\r\n *\r\n * Show how to use Claude Flow NPX commands with SDK features\r\n */\r\nexport function exampleNpxIntegration() {\r\n  console.log(`\r\n╔════════════════════════════════════════════════════════════╗\r\n║  Claude Flow NPX + SDK Integration                         ║\r\n╚════════════════════════════════════════════════════════════╝\r\n\r\n# Install Claude Flow MCP server\r\nclaude mcp add claude-flow npx claude-flow@alpha mcp start\r\n\r\n# Optional: Add ruv-swarm for enhanced coordination\r\nclaude mcp add ruv-swarm npx ruv-swarm mcp start\r\n\r\n# Now use SDK features WITH MCP tools:\r\n\r\n## 1. Session Forking + Swarm Coordination\r\nimport { query } from '@anthropic-ai/claude-code';\r\nimport { RealSessionForking } from './sdk/session-forking';\r\n\r\nconst forking = new RealSessionForking();\r\nconst q = query({\r\n  prompt: 'Use mcp__claude-flow__swarm_init to create mesh topology',\r\n  options: {\r\n    // MCP tools are auto-available via 'claude mcp add'\r\n  }\r\n});\r\n\r\nawait forking.trackSession('swarm-session', q);\r\nconst fork = await forking.fork('swarm-session');\r\n\r\n## 2. Checkpoints + Neural Training\r\nimport { RealCheckpointManager } from './sdk/checkpoint-manager';\r\n\r\nconst manager = new RealCheckpointManager();\r\nconst q = query({\r\n  prompt: 'Use mcp__claude-flow__neural_train to train patterns',\r\n});\r\n\r\nawait manager.trackSession('neural-session', q, true);\r\nconst cp = await manager.createCheckpoint('neural-session', 'Before training');\r\n\r\n// Train neural patterns with Claude Flow MCP\r\n// Then rollback if needed:\r\nawait manager.rollbackToCheckpoint(cp);\r\n\r\n## 3. Query Control + Task Orchestration\r\nimport { RealQueryController } from './sdk/query-control';\r\n\r\nconst controller = new RealQueryController();\r\nconst q = query({\r\n  prompt: \\`\r\n    Use mcp__claude-flow__task_orchestrate to:\r\n    - Break down complex task\r\n    - Distribute to agents\r\n    - Monitor progress\r\n  \\`,\r\n});\r\n\r\n// Pause if needed\r\ncontroller.requestPause('task-session');\r\nconst pauseId = await controller.pauseQuery(q, 'task-session', 'Task', {});\r\n\r\n// Resume later\r\nconst resumed = await controller.resumeQuery('task-session');\r\n\r\n## 4. In-Process MCP + Claude Flow MCP Together\r\nimport { createMathMcpServer } from './sdk/in-process-mcp';\r\n\r\nconst q = query({\r\n  prompt: \\`\r\n    Use math server to calculate factorial.\r\n    Use mcp__claude-flow__memory_usage to store result.\r\n    Use mcp__claude-flow__agent_spawn to process result.\r\n  \\`,\r\n  options: {\r\n    mcpServers: {\r\n      math: createMathMcpServer(), // In-process (fast!)\r\n      // claude-flow MCP tools auto-available\r\n    }\r\n  }\r\n});\r\n\r\n╔════════════════════════════════════════════════════════════╗\r\n║  Key Benefits:                                             ║\r\n║  ✅ SDK = In-process, zero overhead                       ║\r\n║  ✅ MCP tools = Coordination, neural, swarms              ║\r\n║  ✅ Together = Maximum power and flexibility              ║\r\n╚════════════════════════════════════════════════════════════╝\r\n  `);\r\n}\r\n\r\nexport { IntegratedClaudeFlowSession };\r\n"],"names":["query","RealSessionForking","RealQueryController","RealCheckpointManager","createMathMcpServer","createSessionMcpServer","createCheckpointMcpServer","createQueryControlMcpServer","IntegratedClaudeFlowSession","forking","controller","checkpointManager","config","enableSessionForking","enableQueryControl","enableCheckpoints","autoCheckpointInterval","checkpointInterval","createIntegratedQuery","prompt","sessionId","options","mcpServers","inProcessServers","math","session","checkpoint","queryControl","integratedQuery","Object","keys","length","undefined","trackSession","forkWithMcpCoordination","baseSessionId","forkDescription","Error","fork","createCheckpoint","pauseWithCheckpoint","activeQuery","originalPrompt","checkpointDescription","requestPause","pausePointId","pauseQuery","resumeFromCheckpoint","checkpointId","continuePrompt","rollbackToCheckpoint","getMetrics","activeSessions","getActiveSessions","checkpoints","enabled","exampleClaudeFlowMcpWithSdk","mcpToolsConfig","swarmTopology","maxAgents","enableNeural","enableMemory","mainQuery","console","log","fork1","cp","metrics","exampleNpxIntegration"],"mappings":"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"}
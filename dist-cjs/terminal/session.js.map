{
  "version": 3,
  "sources": ["../../src/terminal/session.ts"],
  "sourcesContent": ["/**\n * Terminal session management\n */\n\nimport type { Terminal } from './adapters/base.js';\nimport type { AgentProfile } from '../utils/types.js';\nimport type { ILogger } from '../core/logger.js';\nimport { TerminalCommandError } from '../utils/errors.js';\nimport { generateId, timeout } from '../utils/helpers.js';\n\n/**\n * Terminal session wrapper\n */\nexport class TerminalSession {\n  readonly id: string;\n  readonly startTime: Date;\n  private initialized = false;\n  private commandHistory: string[] = [];\n  private lastCommandTime?: Date;\n  private outputListeners = new Set<(output: string) => void>();\n\n  constructor(\n    public readonly terminal: Terminal,\n    public readonly profile: AgentProfile,\n    private commandTimeout: number,\n    private logger: ILogger,\n  ) {\n    this.id = generateId('session');\n    this.startTime = new Date();\n  }\n\n  get lastActivity(): Date {\n    return this.lastCommandTime || this.startTime;\n  }\n\n  async initialize(): Promise<void> {\n    if (this.initialized) {\n      return;\n    }\n\n    this.logger.debug('Initializing terminal session', {\n      sessionId: this.id,\n      agentId: this.profile.id,\n    });\n\n    try {\n      // Set up environment\n      await this.setupEnvironment();\n\n      // Run initialization commands\n      await this.runInitializationCommands();\n\n      this.initialized = true;\n\n      this.logger.info('Terminal session initialized', {\n        sessionId: this.id,\n        agentId: this.profile.id,\n      });\n    } catch (error) {\n      this.logger.error('Failed to initialize terminal session', error);\n      throw error;\n    }\n  }\n\n  async executeCommand(command: string): Promise<string> {\n    if (!this.initialized) {\n      throw new TerminalCommandError('Session not initialized');\n    }\n\n    if (!this.terminal.isAlive()) {\n      throw new TerminalCommandError('Terminal is not alive');\n    }\n\n    this.logger.debug('Executing command', {\n      sessionId: this.id,\n      command: command.substring(0, 100),\n    });\n\n    try {\n      // Notify listeners of command\n      this.notifyOutputListeners(`$ ${command}\\n`);\n\n      // Execute with timeout\n      const result = await timeout(\n        this.terminal.executeCommand(command),\n        this.commandTimeout,\n        `Command timeout after ${this.commandTimeout}ms`,\n      );\n\n      // Notify listeners of output\n      this.notifyOutputListeners(result);\n\n      // Update history\n      this.commandHistory.push(command);\n      this.lastCommandTime = new Date();\n\n      this.logger.debug('Command executed successfully', {\n        sessionId: this.id,\n        outputLength: result.length,\n      });\n\n      return result;\n    } catch (error) {\n      this.logger.error('Command execution failed', {\n        sessionId: this.id,\n        command,\n        error,\n      });\n      throw new TerminalCommandError('Command execution failed', {\n        command,\n        error,\n      });\n    }\n  }\n\n  async cleanup(): Promise<void> {\n    this.logger.debug('Cleaning up terminal session', { sessionId: this.id });\n\n    try {\n      // Run cleanup commands\n      await this.runCleanupCommands();\n    } catch (error) {\n      this.logger.warn('Error during session cleanup', {\n        sessionId: this.id,\n        error,\n      });\n    }\n  }\n\n  isHealthy(): boolean {\n    if (!this.terminal.isAlive()) {\n      return false;\n    }\n\n    // Check if terminal is responsive\n    if (this.lastCommandTime) {\n      const timeSinceLastCommand = Date.now() - this.lastCommandTime.getTime();\n      if (timeSinceLastCommand > 300000) {\n        // 5 minutes\n        // Terminal might be stale, do a health check\n        this.performHealthCheck().catch((error) => {\n          this.logger.warn('Health check failed', { sessionId: this.id, error });\n        });\n      }\n    }\n\n    return true;\n  }\n\n  getCommandHistory(): string[] {\n    return [...this.commandHistory];\n  }\n\n  private async setupEnvironment(): Promise<void> {\n    // Set environment variables\n    const envVars = {\n      CLAUDE_FLOW_SESSION: this.id,\n      CLAUDE_FLOW_AGENT: this.profile.id,\n      CLAUDE_FLOW_AGENT_TYPE: this.profile.type,\n    };\n\n    for (const [key, value] of Object.entries(envVars)) {\n      await this.terminal.executeCommand(`export ${key}=\"${value}\"`);\n    }\n\n    // Set working directory if specified\n    if (this.profile.metadata?.workingDirectory) {\n      await this.terminal.executeCommand(`cd \"${this.profile.metadata.workingDirectory}\"`);\n    }\n  }\n\n  private async runInitializationCommands(): Promise<void> {\n    // Run any profile-specific initialization commands\n    if (this.profile.metadata?.initCommands) {\n      const commands = this.profile.metadata.initCommands as string[];\n      for (const command of commands) {\n        await this.terminal.executeCommand(command);\n      }\n    }\n\n    // Set up command prompt\n    await this.terminal.executeCommand('export PS1=\"[claude-flow]$ \"');\n  }\n\n  private async runCleanupCommands(): Promise<void> {\n    // Run any profile-specific cleanup commands\n    if (this.profile.metadata?.cleanupCommands) {\n      const commands = this.profile.metadata.cleanupCommands as string[];\n      for (const command of commands) {\n        try {\n          await this.terminal.executeCommand(command);\n        } catch {\n          // Ignore cleanup errors\n        }\n      }\n    }\n  }\n\n  private async performHealthCheck(): Promise<void> {\n    try {\n      const result = await timeout(\n        this.terminal.executeCommand('echo \"HEALTH_CHECK_OK\"'),\n        5000,\n        'Health check timeout',\n      );\n\n      if (!result.includes('HEALTH_CHECK_OK')) {\n        throw new Error('Invalid health check response');\n      }\n\n      this.lastCommandTime = new Date();\n    } catch (error) {\n      throw new Error(\n        `Health check failed: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n\n  /**\n   * Stream terminal output\n   */\n  streamOutput(callback: (output: string) => void): () => void {\n    this.outputListeners.add(callback);\n\n    // Set up terminal output listener if supported\n    if (this.terminal.addOutputListener) {\n      this.terminal.addOutputListener(callback);\n    }\n\n    // Return unsubscribe function\n    return () => {\n      this.outputListeners.delete(callback);\n      if (this.terminal.removeOutputListener) {\n        this.terminal.removeOutputListener(callback);\n      }\n    };\n  }\n\n  /**\n   * Notify output listeners\n   */\n  private notifyOutputListeners(output: string): void {\n    this.outputListeners.forEach((listener) => {\n      try {\n        listener(output);\n      } catch (error) {\n        this.logger.error('Error in output listener', { sessionId: this.id, error });\n      }\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

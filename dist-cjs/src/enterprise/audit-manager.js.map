{"version":3,"sources":["../../../src/enterprise/audit-manager.ts"],"sourcesContent":["import { EventEmitter } from 'events';\r\nimport { writeFile, readFile, mkdir, readdir } from 'fs/promises';\r\nimport { join } from 'path';\r\nimport { createHash } from 'crypto';\r\nimport { Logger } from '../core/logger.js';\r\nimport { ConfigManager } from '../core/config.js';\r\n\r\nexport interface AuditEntry {\r\n  id: string;\r\n  timestamp: Date;\r\n  eventType: string;\r\n  category:\r\n    | 'authentication'\r\n    | 'authorization'\r\n    | 'data-access'\r\n    | 'system-change'\r\n    | 'security'\r\n    | 'compliance'\r\n    | 'business';\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  userId?: string;\r\n  sessionId?: string;\r\n  resource: {\r\n    type: string;\r\n    id: string;\r\n    name?: string;\r\n    path?: string;\r\n  };\r\n  action: string;\r\n  outcome: 'success' | 'failure' | 'partial' | 'denied';\r\n  details: Record<string, any>;\r\n  context: {\r\n    ipAddress?: string;\r\n    userAgent?: string;\r\n    location?: string;\r\n    source: string;\r\n    requestId?: string;\r\n  };\r\n  compliance: {\r\n    frameworks: string[];\r\n    controls: string[];\r\n    retention: string;\r\n    classification: 'public' | 'internal' | 'confidential' | 'restricted';\r\n  };\r\n  integrity: {\r\n    hash: string;\r\n    signature?: string;\r\n    verified: boolean;\r\n  };\r\n  metadata: Record<string, any>;\r\n}\r\n\r\nexport interface ComplianceFramework {\r\n  id: string;\r\n  name: string;\r\n  version: string;\r\n  description: string;\r\n  type: 'regulatory' | 'industry' | 'internal' | 'certification';\r\n  requirements: ComplianceRequirement[];\r\n  auditFrequency: 'continuous' | 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'annually';\r\n  retentionPeriod: string;\r\n  reportingRequirements: {\r\n    frequency: string;\r\n    recipients: string[];\r\n    format: string[];\r\n    automated: boolean;\r\n  };\r\n  controls: ComplianceControl[];\r\n  status: 'active' | 'inactive' | 'pending' | 'deprecated';\r\n  implementationDate: Date;\r\n  nextReview: Date;\r\n  responsible: string;\r\n}\r\n\r\nexport interface ComplianceRequirement {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  category: string;\r\n  priority: 'low' | 'medium' | 'high' | 'critical';\r\n  status: 'compliant' | 'non-compliant' | 'partial' | 'not-applicable' | 'pending';\r\n  evidence: string[];\r\n  gaps: string[];\r\n  remediation: {\r\n    actions: string[];\r\n    owner: string;\r\n    dueDate: Date;\r\n    cost?: number;\r\n    effort?: string;\r\n  };\r\n  lastAssessed: Date;\r\n  nextAssessment: Date;\r\n  automatedCheck: {\r\n    enabled: boolean;\r\n    frequency: string;\r\n    query: string;\r\n    threshold?: any;\r\n  };\r\n}\r\n\r\nexport interface ComplianceControl {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  type: 'preventive' | 'detective' | 'corrective' | 'compensating';\r\n  automationType: 'manual' | 'semi-automated' | 'automated';\r\n  effectiveness: 'low' | 'medium' | 'high';\r\n  frequency: string;\r\n  owner: string;\r\n  evidence: string[];\r\n  testingProcedure: string;\r\n  lastTested: Date;\r\n  nextTest: Date;\r\n  status: 'effective' | 'ineffective' | 'needs-improvement' | 'not-tested';\r\n}\r\n\r\nexport interface AuditReport {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  type: 'compliance' | 'security' | 'operational' | 'financial' | 'investigation' | 'custom';\r\n  scope: {\r\n    timeRange: { start: Date; end: Date };\r\n    systems: string[];\r\n    users: string[];\r\n    events: string[];\r\n    compliance: string[];\r\n  };\r\n  findings: AuditFinding[];\r\n  recommendations: AuditRecommendation[];\r\n  summary: {\r\n    totalEvents: number;\r\n    criticalFindings: number;\r\n    complianceScore: number;\r\n    riskLevel: 'low' | 'medium' | 'high' | 'critical';\r\n  };\r\n  methodology: string;\r\n  limitations: string[];\r\n  reviewers: string[];\r\n  approvers: string[];\r\n  status: 'draft' | 'under-review' | 'approved' | 'published' | 'archived';\r\n  confidentiality: 'public' | 'internal' | 'confidential' | 'restricted';\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  createdBy: string;\r\n  publishedAt?: Date;\r\n}\r\n\r\nexport interface AuditFinding {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  category: string;\r\n  risk: string;\r\n  impact: string;\r\n  likelihood: string;\r\n  evidence: AuditEvidence[];\r\n  relatedEvents: string[];\r\n  complianceImpact: {\r\n    frameworks: string[];\r\n    violations: string[];\r\n    penalties?: string[];\r\n  };\r\n  remediation: {\r\n    priority: 'low' | 'medium' | 'high' | 'immediate';\r\n    owner: string;\r\n    actions: string[];\r\n    timeline: string;\r\n    cost?: number;\r\n  };\r\n  status: 'open' | 'in-progress' | 'resolved' | 'accepted-risk' | 'false-positive';\r\n}\r\n\r\nexport interface AuditEvidence {\r\n  id: string;\r\n  type:\r\n    | 'log-entry'\r\n    | 'screenshot'\r\n    | 'document'\r\n    | 'system-output'\r\n    | 'witness-statement'\r\n    | 'data-export';\r\n  description: string;\r\n  source: string;\r\n  timestamp: Date;\r\n  hash: string;\r\n  location: string;\r\n  preservationStatus: 'intact' | 'modified' | 'corrupted' | 'missing';\r\n  chainOfCustody: ChainOfCustodyEntry[];\r\n}\r\n\r\nexport interface ChainOfCustodyEntry {\r\n  timestamp: Date;\r\n  action: 'collected' | 'accessed' | 'analyzed' | 'transferred' | 'stored' | 'destroyed';\r\n  user: string;\r\n  reason: string;\r\n  hash: string;\r\n}\r\n\r\nexport interface AuditRecommendation {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  priority: 'low' | 'medium' | 'high' | 'critical';\r\n  category: 'policy' | 'process' | 'technology' | 'training' | 'governance';\r\n  implementation: {\r\n    effort: 'low' | 'medium' | 'high';\r\n    cost: 'low' | 'medium' | 'high';\r\n    timeline: string;\r\n    dependencies: string[];\r\n    risks: string[];\r\n  };\r\n  expectedBenefit: string;\r\n  owner: string;\r\n  status: 'proposed' | 'approved' | 'in-progress' | 'completed' | 'rejected';\r\n  tracking: {\r\n    milestones: string[];\r\n    progress: number;\r\n    nextReview: Date;\r\n  };\r\n}\r\n\r\nexport interface AuditTrail {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  category: string;\r\n  entries: AuditEntry[];\r\n  configuration: {\r\n    retention: string;\r\n    compression: boolean;\r\n    encryption: boolean;\r\n    archival: {\r\n      enabled: boolean;\r\n      location: string;\r\n      schedule: string;\r\n    };\r\n    monitoring: {\r\n      realTime: boolean;\r\n      alerting: boolean;\r\n      dashboards: string[];\r\n    };\r\n  };\r\n  integrity: {\r\n    verified: boolean;\r\n    lastVerification: Date;\r\n    checksum: string;\r\n    tamperEvidence: TamperEvidence[];\r\n  };\r\n  access: {\r\n    viewers: string[];\r\n    admins: string[];\r\n    readonly: boolean;\r\n    auditAccess: boolean;\r\n  };\r\n  compliance: {\r\n    frameworks: string[];\r\n    retention: string;\r\n    exportRequirements: string[];\r\n    immutable: boolean;\r\n  };\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface TamperEvidence {\r\n  timestamp: Date;\r\n  type: 'checksum-mismatch' | 'unauthorized-access' | 'missing-entries' | 'timestamp-anomaly';\r\n  description: string;\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  investigationStatus: 'pending' | 'investigating' | 'resolved' | 'false-alarm';\r\n  evidence: string[];\r\n}\r\n\r\nexport interface AuditConfiguration {\r\n  general: {\r\n    enabled: boolean;\r\n    defaultRetention: string;\r\n    compressionEnabled: boolean;\r\n    encryptionEnabled: boolean;\r\n    realTimeProcessing: boolean;\r\n  };\r\n  collection: {\r\n    automaticCapture: boolean;\r\n    bufferSize: number;\r\n    batchSize: number;\r\n    flushInterval: number;\r\n    failureHandling: 'ignore' | 'retry' | 'alert' | 'stop';\r\n  };\r\n  storage: {\r\n    primaryLocation: string;\r\n    backupLocation?: string;\r\n    archivalLocation?: string;\r\n    partitioning: 'daily' | 'weekly' | 'monthly';\r\n    indexing: boolean;\r\n  };\r\n  integrity: {\r\n    checksumAlgorithm: 'sha256' | 'sha512' | 'blake2b';\r\n    verificationFrequency: string;\r\n    digitalSignatures: boolean;\r\n    immutableStorage: boolean;\r\n  };\r\n  compliance: {\r\n    frameworks: string[];\r\n    automaticClassification: boolean;\r\n    retentionPolicies: Record<string, string>;\r\n    exportFormats: string[];\r\n  };\r\n  monitoring: {\r\n    alerting: {\r\n      enabled: boolean;\r\n      channels: string[];\r\n      thresholds: {\r\n        failedLogins: number;\r\n        privilegedAccess: number;\r\n        dataExfiltration: number;\r\n        configChanges: number;\r\n      };\r\n    };\r\n    reporting: {\r\n      automated: boolean;\r\n      frequency: string;\r\n      recipients: string[];\r\n      dashboards: string[];\r\n    };\r\n  };\r\n  privacy: {\r\n    piiDetection: boolean;\r\n    anonymization: boolean;\r\n    masking: {\r\n      enabled: boolean;\r\n      patterns: string[];\r\n    };\r\n    consent: {\r\n      required: boolean;\r\n      tracking: boolean;\r\n    };\r\n  };\r\n}\r\n\r\nexport interface AuditMetrics {\r\n  volume: {\r\n    totalEntries: number;\r\n    dailyAverage: number;\r\n    peakHourly: number;\r\n    byCategory: Record<string, number>;\r\n    bySeverity: Record<string, number>;\r\n  };\r\n  compliance: {\r\n    overallScore: number;\r\n    byFramework: Record<\r\n      string,\r\n      {\r\n        score: number;\r\n        compliant: number;\r\n        nonCompliant: number;\r\n        total: number;\r\n      }\r\n    >;\r\n    trending: 'improving' | 'stable' | 'declining';\r\n  };\r\n  integrity: {\r\n    verificationSuccess: number;\r\n    tamperAttempts: number;\r\n    dataLoss: number;\r\n    corruptionEvents: number;\r\n  };\r\n  performance: {\r\n    ingestionRate: number;\r\n    queryResponseTime: number;\r\n    storageEfficiency: number;\r\n    availabilityPercentage: number;\r\n  };\r\n  security: {\r\n    unauthorizedAccess: number;\r\n    privilegedActions: number;\r\n    suspiciousPatterns: number;\r\n    escalatedIncidents: number;\r\n  };\r\n}\r\n\r\nexport class AuditManager extends EventEmitter {\r\n  private auditTrails: Map<string, AuditTrail> = new Map();\r\n  private frameworks: Map<string, ComplianceFramework> = new Map();\r\n  private reports: Map<string, AuditReport> = new Map();\r\n  private auditBuffer: AuditEntry[] = [];\r\n  private auditPath: string;\r\n  private logger: Logger;\r\n  private config: ConfigManager;\r\n  private configuration: AuditConfiguration;\r\n\r\n  constructor(auditPath: string = './audit', logger?: Logger, config?: ConfigManager) {\r\n    super();\r\n    this.auditPath = auditPath;\r\n    this.logger = logger || new Logger({ level: 'info', format: 'text', destination: 'console' });\r\n    this.config = config || ConfigManager.getInstance();\r\n    this.configuration = this.getDefaultConfiguration();\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    try {\r\n      await mkdir(this.auditPath, { recursive: true });\r\n      await mkdir(join(this.auditPath, 'trails'), { recursive: true });\r\n      await mkdir(join(this.auditPath, 'frameworks'), { recursive: true });\r\n      await mkdir(join(this.auditPath, 'reports'), { recursive: true });\r\n      await mkdir(join(this.auditPath, 'evidence'), { recursive: true });\r\n      await mkdir(join(this.auditPath, 'exports'), { recursive: true });\r\n\r\n      await this.loadConfigurations();\r\n      await this.initializeDefaultFrameworks();\r\n      await this.startAuditProcessing();\r\n\r\n      this.logger.info('Audit Manager initialized successfully');\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize Audit Manager', { error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async logAuditEvent(eventData: {\r\n    eventType: string;\r\n    category: AuditEntry['category'];\r\n    severity?: AuditEntry['severity'];\r\n    userId?: string;\r\n    sessionId?: string;\r\n    resource: AuditEntry['resource'];\r\n    action: string;\r\n    outcome: AuditEntry['outcome'];\r\n    details: Record<string, any>;\r\n    context: Partial<AuditEntry['context']>;\r\n    compliance?: {\r\n      frameworks?: string[];\r\n      controls?: string[];\r\n      classification?: AuditEntry['compliance']['classification'];\r\n    };\r\n  }): Promise<AuditEntry> {\r\n    const entry: AuditEntry = {\r\n      id: `audit-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: new Date(),\r\n      eventType: eventData.eventType,\r\n      category: eventData.category,\r\n      severity: eventData.severity || 'medium',\r\n      userId: eventData.userId,\r\n      sessionId: eventData.sessionId,\r\n      resource: eventData.resource,\r\n      action: eventData.action,\r\n      outcome: eventData.outcome,\r\n      details: eventData.details,\r\n      context: {\r\n        source: 'system',\r\n        ...eventData.context,\r\n      },\r\n      compliance: {\r\n        frameworks: eventData.compliance?.frameworks || [],\r\n        controls: eventData.compliance?.controls || [],\r\n        retention: this.calculateRetentionPeriod(\r\n          eventData.category,\r\n          eventData.compliance?.frameworks,\r\n        ),\r\n        classification: eventData.compliance?.classification || 'internal',\r\n      },\r\n      integrity: {\r\n        hash: '',\r\n        verified: false,\r\n      },\r\n      metadata: {},\r\n    };\r\n\r\n    // Calculate integrity hash\r\n    entry.integrity.hash = this.calculateHash(entry);\r\n    entry.integrity.verified = true;\r\n\r\n    // Add to buffer for batch processing\r\n    this.auditBuffer.push(entry);\r\n\r\n    // Immediate processing for critical events\r\n    if (entry.severity === 'critical') {\r\n      await this.processAuditEntry(entry);\r\n      await this.generateSecurityAlert(entry);\r\n    }\r\n\r\n    // Batch process if buffer is full\r\n    if (this.auditBuffer.length >= this.configuration.collection.batchSize) {\r\n      await this.flushAuditBuffer();\r\n    }\r\n\r\n    this.emit('audit:logged', entry);\r\n    return entry;\r\n  }\r\n\r\n  async createComplianceFramework(frameworkData: {\r\n    name: string;\r\n    version: string;\r\n    description: string;\r\n    type: ComplianceFramework['type'];\r\n    requirements: Omit<ComplianceRequirement, 'id'>[];\r\n    controls: Omit<ComplianceControl, 'id'>[];\r\n    auditFrequency: ComplianceFramework['auditFrequency'];\r\n    retentionPeriod: string;\r\n    responsible: string;\r\n  }): Promise<ComplianceFramework> {\r\n    const framework: ComplianceFramework = {\r\n      id: `framework-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: frameworkData.name,\r\n      version: frameworkData.version,\r\n      description: frameworkData.description,\r\n      type: frameworkData.type,\r\n      requirements: frameworkData.requirements.map((req, index) => ({\r\n        id: `req-${Date.now()}-${index}`,\r\n        ...req,\r\n        automatedCheck: {\r\n          enabled: false,\r\n          frequency: 'daily',\r\n          query: '',\r\n          ...req.automatedCheck,\r\n        },\r\n      })),\r\n      auditFrequency: frameworkData.auditFrequency,\r\n      retentionPeriod: frameworkData.retentionPeriod,\r\n      reportingRequirements: {\r\n        frequency: 'quarterly',\r\n        recipients: [],\r\n        format: ['pdf', 'json'],\r\n        automated: false,\r\n      },\r\n      controls: frameworkData.controls.map((control, index) => ({\r\n        id: `control-${Date.now()}-${index}`,\r\n        ...control,\r\n      })),\r\n      status: 'active',\r\n      implementationDate: new Date(),\r\n      nextReview: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year\r\n      responsible: frameworkData.responsible,\r\n    };\r\n\r\n    this.frameworks.set(framework.id, framework);\r\n    await this.saveFramework(framework);\r\n\r\n    await this.logAuditEvent({\r\n      eventType: 'compliance_framework_created',\r\n      category: 'compliance',\r\n      severity: 'medium',\r\n      resource: { type: 'compliance-framework', id: framework.id, name: framework.name },\r\n      action: 'create',\r\n      outcome: 'success',\r\n      details: { frameworkType: framework.type, requirementsCount: framework.requirements.length },\r\n      context: { source: 'audit-manager' },\r\n      compliance: { frameworks: [framework.id] },\r\n    });\r\n\r\n    this.emit('framework:created', framework);\r\n    this.logger.info(`Compliance framework created: ${framework.name} (${framework.id})`);\r\n\r\n    return framework;\r\n  }\r\n\r\n  async generateAuditReport(reportConfig: {\r\n    title: string;\r\n    description: string;\r\n    type: AuditReport['type'];\r\n    scope: AuditReport['scope'];\r\n    includeRecommendations?: boolean;\r\n    confidentiality?: AuditReport['confidentiality'];\r\n  }): Promise<AuditReport> {\r\n    const report: AuditReport = {\r\n      id: `report-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      title: reportConfig.title,\r\n      description: reportConfig.description,\r\n      type: reportConfig.type,\r\n      scope: reportConfig.scope,\r\n      findings: [],\r\n      recommendations: [],\r\n      summary: {\r\n        totalEvents: 0,\r\n        criticalFindings: 0,\r\n        complianceScore: 0,\r\n        riskLevel: 'low',\r\n      },\r\n      methodology: 'Automated analysis of audit trail data with manual review of findings',\r\n      limitations: [],\r\n      reviewers: [],\r\n      approvers: [],\r\n      status: 'draft',\r\n      confidentiality: reportConfig.confidentiality || 'internal',\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      createdBy: 'audit-manager',\r\n    };\r\n\r\n    // Collect relevant audit entries\r\n    const auditEntries = await this.queryAuditEntries(reportConfig.scope);\r\n    report.summary.totalEvents = auditEntries.length;\r\n\r\n    // Analyze entries for findings\r\n    const findings = await this.analyzeAuditEntries(auditEntries, reportConfig.type);\r\n    report.findings = findings;\r\n    report.summary.criticalFindings = findings.filter((f) => f.severity === 'critical').length;\r\n\r\n    // Calculate compliance score\r\n    if (reportConfig.scope.compliance && reportConfig.scope.compliance.length > 0) {\r\n      report.summary.complianceScore = await this.calculateComplianceScore(\r\n        reportConfig.scope.compliance,\r\n        auditEntries,\r\n      );\r\n    }\r\n\r\n    // Determine risk level\r\n    report.summary.riskLevel = this.calculateRiskLevel(findings);\r\n\r\n    // Generate recommendations\r\n    if (reportConfig.includeRecommendations !== false) {\r\n      report.recommendations = await this.generateRecommendations(findings, reportConfig.type);\r\n    }\r\n\r\n    this.reports.set(report.id, report);\r\n    await this.saveReport(report);\r\n\r\n    await this.logAuditEvent({\r\n      eventType: 'audit_report_generated',\r\n      category: 'compliance',\r\n      severity: 'medium',\r\n      resource: { type: 'audit-report', id: report.id, name: report.title },\r\n      action: 'generate',\r\n      outcome: 'success',\r\n      details: {\r\n        reportType: report.type,\r\n        totalEvents: report.summary.totalEvents,\r\n        findingsCount: report.findings.length,\r\n        complianceScore: report.summary.complianceScore,\r\n      },\r\n      context: { source: 'audit-manager' },\r\n      compliance: { frameworks: reportConfig.scope.compliance || [] },\r\n    });\r\n\r\n    this.emit('report:generated', report);\r\n    this.logger.info(`Audit report generated: ${report.title} (${report.id})`);\r\n\r\n    return report;\r\n  }\r\n\r\n  async exportAuditData(exportConfig: {\r\n    format: 'json' | 'csv' | 'xml' | 'pdf';\r\n    scope: {\r\n      timeRange: { start: Date; end: Date };\r\n      categories?: string[];\r\n      severity?: string[];\r\n      users?: string[];\r\n    };\r\n    destination: string;\r\n    encryption?: boolean;\r\n    compression?: boolean;\r\n  }): Promise<string> {\r\n    const entries = await this.queryAuditEntries(exportConfig.scope);\r\n\r\n    let exportData: string;\r\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\r\n    const filename = `audit-export-${timestamp}.${exportConfig.format}`;\r\n    const filepath = join(this.auditPath, 'exports', filename);\r\n\r\n    switch (exportConfig.format) {\r\n      case 'json':\r\n        exportData = JSON.stringify(entries, null, 2);\r\n        break;\r\n      case 'csv':\r\n        exportData = this.convertToCSV(entries);\r\n        break;\r\n      case 'xml':\r\n        exportData = this.convertToXML(entries);\r\n        break;\r\n      case 'pdf':\r\n        exportData = await this.convertToPDF(entries);\r\n        break;\r\n      default:\r\n        throw new Error(`Unsupported export format: ${exportConfig.format}`);\r\n    }\r\n\r\n    // Apply compression if requested\r\n    if (exportConfig.compression) {\r\n      // Would implement compression here\r\n    }\r\n\r\n    // Apply encryption if requested\r\n    if (exportConfig.encryption) {\r\n      // Would implement encryption here\r\n    }\r\n\r\n    await writeFile(filepath, exportData);\r\n\r\n    await this.logAuditEvent({\r\n      eventType: 'audit_data_exported',\r\n      category: 'data-access',\r\n      severity: 'medium',\r\n      resource: { type: 'audit-data', id: 'export', path: filepath },\r\n      action: 'export',\r\n      outcome: 'success',\r\n      details: {\r\n        format: exportConfig.format,\r\n        recordCount: entries.length,\r\n        timeRange: exportConfig.scope.timeRange,\r\n        compressed: exportConfig.compression || false,\r\n        encrypted: exportConfig.encryption || false,\r\n      },\r\n      context: { source: 'audit-manager' },\r\n    });\r\n\r\n    this.emit('data:exported', {\r\n      filepath,\r\n      format: exportConfig.format,\r\n      recordCount: entries.length,\r\n    });\r\n    this.logger.info(`Audit data exported: ${filename} (${entries.length} records)`);\r\n\r\n    return filepath;\r\n  }\r\n\r\n  async verifyAuditIntegrity(trailId?: string): Promise<{\r\n    verified: boolean;\r\n    issues: TamperEvidence[];\r\n    summary: {\r\n      totalEntries: number;\r\n      verifiedEntries: number;\r\n      corruptedEntries: number;\r\n      missingEntries: number;\r\n    };\r\n  }> {\r\n    const issues: TamperEvidence[] = [];\r\n    let totalEntries = 0;\r\n    let verifiedEntries = 0;\r\n    let corruptedEntries = 0;\r\n    const missingEntries = 0;\r\n\r\n    const trails = trailId\r\n      ? ([this.auditTrails.get(trailId)].filter(Boolean) as AuditTrail[])\r\n      : Array.from(this.auditTrails.values());\r\n\r\n    for (const trail of trails) {\r\n      for (const entry of trail.entries) {\r\n        totalEntries++;\r\n\r\n        // Verify hash\r\n        const calculatedHash = this.calculateHash(entry);\r\n        if (calculatedHash === entry.integrity.hash) {\r\n          verifiedEntries++;\r\n        } else {\r\n          corruptedEntries++;\r\n          issues.push({\r\n            timestamp: new Date(),\r\n            type: 'checksum-mismatch',\r\n            description: `Hash mismatch for audit entry ${entry.id}`,\r\n            severity: 'high',\r\n            investigationStatus: 'pending',\r\n            evidence: [`Expected: ${entry.integrity.hash}`, `Calculated: ${calculatedHash}`],\r\n          });\r\n        }\r\n      }\r\n\r\n      // Update trail integrity status\r\n      trail.integrity.verified = issues.length === 0;\r\n      trail.integrity.lastVerification = new Date();\r\n      trail.integrity.tamperEvidence = issues;\r\n\r\n      await this.saveAuditTrail(trail);\r\n    }\r\n\r\n    const verified = issues.length === 0;\r\n\r\n    await this.logAuditEvent({\r\n      eventType: 'audit_integrity_verification',\r\n      category: 'security',\r\n      severity: verified ? 'low' : 'high',\r\n      resource: { type: 'audit-trail', id: trailId || 'all' },\r\n      action: 'verify',\r\n      outcome: verified ? 'success' : 'failure',\r\n      details: {\r\n        totalEntries,\r\n        verifiedEntries,\r\n        corruptedEntries,\r\n        issuesFound: issues.length,\r\n      },\r\n      context: { source: 'audit-manager' },\r\n    });\r\n\r\n    if (!verified) {\r\n      this.emit('integrity:compromised', {\r\n        issues,\r\n        summary: { totalEntries, verifiedEntries, corruptedEntries, missingEntries },\r\n      });\r\n      this.logger.error(`Audit integrity verification failed: ${issues.length} issues found`);\r\n    } else {\r\n      this.logger.info(`Audit integrity verification successful: ${totalEntries} entries verified`);\r\n    }\r\n\r\n    return {\r\n      verified,\r\n      issues,\r\n      summary: { totalEntries, verifiedEntries, corruptedEntries, missingEntries },\r\n    };\r\n  }\r\n\r\n  async getAuditMetrics(timeRange?: { start: Date; end: Date }): Promise<AuditMetrics> {\r\n    const range = timeRange || {\r\n      start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // Last 30 days\r\n      end: new Date(),\r\n    };\r\n\r\n    const entries = await this.queryAuditEntries({ timeRange: range });\r\n\r\n    // Volume metrics\r\n    const volumeMetrics = {\r\n      totalEntries: entries.length,\r\n      dailyAverage: entries.length / 30,\r\n      peakHourly: this.calculatePeakHourly(entries),\r\n      byCategory: this.groupBy(entries, 'category'),\r\n      bySeverity: this.groupBy(entries, 'severity'),\r\n    };\r\n\r\n    // Compliance metrics\r\n    const complianceMetrics = {\r\n      overallScore: 85, // Would be calculated from actual compliance data\r\n      byFramework: {} as Record<string, any>,\r\n      trending: 'stable' as const,\r\n    };\r\n\r\n    // Calculate compliance scores by framework\r\n    for (const framework of this.frameworks.values()) {\r\n      const score = await this.calculateComplianceScore([framework.id], entries);\r\n      complianceMetrics.byFramework[framework.id] = {\r\n        score,\r\n        compliant: framework.requirements.filter((r) => r.status === 'compliant').length,\r\n        nonCompliant: framework.requirements.filter((r) => r.status === 'non-compliant').length,\r\n        total: framework.requirements.length,\r\n      };\r\n    }\r\n\r\n    // Integrity metrics\r\n    const integrityMetrics = {\r\n      verificationSuccess: 99.5,\r\n      tamperAttempts: entries.filter((e) => e.eventType === 'unauthorized_access').length,\r\n      dataLoss: 0,\r\n      corruptionEvents: 0,\r\n    };\r\n\r\n    // Performance metrics\r\n    const performanceMetrics = {\r\n      ingestionRate: entries.length / 24, // entries per hour\r\n      queryResponseTime: 150, // ms\r\n      storageEfficiency: 85, // percentage\r\n      availabilityPercentage: 99.9,\r\n    };\r\n\r\n    // Security metrics\r\n    const securityMetrics = {\r\n      unauthorizedAccess: entries.filter(\r\n        (e) => e.outcome === 'denied' || e.eventType === 'unauthorized_access',\r\n      ).length,\r\n      privilegedActions: entries.filter((e) => e.details.privileged === true).length,\r\n      suspiciousPatterns: entries.filter((e) => e.severity === 'critical').length,\r\n      escalatedIncidents: entries.filter(\r\n        (e) => e.category === 'security' && e.severity === 'critical',\r\n      ).length,\r\n    };\r\n\r\n    return {\r\n      volume: volumeMetrics,\r\n      compliance: complianceMetrics,\r\n      integrity: integrityMetrics,\r\n      performance: performanceMetrics,\r\n      security: securityMetrics,\r\n    };\r\n  }\r\n\r\n  // Private helper methods\r\n  private getDefaultConfiguration(): AuditConfiguration {\r\n    return {\r\n      general: {\r\n        enabled: true,\r\n        defaultRetention: '7y',\r\n        compressionEnabled: true,\r\n        encryptionEnabled: true,\r\n        realTimeProcessing: true,\r\n      },\r\n      collection: {\r\n        automaticCapture: true,\r\n        bufferSize: 10000,\r\n        batchSize: 1000,\r\n        flushInterval: 60000,\r\n        failureHandling: 'retry',\r\n      },\r\n      storage: {\r\n        primaryLocation: join(this.auditPath, 'trails'),\r\n        partitioning: 'daily',\r\n        indexing: true,\r\n      },\r\n      integrity: {\r\n        checksumAlgorithm: 'sha256',\r\n        verificationFrequency: 'daily',\r\n        digitalSignatures: false,\r\n        immutableStorage: true,\r\n      },\r\n      compliance: {\r\n        frameworks: [],\r\n        automaticClassification: true,\r\n        retentionPolicies: {\r\n          authentication: '3y',\r\n          'data-access': '7y',\r\n          'system-change': '5y',\r\n          security: '7y',\r\n          compliance: '10y',\r\n        },\r\n        exportFormats: ['json', 'csv', 'pdf'],\r\n      },\r\n      monitoring: {\r\n        alerting: {\r\n          enabled: true,\r\n          channels: ['email', 'webhook'],\r\n          thresholds: {\r\n            failedLogins: 5,\r\n            privilegedAccess: 10,\r\n            dataExfiltration: 1,\r\n            configChanges: 20,\r\n          },\r\n        },\r\n        reporting: {\r\n          automated: true,\r\n          frequency: 'weekly',\r\n          recipients: [],\r\n          dashboards: [],\r\n        },\r\n      },\r\n      privacy: {\r\n        piiDetection: true,\r\n        anonymization: false,\r\n        masking: {\r\n          enabled: true,\r\n          patterns: ['\\\\b\\\\d{4}[- ]?\\\\d{4}[- ]?\\\\d{4}[- ]?\\\\d{4}\\\\b'], // Credit card pattern\r\n        },\r\n        consent: {\r\n          required: false,\r\n          tracking: false,\r\n        },\r\n      },\r\n    };\r\n  }\r\n\r\n  private async loadConfigurations(): Promise<void> {\r\n    try {\r\n      // Load frameworks\r\n      const frameworkFiles = await readdir(join(this.auditPath, 'frameworks'));\r\n      for (const file of frameworkFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.auditPath, 'frameworks', file), 'utf-8');\r\n        const framework: ComplianceFramework = JSON.parse(content);\r\n        this.frameworks.set(framework.id, framework);\r\n      }\r\n\r\n      // Load audit trails\r\n      const trailFiles = await readdir(join(this.auditPath, 'trails'));\r\n      for (const file of trailFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.auditPath, 'trails', file), 'utf-8');\r\n        const trail: AuditTrail = JSON.parse(content);\r\n        this.auditTrails.set(trail.id, trail);\r\n      }\r\n\r\n      // Load reports\r\n      const reportFiles = await readdir(join(this.auditPath, 'reports'));\r\n      for (const file of reportFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.auditPath, 'reports', file), 'utf-8');\r\n        const report: AuditReport = JSON.parse(content);\r\n        this.reports.set(report.id, report);\r\n      }\r\n\r\n      this.logger.info(\r\n        `Loaded ${this.frameworks.size} frameworks, ${this.auditTrails.size} trails, ${this.reports.size} reports`,\r\n      );\r\n    } catch (error) {\r\n      this.logger.warn('Failed to load some audit configurations', { error });\r\n    }\r\n  }\r\n\r\n  private async initializeDefaultFrameworks(): Promise<void> {\r\n    const defaultFrameworks = [\r\n      {\r\n        name: 'SOC 2 Type II',\r\n        version: '2017',\r\n        description: 'Service Organization Control 2 Type II compliance framework',\r\n        type: 'certification' as const,\r\n        requirements: [\r\n          {\r\n            title: 'Security Principle - Logical and Physical Access Controls',\r\n            description: 'The entity restricts logical and physical access to the system',\r\n            category: 'access-control',\r\n            priority: 'high' as const,\r\n            status: 'compliant' as const,\r\n            evidence: [],\r\n            gaps: [],\r\n            remediation: {\r\n              actions: [],\r\n              owner: 'security-team',\r\n              dueDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000),\r\n            },\r\n            lastAssessed: new Date(),\r\n            nextAssessment: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\r\n            automatedCheck: {\r\n              enabled: true,\r\n              frequency: 'daily',\r\n              query: 'category:authentication AND outcome:failure',\r\n              threshold: 10,\r\n            },\r\n          },\r\n        ],\r\n        controls: [\r\n          {\r\n            name: 'Multi-Factor Authentication',\r\n            description: 'MFA is required for all user accounts',\r\n            type: 'preventive' as const,\r\n            automationType: 'automated' as const,\r\n            effectiveness: 'high' as const,\r\n            frequency: 'continuous',\r\n            owner: 'security-team',\r\n            evidence: [],\r\n            testingProcedure: 'Verify MFA is enabled for all user accounts',\r\n            lastTested: new Date(),\r\n            nextTest: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000),\r\n            status: 'effective' as const,\r\n          },\r\n        ],\r\n        auditFrequency: 'quarterly' as const,\r\n        retentionPeriod: '7y',\r\n        responsible: 'compliance-officer',\r\n      },\r\n      {\r\n        name: 'GDPR',\r\n        version: '2018',\r\n        description: 'General Data Protection Regulation compliance framework',\r\n        type: 'regulatory' as const,\r\n        requirements: [\r\n          {\r\n            title: 'Data Processing Records',\r\n            description: 'Maintain records of all data processing activities',\r\n            category: 'data-protection',\r\n            priority: 'critical' as const,\r\n            status: 'compliant' as const,\r\n            evidence: [],\r\n            gaps: [],\r\n            remediation: {\r\n              actions: [],\r\n              owner: 'data-protection-officer',\r\n              dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\r\n            },\r\n            lastAssessed: new Date(),\r\n            nextAssessment: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),\r\n            automatedCheck: {\r\n              enabled: true,\r\n              frequency: 'daily',\r\n              query: 'category:data-access AND details.pii:true',\r\n            },\r\n          },\r\n        ],\r\n        controls: [],\r\n        auditFrequency: 'annually' as const,\r\n        retentionPeriod: '6y',\r\n        responsible: 'data-protection-officer',\r\n      },\r\n    ];\r\n\r\n    for (const frameworkData of defaultFrameworks) {\r\n      if (!Array.from(this.frameworks.values()).some((f) => f.name === frameworkData.name)) {\r\n        await this.createComplianceFramework(frameworkData);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async startAuditProcessing(): Promise<void> {\r\n    // Start buffer flush timer\r\n    setInterval(async () => {\r\n      if (this.auditBuffer.length > 0) {\r\n        await this.flushAuditBuffer();\r\n      }\r\n    }, this.configuration.collection.flushInterval);\r\n\r\n    // Start integrity verification timer\r\n    setInterval(\r\n      async () => {\r\n        await this.verifyAuditIntegrity();\r\n      },\r\n      24 * 60 * 60 * 1000,\r\n    ); // Daily\r\n\r\n    this.logger.info('Started audit processing timers');\r\n  }\r\n\r\n  private async flushAuditBuffer(): Promise<void> {\r\n    if (this.auditBuffer.length === 0) return;\r\n\r\n    const entries = [...this.auditBuffer];\r\n    this.auditBuffer = [];\r\n\r\n    try {\r\n      for (const entry of entries) {\r\n        await this.processAuditEntry(entry);\r\n      }\r\n\r\n      this.logger.debug(`Flushed ${entries.length} audit entries`);\r\n    } catch (error) {\r\n      this.logger.error('Failed to flush audit buffer', { error });\r\n\r\n      // Re-add entries to buffer for retry if configured\r\n      if (this.configuration.collection.failureHandling === 'retry') {\r\n        this.auditBuffer.unshift(...entries);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async processAuditEntry(entry: AuditEntry): Promise<void> {\r\n    // Determine which trail to add the entry to\r\n    const trailId = this.determineAuditTrail(entry);\r\n    let trail = this.auditTrails.get(trailId);\r\n\r\n    if (!trail) {\r\n      trail = await this.createAuditTrail(trailId, entry.category);\r\n    }\r\n\r\n    // Add entry to trail\r\n    trail.entries.push(entry);\r\n    trail.updatedAt = new Date();\r\n\r\n    // Update trail integrity\r\n    trail.integrity.checksum = this.calculateTrailChecksum(trail);\r\n    trail.integrity.lastVerification = new Date();\r\n\r\n    await this.saveAuditTrail(trail);\r\n\r\n    // Check for compliance violations\r\n    await this.checkComplianceViolations(entry);\r\n\r\n    // Check for security alerts\r\n    await this.checkSecurityAlerts(entry);\r\n  }\r\n\r\n  private determineAuditTrail(entry: AuditEntry): string {\r\n    // Use category and date for trail determination\r\n    const date = entry.timestamp.toISOString().split('T')[0];\r\n    return `${entry.category}-${date}`;\r\n  }\r\n\r\n  private async createAuditTrail(id: string, category: string): Promise<AuditTrail> {\r\n    const trail: AuditTrail = {\r\n      id,\r\n      name: `${category} audit trail`,\r\n      description: `Audit trail for ${category} events`,\r\n      category,\r\n      entries: [],\r\n      configuration: {\r\n        retention:\r\n          this.configuration.compliance.retentionPolicies[category] ||\r\n          this.configuration.general.defaultRetention,\r\n        compression: this.configuration.general.compressionEnabled,\r\n        encryption: this.configuration.general.encryptionEnabled,\r\n        archival: {\r\n          enabled: true,\r\n          location: join(this.auditPath, 'archive'),\r\n          schedule: 'yearly',\r\n        },\r\n        monitoring: {\r\n          realTime: this.configuration.general.realTimeProcessing,\r\n          alerting: this.configuration.monitoring.alerting.enabled,\r\n          dashboards: [],\r\n        },\r\n      },\r\n      integrity: {\r\n        verified: true,\r\n        lastVerification: new Date(),\r\n        checksum: '',\r\n        tamperEvidence: [],\r\n      },\r\n      access: {\r\n        viewers: [],\r\n        admins: ['audit-admin'],\r\n        readonly: false,\r\n        auditAccess: true,\r\n      },\r\n      compliance: {\r\n        frameworks: [],\r\n        retention:\r\n          this.configuration.compliance.retentionPolicies[category] ||\r\n          this.configuration.general.defaultRetention,\r\n        exportRequirements: [],\r\n        immutable: this.configuration.integrity.immutableStorage,\r\n      },\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    this.auditTrails.set(trail.id, trail);\r\n    await this.saveAuditTrail(trail);\r\n\r\n    return trail;\r\n  }\r\n\r\n  private calculateHash(entry: AuditEntry): string {\r\n    // Create a deterministic string representation of the entry\r\n    const data = {\r\n      timestamp: entry.timestamp.toISOString(),\r\n      eventType: entry.eventType,\r\n      category: entry.category,\r\n      userId: entry.userId,\r\n      resource: entry.resource,\r\n      action: entry.action,\r\n      outcome: entry.outcome,\r\n      details: entry.details,\r\n    };\r\n\r\n    return createHash(this.configuration.integrity.checksumAlgorithm)\r\n      .update(JSON.stringify(data))\r\n      .digest('hex');\r\n  }\r\n\r\n  private calculateTrailChecksum(trail: AuditTrail): string {\r\n    const data = trail.entries.map((e) => e.integrity.hash).join('');\r\n    return createHash(this.configuration.integrity.checksumAlgorithm).update(data).digest('hex');\r\n  }\r\n\r\n  private calculateRetentionPeriod(category: string, frameworks?: string[]): string {\r\n    const categoryRetention = this.configuration.compliance.retentionPolicies[category];\r\n    if (categoryRetention) return categoryRetention;\r\n\r\n    // Check framework requirements\r\n    if (frameworks) {\r\n      let maxRetention = this.configuration.general.defaultRetention;\r\n      for (const frameworkId of frameworks) {\r\n        const framework = this.frameworks.get(frameworkId);\r\n        if (\r\n          framework &&\r\n          this.parseRetentionPeriod(framework.retentionPeriod) >\r\n            this.parseRetentionPeriod(maxRetention)\r\n        ) {\r\n          maxRetention = framework.retentionPeriod;\r\n        }\r\n      }\r\n      return maxRetention;\r\n    }\r\n\r\n    return this.configuration.general.defaultRetention;\r\n  }\r\n\r\n  private parseRetentionPeriod(period: string): number {\r\n    const match = period.match(/(\\d+)([ymd])/);\r\n    if (!match) return 0;\r\n\r\n    const value = parseInt(match[1]);\r\n    const unit = match[2];\r\n\r\n    switch (unit) {\r\n      case 'y':\r\n        return value * 365;\r\n      case 'm':\r\n        return value * 30;\r\n      case 'd':\r\n        return value;\r\n      default:\r\n        return 0;\r\n    }\r\n  }\r\n\r\n  private async queryAuditEntries(scope: {\r\n    timeRange?: { start: Date; end: Date };\r\n    categories?: string[];\r\n    severity?: string[];\r\n    users?: string[];\r\n    events?: string[];\r\n    compliance?: string[];\r\n  }): Promise<AuditEntry[]> {\r\n    let entries: AuditEntry[] = [];\r\n\r\n    // Collect entries from all trails\r\n    for (const trail of this.auditTrails.values()) {\r\n      entries.push(...trail.entries);\r\n    }\r\n\r\n    // Apply filters\r\n    if (scope.timeRange) {\r\n      entries = entries.filter(\r\n        (e) => e.timestamp >= scope.timeRange!.start && e.timestamp <= scope.timeRange!.end,\r\n      );\r\n    }\r\n\r\n    if (scope.categories) {\r\n      entries = entries.filter((e) => scope.categories!.includes(e.category));\r\n    }\r\n\r\n    if (scope.severity) {\r\n      entries = entries.filter((e) => scope.severity!.includes(e.severity));\r\n    }\r\n\r\n    if (scope.users) {\r\n      entries = entries.filter((e) => e.userId && scope.users!.includes(e.userId));\r\n    }\r\n\r\n    if (scope.events) {\r\n      entries = entries.filter((e) => scope.events!.includes(e.eventType));\r\n    }\r\n\r\n    if (scope.compliance) {\r\n      entries = entries.filter((e) =>\r\n        e.compliance.frameworks.some((f) => scope.compliance!.includes(f)),\r\n      );\r\n    }\r\n\r\n    return entries.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());\r\n  }\r\n\r\n  private async analyzeAuditEntries(\r\n    entries: AuditEntry[],\r\n    reportType: string,\r\n  ): Promise<AuditFinding[]> {\r\n    const findings: AuditFinding[] = [];\r\n\r\n    // Security-focused analysis\r\n    if (reportType === 'security') {\r\n      // Check for failed login patterns\r\n      const failedLogins = entries.filter(\r\n        (e) => e.eventType === 'user_login' && e.outcome === 'failure',\r\n      );\r\n\r\n      if (failedLogins.length > 10) {\r\n        findings.push({\r\n          id: `finding-${Date.now()}-1`,\r\n          title: 'Excessive Failed Login Attempts',\r\n          description: `${failedLogins.length} failed login attempts detected`,\r\n          severity: 'high',\r\n          category: 'authentication',\r\n          risk: 'Potential brute force attack',\r\n          impact: 'Unauthorized access attempt',\r\n          likelihood: 'medium',\r\n          evidence: [],\r\n          relatedEvents: failedLogins.map((e) => e.id),\r\n          complianceImpact: {\r\n            frameworks: ['SOC2'],\r\n            violations: ['Access Control'],\r\n            penalties: [],\r\n          },\r\n          remediation: {\r\n            priority: 'high',\r\n            owner: 'security-team',\r\n            actions: ['Implement account lockout', 'Enable MFA', 'Review access logs'],\r\n            timeline: '7 days',\r\n          },\r\n          status: 'open',\r\n        });\r\n      }\r\n    }\r\n\r\n    // Compliance-focused analysis\r\n    if (reportType === 'compliance') {\r\n      // Check for data access patterns\r\n      const dataAccess = entries.filter(\r\n        (e) => e.category === 'data-access' && e.details.pii === true,\r\n      );\r\n\r\n      if (dataAccess.length > 0) {\r\n        findings.push({\r\n          id: `finding-${Date.now()}-2`,\r\n          title: 'PII Data Access Events',\r\n          description: `${dataAccess.length} events involving PII data access`,\r\n          severity: 'medium',\r\n          category: 'data-protection',\r\n          risk: 'Privacy compliance risk',\r\n          impact: 'Potential GDPR violation',\r\n          likelihood: 'low',\r\n          evidence: [],\r\n          relatedEvents: dataAccess.map((e) => e.id),\r\n          complianceImpact: {\r\n            frameworks: ['GDPR'],\r\n            violations: ['Data Processing'],\r\n            penalties: ['Administrative fine'],\r\n          },\r\n          remediation: {\r\n            priority: 'medium',\r\n            owner: 'data-protection-officer',\r\n            actions: ['Review data access justification', 'Update privacy notices'],\r\n            timeline: '30 days',\r\n          },\r\n          status: 'open',\r\n        });\r\n      }\r\n    }\r\n\r\n    return findings;\r\n  }\r\n\r\n  private async calculateComplianceScore(\r\n    frameworks: string[],\r\n    entries: AuditEntry[],\r\n  ): Promise<number> {\r\n    let totalRequirements = 0;\r\n    let metRequirements = 0;\r\n\r\n    for (const frameworkId of frameworks) {\r\n      const framework = this.frameworks.get(frameworkId);\r\n      if (!framework) continue;\r\n\r\n      for (const requirement of framework.requirements) {\r\n        totalRequirements++;\r\n\r\n        if (requirement.status === 'compliant') {\r\n          metRequirements++;\r\n        } else if (requirement.automatedCheck.enabled) {\r\n          // Check if automated requirement is met based on audit data\r\n          const violations = this.checkAutomatedRequirement(requirement, entries);\r\n          if (violations.length === 0) {\r\n            metRequirements++;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return totalRequirements > 0 ? (metRequirements / totalRequirements) * 100 : 0;\r\n  }\r\n\r\n  private checkAutomatedRequirement(\r\n    requirement: ComplianceRequirement,\r\n    entries: AuditEntry[],\r\n  ): AuditEntry[] {\r\n    // Simplified automated compliance checking\r\n    // In a real implementation, this would parse the query and evaluate against entries\r\n    const violations = entries.filter((e) => {\r\n      if (requirement.automatedCheck.query.includes('outcome:failure')) {\r\n        return e.outcome === 'failure';\r\n      }\r\n      return false;\r\n    });\r\n\r\n    return violations;\r\n  }\r\n\r\n  private calculateRiskLevel(findings: AuditFinding[]): 'low' | 'medium' | 'high' | 'critical' {\r\n    const criticalFindings = findings.filter((f) => f.severity === 'critical').length;\r\n    const highFindings = findings.filter((f) => f.severity === 'high').length;\r\n\r\n    if (criticalFindings > 0) return 'critical';\r\n    if (highFindings > 2) return 'high';\r\n    if (findings.length > 5) return 'medium';\r\n    return 'low';\r\n  }\r\n\r\n  private async generateRecommendations(\r\n    findings: AuditFinding[],\r\n    reportType: string,\r\n  ): Promise<AuditRecommendation[]> {\r\n    const recommendations: AuditRecommendation[] = [];\r\n\r\n    // Generic security recommendations\r\n    if (findings.some((f) => f.category === 'authentication')) {\r\n      recommendations.push({\r\n        id: `rec-${Date.now()}-1`,\r\n        title: 'Strengthen Authentication Controls',\r\n        description: 'Implement additional authentication security measures',\r\n        priority: 'high',\r\n        category: 'technology',\r\n        implementation: {\r\n          effort: 'medium',\r\n          cost: 'medium',\r\n          timeline: '30 days',\r\n          dependencies: ['Identity Provider Integration'],\r\n          risks: ['User experience impact'],\r\n        },\r\n        expectedBenefit: 'Reduced risk of unauthorized access',\r\n        owner: 'security-team',\r\n        status: 'proposed',\r\n        tracking: {\r\n          milestones: ['MFA deployment', 'Policy update', 'User training'],\r\n          progress: 0,\r\n          nextReview: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\r\n        },\r\n      });\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  private async checkComplianceViolations(entry: AuditEntry): Promise<void> {\r\n    for (const frameworkId of entry.compliance.frameworks) {\r\n      const framework = this.frameworks.get(frameworkId);\r\n      if (!framework) continue;\r\n\r\n      for (const requirement of framework.requirements) {\r\n        if (requirement.automatedCheck.enabled) {\r\n          const violations = this.checkAutomatedRequirement(requirement, [entry]);\r\n          if (violations.length > 0) {\r\n            this.emit('compliance:violation', {\r\n              framework: frameworkId,\r\n              requirement: requirement.id,\r\n              entry,\r\n              severity: requirement.priority,\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async checkSecurityAlerts(entry: AuditEntry): Promise<void> {\r\n    const thresholds = this.configuration.monitoring.alerting.thresholds;\r\n\r\n    // Check for specific alert conditions\r\n    if (entry.eventType === 'user_login' && entry.outcome === 'failure') {\r\n      // Would implement failed login threshold checking\r\n    }\r\n\r\n    if (entry.category === 'data-access' && entry.details.privileged) {\r\n      this.emit('security:alert', {\r\n        type: 'privileged-access',\r\n        entry,\r\n        severity: 'medium',\r\n      });\r\n    }\r\n  }\r\n\r\n  private async generateSecurityAlert(entry: AuditEntry): Promise<void> {\r\n    this.emit('security:critical', {\r\n      entry,\r\n      message: `Critical security event: ${entry.eventType}`,\r\n      action: 'immediate-review-required',\r\n    });\r\n  }\r\n\r\n  private calculatePeakHourly(entries: AuditEntry[]): number {\r\n    const hourlyBuckets: Record<string, number> = {};\r\n\r\n    for (const entry of entries) {\r\n      const hour = entry.timestamp.toISOString().substr(0, 13); // YYYY-MM-DDTHH\r\n      hourlyBuckets[hour] = (hourlyBuckets[hour] || 0) + 1;\r\n    }\r\n\r\n    return Math.max(...Object.values(hourlyBuckets), 0);\r\n  }\r\n\r\n  private groupBy<T>(array: T[], key: keyof T): Record<string, number> {\r\n    return array.reduce(\r\n      (groups, item) => {\r\n        const value = String(item[key]);\r\n        groups[value] = (groups[value] || 0) + 1;\r\n        return groups;\r\n      },\r\n      {} as Record<string, number>,\r\n    );\r\n  }\r\n\r\n  private convertToCSV(entries: AuditEntry[]): string {\r\n    const headers = [\r\n      'timestamp',\r\n      'eventType',\r\n      'category',\r\n      'severity',\r\n      'userId',\r\n      'action',\r\n      'outcome',\r\n      'resource',\r\n    ];\r\n    const rows = entries.map((entry) => [\r\n      entry.timestamp.toISOString(),\r\n      entry.eventType,\r\n      entry.category,\r\n      entry.severity,\r\n      entry.userId || '',\r\n      entry.action,\r\n      entry.outcome,\r\n      `${entry.resource.type}:${entry.resource.id}`,\r\n    ]);\r\n\r\n    return [headers, ...rows].map((row) => row.join(',')).join('\\n');\r\n  }\r\n\r\n  private convertToXML(entries: AuditEntry[]): string {\r\n    let xml = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<auditEntries>\\n';\r\n\r\n    for (const entry of entries) {\r\n      xml += `  <entry id=\"${entry.id}\">\\n`;\r\n      xml += `    <timestamp>${entry.timestamp.toISOString()}</timestamp>\\n`;\r\n      xml += `    <eventType>${entry.eventType}</eventType>\\n`;\r\n      xml += `    <category>${entry.category}</category>\\n`;\r\n      xml += `    <severity>${entry.severity}</severity>\\n`;\r\n      xml += `    <action>${entry.action}</action>\\n`;\r\n      xml += `    <outcome>${entry.outcome}</outcome>\\n`;\r\n      xml += `  </entry>\\n`;\r\n    }\r\n\r\n    xml += '</auditEntries>';\r\n    return xml;\r\n  }\r\n\r\n  private async convertToPDF(entries: AuditEntry[]): Promise<string> {\r\n    // Would implement PDF generation\r\n    return 'PDF generation not implemented';\r\n  }\r\n\r\n  private async saveFramework(framework: ComplianceFramework): Promise<void> {\r\n    const filePath = join(this.auditPath, 'frameworks', `${framework.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(framework, null, 2));\r\n  }\r\n\r\n  private async saveAuditTrail(trail: AuditTrail): Promise<void> {\r\n    const filePath = join(this.auditPath, 'trails', `${trail.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(trail, null, 2));\r\n  }\r\n\r\n  private async saveReport(report: AuditReport): Promise<void> {\r\n    const filePath = join(this.auditPath, 'reports', `${report.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(report, null, 2));\r\n  }\r\n}\r\n"],"names":["EventEmitter","writeFile","readFile","mkdir","readdir","join","createHash","Logger","ConfigManager","AuditManager","auditTrails","Map","frameworks","reports","auditBuffer","auditPath","logger","config","configuration","level","format","destination","getInstance","getDefaultConfiguration","initialize","recursive","loadConfigurations","initializeDefaultFrameworks","startAuditProcessing","info","error","logAuditEvent","eventData","entry","id","Date","now","Math","random","toString","substr","timestamp","eventType","category","severity","userId","sessionId","resource","action","outcome","details","context","source","compliance","controls","retention","calculateRetentionPeriod","classification","integrity","hash","verified","metadata","calculateHash","push","processAuditEntry","generateSecurityAlert","length","collection","batchSize","flushAuditBuffer","emit","createComplianceFramework","frameworkData","framework","name","version","description","type","requirements","map","req","index","automatedCheck","enabled","frequency","query","auditFrequency","retentionPeriod","reportingRequirements","recipients","automated","control","status","implementationDate","nextReview","responsible","set","saveFramework","frameworkType","requirementsCount","generateAuditReport","reportConfig","report","title","scope","findings","recommendations","summary","totalEvents","criticalFindings","complianceScore","riskLevel","methodology","limitations","reviewers","approvers","confidentiality","createdAt","updatedAt","createdBy","auditEntries","queryAuditEntries","analyzeAuditEntries","filter","f","calculateComplianceScore","calculateRiskLevel","includeRecommendations","generateRecommendations","saveReport","reportType","findingsCount","exportAuditData","exportConfig","entries","exportData","toISOString","replace","filename","filepath","JSON","stringify","convertToCSV","convertToXML","convertToPDF","Error","compression","encryption","path","recordCount","timeRange","compressed","encrypted","verifyAuditIntegrity","trailId","issues","totalEntries","verifiedEntries","corruptedEntries","missingEntries","trails","get","Boolean","Array","from","values","trail","calculatedHash","investigationStatus","evidence","lastVerification","tamperEvidence","saveAuditTrail","issuesFound","getAuditMetrics","range","start","end","volumeMetrics","dailyAverage","peakHourly","calculatePeakHourly","byCategory","groupBy","bySeverity","complianceMetrics","overallScore","byFramework","trending","score","compliant","r","nonCompliant","total","integrityMetrics","verificationSuccess","tamperAttempts","e","dataLoss","corruptionEvents","performanceMetrics","ingestionRate","queryResponseTime","storageEfficiency","availabilityPercentage","securityMetrics","unauthorizedAccess","privilegedActions","privileged","suspiciousPatterns","escalatedIncidents","volume","performance","security","general","defaultRetention","compressionEnabled","encryptionEnabled","realTimeProcessing","automaticCapture","bufferSize","flushInterval","failureHandling","storage","primaryLocation","partitioning","indexing","checksumAlgorithm","verificationFrequency","digitalSignatures","immutableStorage","automaticClassification","retentionPolicies","authentication","exportFormats","monitoring","alerting","channels","thresholds","failedLogins","privilegedAccess","dataExfiltration","configChanges","reporting","dashboards","privacy","piiDetection","anonymization","masking","patterns","consent","required","tracking","frameworkFiles","file","endsWith","content","parse","trailFiles","reportFiles","size","warn","defaultFrameworks","priority","gaps","remediation","actions","owner","dueDate","lastAssessed","nextAssessment","threshold","automationType","effectiveness","testingProcedure","lastTested","nextTest","some","setInterval","debug","unshift","determineAuditTrail","createAuditTrail","checksum","calculateTrailChecksum","checkComplianceViolations","checkSecurityAlerts","date","split","archival","location","schedule","realTime","access","viewers","admins","readonly","auditAccess","exportRequirements","immutable","data","update","digest","categoryRetention","maxRetention","frameworkId","parseRetentionPeriod","period","match","value","parseInt","unit","categories","includes","users","events","sort","a","b","getTime","risk","impact","likelihood","relatedEvents","complianceImpact","violations","penalties","timeline","dataAccess","pii","totalRequirements","metRequirements","requirement","checkAutomatedRequirement","highFindings","implementation","effort","cost","dependencies","risks","expectedBenefit","milestones","progress","message","hourlyBuckets","hour","max","Object","array","key","reduce","groups","item","String","headers","rows","row","xml","filePath"],"mappings":"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"}
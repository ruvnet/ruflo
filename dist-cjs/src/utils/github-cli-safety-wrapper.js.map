{"version":3,"sources":["../../../src/utils/github-cli-safety-wrapper.js"],"sourcesContent":["/**\r\n * GitHub CLI Safety Wrapper - Production-Ready Implementation\r\n * \r\n * Comprehensive wrapper around GitHub CLI commands with:\r\n * - Injection attack prevention\r\n * - Timeout handling with graceful cleanup\r\n * - Process management and recovery\r\n * - Input validation and sanitization\r\n * - Rate limiting protection\r\n * - Comprehensive error handling\r\n * - Retry logic with exponential backoff\r\n * - Secure temp file handling\r\n * - Logging and monitoring\r\n * \r\n * @version 2.0.0\r\n * @license MIT\r\n */\r\n\r\nimport { promises as fs } from 'fs';\r\nimport { tmpdir } from 'os';\r\nimport { join, resolve } from 'path';\r\nimport { randomBytes, createHash } from 'crypto';\r\nimport { spawn, execSync } from 'child_process';\r\nimport { performance } from 'perf_hooks';\r\n\r\n/**\r\n * Configuration constants\r\n */\r\nconst CONFIG = {\r\n  DEFAULT_TIMEOUT: 30000,          // 30 seconds\r\n  MAX_TIMEOUT: 300000,             // 5 minutes\r\n  MAX_RETRIES: 3,\r\n  RETRY_BASE_DELAY: 1000,          // 1 second\r\n  MAX_BODY_SIZE: 1024 * 1024,      // 1MB\r\n  RATE_LIMIT_WINDOW: 60000,        // 1 minute\r\n  MAX_REQUESTS_PER_WINDOW: 50,\r\n  TEMP_FILE_PREFIX: 'gh-safe-',\r\n  ALLOWED_COMMANDS: [\r\n    'auth', 'repo', 'issue', 'pr', 'release', 'gist', 'run', 'workflow', \r\n    'api', 'browse', 'config', 'extension', 'gpg-key', 'label', 'project',\r\n    'secret', 'ssh-key', 'status', 'variable', 'cache', 'codespace'\r\n  ],\r\n  DANGEROUS_PATTERNS: [\r\n    /\\$\\([^)]*\\)/g,                // Command substitution $(...)\r\n    /`[^`]*`/g,                    // Backtick execution\r\n    /&&|\\|\\||;|&/g,                // Command chaining\r\n    /<\\(/g,                        // Process substitution\r\n    />\\s*\\/dev\\/null/g,            // Output redirection\r\n    /\\|\\s*sh/g,                    // Pipe to shell\r\n    /eval\\s*\\(/g,                  // eval() calls\r\n    /exec\\s*\\(/g,                  // exec() calls\r\n  ]\r\n};\r\n\r\n/**\r\n * Custom error classes for better error handling\r\n */\r\nclass GitHubCliError extends Error {\r\n  constructor(message, code = 'GITHUB_CLI_ERROR', details = {}) {\r\n    super(message);\r\n    this.name = 'GitHubCliError';\r\n    this.code = code;\r\n    this.details = details;\r\n    this.timestamp = new Date().toISOString();\r\n  }\r\n}\r\n\r\nclass GitHubCliTimeoutError extends GitHubCliError {\r\n  constructor(timeout, command) {\r\n    super(`Command timed out after ${timeout}ms: ${command}`, 'TIMEOUT', { timeout, command });\r\n    this.name = 'GitHubCliTimeoutError';\r\n  }\r\n}\r\n\r\nclass GitHubCliValidationError extends GitHubCliError {\r\n  constructor(message, field, value) {\r\n    super(message, 'VALIDATION_ERROR', { field, value });\r\n    this.name = 'GitHubCliValidationError';\r\n  }\r\n}\r\n\r\nclass GitHubCliRateLimitError extends GitHubCliError {\r\n  constructor(message) {\r\n    super(message, 'RATE_LIMIT_ERROR');\r\n    this.name = 'GitHubCliRateLimitError';\r\n  }\r\n}\r\n\r\n/**\r\n * Rate limiter to prevent API abuse\r\n */\r\nclass RateLimiter {\r\n  constructor(maxRequests = CONFIG.MAX_REQUESTS_PER_WINDOW, windowMs = CONFIG.RATE_LIMIT_WINDOW) {\r\n    this.maxRequests = maxRequests;\r\n    this.windowMs = windowMs;\r\n    this.requests = [];\r\n  }\r\n\r\n  async checkLimit() {\r\n    const now = Date.now();\r\n    this.requests = this.requests.filter(time => now - time < this.windowMs);\r\n    \r\n    if (this.requests.length >= this.maxRequests) {\r\n      const oldestRequest = Math.min(...this.requests);\r\n      const resetTime = oldestRequest + this.windowMs;\r\n      const waitTime = resetTime - now;\r\n      \r\n      throw new GitHubCliRateLimitError(\r\n        `Rate limit exceeded. Try again in ${Math.ceil(waitTime / 1000)} seconds`\r\n      );\r\n    }\r\n    \r\n    this.requests.push(now);\r\n  }\r\n}\r\n\r\n/**\r\n * Main GitHub CLI Safety Wrapper Class\r\n */\r\nexport class GitHubCliSafe {\r\n  constructor(options = {}) {\r\n    this.options = {\r\n      timeout: options.timeout || CONFIG.DEFAULT_TIMEOUT,\r\n      maxRetries: options.maxRetries || CONFIG.MAX_RETRIES,\r\n      retryDelay: options.retryDelay || CONFIG.RETRY_BASE_DELAY,\r\n      enableRateLimit: options.enableRateLimit !== false,\r\n      enableLogging: options.enableLogging !== false,\r\n      tempDir: options.tempDir || tmpdir(),\r\n      ...options\r\n    };\r\n    \r\n    this.rateLimiter = new RateLimiter();\r\n    this.activeProcesses = new Map();\r\n    this.stats = {\r\n      totalRequests: 0,\r\n      successfulRequests: 0,\r\n      failedRequests: 0,\r\n      timeoutRequests: 0,\r\n      retriedRequests: 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Input validation and sanitization\r\n   */\r\n  validateCommand(command) {\r\n    if (typeof command !== 'string' || !command.trim()) {\r\n      throw new GitHubCliValidationError('Command must be a non-empty string', 'command', command);\r\n    }\r\n\r\n    const parts = command.trim().split(' ');\r\n    const mainCommand = parts[0];\r\n    \r\n    if (!CONFIG.ALLOWED_COMMANDS.includes(mainCommand)) {\r\n      throw new GitHubCliValidationError(\r\n        `Command '${mainCommand}' is not allowed`, \r\n        'command', \r\n        mainCommand\r\n      );\r\n    }\r\n\r\n    return command;\r\n  }\r\n\r\n  sanitizeInput(input) {\r\n    if (typeof input !== 'string') {\r\n      input = String(input);\r\n    }\r\n\r\n    // Check for dangerous patterns\r\n    for (const pattern of CONFIG.DANGEROUS_PATTERNS) {\r\n      if (pattern.test(input)) {\r\n        throw new GitHubCliValidationError(\r\n          `Input contains potentially dangerous pattern: ${pattern}`,\r\n          'input',\r\n          input\r\n        );\r\n      }\r\n    }\r\n\r\n    return input;\r\n  }\r\n\r\n  validateBodySize(body) {\r\n    if (Buffer.byteLength(body, 'utf8') > CONFIG.MAX_BODY_SIZE) {\r\n      throw new GitHubCliValidationError(\r\n        `Body size exceeds maximum allowed size of ${CONFIG.MAX_BODY_SIZE} bytes`,\r\n        'body',\r\n        body.length\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Secure temporary file handling\r\n   */\r\n  async createSecureTempFile(content, suffix = '.tmp') {\r\n    const filename = `${CONFIG.TEMP_FILE_PREFIX}${randomBytes(16).toString('hex')}${suffix}`;\r\n    const filepath = resolve(this.options.tempDir, filename);\r\n    \r\n    // Validate content size\r\n    this.validateBodySize(content);\r\n    \r\n    // Create file with restricted permissions (600 - owner read/write only)\r\n    await fs.writeFile(filepath, content, { mode: 0o600 });\r\n    \r\n    return filepath;\r\n  }\r\n\r\n  async cleanupTempFile(filepath) {\r\n    try {\r\n      await fs.unlink(filepath);\r\n    } catch (error) {\r\n      if (this.options.enableLogging) {\r\n        console.warn(`Failed to cleanup temp file ${filepath}:`, error.message);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process management with timeout and cleanup\r\n   */\r\n  async executeWithTimeout(command, args, options = {}) {\r\n    const timeout = Math.min(options.timeout || this.options.timeout, CONFIG.MAX_TIMEOUT);\r\n    const processId = randomBytes(8).toString('hex');\r\n    \r\n    return new Promise((resolve, reject) => {\r\n      const startTime = performance.now();\r\n      \r\n      const child = spawn('gh', args, {\r\n        stdio: ['ignore', 'pipe', 'pipe'],\r\n        shell: false, // Critical: prevent shell injection\r\n        env: { ...process.env, ...options.env },\r\n        cwd: options.cwd || process.cwd()\r\n      });\r\n\r\n      this.activeProcesses.set(processId, child);\r\n      \r\n      let stdout = '';\r\n      let stderr = '';\r\n      let isTimedOut = false;\r\n      let isResolved = false;\r\n\r\n      // Timeout handler\r\n      const timer = setTimeout(() => {\r\n        if (!isResolved) {\r\n          isTimedOut = true;\r\n          this.killProcess(child, processId);\r\n          this.stats.timeoutRequests++;\r\n          reject(new GitHubCliTimeoutError(timeout, `gh ${args.join(' ')}`));\r\n        }\r\n      }, timeout);\r\n\r\n      // Data handlers\r\n      child.stdout?.on('data', (data) => {\r\n        stdout += data.toString();\r\n      });\r\n\r\n      child.stderr?.on('data', (data) => {\r\n        stderr += data.toString();\r\n      });\r\n\r\n      // Process completion handler\r\n      child.on('close', (code, signal) => {\r\n        if (isResolved) return;\r\n        \r\n        isResolved = true;\r\n        clearTimeout(timer);\r\n        this.activeProcesses.delete(processId);\r\n        \r\n        const duration = performance.now() - startTime;\r\n        \r\n        if (isTimedOut) {\r\n          return; // Already handled by timeout\r\n        }\r\n\r\n        if (signal === 'SIGKILL' || signal === 'SIGTERM') {\r\n          reject(new GitHubCliError(\r\n            `Process terminated by signal ${signal}`,\r\n            'PROCESS_TERMINATED',\r\n            { signal, code, duration }\r\n          ));\r\n          return;\r\n        }\r\n\r\n        if (code !== 0) {\r\n          this.stats.failedRequests++;\r\n          reject(new GitHubCliError(\r\n            `Command failed with exit code ${code}: ${stderr || 'No error details'}`,\r\n            'COMMAND_FAILED',\r\n            { code, stderr, stdout, duration, command: `gh ${args.join(' ')}` }\r\n          ));\r\n          return;\r\n        }\r\n\r\n        this.stats.successfulRequests++;\r\n        resolve({\r\n          stdout: stdout.trim(),\r\n          stderr: stderr.trim(),\r\n          code,\r\n          duration,\r\n          command: `gh ${args.join(' ')}`\r\n        });\r\n      });\r\n\r\n      // Error handler\r\n      child.on('error', (error) => {\r\n        if (isResolved) return;\r\n        \r\n        isResolved = true;\r\n        clearTimeout(timer);\r\n        this.activeProcesses.delete(processId);\r\n        this.stats.failedRequests++;\r\n        \r\n        reject(new GitHubCliError(\r\n          `Process error: ${error.message}`,\r\n          'PROCESS_ERROR',\r\n          { originalError: error }\r\n        ));\r\n      });\r\n    });\r\n  }\r\n\r\n  killProcess(child, processId) {\r\n    try {\r\n      // Graceful termination first\r\n      child.kill('SIGTERM');\r\n      \r\n      // Force kill after 5 seconds if still running\r\n      setTimeout(() => {\r\n        if (this.activeProcesses.has(processId)) {\r\n          child.kill('SIGKILL');\r\n          this.activeProcesses.delete(processId);\r\n        }\r\n      }, 5000);\r\n    } catch (error) {\r\n      if (this.options.enableLogging) {\r\n        console.warn(`Failed to kill process ${processId}:`, error.message);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retry logic with exponential backoff\r\n   */\r\n  async withRetry(operation, maxRetries = this.options.maxRetries) {\r\n    let lastError;\r\n    \r\n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\r\n      try {\r\n        if (attempt > 0) {\r\n          this.stats.retriedRequests++;\r\n          const delay = this.options.retryDelay * Math.pow(2, attempt - 1);\r\n          await this.sleep(delay);\r\n        }\r\n        \r\n        return await operation();\r\n      } catch (error) {\r\n        lastError = error;\r\n        \r\n        // Don't retry on validation errors or rate limits\r\n        if (error instanceof GitHubCliValidationError || \r\n            error instanceof GitHubCliRateLimitError) {\r\n          throw error;\r\n        }\r\n        \r\n        if (attempt === maxRetries) {\r\n          break;\r\n        }\r\n        \r\n        if (this.options.enableLogging) {\r\n          console.warn(`Attempt ${attempt + 1} failed, retrying:`, error.message);\r\n        }\r\n      }\r\n    }\r\n    \r\n    throw lastError;\r\n  }\r\n\r\n  async sleep(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * Core execution method with all safety features\r\n   */\r\n  async execute(command, options = {}) {\r\n    this.stats.totalRequests++;\r\n    \r\n    // Rate limiting check\r\n    if (this.options.enableRateLimit) {\r\n      await this.rateLimiter.checkLimit();\r\n    }\r\n    \r\n    // Validate and sanitize command\r\n    const validatedCommand = this.validateCommand(command);\r\n    const args = validatedCommand.split(' ');\r\n    \r\n    // Handle body content if provided\r\n    let tempFile = null;\r\n    try {\r\n      if (options.body) {\r\n        const sanitizedBody = this.sanitizeInput(options.body);\r\n        tempFile = await this.createSecureTempFile(sanitizedBody);\r\n        args.push('--body-file', tempFile);\r\n      }\r\n      \r\n      // Add other options\r\n      if (options.title) {\r\n        args.push('--title', this.sanitizeInput(options.title));\r\n      }\r\n      \r\n      if (options.labels && Array.isArray(options.labels)) {\r\n        const sanitizedLabels = options.labels.map(label => this.sanitizeInput(label));\r\n        args.push('--label', sanitizedLabels.join(','));\r\n      }\r\n      \r\n      if (options.assignees && Array.isArray(options.assignees)) {\r\n        const sanitizedAssignees = options.assignees.map(assignee => this.sanitizeInput(assignee));\r\n        args.push('--assignee', sanitizedAssignees.join(','));\r\n      }\r\n      \r\n      // Add any additional flags\r\n      if (options.flags) {\r\n        for (const [flag, value] of Object.entries(options.flags)) {\r\n          args.push(`--${flag}`);\r\n          if (value !== true) {\r\n            args.push(this.sanitizeInput(String(value)));\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Execute with retry logic\r\n      return await this.withRetry(async () => {\r\n        return await this.executeWithTimeout(validatedCommand, args.slice(1), options);\r\n      });\r\n      \r\n    } finally {\r\n      // Always cleanup temp file\r\n      if (tempFile) {\r\n        await this.cleanupTempFile(tempFile);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * High-level methods for common GitHub operations\r\n   */\r\n  async createIssue({ title, body, labels = [], assignees = [], ...options }) {\r\n    return await this.execute('issue create', {\r\n      title,\r\n      body,\r\n      labels,\r\n      assignees,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  async createPR({ title, body, base = 'main', head, draft = false, ...options }) {\r\n    const flags = { base };\r\n    if (head) flags.head = head;\r\n    if (draft) flags.draft = true;\r\n    \r\n    return await this.execute('pr create', {\r\n      title,\r\n      body,\r\n      flags,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  async addIssueComment(issueNumber, body, options = {}) {\r\n    return await this.execute(`issue comment ${issueNumber}`, {\r\n      body,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  async addPRComment(prNumber, body, options = {}) {\r\n    return await this.execute(`pr comment ${prNumber}`, {\r\n      body,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  async createRelease({ tag, title, body, prerelease = false, draft = false, ...options }) {\r\n    const flags = { tag };\r\n    if (prerelease) flags.prerelease = true;\r\n    if (draft) flags.draft = true;\r\n    \r\n    return await this.execute('release create', {\r\n      title,\r\n      body,\r\n      flags,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Utility methods\r\n   */\r\n  async checkGitHubCli() {\r\n    try {\r\n      execSync('gh --version', { stdio: 'ignore' });\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async checkAuthentication() {\r\n    try {\r\n      const result = await this.execute('auth status');\r\n      return result.code === 0;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  getStats() {\r\n    return { ...this.stats };\r\n  }\r\n\r\n  getActiveProcessCount() {\r\n    return this.activeProcesses.size;\r\n  }\r\n\r\n  async cleanup() {\r\n    // Kill all active processes\r\n    for (const [processId, child] of this.activeProcesses) {\r\n      this.killProcess(child, processId);\r\n    }\r\n    this.activeProcesses.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function for creating configured instances\r\n */\r\nexport function createGitHubCliSafe(options = {}) {\r\n  return new GitHubCliSafe(options);\r\n}\r\n\r\n/**\r\n * Default singleton instance\r\n */\r\nexport const githubCli = new GitHubCliSafe();\r\n\r\n/**\r\n * Legacy compatibility functions\r\n */\r\nexport async function safeGhCommand(command, target, body, options = {}) {\r\n  return await githubCli.execute(`${command} ${target}`, { body, ...options });\r\n}\r\n\r\nexport const gh = {\r\n  async issueComment(issue, body, options = {}) {\r\n    return await githubCli.addIssueComment(issue, body, options);\r\n  },\r\n  \r\n  async prComment(pr, body, options = {}) {\r\n    return await githubCli.addPRComment(pr, body, options);\r\n  },\r\n  \r\n  async createIssue(params) {\r\n    return await githubCli.createIssue(params);\r\n  },\r\n  \r\n  async createPR(params) {\r\n    return await githubCli.createPR(params);\r\n  }\r\n};\r\n\r\n/**\r\n * Process cleanup on exit\r\n */\r\nprocess.on('SIGINT', async () => {\r\n  await githubCli.cleanup();\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGTERM', async () => {\r\n  await githubCli.cleanup();\r\n  process.exit(0);\r\n});\r\n\r\nexport default GitHubCliSafe;"],"names":["promises","fs","tmpdir","resolve","randomBytes","spawn","execSync","performance","CONFIG","DEFAULT_TIMEOUT","MAX_TIMEOUT","MAX_RETRIES","RETRY_BASE_DELAY","MAX_BODY_SIZE","RATE_LIMIT_WINDOW","MAX_REQUESTS_PER_WINDOW","TEMP_FILE_PREFIX","ALLOWED_COMMANDS","DANGEROUS_PATTERNS","GitHubCliError","Error","message","code","details","name","timestamp","Date","toISOString","GitHubCliTimeoutError","timeout","command","GitHubCliValidationError","field","value","GitHubCliRateLimitError","RateLimiter","maxRequests","windowMs","requests","checkLimit","now","filter","time","length","oldestRequest","Math","min","resetTime","waitTime","ceil","push","GitHubCliSafe","options","maxRetries","retryDelay","enableRateLimit","enableLogging","tempDir","rateLimiter","activeProcesses","Map","stats","totalRequests","successfulRequests","failedRequests","timeoutRequests","retriedRequests","validateCommand","trim","parts","split","mainCommand","includes","sanitizeInput","input","String","pattern","test","validateBodySize","body","Buffer","byteLength","createSecureTempFile","content","suffix","filename","toString","filepath","writeFile","mode","cleanupTempFile","unlink","error","console","warn","executeWithTimeout","args","processId","Promise","reject","startTime","child","stdio","shell","env","process","cwd","set","stdout","stderr","isTimedOut","isResolved","timer","setTimeout","killProcess","join","on","data","signal","clearTimeout","delete","duration","originalError","kill","has","withRetry","operation","lastError","attempt","delay","pow","sleep","ms","execute","validatedCommand","tempFile","sanitizedBody","title","labels","Array","isArray","sanitizedLabels","map","label","assignees","sanitizedAssignees","assignee","flags","flag","Object","entries","slice","createIssue","createPR","base","head","draft","addIssueComment","issueNumber","addPRComment","prNumber","createRelease","tag","prerelease","checkGitHubCli","checkAuthentication","result","getStats","getActiveProcessCount","size","cleanup","clear","createGitHubCliSafe","githubCli","safeGhCommand","target","gh","issueComment","issue","prComment","pr","params","exit"],"mappings":"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"}
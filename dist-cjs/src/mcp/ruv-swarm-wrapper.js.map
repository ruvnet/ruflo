{"version":3,"sources":["../../../src/mcp/ruv-swarm-wrapper.js"],"sourcesContent":["/**\r\n * Wrapper for ruv-swarm MCP server to handle logger issues\r\n * This wrapper ensures compatibility and handles known issues in ruv-swarm\r\n */\r\n\r\nimport { spawn } from 'child_process';\r\nimport { createInterface } from 'readline';\r\n\r\nexport class RuvSwarmWrapper {\r\n  constructor(options = {}) {\r\n    this.options = {\r\n      silent: options.silent || false,\r\n      autoRestart: options.autoRestart !== false,\r\n      maxRestarts: options.maxRestarts || 3,\r\n      restartDelay: options.restartDelay || 1000,\r\n      ...options,\r\n    };\r\n\r\n    this.process = null;\r\n    this.restartCount = 0;\r\n    this.isShuttingDown = false;\r\n  }\r\n\r\n  async start() {\r\n    if (this.process) {\r\n      throw new Error('RuvSwarm MCP server is already running');\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        // Spawn ruv-swarm MCP server\r\n        this.process = spawn('npx', ['ruv-swarm', 'mcp', 'start'], {\r\n          stdio: ['pipe', 'pipe', 'pipe'],\r\n          env: {\r\n            ...process.env,\r\n            // Ensure stdio mode for MCP\r\n            MCP_MODE: 'stdio',\r\n            // Set log level to reduce noise\r\n            LOG_LEVEL: 'WARN',\r\n          },\r\n        });\r\n\r\n        let initialized = false;\r\n        let initTimeout;\r\n\r\n        // Handle stdout (JSON-RPC messages)\r\n        const rlOut = createInterface({\r\n          input: this.process.stdout,\r\n          crlfDelay: Infinity,\r\n        });\r\n\r\n        rlOut.on('line', (line) => {\r\n          try {\r\n            const message = JSON.parse(line);\r\n\r\n            // Check for initialization\r\n            if (message.method === 'server.initialized' && !initialized) {\r\n              initialized = true;\r\n              clearTimeout(initTimeout);\r\n              resolve({\r\n                process: this.process,\r\n                stdout: this.process.stdout,\r\n                stdin: this.process.stdin,\r\n              });\r\n            }\r\n\r\n            // Forward JSON-RPC messages\r\n            process.stdout.write(line + '\\n');\r\n          } catch (err) {\r\n            // Not JSON, ignore\r\n          }\r\n        });\r\n\r\n        // Handle stderr (logs and errors)\r\n        const rlErr = createInterface({\r\n          input: this.process.stderr,\r\n          crlfDelay: Infinity,\r\n        });\r\n\r\n        rlErr.on('line', (line) => {\r\n          // Parse structured error messages if available\r\n          try {\r\n            const errorData = JSON.parse(line);\r\n            if (errorData.error && errorData.error.code) {\r\n              // Handle specific error codes\r\n              switch (errorData.error.code) {\r\n                case 'LOGGER_METHOD_MISSING':\r\n                case 'ERR_LOGGER_MEMORY_USAGE':\r\n                  // Known issue with logger.logMemoryUsage in ruv-swarm\r\n                  if (!this.options.silent) {\r\n                    console.error(\r\n                      '‚ö†Ô∏è  Known ruv-swarm logger issue detected (continuing normally)',\r\n                    );\r\n                  }\r\n                  return;\r\n                case 'ERR_INITIALIZATION':\r\n                  console.error('‚ùå RuvSwarm initialization error:', errorData.error.message);\r\n                  return;\r\n                default:\r\n                  // Unknown error code, log it\r\n                  if (!this.options.silent) {\r\n                    console.error(\r\n                      `RuvSwarm error [${errorData.error.code}]:`,\r\n                      errorData.error.message,\r\n                    );\r\n                  }\r\n              }\r\n              return;\r\n            }\r\n          } catch (e) {\r\n            // Not JSON, check for known text patterns as fallback\r\n            const knownErrorPatterns = [\r\n              {\r\n                pattern: /logger\\.logMemoryUsage is not a function/,\r\n                code: 'LOGGER_METHOD_MISSING',\r\n                message: 'Known ruv-swarm logger issue detected (continuing normally)',\r\n              },\r\n              {\r\n                pattern: /Cannot find module/,\r\n                code: 'MODULE_NOT_FOUND',\r\n                message: 'Module not found error',\r\n              },\r\n              {\r\n                pattern: /ECONNREFUSED/,\r\n                code: 'CONNECTION_REFUSED',\r\n                message: 'Connection refused error',\r\n              },\r\n            ];\r\n\r\n            for (const errorPattern of knownErrorPatterns) {\r\n              if (errorPattern.pattern.test(line)) {\r\n                if (!this.options.silent || errorPattern.code !== 'LOGGER_METHOD_MISSING') {\r\n                  console.error(`‚ö†Ô∏è  ${errorPattern.message}`);\r\n                }\r\n                return;\r\n              }\r\n            }\r\n          }\r\n\r\n          // Filter out initialization messages if silent\r\n          if (this.options.silent) {\r\n            if (line.includes('‚úÖ') || line.includes('üß†') || line.includes('üìä')) {\r\n              return;\r\n            }\r\n          }\r\n\r\n          // Forward other stderr output\r\n          if (!this.options.silent) {\r\n            process.stderr.write(line + '\\n');\r\n          }\r\n        });\r\n\r\n        // Handle process errors\r\n        this.process.on('error', (error) => {\r\n          if (!initialized) {\r\n            clearTimeout(initTimeout);\r\n            reject(new Error(`Failed to start ruv-swarm: ${error.message}`));\r\n          } else {\r\n            console.error('RuvSwarm process error:', error);\r\n            this.handleProcessExit(error.code || 1);\r\n          }\r\n        });\r\n\r\n        // Handle process exit\r\n        this.process.on('exit', (code, signal) => {\r\n          if (!initialized) {\r\n            clearTimeout(initTimeout);\r\n            reject(\r\n              new Error(`RuvSwarm exited before initialization: code ${code}, signal ${signal}`),\r\n            );\r\n          } else {\r\n            this.handleProcessExit(code || 0);\r\n          }\r\n        });\r\n\r\n        // Set initialization timeout\r\n        initTimeout = setTimeout(() => {\r\n          if (!initialized) {\r\n            this.stop();\r\n            reject(new Error('RuvSwarm initialization timeout'));\r\n          }\r\n        }, 30000); // 30 second timeout\r\n      } catch (error) {\r\n        reject(error);\r\n      }\r\n    });\r\n  }\r\n\r\n  handleProcessExit(code) {\r\n    this.process = null;\r\n\r\n    if (this.isShuttingDown) {\r\n      return;\r\n    }\r\n\r\n    console.error(`RuvSwarm MCP server exited with code ${code}`);\r\n\r\n    // Auto-restart if enabled and under limit\r\n    if (this.options.autoRestart && this.restartCount < this.options.maxRestarts) {\r\n      this.restartCount++;\r\n      console.log(\r\n        `Attempting to restart RuvSwarm (attempt ${this.restartCount}/${this.options.maxRestarts})...`,\r\n      );\r\n\r\n      setTimeout(() => {\r\n        this.start().catch((err) => {\r\n          console.error('Failed to restart RuvSwarm:', err);\r\n        });\r\n      }, this.options.restartDelay);\r\n    }\r\n  }\r\n\r\n  async stop() {\r\n    this.isShuttingDown = true;\r\n\r\n    if (!this.process) {\r\n      return;\r\n    }\r\n\r\n    return new Promise((resolve) => {\r\n      const killTimeout = setTimeout(() => {\r\n        console.warn('RuvSwarm did not exit gracefully, forcing kill...');\r\n        this.process.kill('SIGKILL');\r\n      }, 5000);\r\n\r\n      this.process.on('exit', () => {\r\n        clearTimeout(killTimeout);\r\n        this.process = null;\r\n        resolve();\r\n      });\r\n\r\n      // Send graceful shutdown signal\r\n      this.process.kill('SIGTERM');\r\n    });\r\n  }\r\n\r\n  isRunning() {\r\n    return this.process !== null && !this.process.killed;\r\n  }\r\n}\r\n\r\n// Export a function to start ruv-swarm with error handling\r\nexport async function startRuvSwarmMCP(options = {}) {\r\n  const wrapper = new RuvSwarmWrapper(options);\r\n\r\n  try {\r\n    const result = await wrapper.start();\r\n    console.log('‚úÖ RuvSwarm MCP server started successfully');\r\n    return { wrapper, ...result };\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to start RuvSwarm MCP server:', error.message);\r\n    throw error;\r\n  }\r\n}\r\n"],"names":["spawn","createInterface","RuvSwarmWrapper","options","silent","autoRestart","maxRestarts","restartDelay","process","restartCount","isShuttingDown","start","Error","Promise","resolve","reject","stdio","env","MCP_MODE","LOG_LEVEL","initialized","initTimeout","rlOut","input","stdout","crlfDelay","Infinity","on","line","message","JSON","parse","method","clearTimeout","stdin","write","err","rlErr","stderr","errorData","error","code","console","e","knownErrorPatterns","pattern","errorPattern","test","includes","handleProcessExit","signal","setTimeout","stop","log","catch","killTimeout","warn","kill","isRunning","killed","startRuvSwarmMCP","wrapper","result"],"mappings":"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"}
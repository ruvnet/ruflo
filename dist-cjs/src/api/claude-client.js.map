{"version":3,"sources":["../../../src/api/claude-client.ts"],"sourcesContent":["/**\r\n * Claude API client for Claude-Flow\r\n * Provides direct integration with Claude's API including temperature and model selection\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport { ILogger } from '../core/logger.js';\r\nimport { ConfigManager } from '../config/config-manager.js';\r\nimport { \r\n  ClaudeAPIError,\r\n  ClaudeInternalServerError,\r\n  ClaudeServiceUnavailableError,\r\n  ClaudeRateLimitError,\r\n  ClaudeTimeoutError,\r\n  ClaudeNetworkError,\r\n  ClaudeAuthenticationError,\r\n  ClaudeValidationError,\r\n  HealthCheckResult,\r\n  getUserFriendlyError,\r\n} from './claude-api-errors.js';\r\nimport { circuitBreaker, CircuitBreaker } from '../utils/helpers.js';\r\n\r\nexport interface ClaudeAPIConfig {\r\n  apiKey: string;\r\n  apiUrl?: string;\r\n  model?: ClaudeModel;\r\n  temperature?: number;\r\n  maxTokens?: number;\r\n  topP?: number;\r\n  topK?: number;\r\n  systemPrompt?: string;\r\n  timeout?: number;\r\n  retryAttempts?: number;\r\n  retryDelay?: number;\r\n  // Enhanced error handling options\r\n  enableHealthCheck?: boolean;\r\n  healthCheckInterval?: number;\r\n  circuitBreakerThreshold?: number;\r\n  circuitBreakerTimeout?: number;\r\n  circuitBreakerResetTimeout?: number;\r\n  retryJitter?: boolean;\r\n}\r\n\r\nexport type ClaudeModel =\r\n  | 'claude-3-opus-20240229'\r\n  | 'claude-3-sonnet-20240229'\r\n  | 'claude-3-haiku-20240307'\r\n  | 'claude-2.1'\r\n  | 'claude-2.0'\r\n  | 'claude-instant-1.2';\r\n\r\nexport interface ClaudeMessage {\r\n  role: 'user' | 'assistant';\r\n  content: string;\r\n}\r\n\r\nexport interface ClaudeRequest {\r\n  model: ClaudeModel;\r\n  messages: ClaudeMessage[];\r\n  system?: string;\r\n  max_tokens: number;\r\n  temperature?: number;\r\n  top_p?: number;\r\n  top_k?: number;\r\n  metadata?: {\r\n    user_id?: string;\r\n  };\r\n  stop_sequences?: string[];\r\n  stream?: boolean;\r\n}\r\n\r\nexport interface ClaudeResponse {\r\n  id: string;\r\n  type: 'message';\r\n  role: 'assistant';\r\n  content: Array<{\r\n    type: 'text';\r\n    text: string;\r\n  }>;\r\n  model: ClaudeModel;\r\n  stop_reason: 'end_turn' | 'max_tokens' | 'stop_sequence';\r\n  stop_sequence?: string;\r\n  usage: {\r\n    input_tokens: number;\r\n    output_tokens: number;\r\n  };\r\n}\r\n\r\nexport interface ClaudeStreamEvent {\r\n  type:\r\n    | 'message_start'\r\n    | 'content_block_start'\r\n    | 'content_block_delta'\r\n    | 'content_block_stop'\r\n    | 'message_delta'\r\n    | 'message_stop'\r\n    | 'ping'\r\n    | 'error';\r\n  message?: Partial<ClaudeResponse>;\r\n  index?: number;\r\n  delta?: {\r\n    type?: 'text_delta';\r\n    text?: string;\r\n    stop_reason?: string;\r\n    stop_sequence?: string;\r\n  };\r\n  content_block?: {\r\n    type: 'text';\r\n    text: string;\r\n  };\r\n  usage?: {\r\n    output_tokens: number;\r\n  };\r\n  error?: {\r\n    type: string;\r\n    message: string;\r\n  };\r\n}\r\n\r\nexport class ClaudeAPIClient extends EventEmitter {\r\n  private config: ClaudeAPIConfig;\r\n  private logger: ILogger;\r\n  private configManager: ConfigManager;\r\n  private defaultModel: ClaudeModel = 'claude-3-sonnet-20240229';\r\n  private defaultTemperature: number = 0.7;\r\n  private defaultMaxTokens: number = 4096;\r\n  private circuitBreaker: CircuitBreaker;\r\n  private lastHealthCheck?: HealthCheckResult;\r\n  private healthCheckTimer?: NodeJS.Timeout;\r\n\r\n  constructor(logger: ILogger, configManager: ConfigManager, config?: Partial<ClaudeAPIConfig>) {\r\n    super();\r\n    this.logger = logger;\r\n    this.configManager = configManager;\r\n\r\n    // Load config from environment and merge with provided config\r\n    this.config = this.loadConfiguration(config);\r\n    \r\n    // Initialize circuit breaker for API reliability\r\n    this.circuitBreaker = circuitBreaker('claude-api', {\r\n      threshold: this.config.circuitBreakerThreshold || 5,\r\n      timeout: this.config.circuitBreakerTimeout || 60000,\r\n      resetTimeout: this.config.circuitBreakerResetTimeout || 300000,\r\n    });\r\n\r\n    // Start health check if enabled\r\n    if (this.config.enableHealthCheck) {\r\n      this.startHealthCheck();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load configuration from various sources\r\n   */\r\n  private loadConfiguration(overrides?: Partial<ClaudeAPIConfig>): ClaudeAPIConfig {\r\n    // Start with defaults\r\n    const config: ClaudeAPIConfig = {\r\n      apiKey: '',\r\n      apiUrl: 'https://api.anthropic.com/v1/messages',\r\n      model: this.defaultModel,\r\n      temperature: this.defaultTemperature,\r\n      maxTokens: this.defaultMaxTokens,\r\n      topP: 1,\r\n      topK: undefined,\r\n      systemPrompt: undefined,\r\n      timeout: 60000, // 60 seconds\r\n      retryAttempts: 3,\r\n      retryDelay: 1000,\r\n      // Enhanced error handling defaults\r\n      enableHealthCheck: false,\r\n      healthCheckInterval: 300000, // 5 minutes\r\n      circuitBreakerThreshold: 5,\r\n      circuitBreakerTimeout: 60000,\r\n      circuitBreakerResetTimeout: 300000,\r\n      retryJitter: true,\r\n    };\r\n\r\n    // Load from environment variables\r\n    if (process.env.ANTHROPIC_API_KEY) {\r\n      config.apiKey = process.env.ANTHROPIC_API_KEY;\r\n    }\r\n    if (process.env.CLAUDE_API_URL) {\r\n      config.apiUrl = process.env.CLAUDE_API_URL;\r\n    }\r\n    if (process.env.CLAUDE_MODEL) {\r\n      config.model = process.env.CLAUDE_MODEL as ClaudeModel;\r\n    }\r\n    if (process.env.CLAUDE_TEMPERATURE) {\r\n      config.temperature = parseFloat(process.env.CLAUDE_TEMPERATURE);\r\n    }\r\n    if (process.env.CLAUDE_MAX_TOKENS) {\r\n      config.maxTokens = parseInt(process.env.CLAUDE_MAX_TOKENS, 10);\r\n    }\r\n\r\n    // Load from config manager if available\r\n    const claudeConfig = this.configManager.get('claude');\r\n    if (claudeConfig) {\r\n      Object.assign(config, claudeConfig);\r\n    }\r\n\r\n    // Apply overrides\r\n    if (overrides) {\r\n      Object.assign(config, overrides);\r\n    }\r\n\r\n    // Validate configuration\r\n    this.validateConfiguration(config);\r\n\r\n    return config;\r\n  }\r\n\r\n  /**\r\n   * Validate configuration settings\r\n   */\r\n  private validateConfiguration(config: ClaudeAPIConfig): void {\r\n    if (!config.apiKey) {\r\n      throw new ClaudeAuthenticationError('Claude API key is required. Set ANTHROPIC_API_KEY environment variable.');\r\n    }\r\n\r\n    if (config.temperature !== undefined) {\r\n      if (config.temperature < 0 || config.temperature > 1) {\r\n        throw new ClaudeValidationError('Temperature must be between 0 and 1');\r\n      }\r\n    }\r\n\r\n    if (config.topP !== undefined) {\r\n      if (config.topP < 0 || config.topP > 1) {\r\n        throw new ClaudeValidationError('Top-p must be between 0 and 1');\r\n      }\r\n    }\r\n\r\n    if (config.maxTokens !== undefined && (config.maxTokens < 1 || config.maxTokens > 100000)) {\r\n      throw new ClaudeValidationError('Max tokens must be between 1 and 100000');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update configuration dynamically\r\n   */\r\n  updateConfig(updates: Partial<ClaudeAPIConfig>): void {\r\n    this.config = { ...this.config, ...updates };\r\n    this.validateConfiguration(this.config);\r\n    this.logger.info('Claude API configuration updated', {\r\n      model: this.config.model,\r\n      temperature: this.config.temperature,\r\n      maxTokens: this.config.maxTokens,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): ClaudeAPIConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Send a message to Claude API\r\n   */\r\n  async sendMessage(\r\n    messages: ClaudeMessage[],\r\n    options?: {\r\n      model?: ClaudeModel;\r\n      temperature?: number;\r\n      maxTokens?: number;\r\n      systemPrompt?: string;\r\n      stream?: boolean;\r\n    },\r\n  ): Promise<ClaudeResponse | AsyncIterable<ClaudeStreamEvent>> {\r\n    const request: ClaudeRequest = {\r\n      model: options?.model || this.config.model || 'claude-3-opus-20240229',\r\n      messages,\r\n      system: options?.systemPrompt || this.config.systemPrompt,\r\n      max_tokens: options?.maxTokens || this.config.maxTokens || 4096,\r\n      temperature: options?.temperature ?? this.config.temperature,\r\n      top_p: this.config.topP,\r\n      top_k: this.config.topK,\r\n      stream: options?.stream || false,\r\n    };\r\n\r\n    this.logger.debug('Sending Claude API request', {\r\n      model: request.model,\r\n      temperature: request.temperature,\r\n      maxTokens: request.max_tokens,\r\n      messageCount: messages.length,\r\n      stream: request.stream,\r\n    });\r\n\r\n    if (request.stream) {\r\n      return this.streamRequest(request);\r\n    } else {\r\n      return this.sendRequest(request);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Send a non-streaming request\r\n   */\r\n  private async sendRequest(request: ClaudeRequest): Promise<ClaudeResponse> {\r\n    let lastError: ClaudeAPIError | undefined;\r\n\r\n    for (let attempt = 0; attempt < (this.config.retryAttempts || 3); attempt++) {\r\n      try {\r\n        const controller = new AbortController();\r\n        const timeout = setTimeout(() => controller.abort(), this.config.timeout || 30000);\r\n\r\n        const response = await fetch(this.config.apiUrl || 'https://api.anthropic.com/v1/messages', {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'anthropic-version': '2023-06-01',\r\n            'x-api-key': this.config.apiKey,\r\n          },\r\n          body: JSON.stringify(request),\r\n          signal: controller.signal,\r\n        });\r\n\r\n        clearTimeout(timeout);\r\n\r\n        if (!response.ok) {\r\n          const errorText = await response.text();\r\n          let errorData: any;\r\n          \r\n          try {\r\n            errorData = JSON.parse(errorText);\r\n          } catch {\r\n            errorData = { message: errorText };\r\n          }\r\n\r\n          throw this.createAPIError(response.status, errorData);\r\n        }\r\n\r\n        const data = (await response.json()) as ClaudeResponse;\r\n\r\n        this.logger.info('Claude API response received', {\r\n          model: data.model,\r\n          inputTokens: data.usage.input_tokens,\r\n          outputTokens: data.usage.output_tokens,\r\n          stopReason: data.stop_reason,\r\n        });\r\n\r\n        this.emit('response', data);\r\n        return data;\r\n      } catch (error) {\r\n        lastError = this.transformError(error);\r\n        \r\n        // Don't retry non-retryable errors\r\n        if (!lastError.retryable) {\r\n          this.handleError(lastError);\r\n          throw lastError;\r\n        }\r\n\r\n        this.logger.warn(\r\n          `Claude API request failed (attempt ${attempt + 1}/${this.config.retryAttempts})`,\r\n          {\r\n            error: lastError.message,\r\n            statusCode: lastError.statusCode,\r\n            retryable: lastError.retryable,\r\n          },\r\n        );\r\n\r\n        if (attempt < (this.config.retryAttempts || 3) - 1) {\r\n          const delay = this.calculateRetryDelay(attempt, lastError);\r\n          await this.delay(delay);\r\n        }\r\n      }\r\n    }\r\n\r\n    this.handleError(lastError!);\r\n    throw lastError;\r\n  }\r\n\r\n  /**\r\n   * Send a streaming request\r\n   */\r\n  private async *streamRequest(request: ClaudeRequest): AsyncIterable<ClaudeStreamEvent> {\r\n    const controller = new AbortController();\r\n    const timeout = setTimeout(() => controller.abort(), (this.config.timeout || 30000) * 2); // Double timeout for streaming\r\n\r\n    try {\r\n      const response = await fetch(this.config.apiUrl || 'https://api.anthropic.com/v1/messages', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'anthropic-version': '2023-06-01',\r\n          'x-api-key': this.config.apiKey,\r\n        },\r\n        body: JSON.stringify({ ...request, stream: true }),\r\n        signal: controller.signal,\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        let errorData: any;\r\n        \r\n        try {\r\n          errorData = JSON.parse(errorText);\r\n        } catch {\r\n          errorData = { message: errorText };\r\n        }\r\n\r\n        throw this.createAPIError(response.status, errorData);\r\n      }\r\n\r\n      if (!response.body) {\r\n        throw new ClaudeAPIError('Response body is null');\r\n      }\r\n      const reader = response.body.getReader();\r\n      const decoder = new TextDecoder();\r\n      let buffer = '';\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6);\r\n            if (data === '[DONE]') continue;\r\n\r\n            try {\r\n              const event = JSON.parse(data) as ClaudeStreamEvent;\r\n              this.emit('stream_event', event);\r\n              yield event;\r\n            } catch (e) {\r\n              this.logger.warn('Failed to parse stream event', { data, error: e });\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      clearTimeout(timeout);\r\n      \r\n      // Handle abort/timeout\r\n      if (error instanceof Error && error.name === 'AbortError') {\r\n        throw new ClaudeTimeoutError(\r\n          'Request timed out',\r\n          this.config.timeout || 60000,\r\n        );\r\n      }\r\n      \r\n      throw error;\r\n    } finally {\r\n      clearTimeout(timeout);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Helper method for simple completions\r\n   */\r\n  async complete(\r\n    prompt: string,\r\n    options?: {\r\n      model?: ClaudeModel;\r\n      temperature?: number;\r\n      maxTokens?: number;\r\n      systemPrompt?: string;\r\n    },\r\n  ): Promise<string> {\r\n    const messages: ClaudeMessage[] = [{ role: 'user', content: prompt }];\r\n    const response = (await this.sendMessage(messages, options)) as ClaudeResponse;\r\n    return response.content[0].text;\r\n  }\r\n\r\n  /**\r\n   * Helper method for streaming completions\r\n   */\r\n  async *streamComplete(\r\n    prompt: string,\r\n    options?: {\r\n      model?: ClaudeModel;\r\n      temperature?: number;\r\n      maxTokens?: number;\r\n      systemPrompt?: string;\r\n    },\r\n  ): AsyncIterable<string> {\r\n    const messages: ClaudeMessage[] = [{ role: 'user', content: prompt }];\r\n    const stream = (await this.sendMessage(messages, {\r\n      ...options,\r\n      stream: true,\r\n    })) as AsyncIterable<ClaudeStreamEvent>;\r\n\r\n    for await (const event of stream) {\r\n      if (event.type === 'content_block_delta' && event.delta?.text) {\r\n        yield event.delta.text;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get available models\r\n   */\r\n  getAvailableModels(): ClaudeModel[] {\r\n    return [\r\n      'claude-3-opus-20240229',\r\n      'claude-3-sonnet-20240229',\r\n      'claude-3-haiku-20240307',\r\n      'claude-2.1',\r\n      'claude-2.0',\r\n      'claude-instant-1.2',\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * Get model information\r\n   */\r\n  getModelInfo(model: ClaudeModel): {\r\n    name: string;\r\n    contextWindow: number;\r\n    description: string;\r\n  } {\r\n    const modelInfo: Record<\r\n      ClaudeModel,\r\n      { name: string; contextWindow: number; description: string }\r\n    > = {\r\n      'claude-3-opus-20240229': {\r\n        name: 'Claude 3 Opus',\r\n        contextWindow: 200000,\r\n        description: 'Most capable model, best for complex tasks',\r\n      },\r\n      'claude-3-sonnet-20240229': {\r\n        name: 'Claude 3 Sonnet',\r\n        contextWindow: 200000,\r\n        description: 'Balanced performance and speed',\r\n      },\r\n      'claude-3-haiku-20240307': {\r\n        name: 'Claude 3 Haiku',\r\n        contextWindow: 200000,\r\n        description: 'Fastest model, best for simple tasks',\r\n      },\r\n      'claude-2.1': {\r\n        name: 'Claude 2.1',\r\n        contextWindow: 200000,\r\n        description: 'Previous generation, enhanced capabilities',\r\n      },\r\n      'claude-2.0': {\r\n        name: 'Claude 2.0',\r\n        contextWindow: 100000,\r\n        description: 'Previous generation model',\r\n      },\r\n      'claude-instant-1.2': {\r\n        name: 'Claude Instant 1.2',\r\n        contextWindow: 100000,\r\n        description: 'Fast, cost-effective model',\r\n      },\r\n    };\r\n\r\n    return (\r\n      modelInfo[model] || {\r\n        name: model,\r\n        contextWindow: 100000,\r\n        description: 'Unknown model',\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Delay helper for retries\r\n   */\r\n  private delay(ms: number): Promise<void> {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * Start periodic health checks\r\n   */\r\n  private startHealthCheck(): void {\r\n    this.performHealthCheck(); // Initial check\r\n    \r\n    this.healthCheckTimer = setInterval(\r\n      () => this.performHealthCheck(),\r\n      this.config.healthCheckInterval || 300000,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Perform a health check on the API\r\n   */\r\n  async performHealthCheck(): Promise<HealthCheckResult> {\r\n    const startTime = Date.now();\r\n    \r\n    try {\r\n      const controller = new AbortController();\r\n      const timeout = setTimeout(() => controller.abort(), 10000); // 10 second timeout\r\n\r\n      const response = await fetch(this.config.apiUrl || '', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'anthropic-version': '2023-06-01',\r\n          'x-api-key': this.config.apiKey,\r\n        },\r\n        body: JSON.stringify({\r\n          model: this.config.model,\r\n          messages: [{ role: 'user', content: 'Hi' }],\r\n          max_tokens: 1,\r\n        }),\r\n        signal: controller.signal,\r\n      });\r\n\r\n      clearTimeout(timeout);\r\n      \r\n      const latency = Date.now() - startTime;\r\n      const healthy = response.ok || response.status === 429; // Rate limit is still \"healthy\"\r\n      \r\n      this.lastHealthCheck = {\r\n        healthy,\r\n        latency,\r\n        error: healthy ? undefined : `Status: ${response.status}`,\r\n        timestamp: new Date(),\r\n      };\r\n\r\n      this.logger.debug('Claude API health check completed', this.lastHealthCheck);\r\n      this.emit('health_check', this.lastHealthCheck);\r\n      \r\n      return this.lastHealthCheck;\r\n    } catch (error) {\r\n      const latency = Date.now() - startTime;\r\n      \r\n      this.lastHealthCheck = {\r\n        healthy: false,\r\n        latency,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        timestamp: new Date(),\r\n      };\r\n\r\n      this.logger.warn('Claude API health check failed', this.lastHealthCheck);\r\n      this.emit('health_check', this.lastHealthCheck);\r\n      \r\n      return this.lastHealthCheck;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get last health check result\r\n   */\r\n  getHealthStatus(): HealthCheckResult | undefined {\r\n    return this.lastHealthCheck;\r\n  }\r\n\r\n  /**\r\n   * Create appropriate error based on status code\r\n   */\r\n  private createAPIError(statusCode: number, errorData: any): ClaudeAPIError {\r\n    const message = errorData.error?.message || errorData.message || 'Unknown error';\r\n\r\n    switch (statusCode) {\r\n      case 400:\r\n        return new ClaudeValidationError(message, errorData);\r\n      case 401:\r\n      case 403:\r\n        return new ClaudeAuthenticationError(message, errorData);\r\n      case 429: {\r\n        const retryAfter = errorData.error?.retry_after;\r\n        return new ClaudeRateLimitError(message, retryAfter, errorData);\r\n      }\r\n      case 500:\r\n        return new ClaudeInternalServerError(message, errorData);\r\n      case 503:\r\n        return new ClaudeServiceUnavailableError(message, errorData);\r\n      default:\r\n        return new ClaudeAPIError(message, statusCode, statusCode >= 500, errorData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform generic errors to Claude API errors\r\n   */\r\n  private transformError(error: unknown): ClaudeAPIError {\r\n    if (error instanceof ClaudeAPIError) {\r\n      return error;\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      // Network errors\r\n      if (error.message.includes('fetch failed') || error.message.includes('ECONNREFUSED')) {\r\n        return new ClaudeNetworkError(error.message);\r\n      }\r\n      \r\n      // Timeout errors\r\n      if (error.name === 'AbortError' || error.message.includes('timeout')) {\r\n        return new ClaudeTimeoutError(error.message, this.config.timeout || 60000);\r\n      }\r\n    }\r\n\r\n    return new ClaudeAPIError(\r\n      error instanceof Error ? error.message : String(error),\r\n      undefined,\r\n      true, // Assume unknown errors are retryable\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Calculate retry delay with exponential backoff and jitter\r\n   */\r\n  private calculateRetryDelay(attempt: number, error: ClaudeAPIError): number {\r\n    // If rate limit error with retry-after header, use that\r\n    if (error instanceof ClaudeRateLimitError && error.retryAfter) {\r\n      return error.retryAfter * 1000; // Convert to milliseconds\r\n    }\r\n\r\n    const baseDelay = this.config.retryDelay || 1000;\r\n    const maxDelay = 30000; // 30 seconds max\r\n    \r\n    // Exponential backoff: delay = baseDelay * (2 ^ attempt)\r\n    let delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);\r\n    \r\n    // Add jitter to prevent thundering herd\r\n    if (this.config.retryJitter) {\r\n      const jitter = Math.random() * 0.3 * delay; // Up to 30% jitter\r\n      delay = delay + jitter;\r\n    }\r\n\r\n    return Math.floor(delay);\r\n  }\r\n\r\n  /**\r\n   * Handle errors with user-friendly messages and logging\r\n   */\r\n  private handleError(error: ClaudeAPIError): void {\r\n    const errorInfo = getUserFriendlyError(error);\r\n    \r\n    this.logger.error(`${errorInfo.title}: ${errorInfo.message}`, {\r\n      error: error.message,\r\n      code: error.code,\r\n      statusCode: error.statusCode,\r\n      retryable: error.retryable,\r\n      details: error.details,\r\n    });\r\n\r\n    // Log suggestions in debug mode\r\n    if (this.logger.level === 'debug' && errorInfo.suggestions.length > 0) {\r\n      this.logger.debug('Suggestions to resolve the issue:', errorInfo.suggestions);\r\n    }\r\n\r\n    this.emit('error', {\r\n      error,\r\n      userFriendly: errorInfo,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clean up resources\r\n   */\r\n  destroy(): void {\r\n    if (this.healthCheckTimer) {\r\n      clearInterval(this.healthCheckTimer);\r\n      this.healthCheckTimer = undefined;\r\n    }\r\n    this.removeAllListeners();\r\n  }\r\n}\r\n"],"names":["EventEmitter","ClaudeAPIError","ClaudeInternalServerError","ClaudeServiceUnavailableError","ClaudeRateLimitError","ClaudeTimeoutError","ClaudeNetworkError","ClaudeAuthenticationError","ClaudeValidationError","getUserFriendlyError","circuitBreaker","ClaudeAPIClient","config","logger","configManager","defaultModel","defaultTemperature","defaultMaxTokens","lastHealthCheck","healthCheckTimer","loadConfiguration","threshold","circuitBreakerThreshold","timeout","circuitBreakerTimeout","resetTimeout","circuitBreakerResetTimeout","enableHealthCheck","startHealthCheck","overrides","apiKey","apiUrl","model","temperature","maxTokens","topP","topK","undefined","systemPrompt","retryAttempts","retryDelay","healthCheckInterval","retryJitter","process","env","ANTHROPIC_API_KEY","CLAUDE_API_URL","CLAUDE_MODEL","CLAUDE_TEMPERATURE","parseFloat","CLAUDE_MAX_TOKENS","parseInt","claudeConfig","get","Object","assign","validateConfiguration","updateConfig","updates","info","getConfig","sendMessage","messages","options","request","system","max_tokens","top_p","top_k","stream","debug","messageCount","length","streamRequest","sendRequest","lastError","attempt","controller","AbortController","setTimeout","abort","response","fetch","method","headers","body","JSON","stringify","signal","clearTimeout","ok","errorText","text","errorData","parse","message","createAPIError","status","data","json","inputTokens","usage","input_tokens","outputTokens","output_tokens","stopReason","stop_reason","emit","error","transformError","retryable","handleError","warn","statusCode","delay","calculateRetryDelay","reader","getReader","decoder","TextDecoder","buffer","done","value","read","decode","lines","split","pop","line","startsWith","slice","event","e","Error","name","complete","prompt","role","content","streamComplete","type","delta","getAvailableModels","getModelInfo","modelInfo","contextWindow","description","ms","Promise","resolve","performHealthCheck","setInterval","startTime","Date","now","latency","healthy","timestamp","getHealthStatus","retryAfter","retry_after","includes","String","baseDelay","maxDelay","Math","min","pow","jitter","random","floor","errorInfo","title","code","details","level","suggestions","userFriendly","destroy","clearInterval","removeAllListeners"],"mappings":"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"}
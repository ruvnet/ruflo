{"version":3,"sources":["../../../../src/cli/simple-commands/inject-memory-protocol.js"],"sourcesContent":["// inject-memory-protocol.js - Injects memory coordination protocol for swarms\r\n\r\nimport { existsSync } from 'fs';\r\nimport { promises as fs } from 'fs/promises';\r\nimport path from 'path';\r\n\r\n/**\r\n * Memory coordination protocol to inject\r\n */\r\nconst MEMORY_PROTOCOL = `\r\n## ðŸ§  MANDATORY MEMORY COORDINATION PROTOCOL\r\n\r\n### ðŸš¨ CRITICAL: Every Agent MUST Write AND Read Memory\r\n\r\n**EVERY spawned agent MUST follow this exact pattern:**\r\n\r\n\\`\\`\\`javascript\r\n// 1ï¸âƒ£ IMMEDIATELY when agent starts - WRITE initial status\r\nmcp__claude-flow__memory_usage {\r\n  action: \"store\",\r\n  key: \"swarm/[agent-name]/status\",\r\n  namespace: \"coordination\",\r\n  value: JSON.stringify({\r\n    agent: \"[agent-name]\",\r\n    status: \"starting\",\r\n    timestamp: Date.now(),\r\n    tasks: [\"list\", \"of\", \"tasks\"],\r\n    progress: 0\r\n  })\r\n}\r\n\r\n// 2ï¸âƒ£ AFTER EACH MAJOR STEP - WRITE progress\r\nmcp__claude-flow__memory_usage {\r\n  action: \"store\",\r\n  key: \"swarm/[agent-name]/progress\",\r\n  namespace: \"coordination\",\r\n  value: JSON.stringify({\r\n    completed: [\"task1\", \"task2\"],\r\n    current: \"working on task3\",\r\n    progress: 35,\r\n    files_created: [\"file1.js\"],\r\n    interfaces: { \"API\": \"definition\" },\r\n    dependencies_needed: []\r\n  })\r\n}\r\n\r\n// 3ï¸âƒ£ SHARE ARTIFACTS - WRITE for others\r\nmcp__claude-flow__memory_usage {\r\n  action: \"store\",\r\n  key: \"swarm/shared/[component]\",\r\n  namespace: \"coordination\",\r\n  value: JSON.stringify({\r\n    type: \"interface\",\r\n    definition: \"actual code here\",\r\n    created_by: \"[agent-name]\"\r\n  })\r\n}\r\n\r\n// 4ï¸âƒ£ CHECK DEPENDENCIES - READ then WAIT\r\nconst dep = mcp__claude-flow__memory_usage {\r\n  action: \"retrieve\",\r\n  key: \"swarm/shared/[component]\",\r\n  namespace: \"coordination\"\r\n}\r\nif (!dep.found) {\r\n  // Write waiting status\r\n  mcp__claude-flow__memory_usage {\r\n    action: \"store\",\r\n    key: \"swarm/[agent-name]/waiting\",\r\n    namespace: \"coordination\",\r\n    value: JSON.stringify({\r\n      waiting_for: \"[component]\",\r\n      from: \"[other-agent]\"\r\n    })\r\n  }\r\n}\r\n\r\n// 5ï¸âƒ£ SIGNAL COMPLETION\r\nmcp__claude-flow__memory_usage {\r\n  action: \"store\",\r\n  key: \"swarm/[agent-name]/complete\",\r\n  namespace: \"coordination\",\r\n  value: JSON.stringify({\r\n    status: \"complete\",\r\n    deliverables: [\"list\"],\r\n    integration_points: [\"how to use\"]\r\n  })\r\n}\r\n\\`\\`\\`\r\n\r\n### ðŸ“Š MEMORY KEY STRUCTURE\r\n- Use namespace: \"coordination\" ALWAYS\r\n- Keys: swarm/[agent]/status|progress|waiting|complete\r\n- Shared: swarm/shared/[component]\r\n\r\n### âŒ COMMON MISTAKES\r\n1. Only reading, never writing\r\n2. Wrong namespace\r\n3. No progress updates\r\n4. Missing shared artifacts\r\n`;\r\n\r\n/**\r\n * Agent instruction template with memory requirements\r\n */\r\nconst AGENT_INSTRUCTION = `\r\nðŸš¨ MANDATORY MEMORY COORDINATION:\r\n\r\n1. START - IMMEDIATELY write status:\r\n   mcp__claude-flow__memory_usage { action: \"store\", key: \"swarm/[your-name]/status\", namespace: \"coordination\", value: {status: \"starting\"} }\r\n\r\n2. PROGRESS - After EVERY major step:\r\n   mcp__claude-flow__memory_usage { action: \"store\", key: \"swarm/[your-name]/progress\", namespace: \"coordination\", value: {progress: X%} }\r\n\r\n3. SHARE - Write ALL interfaces/APIs:\r\n   mcp__claude-flow__memory_usage { action: \"store\", key: \"swarm/shared/[component]\", namespace: \"coordination\", value: {definition: \"...\"} }\r\n\r\n4. CHECK - Verify dependencies exist:\r\n   mcp__claude-flow__memory_usage { action: \"retrieve\", key: \"swarm/shared/[component]\", namespace: \"coordination\" }\r\n\r\n5. COMPLETE - Signal when done:\r\n   mcp__claude-flow__memory_usage { action: \"store\", key: \"swarm/[your-name]/complete\", namespace: \"coordination\", value: {deliverables: [...]} }\r\n\r\nREMEMBER: If you don't WRITE to memory, other agents can't coordinate with you!\r\n`;\r\n\r\n/**\r\n * Inject memory protocol into CLAUDE.md\r\n */\r\nexport async function injectMemoryProtocol(projectPath = process.cwd()) {\r\n  const claudeMdPath = path.join(projectPath, 'CLAUDE.md');\r\n  \r\n  try {\r\n    let content = '';\r\n    let hasProtocol = false;\r\n    \r\n    // Check if CLAUDE.md exists\r\n    if (existsSync(claudeMdPath)) {\r\n      content = await fs.readFile(claudeMdPath, 'utf8');\r\n      hasProtocol = content.includes('MANDATORY MEMORY COORDINATION PROTOCOL');\r\n    }\r\n    \r\n    // If protocol not present, inject it\r\n    if (!hasProtocol) {\r\n      // Find a good injection point (after project overview or at start)\r\n      const injectionPoint = content.indexOf('## Project Overview');\r\n      \r\n      if (injectionPoint > -1) {\r\n        // Insert before Project Overview\r\n        content = \r\n          content.slice(0, injectionPoint) + \r\n          MEMORY_PROTOCOL + '\\n\\n' +\r\n          content.slice(injectionPoint);\r\n      } else {\r\n        // Prepend to file\r\n        content = MEMORY_PROTOCOL + '\\n\\n' + content;\r\n      }\r\n      \r\n      await fs.writeFile(claudeMdPath, content, 'utf8');\r\n      console.log('âœ… Injected memory coordination protocol into CLAUDE.md');\r\n      return true;\r\n    } else {\r\n      console.log('âœ“ Memory coordination protocol already present in CLAUDE.md');\r\n      return false;\r\n    }\r\n  } catch (error) {\r\n    console.error('âš ï¸  Could not inject memory protocol:', error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Enhance swarm prompt with memory instructions\r\n */\r\nexport function enhanceSwarmPrompt(originalPrompt, agentCount = 5) {\r\n  const enhancement = `\r\nCRITICAL: ALL AGENTS MUST COORDINATE THROUGH MEMORY\r\n\r\n${AGENT_INSTRUCTION}\r\n\r\nEach of the ${agentCount} agents MUST:\r\n- Write initial status when starting\r\n- Update progress after each step (with %)\r\n- Share all interfaces/APIs/configs\r\n- Check dependencies before using\r\n- Signal completion when done\r\n\r\nALL memory operations use namespace: \"coordination\"\r\n\r\nMemory monitoring commands:\r\n- Check status: memory search \"swarm/*/status\" --namespace coordination\r\n- View progress: memory search \"swarm/*/progress\" --namespace coordination\r\n- Find blockers: memory search \"swarm/*/waiting\" --namespace coordination\r\n- List shared: memory search \"swarm/shared/*\" --namespace coordination\r\n\r\n---\r\nORIGINAL OBJECTIVE:\r\n${originalPrompt}`;\r\n\r\n  return enhancement;\r\n}\r\n\r\n/**\r\n * Enhance hive-mind prompt with memory instructions\r\n */\r\nexport function enhanceHiveMindPrompt(originalPrompt, workers = []) {\r\n  const workerInstructions = workers.map(w => \r\n    `Agent ${w.name}: MUST write to swarm/${w.name}/status and swarm/${w.name}/progress`\r\n  ).join('\\n');\r\n\r\n  return `\r\nHIVE MIND COORDINATION REQUIREMENTS:\r\n\r\n${AGENT_INSTRUCTION}\r\n\r\n${workerInstructions}\r\n\r\nCoordination namespace: \"coordination\"\r\nStatus pattern: swarm/[agent]/status\r\nProgress pattern: swarm/[agent]/progress  \r\nShared pattern: swarm/shared/[component]\r\n\r\n---\r\nORIGINAL OBJECTIVE:\r\n${originalPrompt}`;\r\n}\r\n\r\n/**\r\n * Check if memory protocol should be injected\r\n */\r\nexport function shouldInjectProtocol(flags) {\r\n  return flags.claude || flags.spawn || flags['auto-spawn'];\r\n}\r\n\r\nexport default {\r\n  injectMemoryProtocol,\r\n  enhanceSwarmPrompt,\r\n  enhanceHiveMindPrompt,\r\n  shouldInjectProtocol,\r\n  MEMORY_PROTOCOL,\r\n  AGENT_INSTRUCTION\r\n};"],"names":["existsSync","promises","fs","path","MEMORY_PROTOCOL","AGENT_INSTRUCTION","injectMemoryProtocol","projectPath","process","cwd","claudeMdPath","join","content","hasProtocol","readFile","includes","injectionPoint","indexOf","slice","writeFile","console","log","error","message","enhanceSwarmPrompt","originalPrompt","agentCount","enhancement","enhanceHiveMindPrompt","workers","workerInstructions","map","w","name","shouldInjectProtocol","flags","claude","spawn"],"mappings":"AAEA,SAASA,UAAU,QAAQ,KAAK;AAChC,SAASC,YAAYC,EAAE,QAAQ,cAAc;AAC7C,OAAOC,UAAU,OAAO;AAKxB,MAAMC,kBAAkB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2FzB,CAAC;AAKD,MAAMC,oBAAoB,CAAC;;;;;;;;;;;;;;;;;;;AAmB3B,CAAC;AAKD,OAAO,eAAeC,qBAAqBC,cAAcC,QAAQC,GAAG,EAAE;IACpE,MAAMC,eAAeP,KAAKQ,IAAI,CAACJ,aAAa;IAE5C,IAAI;QACF,IAAIK,UAAU;QACd,IAAIC,cAAc;QAGlB,IAAIb,WAAWU,eAAe;YAC5BE,UAAU,MAAMV,GAAGY,QAAQ,CAACJ,cAAc;YAC1CG,cAAcD,QAAQG,QAAQ,CAAC;QACjC;QAGA,IAAI,CAACF,aAAa;YAEhB,MAAMG,iBAAiBJ,QAAQK,OAAO,CAAC;YAEvC,IAAID,iBAAiB,CAAC,GAAG;gBAEvBJ,UACEA,QAAQM,KAAK,CAAC,GAAGF,kBACjBZ,kBAAkB,SAClBQ,QAAQM,KAAK,CAACF;YAClB,OAAO;gBAELJ,UAAUR,kBAAkB,SAASQ;YACvC;YAEA,MAAMV,GAAGiB,SAAS,CAACT,cAAcE,SAAS;YAC1CQ,QAAQC,GAAG,CAAC;YACZ,OAAO;QACT,OAAO;YACLD,QAAQC,GAAG,CAAC;YACZ,OAAO;QACT;IACF,EAAE,OAAOC,OAAO;QACdF,QAAQE,KAAK,CAAC,yCAAyCA,MAAMC,OAAO;QACpE,OAAO;IACT;AACF;AAKA,OAAO,SAASC,mBAAmBC,cAAc,EAAEC,aAAa,CAAC;IAC/D,MAAMC,cAAc,CAAC;;;AAGvB,EAAEtB,kBAAkB;;YAER,EAAEqB,WAAW;;;;;;;;;;;;;;;;;AAiBzB,EAAED,gBAAgB;IAEhB,OAAOE;AACT;AAKA,OAAO,SAASC,sBAAsBH,cAAc,EAAEI,UAAU,EAAE;IAChE,MAAMC,qBAAqBD,QAAQE,GAAG,CAACC,CAAAA,IACrC,CAAC,MAAM,EAAEA,EAAEC,IAAI,CAAC,sBAAsB,EAAED,EAAEC,IAAI,CAAC,kBAAkB,EAAED,EAAEC,IAAI,CAAC,SAAS,CAAC,EACpFtB,IAAI,CAAC;IAEP,OAAO,CAAC;;;AAGV,EAAEN,kBAAkB;;AAEpB,EAAEyB,mBAAmB;;;;;;;;;AASrB,EAAEL,gBAAgB;AAClB;AAKA,OAAO,SAASS,qBAAqBC,KAAK;IACxC,OAAOA,MAAMC,MAAM,IAAID,MAAME,KAAK,IAAIF,KAAK,CAAC,aAAa;AAC3D;AAEA,eAAe;IACb7B;IACAkB;IACAI;IACAM;IACA9B;IACAC;AACF,EAAE"}
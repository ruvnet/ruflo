{"version":3,"sources":["../../../../src/cli/simple-commands/stream-chain-working.js"],"sourcesContent":["#!/usr/bin/env node\r\n/**\r\n * Stream Chain Command - Working implementation for Claude Code\r\n * Uses stream-json output but regular prompt input for compatibility\r\n */\r\n\r\nimport { spawn, execSync } from 'child_process';\r\n\r\n/**\r\n * Check if claude command is available\r\n */\r\nfunction checkClaudeAvailable() {\r\n  try {\r\n    execSync('which claude', { stdio: 'ignore' });\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Extract content from stream-json output\r\n */\r\nfunction extractContentFromStream(streamOutput) {\r\n  const lines = streamOutput.split('\\n').filter(line => line.trim());\r\n  let content = '';\r\n  \r\n  for (const line of lines) {\r\n    try {\r\n      const json = JSON.parse(line);\r\n      if (json.type === 'assistant' && json.message && json.message.content) {\r\n        for (const item of json.message.content) {\r\n          if (item.type === 'text' && item.text) {\r\n            content += item.text;\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      // Skip non-JSON lines\r\n    }\r\n  }\r\n  \r\n  return content.trim();\r\n}\r\n\r\n/**\r\n * Execute a single step with context from previous step\r\n */\r\nasync function executeStep(prompt, previousContent, stepNum, totalSteps, flags) {\r\n  return new Promise((resolve) => {\r\n    const startTime = Date.now();\r\n    const timeout = (flags.timeout || 30) * 1000;\r\n    \r\n    // Build the full prompt with context\r\n    let fullPrompt = prompt;\r\n    if (previousContent) {\r\n      fullPrompt = `Previous step output:\\n${previousContent}\\n\\nNext step: ${prompt}`;\r\n    }\r\n    \r\n    // Build command args\r\n    const args = ['-p'];\r\n    \r\n    // Always use stream-json output for parsing\r\n    args.push('--output-format', 'stream-json', '--verbose');\r\n    \r\n    // Add the prompt\r\n    args.push(fullPrompt);\r\n    \r\n    if (flags.verbose) {\r\n      console.log(`   Command: claude ${args[0]} ${args[1]} ${args[2]} \"${args[4].slice(0, 50)}...\"`);\r\n    }\r\n    \r\n    // Spawn Claude process\r\n    const claudeProcess = spawn('claude', args, {\r\n      stdio: ['pipe', 'pipe', 'pipe'],\r\n      env: process.env\r\n    });\r\n    \r\n    let output = '';\r\n    let stderr = '';\r\n    let completed = false;\r\n    \r\n    // Close stdin since we're not piping input\r\n    claudeProcess.stdin.end();\r\n    \r\n    // Capture output\r\n    claudeProcess.stdout.on('data', (chunk) => {\r\n      output += chunk.toString();\r\n    });\r\n    \r\n    // Capture errors\r\n    claudeProcess.stderr.on('data', (chunk) => {\r\n      stderr += chunk.toString();\r\n    });\r\n    \r\n    // Handle completion\r\n    claudeProcess.on('close', (code) => {\r\n      if (completed) return;\r\n      completed = true;\r\n      \r\n      const duration = Date.now() - startTime;\r\n      \r\n      if (code !== 0) {\r\n        console.error(`   Process exited with code ${code}`);\r\n        if (stderr && flags.verbose) {\r\n          console.error(`   stderr: ${stderr.slice(0, 200)}`);\r\n        }\r\n        resolve({\r\n          success: false,\r\n          duration,\r\n          content: null,\r\n          rawOutput: output\r\n        });\r\n        return;\r\n      }\r\n      \r\n      // Extract content from stream-json output\r\n      const content = extractContentFromStream(output);\r\n      \r\n      resolve({\r\n        success: true,\r\n        duration,\r\n        content,\r\n        rawOutput: output\r\n      });\r\n    });\r\n    \r\n    // Handle errors\r\n    claudeProcess.on('error', (error) => {\r\n      if (completed) return;\r\n      completed = true;\r\n      \r\n      console.error('   Process error:', error.message);\r\n      resolve({\r\n        success: false,\r\n        duration: Date.now() - startTime,\r\n        content: null,\r\n        rawOutput: null\r\n      });\r\n    });\r\n    \r\n    // Timeout\r\n    setTimeout(() => {\r\n      if (!completed) {\r\n        completed = true;\r\n        claudeProcess.kill('SIGTERM');\r\n        console.log('   ‚è±Ô∏è  Step timed out');\r\n        resolve({\r\n          success: false,\r\n          duration: timeout,\r\n          content: null,\r\n          rawOutput: null\r\n        });\r\n      }\r\n    }, timeout);\r\n  });\r\n}\r\n\r\n/**\r\n * Execute the chain\r\n */\r\nasync function executeChain(prompts, flags) {\r\n  const results = [];\r\n  let previousContent = null;\r\n  \r\n  for (let i = 0; i < prompts.length; i++) {\r\n    const prompt = prompts[i];\r\n    console.log(`\\nüîÑ Step ${i + 1}/${prompts.length}: ${prompt.slice(0, 50)}...`);\r\n    \r\n    const result = await executeStep(\r\n      prompt,\r\n      previousContent,\r\n      i + 1,\r\n      prompts.length,\r\n      flags\r\n    );\r\n    \r\n    results.push({\r\n      step: i + 1,\r\n      prompt: prompt.slice(0, 50),\r\n      success: result.success,\r\n      duration: result.duration,\r\n      content: result.content\r\n    });\r\n    \r\n    if (!result.success) {\r\n      console.error(`‚ùå Step ${i + 1} failed`);\r\n      break;\r\n    }\r\n    \r\n    console.log(`‚úÖ Step ${i + 1} completed (${result.duration}ms)`);\r\n    \r\n    if (result.content) {\r\n      previousContent = result.content;\r\n      if (flags.verbose) {\r\n        console.log(`   Content: ${result.content.slice(0, 100)}...`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Main command\r\n */\r\nexport async function streamChainCommand(args, flags) {\r\n  const subcommand = args[0] || 'help';\r\n  \r\n  if (subcommand === 'help') {\r\n    showHelp();\r\n    return;\r\n  }\r\n  \r\n  if (!checkClaudeAvailable()) {\r\n    console.error('‚ùå Claude Code not found');\r\n    console.log('Please ensure Claude Code is installed and available');\r\n    return;\r\n  }\r\n  \r\n  switch (subcommand) {\r\n    case 'demo':\r\n      await runDemo(flags);\r\n      break;\r\n      \r\n    case 'run':\r\n      await runCustom(args.slice(1), flags);\r\n      break;\r\n      \r\n    case 'test':\r\n      await runTest(flags);\r\n      break;\r\n      \r\n    default:\r\n      console.error(`‚ùå Unknown subcommand: ${subcommand}`);\r\n      showHelp();\r\n  }\r\n}\r\n\r\nfunction showHelp() {\r\n  console.log(`\r\nüîó Stream Chain Command - Claude Code Context Chaining\r\n\r\nDESCRIPTION\r\n    Chain multiple Claude Code prompts with context preservation.\r\n    Each step receives the output from the previous step.\r\n\r\nUSAGE\r\n    stream-chain <subcommand> [options]\r\n\r\nSUBCOMMANDS\r\n    run <p1> <p2> [...]  Execute custom chain\r\n    demo                 Run demo chain\r\n    test                 Test chaining\r\n    help                 Show this help\r\n\r\nOPTIONS\r\n    --verbose            Show detailed output\r\n    --timeout <seconds>  Timeout per step (default: 30)\r\n\r\nEXAMPLES\r\n    stream-chain demo\r\n    stream-chain run \"Write code\" \"Review it\" \"Improve it\"\r\n    stream-chain test --verbose\r\n  `);\r\n}\r\n\r\nasync function runDemo(flags) {\r\n  console.log('üé≠ Running Stream Chain Demo');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const prompts = [\r\n    \"Write a simple Python function to reverse a string\",\r\n    \"Add type hints to the function\",\r\n    \"Add a docstring to the function\"\r\n  ];\r\n  \r\n  const results = await executeChain(prompts, flags);\r\n  showSummary(results);\r\n}\r\n\r\nasync function runCustom(prompts, flags) {\r\n  if (prompts.length < 2) {\r\n    console.error('‚ùå Need at least 2 prompts');\r\n    return;\r\n  }\r\n  \r\n  console.log('üîó Starting Custom Chain');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const results = await executeChain(prompts, flags);\r\n  showSummary(results);\r\n}\r\n\r\nasync function runTest(flags) {\r\n  console.log('üß™ Testing Stream Chain');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const prompts = [\r\n    \"Say exactly: 'Step 1 complete'\",\r\n    \"If the previous step said 'Step 1 complete', say 'Chain working!'\"\r\n  ];\r\n  \r\n  const results = await executeChain(prompts, { ...flags, verbose: true });\r\n  \r\n  const success = results.every(r => r.success);\r\n  console.log('\\n' + (success ? '‚úÖ Test passed!' : '‚ùå Test failed'));\r\n}\r\n\r\nfunction showSummary(results) {\r\n  console.log('\\n' + '‚ïê'.repeat(50));\r\n  console.log('üìä Summary');\r\n  console.log('‚ïê'.repeat(50));\r\n  \r\n  for (const r of results) {\r\n    const status = r.success ? '‚úÖ' : '‚ùå';\r\n    console.log(`${status} Step ${r.step}: ${r.prompt}... (${r.duration}ms)`);\r\n  }\r\n  \r\n  const total = results.reduce((sum, r) => sum + r.duration, 0);\r\n  const success = results.filter(r => r.success).length;\r\n  \r\n  console.log(`\\n‚è±Ô∏è  Total: ${total}ms`);\r\n  console.log(`üìà Success: ${success}/${results.length}`);\r\n}\r\n\r\nexport default streamChainCommand;"],"names":["spawn","execSync","checkClaudeAvailable","stdio","extractContentFromStream","streamOutput","lines","split","filter","line","trim","content","json","JSON","parse","type","message","item","text","e","executeStep","prompt","previousContent","stepNum","totalSteps","flags","Promise","resolve","startTime","Date","now","timeout","fullPrompt","args","push","verbose","console","log","slice","claudeProcess","env","process","output","stderr","completed","stdin","end","stdout","on","chunk","toString","code","duration","error","success","rawOutput","setTimeout","kill","executeChain","prompts","results","i","length","result","step","streamChainCommand","subcommand","showHelp","runDemo","runCustom","runTest","repeat","showSummary","every","r","status","total","reduce","sum"],"mappings":"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"}
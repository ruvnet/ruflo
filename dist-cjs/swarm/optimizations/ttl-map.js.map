{
  "version": 3,
  "sources": ["../../../src/swarm/optimizations/ttl-map.ts"],
  "sourcesContent": ["/**\n * TTL Map Implementation\n * Map with time-to-live for automatic entry expiration\n */\n\ninterface TTLItem<T> {\n  value: T;\n  expiry: number;\n  createdAt: number;\n  accessCount: number;\n  lastAccessedAt: number;\n}\n\nexport interface TTLMapOptions {\n  defaultTTL?: number;\n  cleanupInterval?: number;\n  maxSize?: number;\n  onExpire?: <K, V>(key: K, value: V) => void;\n}\n\nexport class TTLMap<K, V> {\n  private items = new Map<K, TTLItem<V>>();\n  private cleanupTimer?: NodeJS.Timeout;\n  private defaultTTL: number;\n  private cleanupInterval: number;\n  private maxSize?: number;\n  private onExpire?: <K, V>(key: K, value: V) => void;\n  private stats = {\n    hits: 0,\n    misses: 0,\n    evictions: 0,\n    expirations: 0,\n  };\n\n  constructor(options: TTLMapOptions = {}) {\n    this.defaultTTL = options.defaultTTL || 3600000; // 1 hour default\n    this.cleanupInterval = options.cleanupInterval || 60000; // 1 minute default\n    this.maxSize = options.maxSize;\n    this.onExpire = options.onExpire;\n\n    this.startCleanup();\n  }\n\n  set(key: K, value: V, ttl?: number): void {\n    const now = Date.now();\n    const expiry = now + (ttl || this.defaultTTL);\n\n    // Check if we need to evict items due to size limit\n    if (this.maxSize && this.items.size >= this.maxSize && !this.items.has(key)) {\n      this.evictLRU();\n    }\n\n    this.items.set(key, {\n      value,\n      expiry,\n      createdAt: now,\n      accessCount: 0,\n      lastAccessedAt: now,\n    });\n  }\n\n  get(key: K): V | undefined {\n    const item = this.items.get(key);\n\n    if (!item) {\n      this.stats.misses++;\n      return undefined;\n    }\n\n    const now = Date.now();\n\n    if (now > item.expiry) {\n      this.items.delete(key);\n      this.stats.expirations++;\n      this.stats.misses++;\n\n      if (this.onExpire) {\n        this.onExpire(key, item.value);\n      }\n\n      return undefined;\n    }\n\n    // Update access stats\n    item.accessCount++;\n    item.lastAccessedAt = now;\n    this.stats.hits++;\n\n    return item.value;\n  }\n\n  has(key: K): boolean {\n    const item = this.items.get(key);\n\n    if (!item) {\n      return false;\n    }\n\n    if (Date.now() > item.expiry) {\n      this.items.delete(key);\n      this.stats.expirations++;\n\n      if (this.onExpire) {\n        this.onExpire(key, item.value);\n      }\n\n      return false;\n    }\n\n    return true;\n  }\n\n  delete(key: K): boolean {\n    return this.items.delete(key);\n  }\n\n  clear(): void {\n    this.items.clear();\n  }\n\n  /**\n   * Update TTL for an existing key\n   */\n  touch(key: K, ttl?: number): boolean {\n    const item = this.items.get(key);\n\n    if (!item || Date.now() > item.expiry) {\n      return false;\n    }\n\n    item.expiry = Date.now() + (ttl || this.defaultTTL);\n    item.lastAccessedAt = Date.now();\n\n    return true;\n  }\n\n  /**\n   * Get remaining TTL for a key\n   */\n  getTTL(key: K): number {\n    const item = this.items.get(key);\n\n    if (!item) {\n      return -1;\n    }\n\n    const remaining = item.expiry - Date.now();\n    return remaining > 0 ? remaining : -1;\n  }\n\n  /**\n   * Get all keys (excluding expired ones)\n   */\n  keys(): K[] {\n    const now = Date.now();\n    const validKeys: K[] = [];\n\n    for (const [key, item] of this.items) {\n      if (now <= item.expiry) {\n        validKeys.push(key);\n      }\n    }\n\n    return validKeys;\n  }\n\n  /**\n   * Get all values (excluding expired ones)\n   */\n  values(): V[] {\n    const now = Date.now();\n    const validValues: V[] = [];\n\n    for (const item of this.items.values()) {\n      if (now <= item.expiry) {\n        validValues.push(item.value);\n      }\n    }\n\n    return validValues;\n  }\n\n  /**\n   * Get all entries (excluding expired ones)\n   */\n  entries(): Array<[K, V]> {\n    const now = Date.now();\n    const validEntries: Array<[K, V]> = [];\n\n    for (const [key, item] of this.items) {\n      if (now <= item.expiry) {\n        validEntries.push([key, item.value]);\n      }\n    }\n\n    return validEntries;\n  }\n\n  /**\n   * Get size (excluding expired items)\n   */\n  get size(): number {\n    this.cleanup(); // Clean up expired items first\n    return this.items.size;\n  }\n\n  private startCleanup(): void {\n    this.cleanupTimer = setInterval(() => {\n      this.cleanup();\n    }, this.cleanupInterval);\n  }\n\n  private cleanup(): void {\n    const now = Date.now();\n    let cleaned = 0;\n\n    for (const [key, item] of this.items) {\n      if (now > item.expiry) {\n        this.items.delete(key);\n        cleaned++;\n        this.stats.expirations++;\n\n        if (this.onExpire) {\n          this.onExpire(key, item.value);\n        }\n      }\n    }\n\n    if (cleaned > 0) {\n      // Optional: Log cleanup stats\n    }\n  }\n\n  private evictLRU(): void {\n    let lruKey: K | undefined;\n    let lruTime = Infinity;\n\n    // Find least recently used item\n    for (const [key, item] of this.items) {\n      if (item.lastAccessedAt < lruTime) {\n        lruTime = item.lastAccessedAt;\n        lruKey = key;\n      }\n    }\n\n    if (lruKey !== undefined) {\n      this.items.delete(lruKey);\n      this.stats.evictions++;\n    }\n  }\n\n  /**\n   * Stop the cleanup timer\n   */\n  destroy(): void {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = undefined;\n    }\n    this.items.clear();\n  }\n\n  /**\n   * Get statistics about the map\n   */\n  getStats() {\n    return {\n      ...this.stats,\n      size: this.items.size,\n      hitRate: this.stats.hits / (this.stats.hits + this.stats.misses) || 0,\n    };\n  }\n\n  /**\n   * Get detailed information about all items\n   */\n  inspect(): Map<\n    K,\n    {\n      value: V;\n      ttl: number;\n      age: number;\n      accessCount: number;\n      lastAccessed: number;\n    }\n  > {\n    const now = Date.now();\n    const result = new Map();\n\n    for (const [key, item] of this.items) {\n      if (now <= item.expiry) {\n        result.set(key, {\n          value: item.value,\n          ttl: item.expiry - now,\n          age: now - item.createdAt,\n          accessCount: item.accessCount,\n          lastAccessed: now - item.lastAccessedAt,\n        });\n      }\n    }\n\n    return result;\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

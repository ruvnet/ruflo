{"version":3,"sources":["../../../src/verification/truth-scorer.ts"],"sourcesContent":["/**\r\n * TruthScorer - Advanced truth scoring system with configurable thresholds\r\n * Provides statistical validation and confidence analysis for agent claims and system states\r\n */\r\n\r\nimport type { ILogger } from '../core/logger.js';\r\nimport { logger } from '../core/logger.js';\r\nimport { AppError } from '../utils/error-handler.js';\r\nimport type {\r\n  TruthScore,\r\n  TruthScoreConfig,\r\n  TruthScoringWeights,\r\n  TruthValidationChecks,\r\n  ConfidenceConfig,\r\n  TruthScoreComponents,\r\n  ConfidenceInterval,\r\n  TruthEvidence,\r\n  AgentClaim,\r\n  VerificationError,\r\n} from './types.js';\r\nimport { VERIFICATION_CONSTANTS } from './types.js';\r\nimport type { AgentId, AgentState } from '../swarm/types.js';\r\n\r\nexport interface TruthScorerOptions {\r\n  config?: Partial<TruthScoreConfig>;\r\n  logger?: ILogger;\r\n}\r\n\r\nexport class TruthScorer {\r\n  private readonly config: TruthScoreConfig;\r\n  private readonly logger: ILogger;\r\n  private readonly agentHistory: Map<string, AgentPerformanceHistory> = new Map();\r\n  private readonly validationCache: Map<string, CachedValidation> = new Map();\r\n\r\n  constructor(options: TruthScorerOptions = {}) {\r\n    this.logger = options.logger || logger.child({ component: 'TruthScorer' });\r\n    this.config = this.mergeConfig(options.config);\r\n    \r\n    this.logger.info('TruthScorer initialized', {\r\n      threshold: this.config.threshold,\r\n      checks: this.config.checks,\r\n      weights: this.config.weights,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Calculate truth score for an agent claim\r\n   */\r\n  async scoreClaim(claim: AgentClaim, context?: ScoringContext): Promise<TruthScore> {\r\n    const startTime = Date.now();\r\n    this.logger.debug('Starting truth score calculation', {\r\n      claimId: claim.id,\r\n      claimType: claim.type,\r\n      agentId: claim.agentId,\r\n    });\r\n\r\n    try {\r\n      // Initialize score components\r\n      const components: Partial<TruthScoreComponents> = {};\r\n      const evidence: TruthEvidence[] = [];\r\n      const errors: VerificationError[] = [];\r\n\r\n      // Calculate individual components\r\n      if (this.config.checks.historicalValidation) {\r\n        components.agentReliability = await this.calculateAgentReliability(claim, evidence, errors);\r\n      }\r\n\r\n      if (this.config.checks.crossAgentValidation && context?.peers) {\r\n        components.crossValidation = await this.calculateCrossValidation(claim, context.peers, evidence, errors);\r\n      }\r\n\r\n      if (this.config.checks.externalValidation && context?.externalSources) {\r\n        components.externalVerification = await this.calculateExternalVerification(claim, context.externalSources, evidence, errors);\r\n      }\r\n\r\n      if (this.config.checks.logicalValidation) {\r\n        components.logicalCoherence = await this.calculateLogicalCoherence(claim, evidence, errors);\r\n      }\r\n\r\n      if (this.config.checks.statisticalValidation) {\r\n        components.factualConsistency = await this.calculateFactualConsistency(claim, evidence, errors);\r\n      }\r\n\r\n      // Calculate overall score using weighted average\r\n      const overall = this.calculateWeightedScore(components as TruthScoreComponents);\r\n      const fullComponents: TruthScoreComponents = {\r\n        agentReliability: components.agentReliability || 0,\r\n        crossValidation: components.crossValidation || 0,\r\n        externalVerification: components.externalVerification || 0,\r\n        logicalCoherence: components.logicalCoherence || 0,\r\n        factualConsistency: components.factualConsistency || 0,\r\n        overall,\r\n      };\r\n\r\n      // Calculate confidence interval\r\n      const confidence = this.calculateConfidenceInterval(fullComponents, evidence.length);\r\n\r\n      const score: TruthScore = {\r\n        score: overall,\r\n        components: fullComponents,\r\n        confidence,\r\n        evidence,\r\n        timestamp: new Date(),\r\n        metadata: {\r\n          claimId: claim.id,\r\n          agentId: claim.agentId,\r\n          calculationTime: Date.now() - startTime,\r\n          evidenceCount: evidence.length,\r\n          errorCount: errors.length,\r\n          config: this.config,\r\n        },\r\n      };\r\n\r\n      this.logger.info('Truth score calculated', {\r\n        claimId: claim.id,\r\n        score: overall,\r\n        components: fullComponents,\r\n        confidence: confidence.level,\r\n        duration: Date.now() - startTime,\r\n      });\r\n\r\n      return score;\r\n    } catch (error) {\r\n      this.logger.error('Failed to calculate truth score', error);\r\n      throw new AppError(\r\n        `Truth score calculation failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        'TRUTH_SCORE_CALCULATION_FAILED',\r\n        500\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate if a truth score meets the configured threshold\r\n   */\r\n  validateScore(score: TruthScore): boolean {\r\n    const passes = score.score >= this.config.threshold;\r\n    this.logger.debug('Truth score validation', {\r\n      score: score.score,\r\n      threshold: this.config.threshold,\r\n      passes,\r\n    });\r\n    return passes;\r\n  }\r\n\r\n  /**\r\n   * Update agent performance history\r\n   */\r\n  updateAgentHistory(agentId: AgentId, performance: AgentPerformanceRecord): void {\r\n    const agentKey = typeof agentId === 'string' ? agentId : agentId.id;\r\n    \r\n    if (!this.agentHistory.has(agentKey)) {\r\n      this.agentHistory.set(agentKey, {\r\n        agentId: agentKey,\r\n        records: [],\r\n        statistics: {\r\n          averageScore: 0,\r\n          successRate: 0,\r\n          totalClaims: 0,\r\n          recentTrend: 'stable',\r\n        },\r\n      });\r\n    }\r\n\r\n    const history = this.agentHistory.get(agentKey)!;\r\n    history.records.push(performance);\r\n\r\n    // Keep only recent records (last 100)\r\n    if (history.records.length > 100) {\r\n      history.records = history.records.slice(-100);\r\n    }\r\n\r\n    // Update statistics\r\n    this.updateAgentStatistics(history);\r\n\r\n    this.logger.debug('Agent history updated', {\r\n      agentId: agentKey,\r\n      recordCount: history.records.length,\r\n      averageScore: history.statistics.averageScore,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get agent reliability score\r\n   */\r\n  getAgentReliability(agentId: AgentId): number {\r\n    const agentKey = typeof agentId === 'string' ? agentId : agentId.id;\r\n    const history = this.agentHistory.get(agentKey);\r\n    \r\n    if (!history || history.records.length === 0) {\r\n      return 0.5; // Default neutral score for unknown agents\r\n    }\r\n\r\n    return history.statistics.averageScore;\r\n  }\r\n\r\n  /**\r\n   * Clear validation cache\r\n   */\r\n  clearCache(): void {\r\n    this.validationCache.clear();\r\n    this.logger.debug('Validation cache cleared');\r\n  }\r\n\r\n  private mergeConfig(partialConfig?: Partial<TruthScoreConfig>): TruthScoreConfig {\r\n    const defaultWeights: TruthScoringWeights = {\r\n      agentReliability: 0.3,\r\n      crossValidation: 0.25,\r\n      externalVerification: 0.2,\r\n      factualConsistency: 0.15,\r\n      logicalCoherence: 0.1,\r\n    };\r\n\r\n    const defaultChecks: TruthValidationChecks = {\r\n      historicalValidation: true,\r\n      crossAgentValidation: true,\r\n      externalValidation: false,\r\n      logicalValidation: true,\r\n      statisticalValidation: true,\r\n    };\r\n\r\n    const defaultConfidence: ConfidenceConfig = {\r\n      level: VERIFICATION_CONSTANTS.DEFAULT_CONFIDENCE_LEVEL,\r\n      minSampleSize: VERIFICATION_CONSTANTS.DEFAULT_MIN_SAMPLE_SIZE,\r\n      maxErrorMargin: VERIFICATION_CONSTANTS.DEFAULT_MAX_ERROR_MARGIN,\r\n    };\r\n\r\n    return {\r\n      threshold: partialConfig?.threshold || VERIFICATION_CONSTANTS.DEFAULT_TRUTH_THRESHOLD,\r\n      weights: { ...defaultWeights, ...partialConfig?.weights },\r\n      checks: { ...defaultChecks, ...partialConfig?.checks },\r\n      confidence: { ...defaultConfidence, ...partialConfig?.confidence },\r\n    };\r\n  }\r\n\r\n  private async calculateAgentReliability(\r\n    claim: AgentClaim,\r\n    evidence: TruthEvidence[],\r\n    errors: VerificationError[]\r\n  ): Promise<number> {\r\n    try {\r\n      const agentKey = typeof claim.agentId === 'string' ? claim.agentId : claim.agentId.id;\r\n      const history = this.agentHistory.get(agentKey);\r\n\r\n      if (!history || history.records.length < 3) {\r\n        // Insufficient data - use neutral score\r\n        evidence.push({\r\n          type: 'agent_history',\r\n          source: 'internal_history',\r\n          weight: this.config.weights.agentReliability,\r\n          score: 0.5,\r\n          details: { reason: 'insufficient_data', recordCount: history?.records.length || 0 },\r\n          timestamp: new Date(),\r\n        });\r\n        return 0.5;\r\n      }\r\n\r\n      // Calculate reliability based on recent performance\r\n      const recentRecords = history.records.slice(-10); // Last 10 records\r\n      const avgScore = recentRecords.reduce((sum, record) => sum + record.score, 0) / recentRecords.length;\r\n      const consistency = 1 - this.calculateVariance(recentRecords.map(r => r.score));\r\n      const trendFactor = this.calculateTrendFactor(recentRecords);\r\n\r\n      const reliability = (avgScore * 0.6) + (consistency * 0.3) + (trendFactor * 0.1);\r\n\r\n      evidence.push({\r\n        type: 'agent_history',\r\n        source: 'internal_history',\r\n        weight: this.config.weights.agentReliability,\r\n        score: reliability,\r\n        details: {\r\n          averageScore: avgScore,\r\n          consistency,\r\n          trendFactor,\r\n          recordCount: recentRecords.length,\r\n        },\r\n        timestamp: new Date(),\r\n      });\r\n\r\n      return Math.max(0, Math.min(1, reliability));\r\n    } catch (error) {\r\n      errors.push({\r\n        code: 'AGENT_RELIABILITY_CALCULATION_FAILED',\r\n        message: `Failed to calculate agent reliability: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        severity: 'medium',\r\n        context: { claimId: claim.id, agentId: claim.agentId },\r\n        recoverable: true,\r\n        timestamp: new Date(),\r\n      });\r\n      return 0.5; // Default score on error\r\n    }\r\n  }\r\n\r\n  private async calculateCrossValidation(\r\n    claim: AgentClaim,\r\n    peers: AgentState[],\r\n    evidence: TruthEvidence[],\r\n    errors: VerificationError[]\r\n  ): Promise<number> {\r\n    try {\r\n      if (peers.length === 0) {\r\n        evidence.push({\r\n          type: 'cross_validation',\r\n          source: 'peer_agents',\r\n          weight: this.config.weights.crossValidation,\r\n          score: 0.5,\r\n          details: { reason: 'no_peers_available' },\r\n          timestamp: new Date(),\r\n        });\r\n        return 0.5;\r\n      }\r\n\r\n      // Simulate cross-validation with peer agents\r\n      // In a real implementation, this would involve querying other agents\r\n      const validationScores: number[] = [];\r\n      const reliablePeers = peers.filter(peer => this.getAgentReliability(peer.id) > 0.7);\r\n\r\n      for (const peer of reliablePeers.slice(0, 5)) { // Limit to 5 peers\r\n        const peerReliability = this.getAgentReliability(peer.id);\r\n        const validationScore = this.simulatePeerValidation(claim, peer);\r\n        validationScores.push(validationScore * peerReliability);\r\n      }\r\n\r\n      if (validationScores.length === 0) {\r\n        evidence.push({\r\n          type: 'cross_validation',\r\n          source: 'peer_agents',\r\n          weight: this.config.weights.crossValidation,\r\n          score: 0.5,\r\n          details: { reason: 'no_reliable_peers' },\r\n          timestamp: new Date(),\r\n        });\r\n        return 0.5;\r\n      }\r\n\r\n      const avgValidation = validationScores.reduce((sum, score) => sum + score, 0) / validationScores.length;\r\n      const consensus = 1 - this.calculateVariance(validationScores);\r\n      const crossValidationScore = (avgValidation * 0.8) + (consensus * 0.2);\r\n\r\n      evidence.push({\r\n        type: 'cross_validation',\r\n        source: 'peer_agents',\r\n        weight: this.config.weights.crossValidation,\r\n        score: crossValidationScore,\r\n        details: {\r\n          peerCount: validationScores.length,\r\n          averageValidation: avgValidation,\r\n          consensus,\r\n          validationScores,\r\n        },\r\n        timestamp: new Date(),\r\n      });\r\n\r\n      return Math.max(0, Math.min(1, crossValidationScore));\r\n    } catch (error) {\r\n      errors.push({\r\n        code: 'CROSS_VALIDATION_FAILED',\r\n        message: `Cross validation failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        severity: 'medium',\r\n        context: { claimId: claim.id, peerCount: peers.length },\r\n        recoverable: true,\r\n        timestamp: new Date(),\r\n      });\r\n      return 0.5;\r\n    }\r\n  }\r\n\r\n  private async calculateExternalVerification(\r\n    claim: AgentClaim,\r\n    externalSources: ExternalSource[],\r\n    evidence: TruthEvidence[],\r\n    errors: VerificationError[]\r\n  ): Promise<number> {\r\n    try {\r\n      if (externalSources.length === 0) {\r\n        evidence.push({\r\n          type: 'external_source',\r\n          source: 'external_verification',\r\n          weight: this.config.weights.externalVerification,\r\n          score: 0.5,\r\n          details: { reason: 'no_external_sources' },\r\n          timestamp: new Date(),\r\n        });\r\n        return 0.5;\r\n      }\r\n\r\n      // Simulate external verification\r\n      // In a real implementation, this would query external APIs, databases, etc.\r\n      const verificationResults: number[] = [];\r\n\r\n      for (const source of externalSources.slice(0, 3)) { // Limit to 3 sources\r\n        const verificationScore = await this.simulateExternalVerification(claim, source);\r\n        verificationResults.push(verificationScore * source.reliability);\r\n      }\r\n\r\n      const avgVerification = verificationResults.reduce((sum, score) => sum + score, 0) / verificationResults.length;\r\n      const sourceAgreement = 1 - this.calculateVariance(verificationResults);\r\n      const externalScore = (avgVerification * 0.7) + (sourceAgreement * 0.3);\r\n\r\n      evidence.push({\r\n        type: 'external_source',\r\n        source: 'external_verification',\r\n        weight: this.config.weights.externalVerification,\r\n        score: externalScore,\r\n        details: {\r\n          sourceCount: verificationResults.length,\r\n          averageVerification: avgVerification,\r\n          sourceAgreement,\r\n          verificationResults,\r\n        },\r\n        timestamp: new Date(),\r\n      });\r\n\r\n      return Math.max(0, Math.min(1, externalScore));\r\n    } catch (error) {\r\n      errors.push({\r\n        code: 'EXTERNAL_VERIFICATION_FAILED',\r\n        message: `External verification failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        severity: 'medium',\r\n        context: { claimId: claim.id, sourceCount: externalSources.length },\r\n        recoverable: true,\r\n        timestamp: new Date(),\r\n      });\r\n      return 0.5;\r\n    }\r\n  }\r\n\r\n  private async calculateLogicalCoherence(\r\n    claim: AgentClaim,\r\n    evidence: TruthEvidence[],\r\n    errors: VerificationError[]\r\n  ): Promise<number> {\r\n    try {\r\n      // Analyze logical consistency of the claim\r\n      const coherenceChecks = {\r\n        structuralIntegrity: this.checkStructuralIntegrity(claim),\r\n        causalConsistency: this.checkCausalConsistency(claim),\r\n        temporalCoherence: this.checkTemporalCoherence(claim),\r\n        metricConsistency: this.checkMetricConsistency(claim),\r\n      };\r\n\r\n      const coherenceScore = Object.values(coherenceChecks).reduce((sum, score) => sum + score, 0) / 4;\r\n\r\n      evidence.push({\r\n        type: 'logical_proof',\r\n        source: 'logical_analyzer',\r\n        weight: this.config.weights.logicalCoherence,\r\n        score: coherenceScore,\r\n        details: coherenceChecks,\r\n        timestamp: new Date(),\r\n      });\r\n\r\n      return Math.max(0, Math.min(1, coherenceScore));\r\n    } catch (error) {\r\n      errors.push({\r\n        code: 'LOGICAL_COHERENCE_FAILED',\r\n        message: `Logical coherence analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        severity: 'medium',\r\n        context: { claimId: claim.id },\r\n        recoverable: true,\r\n        timestamp: new Date(),\r\n      });\r\n      return 0.5;\r\n    }\r\n  }\r\n\r\n  private async calculateFactualConsistency(\r\n    claim: AgentClaim,\r\n    evidence: TruthEvidence[],\r\n    errors: VerificationError[]\r\n  ): Promise<number> {\r\n    try {\r\n      // Perform statistical validation of claim metrics\r\n      const statisticalTests = {\r\n        distributionTest: this.performDistributionTest(claim),\r\n        outlierDetection: this.performOutlierDetection(claim),\r\n        trendAnalysis: this.performTrendAnalysis(claim),\r\n        correlationAnalysis: this.performCorrelationAnalysis(claim),\r\n      };\r\n\r\n      const consistencyScore = Object.values(statisticalTests).reduce((sum, score) => sum + score, 0) / 4;\r\n\r\n      evidence.push({\r\n        type: 'statistical_test',\r\n        source: 'statistical_analyzer',\r\n        weight: this.config.weights.factualConsistency,\r\n        score: consistencyScore,\r\n        details: statisticalTests,\r\n        timestamp: new Date(),\r\n      });\r\n\r\n      return Math.max(0, Math.min(1, consistencyScore));\r\n    } catch (error) {\r\n      errors.push({\r\n        code: 'FACTUAL_CONSISTENCY_FAILED',\r\n        message: `Factual consistency analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        severity: 'medium',\r\n        context: { claimId: claim.id },\r\n        recoverable: true,\r\n        timestamp: new Date(),\r\n      });\r\n      return 0.5;\r\n    }\r\n  }\r\n\r\n  private calculateWeightedScore(components: TruthScoreComponents): number {\r\n    const weights = this.config.weights;\r\n    const totalWeight = Object.values(weights).reduce((sum, weight) => sum + weight, 0);\r\n    \r\n    const weightedSum = \r\n      (components.agentReliability * weights.agentReliability) +\r\n      (components.crossValidation * weights.crossValidation) +\r\n      (components.externalVerification * weights.externalVerification) +\r\n      (components.factualConsistency * weights.factualConsistency) +\r\n      (components.logicalCoherence * weights.logicalCoherence);\r\n\r\n    return weightedSum / totalWeight;\r\n  }\r\n\r\n  private calculateConfidenceInterval(components: TruthScoreComponents, evidenceCount: number): ConfidenceInterval {\r\n    const score = components.overall;\r\n    const sampleSize = Math.max(evidenceCount, 1);\r\n    const confidenceLevel = this.config.confidence.level;\r\n    \r\n    // Calculate standard error (simplified)\r\n    const variance = this.calculateComponentVariance(components);\r\n    const standardError = Math.sqrt(variance / sampleSize);\r\n    \r\n    // Z-score for confidence level (approximation)\r\n    const zScore = this.getZScore(confidenceLevel);\r\n    const margin = zScore * standardError;\r\n    \r\n    return {\r\n      lower: Math.max(0, score - margin),\r\n      upper: Math.min(1, score + margin),\r\n      level: confidenceLevel,\r\n    };\r\n  }\r\n\r\n  private calculateComponentVariance(components: TruthScoreComponents): number {\r\n    const scores = [\r\n      components.agentReliability,\r\n      components.crossValidation,\r\n      components.externalVerification,\r\n      components.factualConsistency,\r\n      components.logicalCoherence,\r\n    ];\r\n    \r\n    return this.calculateVariance(scores);\r\n  }\r\n\r\n  private calculateVariance(values: number[]): number {\r\n    if (values.length === 0) return 0;\r\n    \r\n    const mean = values.reduce((sum, val) => sum + val, 0) / values.length;\r\n    const squaredDiffs = values.map(val => Math.pow(val - mean, 2));\r\n    return squaredDiffs.reduce((sum, diff) => sum + diff, 0) / values.length;\r\n  }\r\n\r\n  private calculateTrendFactor(records: AgentPerformanceRecord[]): number {\r\n    if (records.length < 2) return 0.5;\r\n    \r\n    // Simple linear trend calculation\r\n    const scores = records.map(r => r.score);\r\n    const n = scores.length;\r\n    const x = Array.from({ length: n }, (_, i) => i);\r\n    \r\n    const sumX = x.reduce((a, b) => a + b, 0);\r\n    const sumY = scores.reduce((a, b) => a + b, 0);\r\n    const sumXY = x.reduce((sum, xi, i) => sum + xi * scores[i], 0);\r\n    const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);\r\n    \r\n    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);\r\n    \r\n    // Convert slope to factor (positive trend increases score)\r\n    return 0.5 + Math.max(-0.5, Math.min(0.5, slope));\r\n  }\r\n\r\n  private getZScore(confidenceLevel: number): number {\r\n    // Simplified Z-score lookup\r\n    if (confidenceLevel >= 0.99) return 2.576;\r\n    if (confidenceLevel >= 0.95) return 1.96;\r\n    if (confidenceLevel >= 0.90) return 1.645;\r\n    if (confidenceLevel >= 0.80) return 1.282;\r\n    return 1.0;\r\n  }\r\n\r\n  private updateAgentStatistics(history: AgentPerformanceHistory): void {\r\n    const records = history.records;\r\n    if (records.length === 0) return;\r\n\r\n    const scores = records.map(r => r.score);\r\n    const successCount = records.filter(r => r.success).length;\r\n\r\n    history.statistics.averageScore = scores.reduce((sum, score) => sum + score, 0) / scores.length;\r\n    history.statistics.successRate = successCount / records.length;\r\n    history.statistics.totalClaims = records.length;\r\n\r\n    // Calculate trend\r\n    if (records.length >= 5) {\r\n      const recentScores = scores.slice(-5);\r\n      const earlierScores = scores.slice(-10, -5);\r\n      \r\n      if (earlierScores.length > 0) {\r\n        const recentAvg = recentScores.reduce((sum, score) => sum + score, 0) / recentScores.length;\r\n        const earlierAvg = earlierScores.reduce((sum, score) => sum + score, 0) / earlierScores.length;\r\n        \r\n        if (recentAvg > earlierAvg + 0.05) {\r\n          history.statistics.recentTrend = 'improving';\r\n        } else if (recentAvg < earlierAvg - 0.05) {\r\n          history.statistics.recentTrend = 'declining';\r\n        } else {\r\n          history.statistics.recentTrend = 'stable';\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Simulation methods for demo purposes - replace with real implementations\r\n  private simulatePeerValidation(claim: AgentClaim, peer: AgentState): number {\r\n    // Simulate peer validation logic\r\n    const baseScore = 0.7;\r\n    const randomFactor = (Math.random() - 0.5) * 0.4;\r\n    return Math.max(0, Math.min(1, baseScore + randomFactor));\r\n  }\r\n\r\n  private async simulateExternalVerification(claim: AgentClaim, source: ExternalSource): Promise<number> {\r\n    // Simulate external source verification\r\n    const baseScore = source.reliability * 0.8;\r\n    const randomFactor = (Math.random() - 0.5) * 0.3;\r\n    return Math.max(0, Math.min(1, baseScore + randomFactor));\r\n  }\r\n\r\n  private checkStructuralIntegrity(claim: AgentClaim): number {\r\n    // Check if claim has required fields and proper structure\r\n    let score = 0.8;\r\n    \r\n    if (!claim.data || typeof claim.data !== 'object') score -= 0.3;\r\n    if (!claim.evidence || claim.evidence.length === 0) score -= 0.2;\r\n    if (!claim.metrics) score -= 0.2;\r\n    \r\n    return Math.max(0, score);\r\n  }\r\n\r\n  private checkCausalConsistency(claim: AgentClaim): number {\r\n    // Check for causal relationships in claim data\r\n    return 0.8; // Simplified - implement actual causal analysis\r\n  }\r\n\r\n  private checkTemporalCoherence(claim: AgentClaim): number {\r\n    // Check temporal consistency of claim\r\n    const now = new Date();\r\n    const claimAge = now.getTime() - claim.submittedAt.getTime();\r\n    \r\n    // Claims should be recent\r\n    if (claimAge > 24 * 60 * 60 * 1000) { // More than 24 hours\r\n      return 0.5;\r\n    }\r\n    \r\n    return 0.9;\r\n  }\r\n\r\n  private checkMetricConsistency(claim: AgentClaim): number {\r\n    // Check consistency of metrics in claim\r\n    if (!claim.metrics) return 0.5;\r\n    \r\n    // Check for reasonable metric values\r\n    const metrics = claim.metrics;\r\n    let score = 0.8;\r\n    \r\n    if (metrics.accuracy && (metrics.accuracy < 0 || metrics.accuracy > 1)) score -= 0.3;\r\n    if (metrics.errorRate && metrics.errorRate < 0) score -= 0.2;\r\n    if (metrics.executionTime && metrics.executionTime < 0) score -= 0.2;\r\n    \r\n    return Math.max(0, score);\r\n  }\r\n\r\n  private performDistributionTest(claim: AgentClaim): number {\r\n    // Perform statistical distribution test\r\n    return 0.8; // Simplified - implement actual statistical tests\r\n  }\r\n\r\n  private performOutlierDetection(claim: AgentClaim): number {\r\n    // Detect outliers in claim metrics\r\n    return 0.8; // Simplified - implement actual outlier detection\r\n  }\r\n\r\n  private performTrendAnalysis(claim: AgentClaim): number {\r\n    // Analyze trends in claim data\r\n    return 0.8; // Simplified - implement actual trend analysis\r\n  }\r\n\r\n  private performCorrelationAnalysis(claim: AgentClaim): number {\r\n    // Analyze correlations in claim metrics\r\n    return 0.8; // Simplified - implement actual correlation analysis\r\n  }\r\n}\r\n\r\n// Supporting interfaces\r\ninterface AgentPerformanceHistory {\r\n  agentId: string;\r\n  records: AgentPerformanceRecord[];\r\n  statistics: AgentStatistics;\r\n}\r\n\r\ninterface AgentPerformanceRecord {\r\n  timestamp: Date;\r\n  claimId: string;\r\n  score: number;\r\n  success: boolean;\r\n  executionTime: number;\r\n  resourceUsage: number;\r\n  metadata: Record<string, unknown>;\r\n}\r\n\r\ninterface AgentStatistics {\r\n  averageScore: number;\r\n  successRate: number;\r\n  totalClaims: number;\r\n  recentTrend: 'improving' | 'stable' | 'declining';\r\n}\r\n\r\ninterface CachedValidation {\r\n  key: string;\r\n  result: number;\r\n  timestamp: Date;\r\n  expiry: Date;\r\n}\r\n\r\ninterface ScoringContext {\r\n  peers?: AgentState[];\r\n  externalSources?: ExternalSource[];\r\n  historicalData?: Record<string, unknown>;\r\n  constraints?: Record<string, unknown>;\r\n}\r\n\r\ninterface ExternalSource {\r\n  id: string;\r\n  name: string;\r\n  type: string;\r\n  endpoint: string;\r\n  reliability: number;\r\n  credentials?: Record<string, string>;\r\n}\r\n\r\nexport default TruthScorer;"],"names":["logger","AppError","VERIFICATION_CONSTANTS","TruthScorer","config","agentHistory","Map","validationCache","options","child","component","mergeConfig","info","threshold","checks","weights","scoreClaim","claim","context","startTime","Date","now","debug","claimId","id","claimType","type","agentId","components","evidence","errors","historicalValidation","agentReliability","calculateAgentReliability","crossAgentValidation","peers","crossValidation","calculateCrossValidation","externalValidation","externalSources","externalVerification","calculateExternalVerification","logicalValidation","logicalCoherence","calculateLogicalCoherence","statisticalValidation","factualConsistency","calculateFactualConsistency","overall","calculateWeightedScore","fullComponents","confidence","calculateConfidenceInterval","length","score","timestamp","metadata","calculationTime","evidenceCount","errorCount","level","duration","error","Error","message","validateScore","passes","updateAgentHistory","performance","agentKey","has","set","records","statistics","averageScore","successRate","totalClaims","recentTrend","history","get","push","slice","updateAgentStatistics","recordCount","getAgentReliability","clearCache","clear","partialConfig","defaultWeights","defaultChecks","defaultConfidence","DEFAULT_CONFIDENCE_LEVEL","minSampleSize","DEFAULT_MIN_SAMPLE_SIZE","maxErrorMargin","DEFAULT_MAX_ERROR_MARGIN","DEFAULT_TRUTH_THRESHOLD","source","weight","details","reason","recentRecords","avgScore","reduce","sum","record","consistency","calculateVariance","map","r","trendFactor","calculateTrendFactor","reliability","Math","max","min","code","severity","recoverable","validationScores","reliablePeers","filter","peer","peerReliability","validationScore","simulatePeerValidation","avgValidation","consensus","crossValidationScore","peerCount","averageValidation","verificationResults","verificationScore","simulateExternalVerification","avgVerification","sourceAgreement","externalScore","sourceCount","averageVerification","coherenceChecks","structuralIntegrity","checkStructuralIntegrity","causalConsistency","checkCausalConsistency","temporalCoherence","checkTemporalCoherence","metricConsistency","checkMetricConsistency","coherenceScore","Object","values","statisticalTests","distributionTest","performDistributionTest","outlierDetection","performOutlierDetection","trendAnalysis","performTrendAnalysis","correlationAnalysis","performCorrelationAnalysis","consistencyScore","totalWeight","weightedSum","sampleSize","confidenceLevel","variance","calculateComponentVariance","standardError","sqrt","zScore","getZScore","margin","lower","upper","scores","mean","val","squaredDiffs","pow","diff","n","x","Array","from","_","i","sumX","a","b","sumY","sumXY","xi","sumXX","slope","successCount","success","recentScores","earlierScores","recentAvg","earlierAvg","baseScore","randomFactor","random","data","metrics","claimAge","getTime","submittedAt","accuracy","errorRate","executionTime"],"mappings":"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"}
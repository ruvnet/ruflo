{"version":3,"sources":["../../../../src/cli/agents/base-agent.ts"],"sourcesContent":["/**\r\n * Base Agent Class - Foundation for all specialized agents\r\n */\r\n\r\nimport { EventEmitter } from 'node:events';\r\nimport type {\r\n  AgentId,\r\n  AgentType,\r\n  AgentStatus,\r\n  AgentCapabilities,\r\n  AgentConfig,\r\n  AgentEnvironment,\r\n  AgentMetrics,\r\n  AgentError,\r\n  TaskDefinition,\r\n  TaskId,\r\n} from '../../swarm/types.js';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport type { IEventBus } from '../../core/event-bus.js';\r\nimport type { DistributedMemorySystem } from '../../memory/distributed-memory.js';\r\nimport { generateId } from '../../utils/helpers.js';\r\n\r\nexport interface AgentState {\r\n  id: AgentId;\r\n  name: string;\r\n  type: AgentType;\r\n  status: AgentStatus;\r\n  capabilities: AgentCapabilities;\r\n  config: AgentConfig;\r\n  environment: AgentEnvironment;\r\n  metrics: AgentMetrics;\r\n  workload: number;\r\n  health: number;\r\n  lastHeartbeat: Date;\r\n  currentTasks: TaskId[];\r\n  taskHistory: TaskId[];\r\n  errorHistory: AgentError[];\r\n  collaborators: AgentId[];\r\n  childAgents: AgentId[];\r\n  endpoints: string[];\r\n}\r\n\r\nexport abstract class BaseAgent extends EventEmitter {\r\n  protected id: string;\r\n  protected type: AgentType;\r\n  protected status: AgentStatus = 'initializing';\r\n  protected capabilities: AgentCapabilities;\r\n  protected config: AgentConfig;\r\n  protected environment: AgentEnvironment;\r\n  protected metrics: AgentMetrics;\r\n  protected workload = 0;\r\n  protected health = 1.0;\r\n  protected lastHeartbeat = new Date();\r\n  protected currentTasks: TaskId[] = [];\r\n  protected taskHistory: TaskId[] = [];\r\n  protected errorHistory: AgentError[] = [];\r\n  protected collaborators: AgentId[] = [];\r\n  protected childAgents: AgentId[] = [];\r\n  protected endpoints: string[] = [];\r\n\r\n  protected logger: ILogger;\r\n  protected eventBus: IEventBus;\r\n  protected memory: DistributedMemorySystem;\r\n\r\n  private heartbeatInterval?: NodeJS.Timeout;\r\n  private metricsInterval?: NodeJS.Timeout;\r\n  private isShuttingDown = false;\r\n\r\n  constructor(\r\n    id: string,\r\n    type: AgentType,\r\n    config: AgentConfig,\r\n    environment: AgentEnvironment,\r\n    logger: ILogger,\r\n    eventBus: IEventBus,\r\n    memory: DistributedMemorySystem,\r\n  ) {\r\n    super();\r\n    this.id = id;\r\n    this.type = type;\r\n    this.logger = logger;\r\n    this.eventBus = eventBus;\r\n    this.memory = memory;\r\n\r\n    // Merge with defaults\r\n    this.capabilities = { ...this.getDefaultCapabilities(), ...(config as any).capabilities };\r\n    this.config = { ...this.getDefaultConfig(), ...config };\r\n    this.environment = { ...this.getDefaultEnvironment(), ...environment };\r\n    this.metrics = this.createDefaultMetrics();\r\n\r\n    this.setupEventHandlers();\r\n  }\r\n\r\n  // Abstract methods that specialized agents must implement\r\n  protected abstract getDefaultCapabilities(): AgentCapabilities;\r\n  protected abstract getDefaultConfig(): Partial<AgentConfig>;\r\n  public abstract executeTask(task: TaskDefinition): Promise<any>;\r\n\r\n  // Common agent lifecycle methods\r\n  async initialize(): Promise<void> {\r\n    this.logger.info('Initializing agent', {\r\n      agentId: this.id,\r\n      type: this.type,\r\n    });\r\n\r\n    this.status = 'initializing';\r\n    this.emit('agent:status-changed', { agentId: this.id, status: this.status });\r\n\r\n    // Start heartbeat\r\n    this.startHeartbeat();\r\n\r\n    // Start metrics collection\r\n    this.startMetricsCollection();\r\n\r\n    // Store initial state\r\n    await this.saveState();\r\n\r\n    this.status = 'idle';\r\n    this.emit('agent:status-changed', { agentId: this.id, status: this.status });\r\n    this.emit('agent:ready', { agentId: this.id });\r\n\r\n    this.logger.info('Agent initialized successfully', {\r\n      agentId: this.id,\r\n      type: this.type,\r\n    });\r\n  }\r\n\r\n  async shutdown(): Promise<void> {\r\n    this.logger.info('Shutting down agent', {\r\n      agentId: this.id,\r\n      type: this.type,\r\n    });\r\n\r\n    this.isShuttingDown = true;\r\n    this.status = 'terminating';\r\n    this.emit('agent:status-changed', { agentId: this.id, status: this.status });\r\n\r\n    // Wait for current tasks to complete\r\n    await this.waitForTasksCompletion();\r\n\r\n    // Stop intervals\r\n    if (this.heartbeatInterval) {\r\n      clearInterval(this.heartbeatInterval);\r\n    }\r\n    if (this.metricsInterval) {\r\n      clearInterval(this.metricsInterval);\r\n    }\r\n\r\n    // Save final state\r\n    await this.saveState();\r\n\r\n    this.status = 'terminated';\r\n    this.emit('agent:status-changed', { agentId: this.id, status: this.status });\r\n    this.emit('agent:shutdown', { agentId: this.id });\r\n\r\n    this.logger.info('Agent shutdown complete', {\r\n      agentId: this.id,\r\n      type: this.type,\r\n    });\r\n  }\r\n\r\n  async assignTask(task: TaskDefinition): Promise<void> {\r\n    if (this.status !== 'idle') {\r\n      throw new Error(`Agent ${this.id} is not available (status: ${this.status})`);\r\n    }\r\n\r\n    if (this.currentTasks.length >= this.capabilities.maxConcurrentTasks) {\r\n      throw new Error(`Agent ${this.id} has reached maximum concurrent tasks`);\r\n    }\r\n\r\n    this.logger.info('Task assigned to agent', {\r\n      agentId: this.id,\r\n      taskId: task.id,\r\n      taskType: task.type,\r\n    });\r\n\r\n    this.currentTasks.push(task.id);\r\n    this.status = 'busy';\r\n    this.workload = this.currentTasks.length / this.capabilities.maxConcurrentTasks;\r\n\r\n    this.emit('agent:task-assigned', { agentId: this.id, taskId: task.id });\r\n    this.emit('agent:status-changed', { agentId: this.id, status: this.status });\r\n\r\n    try {\r\n      const startTime = Date.now();\r\n      const result = await this.executeTask(task);\r\n      const executionTime = Date.now() - startTime;\r\n\r\n      // Update metrics\r\n      this.updateTaskMetrics(task.id, executionTime, true);\r\n\r\n      // Remove from current tasks\r\n      this.currentTasks = this.currentTasks.filter((id) => id !== task.id);\r\n      this.taskHistory.push(task.id);\r\n\r\n      // Update status\r\n      this.status = this.currentTasks.length > 0 ? 'busy' : 'idle';\r\n      this.workload = this.currentTasks.length / this.capabilities.maxConcurrentTasks;\r\n\r\n      this.emit('agent:task-completed', {\r\n        agentId: this.id,\r\n        taskId: task.id,\r\n        result,\r\n        executionTime,\r\n      });\r\n\r\n      this.logger.info('Task completed successfully', {\r\n        agentId: this.id,\r\n        taskId: task.id,\r\n        executionTime,\r\n      });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n\r\n      // Update metrics\r\n      this.updateTaskMetrics(task.id, 0, false);\r\n\r\n      // Add to error history\r\n      this.addError({\r\n        timestamp: new Date(),\r\n        type: 'task_execution_failed',\r\n        message: errorMessage,\r\n        context: { taskId: task.id, taskType: task.type },\r\n        severity: 'high',\r\n        resolved: false,\r\n      });\r\n\r\n      // Remove from current tasks\r\n      this.currentTasks = this.currentTasks.filter((id) => id !== task.id);\r\n      this.status = this.currentTasks.length > 0 ? 'busy' : 'idle';\r\n      this.workload = this.currentTasks.length / this.capabilities.maxConcurrentTasks;\r\n\r\n      this.emit('agent:task-failed', {\r\n        agentId: this.id,\r\n        taskId: task.id,\r\n        error: errorMessage,\r\n      });\r\n\r\n      this.logger.error('Task execution failed', {\r\n        agentId: this.id,\r\n        taskId: task.id,\r\n        error: errorMessage,\r\n      });\r\n\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Agent information and status methods\r\n  getAgentInfo(): AgentState {\r\n    return {\r\n      id: {\r\n        id: this.id,\r\n        swarmId: 'default',\r\n        type: this.type,\r\n        instance: 1,\r\n      },\r\n      name: `${this.type}-${this.id.slice(-8)}`,\r\n      type: this.type,\r\n      status: this.status,\r\n      capabilities: this.capabilities,\r\n      config: this.config,\r\n      environment: this.environment,\r\n      metrics: this.metrics,\r\n      workload: this.workload,\r\n      health: this.health,\r\n      lastHeartbeat: this.lastHeartbeat,\r\n      currentTasks: this.currentTasks,\r\n      taskHistory: this.taskHistory,\r\n      errorHistory: this.errorHistory,\r\n      collaborators: this.collaborators,\r\n      childAgents: this.childAgents,\r\n      endpoints: this.endpoints,\r\n    };\r\n  }\r\n\r\n  getAgentStatus(): any {\r\n    return {\r\n      id: this.id,\r\n      type: this.type,\r\n      status: this.status,\r\n      health: this.health,\r\n      workload: this.workload,\r\n      currentTasks: this.currentTasks.length,\r\n      totalTasksCompleted: this.metrics.tasksCompleted,\r\n      successRate: this.metrics.successRate,\r\n      averageExecutionTime: this.metrics.averageExecutionTime,\r\n      lastActivity: this.metrics.lastActivity,\r\n      uptime: Date.now() - this.metrics.totalUptime,\r\n    };\r\n  }\r\n\r\n  getCurrentTasks(): TaskId[] {\r\n    return [...this.currentTasks];\r\n  }\r\n\r\n  getTaskHistory(): TaskId[] {\r\n    return [...this.taskHistory];\r\n  }\r\n\r\n  getErrorHistory(): AgentError[] {\r\n    return [...this.errorHistory];\r\n  }\r\n\r\n  getLastTaskCompletedTime(): Date {\r\n    return this.metrics.lastActivity;\r\n  }\r\n\r\n  // Health and metrics methods\r\n  updateHealth(health: number): void {\r\n    this.health = Math.max(0, Math.min(1, health));\r\n    this.emit('agent:health-changed', { agentId: this.id, health: this.health });\r\n  }\r\n\r\n  addCollaborator(agentId: AgentId): void {\r\n    if (!this.collaborators.find((c) => c.id === agentId.id)) {\r\n      this.collaborators.push(agentId);\r\n      this.emit('agent:collaborator-added', { agentId: this.id, collaborator: agentId });\r\n    }\r\n  }\r\n\r\n  removeCollaborator(agentId: string): void {\r\n    this.collaborators = this.collaborators.filter((c) => c.id !== agentId);\r\n    this.emit('agent:collaborator-removed', { agentId: this.id, collaborator: agentId });\r\n  }\r\n\r\n  // Protected helper methods\r\n  protected getDefaultEnvironment(): Partial<AgentEnvironment> {\r\n    return {\r\n      runtime: 'deno',\r\n      version: '1.40.0',\r\n      workingDirectory: `./agents/${this.type}`,\r\n      tempDirectory: `./tmp/${this.type}`,\r\n      logDirectory: `./logs/${this.type}`,\r\n      apiEndpoints: {},\r\n      credentials: {},\r\n      availableTools: [],\r\n      toolConfigs: {},\r\n    };\r\n  }\r\n\r\n  protected createDefaultMetrics(): AgentMetrics {\r\n    return {\r\n      tasksCompleted: 0,\r\n      tasksFailed: 0,\r\n      averageExecutionTime: 0,\r\n      successRate: 1.0,\r\n      cpuUsage: 0,\r\n      memoryUsage: 0,\r\n      diskUsage: 0,\r\n      networkUsage: 0,\r\n      codeQuality: 0.8,\r\n      testCoverage: 0,\r\n      bugRate: 0,\r\n      userSatisfaction: 0.8,\r\n      totalUptime: Date.now(),\r\n      lastActivity: new Date(),\r\n      responseTime: 0,\r\n    };\r\n  }\r\n\r\n  protected setupEventHandlers(): void {\r\n    this.eventBus.on('system:shutdown', () => {\r\n      if (!this.isShuttingDown) {\r\n        this.shutdown().catch((error) => {\r\n          this.logger.error('Error during agent shutdown', {\r\n            agentId: this.id,\r\n            error: error instanceof Error ? error.message : String(error),\r\n          });\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  protected startHeartbeat(): void {\r\n    this.heartbeatInterval = setInterval(() => {\r\n      if (!this.isShuttingDown) {\r\n        this.sendHeartbeat();\r\n      }\r\n    }, this.config.heartbeatInterval || 10000);\r\n  }\r\n\r\n  protected startMetricsCollection(): void {\r\n    this.metricsInterval = setInterval(() => {\r\n      if (!this.isShuttingDown) {\r\n        this.collectMetrics();\r\n      }\r\n    }, 30000); // Every 30 seconds\r\n  }\r\n\r\n  protected sendHeartbeat(): void {\r\n    this.lastHeartbeat = new Date();\r\n    this.eventBus.emit('agent:heartbeat', {\r\n      agentId: this.id,\r\n      timestamp: this.lastHeartbeat,\r\n      metrics: this.metrics,\r\n    });\r\n  }\r\n\r\n  protected async collectMetrics(): Promise<void> {\r\n    // Update response time based on recent tasks\r\n    const recentTasksTime = this.getRecentTasksAverageTime();\r\n    this.metrics.responseTime = recentTasksTime;\r\n\r\n    // Update activity timestamp\r\n    if (this.currentTasks.length > 0) {\r\n      this.metrics.lastActivity = new Date();\r\n    }\r\n\r\n    // Calculate success rate\r\n    const totalTasks = this.metrics.tasksCompleted + this.metrics.tasksFailed;\r\n    if (totalTasks > 0) {\r\n      this.metrics.successRate = this.metrics.tasksCompleted / totalTasks;\r\n    }\r\n\r\n    // Store metrics in memory\r\n    await this.memory.store(`agent:${this.id}:metrics`, this.metrics, {\r\n      type: 'agent-metrics',\r\n      tags: ['metrics', this.type, this.id],\r\n      partition: 'metrics',\r\n    });\r\n  }\r\n\r\n  protected updateTaskMetrics(taskId: TaskId, executionTime: number, success: boolean): void {\r\n    if (success) {\r\n      this.metrics.tasksCompleted++;\r\n\r\n      // Update average execution time\r\n      const totalTime =\r\n        this.metrics.averageExecutionTime * (this.metrics.tasksCompleted - 1) + executionTime;\r\n      this.metrics.averageExecutionTime = totalTime / this.metrics.tasksCompleted;\r\n    } else {\r\n      this.metrics.tasksFailed++;\r\n    }\r\n\r\n    this.metrics.lastActivity = new Date();\r\n  }\r\n\r\n  protected addError(error: AgentError): void {\r\n    this.errorHistory.push(error);\r\n\r\n    // Keep only last 50 errors\r\n    if (this.errorHistory.length > 50) {\r\n      this.errorHistory.shift();\r\n    }\r\n\r\n    this.eventBus.emit('agent:error', {\r\n      agentId: this.id,\r\n      error,\r\n    });\r\n\r\n    // Reduce health based on error severity\r\n    const healthImpact =\r\n      {\r\n        low: 0.01,\r\n        medium: 0.05,\r\n        high: 0.1,\r\n        critical: 0.2,\r\n      }[error.severity] || 0.05;\r\n\r\n    this.updateHealth(this.health - healthImpact);\r\n  }\r\n\r\n  protected getRecentTasksAverageTime(): number {\r\n    // Simplified - would normally track individual task times\r\n    return this.metrics.averageExecutionTime;\r\n  }\r\n\r\n  protected async waitForTasksCompletion(): Promise<void> {\r\n    if (this.currentTasks.length === 0) return;\r\n\r\n    return new Promise((resolve) => {\r\n      const checkTasks = () => {\r\n        if (this.currentTasks.length === 0) {\r\n          resolve();\r\n        } else {\r\n          setTimeout(checkTasks, 1000);\r\n        }\r\n      };\r\n      checkTasks();\r\n    });\r\n  }\r\n\r\n  protected async saveState(): Promise<void> {\r\n    try {\r\n      await this.memory.store(`agent:${this.id}:state`, this.getAgentInfo(), {\r\n        type: 'agent-state',\r\n        tags: ['state', this.type, this.id],\r\n        partition: 'state',\r\n      });\r\n    } catch (error) {\r\n      this.logger.error('Failed to save agent state', {\r\n        agentId: this.id,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n}\r\n"],"names":["EventEmitter","BaseAgent","id","type","status","capabilities","config","environment","metrics","workload","health","lastHeartbeat","Date","currentTasks","taskHistory","errorHistory","collaborators","childAgents","endpoints","logger","eventBus","memory","heartbeatInterval","metricsInterval","isShuttingDown","getDefaultCapabilities","getDefaultConfig","getDefaultEnvironment","createDefaultMetrics","setupEventHandlers","initialize","info","agentId","emit","startHeartbeat","startMetricsCollection","saveState","shutdown","waitForTasksCompletion","clearInterval","assignTask","task","Error","length","maxConcurrentTasks","taskId","taskType","push","startTime","now","result","executeTask","executionTime","updateTaskMetrics","filter","error","errorMessage","message","String","addError","timestamp","context","severity","resolved","getAgentInfo","swarmId","instance","name","slice","getAgentStatus","totalTasksCompleted","tasksCompleted","successRate","averageExecutionTime","lastActivity","uptime","totalUptime","getCurrentTasks","getTaskHistory","getErrorHistory","getLastTaskCompletedTime","updateHealth","Math","max","min","addCollaborator","find","c","collaborator","removeCollaborator","runtime","version","workingDirectory","tempDirectory","logDirectory","apiEndpoints","credentials","availableTools","toolConfigs","tasksFailed","cpuUsage","memoryUsage","diskUsage","networkUsage","codeQuality","testCoverage","bugRate","userSatisfaction","responseTime","on","catch","setInterval","sendHeartbeat","collectMetrics","recentTasksTime","getRecentTasksAverageTime","totalTasks","store","tags","partition","success","totalTime","shift","healthImpact","low","medium","high","critical","Promise","resolve","checkTasks","setTimeout"],"mappings":"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"}
{"version":3,"sources":["../../../../../src/cli/simple-commands/hive-mind/memory.js"],"sourcesContent":["/**\r\n * Collective Memory System for Hive Mind\r\n * Shared knowledge base and learning system\r\n */\r\n\r\nimport EventEmitter from 'events';\r\nimport Database from 'better-sqlite3';\r\nimport path from 'path';\r\nimport { performance } from 'perf_hooks';\r\nimport { Worker } from 'worker_threads';\r\n\r\n/**\r\n * Memory types and their characteristics\r\n */\r\nconst MEMORY_TYPES = {\r\n  knowledge: { priority: 1, ttl: null, compress: false },\r\n  context: { priority: 2, ttl: 3600000, compress: false }, // 1 hour\r\n  task: { priority: 3, ttl: 1800000, compress: true }, // 30 minutes\r\n  result: { priority: 2, ttl: null, compress: true },\r\n  error: { priority: 1, ttl: 86400000, compress: false }, // 24 hours\r\n  metric: { priority: 3, ttl: 3600000, compress: true }, // 1 hour\r\n  consensus: { priority: 1, ttl: null, compress: false },\r\n  system: { priority: 1, ttl: null, compress: false },\r\n};\r\n\r\n/**\r\n * Memory Pool for object reuse\r\n */\r\nclass MemoryPool {\r\n  constructor(createFn, resetFn, maxSize = 1000) {\r\n    this.createFn = createFn;\r\n    this.resetFn = resetFn;\r\n    this.maxSize = maxSize;\r\n    this.pool = [];\r\n    this.allocated = 0;\r\n    this.reused = 0;\r\n  }\r\n\r\n  acquire() {\r\n    if (this.pool.length > 0) {\r\n      this.reused++;\r\n      return this.pool.pop();\r\n    }\r\n    this.allocated++;\r\n    return this.createFn();\r\n  }\r\n\r\n  release(obj) {\r\n    if (this.pool.length < this.maxSize) {\r\n      this.resetFn(obj);\r\n      this.pool.push(obj);\r\n    }\r\n  }\r\n\r\n  getStats() {\r\n    return {\r\n      poolSize: this.pool.length,\r\n      allocated: this.allocated,\r\n      reused: this.reused,\r\n      reuseRate: (this.reused / (this.allocated + this.reused)) * 100,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Optimized LRU Cache with memory pressure handling\r\n */\r\nclass OptimizedLRUCache {\r\n  constructor(maxSize = 1000, maxMemoryMB = 50) {\r\n    this.maxSize = maxSize;\r\n    this.maxMemory = maxMemoryMB * 1024 * 1024;\r\n    this.cache = new Map();\r\n    this.currentMemory = 0;\r\n    this.hits = 0;\r\n    this.misses = 0;\r\n    this.evictions = 0;\r\n  }\r\n\r\n  get(key) {\r\n    if (this.cache.has(key)) {\r\n      const value = this.cache.get(key);\r\n      // Move to end (most recently used)\r\n      this.cache.delete(key);\r\n      this.cache.set(key, value);\r\n      this.hits++;\r\n      return value.data;\r\n    }\r\n    this.misses++;\r\n    return null;\r\n  }\r\n\r\n  set(key, data) {\r\n    const size = this._estimateSize(data);\r\n\r\n    // Check memory pressure\r\n    if (this.currentMemory + size > this.maxMemory) {\r\n      this._evictByMemoryPressure(size);\r\n    }\r\n\r\n    // Check size limit\r\n    if (this.cache.size >= this.maxSize) {\r\n      this._evictLRU();\r\n    }\r\n\r\n    const entry = {\r\n      data,\r\n      size,\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.cache.set(key, entry);\r\n    this.currentMemory += size;\r\n  }\r\n\r\n  _estimateSize(obj) {\r\n    return JSON.stringify(obj).length * 2; // Rough estimate\r\n  }\r\n\r\n  _evictLRU() {\r\n    const firstKey = this.cache.keys().next().value;\r\n    if (firstKey) {\r\n      const entry = this.cache.get(firstKey);\r\n      this.cache.delete(firstKey);\r\n      this.currentMemory -= entry.size;\r\n      this.evictions++;\r\n    }\r\n  }\r\n\r\n  _evictByMemoryPressure(neededSize) {\r\n    while (this.currentMemory + neededSize > this.maxMemory && this.cache.size > 0) {\r\n      this._evictLRU();\r\n    }\r\n  }\r\n\r\n  forEach(callback) {\r\n    this.cache.forEach((entry, key) => {\r\n      callback(entry, key);\r\n    });\r\n  }\r\n\r\n  delete(key) {\r\n    if (this.cache.has(key)) {\r\n      const entry = this.cache.get(key);\r\n      this.cache.delete(key);\r\n      this.currentMemory -= entry.size;\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getStats() {\r\n    return {\r\n      size: this.cache.size,\r\n      memoryUsage: this.currentMemory,\r\n      hitRate: (this.hits / (this.hits + this.misses)) * 100,\r\n      evictions: this.evictions,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Optimized CollectiveMemory class with advanced memory management\r\n */\r\nexport class CollectiveMemory extends EventEmitter {\r\n  constructor(config = {}) {\r\n    super();\r\n\r\n    /** @type {import('better-sqlite3').Database | null} */\r\n    this.db = null;\r\n\r\n    this.config = {\r\n      swarmId: config.swarmId,\r\n      maxSize: config.maxSize || 100, // MB\r\n      dbPath: config.dbPath || path.join(process.cwd(), '.hive-mind', 'hive.db'),\r\n      compressionThreshold: config.compressionThreshold || 1024, // bytes\r\n      gcInterval: config.gcInterval || 300000, // 5 minutes\r\n      cacheSize: config.cacheSize || 1000,\r\n      cacheMemoryMB: config.cacheMemoryMB || 50,\r\n      enablePooling: config.enablePooling !== false,\r\n      enableAsyncOperations: config.enableAsyncOperations !== false,\r\n      ...config,\r\n    };\r\n\r\n    this.state = {\r\n      totalSize: 0,\r\n      entryCount: 0,\r\n      compressionRatio: 1,\r\n      lastGC: Date.now(),\r\n      accessPatterns: new Map(),\r\n      performanceMetrics: {\r\n        queryTimes: [],\r\n        avgQueryTime: 0,\r\n        cacheHitRate: 0,\r\n        memoryEfficiency: 0,\r\n      },\r\n    };\r\n\r\n    this.gcTimer = null;\r\n\r\n    // Optimized cache with LRU eviction\r\n    this.cache = new OptimizedLRUCache(this.config.cacheSize, this.config.cacheMemoryMB);\r\n\r\n    // Memory pools for frequently created objects\r\n    this.pools = {\r\n      queryResults: new MemoryPool(\r\n        () => ({ results: [], metadata: {} }),\r\n        (obj) => {\r\n          obj.results.length = 0;\r\n          Object.keys(obj.metadata).forEach((k) => delete obj.metadata[k]);\r\n        },\r\n      ),\r\n      memoryEntries: new MemoryPool(\r\n        () => ({ id: '', key: '', value: '', metadata: {} }),\r\n        (obj) => {\r\n          obj.id = obj.key = obj.value = '';\r\n          Object.keys(obj.metadata).forEach((k) => delete obj.metadata[k]);\r\n        },\r\n      ),\r\n    };\r\n\r\n    // Prepared statements for better performance\r\n    this.statements = new Map();\r\n\r\n    // Background worker for heavy operations\r\n    this.backgroundWorker = null;\r\n\r\n    this._initialize();\r\n  }\r\n\r\n  /**\r\n   * Initialize collective memory with optimizations\r\n   */\r\n  _initialize() {\r\n    try {\r\n      // Open database connection with optimizations\r\n      this.db = new Database(this.config.dbPath);\r\n\r\n      // Performance optimizations\r\n      this.db.pragma('journal_mode = WAL');\r\n      this.db.pragma('synchronous = NORMAL');\r\n      this.db.pragma('cache_size = -64000'); // 64MB cache\r\n      this.db.pragma('temp_store = MEMORY');\r\n      this.db.pragma('mmap_size = 268435456'); // 256MB memory mapping\r\n      this.db.pragma('optimize');\r\n\r\n      // Ensure table exists with optimized schema\r\n      this.db.exec(`\r\n        CREATE TABLE IF NOT EXISTS collective_memory (\r\n          id TEXT PRIMARY KEY,\r\n          swarm_id TEXT NOT NULL,\r\n          key TEXT NOT NULL,\r\n          value BLOB,\r\n          type TEXT DEFAULT 'knowledge',\r\n          confidence REAL DEFAULT 1.0,\r\n          created_by TEXT,\r\n          created_at INTEGER DEFAULT (strftime('%s','now')),\r\n          accessed_at INTEGER DEFAULT (strftime('%s','now')),\r\n          access_count INTEGER DEFAULT 0,\r\n          compressed INTEGER DEFAULT 0,\r\n          size INTEGER DEFAULT 0,\r\n          FOREIGN KEY (swarm_id) REFERENCES swarms(id)\r\n        );\r\n        \r\n        -- Optimized indexes\r\n        CREATE UNIQUE INDEX IF NOT EXISTS idx_memory_swarm_key \r\n        ON collective_memory(swarm_id, key);\r\n        \r\n        CREATE INDEX IF NOT EXISTS idx_memory_type_accessed \r\n        ON collective_memory(type, accessed_at DESC);\r\n        \r\n        CREATE INDEX IF NOT EXISTS idx_memory_size_compressed \r\n        ON collective_memory(size, compressed);\r\n        \r\n        -- Memory optimization view\r\n        CREATE VIEW IF NOT EXISTS memory_stats AS\r\n        SELECT \r\n          swarm_id,\r\n          type,\r\n          COUNT(*) as entry_count,\r\n          SUM(size) as total_size,\r\n          AVG(access_count) as avg_access,\r\n          MAX(accessed_at) as last_access\r\n        FROM collective_memory\r\n        GROUP BY swarm_id, type;\r\n      `);\r\n\r\n      // Prepare optimized statements\r\n      this._prepareStatements();\r\n\r\n      // Load initial statistics\r\n      this._updateStatistics();\r\n\r\n      // Start background optimization processes\r\n      this._startOptimizationTimers();\r\n\r\n      // Initialize background worker for heavy operations\r\n      if (this.config.enableAsyncOperations) {\r\n        this._initializeBackgroundWorker();\r\n      }\r\n\r\n      this.emit('memory:initialized', {\r\n        swarmId: this.config.swarmId,\r\n        optimizations: {\r\n          pooling: this.config.enablePooling,\r\n          asyncOps: this.config.enableAsyncOperations,\r\n          cacheSize: this.config.cacheSize,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Prepare optimized SQL statements\r\n   */\r\n  _prepareStatements() {\r\n    this.statements.set(\r\n      'insert',\r\n      this.db.prepare(`\r\n      INSERT OR REPLACE INTO collective_memory \r\n      (id, swarm_id, key, value, type, confidence, created_by, compressed, size)\r\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'update',\r\n      this.db.prepare(`\r\n      UPDATE collective_memory \r\n      SET value = ?, accessed_at = strftime('%s','now'), access_count = access_count + 1,\r\n          compressed = ?, size = ?\r\n      WHERE swarm_id = ? AND key = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'select',\r\n      this.db.prepare(`\r\n      SELECT value, type, compressed, confidence, access_count\r\n      FROM collective_memory\r\n      WHERE swarm_id = ? AND key = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'updateAccess',\r\n      this.db.prepare(`\r\n      UPDATE collective_memory\r\n      SET accessed_at = strftime('%s','now'), access_count = access_count + 1\r\n      WHERE swarm_id = ? AND key = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'searchByPattern',\r\n      this.db.prepare(`\r\n      SELECT key, type, confidence, created_at, accessed_at, access_count\r\n      FROM collective_memory\r\n      WHERE swarm_id = ? AND key LIKE ? AND confidence >= ?\r\n      ORDER BY access_count DESC, confidence DESC\r\n      LIMIT ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getStats',\r\n      this.db.prepare(`\r\n      SELECT \r\n        COUNT(*) as count,\r\n        SUM(size) as totalSize,\r\n        AVG(confidence) as avgConfidence,\r\n        SUM(compressed) as compressedCount,\r\n        AVG(access_count) as avgAccess\r\n      FROM collective_memory\r\n      WHERE swarm_id = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'deleteExpired',\r\n      this.db.prepare(`\r\n      DELETE FROM collective_memory\r\n      WHERE swarm_id = ? AND type = ? AND (strftime('%s','now') - accessed_at) > ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getLRU',\r\n      this.db.prepare(`\r\n      SELECT id, size FROM collective_memory\r\n      WHERE swarm_id = ? AND type NOT IN ('system', 'consensus')\r\n      ORDER BY accessed_at ASC, access_count ASC\r\n      LIMIT ?\r\n    `),\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Start optimization timers\r\n   */\r\n  _startOptimizationTimers() {\r\n    // Main garbage collection\r\n    this.gcTimer = setInterval(() => this._garbageCollect(), this.config.gcInterval);\r\n\r\n    // Database optimization\r\n    this.optimizeTimer = setInterval(() => this._optimizeDatabase(), 1800000); // 30 minutes\r\n\r\n    // Cache cleanup\r\n    this.cacheTimer = setInterval(() => this._optimizeCache(), 60000); // 1 minute\r\n\r\n    // Performance monitoring\r\n    this.metricsTimer = setInterval(() => this._updatePerformanceMetrics(), 30000); // 30 seconds\r\n  }\r\n\r\n  /**\r\n   * Initialize background worker for heavy operations\r\n   */\r\n  _initializeBackgroundWorker() {\r\n    // Note: In production, this would initialize a proper Worker\r\n    // For now, we'll use async operations\r\n    this.backgroundQueue = [];\r\n    this.backgroundProcessing = false;\r\n  }\r\n\r\n  /**\r\n   * Store data in collective memory\r\n   */\r\n  async store(key, value, type = 'knowledge', metadata = {}) {\r\n    try {\r\n      const serialized = JSON.stringify(value);\r\n      const size = Buffer.byteLength(serialized);\r\n      const shouldCompress =\r\n        size > this.config.compressionThreshold && MEMORY_TYPES[type]?.compress;\r\n\r\n      let storedValue = serialized;\r\n      let compressed = 0;\r\n\r\n      if (shouldCompress) {\r\n        // In production, use proper compression like zlib\r\n        // For now, we'll just mark it as compressed\r\n        compressed = 1;\r\n      }\r\n\r\n      const id = `${this.config.swarmId}-${key}-${Date.now()}`;\r\n\r\n      // Check if key already exists\r\n      const existing = this.db\r\n        .prepare(\r\n          `\r\n        SELECT id FROM collective_memory \r\n        WHERE swarm_id = ? AND key = ?\r\n      `,\r\n        )\r\n        .get(this.config.swarmId, key);\r\n\r\n      if (existing) {\r\n        // Update existing entry\r\n        this.db\r\n          .prepare(\r\n            `\r\n          UPDATE collective_memory \r\n          SET value = ?, type = ?, confidence = ?, \r\n              accessed_at = CURRENT_TIMESTAMP, access_count = access_count + 1,\r\n              compressed = ?, size = ?\r\n          WHERE swarm_id = ? AND key = ?\r\n        `,\r\n          )\r\n          .run(\r\n            storedValue,\r\n            type,\r\n            metadata.confidence || 1.0,\r\n            compressed,\r\n            size,\r\n            this.config.swarmId,\r\n            key,\r\n          );\r\n      } else {\r\n        // Insert new entry\r\n        this.db\r\n          .prepare(\r\n            `\r\n          INSERT INTO collective_memory \r\n          (id, swarm_id, key, value, type, confidence, created_by, compressed, size)\r\n          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n        `,\r\n          )\r\n          .run(\r\n            id,\r\n            this.config.swarmId,\r\n            key,\r\n            storedValue,\r\n            type,\r\n            metadata.confidence || 1.0,\r\n            metadata.createdBy || 'system',\r\n            compressed,\r\n            size,\r\n          );\r\n      }\r\n\r\n      // Update cache\r\n      this.cache.set(key, {\r\n        value,\r\n        type,\r\n        timestamp: Date.now(),\r\n        size,\r\n      });\r\n\r\n      // Check memory limits\r\n      this._checkMemoryLimits();\r\n\r\n      // Track access pattern\r\n      this._trackAccess(key, 'write');\r\n\r\n      this.emit('memory:stored', { key, type, size });\r\n\r\n      return { success: true, id, size };\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve data from collective memory\r\n   */\r\n  async retrieve(key) {\r\n    try {\r\n      // Check cache first\r\n      if (this.cache.has(key)) {\r\n        const cached = this.cache.get(key);\r\n        this._trackAccess(key, 'cache_hit');\r\n        return cached.value;\r\n      }\r\n\r\n      // Query database\r\n      const result = this.db\r\n        .prepare(\r\n          `\r\n        SELECT value, type, compressed, confidence\r\n        FROM collective_memory\r\n        WHERE swarm_id = ? AND key = ?\r\n      `,\r\n        )\r\n        .get(this.config.swarmId, key);\r\n\r\n      if (!result) {\r\n        this._trackAccess(key, 'miss');\r\n        return null;\r\n      }\r\n\r\n      // Update access statistics\r\n      this.db\r\n        .prepare(\r\n          `\r\n        UPDATE collective_memory\r\n        SET accessed_at = CURRENT_TIMESTAMP,\r\n            access_count = access_count + 1\r\n        WHERE swarm_id = ? AND key = ?\r\n      `,\r\n        )\r\n        .run(this.config.swarmId, key);\r\n\r\n      // Decompress if needed\r\n      let value = result.value;\r\n      if (result.compressed) {\r\n        // In production, decompress here\r\n      }\r\n\r\n      // Parse JSON\r\n      const parsed = JSON.parse(value);\r\n\r\n      // Add to cache\r\n      this.cache.set(key, {\r\n        value: parsed,\r\n        type: result.type,\r\n        timestamp: Date.now(),\r\n        confidence: result.confidence,\r\n      });\r\n\r\n      this._trackAccess(key, 'read');\r\n\r\n      return parsed;\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search collective memory\r\n   */\r\n  async search(pattern, options = {}) {\r\n    try {\r\n      const limit = options.limit || 50;\r\n      const type = options.type || null;\r\n      const minConfidence = options.minConfidence || 0;\r\n\r\n      let query = `\r\n        SELECT key, type, confidence, created_at, accessed_at, access_count\r\n        FROM collective_memory\r\n        WHERE swarm_id = ? \r\n        AND key LIKE ?\r\n        AND confidence >= ?\r\n      `;\r\n\r\n      const params = [this.config.swarmId, `%${pattern}%`, minConfidence];\r\n\r\n      if (type) {\r\n        query += ' AND type = ?';\r\n        params.push(type);\r\n      }\r\n\r\n      query += ' ORDER BY access_count DESC, confidence DESC LIMIT ?';\r\n      params.push(limit);\r\n\r\n      const results = this.db.prepare(query).all(...params);\r\n\r\n      this._trackAccess(`search:${pattern}`, 'search');\r\n\r\n      return results;\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get related memories using association\r\n   */\r\n  async getRelated(key, limit = 10) {\r\n    try {\r\n      // Get the original memory\r\n      const original = await this.retrieve(key);\r\n      if (!original) return [];\r\n\r\n      // Simple association: find memories accessed around the same time\r\n      const result = this.db\r\n        .prepare(\r\n          `\r\n        SELECT m1.key, m1.type, m1.confidence, m1.access_count\r\n        FROM collective_memory m1\r\n        JOIN collective_memory m2 ON m1.swarm_id = m2.swarm_id\r\n        WHERE m2.key = ? \r\n        AND m1.key != ?\r\n        AND m1.swarm_id = ?\r\n        AND ABS(julianday(m1.accessed_at) - julianday(m2.accessed_at)) < 0.01\r\n        ORDER BY m1.confidence DESC, m1.access_count DESC\r\n        LIMIT ?\r\n      `,\r\n        )\r\n        .all(key, key, this.config.swarmId, limit);\r\n\r\n      return result;\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build associations between memories\r\n   */\r\n  async associate(key1, key2, strength = 1.0) {\r\n    try {\r\n      // Store bidirectional association\r\n      await this.store(\r\n        `assoc:${key1}:${key2}`,\r\n        {\r\n          from: key1,\r\n          to: key2,\r\n          strength,\r\n          created: Date.now(),\r\n        },\r\n        'system',\r\n      );\r\n\r\n      await this.store(\r\n        `assoc:${key2}:${key1}`,\r\n        {\r\n          from: key2,\r\n          to: key1,\r\n          strength,\r\n          created: Date.now(),\r\n        },\r\n        'system',\r\n      );\r\n\r\n      this.emit('memory:associated', { key1, key2, strength });\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Consolidate similar memories\r\n   */\r\n  async consolidate() {\r\n    try {\r\n      // Find similar memories\r\n      const memories = this.db\r\n        .prepare(\r\n          `\r\n        SELECT key, value, type, confidence, access_count\r\n        FROM collective_memory\r\n        WHERE swarm_id = ?\r\n        AND type IN ('knowledge', 'result')\r\n        ORDER BY created_at DESC\r\n        LIMIT 1000\r\n      `,\r\n        )\r\n        .all(this.config.swarmId);\r\n\r\n      const consolidated = new Map();\r\n\r\n      // Group by similarity (simple implementation)\r\n      memories.forEach((memory) => {\r\n        const value = JSON.parse(memory.value);\r\n        const category = this._categorizeMemory(value);\r\n\r\n        if (!consolidated.has(category)) {\r\n          consolidated.set(category, []);\r\n        }\r\n\r\n        consolidated.get(category).push({\r\n          ...memory,\r\n          value,\r\n        });\r\n      });\r\n\r\n      // Merge similar memories\r\n      let mergeCount = 0;\r\n      consolidated.forEach((group, category) => {\r\n        if (group.length > 1) {\r\n          const merged = this._mergeMemories(group);\r\n\r\n          // Store merged memory\r\n          this.store(`consolidated:${category}`, merged, 'knowledge', {\r\n            confidence: merged.confidence,\r\n            createdBy: 'consolidation',\r\n          });\r\n\r\n          mergeCount++;\r\n        }\r\n      });\r\n\r\n      this.emit('memory:consolidated', { categories: consolidated.size, merged: mergeCount });\r\n\r\n      return { categories: consolidated.size, merged: mergeCount };\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Categorize memory for consolidation\r\n   */\r\n  _categorizeMemory(value) {\r\n    // Simple categorization based on content\r\n    if (typeof value === 'string') {\r\n      return 'text';\r\n    }\r\n\r\n    if (typeof value === 'object') {\r\n      const keys = Object.keys(value).sort().join(':');\r\n      return `object:${keys.substring(0, 50)}`;\r\n    }\r\n\r\n    return 'other';\r\n  }\r\n\r\n  /**\r\n   * Merge similar memories\r\n   */\r\n  _mergeMemories(memories) {\r\n    // Calculate weighted average confidence\r\n    let totalWeight = 0;\r\n    let weightedConfidence = 0;\r\n    const mergedValue = {};\r\n\r\n    memories.forEach((memory) => {\r\n      const weight = memory.access_count + 1;\r\n      totalWeight += weight;\r\n      weightedConfidence += memory.confidence * weight;\r\n\r\n      // Merge values (simple implementation)\r\n      if (typeof memory.value === 'object') {\r\n        Object.assign(mergedValue, memory.value);\r\n      }\r\n    });\r\n\r\n    return {\r\n      value: mergedValue,\r\n      confidence: weightedConfidence / totalWeight,\r\n      sourceCount: memories.length,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Garbage collection\r\n   */\r\n  _garbageCollect() {\r\n    try {\r\n      const now = Date.now();\r\n      let deletedCount = 0;\r\n\r\n      // Delete expired memories based on TTL\r\n      Object.entries(MEMORY_TYPES).forEach(([type, config]) => {\r\n        if (config.ttl) {\r\n          const result = this.db\r\n            .prepare(\r\n              `\r\n            DELETE FROM collective_memory\r\n            WHERE swarm_id = ?\r\n            AND type = ?\r\n            AND (julianday('now') - julianday(accessed_at)) * 86400000 > ?\r\n          `,\r\n            )\r\n            .run(this.config.swarmId, type, config.ttl);\r\n\r\n          deletedCount += result.changes;\r\n        }\r\n      });\r\n\r\n      // Clear old cache entries\r\n      const cacheTimeout = 300000; // 5 minutes\r\n      this.cache.forEach((value, key) => {\r\n        if (now - value.timestamp > cacheTimeout) {\r\n          this.cache.delete(key);\r\n        }\r\n      });\r\n\r\n      // Update statistics\r\n      this._updateStatistics();\r\n\r\n      this.state.lastGC = now;\r\n\r\n      if (deletedCount > 0) {\r\n        this.emit('memory:gc', { deleted: deletedCount, cacheSize: this.cache.size });\r\n      }\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check memory limits and evict if necessary\r\n   */\r\n  _checkMemoryLimits() {\r\n    if (this.state.totalSize > this.config.maxSize * 1024 * 1024) {\r\n      // Evict least recently used memories\r\n      const toEvict = this.db\r\n        .prepare(\r\n          `\r\n        SELECT id, size FROM collective_memory\r\n        WHERE swarm_id = ?\r\n        AND type NOT IN ('system', 'consensus')\r\n        ORDER BY accessed_at ASC, access_count ASC\r\n        LIMIT 100\r\n      `,\r\n        )\r\n        .all(this.config.swarmId);\r\n\r\n      let freedSize = 0;\r\n      toEvict.forEach((memory) => {\r\n        this.db.prepare('DELETE FROM collective_memory WHERE id = ?').run(memory.id);\r\n        freedSize += memory.size;\r\n      });\r\n\r\n      this.emit('memory:evicted', { count: toEvict.length, freedSize });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Optimize database performance\r\n   */\r\n  _optimizeDatabase() {\r\n    try {\r\n      // Run database optimization\r\n      this.db.pragma('optimize');\r\n      this.db.pragma('analysis_limit=1000');\r\n      this.db.exec('ANALYZE');\r\n\r\n      // Update database statistics\r\n      this._updateStatistics();\r\n\r\n      this.emit('database:optimized');\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Optimize cache performance\r\n   */\r\n  _optimizeCache() {\r\n    try {\r\n      const now = Date.now();\r\n      const cacheTimeout = 300000; // 5 minutes\r\n\r\n      // Clear expired cache entries\r\n      if (this.cache.cache) {\r\n        this.cache.cache.forEach((value, key) => {\r\n          if (now - value.timestamp > cacheTimeout) {\r\n            this.cache.cache.delete(key);\r\n          }\r\n        });\r\n      }\r\n\r\n      this.emit('cache:optimized', {\r\n        size: this.cache.cache ? this.cache.cache.size : 0,\r\n      });\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update performance metrics\r\n   */\r\n  _updatePerformanceMetrics() {\r\n    try {\r\n      // Calculate cache hit rate\r\n      const cacheStats = this.cache.getStats();\r\n      this.state.performanceMetrics.cacheHitRate = cacheStats.hitRate || 0;\r\n\r\n      // Calculate memory efficiency\r\n      this.state.performanceMetrics.memoryEfficiency =\r\n        (this.state.totalSize / (this.config.maxSize * 1024 * 1024)) * 100;\r\n\r\n      // Update average query time if we have recent measurements\r\n      if (this.state.performanceMetrics.queryTimes.length > 0) {\r\n        this.state.performanceMetrics.avgQueryTime =\r\n          this.state.performanceMetrics.queryTimes.reduce((sum, time) => sum + time, 0) /\r\n          this.state.performanceMetrics.queryTimes.length;\r\n\r\n        // Keep only recent query times (last 100)\r\n        if (this.state.performanceMetrics.queryTimes.length > 100) {\r\n          this.state.performanceMetrics.queryTimes =\r\n            this.state.performanceMetrics.queryTimes.slice(-100);\r\n        }\r\n      }\r\n\r\n      this.emit('metrics:updated', this.state.performanceMetrics);\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update memory statistics\r\n   */\r\n  _updateStatistics() {\r\n    const stats = this.db\r\n      .prepare(\r\n        `\r\n      SELECT \r\n        COUNT(*) as count,\r\n        SUM(size) as totalSize,\r\n        AVG(confidence) as avgConfidence,\r\n        SUM(compressed) as compressedCount\r\n      FROM collective_memory\r\n      WHERE swarm_id = ?\r\n    `,\r\n      )\r\n      .get(this.config.swarmId);\r\n\r\n    this.state.entryCount = stats.count || 0;\r\n    this.state.totalSize = stats.totalSize || 0;\r\n    this.state.avgConfidence = stats.avgConfidence || 1.0;\r\n\r\n    if (stats.compressedCount > 0) {\r\n      // Estimate compression ratio\r\n      this.state.compressionRatio = 0.6; // Assume 40% compression\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Track access patterns\r\n   */\r\n  _trackAccess(key, operation) {\r\n    const pattern = this.state.accessPatterns.get(key) || {\r\n      reads: 0,\r\n      writes: 0,\r\n      searches: 0,\r\n      cacheHits: 0,\r\n      misses: 0,\r\n      lastAccess: Date.now(),\r\n    };\r\n\r\n    switch (operation) {\r\n      case 'read':\r\n        pattern.reads++;\r\n        break;\r\n      case 'write':\r\n        pattern.writes++;\r\n        break;\r\n      case 'search':\r\n        pattern.searches++;\r\n        break;\r\n      case 'cache_hit':\r\n        pattern.cacheHits++;\r\n        break;\r\n      case 'miss':\r\n        pattern.misses++;\r\n        break;\r\n    }\r\n\r\n    pattern.lastAccess = Date.now();\r\n    this.state.accessPatterns.set(key, pattern);\r\n\r\n    // Keep access patterns size limited\r\n    if (this.state.accessPatterns.size > 1000) {\r\n      // Remove oldest entries\r\n      const sorted = Array.from(this.state.accessPatterns.entries()).sort(\r\n        (a, b) => a[1].lastAccess - b[1].lastAccess,\r\n      );\r\n\r\n      sorted.slice(0, 100).forEach(([key]) => {\r\n        this.state.accessPatterns.delete(key);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get enhanced memory statistics\r\n   */\r\n  getStatistics() {\r\n    return {\r\n      swarmId: this.config.swarmId,\r\n      entryCount: this.state.entryCount,\r\n      totalSize: this.state.totalSize,\r\n      maxSize: this.config.maxSize * 1024 * 1024,\r\n      utilizationPercent: (this.state.totalSize / (this.config.maxSize * 1024 * 1024)) * 100,\r\n      avgConfidence: this.state.avgConfidence,\r\n      compressionRatio: this.state.compressionRatio,\r\n      cacheSize: this.cache.cache ? this.cache.cache.size : 0,\r\n      lastGC: new Date(this.state.lastGC).toISOString(),\r\n      accessPatterns: this.state.accessPatterns.size,\r\n      optimization: {\r\n        cacheOptimized: true,\r\n        poolingEnabled: this.config.enablePooling,\r\n        asyncOperations: this.config.enableAsyncOperations,\r\n        compressionRatio: this.state.compressionRatio,\r\n        performanceMetrics: this.state.performanceMetrics,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Export memory snapshot\r\n   */\r\n  async exportSnapshot(filepath) {\r\n    try {\r\n      const memories = this.db\r\n        .prepare(\r\n          `\r\n        SELECT * FROM collective_memory\r\n        WHERE swarm_id = ?\r\n        ORDER BY created_at DESC\r\n      `,\r\n        )\r\n        .all(this.config.swarmId);\r\n\r\n      const snapshot = {\r\n        swarmId: this.config.swarmId,\r\n        timestamp: new Date().toISOString(),\r\n        statistics: this.getStatistics(),\r\n        memories: memories.map((m) => ({\r\n          ...m,\r\n          value: JSON.parse(m.value),\r\n        })),\r\n      };\r\n\r\n      // In production, write to file\r\n      // For now, return the snapshot\r\n      this.emit('memory:exported', { count: memories.length });\r\n\r\n      return snapshot;\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Import memory snapshot\r\n   */\r\n  async importSnapshot(snapshot) {\r\n    try {\r\n      let imported = 0;\r\n\r\n      for (const memory of snapshot.memories) {\r\n        await this.store(memory.key, memory.value, memory.type, {\r\n          confidence: memory.confidence,\r\n          createdBy: memory.created_by,\r\n        });\r\n        imported++;\r\n      }\r\n\r\n      this.emit('memory:imported', { count: imported });\r\n\r\n      return { imported };\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enhanced shutdown with cleanup\r\n   */\r\n  close() {\r\n    // Clear all timers\r\n    if (this.gcTimer) clearInterval(this.gcTimer);\r\n    if (this.optimizeTimer) clearInterval(this.optimizeTimer);\r\n    if (this.cacheTimer) clearInterval(this.cacheTimer);\r\n    if (this.metricsTimer) clearInterval(this.metricsTimer);\r\n\r\n    // Final optimization before closing\r\n    try {\r\n      this.db.pragma('optimize');\r\n    } catch (error) {\r\n      // Ignore errors during shutdown\r\n    }\r\n\r\n    // Close database\r\n    if (this.db) {\r\n      this.db.close();\r\n    }\r\n\r\n    // Clear memory pools\r\n    if (this.config.enablePooling) {\r\n      Object.values(this.pools).forEach((pool) => {\r\n        pool.pool.length = 0;\r\n      });\r\n    }\r\n\r\n    const finalStats = {\r\n      cacheStats: this.cache.getStats ? this.cache.getStats() : {},\r\n      poolStats: this.config.enablePooling\r\n        ? {\r\n            queryResults: this.pools.queryResults.getStats(),\r\n            memoryEntries: this.pools.memoryEntries.getStats(),\r\n          }\r\n        : null,\r\n      performanceMetrics: this.state.performanceMetrics,\r\n    };\r\n\r\n    this.emit('memory:closed', finalStats);\r\n  }\r\n\r\n  /**\r\n   * Get comprehensive memory analytics\r\n   */\r\n  getAnalytics() {\r\n    return {\r\n      basic: this.getStatistics(),\r\n      performance: this.state.performanceMetrics,\r\n      cache: this.cache.getStats ? this.cache.getStats() : {},\r\n      pools: this.config.enablePooling\r\n        ? {\r\n            queryResults: this.pools.queryResults.getStats(),\r\n            memoryEntries: this.pools.memoryEntries.getStats(),\r\n          }\r\n        : null,\r\n      database: {\r\n        fragmentation: this.db.pragma('freelist_count'),\r\n        pageSize: this.db.pragma('page_size'),\r\n        cacheSize: this.db.pragma('cache_size'),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Memory health check\r\n   */\r\n  async healthCheck() {\r\n    const analytics = this.getAnalytics();\r\n    const health = {\r\n      status: 'healthy',\r\n      issues: [],\r\n      recommendations: [],\r\n    };\r\n\r\n    // Check cache hit rate\r\n    if (analytics.cache.hitRate < 50) {\r\n      health.issues.push('Low cache hit rate');\r\n      health.recommendations.push('Consider increasing cache size');\r\n    }\r\n\r\n    // Check memory usage\r\n    if (analytics.basic.utilizationPercent > 90) {\r\n      health.status = 'warning';\r\n      health.issues.push('High memory utilization');\r\n      health.recommendations.push('Consider increasing max memory or running garbage collection');\r\n    }\r\n\r\n    // Check query performance\r\n    if (analytics.performance.avgQueryTime > 100) {\r\n      health.issues.push('Slow query performance');\r\n      health.recommendations.push('Consider database optimization or indexing');\r\n    }\r\n\r\n    return health;\r\n  }\r\n}\r\n\r\n/**\r\n * Memory optimization utilities\r\n */\r\nexport class MemoryOptimizer {\r\n  static async optimizeCollectiveMemory(memory) {\r\n    const startTime = performance.now();\r\n\r\n    // Run comprehensive optimization\r\n    await memory._optimizeDatabase();\r\n    memory._optimizeCache();\r\n    memory._garbageCollect();\r\n\r\n    const duration = performance.now() - startTime;\r\n\r\n    return {\r\n      duration,\r\n      analytics: memory.getAnalytics(),\r\n      health: await memory.healthCheck(),\r\n    };\r\n  }\r\n\r\n  static calculateOptimalCacheSize(memoryStats, accessPatterns) {\r\n    const avgEntrySize = memoryStats.totalSize / memoryStats.entryCount;\r\n    const hotKeys = Array.from(accessPatterns.entries())\r\n      .sort((a, b) => b[1] - a[1])\r\n      .slice(0, Math.min(1000, memoryStats.entryCount * 0.2));\r\n\r\n    const optimalCacheEntries = hotKeys.length * 1.2; // 20% buffer\r\n    const optimalCacheMemoryMB = (optimalCacheEntries * avgEntrySize) / (1024 * 1024);\r\n\r\n    return {\r\n      entries: Math.ceil(optimalCacheEntries),\r\n      memoryMB: Math.ceil(optimalCacheMemoryMB),\r\n      efficiency: (hotKeys.length / memoryStats.entryCount) * 100,\r\n    };\r\n  }\r\n\r\n  static generateOptimizationReport(analytics) {\r\n    const report = {\r\n      timestamp: new Date().toISOString(),\r\n      summary: {},\r\n      recommendations: [],\r\n      metrics: analytics,\r\n    };\r\n\r\n    // Performance summary\r\n    report.summary.avgQueryTime = analytics.performance.avgQueryTime;\r\n    report.summary.cacheHitRate = analytics.cache.hitRate || 0;\r\n    report.summary.memoryEfficiency = analytics.cache.memoryUsage / (1024 * 1024);\r\n\r\n    // Generate recommendations\r\n    if ((analytics.cache.hitRate || 0) < 70) {\r\n      report.recommendations.push({\r\n        type: 'cache',\r\n        priority: 'high',\r\n        description: 'Increase cache size to improve hit rate',\r\n        impact: 'Reduce database queries by up to 30%',\r\n      });\r\n    }\r\n\r\n    if (analytics.performance.avgQueryTime > 50) {\r\n      report.recommendations.push({\r\n        type: 'database',\r\n        priority: 'medium',\r\n        description: 'Optimize database indexes and run ANALYZE',\r\n        impact: 'Improve query performance by 20-40%',\r\n      });\r\n    }\r\n\r\n    if (analytics.pools?.queryResults?.reuseRate < 50) {\r\n      report.recommendations.push({\r\n        type: 'pooling',\r\n        priority: 'low',\r\n        description: 'Increase object pool sizes for better reuse',\r\n        impact: 'Reduce garbage collection pressure',\r\n      });\r\n    }\r\n\r\n    return report;\r\n  }\r\n}\r\n"],"names":["EventEmitter","Database","path","performance","MEMORY_TYPES","knowledge","priority","ttl","compress","context","task","result","error","metric","consensus","system","MemoryPool","createFn","resetFn","maxSize","pool","allocated","reused","acquire","length","pop","release","obj","push","getStats","poolSize","reuseRate","OptimizedLRUCache","maxMemoryMB","maxMemory","cache","Map","currentMemory","hits","misses","evictions","get","key","has","value","delete","set","data","size","_estimateSize","_evictByMemoryPressure","_evictLRU","entry","timestamp","Date","now","JSON","stringify","firstKey","keys","next","neededSize","forEach","callback","memoryUsage","hitRate","CollectiveMemory","config","db","swarmId","dbPath","join","process","cwd","compressionThreshold","gcInterval","cacheSize","cacheMemoryMB","enablePooling","enableAsyncOperations","state","totalSize","entryCount","compressionRatio","lastGC","accessPatterns","performanceMetrics","queryTimes","avgQueryTime","cacheHitRate","memoryEfficiency","gcTimer","pools","queryResults","results","metadata","Object","k","memoryEntries","id","statements","backgroundWorker","_initialize","pragma","exec","_prepareStatements","_updateStatistics","_startOptimizationTimers","_initializeBackgroundWorker","emit","optimizations","pooling","asyncOps","prepare","setInterval","_garbageCollect","optimizeTimer","_optimizeDatabase","cacheTimer","_optimizeCache","metricsTimer","_updatePerformanceMetrics","backgroundQueue","backgroundProcessing","store","type","serialized","Buffer","byteLength","shouldCompress","storedValue","compressed","existing","run","confidence","createdBy","_checkMemoryLimits","_trackAccess","success","retrieve","cached","parsed","parse","search","pattern","options","limit","minConfidence","query","params","all","getRelated","original","associate","key1","key2","strength","from","to","created","consolidate","memories","consolidated","memory","category","_categorizeMemory","mergeCount","group","merged","_mergeMemories","categories","sort","substring","totalWeight","weightedConfidence","mergedValue","weight","access_count","assign","sourceCount","deletedCount","entries","changes","cacheTimeout","deleted","toEvict","freedSize","count","cacheStats","reduce","sum","time","slice","stats","avgConfidence","compressedCount","operation","reads","writes","searches","cacheHits","lastAccess","sorted","Array","a","b","getStatistics","utilizationPercent","toISOString","optimization","cacheOptimized","poolingEnabled","asyncOperations","exportSnapshot","filepath","snapshot","statistics","map","m","importSnapshot","imported","created_by","close","clearInterval","values","finalStats","poolStats","getAnalytics","basic","database","fragmentation","pageSize","healthCheck","analytics","health","status","issues","recommendations","MemoryOptimizer","optimizeCollectiveMemory","startTime","duration","calculateOptimalCacheSize","memoryStats","avgEntrySize","hotKeys","Math","min","optimalCacheEntries","optimalCacheMemoryMB","ceil","memoryMB","efficiency","generateOptimizationReport","report","summary","metrics","description","impact"],"mappings":"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"}
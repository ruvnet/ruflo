{"version":3,"sources":["../../../../../src/mcp/tools/system/search.ts"],"sourcesContent":["/**\r\n * Tool Search Capability (tools/search)\r\n *\r\n * Implements progressive disclosure pattern with tiered detail levels:\r\n * - names-only: Just tool names (minimal tokens)\r\n * - basic: Name + description + category\r\n * - full: Complete schemas with examples\r\n *\r\n * This is the key to achieving 98.7% token reduction.\r\n */\r\n\r\nimport type { MCPTool, ClaudeFlowToolContext } from '../../types.js';\r\nimport type { ILogger } from '../../../interfaces/logger.js';\r\nimport type { DynamicToolLoader, ToolMetadata } from '../loader.js';\r\n\r\ninterface SearchToolsInput {\r\n  query?: string;\r\n  category?: string;\r\n  tags?: string[];\r\n  detailLevel?: 'names-only' | 'basic' | 'full';\r\n  limit?: number;\r\n}\r\n\r\ninterface ToolSearchResult {\r\n  name: string;\r\n  description?: string;\r\n  category?: string;\r\n  tags?: string[];\r\n  inputSchema?: any;\r\n  examples?: any[];\r\n}\r\n\r\ninterface SearchToolsResult {\r\n  success: boolean;\r\n  tools: ToolSearchResult[];\r\n  totalMatches: number;\r\n  detailLevel: string;\r\n  tokenSavings?: {\r\n    estimatedFullSize: number;\r\n    actualSize: number;\r\n    reductionPercent: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Create tool search capability\r\n *\r\n * @param loader - Dynamic tool loader instance\r\n * @param logger - Logger instance\r\n * @returns MCPTool definition\r\n */\r\nexport function createSearchToolsTool(\r\n  loader: DynamicToolLoader,\r\n  logger: ILogger\r\n): MCPTool {\r\n  return {\r\n    name: 'tools/search',\r\n    description: 'Search for tools with configurable detail levels. Use names-only for quick discovery (saves 98%+ tokens), basic for descriptions, full for complete schemas. This is the primary tool discovery mechanism.',\r\n\r\n    inputSchema: {\r\n      type: 'object',\r\n      properties: {\r\n        query: {\r\n          type: 'string',\r\n          description: 'Search query (searches tool names and descriptions)',\r\n        },\r\n        category: {\r\n          type: 'string',\r\n          description: 'Filter by category',\r\n          enum: [\r\n            'agents',\r\n            'tasks',\r\n            'memory',\r\n            'system',\r\n            'config',\r\n            'workflow',\r\n            'terminal',\r\n            'query',\r\n            'swarm',\r\n            'data',\r\n            'jobs',\r\n          ],\r\n        },\r\n        tags: {\r\n          type: 'array',\r\n          items: { type: 'string' },\r\n          description: 'Filter by tags (all tags must match)',\r\n        },\r\n        detailLevel: {\r\n          type: 'string',\r\n          enum: ['names-only', 'basic', 'full'],\r\n          description: 'Level of detail to return. names-only: just names (fastest, minimal tokens). basic: name + description + category (recommended for discovery). full: complete schemas with examples (use only when needed)',\r\n          default: 'basic',\r\n        },\r\n        limit: {\r\n          type: 'number',\r\n          description: 'Maximum number of results (default: 20)',\r\n          minimum: 1,\r\n          maximum: 100,\r\n          default: 20,\r\n        },\r\n      },\r\n      required: [],\r\n    },\r\n\r\n    metadata: {\r\n      category: 'system',\r\n      tags: ['discovery', 'search', 'progressive-disclosure', 'tools'],\r\n      examples: [\r\n        {\r\n          description: 'Quick search for agent-related tools (minimal tokens)',\r\n          input: {\r\n            query: 'agent',\r\n            detailLevel: 'names-only',\r\n            limit: 10,\r\n          },\r\n          expectedOutput: {\r\n            tools: [\r\n              { name: 'agents/spawn' },\r\n              { name: 'agents/list' },\r\n              { name: 'agents/terminate' },\r\n            ],\r\n            totalMatches: 5,\r\n            detailLevel: 'names-only',\r\n          },\r\n        },\r\n        {\r\n          description: 'Get basic info about system tools',\r\n          input: {\r\n            category: 'system',\r\n            detailLevel: 'basic',\r\n          },\r\n          expectedOutput: {\r\n            tools: [\r\n              {\r\n                name: 'system/status',\r\n                description: 'Get system health status',\r\n                category: 'system',\r\n              },\r\n            ],\r\n            totalMatches: 3,\r\n            detailLevel: 'basic',\r\n          },\r\n        },\r\n        {\r\n          description: 'Get full schema for specific tool',\r\n          input: {\r\n            query: 'agents/spawn',\r\n            detailLevel: 'full',\r\n            limit: 1,\r\n          },\r\n          expectedOutput: {\r\n            tools: [\r\n              {\r\n                name: 'agents/spawn',\r\n                description: 'Spawn a new agent',\r\n                category: 'agents',\r\n                inputSchema: { type: 'object', properties: {} },\r\n                examples: [],\r\n              },\r\n            ],\r\n            totalMatches: 1,\r\n            detailLevel: 'full',\r\n          },\r\n        },\r\n      ],\r\n      detailLevel: 'standard',\r\n    },\r\n\r\n    handler: async (\r\n      input: any,\r\n      context?: ClaudeFlowToolContext\r\n    ): Promise<SearchToolsResult> => {\r\n      const validatedInput = input as SearchToolsInput;\r\n      const detailLevel = validatedInput.detailLevel || 'basic';\r\n      const limit = validatedInput.limit || 20;\r\n\r\n      logger.info('tools/search invoked', {\r\n        query: validatedInput.query,\r\n        category: validatedInput.category,\r\n        detailLevel,\r\n        limit,\r\n      });\r\n\r\n      try {\r\n        // Search tool metadata (lightweight operation)\r\n        const metadata = loader.searchTools({\r\n          category: validatedInput.category,\r\n          tags: validatedInput.tags,\r\n          namePattern: validatedInput.query,\r\n        });\r\n\r\n        logger.debug('Tool search results', {\r\n          totalMatches: metadata.length,\r\n          detailLevel,\r\n        });\r\n\r\n        // Process results based on detail level\r\n        const results: ToolSearchResult[] = [];\r\n        const limitedMetadata = metadata.slice(0, limit);\r\n\r\n        for (const meta of limitedMetadata) {\r\n          if (detailLevel === 'names-only') {\r\n            // Minimal: Just name (saves most tokens)\r\n            results.push({ name: meta.name });\r\n          } else if (detailLevel === 'basic') {\r\n            // Basic: Name + description + category + tags\r\n            results.push({\r\n              name: meta.name,\r\n              description: meta.description,\r\n              category: meta.category,\r\n              tags: meta.tags,\r\n            });\r\n          } else if (detailLevel === 'full') {\r\n            // Full: Load complete tool definition including schema\r\n            const tool = await loader.loadTool(meta.name, logger);\r\n            if (tool) {\r\n              results.push({\r\n                name: tool.name,\r\n                description: tool.description,\r\n                category: meta.category,\r\n                tags: meta.tags,\r\n                inputSchema: tool.inputSchema,\r\n                examples: tool.metadata?.examples || [],\r\n              });\r\n            }\r\n          }\r\n        }\r\n\r\n        // Calculate token savings for demonstration\r\n        const actualSize = JSON.stringify(results).length;\r\n        const estimatedFullSize = limitedMetadata.length * 2000; // Estimate 2KB per full tool\r\n        const reductionPercent = detailLevel === 'full'\r\n          ? 0\r\n          : ((estimatedFullSize - actualSize) / estimatedFullSize) * 100;\r\n\r\n        logger.info('tools/search completed successfully', {\r\n          resultsCount: results.length,\r\n          totalMatches: metadata.length,\r\n          detailLevel,\r\n          actualSizeBytes: actualSize,\r\n          reductionPercent: reductionPercent.toFixed(2),\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          tools: results,\r\n          totalMatches: metadata.length,\r\n          detailLevel,\r\n          tokenSavings:\r\n            detailLevel !== 'full'\r\n              ? {\r\n                  estimatedFullSize,\r\n                  actualSize,\r\n                  reductionPercent: Math.round(reductionPercent * 100) / 100,\r\n                }\r\n              : undefined,\r\n        };\r\n      } catch (error) {\r\n        logger.error('tools/search failed', {\r\n          error,\r\n          input: validatedInput,\r\n        });\r\n        throw error;\r\n      }\r\n    },\r\n  };\r\n}\r\n\r\nexport const toolMetadata = {\r\n  name: 'tools/search',\r\n  description: 'Search and discover tools with progressive disclosure',\r\n  category: 'system',\r\n  detailLevel: 'standard' as const,\r\n  tags: ['discovery', 'search', 'tools'],\r\n};\r\n"],"names":["createSearchToolsTool","loader","logger","name","description","inputSchema","type","properties","query","category","enum","tags","items","detailLevel","default","limit","minimum","maximum","required","metadata","examples","input","expectedOutput","tools","totalMatches","handler","context","validatedInput","info","searchTools","namePattern","debug","length","results","limitedMetadata","slice","meta","push","tool","loadTool","actualSize","JSON","stringify","estimatedFullSize","reductionPercent","resultsCount","actualSizeBytes","toFixed","success","tokenSavings","Math","round","undefined","error","toolMetadata"],"mappings":"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"}
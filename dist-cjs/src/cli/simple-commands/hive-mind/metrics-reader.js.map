{"version":3,"sources":["../../../../../src/cli/simple-commands/hive-mind/metrics-reader.js"],"sourcesContent":["/**\r\n * HiveMind Metrics Reader\r\n * Reads real metrics from the database instead of returning mock data\r\n */\r\n\r\nimport Database from 'better-sqlite3';\r\nimport { existsSync } from 'fs';\r\nimport path from 'path';\r\nimport { cwd } from '../../node-compat.js';\r\n\r\nexport class HiveMindMetricsReader {\r\n  constructor(dbPath = null) {\r\n    this.dbPath = dbPath || path.join(cwd(), '.hive-mind', 'hive.db');\r\n    this.db = null;\r\n  }\r\n\r\n  /**\r\n   * Initialize database connection\r\n   */\r\n  init() {\r\n    if (existsSync(this.dbPath)) {\r\n      this.db = new Database(this.dbPath, { readonly: true });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Close database connection\r\n   */\r\n  close() {\r\n    if (this.db) {\r\n      this.db.close();\r\n      this.db = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get swarm metrics with real data\r\n   */\r\n  getSwarmMetrics(swarmId) {\r\n    if (!this.db) {\r\n      this.init();\r\n    }\r\n\r\n    if (!this.db) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      // Get swarm details\r\n      const swarm = this.db.prepare('SELECT * FROM swarms WHERE id = ?').get(swarmId);\r\n      \r\n      if (!swarm) {\r\n        return null;\r\n      }\r\n\r\n      // Get real agent count\r\n      const agentCount = this.db\r\n        .prepare('SELECT COUNT(*) as count FROM agents WHERE swarm_id = ?')\r\n        .get(swarmId).count;\r\n\r\n      // Get real task metrics\r\n      const taskMetrics = this.db\r\n        .prepare(`\r\n          SELECT \r\n            COUNT(*) as total,\r\n            SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,\r\n            SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress,\r\n            SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,\r\n            SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed\r\n          FROM tasks\r\n          WHERE swarm_id = ?\r\n        `)\r\n        .get(swarmId);\r\n\r\n      // Get memory entries count\r\n      const memoryCount = this.db\r\n        .prepare('SELECT COUNT(*) as count FROM collective_memory WHERE swarm_id = ?')\r\n        .get(swarmId).count;\r\n\r\n      // Get consensus decisions count\r\n      const consensusCount = this.db\r\n        .prepare('SELECT COUNT(*) as count FROM consensus_decisions WHERE swarm_id = ?')\r\n        .get(swarmId).count;\r\n\r\n      // Get active agent details\r\n      const agents = this.db\r\n        .prepare('SELECT * FROM agents WHERE swarm_id = ? ORDER BY role DESC, created_at ASC')\r\n        .all(swarmId);\r\n\r\n      return {\r\n        ...swarm,\r\n        agent_count: agentCount,\r\n        agents: agents,\r\n        task_metrics: taskMetrics,\r\n        memory_count: memoryCount,\r\n        consensus_count: consensusCount,\r\n        completion_percentage: taskMetrics.total > 0 \r\n          ? Math.round((taskMetrics.completed / taskMetrics.total) * 100)\r\n          : 0\r\n      };\r\n    } catch (error) {\r\n      console.error('Error reading swarm metrics:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get session metrics with real data\r\n   */\r\n  getSessionMetrics(sessionId) {\r\n    if (!this.db) {\r\n      this.init();\r\n    }\r\n\r\n    if (!this.db) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      // Get session details\r\n      const session = this.db.prepare('SELECT * FROM sessions WHERE id = ?').get(sessionId);\r\n      \r\n      if (!session) {\r\n        return null;\r\n      }\r\n\r\n      // Get real agent count for this session's swarm\r\n      const agentCount = this.db\r\n        .prepare('SELECT COUNT(*) as count FROM agents WHERE swarm_id = ?')\r\n        .get(session.swarm_id).count;\r\n\r\n      // Get real task metrics for this session's swarm\r\n      const taskMetrics = this.db\r\n        .prepare(`\r\n          SELECT \r\n            COUNT(*) as total,\r\n            SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,\r\n            SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress,\r\n            SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending\r\n          FROM tasks\r\n          WHERE swarm_id = ?\r\n        `)\r\n        .get(session.swarm_id);\r\n\r\n      // Calculate real completion percentage\r\n      const completionPercentage = taskMetrics.total > 0\r\n        ? Math.round((taskMetrics.completed / taskMetrics.total) * 100)\r\n        : session.completion_percentage || 0;\r\n\r\n      return {\r\n        ...session,\r\n        agent_count: agentCount,\r\n        task_count: taskMetrics.total,\r\n        completed_tasks: taskMetrics.completed,\r\n        pending_tasks: taskMetrics.pending,\r\n        in_progress_tasks: taskMetrics.in_progress,\r\n        completion_percentage: completionPercentage\r\n      };\r\n    } catch (error) {\r\n      console.error('Error reading session metrics:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all active sessions with real metrics\r\n   */\r\n  getActiveSessions() {\r\n    if (!this.db) {\r\n      this.init();\r\n    }\r\n\r\n    if (!this.db) {\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      // Get all active or paused sessions\r\n      const sessions = this.db\r\n        .prepare(`\r\n          SELECT * FROM sessions \r\n          WHERE status = 'active' OR status = 'paused'\r\n          ORDER BY updated_at DESC\r\n        `)\r\n        .all();\r\n\r\n      // Enrich each session with real metrics\r\n      return sessions.map(session => {\r\n        const metrics = this.getSessionMetrics(session.id);\r\n        return metrics || session;\r\n      });\r\n    } catch (error) {\r\n      console.error('Error reading active sessions:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all active swarms with real metrics\r\n   */\r\n  getActiveSwarms() {\r\n    if (!this.db) {\r\n      this.init();\r\n    }\r\n\r\n    if (!this.db) {\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      // Get all active swarms\r\n      const swarms = this.db\r\n        .prepare(`\r\n          SELECT * FROM swarms \r\n          WHERE status = 'active'\r\n          ORDER BY created_at DESC\r\n        `)\r\n        .all();\r\n\r\n      // Enrich each swarm with real metrics\r\n      return swarms.map(swarm => {\r\n        const metrics = this.getSwarmMetrics(swarm.id);\r\n        return metrics || swarm;\r\n      });\r\n    } catch (error) {\r\n      console.error('Error reading active swarms:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get performance metrics\r\n   */\r\n  getPerformanceMetrics() {\r\n    if (!this.db) {\r\n      this.init();\r\n    }\r\n\r\n    if (!this.db) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      // Get overall task metrics\r\n      const overallTasks = this.db\r\n        .prepare(`\r\n          SELECT \r\n            COUNT(*) as total,\r\n            SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,\r\n            AVG(CASE WHEN status = 'completed' AND completion_time IS NOT NULL \r\n                THEN (julianday(completion_time) - julianday(created_at)) * 24 * 60 \r\n                ELSE NULL END) as avg_completion_minutes\r\n          FROM tasks\r\n        `)\r\n        .get();\r\n\r\n      // Get agent performance\r\n      const agentPerformance = this.db\r\n        .prepare(`\r\n          SELECT \r\n            a.type,\r\n            COUNT(DISTINCT a.id) as agent_count,\r\n            COUNT(t.id) as tasks_assigned,\r\n            SUM(CASE WHEN t.status = 'completed' THEN 1 ELSE 0 END) as tasks_completed\r\n          FROM agents a\r\n          LEFT JOIN tasks t ON a.id = t.agent_id\r\n          GROUP BY a.type\r\n          ORDER BY tasks_completed DESC\r\n        `)\r\n        .all();\r\n\r\n      // Get swarm performance\r\n      const swarmPerformance = this.db\r\n        .prepare(`\r\n          SELECT \r\n            s.name,\r\n            s.objective,\r\n            COUNT(DISTINCT a.id) as agent_count,\r\n            COUNT(DISTINCT t.id) as task_count,\r\n            SUM(CASE WHEN t.status = 'completed' THEN 1 ELSE 0 END) as completed_count\r\n          FROM swarms s\r\n          LEFT JOIN agents a ON s.id = a.swarm_id\r\n          LEFT JOIN tasks t ON s.id = t.swarm_id\r\n          WHERE s.status = 'active'\r\n          GROUP BY s.id\r\n          ORDER BY s.created_at DESC\r\n          LIMIT 5\r\n        `)\r\n        .all();\r\n\r\n      return {\r\n        overall_tasks: overallTasks,\r\n        agent_performance: agentPerformance,\r\n        swarm_performance: swarmPerformance,\r\n        success_rate: overallTasks.total > 0 \r\n          ? (overallTasks.completed / overallTasks.total * 100).toFixed(1)\r\n          : 0\r\n      };\r\n    } catch (error) {\r\n      console.error('Error reading performance metrics:', error);\r\n      return null;\r\n    }\r\n  }\r\n}"],"names":["Database","existsSync","path","cwd","HiveMindMetricsReader","dbPath","join","db","init","readonly","close","getSwarmMetrics","swarmId","swarm","prepare","get","agentCount","count","taskMetrics","memoryCount","consensusCount","agents","all","agent_count","task_metrics","memory_count","consensus_count","completion_percentage","total","Math","round","completed","error","console","getSessionMetrics","sessionId","session","swarm_id","completionPercentage","task_count","completed_tasks","pending_tasks","pending","in_progress_tasks","in_progress","getActiveSessions","sessions","map","metrics","id","getActiveSwarms","swarms","getPerformanceMetrics","overallTasks","agentPerformance","swarmPerformance","overall_tasks","agent_performance","swarm_performance","success_rate","toFixed"],"mappings":"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"}
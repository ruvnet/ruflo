{"version":3,"sources":["../../../src/mcp/router.ts"],"sourcesContent":["/**\r\n * Request router for MCP\r\n */\r\n\r\nimport type { MCPRequest } from '../utils/types.js';\r\nimport type { ILogger } from '../core/logger.js';\r\nimport { MCPMethodNotFoundError } from '../utils/errors.js';\r\nimport type { ToolRegistry } from './tools.js';\r\n\r\n/**\r\n * Request router implementation\r\n */\r\nexport class RequestRouter {\r\n  private totalRequests = 0;\r\n  private successfulRequests = 0;\r\n  private failedRequests = 0;\r\n\r\n  constructor(\r\n    private toolRegistry: ToolRegistry,\r\n    private logger: ILogger,\r\n  ) {}\r\n\r\n  /**\r\n   * Routes a request to the appropriate handler\r\n   */\r\n  async route(request: MCPRequest): Promise<unknown> {\r\n    this.totalRequests++;\r\n\r\n    try {\r\n      // Parse method to determine handler\r\n      const { method, params } = request;\r\n\r\n      // Handle built-in methods\r\n      if (method.startsWith('rpc.')) {\r\n        return await this.handleRPCMethod(method, params);\r\n      }\r\n\r\n      // Handle tool invocations\r\n      if (method.startsWith('tools.')) {\r\n        return await this.handleToolMethod(method, params);\r\n      }\r\n\r\n      // Try to execute as a tool directly\r\n      const tool = this.toolRegistry.getTool(method);\r\n      if (tool) {\r\n        const result = await this.toolRegistry.executeTool(method, params);\r\n        this.successfulRequests++;\r\n        return result;\r\n      }\r\n\r\n      // Method not found\r\n      throw new MCPMethodNotFoundError(method);\r\n    } catch (error) {\r\n      this.failedRequests++;\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets router metrics\r\n   */\r\n  getMetrics(): {\r\n    totalRequests: number;\r\n    successfulRequests: number;\r\n    failedRequests: number;\r\n  } {\r\n    return {\r\n      totalRequests: this.totalRequests,\r\n      successfulRequests: this.successfulRequests,\r\n      failedRequests: this.failedRequests,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handles built-in RPC methods\r\n   */\r\n  private async handleRPCMethod(method: string, params: unknown): Promise<unknown> {\r\n    switch (method) {\r\n      case 'rpc.discover':\r\n        return this.discoverMethods();\r\n\r\n      case 'rpc.ping':\r\n        return { pong: true };\r\n\r\n      case 'rpc.describe':\r\n        return this.describeMethod(params);\r\n\r\n      default:\r\n        throw new MCPMethodNotFoundError(method);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles tool-related methods\r\n   */\r\n  private async handleToolMethod(method: string, params: unknown): Promise<unknown> {\r\n    switch (method) {\r\n      case 'tools.list':\r\n        return this.toolRegistry.listTools();\r\n\r\n      case 'tools.invoke':\r\n        return await this.invokeTool(params);\r\n\r\n      case 'tools.describe':\r\n        return this.describeTool(params);\r\n\r\n      default:\r\n        throw new MCPMethodNotFoundError(method);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Discovers all available methods\r\n   */\r\n  private discoverMethods(): Record<string, string> {\r\n    const methods: Record<string, string> = {\r\n      'rpc.discover': 'Discover all available methods',\r\n      'rpc.ping': 'Ping the server',\r\n      'rpc.describe': 'Describe a specific method',\r\n      'tools.list': 'List all available tools',\r\n      'tools.invoke': 'Invoke a specific tool',\r\n      'tools.describe': 'Describe a specific tool',\r\n    };\r\n\r\n    // Add all registered tools\r\n    for (const tool of this.toolRegistry.listTools()) {\r\n      methods[tool.name] = tool.description;\r\n    }\r\n\r\n    return methods;\r\n  }\r\n\r\n  /**\r\n   * Describes a specific method\r\n   */\r\n  private describeMethod(params: unknown): unknown {\r\n    if (!params || typeof params !== 'object' || !('method' in params)) {\r\n      throw new Error('Invalid params: method required');\r\n    }\r\n\r\n    const { method } = params as { method: string };\r\n\r\n    // Check if it's a tool\r\n    const tool = this.toolRegistry.getTool(method);\r\n    if (tool) {\r\n      return {\r\n        name: tool.name,\r\n        description: tool.description,\r\n        inputSchema: tool.inputSchema,\r\n      };\r\n    }\r\n\r\n    // Check built-in methods\r\n    const builtInMethods: Record<string, unknown> = {\r\n      'rpc.discover': {\r\n        description: 'Discover all available methods',\r\n        inputSchema: { type: 'object', properties: {} },\r\n      },\r\n      'rpc.ping': {\r\n        description: 'Ping the server',\r\n        inputSchema: { type: 'object', properties: {} },\r\n      },\r\n      'rpc.describe': {\r\n        description: 'Describe a specific method',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            method: { type: 'string' },\r\n          },\r\n          required: ['method'],\r\n        },\r\n      },\r\n      'tools.list': {\r\n        description: 'List all available tools',\r\n        inputSchema: { type: 'object', properties: {} },\r\n      },\r\n      'tools.invoke': {\r\n        description: 'Invoke a specific tool',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            tool: { type: 'string' },\r\n            input: { type: 'object' },\r\n          },\r\n          required: ['tool', 'input'],\r\n        },\r\n      },\r\n      'tools.describe': {\r\n        description: 'Describe a specific tool',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            tool: { type: 'string' },\r\n          },\r\n          required: ['tool'],\r\n        },\r\n      },\r\n    };\r\n\r\n    if (method in builtInMethods) {\r\n      return builtInMethods[method];\r\n    }\r\n\r\n    throw new MCPMethodNotFoundError(method);\r\n  }\r\n\r\n  /**\r\n   * Invokes a tool\r\n   */\r\n  private async invokeTool(params: unknown): Promise<unknown> {\r\n    if (!params || typeof params !== 'object' || !('tool' in params)) {\r\n      throw new Error('Invalid params: tool required');\r\n    }\r\n\r\n    const { tool, input } = params as { tool: string; input?: unknown };\r\n    return await this.toolRegistry.executeTool(tool, input || {});\r\n  }\r\n\r\n  /**\r\n   * Describes a specific tool\r\n   */\r\n  private describeTool(params: unknown): unknown {\r\n    if (!params || typeof params !== 'object' || !('tool' in params)) {\r\n      throw new Error('Invalid params: tool required');\r\n    }\r\n\r\n    const { tool: toolName } = params as { tool: string };\r\n    const tool = this.toolRegistry.getTool(toolName);\r\n\r\n    if (!tool) {\r\n      throw new Error(`Tool not found: ${toolName}`);\r\n    }\r\n\r\n    return {\r\n      name: tool.name,\r\n      description: tool.description,\r\n      inputSchema: tool.inputSchema,\r\n    };\r\n  }\r\n}\r\n"],"names":["MCPMethodNotFoundError","RequestRouter","totalRequests","successfulRequests","failedRequests","toolRegistry","logger","route","request","method","params","startsWith","handleRPCMethod","handleToolMethod","tool","getTool","result","executeTool","error","getMetrics","discoverMethods","pong","describeMethod","listTools","invokeTool","describeTool","methods","name","description","Error","inputSchema","builtInMethods","type","properties","required","input","toolName"],"mappings":"AAMA,SAASA,sBAAsB,QAAQ,qBAAqB;AAM5D,OAAO,MAAMC;;;IACHC,gBAAgB,EAAE;IAClBC,qBAAqB,EAAE;IACvBC,iBAAiB,EAAE;IAE3B,YACE,AAAQC,YAA0B,EAClC,AAAQC,MAAe,CACvB;aAFQD,eAAAA;aACAC,SAAAA;IACP;IAKH,MAAMC,MAAMC,OAAmB,EAAoB;QACjD,IAAI,CAACN,aAAa;QAElB,IAAI;YAEF,MAAM,EAAEO,MAAM,EAAEC,MAAM,EAAE,GAAGF;YAG3B,IAAIC,OAAOE,UAAU,CAAC,SAAS;gBAC7B,OAAO,MAAM,IAAI,CAACC,eAAe,CAACH,QAAQC;YAC5C;YAGA,IAAID,OAAOE,UAAU,CAAC,WAAW;gBAC/B,OAAO,MAAM,IAAI,CAACE,gBAAgB,CAACJ,QAAQC;YAC7C;YAGA,MAAMI,OAAO,IAAI,CAACT,YAAY,CAACU,OAAO,CAACN;YACvC,IAAIK,MAAM;gBACR,MAAME,SAAS,MAAM,IAAI,CAACX,YAAY,CAACY,WAAW,CAACR,QAAQC;gBAC3D,IAAI,CAACP,kBAAkB;gBACvB,OAAOa;YACT;YAGA,MAAM,IAAIhB,uBAAuBS;QACnC,EAAE,OAAOS,OAAO;YACd,IAAI,CAACd,cAAc;YACnB,MAAMc;QACR;IACF;IAKAC,aAIE;QACA,OAAO;YACLjB,eAAe,IAAI,CAACA,aAAa;YACjCC,oBAAoB,IAAI,CAACA,kBAAkB;YAC3CC,gBAAgB,IAAI,CAACA,cAAc;QACrC;IACF;IAKA,MAAcQ,gBAAgBH,MAAc,EAAEC,MAAe,EAAoB;QAC/E,OAAQD;YACN,KAAK;gBACH,OAAO,IAAI,CAACW,eAAe;YAE7B,KAAK;gBACH,OAAO;oBAAEC,MAAM;gBAAK;YAEtB,KAAK;gBACH,OAAO,IAAI,CAACC,cAAc,CAACZ;YAE7B;gBACE,MAAM,IAAIV,uBAAuBS;QACrC;IACF;IAKA,MAAcI,iBAAiBJ,MAAc,EAAEC,MAAe,EAAoB;QAChF,OAAQD;YACN,KAAK;gBACH,OAAO,IAAI,CAACJ,YAAY,CAACkB,SAAS;YAEpC,KAAK;gBACH,OAAO,MAAM,IAAI,CAACC,UAAU,CAACd;YAE/B,KAAK;gBACH,OAAO,IAAI,CAACe,YAAY,CAACf;YAE3B;gBACE,MAAM,IAAIV,uBAAuBS;QACrC;IACF;IAKQW,kBAA0C;QAChD,MAAMM,UAAkC;YACtC,gBAAgB;YAChB,YAAY;YACZ,gBAAgB;YAChB,cAAc;YACd,gBAAgB;YAChB,kBAAkB;QACpB;QAGA,KAAK,MAAMZ,QAAQ,IAAI,CAACT,YAAY,CAACkB,SAAS,GAAI;YAChDG,OAAO,CAACZ,KAAKa,IAAI,CAAC,GAAGb,KAAKc,WAAW;QACvC;QAEA,OAAOF;IACT;IAKQJ,eAAeZ,MAAe,EAAW;QAC/C,IAAI,CAACA,UAAU,OAAOA,WAAW,YAAY,CAAE,CAAA,YAAYA,MAAK,GAAI;YAClE,MAAM,IAAImB,MAAM;QAClB;QAEA,MAAM,EAAEpB,MAAM,EAAE,GAAGC;QAGnB,MAAMI,OAAO,IAAI,CAACT,YAAY,CAACU,OAAO,CAACN;QACvC,IAAIK,MAAM;YACR,OAAO;gBACLa,MAAMb,KAAKa,IAAI;gBACfC,aAAad,KAAKc,WAAW;gBAC7BE,aAAahB,KAAKgB,WAAW;YAC/B;QACF;QAGA,MAAMC,iBAA0C;YAC9C,gBAAgB;gBACdH,aAAa;gBACbE,aAAa;oBAAEE,MAAM;oBAAUC,YAAY,CAAC;gBAAE;YAChD;YACA,YAAY;gBACVL,aAAa;gBACbE,aAAa;oBAAEE,MAAM;oBAAUC,YAAY,CAAC;gBAAE;YAChD;YACA,gBAAgB;gBACdL,aAAa;gBACbE,aAAa;oBACXE,MAAM;oBACNC,YAAY;wBACVxB,QAAQ;4BAAEuB,MAAM;wBAAS;oBAC3B;oBACAE,UAAU;wBAAC;qBAAS;gBACtB;YACF;YACA,cAAc;gBACZN,aAAa;gBACbE,aAAa;oBAAEE,MAAM;oBAAUC,YAAY,CAAC;gBAAE;YAChD;YACA,gBAAgB;gBACdL,aAAa;gBACbE,aAAa;oBACXE,MAAM;oBACNC,YAAY;wBACVnB,MAAM;4BAAEkB,MAAM;wBAAS;wBACvBG,OAAO;4BAAEH,MAAM;wBAAS;oBAC1B;oBACAE,UAAU;wBAAC;wBAAQ;qBAAQ;gBAC7B;YACF;YACA,kBAAkB;gBAChBN,aAAa;gBACbE,aAAa;oBACXE,MAAM;oBACNC,YAAY;wBACVnB,MAAM;4BAAEkB,MAAM;wBAAS;oBACzB;oBACAE,UAAU;wBAAC;qBAAO;gBACpB;YACF;QACF;QAEA,IAAIzB,UAAUsB,gBAAgB;YAC5B,OAAOA,cAAc,CAACtB,OAAO;QAC/B;QAEA,MAAM,IAAIT,uBAAuBS;IACnC;IAKA,MAAce,WAAWd,MAAe,EAAoB;QAC1D,IAAI,CAACA,UAAU,OAAOA,WAAW,YAAY,CAAE,CAAA,UAAUA,MAAK,GAAI;YAChE,MAAM,IAAImB,MAAM;QAClB;QAEA,MAAM,EAAEf,IAAI,EAAEqB,KAAK,EAAE,GAAGzB;QACxB,OAAO,MAAM,IAAI,CAACL,YAAY,CAACY,WAAW,CAACH,MAAMqB,SAAS,CAAC;IAC7D;IAKQV,aAAaf,MAAe,EAAW;QAC7C,IAAI,CAACA,UAAU,OAAOA,WAAW,YAAY,CAAE,CAAA,UAAUA,MAAK,GAAI;YAChE,MAAM,IAAImB,MAAM;QAClB;QAEA,MAAM,EAAEf,MAAMsB,QAAQ,EAAE,GAAG1B;QAC3B,MAAMI,OAAO,IAAI,CAACT,YAAY,CAACU,OAAO,CAACqB;QAEvC,IAAI,CAACtB,MAAM;YACT,MAAM,IAAIe,MAAM,CAAC,gBAAgB,EAAEO,UAAU;QAC/C;QAEA,OAAO;YACLT,MAAMb,KAAKa,IAAI;YACfC,aAAad,KAAKc,WAAW;YAC7BE,aAAahB,KAAKgB,WAAW;QAC/B;IACF;AACF"}
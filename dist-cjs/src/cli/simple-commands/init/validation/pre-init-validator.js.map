{"version":3,"sources":["../../../../../../src/cli/simple-commands/init/validation/pre-init-validator.js"],"sourcesContent":["// pre-init-validator.js - Pre-initialization validation checks\r\n\r\nimport { printWarning } from '../../../utils.js';\r\n\r\nexport class PreInitValidator {\r\n  constructor(workingDir) {\r\n    this.workingDir = workingDir;\r\n  }\r\n\r\n  /**\r\n   * Check file system permissions\r\n   */\r\n  async checkPermissions() {\r\n    const result = {\r\n      success: true,\r\n      errors: [],\r\n      warnings: [],\r\n    };\r\n\r\n    try {\r\n      // Test write permission in working directory\r\n      const testFile = `${this.workingDir}/.claude-flow-permission-test`;\r\n      await Deno.writeTextFile(testFile, 'test');\r\n      await Deno.remove(testFile);\r\n\r\n      // Test directory creation permission\r\n      const testDir = `${this.workingDir}/.claude-flow-dir-test`;\r\n      await Deno.mkdir(testDir);\r\n      await Deno.remove(testDir);\r\n    } catch (error) {\r\n      result.success = false;\r\n      result.errors.push(`Insufficient permissions in ${this.workingDir}: ${error.message}`);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Check available disk space\r\n   */\r\n  async checkDiskSpace() {\r\n    const result = {\r\n      success: true,\r\n      errors: [],\r\n      warnings: [],\r\n    };\r\n\r\n    try {\r\n      // Get disk usage information\r\n      const command = new Deno.Command('df', {\r\n        args: ['-k', this.workingDir],\r\n        stdout: 'piped',\r\n        stderr: 'piped',\r\n      });\r\n\r\n      const { stdout, success } = await command.output();\r\n\r\n      if (success) {\r\n        const output = new TextDecoder().decode(stdout);\r\n        const lines = output.trim().split('\\n');\r\n\r\n        if (lines.length >= 2) {\r\n          const dataLine = lines[1];\r\n          const parts = dataLine.split(/\\s+/);\r\n\r\n          if (parts.length >= 4) {\r\n            const availableKB = parseInt(parts[3]);\r\n            const availableMB = availableKB / 1024;\r\n\r\n            // Require at least 100MB free space\r\n            if (availableMB < 100) {\r\n              result.success = false;\r\n              result.errors.push(\r\n                `Insufficient disk space: ${availableMB.toFixed(2)}MB available (minimum 100MB required)`,\r\n              );\r\n            } else if (availableMB < 500) {\r\n              result.warnings.push(`Low disk space: ${availableMB.toFixed(2)}MB available`);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // Non-critical - just warn if we can't check disk space\r\n      result.warnings.push(`Could not check disk space: ${error.message}`);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Check for existing files and conflicts\r\n   */\r\n  async checkConflicts(force = false) {\r\n    const result = {\r\n      success: true,\r\n      errors: [],\r\n      warnings: [],\r\n      conflicts: [],\r\n    };\r\n\r\n    const criticalFiles = [\r\n      'CLAUDE.md',\r\n      'memory-bank.md',\r\n      'coordination.md',\r\n      '.roomodes',\r\n      'memory/claude-flow-data.json',\r\n    ];\r\n\r\n    const criticalDirs = ['.roo', '.claude', 'memory', 'coordination'];\r\n\r\n    // Check critical files\r\n    for (const file of criticalFiles) {\r\n      try {\r\n        const stat = await Deno.stat(`${this.workingDir}/${file}`);\r\n        if (stat.isFile) {\r\n          result.conflicts.push(file);\r\n          if (!force) {\r\n            result.success = false;\r\n            result.errors.push(`File already exists: ${file}`);\r\n          } else {\r\n            result.warnings.push(`File will be overwritten: ${file}`);\r\n          }\r\n        }\r\n      } catch {\r\n        // File doesn't exist - good\r\n      }\r\n    }\r\n\r\n    // Check critical directories\r\n    for (const dir of criticalDirs) {\r\n      try {\r\n        const stat = await Deno.stat(`${this.workingDir}/${dir}`);\r\n        if (stat.isDirectory) {\r\n          // Check if directory has important content\r\n          const entries = [];\r\n          for await (const entry of Deno.readDir(`${this.workingDir}/${dir}`)) {\r\n            entries.push(entry.name);\r\n          }\r\n\r\n          if (entries.length > 0) {\r\n            result.conflicts.push(`${dir}/ (${entries.length} items)`);\r\n            if (!force) {\r\n              result.warnings.push(`Directory exists with content: ${dir}/`);\r\n            }\r\n          }\r\n        }\r\n      } catch {\r\n        // Directory doesn't exist - good\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Check for required dependencies\r\n   */\r\n  async checkDependencies() {\r\n    const result = {\r\n      success: true,\r\n      errors: [],\r\n      warnings: [],\r\n      dependencies: {},\r\n    };\r\n\r\n    const dependencies = [\r\n      { name: 'node', command: 'node', args: ['--version'], required: true },\r\n      { name: 'npm', command: 'npm', args: ['--version'], required: true },\r\n      { name: 'git', command: 'git', args: ['--version'], required: false },\r\n      { name: 'npx', command: 'npx', args: ['--version'], required: true },\r\n    ];\r\n\r\n    for (const dep of dependencies) {\r\n      try {\r\n        const command = new Deno.Command(dep.command, {\r\n          args: dep.args,\r\n          stdout: 'piped',\r\n          stderr: 'piped',\r\n        });\r\n\r\n        const { stdout, success } = await command.output();\r\n\r\n        if (success) {\r\n          const version = new TextDecoder().decode(stdout).trim();\r\n          result.dependencies[dep.name] = {\r\n            available: true,\r\n            version,\r\n          };\r\n        } else {\r\n          throw new Error('Command failed');\r\n        }\r\n      } catch (error) {\r\n        result.dependencies[dep.name] = {\r\n          available: false,\r\n          error: error.message,\r\n        };\r\n\r\n        if (dep.required) {\r\n          result.success = false;\r\n          result.errors.push(`Required dependency '${dep.name}' is not available`);\r\n        } else {\r\n          result.warnings.push(`Optional dependency '${dep.name}' is not available`);\r\n        }\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Check environment variables and configuration\r\n   */\r\n  async checkEnvironment() {\r\n    const result = {\r\n      success: true,\r\n      errors: [],\r\n      warnings: [],\r\n      environment: {},\r\n    };\r\n\r\n    // Check for important environment variables\r\n    const envVars = [\r\n      { name: 'HOME', required: false },\r\n      { name: 'PATH', required: true },\r\n      { name: 'PWD', required: false },\r\n      { name: 'CLAUDE_FLOW_DEBUG', required: false },\r\n    ];\r\n\r\n    for (const envVar of envVars) {\r\n      const value = Deno.env.get(envVar.name);\r\n\r\n      if (value) {\r\n        result.environment[envVar.name] = 'set';\r\n      } else {\r\n        result.environment[envVar.name] = 'not set';\r\n\r\n        if (envVar.required) {\r\n          result.success = false;\r\n          result.errors.push(`Required environment variable ${envVar.name} is not set`);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check if we're in a git repository\r\n    try {\r\n      const command = new Deno.Command('git', {\r\n        args: ['rev-parse', '--git-dir'],\r\n        cwd: this.workingDir,\r\n        stdout: 'piped',\r\n        stderr: 'piped',\r\n      });\r\n\r\n      const { success } = await command.output();\r\n      result.environment.gitRepo = success;\r\n\r\n      if (!success) {\r\n        result.warnings.push('Not in a git repository - version control recommended');\r\n      }\r\n    } catch {\r\n      result.environment.gitRepo = false;\r\n      result.warnings.push('Could not check git repository status');\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Run all pre-initialization checks\r\n   */\r\n  async runAllChecks(options = {}) {\r\n    const results = {\r\n      permissions: await this.checkPermissions(),\r\n      diskSpace: await this.checkDiskSpace(),\r\n      conflicts: await this.checkConflicts(options.force),\r\n      dependencies: await this.checkDependencies(),\r\n      environment: await this.checkEnvironment(),\r\n    };\r\n\r\n    const overallSuccess = Object.values(results).every((r) => r.success);\r\n    const allErrors = Object.values(results).flatMap((r) => r.errors || []);\r\n    const allWarnings = Object.values(results).flatMap((r) => r.warnings || []);\r\n\r\n    return {\r\n      success: overallSuccess,\r\n      results,\r\n      errors: allErrors,\r\n      warnings: allWarnings,\r\n    };\r\n  }\r\n}\r\n"],"names":["PreInitValidator","workingDir","checkPermissions","result","success","errors","warnings","testFile","Deno","writeTextFile","remove","testDir","mkdir","error","push","message","checkDiskSpace","command","Command","args","stdout","stderr","output","TextDecoder","decode","lines","trim","split","length","dataLine","parts","availableKB","parseInt","availableMB","toFixed","checkConflicts","force","conflicts","criticalFiles","criticalDirs","file","stat","isFile","dir","isDirectory","entries","entry","readDir","name","checkDependencies","dependencies","required","dep","version","available","Error","checkEnvironment","environment","envVars","envVar","value","env","get","cwd","gitRepo","runAllChecks","options","results","permissions","diskSpace","overallSuccess","Object","values","every","r","allErrors","flatMap","allWarnings"],"mappings":"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"}
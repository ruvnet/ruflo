{"version":3,"sources":["../../../src/swarm/claude-flow-executor.ts"],"sourcesContent":["/**\r\n * Claude Flow SPARC Executor\r\n * Executes tasks using the full claude-flow SPARC system in non-interactive mode\r\n */\r\n\r\nimport type { TaskDefinition, AgentState, TaskResult } from './types.js';\r\nimport { Logger } from '../core/logger.js';\r\nimport * as path from 'node:path';\r\nimport { spawn } from 'node:child_process';\r\nimport { getClaudeFlowBin } from '../utils/paths.js';\r\n\r\nexport interface ClaudeFlowExecutorConfig {\r\n  logger?: Logger;\r\n  claudeFlowPath?: string;\r\n  enableSparc?: boolean;\r\n  verbose?: boolean;\r\n  timeoutMinutes?: number;\r\n}\r\n\r\nexport class ClaudeFlowExecutor {\r\n  private logger: Logger;\r\n  private claudeFlowPath: string;\r\n  private enableSparc: boolean;\r\n  private verbose: boolean;\r\n  private timeoutMinutes: number;\r\n\r\n  constructor(config: ClaudeFlowExecutorConfig = {}) {\r\n    this.logger =\r\n      config.logger ||\r\n      new Logger(\r\n        { level: 'info', format: 'text', destination: 'console' },\r\n        { component: 'ClaudeFlowExecutor' },\r\n      );\r\n    this.claudeFlowPath = config.claudeFlowPath || getClaudeFlowBin();\r\n    this.enableSparc = config.enableSparc ?? true;\r\n    this.verbose = config.verbose ?? false;\r\n    this.timeoutMinutes = config.timeoutMinutes ?? 59;\r\n  }\r\n\r\n  async executeTask(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    targetDir?: string,\r\n  ): Promise<TaskResult> {\r\n    this.logger.info('Executing task with Claude Flow SPARC', {\r\n      taskId: task.id.id,\r\n      taskName: task.name,\r\n      agentType: agent.type,\r\n      targetDir,\r\n    });\r\n\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      // Determine the SPARC mode based on task type and agent type\r\n      const sparcMode = this.determineSparcMode(task, agent);\r\n\r\n      // Build the command\r\n      const command = this.buildSparcCommand(task, sparcMode, targetDir);\r\n\r\n      this.logger.info('Executing SPARC command', {\r\n        mode: sparcMode,\r\n        command: command.join(' '),\r\n      });\r\n\r\n      // Execute the command\r\n      const result = await this.executeCommand(command);\r\n\r\n      const endTime = Date.now();\r\n      const executionTime = endTime - startTime;\r\n\r\n      return {\r\n        output: result.output,\r\n        artifacts: result.artifacts || {},\r\n        metadata: {\r\n          executionTime,\r\n          sparcMode,\r\n          command: command.join(' '),\r\n          exitCode: result.exitCode,\r\n          quality: 0.95,\r\n          completeness: 0.9,\r\n        },\r\n        error: result.error,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Failed to execute Claude Flow SPARC command', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n        taskId: task.id.id,\r\n      });\r\n\r\n      return {\r\n        output: '',\r\n        artifacts: {},\r\n        metadata: {\r\n          executionTime: Date.now() - startTime,\r\n          quality: 0,\r\n          completeness: 0,\r\n        },\r\n        error: error instanceof Error ? error.message : String(error),\r\n      };\r\n    }\r\n  }\r\n\r\n  private determineSparcMode(task: TaskDefinition, agent: AgentState): string {\r\n    // Map task types and agent types to SPARC modes\r\n    const modeMap = {\r\n      // Task type mappings\r\n      coding: 'code',\r\n      testing: 'tdd',\r\n      analysis: 'spec-pseudocode',\r\n      documentation: 'docs-writer',\r\n      research: 'spec-pseudocode',\r\n      review: 'refinement-optimization-mode',\r\n      deployment: 'devops',\r\n      optimization: 'refinement-optimization-mode',\r\n      integration: 'integration',\r\n\r\n      // Agent type overrides\r\n      coder: 'code',\r\n      tester: 'tdd',\r\n      analyst: 'spec-pseudocode',\r\n      documenter: 'docs-writer',\r\n      reviewer: 'refinement-optimization-mode',\r\n      researcher: 'spec-pseudocode',\r\n      coordinator: 'architect',\r\n    };\r\n\r\n    // Check for specific keywords in task description\r\n    const description = task.description.toLowerCase();\r\n    if (description.includes('architecture') || description.includes('design')) {\r\n      return 'architect';\r\n    }\r\n    if (description.includes('security')) {\r\n      return 'security-review';\r\n    }\r\n    if (description.includes('debug')) {\r\n      return 'debug';\r\n    }\r\n    if (description.includes('test')) {\r\n      return 'tdd';\r\n    }\r\n    if (description.includes('document')) {\r\n      return 'docs-writer';\r\n    }\r\n    if (description.includes('integrate')) {\r\n      return 'integration';\r\n    }\r\n\r\n    // Use agent type first, then task type\r\n    return modeMap[agent.type] || modeMap[task.type] || 'code';\r\n  }\r\n\r\n  private buildSparcCommand(task: TaskDefinition, mode: string, targetDir?: string): string[] {\r\n    const command = [\r\n      this.claudeFlowPath,\r\n      'sparc',\r\n      'run',\r\n      mode,\r\n      `\"${this.formatTaskDescription(task)}\"`,\r\n    ];\r\n\r\n    // Add options\r\n    if (targetDir) {\r\n      command.push('--target-dir', targetDir);\r\n    }\r\n\r\n    if (this.verbose) {\r\n      command.push('--verbose');\r\n    }\r\n\r\n    // Add non-interactive flag\r\n    command.push('--non-interactive');\r\n\r\n    // Add auto-confirm flag\r\n    command.push('--yes');\r\n\r\n    return command;\r\n  }\r\n\r\n  private formatTaskDescription(task: TaskDefinition): string {\r\n    // Format the task description for SPARC command\r\n    let description = task.description;\r\n\r\n    // If the task has specific instructions, include them\r\n    if (task.instructions && task.instructions !== task.description) {\r\n      description = `${task.description}. ${task.instructions}`;\r\n    }\r\n\r\n    // Add context if available\r\n    if (task.context?.targetDir) {\r\n      description += ` in ${task.context.targetDir}`;\r\n    }\r\n\r\n    return description.replace(/\"/g, '\\\\\"');\r\n  }\r\n\r\n  private async executeCommand(command: string[]): Promise<any> {\r\n    return new Promise((resolve, reject) => {\r\n      const [cmd, ...args] = command;\r\n\r\n      const proc = spawn(cmd, args, {\r\n        shell: true,\r\n        env: {\r\n          ...process.env,\r\n          CLAUDE_FLOW_NON_INTERACTIVE: 'true',\r\n          CLAUDE_FLOW_AUTO_CONFIRM: 'true',\r\n        },\r\n      });\r\n\r\n      let stdout = '';\r\n      let stderr = '';\r\n      const artifacts: Record<string, any> = {};\r\n\r\n      proc.stdout.on('data', (data) => {\r\n        const chunk = data.toString();\r\n        stdout += chunk;\r\n\r\n        // Parse artifacts from output\r\n        const artifactMatch = chunk.match(/Created file: (.+)/g);\r\n        if (artifactMatch) {\r\n          artifactMatch.forEach((match) => {\r\n            const filePath = match.replace('Created file: ', '').trim();\r\n            artifacts[filePath] = true;\r\n          });\r\n        }\r\n      });\r\n\r\n      proc.stderr.on('data', (data) => {\r\n        stderr += data.toString();\r\n      });\r\n\r\n      proc.on('close', (code) => {\r\n        clearTimeout(timeoutId); // Clear timeout when process completes\r\n        if (code === 0) {\r\n          resolve({\r\n            output: stdout,\r\n            artifacts,\r\n            exitCode: code,\r\n            error: null,\r\n          });\r\n        } else {\r\n          resolve({\r\n            output: stdout,\r\n            artifacts,\r\n            exitCode: code,\r\n            error: stderr || `Command exited with code ${code}`,\r\n          });\r\n        }\r\n      });\r\n\r\n      proc.on('error', (err) => {\r\n        reject(err);\r\n      });\r\n\r\n      // Handle timeout - configurable for SPARC operations\r\n      const timeoutMs = this.timeoutMinutes * 60 * 1000;\r\n      const timeoutId = setTimeout(() => {\r\n        proc.kill('SIGTERM');\r\n        reject(new Error('Command execution timeout'));\r\n      }, timeoutMs);\r\n    });\r\n  }\r\n}\r\n\r\n// Export for use in swarm coordinator\r\nexport default ClaudeFlowExecutor;\r\n"],"names":["Logger","spawn","getClaudeFlowBin","ClaudeFlowExecutor","logger","claudeFlowPath","enableSparc","verbose","timeoutMinutes","config","level","format","destination","component","executeTask","task","agent","targetDir","info","taskId","id","taskName","name","agentType","type","startTime","Date","now","sparcMode","determineSparcMode","command","buildSparcCommand","mode","join","result","executeCommand","endTime","executionTime","output","artifacts","metadata","exitCode","quality","completeness","error","Error","message","String","modeMap","coding","testing","analysis","documentation","research","review","deployment","optimization","integration","coder","tester","analyst","documenter","reviewer","researcher","coordinator","description","toLowerCase","includes","formatTaskDescription","push","instructions","context","replace","Promise","resolve","reject","cmd","args","proc","shell","env","process","CLAUDE_FLOW_NON_INTERACTIVE","CLAUDE_FLOW_AUTO_CONFIRM","stdout","stderr","on","data","chunk","toString","artifactMatch","match","forEach","filePath","trim","code","clearTimeout","timeoutId","err","timeoutMs","setTimeout","kill"],"mappings":"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"}
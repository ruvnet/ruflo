{"version":3,"sources":["../../../src/__tests__/session-forking.test.ts"],"sourcesContent":["/**\r\n * Session Forking Tests\r\n * Claude-Flow v2.5-alpha.130\r\n *\r\n * Tests for parallel agent execution and real-time query control\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';\r\nimport { ParallelSwarmExecutor, type ParallelAgentConfig } from '../sdk/session-forking.js';\r\nimport { RealTimeQueryController, type QueryControlCommand } from '../sdk/query-control.js';\r\nimport { query, type Query } from '@anthropic-ai/claude-code/sdk';\r\n\r\n// Mock the SDK query function\r\nvi.mock('@anthropic-ai/claude-code/sdk', () => ({\r\n  query: vi.fn()\r\n}));\r\n\r\ndescribe('ParallelSwarmExecutor', () => {\r\n  let executor: ParallelSwarmExecutor;\r\n\r\n  beforeEach(() => {\r\n    executor = new ParallelSwarmExecutor();\r\n  });\r\n\r\n  afterEach(() => {\r\n    executor.removeAllListeners();\r\n  });\r\n\r\n  describe('spawnParallelAgents', () => {\r\n    it('should spawn multiple agents in parallel', async () => {\r\n      const configs: ParallelAgentConfig[] = [\r\n        {\r\n          agentId: 'agent-1',\r\n          agentType: 'researcher',\r\n          task: 'Research AI trends',\r\n          priority: 'high'\r\n        },\r\n        {\r\n          agentId: 'agent-2',\r\n          agentType: 'coder',\r\n          task: 'Write test code',\r\n          priority: 'medium'\r\n        },\r\n        {\r\n          agentId: 'agent-3',\r\n          agentType: 'analyst',\r\n          task: 'Analyze data',\r\n          priority: 'high'\r\n        }\r\n      ];\r\n\r\n      // Mock query responses\r\n      const mockQuery = {\r\n        [Symbol.asyncIterator]: async function* () {\r\n          yield {\r\n            type: 'system',\r\n            subtype: 'init',\r\n            uuid: 'test-uuid',\r\n            session_id: 'test-session',\r\n            tools: [],\r\n            model: 'claude-sonnet-4',\r\n            mcp_servers: [],\r\n            permissionMode: 'default',\r\n            slash_commands: [],\r\n            output_style: 'text',\r\n            cwd: '/test',\r\n            apiKeySource: 'user'\r\n          };\r\n          yield {\r\n            type: 'assistant',\r\n            uuid: 'test-uuid-2',\r\n            session_id: 'test-session',\r\n            parent_tool_use_id: null,\r\n            message: {\r\n              id: 'msg-1',\r\n              type: 'message',\r\n              role: 'assistant',\r\n              content: [{ type: 'text', text: 'Task completed successfully' }],\r\n              model: 'claude-sonnet-4',\r\n              stop_reason: 'end_turn',\r\n              usage: { input_tokens: 100, output_tokens: 50 }\r\n            }\r\n          };\r\n        },\r\n        interrupt: vi.fn(),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn(),\r\n        supportedCommands: vi.fn(),\r\n        supportedModels: vi.fn(),\r\n        mcpServerStatus: vi.fn()\r\n      } as any;\r\n\r\n      vi.mocked(query).mockReturnValue(mockQuery);\r\n\r\n      const result = await executor.spawnParallelAgents(configs, {\r\n        maxParallelAgents: 5,\r\n        timeout: 30000\r\n      });\r\n\r\n      expect(result.success).toBe(true);\r\n      expect(result.successfulAgents).toHaveLength(3);\r\n      expect(result.failedAgents).toHaveLength(0);\r\n      expect(result.agentResults.size).toBe(3);\r\n    });\r\n\r\n    it('should respect priority ordering', async () => {\r\n      const configs: ParallelAgentConfig[] = [\r\n        { agentId: 'low', agentType: 'analyst', task: 'Low priority', priority: 'low' },\r\n        { agentId: 'critical', agentType: 'researcher', task: 'Critical task', priority: 'critical' },\r\n        { agentId: 'medium', agentType: 'coder', task: 'Medium task', priority: 'medium' },\r\n        { agentId: 'high', agentType: 'optimizer', task: 'High priority', priority: 'high' }\r\n      ];\r\n\r\n      const executionOrder: string[] = [];\r\n\r\n      executor.on('session:forked', (data) => {\r\n        executionOrder.push(data.agentId);\r\n      });\r\n\r\n      const mockQuery = {\r\n        [Symbol.asyncIterator]: async function* () {\r\n          yield {\r\n            type: 'system',\r\n            subtype: 'init',\r\n            uuid: 'test-uuid',\r\n            session_id: 'test-session',\r\n            tools: [],\r\n            model: 'claude-sonnet-4',\r\n            mcp_servers: [],\r\n            permissionMode: 'default',\r\n            slash_commands: [],\r\n            output_style: 'text',\r\n            cwd: '/test',\r\n            apiKeySource: 'user'\r\n          };\r\n        },\r\n        interrupt: vi.fn(),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn(),\r\n        supportedCommands: vi.fn(),\r\n        supportedModels: vi.fn(),\r\n        mcpServerStatus: vi.fn()\r\n      } as any;\r\n\r\n      vi.mocked(query).mockReturnValue(mockQuery);\r\n\r\n      await executor.spawnParallelAgents(configs, { maxParallelAgents: 2 });\r\n\r\n      // Critical should be first, then high, medium, low\r\n      expect(executionOrder[0]).toBe('critical');\r\n      expect(executionOrder[1]).toBe('high');\r\n    });\r\n\r\n    it('should handle agent failures gracefully', async () => {\r\n      const configs: ParallelAgentConfig[] = [\r\n        { agentId: 'success', agentType: 'researcher', task: 'Will succeed' },\r\n        { agentId: 'fail', agentType: 'coder', task: 'Will fail' }\r\n      ];\r\n\r\n      let callCount = 0;\r\n      vi.mocked(query).mockImplementation(() => {\r\n        callCount++;\r\n        if (callCount === 2) {\r\n          throw new Error('Simulated failure');\r\n        }\r\n        return {\r\n          [Symbol.asyncIterator]: async function* () {\r\n            yield {\r\n              type: 'system',\r\n              subtype: 'init',\r\n              uuid: 'test-uuid',\r\n              session_id: 'test-session',\r\n              tools: [],\r\n              model: 'claude-sonnet-4',\r\n              mcp_servers: [],\r\n              permissionMode: 'default',\r\n              slash_commands: [],\r\n              output_style: 'text',\r\n              cwd: '/test',\r\n              apiKeySource: 'user'\r\n            };\r\n          },\r\n          interrupt: vi.fn()\r\n        } as any;\r\n      });\r\n\r\n      const result = await executor.spawnParallelAgents(configs);\r\n\r\n      expect(result.success).toBe(false);\r\n      expect(result.successfulAgents).toHaveLength(1);\r\n      expect(result.failedAgents).toHaveLength(1);\r\n      expect(result.failedAgents[0]).toBe('fail');\r\n    });\r\n\r\n    it('should batch agents when exceeding maxParallelAgents', async () => {\r\n      const configs: ParallelAgentConfig[] = Array.from({ length: 15 }, (_, i) => ({\r\n        agentId: `agent-${i}`,\r\n        agentType: 'researcher',\r\n        task: `Task ${i}`\r\n      }));\r\n\r\n      const mockQuery = {\r\n        [Symbol.asyncIterator]: async function* () {\r\n          yield {\r\n            type: 'system',\r\n            subtype: 'init',\r\n            uuid: 'test-uuid',\r\n            session_id: 'test-session',\r\n            tools: [],\r\n            model: 'claude-sonnet-4',\r\n            mcp_servers: [],\r\n            permissionMode: 'default',\r\n            slash_commands: [],\r\n            output_style: 'text',\r\n            cwd: '/test',\r\n            apiKeySource: 'user'\r\n          };\r\n        },\r\n        interrupt: vi.fn()\r\n      } as any;\r\n\r\n      vi.mocked(query).mockReturnValue(mockQuery);\r\n\r\n      const result = await executor.spawnParallelAgents(configs, {\r\n        maxParallelAgents: 5\r\n      });\r\n\r\n      expect(result.successfulAgents).toHaveLength(15);\r\n      // Should execute in 3 batches (5, 5, 5)\r\n    });\r\n  });\r\n\r\n  describe('Performance Metrics', () => {\r\n    it('should track performance gain', async () => {\r\n      const configs: ParallelAgentConfig[] = [\r\n        { agentId: 'agent-1', agentType: 'researcher', task: 'Task 1' },\r\n        { agentId: 'agent-2', agentType: 'coder', task: 'Task 2' },\r\n        { agentId: 'agent-3', agentType: 'analyst', task: 'Task 3' }\r\n      ];\r\n\r\n      const mockQuery = {\r\n        [Symbol.asyncIterator]: async function* () {\r\n          yield {\r\n            type: 'system',\r\n            subtype: 'init',\r\n            uuid: 'test-uuid',\r\n            session_id: 'test-session',\r\n            tools: [],\r\n            model: 'claude-sonnet-4',\r\n            mcp_servers: [],\r\n            permissionMode: 'default',\r\n            slash_commands: [],\r\n            output_style: 'text',\r\n            cwd: '/test',\r\n            apiKeySource: 'user'\r\n          };\r\n        },\r\n        interrupt: vi.fn()\r\n      } as any;\r\n\r\n      vi.mocked(query).mockReturnValue(mockQuery);\r\n\r\n      await executor.spawnParallelAgents(configs);\r\n\r\n      const metrics = executor.getMetrics();\r\n      expect(metrics.totalAgentsSpawned).toBe(3);\r\n      expect(metrics.parallelExecutions).toBe(1);\r\n      expect(metrics.performanceGain).toBeGreaterThan(1); // Should show improvement\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('RealTimeQueryController', () => {\r\n  let controller: RealTimeQueryController;\r\n\r\n  beforeEach(() => {\r\n    controller = new RealTimeQueryController({\r\n      allowPause: true,\r\n      allowModelChange: true,\r\n      allowPermissionChange: true,\r\n      monitoringInterval: 100\r\n    });\r\n  });\r\n\r\n  afterEach(() => {\r\n    controller.shutdown();\r\n  });\r\n\r\n  describe('Query Registration', () => {\r\n    it('should register a query for control', () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn(),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn(),\r\n        supportedCommands: vi.fn(),\r\n        supportedModels: vi.fn()\r\n      } as any;\r\n\r\n      const controlled = controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      expect(controlled.queryId).toBe('query-1');\r\n      expect(controlled.agentId).toBe('agent-1');\r\n      expect(controlled.status).toBe('running');\r\n      expect(controlled.canControl).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Query Control', () => {\r\n    it('should pause a running query', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn().mockResolvedValue(undefined),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      const paused = await controller.pauseQuery('query-1', 'Manual pause');\r\n\r\n      expect(paused).toBe(true);\r\n      expect(mockQuery.interrupt).toHaveBeenCalled();\r\n\r\n      const status = controller.getQueryStatus('query-1');\r\n      expect(status?.status).toBe('paused');\r\n      expect(status?.isPaused).toBe(true);\r\n    });\r\n\r\n    it('should resume a paused query', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn().mockResolvedValue(undefined),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n      await controller.pauseQuery('query-1');\r\n\r\n      const resumed = await controller.resumeQuery('query-1');\r\n\r\n      expect(resumed).toBe(true);\r\n\r\n      const status = controller.getQueryStatus('query-1');\r\n      expect(status?.status).toBe('running');\r\n      expect(status?.isPaused).toBe(false);\r\n    });\r\n\r\n    it('should terminate a query', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn().mockResolvedValue(undefined),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      const terminated = await controller.terminateQuery('query-1', 'Test termination');\r\n\r\n      expect(terminated).toBe(true);\r\n      expect(mockQuery.interrupt).toHaveBeenCalled();\r\n\r\n      const status = controller.getQueryStatus('query-1');\r\n      expect(status?.status).toBe('terminated');\r\n    });\r\n\r\n    it('should change model for a running query', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn(),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn().mockResolvedValue(undefined),\r\n        supportedModels: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      const changed = await controller.changeModel('query-1', 'claude-opus-4');\r\n\r\n      expect(changed).toBe(true);\r\n      expect(mockQuery.setModel).toHaveBeenCalledWith('claude-opus-4');\r\n\r\n      const status = controller.getQueryStatus('query-1');\r\n      expect(status?.currentModel).toBe('claude-opus-4');\r\n    });\r\n\r\n    it('should change permission mode', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn(),\r\n        setPermissionMode: vi.fn().mockResolvedValue(undefined),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      const changed = await controller.changePermissionMode('query-1', 'bypassPermissions');\r\n\r\n      expect(changed).toBe(true);\r\n      expect(mockQuery.setPermissionMode).toHaveBeenCalledWith('bypassPermissions');\r\n\r\n      const status = controller.getQueryStatus('query-1');\r\n      expect(status?.permissionMode).toBe('bypassPermissions');\r\n    });\r\n  });\r\n\r\n  describe('Command Queue', () => {\r\n    it('should queue and execute commands', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn().mockResolvedValue(undefined),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      const command: QueryControlCommand = {\r\n        type: 'pause',\r\n        queryId: 'query-1',\r\n        params: { reason: 'Test pause' }\r\n      };\r\n\r\n      controller.queueCommand(command);\r\n      await controller.processQueuedCommands('query-1');\r\n\r\n      expect(mockQuery.interrupt).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('Monitoring', () => {\r\n    it('should emit status updates during monitoring', (done) => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn(),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n\r\n      let updateCount = 0;\r\n      controller.on('query:status', (update) => {\r\n        updateCount++;\r\n        if (updateCount >= 2) {\r\n          expect(update.queryId).toBe('query-1');\r\n          expect(update.status).toBe('running');\r\n          done();\r\n        }\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('Cleanup', () => {\r\n    it('should cleanup old queries', async () => {\r\n      const mockQuery = {\r\n        interrupt: vi.fn().mockResolvedValue(undefined),\r\n        setPermissionMode: vi.fn(),\r\n        setModel: vi.fn()\r\n      } as any;\r\n\r\n      controller.registerQuery('query-1', 'agent-1', mockQuery);\r\n      await controller.terminateQuery('query-1');\r\n\r\n      // Cleanup queries older than 0ms (all queries)\r\n      controller.cleanup(0);\r\n\r\n      const status = controller.getQueryStatus('query-1');\r\n      expect(status).toBeUndefined();\r\n    });\r\n  });\r\n});"],"names":["describe","it","expect","beforeEach","afterEach","vi","ParallelSwarmExecutor","RealTimeQueryController","query","mock","fn","executor","removeAllListeners","configs","agentId","agentType","task","priority","mockQuery","Symbol","asyncIterator","type","subtype","uuid","session_id","tools","model","mcp_servers","permissionMode","slash_commands","output_style","cwd","apiKeySource","parent_tool_use_id","message","id","role","content","text","stop_reason","usage","input_tokens","output_tokens","interrupt","setPermissionMode","setModel","supportedCommands","supportedModels","mcpServerStatus","mocked","mockReturnValue","result","spawnParallelAgents","maxParallelAgents","timeout","success","toBe","successfulAgents","toHaveLength","failedAgents","agentResults","size","executionOrder","on","data","push","callCount","mockImplementation","Error","Array","from","length","_","i","metrics","getMetrics","totalAgentsSpawned","parallelExecutions","performanceGain","toBeGreaterThan","controller","allowPause","allowModelChange","allowPermissionChange","monitoringInterval","shutdown","controlled","registerQuery","queryId","status","canControl","mockResolvedValue","undefined","paused","pauseQuery","toHaveBeenCalled","getQueryStatus","isPaused","resumed","resumeQuery","terminated","terminateQuery","changed","changeModel","toHaveBeenCalledWith","currentModel","changePermissionMode","command","params","reason","queueCommand","processQueuedCommands","done","updateCount","update","cleanup","toBeUndefined"],"mappings":"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"}
{"version":3,"sources":["../../../../src/hive-mind/core/HiveMind.ts"],"sourcesContent":["/**\r\n * HiveMind Core Class\r\n *\r\n * Main orchestrator for the collective intelligence swarm system.\r\n * Manages agents, tasks, memory, and coordination.\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { Queen } from './Queen.js';\r\nimport { Agent } from './Agent.js';\r\nimport { Memory } from './Memory.js';\r\nimport { Communication } from './Communication.js';\r\nimport { DatabaseManager } from './DatabaseManager.js';\r\nimport { SwarmOrchestrator } from '../integration/SwarmOrchestrator.js';\r\nimport { ConsensusEngine } from '../integration/ConsensusEngine.js';\r\nimport {\r\n  HiveMindConfig,\r\n  SwarmTopology,\r\n  AgentType,\r\n  Task,\r\n  TaskPriority,\r\n  TaskStrategy,\r\n  SwarmStatus,\r\n  AgentSpawnOptions,\r\n  TaskSubmitOptions,\r\n} from '../types.js';\r\n\r\nexport class HiveMind extends EventEmitter {\r\n  private id: string;\r\n  private config: HiveMindConfig;\r\n  private queen: Queen;\r\n  private agents: Map<string, Agent>;\r\n  private memory: Memory;\r\n  private communication: Communication;\r\n  private orchestrator: SwarmOrchestrator;\r\n  private consensus: ConsensusEngine;\r\n  private db: DatabaseManager;\r\n  private started: boolean = false;\r\n  private startTime: number;\r\n\r\n  constructor(config: HiveMindConfig) {\r\n    super();\r\n    this.config = config;\r\n    this.id = uuidv4();\r\n    this.agents = new Map();\r\n    this.startTime = Date.now();\r\n  }\r\n\r\n  /**\r\n   * Initialize the Hive Mind and all subsystems\r\n   */\r\n  async initialize(): Promise<string> {\r\n    try {\r\n      // Initialize database\r\n      this.db = await DatabaseManager.getInstance();\r\n\r\n      // Create swarm in database\r\n      await this.db.createSwarm({\r\n        id: this.id,\r\n        name: this.config.name,\r\n        topology: this.config.topology,\r\n        queenMode: this.config.queenMode,\r\n        maxAgents: this.config.maxAgents,\r\n        consensusThreshold: this.config.consensusThreshold,\r\n        memoryTTL: this.config.memoryTTL,\r\n        config: JSON.stringify(this.config),\r\n      });\r\n\r\n      // Initialize Queen\r\n      this.queen = new Queen({\r\n        swarmId: this.id,\r\n        mode: this.config.queenMode,\r\n        topology: this.config.topology,\r\n      });\r\n\r\n      // Initialize subsystems\r\n      this.memory = new Memory(this.id);\r\n      this.communication = new Communication(this.id);\r\n      this.orchestrator = new SwarmOrchestrator(this);\r\n      this.consensus = new ConsensusEngine(this.config.consensusThreshold);\r\n\r\n      // Initialize subsystems\r\n      await Promise.all([\r\n        this.queen.initialize(),\r\n        this.memory.initialize(),\r\n        this.communication.initialize(),\r\n        this.orchestrator.initialize(),\r\n      ]);\r\n\r\n      // Set as active swarm\r\n      await this.db.setActiveSwarm(this.id);\r\n\r\n      // Auto-spawn agents if configured\r\n      if (this.config.autoSpawn) {\r\n        await this.autoSpawnAgents();\r\n      }\r\n\r\n      this.started = true;\r\n      this.emit('initialized', { swarmId: this.id });\r\n\r\n      return this.id;\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load an existing Hive Mind from the database\r\n   */\r\n  static async load(swarmId: string): Promise<HiveMind> {\r\n    const db = await DatabaseManager.getInstance();\r\n    const swarmData = await db.getSwarm(swarmId);\r\n\r\n    if (!swarmData) {\r\n      throw new Error(`Swarm ${swarmId} not found`);\r\n    }\r\n\r\n    const config = JSON.parse(swarmData.config);\r\n    const hiveMind = new HiveMind(config);\r\n    hiveMind.id = swarmId;\r\n\r\n    await hiveMind.initialize();\r\n\r\n    // Load existing agents\r\n    const agents = await db.getAgents(swarmId);\r\n    for (const agentData of agents) {\r\n      const agent = new Agent({\r\n        id: agentData.id,\r\n        name: agentData.name,\r\n        type: agentData.type,\r\n        swarmId: swarmId,\r\n        capabilities: JSON.parse(agentData.capabilities),\r\n      });\r\n\r\n      await agent.initialize();\r\n      hiveMind.agents.set(agent.id, agent);\r\n    }\r\n\r\n    return hiveMind;\r\n  }\r\n\r\n  /**\r\n   * Auto-spawn initial agents based on topology\r\n   */\r\n  async autoSpawnAgents(): Promise<Agent[]> {\r\n    const topologyConfigs = {\r\n      hierarchical: [\r\n        { type: 'coordinator', count: 1 },\r\n        { type: 'researcher', count: 2 },\r\n        { type: 'coder', count: 2 },\r\n        { type: 'analyst', count: 1 },\r\n        { type: 'tester', count: 1 },\r\n      ],\r\n      mesh: [\r\n        { type: 'coordinator', count: 2 },\r\n        { type: 'researcher', count: 2 },\r\n        { type: 'coder', count: 2 },\r\n        { type: 'specialist', count: 2 },\r\n      ],\r\n      ring: [\r\n        { type: 'coordinator', count: 1 },\r\n        { type: 'coder', count: 3 },\r\n        { type: 'reviewer', count: 2 },\r\n      ],\r\n      star: [\r\n        { type: 'coordinator', count: 1 },\r\n        { type: 'specialist', count: 4 },\r\n      ],\r\n      // Maestro specs-driven topology\r\n      'specs-driven': [\r\n        { type: 'requirements_analyst', count: 1 },\r\n        { type: 'design_architect', count: 2 },\r\n        { type: 'task_planner', count: 1 },\r\n        { type: 'implementation_coder', count: 2 },\r\n        { type: 'quality_reviewer', count: 1 },\r\n        { type: 'steering_documenter', count: 1 },\r\n      ],\r\n    };\r\n\r\n    const config = topologyConfigs[this.config.topology];\r\n    const spawnedAgents: Agent[] = [];\r\n\r\n    for (const agentConfig of config) {\r\n      for (let i = 0; i < agentConfig.count; i++) {\r\n        const agent = await this.spawnAgent({\r\n          type: agentConfig.type as AgentType,\r\n          name: `${agentConfig.type}-${i + 1}`,\r\n        });\r\n        spawnedAgents.push(agent);\r\n      }\r\n    }\r\n\r\n    return spawnedAgents;\r\n  }\r\n\r\n  /**\r\n   * Spawn a new agent into the swarm\r\n   */\r\n  async spawnAgent(options: AgentSpawnOptions): Promise<Agent> {\r\n    if (this.agents.size >= this.config.maxAgents) {\r\n      throw new Error('Maximum agent limit reached');\r\n    }\r\n\r\n    const agent = new Agent({\r\n      name: options.name || `${options.type}-${Date.now()}`,\r\n      type: options.type,\r\n      swarmId: this.id,\r\n      capabilities: options.capabilities || this.getDefaultCapabilities(options.type),\r\n    });\r\n\r\n    await agent.initialize();\r\n\r\n    // Register with Queen\r\n    await this.queen.registerAgent(agent);\r\n\r\n    // Store in database\r\n    await this.db.createAgent({\r\n      id: agent.id,\r\n      swarmId: this.id,\r\n      name: agent.name,\r\n      type: agent.type,\r\n      capabilities: JSON.stringify(agent.capabilities),\r\n      status: 'idle',\r\n    });\r\n\r\n    // Add to local map\r\n    this.agents.set(agent.id, agent);\r\n\r\n    // Setup communication channels\r\n    this.communication.addAgent(agent);\r\n\r\n    // Auto-assign to pending tasks if configured\r\n    if (options.autoAssign) {\r\n      await this.assignPendingTasksToAgent(agent);\r\n    }\r\n\r\n    this.emit('agentSpawned', { agent });\r\n\r\n    return agent;\r\n  }\r\n\r\n  /**\r\n   * Submit a task to the Hive Mind\r\n   */\r\n  async submitTask(options: TaskSubmitOptions): Promise<Task> {\r\n    const task: Task = {\r\n      id: uuidv4(),\r\n      swarmId: this.id,\r\n      description: options.description,\r\n      priority: options.priority,\r\n      strategy: options.strategy,\r\n      status: 'pending',\r\n      progress: 0,\r\n      dependencies: options.dependencies || [],\r\n      assignedAgents: [],\r\n      requireConsensus: options.requireConsensus || false,\r\n      maxAgents: options.maxAgents || 3,\r\n      requiredCapabilities: options.requiredCapabilities || [],\r\n      createdAt: new Date(),\r\n      metadata: options.metadata || {},\r\n    };\r\n\r\n    // Store in database\r\n    await this.db.createTask({\r\n      ...task,\r\n      dependencies: JSON.stringify(task.dependencies),\r\n      assignedAgents: JSON.stringify(task.assignedAgents),\r\n      requiredCapabilities: JSON.stringify(task.requiredCapabilities),\r\n      metadata: JSON.stringify(task.metadata),\r\n    });\r\n\r\n    // Submit to orchestrator\r\n    await this.orchestrator.submitTask(task);\r\n\r\n    // Notify Queen\r\n    await this.queen.onTaskSubmitted(task);\r\n\r\n    this.emit('taskSubmitted', { task });\r\n\r\n    return task;\r\n  }\r\n\r\n  /**\r\n   * Get full status of the Hive Mind\r\n   */\r\n  async getFullStatus(): Promise<SwarmStatus> {\r\n    const agents = Array.from(this.agents.values());\r\n    const tasks = await this.db.getTasks(this.id);\r\n    const memoryStats = await this.memory.getStats();\r\n    const communicationStats = await this.communication.getStats();\r\n\r\n    // Calculate agent statistics\r\n    const agentsByType = agents.reduce(\r\n      (acc, agent) => {\r\n        acc[agent.type] = (acc[agent.type] || 0) + 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, number>,\r\n    );\r\n\r\n    // Calculate task statistics\r\n    const taskStats = {\r\n      total: tasks.length,\r\n      pending: tasks.filter((t) => t.status === 'pending').length,\r\n      inProgress: tasks.filter((t) => t.status === 'in_progress').length,\r\n      completed: tasks.filter((t) => t.status === 'completed').length,\r\n      failed: tasks.filter((t) => t.status === 'failed').length,\r\n    };\r\n\r\n    // Calculate performance metrics\r\n    const performance = await this.calculatePerformanceMetrics();\r\n\r\n    // Determine health status\r\n    const health = this.determineHealth(agents, tasks, performance);\r\n\r\n    // Get any warnings\r\n    const warnings = this.getSystemWarnings(agents, tasks, performance);\r\n\r\n    return {\r\n      swarmId: this.id,\r\n      name: this.config.name,\r\n      topology: this.config.topology,\r\n      queenMode: this.config.queenMode,\r\n      health,\r\n      uptime: Date.now() - this.startTime,\r\n      agents: agents.map((a) => ({\r\n        id: a.id,\r\n        name: a.name,\r\n        type: a.type,\r\n        status: a.status,\r\n        currentTask: a.currentTask,\r\n        messageCount: a.messageCount,\r\n        createdAt: a.createdAt.getTime(),\r\n      })),\r\n      agentsByType,\r\n      tasks: tasks.map((t) => ({\r\n        id: t.id,\r\n        description: t.description,\r\n        status: t.status,\r\n        priority: t.priority,\r\n        progress: t.progress,\r\n        assignedAgent: t.assigned_agents ? JSON.parse(t.assigned_agents)[0] : null,\r\n      })),\r\n      taskStats,\r\n      memoryStats,\r\n      communicationStats,\r\n      performance,\r\n      warnings,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get basic statistics\r\n   */\r\n  async getStats() {\r\n    const agents = Array.from(this.agents.values());\r\n    const tasks = await this.db.getTasks(this.id);\r\n\r\n    return {\r\n      totalAgents: agents.length,\r\n      activeAgents: agents.filter((a) => a.status === 'busy').length,\r\n      pendingTasks: tasks.filter((t) => t.status === 'pending').length,\r\n      availableCapacity: Math.round(\r\n        (1 - agents.filter((a) => a.status === 'busy').length / agents.length) * 100,\r\n      ),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get list of agents\r\n   */\r\n  async getAgents(): Promise<Agent[]> {\r\n    return Array.from(this.agents.values());\r\n  }\r\n\r\n  /**\r\n   * Get list of tasks\r\n   */\r\n  async getTasks(): Promise<any[]> {\r\n    return this.db.getTasks(this.id);\r\n  }\r\n\r\n  /**\r\n   * Get specific task\r\n   */\r\n  async getTask(taskId: string): Promise<any> {\r\n    return this.db.getTask(taskId);\r\n  }\r\n\r\n  /**\r\n   * Cancel a task\r\n   */\r\n  async cancelTask(taskId: string): Promise<void> {\r\n    await this.orchestrator.cancelTask(taskId);\r\n    await this.db.updateTaskStatus(taskId, 'cancelled');\r\n    this.emit('taskCancelled', { taskId });\r\n  }\r\n\r\n  /**\r\n   * Retry a failed task\r\n   */\r\n  async retryTask(taskId: string): Promise<Task> {\r\n    const originalTask = await this.db.getTask(taskId);\r\n    if (!originalTask) {\r\n      throw new Error('Task not found');\r\n    }\r\n\r\n    const newTask = await this.submitTask({\r\n      description: originalTask.description + ' (Retry)',\r\n      priority: originalTask.priority,\r\n      strategy: originalTask.strategy,\r\n      dependencies: [],\r\n      requireConsensus: originalTask.require_consensus,\r\n      maxAgents: originalTask.max_agents,\r\n      requiredCapabilities: JSON.parse(originalTask.required_capabilities || '[]'),\r\n      metadata: {\r\n        ...JSON.parse(originalTask.metadata || '{}'),\r\n        retryOf: taskId,\r\n      },\r\n    });\r\n\r\n    return newTask;\r\n  }\r\n\r\n  /**\r\n   * Rebalance agents across tasks\r\n   */\r\n  async rebalanceAgents(): Promise<void> {\r\n    await this.orchestrator.rebalance();\r\n    this.emit('agentsRebalanced');\r\n  }\r\n\r\n  /**\r\n   * Shutdown the Hive Mind\r\n   */\r\n  async shutdown(): Promise<void> {\r\n    this.started = false;\r\n\r\n    // Shutdown all agents\r\n    for (const agent of this.agents.values()) {\r\n      await agent.shutdown();\r\n    }\r\n\r\n    // Shutdown subsystems\r\n    await Promise.all([\r\n      this.queen.shutdown(),\r\n      this.memory.shutdown(),\r\n      this.communication.shutdown(),\r\n      this.orchestrator.shutdown(),\r\n    ]);\r\n\r\n    this.emit('shutdown');\r\n  }\r\n\r\n  // Private helper methods\r\n\r\n  private getDefaultCapabilities(type: AgentType): string[] {\r\n    const capabilityMap: Record<AgentType, string[]> = {\r\n      coordinator: ['task_management', 'resource_allocation', 'consensus_building'],\r\n      researcher: ['information_gathering', 'pattern_recognition', 'knowledge_synthesis'],\r\n      coder: ['code_generation', 'refactoring', 'debugging'],\r\n      analyst: ['data_analysis', 'performance_metrics', 'bottleneck_detection'],\r\n      architect: ['system_design', 'architecture_patterns', 'integration_planning'],\r\n      tester: ['test_generation', 'quality_assurance', 'edge_case_detection'],\r\n      reviewer: ['code_review', 'standards_enforcement', 'best_practices'],\r\n      optimizer: ['performance_optimization', 'resource_optimization', 'algorithm_improvement'],\r\n      documenter: ['documentation_generation', 'api_docs', 'user_guides'],\r\n      monitor: ['system_monitoring', 'health_checks', 'alerting'],\r\n      specialist: ['domain_expertise', 'custom_capabilities', 'problem_solving'],\r\n      // Maestro specs-driven agent capabilities\r\n      requirements_analyst: ['requirements_analysis', 'user_story_creation', 'acceptance_criteria'],\r\n      design_architect: ['system_design', 'architecture', 'technical_writing', 'specs_driven_design'],\r\n      task_planner: ['task_management', 'workflow_orchestration', 'project_management'],\r\n      implementation_coder: ['code_generation', 'implementation', 'debugging', 'refactoring'],\r\n      quality_reviewer: ['code_review', 'quality_assurance', 'testing', 'standards_enforcement'],\r\n      steering_documenter: ['documentation_generation', 'governance', 'technical_writing'],\r\n    };\r\n\r\n    return capabilityMap[type] || [];\r\n  }\r\n\r\n  private async assignPendingTasksToAgent(agent: Agent): Promise<void> {\r\n    const pendingTasks = await this.db.getPendingTasks(this.id);\r\n\r\n    for (const task of pendingTasks) {\r\n      const requiredCapabilities = JSON.parse(task.required_capabilities || '[]');\r\n\r\n      // Check if agent has required capabilities\r\n      if (requiredCapabilities.every((cap: string) => agent.capabilities.includes(cap))) {\r\n        await this.orchestrator.assignTaskToAgent(task.id, agent.id);\r\n        break; // Only assign one task at a time\r\n      }\r\n    }\r\n  }\r\n\r\n  private async calculatePerformanceMetrics() {\r\n    // This would calculate real metrics from the database\r\n    return {\r\n      avgTaskCompletion: 3500,\r\n      messageThroughput: 120,\r\n      consensusSuccessRate: 92,\r\n      memoryHitRate: 85,\r\n      agentUtilization: 78,\r\n    };\r\n  }\r\n\r\n  private determineHealth(agents: Agent[], tasks: any[], performance: any): string {\r\n    if (agents.length === 0) return 'critical';\r\n\r\n    const busyAgents = agents.filter((a) => a.status === 'busy').length;\r\n    const utilization = busyAgents / agents.length;\r\n\r\n    if (utilization > 0.9) return 'degraded';\r\n    if (performance.consensusSuccessRate < 50) return 'degraded';\r\n    if (agents.filter((a) => a.status === 'error').length > agents.length * 0.2) return 'critical';\r\n\r\n    return 'healthy';\r\n  }\r\n\r\n  private getSystemWarnings(agents: Agent[], tasks: any[], performance: any): string[] {\r\n    const warnings: string[] = [];\r\n\r\n    const utilization = agents.filter((a) => a.status === 'busy').length / agents.length;\r\n    if (utilization > 0.8) {\r\n      warnings.push('High agent utilization - consider spawning more agents');\r\n    }\r\n\r\n    const pendingTasks = tasks.filter((t) => t.status === 'pending').length;\r\n    if (pendingTasks > agents.length * 2) {\r\n      warnings.push('Large task backlog - tasks may be delayed');\r\n    }\r\n\r\n    if (performance.memoryHitRate < 60) {\r\n      warnings.push('Low memory hit rate - consider optimizing memory usage');\r\n    }\r\n\r\n    return warnings;\r\n  }\r\n}\r\n"],"names":["EventEmitter","v4","uuidv4","Queen","Agent","Memory","Communication","DatabaseManager","SwarmOrchestrator","ConsensusEngine","HiveMind","id","config","queen","agents","memory","communication","orchestrator","consensus","db","started","startTime","Map","Date","now","initialize","getInstance","createSwarm","name","topology","queenMode","maxAgents","consensusThreshold","memoryTTL","JSON","stringify","swarmId","mode","Promise","all","setActiveSwarm","autoSpawn","autoSpawnAgents","emit","error","load","swarmData","getSwarm","Error","parse","hiveMind","getAgents","agentData","agent","type","capabilities","set","topologyConfigs","hierarchical","count","mesh","ring","star","spawnedAgents","agentConfig","i","spawnAgent","push","options","size","getDefaultCapabilities","registerAgent","createAgent","status","addAgent","autoAssign","assignPendingTasksToAgent","submitTask","task","description","priority","strategy","progress","dependencies","assignedAgents","requireConsensus","requiredCapabilities","createdAt","metadata","createTask","onTaskSubmitted","getFullStatus","Array","from","values","tasks","getTasks","memoryStats","getStats","communicationStats","agentsByType","reduce","acc","taskStats","total","length","pending","filter","t","inProgress","completed","failed","performance","calculatePerformanceMetrics","health","determineHealth","warnings","getSystemWarnings","uptime","map","a","currentTask","messageCount","getTime","assignedAgent","assigned_agents","totalAgents","activeAgents","pendingTasks","availableCapacity","Math","round","getTask","taskId","cancelTask","updateTaskStatus","retryTask","originalTask","newTask","require_consensus","max_agents","required_capabilities","retryOf","rebalanceAgents","rebalance","shutdown","capabilityMap","coordinator","researcher","coder","analyst","architect","tester","reviewer","optimizer","documenter","monitor","specialist","requirements_analyst","design_architect","task_planner","implementation_coder","quality_reviewer","steering_documenter","getPendingTasks","every","cap","includes","assignTaskToAgent","avgTaskCompletion","messageThroughput","consensusSuccessRate","memoryHitRate","agentUtilization","busyAgents","utilization"],"mappings":"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"}
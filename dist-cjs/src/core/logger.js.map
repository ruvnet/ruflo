{"version":3,"sources":["../../../src/core/logger.ts"],"sourcesContent":["/**\r\n * Logging infrastructure for Claude-Flow\r\n */\r\n\r\nimport { promises as fs } from 'node:fs';\r\nimport * as path from 'node:path';\r\nimport { Buffer } from 'node:buffer';\r\nimport process from 'node:process';\r\nimport type { LoggingConfig } from '../utils/types.js';\r\nimport { formatBytes } from '../utils/helpers.js';\r\n\r\nexport interface ILogger {\r\n  debug(message: string, meta?: unknown): void;\r\n  info(message: string, meta?: unknown): void;\r\n  warn(message: string, meta?: unknown): void;\r\n  error(message: string, error?: unknown): void;\r\n  configure(config: LoggingConfig): Promise<void>;\r\n  level?: string;\r\n}\r\n\r\nexport enum LogLevel {\r\n  DEBUG = 0,\r\n  INFO = 1,\r\n  WARN = 2,\r\n  ERROR = 3,\r\n}\r\n\r\ninterface LogEntry {\r\n  timestamp: string;\r\n  level: string;\r\n  message: string;\r\n  context: Record<string, unknown>;\r\n  data?: unknown;\r\n  error?: unknown;\r\n}\r\n\r\n/**\r\n * Logger implementation with context support\r\n */\r\nexport class Logger implements ILogger {\r\n  private static instance: Logger;\r\n  private config: LoggingConfig;\r\n  private context: Record<string, unknown>;\r\n  private fileHandle?: fs.FileHandle;\r\n  private currentFileSize = 0;\r\n  private currentFileIndex = 0;\r\n  private isClosing = false;\r\n\r\n  get level(): string {\r\n    return this.config.level;\r\n  }\r\n\r\n  constructor(\r\n    config: LoggingConfig = {\r\n      level: 'info',\r\n      format: 'json',\r\n      destination: 'console',\r\n    },\r\n    context: Record<string, unknown> = {},\r\n  ) {\r\n    // Validate file path if file destination\r\n    if ((config.destination === 'file' || config.destination === 'both') && !config.filePath) {\r\n      throw new Error('File path required for file logging');\r\n    }\r\n\r\n    this.config = config;\r\n    this.context = context;\r\n  }\r\n\r\n  /**\r\n   * Gets the singleton instance of the logger\r\n   */\r\n  static getInstance(config?: LoggingConfig): Logger {\r\n    if (!Logger.instance) {\r\n      if (!config) {\r\n        // Use default config if none provided\r\n        const isTestEnv = process.env.CLAUDE_FLOW_ENV === 'test';\r\n        config = {\r\n          level: isTestEnv ? 'error' : 'info', // Quieter logging in tests\r\n          format: 'json',\r\n          destination: isTestEnv ? 'null' : 'console', // Suppress output in tests\r\n        };\r\n      }\r\n      Logger.instance = new Logger(config);\r\n    }\r\n    return Logger.instance;\r\n  }\r\n\r\n  /**\r\n   * Updates logger configuration\r\n   */\r\n  async configure(config: LoggingConfig): Promise<void> {\r\n    this.config = config;\r\n\r\n    // Reset file handle if destination changed\r\n    if (this.fileHandle && config.destination !== 'file' && config.destination !== 'both') {\r\n      await this.fileHandle.close();\r\n      delete this.fileHandle;\r\n    }\r\n  }\r\n\r\n  debug(message: string, meta?: unknown): void {\r\n    this.log(LogLevel.DEBUG, message, meta);\r\n  }\r\n\r\n  info(message: string, meta?: unknown): void {\r\n    this.log(LogLevel.INFO, message, meta);\r\n  }\r\n\r\n  warn(message: string, meta?: unknown): void {\r\n    this.log(LogLevel.WARN, message, meta);\r\n  }\r\n\r\n  error(message: string, error?: unknown): void {\r\n    this.log(LogLevel.ERROR, message, undefined, error);\r\n  }\r\n\r\n  /**\r\n   * Creates a child logger with additional context\r\n   */\r\n  child(context: Record<string, unknown>): Logger {\r\n    return new Logger(this.config, { ...this.context, ...context });\r\n  }\r\n\r\n  /**\r\n   * Properly close the logger and release resources\r\n   */\r\n  async close(): Promise<void> {\r\n    this.isClosing = true;\r\n    if (this.fileHandle) {\r\n      try {\r\n        await this.fileHandle.close();\r\n      } catch (error) {\r\n        console.error('Error closing log file handle:', error);\r\n      } finally {\r\n        delete this.fileHandle;\r\n      }\r\n    }\r\n  }\r\n\r\n  private log(level: LogLevel, message: string, data?: unknown, error?: unknown): void {\r\n    if (!this.shouldLog(level)) {\r\n      return;\r\n    }\r\n\r\n    const entry: LogEntry = {\r\n      timestamp: new Date().toISOString(),\r\n      level: LogLevel[level],\r\n      message,\r\n      context: this.context,\r\n      data,\r\n      error,\r\n    };\r\n\r\n    const formatted = this.format(entry);\r\n\r\n    if (this.config.destination === 'console' || this.config.destination === 'both') {\r\n      this.writeToConsole(level, formatted);\r\n    }\r\n\r\n    if (this.config.destination === 'file' || this.config.destination === 'both') {\r\n      this.writeToFile(formatted);\r\n    }\r\n  }\r\n\r\n  private shouldLog(level: LogLevel): boolean {\r\n    const configLevel = LogLevel[this.config.level.toUpperCase() as keyof typeof LogLevel];\r\n    return level >= configLevel;\r\n  }\r\n\r\n  private format(entry: LogEntry): string {\r\n    if (this.config.format === 'json') {\r\n      // Handle error serialization for JSON format\r\n      const jsonEntry = { ...entry };\r\n      if (jsonEntry.error instanceof Error) {\r\n        jsonEntry.error = {\r\n          name: jsonEntry.error.name,\r\n          message: jsonEntry.error.message,\r\n          stack: jsonEntry.error.stack,\r\n        };\r\n      }\r\n      return JSON.stringify(jsonEntry);\r\n    }\r\n\r\n    // Text format\r\n    const contextStr =\r\n      Object.keys(entry.context).length > 0 ? ` ${JSON.stringify(entry.context)}` : '';\r\n    const dataStr = entry.data !== undefined ? ` ${JSON.stringify(entry.data)}` : '';\r\n    const errorStr =\r\n      entry.error !== undefined\r\n        ? entry.error instanceof Error\r\n          ? `\\n  Error: ${entry.error.message}\\n  Stack: ${entry.error.stack}`\r\n          : ` Error: ${JSON.stringify(entry.error)}`\r\n        : '';\r\n\r\n    return `[${entry.timestamp}] ${entry.level} ${entry.message}${contextStr}${dataStr}${errorStr}`;\r\n  }\r\n\r\n  private writeToConsole(level: LogLevel, message: string): void {\r\n    switch (level) {\r\n      case LogLevel.DEBUG:\r\n        console.debug(message);\r\n        break;\r\n      case LogLevel.INFO:\r\n        console.info(message);\r\n        break;\r\n      case LogLevel.WARN:\r\n        console.warn(message);\r\n        break;\r\n      case LogLevel.ERROR:\r\n        console.error(message);\r\n        break;\r\n    }\r\n  }\r\n\r\n  private async writeToFile(message: string): Promise<void> {\r\n    if (!this.config.filePath || this.isClosing) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Check if we need to rotate the log file\r\n      if (await this.shouldRotate()) {\r\n        await this.rotate();\r\n      }\r\n\r\n      // Open file handle if not already open\r\n      if (!this.fileHandle) {\r\n        this.fileHandle = await fs.open(this.config.filePath, 'a');\r\n      }\r\n\r\n      // Write the message\r\n      const data = Buffer.from(message + '\\n', 'utf8');\r\n      await this.fileHandle.write(data);\r\n      this.currentFileSize += data.length;\r\n    } catch (error) {\r\n      console.error('Failed to write to log file:', error);\r\n    }\r\n  }\r\n\r\n  private async shouldRotate(): Promise<boolean> {\r\n    if (!this.config.maxFileSize || !this.config.filePath) {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const stat = await fs.stat(this.config.filePath);\r\n      return stat.size >= this.config.maxFileSize;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async rotate(): Promise<void> {\r\n    if (!this.config.filePath || !this.config.maxFiles) {\r\n      return;\r\n    }\r\n\r\n    // Close current file\r\n    if (this.fileHandle) {\r\n      await this.fileHandle.close();\r\n      delete this.fileHandle;\r\n    }\r\n\r\n    // Rename current file\r\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\r\n    const rotatedPath = `${this.config.filePath}.${timestamp}`;\r\n    await fs.rename(this.config.filePath, rotatedPath);\r\n\r\n    // Clean up old files\r\n    await this.cleanupOldFiles();\r\n\r\n    // Reset file size\r\n    this.currentFileSize = 0;\r\n  }\r\n\r\n  private async cleanupOldFiles(): Promise<void> {\r\n    if (!this.config.filePath || !this.config.maxFiles) {\r\n      return;\r\n    }\r\n\r\n    const dir = path.dirname(this.config.filePath);\r\n    const baseFileName = path.basename(this.config.filePath);\r\n\r\n    try {\r\n      const entries = await fs.readdir(dir, { withFileTypes: true });\r\n      const files: string[] = [];\r\n\r\n      for (const entry of entries) {\r\n        if (entry.isFile() && entry.name.startsWith(baseFileName + '.')) {\r\n          files.push(entry.name);\r\n        }\r\n      }\r\n\r\n      // Sort files by timestamp (newest first)\r\n      files.sort().reverse();\r\n\r\n      // Remove old files\r\n      const filesToRemove = files.slice(this.config.maxFiles - 1);\r\n      for (const file of filesToRemove) {\r\n        await fs.unlink(path.join(dir, file));\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to cleanup old log files:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance with lazy initialization\r\nexport const logger = Logger.getInstance();\r\n"],"names":["promises","fs","path","Buffer","process","LogLevel","Logger","instance","config","context","fileHandle","currentFileSize","currentFileIndex","isClosing","level","format","destination","filePath","Error","getInstance","isTestEnv","env","CLAUDE_FLOW_ENV","configure","close","debug","message","meta","log","info","warn","error","undefined","child","console","data","shouldLog","entry","timestamp","Date","toISOString","formatted","writeToConsole","writeToFile","configLevel","toUpperCase","jsonEntry","name","stack","JSON","stringify","contextStr","Object","keys","length","dataStr","errorStr","shouldRotate","rotate","open","from","write","maxFileSize","stat","size","maxFiles","replace","rotatedPath","rename","cleanupOldFiles","dir","dirname","baseFileName","basename","entries","readdir","withFileTypes","files","isFile","startsWith","push","sort","reverse","filesToRemove","slice","file","unlink","join","logger"],"mappings":"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"}
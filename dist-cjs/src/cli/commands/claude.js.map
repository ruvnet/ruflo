{"version":3,"sources":["../../../../src/cli/commands/claude.ts"],"sourcesContent":["/**\r\n * Claude instance management commands\r\n */\r\nimport { promises as fs } from 'node:fs';\r\n\r\nimport { Command } from '../commander-fix.js';\r\nimport chalk from 'chalk';\r\nimport { spawn } from 'node:child_process';\r\nimport { generateId } from '../../utils/helpers.js';\r\n\r\nexport const claudeCommand = new Command()\r\n  .name('claude')\r\n  .description('Manage Claude instances')\r\n  .action(() => {\r\n    claudeCommand.help();\r\n  });\r\n\r\n// Spawn command\r\nclaudeCommand\r\n  .command('spawn')\r\n  .description('Spawn a new Claude instance with specific configuration')\r\n  .arguments('<task>')\r\n  .option(\r\n    '-t, --tools <tools>',\r\n    'Allowed tools (comma-separated)',\r\n    'View,Edit,Replace,GlobTool,GrepTool,LS,Bash',\r\n  )\r\n  .option('--no-permissions', 'Use --dangerously-skip-permissions flag')\r\n  .option('-c, --config <config>', 'MCP config file path')\r\n  .option(\r\n    '-m, --mode <mode>',\r\n    'Development mode (full, backend-only, frontend-only, api-only)',\r\n    'full',\r\n  )\r\n  .option('--parallel', 'Enable parallel execution with BatchTool')\r\n  .option('--research', 'Enable web research with WebFetchTool')\r\n  .option('--coverage <coverage>', 'Test coverage target', '80')\r\n  .option('--commit <frequency>', 'Commit frequency (phase, feature, manual)', 'phase')\r\n  .option('-v, --verbose', 'Enable verbose output')\r\n  .option('--dry-run', 'Show what would be executed without running')\r\n  .action(async (task: string, options: any) => {\r\n    try {\r\n      const instanceId = generateId('claude');\r\n\r\n      // Build allowed tools list\r\n      let tools = options.tools;\r\n      if (options.parallel && !tools.includes('BatchTool')) {\r\n        tools += ',BatchTool,dispatch_agent';\r\n      }\r\n      if (options.research && !tools.includes('WebFetchTool')) {\r\n        tools += ',WebFetchTool';\r\n      }\r\n\r\n      // Build Claude command\r\n      const claudeArgs = [task];\r\n      claudeArgs.push('--allowedTools', tools);\r\n\r\n      if (options.noPermissions) {\r\n        claudeArgs.push('--dangerously-skip-permissions');\r\n      }\r\n\r\n      if (options.config) {\r\n        claudeArgs.push('--mcp-config', options.config);\r\n      }\r\n\r\n      if (options.verbose) {\r\n        claudeArgs.push('--verbose');\r\n      }\r\n\r\n      if (options.dryRun) {\r\n        console.log(chalk.yellow('DRY RUN - Would execute:'));\r\n        console.log(chalk.gray(`claude ${claudeArgs.join(' ')}`));\r\n        console.log('\\nConfiguration:');\r\n        console.log(`  Instance ID: ${instanceId}`);\r\n        console.log(`  Task: ${task}`);\r\n        console.log(`  Tools: ${tools}`);\r\n        console.log(`  Mode: ${options.mode}`);\r\n        console.log(`  Coverage: ${parseInt(options.coverage)}%`);\r\n        console.log(`  Commit: ${options.commit}`);\r\n        return;\r\n      }\r\n\r\n      console.log(chalk.green(`Spawning Claude instance: ${instanceId}`));\r\n      console.log(chalk.gray(`Task: ${task}`));\r\n      console.log(chalk.gray(`Tools: ${tools}`));\r\n\r\n      // Spawn Claude process\r\n      const claude = spawn('claude', claudeArgs, {\r\n        stdio: 'inherit',\r\n        env: {\r\n          ...process.env,\r\n          CLAUDE_INSTANCE_ID: instanceId,\r\n          CLAUDE_FLOW_MODE: options.mode,\r\n          CLAUDE_FLOW_COVERAGE: parseInt(options.coverage).toString(),\r\n          CLAUDE_FLOW_COMMIT: options.commit,\r\n        },\r\n      });\r\n\r\n      claude.on('error', (err) => {\r\n        console.error(chalk.red('Failed to spawn Claude:'), err.message);\r\n      });\r\n\r\n      claude.on('exit', (code) => {\r\n        if (code === 0) {\r\n          console.log(chalk.green(`Claude instance ${instanceId} completed successfully`));\r\n        } else {\r\n          console.log(chalk.red(`Claude instance ${instanceId} exited with code ${code}`));\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error(chalk.red('Failed to spawn Claude:'), (error as Error).message);\r\n    }\r\n  });\r\n\r\n// Batch command\r\nclaudeCommand\r\n  .command('batch')\r\n  .description('Spawn multiple Claude instances from workflow')\r\n  .arguments('<workflow-file>')\r\n  .option('--dry-run', 'Show what would be executed without running')\r\n  .action(async (workflowFile: string, options: any) => {\r\n    try {\r\n      const content = await fs.readFile(workflowFile, 'utf-8');\r\n      const workflow = JSON.parse(content);\r\n\r\n      console.log(chalk.green('Loading workflow:'), workflow.name || 'Unnamed');\r\n      console.log(chalk.gray(`Tasks: ${workflow.tasks?.length || 0}`));\r\n\r\n      if (!workflow.tasks || workflow.tasks.length === 0) {\r\n        console.log(chalk.yellow('No tasks found in workflow'));\r\n        return;\r\n      }\r\n\r\n      for (const task of workflow.tasks) {\r\n        const claudeArgs = [task.description || task.name];\r\n\r\n        // Add tools\r\n        if (task.tools) {\r\n          claudeArgs.push(\r\n            '--allowedTools',\r\n            Array.isArray(task.tools) ? task.tools.join(',') : task.tools,\r\n          );\r\n        }\r\n\r\n        // Add flags\r\n        if (task.skipPermissions) {\r\n          claudeArgs.push('--dangerously-skip-permissions');\r\n        }\r\n\r\n        if (task.config) {\r\n          claudeArgs.push('--mcp-config', task.config);\r\n        }\r\n\r\n        if (options.dryRun) {\r\n          console.log(chalk.yellow(`\\nDRY RUN - Task: ${task.name || task.id}`));\r\n          console.log(chalk.gray(`claude ${claudeArgs.join(' ')}`));\r\n        } else {\r\n          console.log(chalk.blue(`\\nSpawning Claude for task: ${task.name || task.id}`));\r\n\r\n          const claude = spawn('claude', claudeArgs, {\r\n            stdio: 'inherit',\r\n            env: {\r\n              ...process.env,\r\n              CLAUDE_TASK_ID: task.id || generateId('task'),\r\n              CLAUDE_TASK_TYPE: task.type || 'general',\r\n            },\r\n          });\r\n\r\n          // Wait for completion if sequential\r\n          if (!workflow.parallel) {\r\n            await new Promise((resolve) => {\r\n              claude.on('exit', resolve);\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!options.dryRun && workflow.parallel) {\r\n        console.log(chalk.green('\\nAll Claude instances spawned in parallel mode'));\r\n      }\r\n    } catch (error) {\r\n      console.error(chalk.red('Failed to process workflow:'), (error as Error).message);\r\n    }\r\n  });\r\n"],"names":["promises","fs","Command","chalk","spawn","generateId","claudeCommand","name","description","action","help","command","arguments","option","task","options","instanceId","tools","parallel","includes","research","claudeArgs","push","noPermissions","config","verbose","dryRun","console","log","yellow","gray","join","mode","parseInt","coverage","commit","green","claude","stdio","env","process","CLAUDE_INSTANCE_ID","CLAUDE_FLOW_MODE","CLAUDE_FLOW_COVERAGE","toString","CLAUDE_FLOW_COMMIT","on","err","error","red","message","code","workflowFile","content","readFile","workflow","JSON","parse","tasks","length","Array","isArray","skipPermissions","id","blue","CLAUDE_TASK_ID","CLAUDE_TASK_TYPE","type","Promise","resolve"],"mappings":"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"}
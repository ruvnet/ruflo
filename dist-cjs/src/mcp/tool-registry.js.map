{"version":3,"sources":["../../../src/mcp/tool-registry.ts"],"sourcesContent":["/**\n * Tool Registry for In-Process MCP Server\n *\n * Registers all 50+ Claude-Flow MCP tools for in-process execution.\n * Provides tool discovery, validation, and routing.\n */\n\nimport { createInProcessServer, InProcessMCPServer } from './in-process-server.js';\nimport { createClaudeFlowTools } from './claude-flow-tools.js';\nimport { logger } from '../core/logger.js';\nimport type { MCPTool, MCPToolFilterConfig } from '../utils/types.js';\nimport type { McpSdkServerConfigWithInstance } from '@anthropic-ai/claude-code/sdk.d.ts';\nimport { createToolFilter, IToolFilter, ToolFilterStats } from './tool-filter.js';\n\n// Import SDK tool creation function\nimport { tool, createSdkMcpServer } from '@anthropic-ai/claude-code/sdk';\nimport { z } from 'zod';\n\nexport interface ToolRegistryConfig {\n  enableInProcess: boolean;\n  enableMetrics: boolean;\n  enableCaching: boolean;\n  orchestratorContext?: any;\n  toolFilter?: MCPToolFilterConfig;\n}\n\n/**\n * Global tool registry for managing all MCP tools\n */\nexport class ClaudeFlowToolRegistry {\n  private inProcessServer?: InProcessMCPServer;\n  private sdkServer?: McpSdkServerConfigWithInstance;\n  private tools: Map<string, MCPTool>;\n  private config: ToolRegistryConfig;\n  private toolFilter?: IToolFilter;\n\n  constructor(config: ToolRegistryConfig) {\n    this.config = config;\n    this.tools = new Map();\n\n    // Initialize tool filter if configured\n    if (config.toolFilter?.enabled) {\n      this.toolFilter = createToolFilter(config.toolFilter, logger);\n    }\n\n    logger.info('ClaudeFlowToolRegistry initialized', {\n      enableInProcess: config.enableInProcess,\n      enableMetrics: config.enableMetrics,\n      toolFilterEnabled: config.toolFilter?.enabled ?? false,\n    });\n  }\n\n  /**\n   * Set or update tool filter configuration\n   */\n  setToolFilter(config: MCPToolFilterConfig): void {\n    this.toolFilter = createToolFilter(config, logger);\n    logger.info('Tool filter updated', { mode: config.mode, enabled: config.enabled });\n  }\n\n  /**\n   * Initialize the tool registry with all Claude-Flow tools\n   */\n  async initialize(): Promise<void> {\n    logger.info('Loading Claude-Flow tools...');\n\n    // Load all tools from claude-flow-tools.ts\n    const claudeFlowTools = await createClaudeFlowTools(logger);\n\n    // Register each tool\n    for (const tool of claudeFlowTools) {\n      this.tools.set(tool.name, tool);\n    }\n\n    logger.info(`Loaded ${this.tools.size} Claude-Flow tools`);\n\n    // Create in-process server if enabled\n    if (this.config.enableInProcess) {\n      await this.createInProcessServer();\n    }\n  }\n\n  /**\n   * Create SDK-compatible in-process server\n   */\n  private async createInProcessServer(): Promise<void> {\n    logger.info('Creating in-process MCP server...');\n\n    // Create in-process server\n    this.inProcessServer = createInProcessServer({\n      name: 'claude-flow',\n      version: '2.0.0',\n      enableMetrics: this.config.enableMetrics,\n      enableCaching: this.config.enableCaching,\n    });\n\n    // Register all tools\n    for (const [name, tool] of this.tools) {\n      this.inProcessServer.registerTool(tool);\n    }\n\n    // Set orchestrator context if provided\n    if (this.config.orchestratorContext) {\n      this.inProcessServer.setContext({\n        orchestrator: this.config.orchestratorContext,\n        sessionId: 'in-process-session',\n      });\n    }\n\n    // Create SDK MCP server for integration\n    await this.createSdkServer();\n\n    logger.info('In-process MCP server created', {\n      toolCount: this.inProcessServer.getToolNames().length,\n    });\n  }\n\n  /**\n   * Create SDK-compatible MCP server using SDK's createSdkMcpServer\n   */\n  private async createSdkServer(): Promise<void> {\n    if (!this.inProcessServer) {\n      throw new Error('In-process server not initialized');\n    }\n\n    // Convert Claude-Flow tools to SDK tool format\n    const sdkTools = Array.from(this.tools.values()).map(tool => {\n      return this.convertToSdkTool(tool);\n    });\n\n    // Create SDK MCP server\n    this.sdkServer = createSdkMcpServer({\n      name: 'claude-flow',\n      version: '2.0.0',\n      tools: sdkTools,\n    });\n\n    logger.info('SDK MCP server created', { toolCount: sdkTools.length });\n  }\n\n  /**\n   * Convert Claude-Flow tool to SDK tool format\n   */\n  private convertToSdkTool(mcpTool: MCPTool): any {\n    // Convert JSON Schema to Zod schema\n    const zodSchema = this.jsonSchemaToZod(mcpTool.inputSchema);\n\n    // Create SDK tool using the 'tool' helper\n    return tool(\n      mcpTool.name,\n      mcpTool.description,\n      zodSchema,\n      async (args: any, extra: unknown) => {\n        // Execute via in-process server\n        if (this.inProcessServer) {\n          return await this.inProcessServer.callTool(mcpTool.name, args);\n        }\n\n        // Fallback to direct execution\n        const result = await mcpTool.handler(args, {\n          orchestrator: this.config.orchestratorContext,\n          sessionId: 'sdk-session',\n        });\n\n        return {\n          content: [\n            {\n              type: 'text',\n              text: typeof result === 'string' ? result : JSON.stringify(result, null, 2),\n            },\n          ],\n          isError: false,\n        };\n      }\n    );\n  }\n\n  /**\n   * Convert JSON Schema to Zod schema (simplified)\n   */\n  private jsonSchemaToZod(schema: any): any {\n    const zodSchema: any = {};\n\n    if (!schema.properties) {\n      return {};\n    }\n\n    for (const [key, prop] of Object.entries(schema.properties)) {\n      const p = prop as any;\n\n      // Basic type conversion\n      if (p.type === 'string') {\n        zodSchema[key] = p.enum ? z.enum(p.enum) : z.string();\n        if (p.default !== undefined) {\n          zodSchema[key] = zodSchema[key].default(p.default);\n        }\n        if (!schema.required?.includes(key)) {\n          zodSchema[key] = zodSchema[key].optional();\n        }\n      } else if (p.type === 'number' || p.type === 'integer') {\n        zodSchema[key] = z.number();\n        if (p.default !== undefined) {\n          zodSchema[key] = zodSchema[key].default(p.default);\n        }\n        if (!schema.required?.includes(key)) {\n          zodSchema[key] = zodSchema[key].optional();\n        }\n      } else if (p.type === 'boolean') {\n        zodSchema[key] = z.boolean();\n        if (p.default !== undefined) {\n          zodSchema[key] = zodSchema[key].default(p.default);\n        }\n        if (!schema.required?.includes(key)) {\n          zodSchema[key] = zodSchema[key].optional();\n        }\n      } else if (p.type === 'array') {\n        zodSchema[key] = z.array(z.any());\n        if (!schema.required?.includes(key)) {\n          zodSchema[key] = zodSchema[key].optional();\n        }\n      } else if (p.type === 'object') {\n        zodSchema[key] = z.record(z.any());\n        if (!schema.required?.includes(key)) {\n          zodSchema[key] = zodSchema[key].optional();\n        }\n      } else {\n        // Default to any\n        zodSchema[key] = z.any();\n        if (!schema.required?.includes(key)) {\n          zodSchema[key] = zodSchema[key].optional();\n        }\n      }\n\n      // Add description\n      if (p.description) {\n        zodSchema[key] = zodSchema[key].describe(p.description);\n      }\n    }\n\n    return zodSchema;\n  }\n\n  /**\n   * Get SDK server config for use in query() options\n   */\n  getSdkServerConfig(): McpSdkServerConfigWithInstance | undefined {\n    return this.sdkServer;\n  }\n\n  /**\n   * Get in-process server instance\n   */\n  getInProcessServer(): InProcessMCPServer | undefined {\n    return this.inProcessServer;\n  }\n\n  /**\n   * Get tool by name\n   */\n  getTool(name: string): MCPTool | undefined {\n    return this.tools.get(name);\n  }\n\n  /**\n   * Get all tool names (with filtering applied)\n   */\n  getToolNames(): string[] {\n    let tools = Array.from(this.tools.values());\n\n    if (this.toolFilter) {\n      tools = this.toolFilter.filterTools(tools);\n    }\n\n    return tools.map(t => t.name);\n  }\n\n  /**\n   * Get all tool names (without filtering)\n   */\n  getAllToolNames(): string[] {\n    return Array.from(this.tools.keys());\n  }\n\n  /**\n   * Get filter statistics\n   */\n  getFilterStats(): ToolFilterStats | null {\n    return this.toolFilter?.getFilterStats() ?? null;\n  }\n\n  /**\n   * Check if tool should use in-process execution\n   */\n  shouldUseInProcess(toolName: string): boolean {\n    // All Claude-Flow tools use in-process\n    return this.tools.has(toolName);\n  }\n\n  /**\n   * Route tool call to appropriate transport\n   */\n  async routeToolCall(\n    toolName: string,\n    args: Record<string, unknown>,\n    context?: any\n  ): Promise<any> {\n    const startTime = performance.now();\n\n    try {\n      if (this.shouldUseInProcess(toolName) && this.inProcessServer) {\n        logger.debug('Routing to in-process server', { toolName });\n        const result = await this.inProcessServer.callTool(toolName, args, context);\n        const duration = performance.now() - startTime;\n\n        logger.info('In-process tool call completed', {\n          toolName,\n          duration: `${duration.toFixed(2)}ms`,\n          transport: 'in-process',\n        });\n\n        return result;\n      }\n\n      // External tools would use stdio/SSE (not implemented in this phase)\n      logger.warn('Tool not found in in-process registry', { toolName });\n      throw new Error(`Tool not available: ${toolName}`);\n    } catch (error) {\n      logger.error('Tool routing failed', { toolName, error });\n      throw error;\n    }\n  }\n\n  /**\n   * Get performance metrics\n   */\n  getMetrics() {\n    if (!this.inProcessServer) {\n      return { error: 'In-process server not initialized' };\n    }\n\n    const stats = this.inProcessServer.getStats();\n    const metrics = this.inProcessServer.getMetrics();\n\n    return {\n      stats,\n      recentMetrics: metrics.slice(-10), // Last 10 calls\n      summary: {\n        totalCalls: metrics.length,\n        averageLatency: stats.averageDuration,\n        cacheHitRate: stats.cacheHitRate,\n      },\n    };\n  }\n\n  /**\n   * Get performance comparison (in-process vs IPC)\n   */\n  getPerformanceComparison() {\n    const metrics = this.getMetrics();\n\n    if ('error' in metrics) {\n      return metrics;\n    }\n\n    const avgInProcessLatency = metrics.stats.averageDuration;\n\n    // Estimated IPC latency (based on typical MCP stdio overhead)\n    const estimatedIPCLatency = avgInProcessLatency * 50; // 50x overhead estimate\n\n    return {\n      inProcessLatency: `${avgInProcessLatency.toFixed(2)}ms`,\n      estimatedIPCLatency: `${estimatedIPCLatency.toFixed(2)}ms`,\n      speedupFactor: `${(estimatedIPCLatency / avgInProcessLatency).toFixed(1)}x`,\n      recommendation: 'Use in-process for all Claude-Flow tools for maximum performance',\n    };\n  }\n\n  /**\n   * Cleanup resources\n   */\n  async cleanup(): Promise<void> {\n    if (this.inProcessServer) {\n      this.inProcessServer.clearCache();\n      this.inProcessServer.clearMetrics();\n    }\n\n    this.tools.clear();\n    logger.info('Tool registry cleaned up');\n  }\n}\n\n/**\n * Create a global tool registry instance\n */\nexport async function createToolRegistry(\n  config: ToolRegistryConfig\n): Promise<ClaudeFlowToolRegistry> {\n  const registry = new ClaudeFlowToolRegistry(config);\n  await registry.initialize();\n  return registry;\n}\n\n/**\n * Export SDK server creation helper\n */\nexport async function createClaudeFlowSdkServer(\n  orchestratorContext?: any\n): Promise<McpSdkServerConfigWithInstance> {\n  const registry = await createToolRegistry({\n    enableInProcess: true,\n    enableMetrics: true,\n    enableCaching: true,\n    orchestratorContext,\n  });\n\n  const sdkServer = registry.getSdkServerConfig();\n  if (!sdkServer) {\n    throw new Error('Failed to create SDK server');\n  }\n\n  return sdkServer;\n}"],"names":["createInProcessServer","createClaudeFlowTools","logger","createToolFilter","tool","createSdkMcpServer","z","ClaudeFlowToolRegistry","inProcessServer","sdkServer","tools","config","toolFilter","Map","enabled","info","enableInProcess","enableMetrics","toolFilterEnabled","setToolFilter","mode","initialize","claudeFlowTools","set","name","size","version","enableCaching","registerTool","orchestratorContext","setContext","orchestrator","sessionId","createSdkServer","toolCount","getToolNames","length","Error","sdkTools","Array","from","values","map","convertToSdkTool","mcpTool","zodSchema","jsonSchemaToZod","inputSchema","description","args","extra","callTool","result","handler","content","type","text","JSON","stringify","isError","schema","properties","key","prop","Object","entries","p","enum","string","default","undefined","required","includes","optional","number","boolean","array","any","record","describe","getSdkServerConfig","getInProcessServer","getTool","get","filterTools","t","getAllToolNames","keys","getFilterStats","shouldUseInProcess","toolName","has","routeToolCall","context","startTime","performance","now","debug","duration","toFixed","transport","warn","error","getMetrics","stats","getStats","metrics","recentMetrics","slice","summary","totalCalls","averageLatency","averageDuration","cacheHitRate","getPerformanceComparison","avgInProcessLatency","estimatedIPCLatency","inProcessLatency","speedupFactor","recommendation","cleanup","clearCache","clearMetrics","clear","createToolRegistry","registry","createClaudeFlowSdkServer"],"mappings":"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"}
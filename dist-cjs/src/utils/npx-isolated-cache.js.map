{"version":3,"sources":["../../../src/utils/npx-isolated-cache.js"],"sourcesContent":["#!/usr/bin/env node\r\n\r\n/**\r\n * NPX Isolated Cache\r\n *\r\n * Provides isolated NPX cache directories per process to prevent\r\n * concurrent cache conflicts when multiple claude-flow instances\r\n * run simultaneously.\r\n *\r\n * This simple solution gives each process its own cache directory,\r\n * eliminating ENOTEMPTY errors without the complexity of locks.\r\n */\r\n\r\nimport { promises as fs } from 'fs';\r\nimport path from 'path';\r\nimport os from 'os';\r\nimport { fileURLToPath } from 'url';\r\nimport { dirname } from 'path';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\n\r\n// Track cache directories for cleanup\r\nconst cacheDirectories = new Set();\r\nlet cleanupRegistered = false;\r\n\r\n/**\r\n * Creates an isolated NPX cache environment\r\n * @returns {Object} Environment variables with isolated cache\r\n */\r\nexport function createIsolatedCache() {\r\n  // Create unique cache directory for this process\r\n  const timestamp = Date.now();\r\n  const pid = process.pid;\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  const cacheName = `claude-flow-${pid}-${timestamp}-${random}`;\r\n  const cacheDir = path.join(os.tmpdir(), '.npm-cache', cacheName);\r\n\r\n  // Track for cleanup\r\n  cacheDirectories.add(cacheDir);\r\n\r\n  // Register cleanup on first use\r\n  if (!cleanupRegistered) {\r\n    registerCleanup();\r\n    cleanupRegistered = true;\r\n  }\r\n\r\n  // Return environment with isolated cache\r\n  // Use Deno.env if available (Deno environment), otherwise use process.env (Node.js environment)\r\n  const baseEnv = typeof Deno !== 'undefined' && Deno.env ? Deno.env.toObject() : process.env;\r\n\r\n  return {\r\n    ...baseEnv,\r\n    NPM_CONFIG_CACHE: cacheDir,\r\n    // Also set npm cache for older npm versions\r\n    npm_config_cache: cacheDir,\r\n  };\r\n}\r\n\r\n/**\r\n * Gets environment variables for isolated NPX execution\r\n * @param {Object} additionalEnv - Additional environment variables\r\n * @returns {Object} Merged environment with isolated cache\r\n */\r\nexport function getIsolatedNpxEnv(additionalEnv = {}) {\r\n  const isolatedEnv = createIsolatedCache();\r\n  return {\r\n    ...isolatedEnv,\r\n    ...additionalEnv,\r\n  };\r\n}\r\n\r\n/**\r\n * Cleans up cache directories\r\n */\r\nasync function cleanupCaches() {\r\n  const cleanupPromises = Array.from(cacheDirectories).map(async (cacheDir) => {\r\n    try {\r\n      await fs.rm(cacheDir, { recursive: true, force: true });\r\n    } catch (error) {\r\n      // Ignore errors during cleanup - cache might already be gone\r\n      if (error.code !== 'ENOENT') {\r\n        console.debug(`Failed to cleanup cache ${cacheDir}:`, error.message);\r\n      }\r\n    }\r\n  });\r\n\r\n  await Promise.all(cleanupPromises);\r\n  cacheDirectories.clear();\r\n}\r\n\r\n/**\r\n * Registers cleanup handlers\r\n */\r\nfunction registerCleanup() {\r\n  // Cleanup on normal exit\r\n  process.on('exit', () => {\r\n    // Attempt synchronous cleanup on exit\r\n    for (const cacheDir of cacheDirectories) {\r\n      try {\r\n        require('fs').rmSync(cacheDir, { recursive: true, force: true });\r\n      } catch (error) {\r\n        // Ignore cleanup errors\r\n      }\r\n    }\r\n  });\r\n\r\n  // Cleanup on signals\r\n  const signals = ['SIGINT', 'SIGTERM', 'SIGUSR1', 'SIGUSR2'];\r\n  signals.forEach((signal) => {\r\n    process.on(signal, async () => {\r\n      await cleanupCaches();\r\n      process.exit();\r\n    });\r\n  });\r\n\r\n  // Cleanup on uncaught exceptions\r\n  process.on('uncaughtException', async (error) => {\r\n    console.error('Uncaught exception:', error);\r\n    await cleanupCaches();\r\n    process.exit(1);\r\n  });\r\n\r\n  // Cleanup on unhandled rejections\r\n  process.on('unhandledRejection', async (reason, promise) => {\r\n    console.error('Unhandled rejection at:', promise, 'reason:', reason);\r\n    await cleanupCaches();\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\n/**\r\n * Manually cleanup all caches (useful for testing)\r\n */\r\nexport async function cleanupAllCaches() {\r\n  await cleanupCaches();\r\n}\r\n\r\n// For direct CLI usage\r\nif (import.meta.url === `file://${process.argv[1]}`) {\r\n  const command = process.argv[2];\r\n\r\n  if (command === 'test') {\r\n    console.log('Testing isolated cache creation...');\r\n    const env = createIsolatedCache();\r\n    console.log('Cache directory:', env.NPM_CONFIG_CACHE);\r\n    console.log('Environment configured successfully');\r\n\r\n    // Cleanup\r\n    await cleanupAllCaches();\r\n    console.log('Cleanup completed');\r\n  } else {\r\n    console.log('NPX Isolated Cache Utility');\r\n    console.log('Usage: node npx-isolated-cache.js test');\r\n  }\r\n}\r\n"],"names":["promises","fs","path","os","fileURLToPath","dirname","__filename","url","__dirname","cacheDirectories","Set","cleanupRegistered","createIsolatedCache","timestamp","Date","now","pid","process","random","Math","toString","substring","cacheName","cacheDir","join","tmpdir","add","registerCleanup","baseEnv","Deno","env","toObject","NPM_CONFIG_CACHE","npm_config_cache","getIsolatedNpxEnv","additionalEnv","isolatedEnv","cleanupCaches","cleanupPromises","Array","from","map","rm","recursive","force","error","code","console","debug","message","Promise","all","clear","on","require","rmSync","signals","forEach","signal","exit","reason","promise","cleanupAllCaches","argv","command","log"],"mappings":"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"}
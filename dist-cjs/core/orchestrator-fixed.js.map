{
  "version": 3,
  "sources": ["../../src/core/orchestrator-fixed.ts"],
  "sourcesContent": ["/**\n * Fixed orchestrator implementation for Claude-Flow\n */\n\nimport type { EventBus } from './event-bus.js';\nimport type { Logger } from './logger.js';\nimport type { ConfigManager } from './config.js';\nimport { JsonPersistenceManager } from './json-persistence.js';\n\nexport interface AgentInfo {\n  id: string;\n  type: string;\n  name: string;\n  status: string;\n  assignedTasks: string[];\n  createdAt: number;\n}\n\nexport interface TaskInfo {\n  id: string;\n  type: string;\n  description: string;\n  status: string;\n  progress: number;\n  assignedAgent?: string;\n  error?: string;\n}\n\nexport interface SessionInfo {\n  id: string;\n  type: string;\n  agentId: string;\n}\n\nexport interface WorkflowStatus {\n  status: string;\n  progress: number;\n  error?: string;\n}\n\nexport interface HealthCheckResult {\n  healthy: boolean;\n  memory: boolean;\n  terminalPool: boolean;\n  mcp: boolean;\n}\n\nexport class Orchestrator {\n  private agents: Map<string, AgentInfo> = new Map();\n  private tasks: Map<string, TaskInfo> = new Map();\n  private sessions: Map<string, SessionInfo> = new Map();\n  private persistence: JsonPersistenceManager;\n  private workflows: Map<string, WorkflowStatus> = new Map();\n  private started = false;\n\n  constructor(\n    private config: ConfigManager,\n    private eventBus: EventBus,\n    private logger: Logger,\n  ) {\n    this.persistence = new JsonPersistenceManager();\n  }\n\n  async start(): Promise<void> {\n    if (this.started) {\n      throw new Error('Orchestrator already started');\n    }\n\n    this.logger.info('Starting orchestrator...');\n\n    // Initialize persistence\n    await this.persistence.initialize();\n\n    // Load existing agents and tasks from database\n    await this.loadFromPersistence();\n\n    // Initialize components\n    this.eventBus.emit('system:ready', { timestamp: new Date() });\n\n    this.started = true;\n    this.logger.info('Orchestrator started successfully');\n  }\n\n  private async loadFromPersistence(): Promise<void> {\n    // Load agents\n    const persistedAgents = await this.persistence.getActiveAgents();\n    for (const agent of persistedAgents) {\n      this.agents.set(agent.id, {\n        id: agent.id,\n        type: agent.type,\n        name: agent.name,\n        status: agent.status,\n        assignedTasks: [],\n        createdAt: agent.createdAt,\n      });\n    }\n\n    // Load tasks\n    const persistedTasks = await this.persistence.getActiveTasks();\n    for (const task of persistedTasks) {\n      this.tasks.set(task.id, {\n        id: task.id,\n        type: task.type,\n        description: task.description,\n        status: task.status,\n        progress: task.progress,\n        assignedAgent: task.assignedAgent,\n        error: task.error,\n      });\n    }\n\n    this.logger.info(\n      `Loaded ${this.agents.size} agents and ${this.tasks.size} tasks from persistence`,\n    );\n  }\n\n  async stop(): Promise<void> {\n    if (!this.started) {\n      return;\n    }\n\n    this.logger.info('Stopping orchestrator...');\n\n    // Clean up resources\n    this.agents.clear();\n    this.tasks.clear();\n    this.sessions.clear();\n    this.workflows.clear();\n\n    // Close persistence\n    this.persistence.close();\n\n    this.started = false;\n    this.logger.info('Orchestrator stopped');\n  }\n\n  async spawnAgent(profile: {\n    type: string;\n    name: string;\n    capabilities: string[];\n    systemPrompt: string;\n    maxConcurrentTasks: number;\n    priority: number;\n  }): Promise<string> {\n    const agentId = `agent-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const agent: AgentInfo = {\n      id: agentId,\n      type: profile.type,\n      name: profile.name,\n      status: 'active',\n      assignedTasks: [],\n      createdAt: Date.now(),\n    };\n\n    // Save to persistence\n    await this.persistence.saveAgent({\n      id: agentId,\n      type: profile.type,\n      name: profile.name,\n      status: 'active',\n      capabilities: profile.capabilities,\n      systemPrompt: profile.systemPrompt,\n      maxConcurrentTasks: profile.maxConcurrentTasks,\n      priority: profile.priority,\n      createdAt: Date.now(),\n    });\n\n    this.agents.set(agentId, agent);\n    this.eventBus.emit('agent:spawned', { agentId, profile });\n\n    return agentId;\n  }\n\n  async terminateAgent(agentId: string): Promise<void> {\n    const agent = this.agents.get(agentId);\n    if (!agent) {\n      throw new Error(`Agent ${agentId} not found`);\n    }\n\n    // Update persistence\n    await this.persistence.updateAgentStatus(agentId, 'terminated');\n\n    this.agents.delete(agentId);\n    this.eventBus.emit('agent:terminated', { agentId, reason: 'User requested' });\n  }\n\n  getActiveAgents(): AgentInfo[] {\n    return Array.from(this.agents.values());\n  }\n\n  getAgentInfo(agentId: string): AgentInfo | undefined {\n    return this.agents.get(agentId);\n  }\n\n  async submitTask(task: {\n    type: string;\n    description: string;\n    priority: number;\n    dependencies: string[];\n    metadata: Record<string, unknown>;\n  }): Promise<string> {\n    const taskId = `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const taskInfo: TaskInfo = {\n      id: taskId,\n      type: task.type,\n      description: task.description,\n      status: 'pending',\n      progress: 0,\n    };\n\n    // Save to persistence\n    await this.persistence.saveTask({\n      id: taskId,\n      type: task.type,\n      description: task.description,\n      status: 'pending',\n      priority: task.priority,\n      dependencies: task.dependencies,\n      metadata: task.metadata,\n      progress: 0,\n      createdAt: Date.now(),\n    });\n\n    this.tasks.set(taskId, taskInfo);\n    this.eventBus.emit('task:created', { taskId, task });\n\n    // Simulate task assignment\n    const availableAgents = Array.from(this.agents.values()).filter((a) => a.status === 'active');\n    if (availableAgents.length > 0) {\n      const agent = availableAgents[0];\n      taskInfo.assignedAgent = agent.id;\n      taskInfo.status = 'assigned';\n      agent.assignedTasks.push(taskId);\n      this.eventBus.emit('task:assigned', { taskId, agentId: agent.id });\n\n      // Update persistence with assignment\n      await this.persistence.updateTaskStatus(taskId, 'assigned', agent.id);\n    }\n\n    return taskId;\n  }\n\n  getTaskQueue(): TaskInfo[] {\n    return Array.from(this.tasks.values());\n  }\n\n  getTaskStatus(taskId: string): TaskInfo | undefined {\n    return this.tasks.get(taskId);\n  }\n\n  async cancelTask(taskId: string): Promise<void> {\n    const task = this.tasks.get(taskId);\n    if (!task) {\n      throw new Error(`Task ${taskId} not found`);\n    }\n\n    task.status = 'cancelled';\n    this.eventBus.emit('task:cancelled', { taskId });\n  }\n\n  getActiveSessions(): SessionInfo[] {\n    return Array.from(this.sessions.values());\n  }\n\n  async terminateSession(sessionId: string): Promise<void> {\n    const session = this.sessions.get(sessionId);\n    if (!session) {\n      throw new Error(`Session ${sessionId} not found`);\n    }\n\n    this.sessions.delete(sessionId);\n    this.eventBus.emit('session:terminated', { sessionId });\n  }\n\n  async executeWorkflow(workflow: any): Promise<string> {\n    const workflowId = `workflow-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const status: WorkflowStatus = {\n      status: 'running',\n      progress: 0,\n    };\n\n    this.workflows.set(workflowId, status);\n    this.eventBus.emit('workflow:started', { workflowId, workflow });\n\n    // Simulate workflow execution\n    setTimeout(() => {\n      status.status = 'completed';\n      status.progress = 100;\n      this.eventBus.emit('workflow:completed', { workflowId });\n    }, 5000);\n\n    return workflowId;\n  }\n\n  async getWorkflowStatus(workflowId: string): Promise<WorkflowStatus> {\n    const status = this.workflows.get(workflowId);\n    if (!status) {\n      throw new Error(`Workflow ${workflowId} not found`);\n    }\n    return status;\n  }\n\n  async healthCheck(): Promise<HealthCheckResult> {\n    return {\n      healthy: this.started,\n      memory: true,\n      terminalPool: true,\n      mcp: this.started,\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

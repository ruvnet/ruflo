{"version":3,"sources":["../../../../src/swarm/optimizations/connection-pool.ts"],"sourcesContent":["/**\r\n * Connection Pool for Claude API\r\n * Manages reusable connections to improve performance\r\n */\r\n\r\nimport { EventEmitter } from 'node:events';\r\nimport { Logger } from '../../core/logger.js';\r\n// Mock ClaudeAPI for testing when service doesn't exist\r\nexport class ClaudeAPI {\r\n  id: string;\r\n  isHealthy: boolean;\r\n\r\n  constructor() {\r\n    this.id = `mock-api-${Date.now()}`;\r\n    this.isHealthy = true;\r\n  }\r\n\r\n  async healthCheck(): Promise<boolean> {\r\n    return this.isHealthy;\r\n  }\r\n\r\n  async complete(options: any): Promise<any> {\r\n    // Mock response for testing\r\n    return {\r\n      content: [{ text: `Mock response for: ${options.messages?.[0]?.content || 'test'}` }],\r\n      model: options.model || 'claude-3-5-sonnet-20241022',\r\n      usage: {\r\n        input_tokens: 10,\r\n        output_tokens: 20,\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\nexport interface PoolConfig {\r\n  min: number;\r\n  max: number;\r\n  acquireTimeoutMillis: number;\r\n  idleTimeoutMillis: number;\r\n  evictionRunIntervalMillis: number;\r\n  testOnBorrow: boolean;\r\n}\r\n\r\nexport interface PooledConnection {\r\n  id: string;\r\n  api: ClaudeAPI;\r\n  inUse: boolean;\r\n  createdAt: Date;\r\n  lastUsedAt: Date;\r\n  useCount: number;\r\n}\r\n\r\nexport class ClaudeConnectionPool extends EventEmitter {\r\n  private connections: Map<string, PooledConnection> = new Map();\r\n  private waitingQueue: Array<{\r\n    resolve: (conn: PooledConnection) => void;\r\n    reject: (error: Error) => void;\r\n    timeout: NodeJS.Timeout;\r\n  }> = [];\r\n\r\n  private config: PoolConfig;\r\n  private logger: Logger;\r\n  private evictionTimer?: NodeJS.Timeout;\r\n  private isShuttingDown = false;\r\n\r\n  constructor(config: Partial<PoolConfig> = {}) {\r\n    super();\r\n\r\n    this.config = {\r\n      min: 2,\r\n      max: 10,\r\n      acquireTimeoutMillis: 30000,\r\n      idleTimeoutMillis: 30000,\r\n      evictionRunIntervalMillis: 10000,\r\n      testOnBorrow: true,\r\n      ...config,\r\n    };\r\n\r\n    this.logger = new Logger(\r\n      { level: 'info', format: 'json', destination: 'console' },\r\n      { component: 'ClaudeConnectionPool' },\r\n    );\r\n\r\n    this.initialize();\r\n  }\r\n\r\n  private async initialize(): Promise<void> {\r\n    // Create minimum connections\r\n    for (let i = 0; i < this.config.min; i++) {\r\n      await this.createConnection();\r\n    }\r\n\r\n    // Start eviction timer\r\n    this.evictionTimer = setInterval(() => {\r\n      this.evictIdleConnections();\r\n    }, this.config.evictionRunIntervalMillis);\r\n\r\n    this.logger.info('Connection pool initialized', {\r\n      min: this.config.min,\r\n      max: this.config.max,\r\n    });\r\n  }\r\n\r\n  private async createConnection(): Promise<PooledConnection> {\r\n    const id = `conn-${Date.now()}-${Math.random().toString(36).substring(7)}`;\r\n    const api = new ClaudeAPI();\r\n\r\n    const connection: PooledConnection = {\r\n      id,\r\n      api,\r\n      inUse: false,\r\n      createdAt: new Date(),\r\n      lastUsedAt: new Date(),\r\n      useCount: 0,\r\n    };\r\n\r\n    this.connections.set(id, connection);\r\n    this.emit('connection:created', connection);\r\n\r\n    return connection;\r\n  }\r\n\r\n  async acquire(): Promise<PooledConnection> {\r\n    if (this.isShuttingDown) {\r\n      throw new Error('Connection pool is shutting down');\r\n    }\r\n\r\n    // Try to find an available connection\r\n    for (const conn of this.connections.values()) {\r\n      if (!conn.inUse) {\r\n        conn.inUse = true;\r\n        conn.lastUsedAt = new Date();\r\n        conn.useCount++;\r\n\r\n        // Test connection if configured\r\n        if (this.config.testOnBorrow) {\r\n          const isHealthy = await this.testConnection(conn);\r\n          if (!isHealthy) {\r\n            await this.destroyConnection(conn);\r\n            continue;\r\n          }\r\n        }\r\n\r\n        this.emit('connection:acquired', conn);\r\n        return conn;\r\n      }\r\n    }\r\n\r\n    // Create new connection if under limit\r\n    if (this.connections.size < this.config.max) {\r\n      const conn = await this.createConnection();\r\n      conn.inUse = true;\r\n      conn.useCount++;\r\n      this.emit('connection:acquired', conn);\r\n      return conn;\r\n    }\r\n\r\n    // Wait for a connection to become available\r\n    return new Promise((resolve, reject) => {\r\n      const timeout = setTimeout(() => {\r\n        const index = this.waitingQueue.findIndex((item) => item.resolve === resolve);\r\n        if (index !== -1) {\r\n          this.waitingQueue.splice(index, 1);\r\n        }\r\n        reject(new Error('Connection acquire timeout'));\r\n      }, this.config.acquireTimeoutMillis);\r\n\r\n      this.waitingQueue.push({ resolve, reject, timeout });\r\n    });\r\n  }\r\n\r\n  async release(connection: PooledConnection): Promise<void> {\r\n    const conn = this.connections.get(connection.id);\r\n    if (!conn) {\r\n      this.logger.warn('Attempted to release unknown connection', { id: connection.id });\r\n      return;\r\n    }\r\n\r\n    conn.inUse = false;\r\n    conn.lastUsedAt = new Date();\r\n\r\n    this.emit('connection:released', conn);\r\n\r\n    // Check if anyone is waiting for a connection\r\n    if (this.waitingQueue.length > 0) {\r\n      const waiter = this.waitingQueue.shift();\r\n      if (waiter) {\r\n        clearTimeout(waiter.timeout);\r\n        conn.inUse = true;\r\n        conn.useCount++;\r\n        waiter.resolve(conn);\r\n      }\r\n    }\r\n  }\r\n\r\n  async execute<T>(fn: (api: ClaudeAPI) => Promise<T>): Promise<T> {\r\n    const conn = await this.acquire();\r\n    try {\r\n      return await fn(conn.api);\r\n    } finally {\r\n      await this.release(conn);\r\n    }\r\n  }\r\n\r\n  private async testConnection(conn: PooledConnection): Promise<boolean> {\r\n    try {\r\n      // Simple health check - could be expanded\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.warn('Connection health check failed', {\r\n        id: conn.id,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async destroyConnection(conn: PooledConnection): Promise<void> {\r\n    this.connections.delete(conn.id);\r\n    this.emit('connection:destroyed', conn);\r\n\r\n    // Ensure minimum connections\r\n    if (this.connections.size < this.config.min && !this.isShuttingDown) {\r\n      await this.createConnection();\r\n    }\r\n  }\r\n\r\n  private evictIdleConnections(): void {\r\n    const now = Date.now();\r\n    const idleThreshold = now - this.config.idleTimeoutMillis;\r\n\r\n    for (const conn of this.connections.values()) {\r\n      if (\r\n        !conn.inUse &&\r\n        conn.lastUsedAt.getTime() < idleThreshold &&\r\n        this.connections.size > this.config.min\r\n      ) {\r\n        this.destroyConnection(conn);\r\n      }\r\n    }\r\n  }\r\n\r\n  async drain(): Promise<void> {\r\n    this.isShuttingDown = true;\r\n\r\n    // Clear eviction timer\r\n    if (this.evictionTimer) {\r\n      clearInterval(this.evictionTimer);\r\n      this.evictionTimer = undefined;\r\n    }\r\n\r\n    // Reject all waiting requests\r\n    for (const waiter of this.waitingQueue) {\r\n      clearTimeout(waiter.timeout);\r\n      waiter.reject(new Error('Connection pool is draining'));\r\n    }\r\n    this.waitingQueue = [];\r\n\r\n    // Wait for all connections to be released\r\n    const maxWaitTime = 30000; // 30 seconds\r\n    const startTime = Date.now();\r\n\r\n    while (true) {\r\n      const inUseCount = Array.from(this.connections.values()).filter((conn) => conn.inUse).length;\r\n\r\n      if (inUseCount === 0) break;\r\n\r\n      if (Date.now() - startTime > maxWaitTime) {\r\n        this.logger.warn('Timeout waiting for connections to be released', { inUseCount });\r\n        break;\r\n      }\r\n\r\n      await new Promise((resolve) => setTimeout(resolve, 100));\r\n    }\r\n\r\n    // Destroy all connections\r\n    for (const conn of this.connections.values()) {\r\n      await this.destroyConnection(conn);\r\n    }\r\n\r\n    this.logger.info('Connection pool drained');\r\n  }\r\n\r\n  getStats() {\r\n    const connections = Array.from(this.connections.values());\r\n    return {\r\n      total: connections.length,\r\n      inUse: connections.filter((c) => c.inUse).length,\r\n      idle: connections.filter((c) => !c.inUse).length,\r\n      waitingQueue: this.waitingQueue.length,\r\n      totalUseCount: connections.reduce((sum, c) => sum + c.useCount, 0),\r\n    };\r\n  }\r\n}\r\n"],"names":["EventEmitter","Logger","ClaudeAPI","id","isHealthy","Date","now","healthCheck","complete","options","content","text","messages","model","usage","input_tokens","output_tokens","ClaudeConnectionPool","connections","Map","waitingQueue","config","logger","evictionTimer","isShuttingDown","min","max","acquireTimeoutMillis","idleTimeoutMillis","evictionRunIntervalMillis","testOnBorrow","level","format","destination","component","initialize","i","createConnection","setInterval","evictIdleConnections","info","Math","random","toString","substring","api","connection","inUse","createdAt","lastUsedAt","useCount","set","emit","acquire","Error","conn","values","testConnection","destroyConnection","size","Promise","resolve","reject","timeout","setTimeout","index","findIndex","item","splice","push","release","get","warn","length","waiter","shift","clearTimeout","execute","fn","error","message","delete","idleThreshold","getTime","drain","clearInterval","undefined","maxWaitTime","startTime","inUseCount","Array","from","filter","getStats","total","c","idle","totalUseCount","reduce","sum"],"mappings":"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"}
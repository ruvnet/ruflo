{"version":3,"sources":["../../../src/permissions/permission-manager.ts"],"sourcesContent":["/**\r\n * Permission Manager - 4-Level Hierarchical Permissions\r\n *\r\n * Implements hierarchical permission system with fallback chain:\r\n * USER (global) → PROJECT (.claude-flow/) → LOCAL (file-based) → SESSION (runtime)\r\n *\r\n * Features:\r\n * - Fast permission resolution with caching\r\n * - Granular control at each level\r\n * - Override capabilities\r\n * - Automatic fallback chain\r\n * - Thread-safe operations\r\n */\r\n\r\nimport { readFile, writeFile, mkdir, access } from 'fs/promises';\r\nimport { join, dirname } from 'path';\r\nimport { constants } from 'fs';\r\nimport type { PermissionBehavior, PermissionRuleValue, PermissionUpdate } from '@anthropic-ai/claude-code/sdk';\r\n\r\n// ===== Core Permission Types =====\r\n\r\nexport type PermissionLevel = 'user' | 'project' | 'local' | 'session';\r\n\r\nexport interface PermissionRule {\r\n  toolName: string;\r\n  ruleContent?: string;\r\n  behavior: PermissionBehavior;\r\n  scope: PermissionLevel;\r\n  priority: number;\r\n  timestamp: number;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface PermissionConfig {\r\n  mode: 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan';\r\n  rules: PermissionRule[];\r\n  allowedDirectories: string[];\r\n  deniedDirectories: string[];\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface PermissionQuery {\r\n  toolName: string;\r\n  toolInput?: Record<string, unknown>;\r\n  context?: {\r\n    sessionId?: string;\r\n    workingDir?: string;\r\n    agentType?: string;\r\n  };\r\n}\r\n\r\nexport interface PermissionResolution {\r\n  behavior: PermissionBehavior;\r\n  level: PermissionLevel;\r\n  rule?: PermissionRule;\r\n  fallbackChain: PermissionLevel[];\r\n  cached: boolean;\r\n  resolutionTime: number;\r\n}\r\n\r\n// ===== Cache Entry =====\r\n\r\ninterface CacheEntry {\r\n  resolution: PermissionResolution;\r\n  timestamp: number;\r\n}\r\n\r\n// ===== Permission Manager Class =====\r\n\r\nexport class PermissionManager {\r\n  private userConfig?: PermissionConfig;\r\n  private projectConfig?: PermissionConfig;\r\n  private localConfig?: PermissionConfig;\r\n  private sessionConfig: PermissionConfig;\r\n\r\n  private cache: Map<string, CacheEntry> = new Map();\r\n  private cacheEnabled: boolean;\r\n  private cacheTTL: number;\r\n\r\n  private userConfigPath?: string;\r\n  private projectConfigPath?: string;\r\n  private localConfigPath?: string;\r\n\r\n  constructor(options?: {\r\n    cacheEnabled?: boolean;\r\n    cacheTTL?: number;\r\n    userConfigPath?: string;\r\n    projectConfigPath?: string;\r\n    localConfigPath?: string;\r\n  }) {\r\n    this.cacheEnabled = options?.cacheEnabled ?? true;\r\n    this.cacheTTL = options?.cacheTTL ?? 300000; // 5 minutes default\r\n\r\n    this.userConfigPath = options?.userConfigPath;\r\n    this.projectConfigPath = options?.projectConfigPath;\r\n    this.localConfigPath = options?.localConfigPath;\r\n\r\n    // Initialize session config\r\n    this.sessionConfig = this.createDefaultConfig('session');\r\n  }\r\n\r\n  /**\r\n   * Initialize permission manager by loading all configs\r\n   */\r\n  async initialize(): Promise<void> {\r\n    await Promise.allSettled([\r\n      this.loadUserConfig(),\r\n      this.loadProjectConfig(),\r\n      this.loadLocalConfig(),\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Resolve permission for a query using fallback chain\r\n   */\r\n  async resolvePermission(query: PermissionQuery): Promise<PermissionResolution> {\r\n    const startTime = Date.now();\r\n\r\n    // Check cache\r\n    if (this.cacheEnabled) {\r\n      const cacheKey = this.generateCacheKey(query);\r\n      const cached = this.cache.get(cacheKey);\r\n\r\n      if (cached && (Date.now() - cached.timestamp) < this.cacheTTL) {\r\n        return {\r\n          ...cached.resolution,\r\n          cached: true,\r\n          resolutionTime: Date.now() - startTime,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Resolve using fallback chain: SESSION → LOCAL → PROJECT → USER\r\n    const fallbackChain: PermissionLevel[] = ['session', 'local', 'project', 'user'];\r\n\r\n    for (const level of fallbackChain) {\r\n      const rule = this.findRule(query, level);\r\n\r\n      if (rule) {\r\n        const resolution: PermissionResolution = {\r\n          behavior: rule.behavior,\r\n          level,\r\n          rule,\r\n          fallbackChain: fallbackChain.slice(0, fallbackChain.indexOf(level) + 1),\r\n          cached: false,\r\n          resolutionTime: Date.now() - startTime,\r\n        };\r\n\r\n        // Cache result\r\n        if (this.cacheEnabled) {\r\n          this.cache.set(this.generateCacheKey(query), {\r\n            resolution,\r\n            timestamp: Date.now(),\r\n          });\r\n        }\r\n\r\n        return resolution;\r\n      }\r\n    }\r\n\r\n    // No rule found, use default 'ask' behavior\r\n    return {\r\n      behavior: 'ask',\r\n      level: 'session',\r\n      fallbackChain,\r\n      cached: false,\r\n      resolutionTime: Date.now() - startTime,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update permissions at specified level\r\n   */\r\n  async updatePermissions(\r\n    level: PermissionLevel,\r\n    update: PermissionUpdate\r\n  ): Promise<void> {\r\n    const config = this.getConfigForLevel(level);\r\n\r\n    switch (update.type) {\r\n      case 'addRules':\r\n        this.addRules(config, update.rules, update.behavior);\r\n        break;\r\n\r\n      case 'replaceRules':\r\n        this.replaceRules(config, update.rules, update.behavior);\r\n        break;\r\n\r\n      case 'removeRules':\r\n        this.removeRules(config, update.rules);\r\n        break;\r\n\r\n      case 'setMode':\r\n        config.mode = update.mode;\r\n        break;\r\n\r\n      case 'addDirectories':\r\n        config.allowedDirectories.push(...update.directories);\r\n        break;\r\n\r\n      case 'removeDirectories':\r\n        config.allowedDirectories = config.allowedDirectories.filter(\r\n          d => !update.directories.includes(d)\r\n        );\r\n        break;\r\n    }\r\n\r\n    // Clear cache on updates\r\n    this.clearCache();\r\n\r\n    // Persist changes for persistent levels\r\n    if (level !== 'session') {\r\n      await this.saveConfig(level, config);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current configuration for a level\r\n   */\r\n  getConfig(level: PermissionLevel): PermissionConfig | undefined {\r\n    switch (level) {\r\n      case 'user':\r\n        return this.userConfig;\r\n      case 'project':\r\n        return this.projectConfig;\r\n      case 'local':\r\n        return this.localConfig;\r\n      case 'session':\r\n        return this.sessionConfig;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear permission cache\r\n   */\r\n  clearCache(): void {\r\n    this.cache.clear();\r\n  }\r\n\r\n  /**\r\n   * Get cache statistics\r\n   */\r\n  getCacheStats(): { size: number; entries: number } {\r\n    return {\r\n      size: this.cache.size,\r\n      entries: this.cache.size,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Prune expired cache entries\r\n   */\r\n  pruneCache(): number {\r\n    const now = Date.now();\r\n    let pruned = 0;\r\n\r\n    for (const [key, entry] of this.cache.entries()) {\r\n      if (now - entry.timestamp >= this.cacheTTL) {\r\n        this.cache.delete(key);\r\n        pruned++;\r\n      }\r\n    }\r\n\r\n    return pruned;\r\n  }\r\n\r\n  // ===== Private Methods =====\r\n\r\n  private async loadUserConfig(): Promise<void> {\r\n    if (!this.userConfigPath) return;\r\n\r\n    try {\r\n      await access(this.userConfigPath, constants.R_OK);\r\n      const content = await readFile(this.userConfigPath, 'utf-8');\r\n      this.userConfig = JSON.parse(content);\r\n    } catch (error) {\r\n      // Create default if not exists\r\n      this.userConfig = this.createDefaultConfig('user');\r\n    }\r\n  }\r\n\r\n  private async loadProjectConfig(): Promise<void> {\r\n    if (!this.projectConfigPath) return;\r\n\r\n    try {\r\n      await access(this.projectConfigPath, constants.R_OK);\r\n      const content = await readFile(this.projectConfigPath, 'utf-8');\r\n      this.projectConfig = JSON.parse(content);\r\n    } catch (error) {\r\n      // Create default if not exists\r\n      this.projectConfig = this.createDefaultConfig('project');\r\n    }\r\n  }\r\n\r\n  private async loadLocalConfig(): Promise<void> {\r\n    if (!this.localConfigPath) return;\r\n\r\n    try {\r\n      await access(this.localConfigPath, constants.R_OK);\r\n      const content = await readFile(this.localConfigPath, 'utf-8');\r\n      this.localConfig = JSON.parse(content);\r\n    } catch (error) {\r\n      // Create default if not exists\r\n      this.localConfig = this.createDefaultConfig('local');\r\n    }\r\n  }\r\n\r\n  private async saveConfig(level: PermissionLevel, config: PermissionConfig): Promise<void> {\r\n    let configPath: string | undefined;\r\n\r\n    switch (level) {\r\n      case 'user':\r\n        configPath = this.userConfigPath;\r\n        break;\r\n      case 'project':\r\n        configPath = this.projectConfigPath;\r\n        break;\r\n      case 'local':\r\n        configPath = this.localConfigPath;\r\n        break;\r\n    }\r\n\r\n    if (!configPath) return;\r\n\r\n    // Ensure directory exists\r\n    await mkdir(dirname(configPath), { recursive: true });\r\n\r\n    // Write config\r\n    await writeFile(configPath, JSON.stringify(config, null, 2), 'utf-8');\r\n  }\r\n\r\n  private findRule(query: PermissionQuery, level: PermissionLevel): PermissionRule | undefined {\r\n    const config = this.getConfigForLevel(level);\r\n    if (!config) return undefined;\r\n\r\n    // Check if mode bypasses rules\r\n    if (config.mode === 'bypassPermissions') {\r\n      return {\r\n        toolName: '*',\r\n        behavior: 'allow',\r\n        scope: level,\r\n        priority: 1000,\r\n        timestamp: Date.now(),\r\n      };\r\n    }\r\n\r\n    // Find matching rule with highest priority\r\n    return config.rules\r\n      .filter(rule => this.ruleMatches(rule, query))\r\n      .sort((a, b) => b.priority - a.priority)[0];\r\n  }\r\n\r\n  private ruleMatches(rule: PermissionRule, query: PermissionQuery): boolean {\r\n    // Exact match\r\n    if (rule.toolName === query.toolName) {\r\n      return this.ruleContentMatches(rule, query);\r\n    }\r\n\r\n    // Wildcard match\r\n    if (rule.toolName === '*') {\r\n      return this.ruleContentMatches(rule, query);\r\n    }\r\n\r\n    // Pattern match (simple glob-style)\r\n    if (rule.toolName.includes('*')) {\r\n      const pattern = rule.toolName.replace(/\\*/g, '.*');\r\n      if (new RegExp(`^${pattern}$`).test(query.toolName)) {\r\n        return this.ruleContentMatches(rule, query);\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  private ruleContentMatches(rule: PermissionRule, query: PermissionQuery): boolean {\r\n    if (!rule.ruleContent || !query.toolInput) {\r\n      return true; // No content means rule applies to all\r\n    }\r\n\r\n    // Simple string matching for now\r\n    // In production, this would parse ruleContent and match against toolInput\r\n    return true;\r\n  }\r\n\r\n  private getConfigForLevel(level: PermissionLevel): PermissionConfig {\r\n    switch (level) {\r\n      case 'user':\r\n        if (!this.userConfig) {\r\n          this.userConfig = this.createDefaultConfig('user');\r\n        }\r\n        return this.userConfig;\r\n\r\n      case 'project':\r\n        if (!this.projectConfig) {\r\n          this.projectConfig = this.createDefaultConfig('project');\r\n        }\r\n        return this.projectConfig;\r\n\r\n      case 'local':\r\n        if (!this.localConfig) {\r\n          this.localConfig = this.createDefaultConfig('local');\r\n        }\r\n        return this.localConfig;\r\n\r\n      case 'session':\r\n        return this.sessionConfig;\r\n    }\r\n  }\r\n\r\n  private createDefaultConfig(scope: PermissionLevel): PermissionConfig {\r\n    return {\r\n      mode: 'default',\r\n      rules: [],\r\n      allowedDirectories: [],\r\n      deniedDirectories: [],\r\n      metadata: {\r\n        scope,\r\n        created: Date.now(),\r\n      },\r\n    };\r\n  }\r\n\r\n  private addRules(\r\n    config: PermissionConfig,\r\n    rules: PermissionRuleValue[],\r\n    behavior: PermissionBehavior\r\n  ): void {\r\n    const newRules: PermissionRule[] = rules.map((r, index) => ({\r\n      ...r,\r\n      behavior,\r\n      scope: config.metadata?.scope || 'session',\r\n      priority: 100 + index,\r\n      timestamp: Date.now(),\r\n    }));\r\n\r\n    config.rules.push(...newRules);\r\n  }\r\n\r\n  private replaceRules(\r\n    config: PermissionConfig,\r\n    rules: PermissionRuleValue[],\r\n    behavior: PermissionBehavior\r\n  ): void {\r\n    config.rules = rules.map((r, index) => ({\r\n      ...r,\r\n      behavior,\r\n      scope: config.metadata?.scope || 'session',\r\n      priority: 100 + index,\r\n      timestamp: Date.now(),\r\n    }));\r\n  }\r\n\r\n  private removeRules(config: PermissionConfig, rules: PermissionRuleValue[]): void {\r\n    const toRemove = new Set(rules.map(r => `${r.toolName}:${r.ruleContent || ''}`));\r\n\r\n    config.rules = config.rules.filter(rule => {\r\n      const key = `${rule.toolName}:${rule.ruleContent || ''}`;\r\n      return !toRemove.has(key);\r\n    });\r\n  }\r\n\r\n  private generateCacheKey(query: PermissionQuery): string {\r\n    return JSON.stringify({\r\n      tool: query.toolName,\r\n      input: query.toolInput,\r\n      session: query.context?.sessionId,\r\n    });\r\n  }\r\n}\r\n\r\n// ===== Factory Functions =====\r\n\r\nexport function createPermissionManager(options?: {\r\n  workingDir?: string;\r\n  cacheEnabled?: boolean;\r\n  cacheTTL?: number;\r\n}): PermissionManager {\r\n  const workingDir = options?.workingDir || process.cwd();\r\n\r\n  return new PermissionManager({\r\n    cacheEnabled: options?.cacheEnabled,\r\n    cacheTTL: options?.cacheTTL,\r\n    userConfigPath: join(process.env.HOME || '~', '.claude-flow', 'permissions.json'),\r\n    projectConfigPath: join(workingDir, '.claude-flow', 'permissions.json'),\r\n    localConfigPath: join(workingDir, '.permissions.json'),\r\n  });\r\n}\r\n\r\n// Export singleton instance\r\nexport const permissionManager = createPermissionManager({\r\n  cacheEnabled: true,\r\n  cacheTTL: 300000,\r\n});"],"names":["readFile","writeFile","mkdir","access","join","dirname","constants","PermissionManager","userConfig","projectConfig","localConfig","sessionConfig","cache","Map","cacheEnabled","cacheTTL","userConfigPath","projectConfigPath","localConfigPath","options","createDefaultConfig","initialize","Promise","allSettled","loadUserConfig","loadProjectConfig","loadLocalConfig","resolvePermission","query","startTime","Date","now","cacheKey","generateCacheKey","cached","get","timestamp","resolution","resolutionTime","fallbackChain","level","rule","findRule","behavior","slice","indexOf","set","updatePermissions","update","config","getConfigForLevel","type","addRules","rules","replaceRules","removeRules","mode","allowedDirectories","push","directories","filter","d","includes","clearCache","saveConfig","getConfig","clear","getCacheStats","size","entries","pruneCache","pruned","key","entry","delete","R_OK","content","JSON","parse","error","configPath","recursive","stringify","undefined","toolName","scope","priority","ruleMatches","sort","a","b","ruleContentMatches","pattern","replace","RegExp","test","ruleContent","toolInput","deniedDirectories","metadata","created","newRules","map","r","index","toRemove","Set","has","tool","input","session","context","sessionId","createPermissionManager","workingDir","process","cwd","env","HOME","permissionManager"],"mappings":"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"}
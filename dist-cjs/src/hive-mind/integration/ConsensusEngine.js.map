{"version":3,"sources":["../../../../src/hive-mind/integration/ConsensusEngine.ts"],"sourcesContent":["/**\r\n * ConsensusEngine Class\r\n *\r\n * Manages consensus mechanisms, voting, and collective decision-making\r\n * within the Hive Mind swarm.\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport { DatabaseManager } from '../core/DatabaseManager.js';\r\nimport { MCPToolWrapper } from './MCPToolWrapper.js';\r\nimport {\r\n  ConsensusProposal,\r\n  ConsensusVote,\r\n  ConsensusResult,\r\n  VotingStrategy,\r\n  ConsensusMetrics,\r\n} from '../types.js';\r\n\r\nexport class ConsensusEngine extends EventEmitter {\r\n  private threshold: number;\r\n  private db: DatabaseManager;\r\n  private mcpWrapper: MCPToolWrapper;\r\n  private activeProposals: Map<string, ConsensusProposal>;\r\n  private votingStrategies: Map<string, VotingStrategy>;\r\n  private metrics: ConsensusMetrics;\r\n  private isActive: boolean = false;\r\n\r\n  constructor(threshold: number = 0.66) {\r\n    super();\r\n    this.threshold = threshold;\r\n    this.activeProposals = new Map();\r\n    this.votingStrategies = new Map();\r\n    this.metrics = {\r\n      totalProposals: 0,\r\n      achievedConsensus: 0,\r\n      failedConsensus: 0,\r\n      avgVotingTime: 0,\r\n      avgParticipation: 0,\r\n    };\r\n\r\n    this.initializeVotingStrategies();\r\n  }\r\n\r\n  /**\r\n   * Initialize consensus engine\r\n   */\r\n  async initialize(): Promise<void> {\r\n    this.db = await DatabaseManager.getInstance();\r\n    this.mcpWrapper = new MCPToolWrapper();\r\n\r\n    // Start consensus monitoring\r\n    this.startProposalMonitor();\r\n    this.startTimeoutChecker();\r\n    this.startMetricsCollector();\r\n\r\n    this.isActive = true;\r\n    this.emit('initialized');\r\n  }\r\n\r\n  /**\r\n   * Create a new consensus proposal\r\n   */\r\n  async createProposal(proposal: ConsensusProposal): Promise<string> {\r\n    // Store in database\r\n    await this.db.createConsensusProposal(proposal);\r\n\r\n    // Add to active proposals\r\n    this.activeProposals.set(proposal.id, proposal);\r\n\r\n    // Update metrics\r\n    this.metrics.totalProposals++;\r\n\r\n    // Initiate voting\r\n    await this.initiateVoting(proposal);\r\n\r\n    this.emit('proposalCreated', proposal);\r\n\r\n    return proposal.id;\r\n  }\r\n\r\n  /**\r\n   * Submit a vote for a proposal\r\n   */\r\n  async submitVote(vote: ConsensusVote): Promise<void> {\r\n    const proposal = this.activeProposals.get(vote.proposalId);\r\n    if (!proposal) {\r\n      throw new Error('Proposal not found or no longer active');\r\n    }\r\n\r\n    // Validate vote\r\n    if (!this.validateVote(vote, proposal)) {\r\n      throw new Error('Invalid vote');\r\n    }\r\n\r\n    // Store vote\r\n    await this.db.submitConsensusVote(vote.proposalId, vote.agentId, vote.vote, vote.reason);\r\n\r\n    // Check if consensus achieved\r\n    await this.checkConsensus(proposal);\r\n\r\n    this.emit('voteSubmitted', vote);\r\n  }\r\n\r\n  /**\r\n   * Get proposal status\r\n   */\r\n  async getProposalStatus(proposalId: string): Promise<any> {\r\n    const dbProposal = await this.db.getConsensusProposal(proposalId);\r\n    if (!dbProposal) {\r\n      throw new Error('Proposal not found');\r\n    }\r\n\r\n    const votes = JSON.parse(dbProposal.votes || '{}');\r\n    const voteCount = Object.keys(votes).length;\r\n    const positiveVotes = Object.values(votes).filter((v: any) => v.vote).length;\r\n\r\n    return {\r\n      id: proposalId,\r\n      status: dbProposal.status,\r\n      proposal: JSON.parse(dbProposal.proposal),\r\n      requiredThreshold: dbProposal.required_threshold,\r\n      currentVotes: dbProposal.current_votes,\r\n      totalVoters: dbProposal.total_voters,\r\n      currentRatio: voteCount > 0 ? positiveVotes / voteCount : 0,\r\n      votes: votes,\r\n      deadline: dbProposal.deadline_at,\r\n      timeRemaining: new Date(dbProposal.deadline_at).getTime() - Date.now(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get voting recommendation for an agent\r\n   */\r\n  async getVotingRecommendation(\r\n    proposalId: string,\r\n    agentId: string,\r\n    agentType: string,\r\n  ): Promise<any> {\r\n    const proposal = this.activeProposals.get(proposalId);\r\n    if (!proposal) {\r\n      throw new Error('Proposal not found');\r\n    }\r\n\r\n    // Analyze proposal using neural patterns\r\n    const analysis = await this.mcpWrapper.analyzePattern({\r\n      action: 'analyze',\r\n      operation: 'consensus_proposal',\r\n      metadata: {\r\n        proposal: proposal.proposal,\r\n        agentType,\r\n        requiredThreshold: proposal.requiredThreshold,\r\n      },\r\n    });\r\n\r\n    // Get strategy recommendation\r\n    const strategy = this.selectVotingStrategy(proposal, agentType);\r\n    const recommendation = strategy.recommend(proposal, analysis);\r\n\r\n    return {\r\n      proposalId,\r\n      recommendation: recommendation.vote,\r\n      confidence: recommendation.confidence,\r\n      reasoning: recommendation.reasoning,\r\n      factors: recommendation.factors,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Force consensus check (for testing or manual intervention)\r\n   */\r\n  async forceConsensusCheck(proposalId: string): Promise<ConsensusResult> {\r\n    const proposal = this.activeProposals.get(proposalId);\r\n    if (!proposal) {\r\n      throw new Error('Proposal not found');\r\n    }\r\n\r\n    return this.checkConsensus(proposal);\r\n  }\r\n\r\n  /**\r\n   * Get consensus metrics\r\n   */\r\n  getMetrics(): ConsensusMetrics {\r\n    return { ...this.metrics };\r\n  }\r\n\r\n  /**\r\n   * Initialize voting strategies\r\n   */\r\n  private initializeVotingStrategies(): void {\r\n    // Simple majority strategy\r\n    this.votingStrategies.set('simple_majority', {\r\n      name: 'Simple Majority',\r\n      description: 'Requires more than 50% positive votes',\r\n      threshold: 0.5,\r\n      recommend: (proposal, analysis) => ({\r\n        vote: analysis.data?.recommendation || true,\r\n        confidence: 0.7,\r\n        reasoning: 'Based on simple majority principle',\r\n        factors: ['proposal_quality', 'impact_assessment'],\r\n      }),\r\n    });\r\n\r\n    // Supermajority strategy\r\n    this.votingStrategies.set('supermajority', {\r\n      name: 'Supermajority',\r\n      description: 'Requires 2/3 or more positive votes',\r\n      threshold: 0.66,\r\n      recommend: (proposal, analysis) => ({\r\n        vote: analysis.data?.strongRecommendation || false,\r\n        confidence: 0.8,\r\n        reasoning: 'Requires strong consensus for critical decisions',\r\n        factors: ['criticality', 'risk_assessment', 'broad_support'],\r\n      }),\r\n    });\r\n\r\n    // Unanimous strategy\r\n    this.votingStrategies.set('unanimous', {\r\n      name: 'Unanimous',\r\n      description: 'Requires 100% agreement',\r\n      threshold: 1.0,\r\n      recommend: (proposal, analysis) => ({\r\n        vote: analysis.data?.perfectAlignment || false,\r\n        confidence: 0.9,\r\n        reasoning: 'All agents must agree for this decision',\r\n        factors: ['absolute_necessity', 'zero_dissent'],\r\n      }),\r\n    });\r\n\r\n    // Qualified majority strategy\r\n    this.votingStrategies.set('qualified_majority', {\r\n      name: 'Qualified Majority',\r\n      description: 'Weighted voting based on agent expertise',\r\n      threshold: 0.6,\r\n      recommend: (proposal, analysis) => {\r\n        const expertise = analysis.data?.expertiseAlignment || 0.5;\r\n        return {\r\n          vote: expertise > 0.6,\r\n          confidence: expertise,\r\n          reasoning: 'Based on agent expertise and proposal alignment',\r\n          factors: ['expertise_level', 'domain_knowledge', 'past_performance'],\r\n        };\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initiate voting process\r\n   */\r\n  private async initiateVoting(proposal: ConsensusProposal): Promise<void> {\r\n    // Broadcast proposal to all eligible voters\r\n    await this.db.createCommunication({\r\n      from_agent_id: 'consensus-engine',\r\n      to_agent_id: null, // broadcast\r\n      swarm_id: proposal.swarmId,\r\n      message_type: 'consensus',\r\n      content: JSON.stringify({\r\n        type: 'voting_request',\r\n        proposal,\r\n      }),\r\n      priority: 'high',\r\n      requires_response: true,\r\n    });\r\n\r\n    // Set up voting deadline monitoring\r\n    if (proposal.deadline) {\r\n      const timeUntilDeadline = proposal.deadline.getTime() - Date.now();\r\n\r\n      setTimeout(async () => {\r\n        await this.handleVotingDeadline(proposal.id);\r\n      }, timeUntilDeadline);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate a vote\r\n   */\r\n  private validateVote(vote: ConsensusVote, proposal: ConsensusProposal): boolean {\r\n    // Check if voting is still open\r\n    if (proposal.deadline && new Date() > proposal.deadline) {\r\n      return false;\r\n    }\r\n\r\n    // Check if agent already voted\r\n    // This would be checked in the database layer\r\n\r\n    // Validate vote structure\r\n    if (typeof vote.vote !== 'boolean') {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Check if consensus has been achieved\r\n   */\r\n  private async checkConsensus(proposal: ConsensusProposal): Promise<ConsensusResult> {\r\n    const status = await this.getProposalStatus(proposal.id);\r\n\r\n    const result: ConsensusResult = {\r\n      proposalId: proposal.id,\r\n      achieved: false,\r\n      finalRatio: status.currentRatio,\r\n      totalVotes: status.currentVotes,\r\n      positiveVotes: Math.round(status.currentVotes * status.currentRatio),\r\n      negativeVotes: status.currentVotes - Math.round(status.currentVotes * status.currentRatio),\r\n      participationRate: status.totalVoters > 0 ? status.currentVotes / status.totalVoters : 0,\r\n    };\r\n\r\n    // Check if threshold met\r\n    if (status.currentRatio >= proposal.requiredThreshold) {\r\n      result.achieved = true;\r\n      await this.handleConsensusAchieved(proposal, result);\r\n    } else if (status.currentVotes === status.totalVoters) {\r\n      // All votes are in but consensus not achieved\r\n      await this.handleConsensusFailed(proposal, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Handle consensus achieved\r\n   */\r\n  private async handleConsensusAchieved(\r\n    proposal: ConsensusProposal,\r\n    result: ConsensusResult,\r\n  ): Promise<void> {\r\n    // Update proposal status\r\n    await this.db.updateConsensusStatus(proposal.id, 'achieved');\r\n\r\n    // Remove from active proposals\r\n    this.activeProposals.delete(proposal.id);\r\n\r\n    // Update metrics\r\n    this.metrics.achievedConsensus++;\r\n    this.updateAverageMetrics(result);\r\n\r\n    // Notify all agents\r\n    await this.broadcastConsensusResult(proposal, result, true);\r\n\r\n    // Execute consensus decision if applicable\r\n    if (proposal.taskId) {\r\n      await this.executeConsensusDecision(proposal, result);\r\n    }\r\n\r\n    this.emit('consensusAchieved', { proposal, result });\r\n  }\r\n\r\n  /**\r\n   * Handle consensus failed\r\n   */\r\n  private async handleConsensusFailed(\r\n    proposal: ConsensusProposal,\r\n    result: ConsensusResult,\r\n  ): Promise<void> {\r\n    // Update proposal status\r\n    await this.db.updateConsensusStatus(proposal.id, 'failed');\r\n\r\n    // Remove from active proposals\r\n    this.activeProposals.delete(proposal.id);\r\n\r\n    // Update metrics\r\n    this.metrics.failedConsensus++;\r\n    this.updateAverageMetrics(result);\r\n\r\n    // Notify all agents\r\n    await this.broadcastConsensusResult(proposal, result, false);\r\n\r\n    this.emit('consensusFailed', { proposal, result });\r\n  }\r\n\r\n  /**\r\n   * Handle voting deadline\r\n   */\r\n  private async handleVotingDeadline(proposalId: string): Promise<void> {\r\n    const proposal = this.activeProposals.get(proposalId);\r\n    if (!proposal) return;\r\n\r\n    const result = await this.checkConsensus(proposal);\r\n\r\n    if (!result.achieved) {\r\n      await this.handleConsensusFailed(proposal, result);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Select voting strategy\r\n   */\r\n  private selectVotingStrategy(proposal: ConsensusProposal, agentType: string): VotingStrategy {\r\n    // Select strategy based on threshold\r\n    if (proposal.requiredThreshold >= 1.0) {\r\n      return this.votingStrategies.get('unanimous')!;\r\n    } else if (proposal.requiredThreshold >= 0.66) {\r\n      return this.votingStrategies.get('supermajority')!;\r\n    } else {\r\n      return this.votingStrategies.get('simple_majority')!;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update average metrics\r\n   */\r\n  private updateAverageMetrics(result: ConsensusResult): void {\r\n    // Update average participation rate\r\n    const totalDecisions = this.metrics.achievedConsensus + this.metrics.failedConsensus;\r\n    this.metrics.avgParticipation =\r\n      (this.metrics.avgParticipation * (totalDecisions - 1) + result.participationRate) /\r\n      totalDecisions;\r\n  }\r\n\r\n  /**\r\n   * Broadcast consensus result\r\n   */\r\n  private async broadcastConsensusResult(\r\n    proposal: ConsensusProposal,\r\n    result: ConsensusResult,\r\n    achieved: boolean,\r\n  ): Promise<void> {\r\n    await this.db.createCommunication({\r\n      from_agent_id: 'consensus-engine',\r\n      to_agent_id: null, // broadcast\r\n      swarm_id: proposal.swarmId,\r\n      message_type: 'consensus',\r\n      content: JSON.stringify({\r\n        type: 'consensus_result',\r\n        proposal,\r\n        result,\r\n        achieved,\r\n      }),\r\n      priority: 'high',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Execute consensus decision\r\n   */\r\n  private async executeConsensusDecision(\r\n    proposal: ConsensusProposal,\r\n    result: ConsensusResult,\r\n  ): Promise<void> {\r\n    if (!proposal.taskId) return;\r\n\r\n    // Update task based on consensus decision\r\n    const decision = proposal.proposal;\r\n\r\n    if (decision.action === 'approve_task') {\r\n      await this.db.updateTaskStatus(proposal.taskId, 'approved');\r\n    } else if (decision.action === 'modify_task') {\r\n      await this.db.updateTask(proposal.taskId, decision.modifications);\r\n    } else if (decision.action === 'cancel_task') {\r\n      await this.db.updateTaskStatus(proposal.taskId, 'cancelled');\r\n    }\r\n\r\n    this.emit('consensusExecuted', { proposal, result, taskId: proposal.taskId });\r\n  }\r\n\r\n  /**\r\n   * Start proposal monitor\r\n   */\r\n  private startProposalMonitor(): void {\r\n    setInterval(async () => {\r\n      if (!this.isActive) return;\r\n\r\n      try {\r\n        // Check active proposals for updates\r\n        for (const proposal of this.activeProposals.values()) {\r\n          await this.checkConsensus(proposal);\r\n        }\r\n      } catch (error) {\r\n        this.emit('error', error);\r\n      }\r\n    }, 5000); // Every 5 seconds\r\n  }\r\n\r\n  /**\r\n   * Start timeout checker\r\n   */\r\n  private startTimeoutChecker(): void {\r\n    setInterval(async () => {\r\n      if (!this.isActive) return;\r\n\r\n      try {\r\n        const now = Date.now();\r\n\r\n        for (const proposal of this.activeProposals.values()) {\r\n          if (proposal.deadline && proposal.deadline.getTime() < now) {\r\n            await this.handleVotingDeadline(proposal.id);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        this.emit('error', error);\r\n      }\r\n    }, 1000); // Every second\r\n  }\r\n\r\n  /**\r\n   * Start metrics collector\r\n   */\r\n  private startMetricsCollector(): void {\r\n    setInterval(async () => {\r\n      if (!this.isActive) return;\r\n\r\n      try {\r\n        // Calculate average voting time\r\n        const recentProposals = await this.db.getRecentConsensusProposals(10);\r\n\r\n        if (recentProposals.length > 0) {\r\n          const votingTimes = recentProposals\r\n            .filter((p) => p.completed_at)\r\n            .map((p) => new Date(p.completed_at).getTime() - new Date(p.created_at).getTime());\r\n\r\n          if (votingTimes.length > 0) {\r\n            this.metrics.avgVotingTime =\r\n              votingTimes.reduce((a, b) => a + b, 0) / votingTimes.length;\r\n          }\r\n        }\r\n\r\n        // Store metrics\r\n        await this.storeMetrics();\r\n      } catch (error) {\r\n        this.emit('error', error);\r\n      }\r\n    }, 60000); // Every minute\r\n  }\r\n\r\n  /**\r\n   * Store consensus metrics\r\n   */\r\n  private async storeMetrics(): Promise<void> {\r\n    await this.mcpWrapper.storeMemory({\r\n      action: 'store',\r\n      key: 'consensus-metrics',\r\n      value: JSON.stringify(this.metrics),\r\n      namespace: 'performance-metrics',\r\n      ttl: 86400 * 30, // 30 days\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Database helper methods (to be implemented in DatabaseManager)\r\n   */\r\n  private async getConsensusProposal(id: string): Promise<any> {\r\n    return this.db.prepare('SELECT * FROM consensus WHERE id = ?').get(id);\r\n  }\r\n\r\n  private async updateConsensusStatus(id: string, status: string): Promise<void> {\r\n    this.db\r\n      .prepare('UPDATE consensus SET status = ?, completed_at = CURRENT_TIMESTAMP WHERE id = ?')\r\n      .run(status, id);\r\n  }\r\n\r\n  private async getRecentConsensusProposals(limit: number): Promise<any[]> {\r\n    return this.db.prepare('SELECT * FROM consensus ORDER BY created_at DESC LIMIT ?').all(limit);\r\n  }\r\n\r\n  /**\r\n   * Shutdown consensus engine\r\n   */\r\n  async shutdown(): Promise<void> {\r\n    this.isActive = false;\r\n\r\n    // Clear active proposals\r\n    this.activeProposals.clear();\r\n\r\n    this.emit('shutdown');\r\n  }\r\n}\r\n"],"names":["EventEmitter","DatabaseManager","MCPToolWrapper","ConsensusEngine","threshold","db","mcpWrapper","activeProposals","votingStrategies","metrics","isActive","Map","totalProposals","achievedConsensus","failedConsensus","avgVotingTime","avgParticipation","initializeVotingStrategies","initialize","getInstance","startProposalMonitor","startTimeoutChecker","startMetricsCollector","emit","createProposal","proposal","createConsensusProposal","set","id","initiateVoting","submitVote","vote","get","proposalId","Error","validateVote","submitConsensusVote","agentId","reason","checkConsensus","getProposalStatus","dbProposal","getConsensusProposal","votes","JSON","parse","voteCount","Object","keys","length","positiveVotes","values","filter","v","status","requiredThreshold","required_threshold","currentVotes","current_votes","totalVoters","total_voters","currentRatio","deadline","deadline_at","timeRemaining","Date","getTime","now","getVotingRecommendation","agentType","analysis","analyzePattern","action","operation","metadata","strategy","selectVotingStrategy","recommendation","recommend","confidence","reasoning","factors","forceConsensusCheck","getMetrics","name","description","data","strongRecommendation","perfectAlignment","expertise","expertiseAlignment","createCommunication","from_agent_id","to_agent_id","swarm_id","swarmId","message_type","content","stringify","type","priority","requires_response","timeUntilDeadline","setTimeout","handleVotingDeadline","result","achieved","finalRatio","totalVotes","Math","round","negativeVotes","participationRate","handleConsensusAchieved","handleConsensusFailed","updateConsensusStatus","delete","updateAverageMetrics","broadcastConsensusResult","taskId","executeConsensusDecision","totalDecisions","decision","updateTaskStatus","updateTask","modifications","setInterval","error","recentProposals","getRecentConsensusProposals","votingTimes","p","completed_at","map","created_at","reduce","a","b","storeMetrics","storeMemory","key","value","namespace","ttl","prepare","run","limit","all","shutdown","clear"],"mappings":"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"}
{
  "version": 3,
  "sources": ["../../../src/mcp/recovery/connection-health-monitor.ts"],
  "sourcesContent": ["/**\n * Connection Health Monitor for MCP\n * Monitors connection health and triggers recovery when needed\n */\n\nimport { EventEmitter } from 'node:events';\nimport type { ILogger } from '../../core/logger.js';\nimport type { MCPClient } from '../client.js';\n\nexport interface HealthStatus {\n  healthy: boolean;\n  lastHeartbeat: Date;\n  missedHeartbeats: number;\n  latency: number;\n  connectionState: 'connected' | 'disconnected' | 'reconnecting';\n  error?: string;\n}\n\nexport interface HealthMonitorConfig {\n  heartbeatInterval: number;\n  heartbeatTimeout: number;\n  maxMissedHeartbeats: number;\n  enableAutoRecovery: boolean;\n}\n\nexport class ConnectionHealthMonitor extends EventEmitter {\n  private heartbeatTimer?: NodeJS.Timeout;\n  private timeoutTimer?: NodeJS.Timeout;\n  private lastHeartbeat: Date = new Date();\n  private missedHeartbeats = 0;\n  private currentLatency = 0;\n  private isMonitoring = false;\n  private healthStatus: HealthStatus;\n\n  private readonly defaultConfig: HealthMonitorConfig = {\n    heartbeatInterval: 5000,\n    heartbeatTimeout: 10000,\n    maxMissedHeartbeats: 3,\n    enableAutoRecovery: true,\n  };\n\n  constructor(\n    private client: MCPClient,\n    private logger: ILogger,\n    config?: Partial<HealthMonitorConfig>,\n  ) {\n    super();\n    this.config = { ...this.defaultConfig, ...config };\n\n    this.healthStatus = {\n      healthy: false,\n      lastHeartbeat: new Date(),\n      missedHeartbeats: 0,\n      latency: 0,\n      connectionState: 'disconnected',\n    };\n  }\n\n  private config: HealthMonitorConfig;\n\n  /**\n   * Start health monitoring\n   */\n  async start(): Promise<void> {\n    if (this.isMonitoring) {\n      this.logger.warn('Health monitor already running');\n      return;\n    }\n\n    this.logger.info('Starting connection health monitor', {\n      config: this.config,\n    });\n\n    this.isMonitoring = true;\n    this.missedHeartbeats = 0;\n    this.lastHeartbeat = new Date();\n\n    // Start heartbeat cycle\n    this.scheduleHeartbeat();\n\n    // Update initial status\n    this.updateHealthStatus('connected');\n    this.emit('started');\n  }\n\n  /**\n   * Stop health monitoring\n   */\n  async stop(): Promise<void> {\n    if (!this.isMonitoring) {\n      return;\n    }\n\n    this.logger.info('Stopping connection health monitor');\n    this.isMonitoring = false;\n\n    if (this.heartbeatTimer) {\n      clearTimeout(this.heartbeatTimer);\n      this.heartbeatTimer = undefined;\n    }\n\n    if (this.timeoutTimer) {\n      clearTimeout(this.timeoutTimer);\n      this.timeoutTimer = undefined;\n    }\n\n    this.updateHealthStatus('disconnected');\n    this.emit('stopped');\n  }\n\n  /**\n   * Get current health status\n   */\n  getHealthStatus(): HealthStatus {\n    return { ...this.healthStatus };\n  }\n\n  /**\n   * Check connection health immediately\n   */\n  async checkHealth(): Promise<HealthStatus> {\n    try {\n      const startTime = Date.now();\n\n      // Send heartbeat ping\n      await this.sendHeartbeat();\n\n      // Calculate latency\n      this.currentLatency = Date.now() - startTime;\n      this.lastHeartbeat = new Date();\n      this.missedHeartbeats = 0;\n\n      this.updateHealthStatus('connected', true);\n\n      return this.getHealthStatus();\n    } catch (error) {\n      this.logger.error('Health check failed', error);\n      this.handleHeartbeatFailure(error as Error);\n      return this.getHealthStatus();\n    }\n  }\n\n  /**\n   * Force a health check\n   */\n  async forceCheck(): Promise<void> {\n    this.logger.debug('Forcing health check');\n\n    // Cancel current timers\n    if (this.heartbeatTimer) {\n      clearTimeout(this.heartbeatTimer);\n    }\n    if (this.timeoutTimer) {\n      clearTimeout(this.timeoutTimer);\n    }\n\n    // Perform immediate check\n    await this.performHeartbeat();\n  }\n\n  private scheduleHeartbeat(): void {\n    if (!this.isMonitoring) {\n      return;\n    }\n\n    this.heartbeatTimer = setTimeout(() => {\n      this.performHeartbeat().catch((error) => {\n        this.logger.error('Heartbeat error', error);\n      });\n    }, this.config.heartbeatInterval);\n  }\n\n  private async performHeartbeat(): Promise<void> {\n    if (!this.isMonitoring) {\n      return;\n    }\n\n    this.logger.debug('Performing heartbeat');\n\n    try {\n      // Set timeout for heartbeat response\n      this.setHeartbeatTimeout();\n\n      const startTime = Date.now();\n      await this.sendHeartbeat();\n\n      // Clear timeout on success\n      this.clearHeartbeatTimeout();\n\n      // Update metrics\n      this.currentLatency = Date.now() - startTime;\n      this.lastHeartbeat = new Date();\n      this.missedHeartbeats = 0;\n\n      this.logger.debug('Heartbeat successful', {\n        latency: this.currentLatency,\n      });\n\n      this.updateHealthStatus('connected', true);\n\n      // Schedule next heartbeat\n      this.scheduleHeartbeat();\n    } catch (error) {\n      this.handleHeartbeatFailure(error as Error);\n    }\n  }\n\n  private async sendHeartbeat(): Promise<void> {\n    // Send heartbeat notification via MCP\n    await this.client.notify('heartbeat', {\n      timestamp: Date.now(),\n      sessionId: this.generateSessionId(),\n    });\n  }\n\n  private setHeartbeatTimeout(): void {\n    this.timeoutTimer = setTimeout(() => {\n      this.handleHeartbeatTimeout();\n    }, this.config.heartbeatTimeout);\n  }\n\n  private clearHeartbeatTimeout(): void {\n    if (this.timeoutTimer) {\n      clearTimeout(this.timeoutTimer);\n      this.timeoutTimer = undefined;\n    }\n  }\n\n  private handleHeartbeatTimeout(): void {\n    this.logger.warn('Heartbeat timeout');\n    this.handleHeartbeatFailure(new Error('Heartbeat timeout'));\n  }\n\n  private handleHeartbeatFailure(error: Error): void {\n    this.clearHeartbeatTimeout();\n\n    this.missedHeartbeats++;\n    this.logger.warn('Heartbeat failed', {\n      missedHeartbeats: this.missedHeartbeats,\n      maxMissed: this.config.maxMissedHeartbeats,\n      error: error instanceof Error ? error.message : String(error),\n    });\n\n    if (this.missedHeartbeats >= this.config.maxMissedHeartbeats) {\n      this.logger.error('Max missed heartbeats exceeded, connection unhealthy');\n      this.updateHealthStatus(\n        'disconnected',\n        false,\n        error instanceof Error ? error.message : String(error),\n      );\n\n      if (this.config.enableAutoRecovery) {\n        this.emit('connectionLost', { error });\n      }\n    } else {\n      // Schedule next heartbeat with backoff\n      const backoffDelay = this.config.heartbeatInterval * (this.missedHeartbeats + 1);\n      this.logger.debug('Scheduling heartbeat with backoff', { delay: backoffDelay });\n\n      this.heartbeatTimer = setTimeout(() => {\n        this.performHeartbeat().catch((err) => {\n          this.logger.error('Backoff heartbeat error', err);\n        });\n      }, backoffDelay);\n    }\n  }\n\n  private updateHealthStatus(\n    connectionState: 'connected' | 'disconnected' | 'reconnecting',\n    healthy?: boolean,\n    error?: string,\n  ): void {\n    const previousStatus = { ...this.healthStatus };\n\n    this.healthStatus = {\n      healthy: healthy ?? connectionState === 'connected',\n      lastHeartbeat: this.lastHeartbeat,\n      missedHeartbeats: this.missedHeartbeats,\n      latency: this.currentLatency,\n      connectionState,\n      error,\n    };\n\n    // Emit event if health changed\n    if (\n      previousStatus.healthy !== this.healthStatus.healthy ||\n      previousStatus.connectionState !== this.healthStatus.connectionState\n    ) {\n      this.logger.info('Health status changed', {\n        from: previousStatus.connectionState,\n        to: this.healthStatus.connectionState,\n        healthy: this.healthStatus.healthy,\n      });\n\n      this.emit('healthChange', this.healthStatus, previousStatus);\n    }\n  }\n\n  private generateSessionId(): string {\n    return `session-${Date.now()}-${Math.random().toString(36).slice(2)}`;\n  }\n\n  /**\n   * Reset monitor state\n   */\n  reset(): void {\n    this.missedHeartbeats = 0;\n    this.currentLatency = 0;\n    this.lastHeartbeat = new Date();\n\n    if (this.isMonitoring) {\n      this.logger.debug('Resetting health monitor');\n      this.clearHeartbeatTimeout();\n      this.scheduleHeartbeat();\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

{"version":3,"sources":["../../../../src/terminal/adapters/native.ts"],"sourcesContent":["import * as process from 'node:process';\r\n/**\r\n * Native terminal adapter implementation\r\n */\r\n\r\nimport { spawn, ChildProcess } from 'child_process';\r\nimport { platform } from 'os';\r\nimport type { ITerminalAdapter, Terminal } from './base.js';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport { TerminalError, TerminalCommandError } from '../../utils/errors.js';\r\nimport { generateId, delay, timeout, createDeferred } from '../../utils/helpers.js';\r\n\r\n/**\r\n * Platform-specific shell configuration\r\n */\r\ninterface ShellConfig {\r\n  path: string;\r\n  args: string[];\r\n  env?: Record<string, string>;\r\n}\r\n\r\n/**\r\n * Native terminal implementation using Deno subprocess\r\n */\r\nclass NativeTerminal implements Terminal {\r\n  id: string;\r\n  pid?: number;\r\n  private process?: ChildProcess | undefined;\r\n  private encoder = new TextEncoder();\r\n  private decoder = new TextDecoder();\r\n  private shell: string;\r\n  private outputBuffer = '';\r\n  private errorBuffer = '';\r\n  private commandMarker: string;\r\n  private commandDeferred?: ReturnType<typeof createDeferred<string>> | undefined;\r\n  private outputListeners = new Set<(data: string) => void>();\r\n  private alive = true;\r\n  private stdoutData = '';\r\n  private stderrData = '';\r\n\r\n  constructor(\r\n    shell: string,\r\n    private logger: ILogger,\r\n  ) {\r\n    this.id = generateId('native-term');\r\n    this.shell = shell;\r\n    this.commandMarker = `__CLAUDE_FLOW_${this.id}__`;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    try {\r\n      const shellConfig = this.getShellConfig();\r\n\r\n      // Start shell process\r\n      this.process = spawn(shellConfig.path, shellConfig.args, {\r\n        stdio: ['pipe', 'pipe', 'pipe'],\r\n        env: {\r\n          ...process.env,\r\n          ...shellConfig.env,\r\n          CLAUDE_FLOW_TERMINAL: 'true',\r\n          CLAUDE_FLOW_TERMINAL_ID: this.id,\r\n        },\r\n      });\r\n\r\n      // Get PID\r\n      this.pid = this.process.pid;\r\n\r\n      // Set up output handlers\r\n      this.setupOutputHandlers();\r\n\r\n      // Monitor process status\r\n      this.monitorProcess();\r\n\r\n      // Wait for shell to be ready\r\n      await this.waitForReady();\r\n\r\n      this.logger.debug('Native terminal initialized', {\r\n        id: this.id,\r\n        pid: this.pid,\r\n        shell: this.shell,\r\n      });\r\n    } catch (error) {\r\n      this.alive = false;\r\n      throw new TerminalError('Failed to create native terminal', { error });\r\n    }\r\n  }\r\n\r\n  async executeCommand(command: string): Promise<string> {\r\n    if (!this.process || !this.isAlive()) {\r\n      throw new TerminalError('Terminal is not alive');\r\n    }\r\n\r\n    try {\r\n      // Create deferred for this command\r\n      this.commandDeferred = createDeferred<string>();\r\n\r\n      // Clear output buffer\r\n      this.outputBuffer = '';\r\n\r\n      // Send command with marker\r\n      const markedCommand = this.wrapCommand(command);\r\n      await this.write(markedCommand + '\\n');\r\n\r\n      // Wait for command to complete\r\n      const output = await timeout(\r\n        this.commandDeferred.promise,\r\n        30000,\r\n        'Command execution timeout',\r\n      );\r\n\r\n      return output;\r\n    } catch (error) {\r\n      throw new TerminalCommandError('Failed to execute command', { command, error });\r\n    }\r\n  }\r\n\r\n  async write(data: string): Promise<void> {\r\n    if (!this.process || !this.isAlive()) {\r\n      throw new TerminalError('Terminal is not alive');\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      if (!this.process?.stdin) {\r\n        reject(new TerminalError('Process stdin not available'));\r\n        return;\r\n      }\r\n\r\n      this.process.stdin.write(data, (error) => {\r\n        if (error) {\r\n          reject(error);\r\n        } else {\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  async read(): Promise<string> {\r\n    if (!this.process || !this.isAlive()) {\r\n      throw new TerminalError('Terminal is not alive');\r\n    }\r\n\r\n    // Return buffered output\r\n    const output = this.outputBuffer;\r\n    this.outputBuffer = '';\r\n    return output;\r\n  }\r\n\r\n  isAlive(): boolean {\r\n    return this.alive && this.process !== undefined;\r\n  }\r\n\r\n  async kill(): Promise<void> {\r\n    if (!this.process) return;\r\n\r\n    try {\r\n      this.alive = false;\r\n\r\n      // Close streams\r\n      if (this.process.stdin && !this.process.stdin.destroyed) {\r\n        this.process.stdin.end();\r\n      }\r\n\r\n      // Try graceful shutdown first\r\n      try {\r\n        await this.write('exit\\n');\r\n        await delay(500);\r\n      } catch {\r\n        // Ignore write errors during shutdown\r\n      }\r\n\r\n      // Force kill if still alive\r\n      try {\r\n        this.process.kill('SIGTERM');\r\n        await delay(500);\r\n\r\n        // Use SIGKILL if SIGTERM didn't work\r\n        if (!this.process.killed) {\r\n          this.process.kill('SIGKILL');\r\n        }\r\n      } catch {\r\n        // Process might already be dead\r\n      }\r\n    } catch (error) {\r\n      this.logger.warn('Error killing native terminal', { id: this.id, error });\r\n    } finally {\r\n      this.process = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add output listener\r\n   */\r\n  addOutputListener(listener: (data: string) => void): void {\r\n    this.outputListeners.add(listener);\r\n  }\r\n\r\n  /**\r\n   * Remove output listener\r\n   */\r\n  removeOutputListener(listener: (data: string) => void): void {\r\n    this.outputListeners.delete(listener);\r\n  }\r\n\r\n  private getShellConfig(): ShellConfig {\r\n    const osplatform = platform();\r\n\r\n    switch (this.shell) {\r\n      case 'bash':\r\n        return {\r\n          path: osplatform === 'win32' ? 'C:\\\\Program Files\\\\Git\\\\bin\\\\bash.exe' : '/bin/bash',\r\n          args: ['--norc', '--noprofile'],\r\n          env: { PS1: '$ ' },\r\n        };\r\n\r\n      case 'zsh':\r\n        return {\r\n          path: '/bin/zsh',\r\n          args: ['--no-rcs'],\r\n          env: { PS1: '$ ' },\r\n        };\r\n\r\n      case 'powershell':\r\n        return {\r\n          path: osplatform === 'win32' ? 'powershell.exe' : 'pwsh',\r\n          args: ['-NoProfile', '-NonInteractive', '-NoLogo'],\r\n        };\r\n\r\n      case 'cmd':\r\n        return {\r\n          path: 'cmd.exe',\r\n          args: ['/Q', '/K', 'prompt $G'],\r\n        };\r\n\r\n      case 'sh':\r\n      default:\r\n        return {\r\n          path: '/bin/sh',\r\n          args: [],\r\n          env: { PS1: '$ ' },\r\n        };\r\n    }\r\n  }\r\n\r\n  private wrapCommand(command: string): string {\r\n    const osplatform = platform();\r\n\r\n    if (this.shell === 'powershell') {\r\n      // PowerShell command wrapping\r\n      return `${command}; Write-Host \"${this.commandMarker}\"`;\r\n    } else if (this.shell === 'cmd' && osplatform === 'win32') {\r\n      // Windows CMD command wrapping\r\n      return `${command} & echo ${this.commandMarker}`;\r\n    } else {\r\n      // Unix-like shell command wrapping\r\n      return `${command} && echo \"${this.commandMarker}\" || (echo \"${this.commandMarker}\"; false)`;\r\n    }\r\n  }\r\n\r\n  private setupOutputHandlers(): void {\r\n    if (!this.process) return;\r\n\r\n    // Handle stdout\r\n    this.process.stdout?.on('data', (data: Buffer) => {\r\n      const text = data.toString();\r\n      this.processOutput(text);\r\n    });\r\n\r\n    // Handle stderr\r\n    this.process.stderr?.on('data', (data: Buffer) => {\r\n      const text = data.toString();\r\n      this.errorBuffer += text;\r\n\r\n      // Also send stderr to output listeners\r\n      this.notifyListeners(text);\r\n    });\r\n\r\n    // Handle process errors\r\n    this.process.on('error', (error) => {\r\n      if (this.alive) {\r\n        this.logger.error('Process error', { id: this.id, error });\r\n      }\r\n    });\r\n  }\r\n\r\n  private processOutput(text: string): void {\r\n    this.outputBuffer += text;\r\n\r\n    // Notify listeners\r\n    this.notifyListeners(text);\r\n\r\n    // Check for command completion marker\r\n    const markerIndex = this.outputBuffer.indexOf(this.commandMarker);\r\n    if (markerIndex !== -1 && this.commandDeferred) {\r\n      // Extract output before marker\r\n      const output = this.outputBuffer.substring(0, markerIndex).trim();\r\n\r\n      // Include any stderr output\r\n      const fullOutput = this.errorBuffer ? `${output}\\n${this.errorBuffer}` : output;\r\n      this.errorBuffer = '';\r\n\r\n      // Clear buffer up to after marker\r\n      this.outputBuffer = this.outputBuffer\r\n        .substring(markerIndex + this.commandMarker.length)\r\n        .trim();\r\n\r\n      // Resolve pending command\r\n      this.commandDeferred.resolve(fullOutput);\r\n      this.commandDeferred = undefined;\r\n    }\r\n  }\r\n\r\n  private notifyListeners(data: string): void {\r\n    this.outputListeners.forEach((listener) => {\r\n      try {\r\n        listener(data);\r\n      } catch (error) {\r\n        this.logger.error('Error in output listener', { id: this.id, error });\r\n      }\r\n    });\r\n  }\r\n\r\n  private async monitorProcess(): Promise<void> {\r\n    if (!this.process) return;\r\n\r\n    this.process.on('exit', (code, signal) => {\r\n      this.logger.info('Terminal process exited', {\r\n        id: this.id,\r\n        code,\r\n        signal,\r\n      });\r\n      this.alive = false;\r\n\r\n      // Reject any pending command\r\n      if (this.commandDeferred) {\r\n        this.commandDeferred.reject(new Error('Terminal process exited'));\r\n      }\r\n    });\r\n\r\n    this.process.on('error', (error) => {\r\n      this.logger.error('Error monitoring process', { id: this.id, error });\r\n      this.alive = false;\r\n\r\n      // Reject any pending command\r\n      if (this.commandDeferred) {\r\n        this.commandDeferred.reject(error);\r\n      }\r\n    });\r\n  }\r\n\r\n  private async waitForReady(): Promise<void> {\r\n    // Send a test command to ensure shell is ready\r\n    const testCommand = this.shell === 'powershell' ? 'Write-Host \"READY\"' : 'echo \"READY\"';\r\n\r\n    await this.write(testCommand + '\\n');\r\n\r\n    const startTime = Date.now();\r\n    while (Date.now() - startTime < 5000) {\r\n      if (this.outputBuffer.includes('READY')) {\r\n        this.outputBuffer = '';\r\n        return;\r\n      }\r\n      await delay(100);\r\n    }\r\n\r\n    throw new TerminalError('Terminal failed to become ready');\r\n  }\r\n}\r\n\r\n/**\r\n * Native terminal adapter\r\n */\r\nexport class NativeAdapter implements ITerminalAdapter {\r\n  private terminals = new Map<string, NativeTerminal>();\r\n  private shell: string;\r\n\r\n  constructor(private logger: ILogger) {\r\n    // Detect available shell\r\n    this.shell = this.detectShell();\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    this.logger.info('Initializing native terminal adapter', { shell: this.shell });\r\n\r\n    // Verify shell is available\r\n    try {\r\n      const testConfig = this.getTestCommand();\r\n      const { spawnSync } = require('child_process');\r\n      const result = spawnSync(testConfig.cmd, testConfig.args, { stdio: 'ignore' });\r\n\r\n      if (result.status !== 0) {\r\n        throw new Error('Shell test failed');\r\n      }\r\n    } catch (error) {\r\n      this.logger.warn(`Shell ${this.shell} not available, falling back to sh`, { error });\r\n      this.shell = 'sh';\r\n    }\r\n  }\r\n\r\n  async shutdown(): Promise<void> {\r\n    this.logger.info('Shutting down native terminal adapter');\r\n\r\n    // Kill all terminals\r\n    const terminals = Array.from(this.terminals.values());\r\n    await Promise.all(terminals.map((term) => term.kill()));\r\n\r\n    this.terminals.clear();\r\n  }\r\n\r\n  async createTerminal(): Promise<Terminal> {\r\n    const terminal = new NativeTerminal(this.shell, this.logger);\r\n\r\n    await terminal.initialize();\r\n    this.terminals.set(terminal.id, terminal);\r\n\r\n    return terminal;\r\n  }\r\n\r\n  async destroyTerminal(terminal: Terminal): Promise<void> {\r\n    await terminal.kill();\r\n    this.terminals.delete(terminal.id);\r\n  }\r\n\r\n  private detectShell(): string {\r\n    const osplatform = platform();\r\n\r\n    if (osplatform === 'win32') {\r\n      // Windows shell detection\r\n      const comspec = process.env.COMSPEC;\r\n      if (comspec?.toLowerCase().includes('powershell')) {\r\n        return 'powershell';\r\n      }\r\n\r\n      // Check if PowerShell is available\r\n      try {\r\n        const { spawnSync } = require('child_process');\r\n        const result = spawnSync('powershell', ['-Version'], { stdio: 'ignore' });\r\n        if (result.status === 0) {\r\n          return 'powershell';\r\n        }\r\n      } catch {\r\n        // PowerShell not available\r\n      }\r\n\r\n      return 'cmd';\r\n    } else {\r\n      // Unix-like shell detection\r\n      const shell = process.env.SHELL;\r\n      if (shell) {\r\n        const shellName = shell.split('/').pop();\r\n        if (shellName && this.isShellSupported(shellName)) {\r\n          return shellName;\r\n        }\r\n      }\r\n\r\n      // Try common shells in order of preference\r\n      const shells = ['bash', 'zsh', 'sh'];\r\n      for (const shell of shells) {\r\n        try {\r\n          const { spawnSync } = require('child_process');\r\n          const result = spawnSync('which', [shell], { stdio: 'ignore' });\r\n          if (result.status === 0) {\r\n            return shell;\r\n          }\r\n        } catch {\r\n          // Continue to next shell\r\n        }\r\n      }\r\n\r\n      // Default to sh\r\n      return 'sh';\r\n    }\r\n  }\r\n\r\n  private isShellSupported(shell: string): boolean {\r\n    return ['bash', 'zsh', 'sh', 'fish', 'dash', 'powershell', 'cmd'].includes(shell);\r\n  }\r\n\r\n  private getTestCommand(): { cmd: string; args: string[] } {\r\n    switch (this.shell) {\r\n      case 'powershell':\r\n        return { cmd: 'powershell', args: ['-Version'] };\r\n      case 'cmd':\r\n        return { cmd: 'cmd', args: ['/C', 'echo test'] };\r\n      default:\r\n        return { cmd: this.shell, args: ['--version'] };\r\n    }\r\n  }\r\n}\r\n"],"names":["process","spawn","platform","TerminalError","TerminalCommandError","generateId","delay","timeout","createDeferred","NativeTerminal","id","pid","encoder","TextEncoder","decoder","TextDecoder","shell","outputBuffer","errorBuffer","commandMarker","commandDeferred","outputListeners","Set","alive","stdoutData","stderrData","logger","initialize","shellConfig","getShellConfig","path","args","stdio","env","CLAUDE_FLOW_TERMINAL","CLAUDE_FLOW_TERMINAL_ID","setupOutputHandlers","monitorProcess","waitForReady","debug","error","executeCommand","command","isAlive","markedCommand","wrapCommand","write","output","promise","data","Promise","resolve","reject","stdin","read","undefined","kill","destroyed","end","killed","warn","addOutputListener","listener","add","removeOutputListener","delete","osplatform","PS1","stdout","on","text","toString","processOutput","stderr","notifyListeners","markerIndex","indexOf","substring","trim","fullOutput","length","forEach","code","signal","info","Error","testCommand","startTime","Date","now","includes","NativeAdapter","terminals","Map","detectShell","testConfig","getTestCommand","spawnSync","require","result","cmd","status","shutdown","Array","from","values","all","map","term","clear","createTerminal","terminal","set","destroyTerminal","comspec","COMSPEC","toLowerCase","SHELL","shellName","split","pop","isShellSupported","shells"],"mappings":"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"}
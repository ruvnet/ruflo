{"version":3,"sources":["../../../src/mcp/server.ts"],"sourcesContent":["/**\r\n * MCP (Model Context Protocol) server implementation\r\n */\r\n\r\nimport {\r\n  MCPConfig,\r\n  MCPRequest,\r\n  MCPResponse,\r\n  MCPError,\r\n  MCPTool,\r\n  MCPInitializeParams,\r\n  MCPInitializeResult,\r\n  MCPSession,\r\n  MCPMetrics,\r\n  MCPProtocolVersion,\r\n  MCPCapabilities,\r\n  MCPContext,\r\n} from '../utils/types.js';\r\nimport type { IEventBus } from '../core/event-bus.js';\r\nimport type { ILogger } from '../core/logger.js';\r\nimport { MCPError as MCPErrorClass, MCPMethodNotFoundError } from '../utils/errors.js';\r\nimport type { ITransport } from './transports/base.js';\r\nimport { StdioTransport } from './transports/stdio.js';\r\nimport { HttpTransport } from './transports/http.js';\r\nimport { ToolRegistry } from './tools.js';\r\nimport { RequestRouter } from './router.js';\r\nimport { SessionManager, ISessionManager } from './session-manager.js';\r\nimport { AuthManager, IAuthManager } from './auth.js';\r\nimport { LoadBalancer, ILoadBalancer, RequestQueue } from './load-balancer.js';\r\nimport { createClaudeFlowTools, ClaudeFlowToolContext } from './claude-flow-tools.js';\r\nimport { createSwarmTools, SwarmToolContext } from './swarm-tools.js';\r\nimport {\r\n  createRuvSwarmTools,\r\n  RuvSwarmToolContext,\r\n  isRuvSwarmAvailable,\r\n  initializeRuvSwarmIntegration,\r\n} from './ruv-swarm-tools.js';\r\nimport { platform, arch } from 'node:os';\r\nimport { performance } from 'node:perf_hooks';\r\n\r\nexport interface IMCPServer {\r\n  start(): Promise<void>;\r\n  stop(): Promise<void>;\r\n  registerTool(tool: MCPTool): void;\r\n  getHealthStatus(): Promise<{\r\n    healthy: boolean;\r\n    error?: string;\r\n    metrics?: Record<string, number>;\r\n  }>;\r\n  getMetrics(): MCPMetrics;\r\n  getSessions(): MCPSession[];\r\n  getSession(sessionId: string): MCPSession | undefined;\r\n  terminateSession(sessionId: string): void;\r\n}\r\n\r\n/**\r\n * MCP server implementation\r\n */\r\nexport class MCPServer implements IMCPServer {\r\n  private transport: ITransport;\r\n  private toolRegistry: ToolRegistry;\r\n  private router: RequestRouter;\r\n  private sessionManager: ISessionManager;\r\n  private authManager: IAuthManager;\r\n  private loadBalancer?: ILoadBalancer;\r\n  private requestQueue?: RequestQueue;\r\n  private running = false;\r\n  private currentSession?: MCPSession | undefined;\r\n\r\n  private readonly serverInfo = {\r\n    name: 'Claude-Flow MCP Server',\r\n    version: '1.0.0',\r\n  };\r\n\r\n  private readonly supportedProtocolVersion: MCPProtocolVersion = {\r\n    major: 2024,\r\n    minor: 11,\r\n    patch: 5,\r\n  };\r\n\r\n  private readonly serverCapabilities: MCPCapabilities = {\r\n    logging: {\r\n      level: 'info',\r\n    },\r\n    tools: {\r\n      listChanged: true,\r\n    },\r\n    resources: {\r\n      listChanged: false,\r\n      subscribe: false,\r\n    },\r\n    prompts: {\r\n      listChanged: false,\r\n    },\r\n  };\r\n\r\n  constructor(\r\n    private config: MCPConfig,\r\n    private eventBus: IEventBus,\r\n    private logger: ILogger,\r\n    private orchestrator?: any, // Reference to orchestrator instance\r\n    private swarmCoordinator?: any, // Reference to swarm coordinator instance\r\n    private agentManager?: any, // Reference to agent manager instance\r\n    private resourceManager?: any, // Reference to resource manager instance\r\n    private messagebus?: any, // Reference to message bus instance\r\n    private monitor?: any, // Reference to real-time monitor instance\r\n  ) {\r\n    // Initialize transport\r\n    this.transport = this.createTransport();\r\n\r\n    // Initialize tool registry\r\n    this.toolRegistry = new ToolRegistry(logger);\r\n\r\n    // Initialize session manager\r\n    this.sessionManager = new SessionManager(config, logger);\r\n\r\n    // Initialize auth manager\r\n    this.authManager = new AuthManager(config.auth || { enabled: false, method: 'token' }, logger);\r\n\r\n    // Initialize load balancer if enabled\r\n    if (config.loadBalancer?.enabled) {\r\n      this.loadBalancer = new LoadBalancer(config.loadBalancer, logger);\r\n      this.requestQueue = new RequestQueue(1000, 30000, logger);\r\n    }\r\n\r\n    // Initialize request router\r\n    this.router = new RequestRouter(this.toolRegistry, logger);\r\n  }\r\n\r\n  async start(): Promise<void> {\r\n    if (this.running) {\r\n      throw new MCPErrorClass('MCP server already running');\r\n    }\r\n\r\n    this.logger.info('Starting MCP server', { transport: this.config.transport });\r\n\r\n    try {\r\n      // Set up request handler\r\n      this.transport.onRequest(async (request) => {\r\n        return await this.handleRequest(request);\r\n      });\r\n\r\n      // Start transport\r\n      await this.transport.start();\r\n\r\n      // Register built-in tools\r\n      await this.registerBuiltInTools();\r\n\r\n      this.running = true;\r\n      this.logger.info('MCP server started successfully');\r\n    } catch (error) {\r\n      this.logger.error('Failed to start MCP server', error);\r\n      throw new MCPErrorClass('Failed to start MCP server', { error });\r\n    }\r\n  }\r\n\r\n  async stop(): Promise<void> {\r\n    if (!this.running) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Stopping MCP server');\r\n\r\n    try {\r\n      // Stop transport\r\n      await this.transport.stop();\r\n\r\n      // Clean up session manager\r\n      if (this.sessionManager && 'destroy' in this.sessionManager) {\r\n        (this.sessionManager as any).destroy();\r\n      }\r\n\r\n      // Clean up all sessions\r\n      for (const session of this.sessionManager.getActiveSessions()) {\r\n        this.sessionManager.removeSession(session.id);\r\n      }\r\n\r\n      this.running = false;\r\n      this.currentSession = undefined;\r\n      this.logger.info('MCP server stopped');\r\n    } catch (error) {\r\n      this.logger.error('Error stopping MCP server', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  registerTool(tool: MCPTool): void {\r\n    this.toolRegistry.register(tool);\r\n    this.logger.info('Tool registered', { name: tool.name });\r\n  }\r\n\r\n  async getHealthStatus(): Promise<{\r\n    healthy: boolean;\r\n    error?: string;\r\n    metrics?: Record<string, number>;\r\n  }> {\r\n    try {\r\n      const transportHealth = await this.transport.getHealthStatus();\r\n      const registeredTools = this.toolRegistry.getToolCount();\r\n      const { totalRequests, successfulRequests, failedRequests } = this.router.getMetrics();\r\n      const sessionMetrics = this.sessionManager.getSessionMetrics();\r\n\r\n      const metrics: Record<string, number> = {\r\n        registeredTools,\r\n        totalRequests,\r\n        successfulRequests,\r\n        failedRequests,\r\n        totalSessions: sessionMetrics.total,\r\n        activeSessions: sessionMetrics.active,\r\n        authenticatedSessions: sessionMetrics.authenticated,\r\n        expiredSessions: sessionMetrics.expired,\r\n        ...transportHealth.metrics,\r\n      };\r\n\r\n      if (this.loadBalancer) {\r\n        const lbMetrics = this.loadBalancer.getMetrics();\r\n        metrics.rateLimitedRequests = lbMetrics.rateLimitedRequests;\r\n        metrics.averageResponseTime = lbMetrics.averageResponseTime;\r\n        metrics.requestsPerSecond = lbMetrics.requestsPerSecond;\r\n        metrics.circuitBreakerTrips = lbMetrics.circuitBreakerTrips;\r\n      }\r\n\r\n      const status: { healthy: boolean; error?: string; metrics?: Record<string, number> } = {\r\n        healthy: this.running && transportHealth.healthy,\r\n        metrics,\r\n      };\r\n      if (transportHealth.error !== undefined) {\r\n        status.error = transportHealth.error;\r\n      }\r\n      return status;\r\n    } catch (error) {\r\n      return {\r\n        healthy: false,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      };\r\n    }\r\n  }\r\n\r\n  getMetrics(): MCPMetrics {\r\n    const routerMetrics = this.router.getMetrics();\r\n    const sessionMetrics = this.sessionManager.getSessionMetrics();\r\n    const lbMetrics = this.loadBalancer?.getMetrics();\r\n\r\n    return {\r\n      totalRequests: routerMetrics.totalRequests,\r\n      successfulRequests: routerMetrics.successfulRequests,\r\n      failedRequests: routerMetrics.failedRequests,\r\n      averageResponseTime: lbMetrics?.averageResponseTime || 0,\r\n      activeSessions: sessionMetrics.active,\r\n      toolInvocations: {}, // TODO: Implement tool-specific metrics\r\n      errors: {}, // TODO: Implement error categorization\r\n      lastReset: lbMetrics?.lastReset || new Date(),\r\n    };\r\n  }\r\n\r\n  getSessions(): MCPSession[] {\r\n    return this.sessionManager.getActiveSessions();\r\n  }\r\n\r\n  getSession(sessionId: string): MCPSession | undefined {\r\n    return this.sessionManager.getSession(sessionId);\r\n  }\r\n\r\n  terminateSession(sessionId: string): void {\r\n    this.sessionManager.removeSession(sessionId);\r\n    if (this.currentSession?.id === sessionId) {\r\n      this.currentSession = undefined;\r\n    }\r\n  }\r\n\r\n  private async handleRequest(request: MCPRequest): Promise<MCPResponse> {\r\n    this.logger.debug('Handling MCP request', {\r\n      id: request.id,\r\n      method: request.method,\r\n    });\r\n\r\n    try {\r\n      // Handle initialization request separately\r\n      if (request.method === 'initialize') {\r\n        return await this.handleInitialize(request);\r\n      }\r\n\r\n      // Get or create session\r\n      const session = this.getOrCreateSession();\r\n\r\n      // Check if session is initialized for non-initialize requests\r\n      if (!session.isInitialized) {\r\n        return {\r\n          jsonrpc: '2.0',\r\n          id: request.id,\r\n          error: {\r\n            code: -32002,\r\n            message: 'Server not initialized',\r\n          },\r\n        };\r\n      }\r\n\r\n      // Update session activity\r\n      this.sessionManager.updateActivity(session.id);\r\n\r\n      // Check load balancer constraints\r\n      if (this.loadBalancer) {\r\n        const allowed = await this.loadBalancer.shouldAllowRequest(session, request);\r\n        if (!allowed) {\r\n          return {\r\n            jsonrpc: '2.0',\r\n            id: request.id,\r\n            error: {\r\n              code: -32000,\r\n              message: 'Rate limit exceeded or circuit breaker open',\r\n            },\r\n          };\r\n        }\r\n      }\r\n\r\n      // Record request start\r\n      const requestMetrics = this.loadBalancer?.recordRequestStart(session, request);\r\n\r\n      try {\r\n        // Process request through router\r\n        const result = await this.router.route(request);\r\n\r\n        const response: MCPResponse = {\r\n          jsonrpc: '2.0',\r\n          id: request.id,\r\n          result,\r\n        };\r\n\r\n        // Record success\r\n        if (requestMetrics) {\r\n          this.loadBalancer?.recordRequestEnd(requestMetrics, response);\r\n        }\r\n\r\n        return response;\r\n      } catch (error) {\r\n        // Record failure\r\n        if (requestMetrics) {\r\n          this.loadBalancer?.recordRequestEnd(requestMetrics, undefined, error as Error);\r\n        }\r\n        throw error;\r\n      }\r\n    } catch (error) {\r\n      this.logger.error('Error handling MCP request', {\r\n        id: request.id,\r\n        method: request.method,\r\n        error,\r\n      });\r\n\r\n      return {\r\n        jsonrpc: '2.0',\r\n        id: request.id,\r\n        error: this.errorToMCPError(error),\r\n      };\r\n    }\r\n  }\r\n\r\n  private async handleInitialize(request: MCPRequest): Promise<MCPResponse> {\r\n    try {\r\n      const params = request.params as MCPInitializeParams;\r\n\r\n      if (!params) {\r\n        return {\r\n          jsonrpc: '2.0',\r\n          id: request.id,\r\n          error: {\r\n            code: -32602,\r\n            message: 'Invalid params',\r\n          },\r\n        };\r\n      }\r\n\r\n      // Create session\r\n      const session = this.sessionManager.createSession(this.config.transport);\r\n      this.currentSession = session;\r\n\r\n      // Initialize session\r\n      this.sessionManager.initializeSession(session.id, params);\r\n\r\n      // Prepare response\r\n      const result: MCPInitializeResult = {\r\n        protocolVersion: this.supportedProtocolVersion,\r\n        capabilities: this.serverCapabilities,\r\n        serverInfo: this.serverInfo,\r\n        instructions: 'Claude-Flow MCP Server ready for tool execution',\r\n      };\r\n\r\n      this.logger.info('Session initialized', {\r\n        sessionId: session.id,\r\n        clientInfo: params.clientInfo,\r\n        protocolVersion: params.protocolVersion,\r\n      });\r\n\r\n      return {\r\n        jsonrpc: '2.0',\r\n        id: request.id,\r\n        result,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Error during initialization', error);\r\n      return {\r\n        jsonrpc: '2.0',\r\n        id: request.id,\r\n        error: this.errorToMCPError(error),\r\n      };\r\n    }\r\n  }\r\n\r\n  private getOrCreateSession(): MCPSession {\r\n    if (this.currentSession) {\r\n      return this.currentSession;\r\n    }\r\n\r\n    // For stdio transport, create a default session\r\n    const session = this.sessionManager.createSession(this.config.transport);\r\n    this.currentSession = session;\r\n    return session;\r\n  }\r\n\r\n  private createTransport(): ITransport {\r\n    switch (this.config.transport) {\r\n      case 'stdio':\r\n        return new StdioTransport(this.logger);\r\n\r\n      case 'http':\r\n        return new HttpTransport(\r\n          this.config.host || 'localhost',\r\n          this.config.port || 3000,\r\n          this.config.tlsEnabled || false,\r\n          this.logger,\r\n        );\r\n\r\n      default:\r\n        throw new MCPErrorClass(`Unknown transport type: ${this.config.transport}`);\r\n    }\r\n  }\r\n\r\n  private async registerBuiltInTools(): Promise<void> {\r\n    // System information tool\r\n    this.registerTool({\r\n      name: 'system/info',\r\n      description: 'Get system information',\r\n      inputSchema: {\r\n        type: 'object',\r\n        properties: {},\r\n      },\r\n      handler: async () => {\r\n        return {\r\n          version: '1.0.0',\r\n          platform: platform(),\r\n          arch: arch(),\r\n          runtime: 'Node.js',\r\n          uptime: performance.now(),\r\n        };\r\n      },\r\n    });\r\n\r\n    // Health check tool\r\n    this.registerTool({\r\n      name: 'system/health',\r\n      description: 'Get system health status',\r\n      inputSchema: {\r\n        type: 'object',\r\n        properties: {},\r\n      },\r\n      handler: async () => {\r\n        return await this.getHealthStatus();\r\n      },\r\n    });\r\n\r\n    // List tools\r\n    this.registerTool({\r\n      name: 'tools/list',\r\n      description: 'List all available tools',\r\n      inputSchema: {\r\n        type: 'object',\r\n        properties: {},\r\n      },\r\n      handler: async () => {\r\n        return this.toolRegistry.listTools();\r\n      },\r\n    });\r\n\r\n    // Tool schema\r\n    this.registerTool({\r\n      name: 'tools/schema',\r\n      description: 'Get schema for a specific tool',\r\n      inputSchema: {\r\n        type: 'object',\r\n        properties: {\r\n          name: { type: 'string' },\r\n        },\r\n        required: ['name'],\r\n      },\r\n      handler: async (input: any) => {\r\n        const tool = this.toolRegistry.getTool(input.name);\r\n        if (!tool) {\r\n          throw new Error(`Tool not found: ${input.name}`);\r\n        }\r\n        return {\r\n          name: tool.name,\r\n          description: tool.description,\r\n          inputSchema: tool.inputSchema,\r\n        };\r\n      },\r\n    });\r\n\r\n    // Register Claude-Flow specific tools if orchestrator is available\r\n    if (this.orchestrator) {\r\n      const claudeFlowTools = await createClaudeFlowTools(this.logger);\r\n\r\n      for (const tool of claudeFlowTools) {\r\n        // Wrap the handler to inject orchestrator context\r\n        const originalHandler = tool.handler;\r\n        tool.handler = async (input: unknown, context?: MCPContext) => {\r\n          const claudeFlowContext: ClaudeFlowToolContext = {\r\n            ...context,\r\n            orchestrator: this.orchestrator,\r\n          } as ClaudeFlowToolContext;\r\n\r\n          return await originalHandler(input, claudeFlowContext);\r\n        };\r\n\r\n        this.registerTool(tool);\r\n      }\r\n\r\n      this.logger.info('Registered Claude-Flow tools', { count: claudeFlowTools.length });\r\n    } else {\r\n      this.logger.warn('Orchestrator not available - Claude-Flow tools not registered');\r\n    }\r\n\r\n    // Register Swarm-specific tools if swarm components are available\r\n    if (this.swarmCoordinator || this.agentManager || this.resourceManager) {\r\n      const swarmTools = createSwarmTools(this.logger);\r\n\r\n      for (const tool of swarmTools) {\r\n        // Wrap the handler to inject swarm context\r\n        const originalHandler = tool.handler;\r\n        tool.handler = async (input: unknown, context?: MCPContext) => {\r\n          const swarmContext: SwarmToolContext = {\r\n            ...context,\r\n            swarmCoordinator: this.swarmCoordinator,\r\n            agentManager: this.agentManager,\r\n            resourceManager: this.resourceManager,\r\n            messageBus: this.messagebus,\r\n            monitor: this.monitor,\r\n          } as SwarmToolContext;\r\n\r\n          return await originalHandler(input, swarmContext);\r\n        };\r\n\r\n        this.registerTool(tool);\r\n      }\r\n\r\n      this.logger.info('Registered Swarm tools', { count: swarmTools.length });\r\n    } else {\r\n      this.logger.warn('Swarm components not available - Swarm tools not registered');\r\n    }\r\n\r\n    // Register ruv-swarm MCP tools if available\r\n    this.registerRuvSwarmTools();\r\n  }\r\n\r\n  /**\r\n   * Register ruv-swarm MCP tools if available\r\n   */\r\n  private async registerRuvSwarmTools(): Promise<void> {\r\n    try {\r\n      // Check if ruv-swarm is available\r\n      const available = await isRuvSwarmAvailable(this.logger);\r\n\r\n      if (!available) {\r\n        this.logger.info('ruv-swarm not available - skipping ruv-swarm MCP tools registration');\r\n        return;\r\n      }\r\n\r\n      // Initialize ruv-swarm integration\r\n      const workingDirectory = process.cwd();\r\n      const integration = await initializeRuvSwarmIntegration(workingDirectory, this.logger);\r\n\r\n      if (!integration.success) {\r\n        this.logger.warn('Failed to initialize ruv-swarm integration', {\r\n          error: integration.error,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Create ruv-swarm tools\r\n      const ruvSwarmTools = createRuvSwarmTools(this.logger);\r\n\r\n      for (const tool of ruvSwarmTools) {\r\n        // Wrap the handler to inject ruv-swarm context\r\n        const originalHandler = tool.handler;\r\n        tool.handler = async (input: unknown, context?: MCPContext) => {\r\n          const ruvSwarmContext: RuvSwarmToolContext = {\r\n            ...context,\r\n            workingDirectory,\r\n            sessionId: `mcp-session-${Date.now()}`,\r\n            swarmId: process.env.CLAUDE_SWARM_ID || `mcp-swarm-${Date.now()}`,\r\n          };\r\n\r\n          return await originalHandler(input, ruvSwarmContext);\r\n        };\r\n\r\n        this.registerTool(tool);\r\n      }\r\n\r\n      this.logger.info('Registered ruv-swarm MCP tools', {\r\n        count: ruvSwarmTools.length,\r\n        integration: integration.data,\r\n      });\r\n    } catch (error) {\r\n      this.logger.error('Error registering ruv-swarm MCP tools', error);\r\n    }\r\n  }\r\n\r\n  private errorToMCPError(error): MCPError {\r\n    if (error instanceof MCPMethodNotFoundError) {\r\n      return {\r\n        code: -32601,\r\n        message: error instanceof Error ? error.message : String(error),\r\n        data: error.details,\r\n      };\r\n    }\r\n\r\n    if (error instanceof MCPErrorClass) {\r\n      return {\r\n        code: -32603,\r\n        message: error instanceof Error ? error.message : String(error),\r\n        data: error.details,\r\n      };\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      return {\r\n        code: -32603,\r\n        message: error instanceof Error ? error.message : String(error),\r\n      };\r\n    }\r\n\r\n    return {\r\n      code: -32603,\r\n      message: 'Internal error',\r\n      data: error,\r\n    };\r\n  }\r\n}\r\n"],"names":["MCPError","MCPErrorClass","MCPMethodNotFoundError","StdioTransport","HttpTransport","ToolRegistry","RequestRouter","SessionManager","AuthManager","LoadBalancer","RequestQueue","createClaudeFlowTools","createSwarmTools","createRuvSwarmTools","isRuvSwarmAvailable","initializeRuvSwarmIntegration","platform","arch","performance","MCPServer","transport","toolRegistry","router","sessionManager","authManager","loadBalancer","requestQueue","running","currentSession","serverInfo","name","version","supportedProtocolVersion","major","minor","patch","serverCapabilities","logging","level","tools","listChanged","resources","subscribe","prompts","config","eventBus","logger","orchestrator","swarmCoordinator","agentManager","resourceManager","messagebus","monitor","createTransport","auth","enabled","method","start","info","onRequest","request","handleRequest","registerBuiltInTools","error","stop","destroy","session","getActiveSessions","removeSession","id","undefined","registerTool","tool","register","getHealthStatus","transportHealth","registeredTools","getToolCount","totalRequests","successfulRequests","failedRequests","getMetrics","sessionMetrics","getSessionMetrics","metrics","totalSessions","total","activeSessions","active","authenticatedSessions","authenticated","expiredSessions","expired","lbMetrics","rateLimitedRequests","averageResponseTime","requestsPerSecond","circuitBreakerTrips","status","healthy","Error","message","routerMetrics","toolInvocations","errors","lastReset","Date","getSessions","getSession","sessionId","terminateSession","debug","handleInitialize","getOrCreateSession","isInitialized","jsonrpc","code","updateActivity","allowed","shouldAllowRequest","requestMetrics","recordRequestStart","result","route","response","recordRequestEnd","errorToMCPError","params","createSession","initializeSession","protocolVersion","capabilities","instructions","clientInfo","host","port","tlsEnabled","description","inputSchema","type","properties","handler","runtime","uptime","now","listTools","required","input","getTool","claudeFlowTools","originalHandler","context","claudeFlowContext","count","length","warn","swarmTools","swarmContext","messageBus","registerRuvSwarmTools","available","workingDirectory","process","cwd","integration","success","ruvSwarmTools","ruvSwarmContext","swarmId","env","CLAUDE_SWARM_ID","data","String","details"],"mappings":"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"}
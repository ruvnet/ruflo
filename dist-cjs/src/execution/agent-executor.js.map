{"version":3,"sources":["../../../src/execution/agent-executor.ts"],"sourcesContent":["/**\r\n * Agent Executor - Wrapper around agentic-flow execution engine\r\n * Integrates agentic-flow agents with claude-flow hooks and coordination\r\n */\r\n\r\nimport { exec } from 'child_process';\r\nimport { promisify } from 'util';\r\nimport path from 'path';\r\nimport fs from 'fs-extra';\r\n\r\nconst execAsync = promisify(exec);\r\n\r\nexport interface AgentExecutionOptions {\r\n  agent: string;\r\n  task: string;\r\n  provider?: 'anthropic' | 'openrouter' | 'onnx' | 'gemini';\r\n  model?: string;\r\n  temperature?: number;\r\n  maxTokens?: number;\r\n  outputFormat?: 'text' | 'json' | 'markdown';\r\n  stream?: boolean;\r\n  verbose?: boolean;\r\n  retryOnError?: boolean;\r\n  timeout?: number;\r\n\r\n  // ReasoningBank memory options\r\n  enableMemory?: boolean;           // Enable ReasoningBank learning\r\n  memoryDatabase?: string;          // Path to .swarm/memory.db\r\n  memoryRetrievalK?: number;        // Top-k memories to retrieve (default: 3)\r\n  memoryLearning?: boolean;         // Enable post-task learning (default: true)\r\n  memoryDomain?: string;            // Domain filter for memories\r\n  memoryMinConfidence?: number;     // Minimum confidence threshold (default: 0.5)\r\n  memoryTaskId?: string;            // Unique task ID for tracking\r\n}\r\n\r\nexport interface AgentExecutionResult {\r\n  success: boolean;\r\n  output: string;\r\n  error?: string;\r\n  provider: string;\r\n  model: string;\r\n  tokens?: number;\r\n  cost?: number;\r\n  duration: number;\r\n  agent: string;\r\n  task: string;\r\n\r\n  // ReasoningBank metrics\r\n  memoryEnabled?: boolean;\r\n  memoriesRetrieved?: number;\r\n  memoriesUsed?: string[];          // IDs of memories applied\r\n  memoryLearned?: boolean;          // Whether new memories were created\r\n  memoryVerdict?: 'success' | 'failure';\r\n  memoryConfidence?: number;\r\n  newMemoryIds?: string[];          // IDs of newly created memories\r\n}\r\n\r\nexport class AgentExecutor {\r\n  private readonly agenticFlowPath: string;\r\n  private readonly hooksManager: any;\r\n  private memoryEnabled: boolean = false;\r\n  private memoryDatabase: string = '.swarm/memory.db';\r\n\r\n  constructor(hooksManager?: any) {\r\n    this.hooksManager = hooksManager;\r\n    // Agentic-flow is installed as npm dependency\r\n    this.agenticFlowPath = 'npx agentic-flow';\r\n  }\r\n\r\n  /**\r\n   * Initialize ReasoningBank database\r\n   */\r\n  async initializeMemory(dbPath?: string): Promise<void> {\r\n    const db = dbPath || this.memoryDatabase;\r\n\r\n    try {\r\n      const { stdout } = await execAsync(\r\n        `${this.agenticFlowPath} reasoningbank init`\r\n      );\r\n\r\n      this.memoryEnabled = true;\r\n      this.memoryDatabase = db;\r\n      console.log('✅ ReasoningBank initialized:', db);\r\n    } catch (error: any) {\r\n      console.error('Failed to initialize ReasoningBank:', error.message);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get memory statistics\r\n   */\r\n  async getMemoryStats(): Promise<any> {\r\n    if (!this.memoryEnabled) {\r\n      return { enabled: false, totalMemories: 0 };\r\n    }\r\n\r\n    try {\r\n      const { stdout } = await execAsync(\r\n        `${this.agenticFlowPath} reasoningbank status`\r\n      );\r\n      return { enabled: true, output: stdout };\r\n    } catch (error: any) {\r\n      return { enabled: true, error: error.message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run memory consolidation (dedup + prune)\r\n   */\r\n  async consolidateMemories(): Promise<void> {\r\n    if (!this.memoryEnabled) return;\r\n\r\n    try {\r\n      await execAsync(\r\n        `${this.agenticFlowPath} reasoningbank consolidate`\r\n      );\r\n      console.log('✅ Memory consolidation complete');\r\n    } catch (error: any) {\r\n      console.warn('Consolidation failed:', error.message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute an agent with agentic-flow\r\n   */\r\n  async execute(options: AgentExecutionOptions): Promise<AgentExecutionResult> {\r\n    const startTime = Date.now();\r\n    const taskId = options.memoryTaskId || `task-${Date.now()}`;\r\n\r\n    try {\r\n      // Initialize memory if requested\r\n      if (options.enableMemory && !this.memoryEnabled) {\r\n        try {\r\n          await this.initializeMemory(options.memoryDatabase);\r\n        } catch (error) {\r\n          console.warn('Memory initialization failed, continuing without memory');\r\n        }\r\n      }\r\n\r\n      // Trigger pre-execution hook\r\n      if (this.hooksManager) {\r\n        await this.hooksManager.trigger('pre-agent-execute', {\r\n          agent: options.agent,\r\n          task: options.task,\r\n          provider: options.provider || 'anthropic',\r\n          timestamp: Date.now(),\r\n          memoryEnabled: this.memoryEnabled || options.enableMemory,\r\n        });\r\n      }\r\n\r\n      // Build agentic-flow command\r\n      const command = this.buildCommand(options);\r\n\r\n      // Execute command\r\n      const { stdout, stderr } = await execAsync(command, {\r\n        timeout: options.timeout || 300000, // 5 minutes default\r\n        maxBuffer: 10 * 1024 * 1024, // 10MB buffer,\r\n      });\r\n\r\n      const duration = Date.now() - startTime;\r\n\r\n      // Parse output\r\n      const result: AgentExecutionResult = {\r\n        success: true,\r\n        output: stdout,\r\n        provider: options.provider || 'anthropic',\r\n        model: options.model || 'default',\r\n        duration,\r\n        agent: options.agent,\r\n        task: options.task,\r\n        memoryEnabled: this.memoryEnabled || options.enableMemory || false,\r\n      };\r\n\r\n      // Trigger post-execution hook\r\n      if (this.hooksManager) {\r\n        await this.hooksManager.trigger('post-agent-execute', {\r\n          agent: options.agent,\r\n          task: options.task,\r\n          result,\r\n          success: true,\r\n        });\r\n      }\r\n\r\n      return result;\r\n    } catch (error: any) {\r\n      const duration = Date.now() - startTime;\r\n\r\n      const result: AgentExecutionResult = {\r\n        success: false,\r\n        output: '',\r\n        error: error.message,\r\n        provider: options.provider || 'anthropic',\r\n        model: options.model || 'default',\r\n        duration,\r\n        agent: options.agent,\r\n        task: options.task,\r\n        memoryEnabled: this.memoryEnabled || options.enableMemory || false,\r\n      };\r\n\r\n      // Trigger error hook\r\n      if (this.hooksManager) {\r\n        await this.hooksManager.trigger('agent-execute-error', {\r\n          agent: options.agent,\r\n          task: options.task,\r\n          error: error.message,\r\n        });\r\n      }\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List available agents from agentic-flow\r\n   */\r\n  async listAgents(source?: 'all' | 'package' | 'local'): Promise<string[]> {\r\n    try {\r\n      // Agentic-flow uses 'agent list' command\r\n      const command = source\r\n        ? `${this.agenticFlowPath} agent list --filter ${source}`\r\n        : `${this.agenticFlowPath} agent list`;\r\n\r\n      const { stdout } = await execAsync(command);\r\n\r\n      // Parse agent list from output\r\n      const agents = stdout\r\n        .split('\\n')\r\n        .filter(line => line.trim())\r\n        .map(line => line.trim());\r\n\r\n      return agents;\r\n    } catch (error: any) {\r\n      console.error('Failed to list agents:', error.message);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get agent information\r\n   */\r\n  async getAgentInfo(agentName: string): Promise<any> {\r\n    try {\r\n      // Agentic-flow uses 'agent info' command\r\n      const command = `${this.agenticFlowPath} agent info ${agentName}`;\r\n      const { stdout } = await execAsync(command);\r\n\r\n      // Try to parse as JSON if it looks like JSON\r\n      if (stdout.trim().startsWith('{')) {\r\n        return JSON.parse(stdout);\r\n      }\r\n\r\n      // Otherwise return as plain text\r\n      return { name: agentName, description: stdout };\r\n    } catch (error: any) {\r\n      console.error('Failed to get agent info:', error.message);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build agentic-flow command from options\r\n   */\r\n  private buildCommand(options: AgentExecutionOptions): string {\r\n    const parts = [this.agenticFlowPath];\r\n\r\n    // Agentic-flow uses --agent flag directly (no 'execute' subcommand)\r\n    parts.push('--agent', options.agent);\r\n    parts.push('--task', `\"${options.task.replace(/\"/g, '\\\\\"')}\"`);\r\n\r\n    if (options.provider) {\r\n      parts.push('--provider', options.provider);\r\n    }\r\n\r\n    if (options.model) {\r\n      parts.push('--model', options.model);\r\n    }\r\n\r\n    if (options.temperature !== undefined) {\r\n      parts.push('--temperature', options.temperature.toString());\r\n    }\r\n\r\n    if (options.maxTokens) {\r\n      parts.push('--max-tokens', options.maxTokens.toString());\r\n    }\r\n\r\n    if (options.outputFormat) {\r\n      parts.push('--output-format', options.outputFormat);\r\n    }\r\n\r\n    if (options.stream) {\r\n      parts.push('--stream');\r\n    }\r\n\r\n    if (options.verbose) {\r\n      parts.push('--verbose');\r\n    }\r\n\r\n    // Note: agentic-flow doesn't have a --retry flag\r\n    // Retry logic should be handled by AgentExecutor if needed\r\n\r\n    return parts.join(' ');\r\n  }\r\n}\r\n\r\nexport default AgentExecutor;\r\n"],"names":["exec","promisify","execAsync","AgentExecutor","agenticFlowPath","hooksManager","memoryEnabled","memoryDatabase","initializeMemory","dbPath","db","stdout","console","log","error","message","getMemoryStats","enabled","totalMemories","output","consolidateMemories","warn","execute","options","startTime","Date","now","taskId","memoryTaskId","enableMemory","trigger","agent","task","provider","timestamp","command","buildCommand","stderr","timeout","maxBuffer","duration","result","success","model","listAgents","source","agents","split","filter","line","trim","map","getAgentInfo","agentName","startsWith","JSON","parse","name","description","parts","push","replace","temperature","undefined","toString","maxTokens","outputFormat","stream","verbose","join"],"mappings":"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"}
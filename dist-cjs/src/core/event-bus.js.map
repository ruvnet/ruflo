{"version":3,"sources":["../../../src/core/event-bus.ts"],"sourcesContent":["/**\r\n * Event bus implementation for Claude-Flow\r\n */\r\n\r\nimport { SystemEvents } from '../utils/types.js';\r\nimport type { EventMap } from '../utils/types.js';\r\nimport { TypedEventEmitter } from '../utils/helpers.js';\r\n\r\nexport interface IEventBus {\r\n  emit(event: string, data?: unknown): void;\r\n  on(event: string, handler: (data: unknown) => void): void;\r\n  off(event: string, handler: (data: unknown) => void): void;\r\n  once(event: string, handler: (data: unknown) => void): void;\r\n}\r\n\r\n/**\r\n * Internal typed event bus\r\n */\r\nclass TypedEventBus extends TypedEventEmitter<EventMap> {\r\n  private eventCounts = new Map<keyof EventMap, number>();\r\n  private lastEventTimes = new Map<keyof EventMap, number>();\r\n  private debug: boolean;\r\n\r\n  constructor(debug = false) {\r\n    super();\r\n    this.debug = debug;\r\n  }\r\n\r\n  /**\r\n   * Emits an event with logging\r\n   */\r\n  override emit<K extends keyof EventMap>(event: K, data: EventMap[K]): void {\r\n    if (this.debug) {\r\n      console.debug(`[EventBus] Emitting event: ${String(event)}`, data);\r\n    }\r\n\r\n    // Track event metrics\r\n    const count = this.eventCounts.get(event) || 0;\r\n    this.eventCounts.set(event, count + 1);\r\n    this.lastEventTimes.set(event, Date.now());\r\n\r\n    super.emit(event, data);\r\n  }\r\n\r\n  /**\r\n   * Get event statistics\r\n   */\r\n  getEventStats(): { event: string; count: number; lastEmitted: Date | null }[] {\r\n    const stats: { event: string; count: number; lastEmitted: Date | null }[] = [];\r\n\r\n    for (const [event, count] of this.eventCounts.entries()) {\r\n      const lastTime = this.lastEventTimes.get(event);\r\n      stats.push({\r\n        event: String(event),\r\n        count,\r\n        lastEmitted: lastTime ? new Date(lastTime) : null,\r\n      });\r\n    }\r\n\r\n    return stats.sort((a, b) => b.count - a.count);\r\n  }\r\n\r\n  /**\r\n   * Reset event statistics\r\n   */\r\n  resetStats(): void {\r\n    this.eventCounts.clear();\r\n    this.lastEventTimes.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * Global event bus for system-wide communication\r\n */\r\nexport class EventBus implements IEventBus {\r\n  private static instance: EventBus;\r\n  private typedBus: TypedEventBus;\r\n\r\n  private constructor(debug = false) {\r\n    this.typedBus = new TypedEventBus(debug);\r\n  }\r\n\r\n  /**\r\n   * Gets the singleton instance of the event bus\r\n   */\r\n  static getInstance(debug = false): EventBus {\r\n    if (!EventBus.instance) {\r\n      EventBus.instance = new EventBus(debug);\r\n    }\r\n    return EventBus.instance;\r\n  }\r\n\r\n  /**\r\n   * Emits an event\r\n   */\r\n  emit(event: string, data?: unknown): void {\r\n    // Type-safe emission for known events\r\n    if (event in SystemEvents) {\r\n      this.typedBus.emit(event as keyof EventMap, data as any);\r\n    } else {\r\n      // For custom events, emit as-is\r\n      this.typedBus.emit(event as any, data as any);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registers an event handler\r\n   */\r\n  on(event: string, handler: (data: unknown) => void): void {\r\n    this.typedBus.on(event as any, handler);\r\n  }\r\n\r\n  /**\r\n   * Removes an event handler\r\n   */\r\n  off(event: string, handler: (data: unknown) => void): void {\r\n    this.typedBus.off(event as any, handler);\r\n  }\r\n\r\n  /**\r\n   * Registers a one-time event handler\r\n   */\r\n  once(event: string, handler: (data: unknown) => void): void {\r\n    this.typedBus.once(event as any, handler);\r\n  }\r\n\r\n  /**\r\n   * Waits for an event to occur\r\n   */\r\n  async waitFor(event: string, timeoutMs?: number): Promise<unknown> {\r\n    return new Promise((resolve, reject) => {\r\n      const handler = (data: unknown) => {\r\n        if (timer) clearTimeout(timer);\r\n        resolve(data);\r\n      };\r\n\r\n      let timer: number | undefined;\r\n      if (timeoutMs) {\r\n        timer = setTimeout(() => {\r\n          this.off(event, handler);\r\n          reject(new Error(`Timeout waiting for event: ${event}`));\r\n        }, timeoutMs);\r\n      }\r\n\r\n      this.once(event, handler);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a filtered event listener\r\n   */\r\n  onFiltered(\r\n    event: string,\r\n    filter: (data: unknown) => boolean,\r\n    handler: (data: unknown) => void,\r\n  ): void {\r\n    this.on(event, (data) => {\r\n      if (filter(data)) {\r\n        handler(data);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get event statistics\r\n   */\r\n  getEventStats(): { event: string; count: number; lastEmitted: Date | null }[] {\r\n    return this.typedBus.getEventStats();\r\n  }\r\n\r\n  /**\r\n   * Reset event statistics\r\n   */\r\n  resetStats(): void {\r\n    this.typedBus.resetStats();\r\n  }\r\n\r\n  /**\r\n   * Remove all listeners for an event\r\n   */\r\n  removeAllListeners(event?: string): void {\r\n    this.typedBus.removeAllListeners(event as any);\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const eventBus = EventBus.getInstance();\r\n"],"names":["SystemEvents","TypedEventEmitter","TypedEventBus","eventCounts","Map","lastEventTimes","debug","emit","event","data","console","String","count","get","set","Date","now","getEventStats","stats","entries","lastTime","push","lastEmitted","sort","a","b","resetStats","clear","EventBus","instance","typedBus","getInstance","on","handler","off","once","waitFor","timeoutMs","Promise","resolve","reject","timer","clearTimeout","setTimeout","Error","onFiltered","filter","removeAllListeners","eventBus"],"mappings":"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"}
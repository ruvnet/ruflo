{"version":3,"sources":["../../../../src/cli/simple-commands/memory.js"],"sourcesContent":["// memory.js - Memory management commands\r\nimport { printSuccess, printError, printWarning, printInfo } from '../utils.js';\r\nimport { promises as fs } from 'fs';\r\nimport { cwd, exit, existsSync } from '../node-compat.js';\r\nimport { getUnifiedMemory } from '../../memory/unified-memory-manager.js';\r\nimport { KeyRedactor } from '../../utils/key-redactor.js';\r\nimport { exec } from 'child_process';\r\nimport { promisify } from 'util';\r\n\r\nconst execAsync = promisify(exec);\r\n\r\nexport async function memoryCommand(subArgs, flags) {\r\n  const memorySubcommand = subArgs[0];\r\n  const memoryStore = './memory/memory-store.json';\r\n\r\n  // Extract namespace from flags or subArgs\r\n  const namespace = flags?.namespace || flags?.ns || getNamespaceFromArgs(subArgs) || 'default';\r\n\r\n  // Check for redaction flag\r\n  const enableRedaction = flags?.redact || subArgs.includes('--redact') || subArgs.includes('--secure');\r\n\r\n  // NEW: Detect memory mode (basic, reasoningbank, auto)\r\n  const mode = await detectMemoryMode(flags, subArgs);\r\n\r\n  // Helper to load memory data\r\n  async function loadMemory() {\r\n    try {\r\n      const content = await fs.readFile(memoryStore, 'utf8');\r\n      return JSON.parse(content);\r\n    } catch {\r\n      return {};\r\n    }\r\n  }\r\n\r\n  // Helper to save memory data\r\n  async function saveMemory(data) {\r\n    await fs.mkdir('./memory', { recursive: true });\r\n    await fs.writeFile(memoryStore, JSON.stringify(data, null, 2, 'utf8'));\r\n  }\r\n\r\n  // NEW: Handle ReasoningBank-specific commands\r\n  if (mode === 'reasoningbank' && ['init', 'status', 'consolidate', 'demo', 'test', 'benchmark'].includes(memorySubcommand)) {\r\n    return await handleReasoningBankCommand(memorySubcommand, subArgs, flags);\r\n  }\r\n\r\n  // NEW: Handle new mode management commands\r\n  if (['detect', 'mode', 'migrate'].includes(memorySubcommand)) {\r\n    return await handleModeCommand(memorySubcommand, subArgs, flags);\r\n  }\r\n\r\n  // NEW: Delegate to ReasoningBank for regular commands if mode is set\r\n  // Note: 'stats' is handled in switch statement for unified output\r\n  if (mode === 'reasoningbank' && ['store', 'query', 'list'].includes(memorySubcommand)) {\r\n    return await handleReasoningBankCommand(memorySubcommand, subArgs, flags);\r\n  }\r\n\r\n  switch (memorySubcommand) {\r\n    case 'store':\r\n      await storeMemory(subArgs, loadMemory, saveMemory, namespace, enableRedaction);\r\n      break;\r\n\r\n    case 'query':\r\n      await queryMemory(subArgs, loadMemory, namespace, enableRedaction);\r\n      break;\r\n\r\n    case 'stats':\r\n      // Always use showMemoryStats for unified output\r\n      // It will detect mode and show appropriate stats\r\n      await showMemoryStats(loadMemory, mode);\r\n      break;\r\n\r\n    case 'export':\r\n      await exportMemory(subArgs, loadMemory, namespace);\r\n      break;\r\n\r\n    case 'import':\r\n      await importMemory(subArgs, saveMemory, loadMemory);\r\n      break;\r\n\r\n    case 'clear':\r\n      await clearMemory(subArgs, saveMemory, namespace);\r\n      break;\r\n\r\n    case 'list':\r\n      await listNamespaces(loadMemory);\r\n      break;\r\n\r\n    default:\r\n      showMemoryHelp();\r\n  }\r\n}\r\n\r\nasync function storeMemory(subArgs, loadMemory, saveMemory, namespace, enableRedaction = false) {\r\n  const key = subArgs[1];\r\n  let value = subArgs.slice(2).join(' ');\r\n\r\n  if (!key || !value) {\r\n    printError('Usage: memory store <key> <value> [--namespace <ns>] [--redact]');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Apply redaction if enabled\r\n    let redactedValue = value;\r\n    let securityWarnings = [];\r\n\r\n    if (enableRedaction) {\r\n      redactedValue = KeyRedactor.redact(value, true);\r\n      const validation = KeyRedactor.validate(value);\r\n\r\n      if (!validation.safe) {\r\n        securityWarnings = validation.warnings;\r\n        printWarning('üîí Redaction enabled: Sensitive data detected and redacted');\r\n        securityWarnings.forEach(warning => console.log(`   ‚ö†Ô∏è  ${warning}`));\r\n      }\r\n    } else {\r\n      // Even if redaction is not explicitly enabled, validate and warn\r\n      const validation = KeyRedactor.validate(value);\r\n      if (!validation.safe) {\r\n        printWarning('‚ö†Ô∏è  Potential sensitive data detected! Use --redact flag for automatic redaction');\r\n        validation.warnings.forEach(warning => console.log(`   ‚ö†Ô∏è  ${warning}`));\r\n        console.log('   üí° Tip: Add --redact flag to automatically redact API keys');\r\n      }\r\n    }\r\n\r\n    const data = await loadMemory();\r\n\r\n    if (!data[namespace]) {\r\n      data[namespace] = [];\r\n    }\r\n\r\n    // Remove existing entry with same key\r\n    data[namespace] = data[namespace].filter((e) => e.key !== key);\r\n\r\n    // Add new entry with redacted value\r\n    data[namespace].push({\r\n      key,\r\n      value: redactedValue,\r\n      namespace,\r\n      timestamp: Date.now(),\r\n      redacted: enableRedaction && securityWarnings.length > 0,\r\n    });\r\n\r\n    await saveMemory(data);\r\n    printSuccess(enableRedaction && securityWarnings.length > 0 ? 'üîí Stored successfully (with redaction)' : '‚úÖ Stored successfully');\r\n    console.log(`üìù Key: ${key}`);\r\n    console.log(`üì¶ Namespace: ${namespace}`);\r\n    console.log(`üíæ Size: ${new TextEncoder().encode(redactedValue).length} bytes`);\r\n    if (enableRedaction && securityWarnings.length > 0) {\r\n      console.log(`üîí Security: ${securityWarnings.length} sensitive pattern(s) redacted`);\r\n    }\r\n  } catch (err) {\r\n    printError(`Failed to store: ${err.message}`);\r\n  }\r\n}\r\n\r\nasync function queryMemory(subArgs, loadMemory, namespace, enableRedaction = false) {\r\n  const search = subArgs.slice(1).join(' ');\r\n\r\n  if (!search) {\r\n    printError('Usage: memory query <search> [--namespace <ns>] [--redact]');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const data = await loadMemory();\r\n    const results = [];\r\n\r\n    for (const [ns, entries] of Object.entries(data)) {\r\n      if (namespace && ns !== namespace) continue;\r\n\r\n      for (const entry of entries) {\r\n        if (entry.key.includes(search) || entry.value.includes(search)) {\r\n          results.push(entry);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (results.length === 0) {\r\n      printWarning('No results found');\r\n      return;\r\n    }\r\n\r\n    printSuccess(`Found ${results.length} results:`);\r\n\r\n    // Sort by timestamp (newest first)\r\n    results.sort((a, b) => b.timestamp - a.timestamp);\r\n\r\n    for (const entry of results.slice(0, 10)) {\r\n      console.log(`\\nüìå ${entry.key}`);\r\n      console.log(`   Namespace: ${entry.namespace}`);\r\n\r\n      // Apply redaction to displayed value if requested\r\n      let displayValue = entry.value;\r\n      if (enableRedaction) {\r\n        displayValue = KeyRedactor.redact(displayValue, true);\r\n      }\r\n\r\n      console.log(\r\n        `   Value: ${displayValue.substring(0, 100)}${displayValue.length > 100 ? '...' : ''}`,\r\n      );\r\n      console.log(`   Stored: ${new Date(entry.timestamp).toLocaleString()}`);\r\n\r\n      // Show redaction status\r\n      if (entry.redacted) {\r\n        console.log(`   üîí Status: Redacted on storage`);\r\n      } else if (enableRedaction) {\r\n        console.log(`   üîí Status: Redacted for display`);\r\n      }\r\n    }\r\n\r\n    if (results.length > 10) {\r\n      console.log(`\\n... and ${results.length - 10} more results`);\r\n    }\r\n  } catch (err) {\r\n    printError(`Failed to query: ${err.message}`);\r\n  }\r\n}\r\n\r\nasync function showMemoryStats(loadMemory, mode) {\r\n  try {\r\n    const rbInitialized = await isReasoningBankInitialized();\r\n\r\n    // If in auto mode and ReasoningBank is initialized, show unified stats\r\n    if (mode === 'reasoningbank' || (rbInitialized && mode !== 'basic')) {\r\n      // Show unified statistics for both backends\r\n      printSuccess('Memory Bank Statistics:\\n');\r\n\r\n      // JSON Storage stats\r\n      const data = await loadMemory();\r\n      let totalEntries = 0;\r\n      const namespaceStats = {};\r\n\r\n      for (const [namespace, entries] of Object.entries(data)) {\r\n        namespaceStats[namespace] = entries.length;\r\n        totalEntries += entries.length;\r\n      }\r\n\r\n      console.log('üìÅ JSON Storage (./memory/memory-store.json):');\r\n      console.log(`   Total Entries: ${totalEntries}`);\r\n      console.log(`   Namespaces: ${Object.keys(data).length}`);\r\n      console.log(\r\n        `   Size: ${(new TextEncoder().encode(JSON.stringify(data)).length / 1024).toFixed(2)} KB`,\r\n      );\r\n\r\n      if (Object.keys(data).length > 0) {\r\n        console.log('   Namespace Breakdown:');\r\n        for (const [namespace, count] of Object.entries(namespaceStats)) {\r\n          console.log(`     ${namespace}: ${count} entries`);\r\n        }\r\n      }\r\n\r\n      // ReasoningBank stats\r\n      if (rbInitialized) {\r\n        try {\r\n          const { getStatus } = await import('../../reasoningbank/reasoningbank-adapter.js');\r\n          const rbStats = await getStatus();\r\n\r\n          console.log('\\nüß† ReasoningBank Storage (.swarm/memory.db):');\r\n          console.log(`   Total Memories: ${rbStats.total_memories}`);\r\n          console.log(`   Categories: ${rbStats.total_categories}`);\r\n          console.log(`   Average Confidence: ${(rbStats.avg_confidence * 100).toFixed(1)}%`);\r\n          console.log(`   Embeddings: ${rbStats.total_embeddings}`);\r\n          console.log(`   Trajectories: ${rbStats.total_trajectories}`);\r\n\r\n          // Get database file size\r\n          try {\r\n            const dbPath = rbStats.database_path || '.swarm/memory.db';\r\n            const stats = await fs.stat(dbPath);\r\n            console.log(`   Database Size: ${(stats.size / 1024 / 1024).toFixed(2)} MB`);\r\n          } catch (sizeErr) {\r\n            // Ignore size calculation errors\r\n          }\r\n\r\n          console.log('\\nüí° Active Mode: ReasoningBank (auto-selected)');\r\n          console.log('   Use --basic flag to force JSON-only statistics');\r\n        } catch (rbErr) {\r\n          console.log('\\n‚ö†Ô∏è  ReasoningBank stats unavailable:', rbErr.message);\r\n        }\r\n      }\r\n    } else {\r\n      // Basic mode - JSON only\r\n      const data = await loadMemory();\r\n      let totalEntries = 0;\r\n      const namespaceStats = {};\r\n\r\n      for (const [namespace, entries] of Object.entries(data)) {\r\n        namespaceStats[namespace] = entries.length;\r\n        totalEntries += entries.length;\r\n      }\r\n\r\n      printSuccess('Memory Bank Statistics (JSON Mode):');\r\n      console.log(`   Total Entries: ${totalEntries}`);\r\n      console.log(`   Namespaces: ${Object.keys(data).length}`);\r\n      console.log(\r\n        `   Size: ${(new TextEncoder().encode(JSON.stringify(data)).length / 1024).toFixed(2)} KB`,\r\n      );\r\n\r\n      if (Object.keys(data).length > 0) {\r\n        console.log('\\nüìÅ Namespace Breakdown:');\r\n        for (const [namespace, count] of Object.entries(namespaceStats)) {\r\n          console.log(`   ${namespace}: ${count} entries`);\r\n        }\r\n      }\r\n\r\n      if (!rbInitialized) {\r\n        console.log('\\nüí° Tip: Initialize ReasoningBank for AI-powered memory');\r\n        console.log('   Run: memory init --reasoningbank');\r\n      }\r\n    }\r\n  } catch (err) {\r\n    printError(`Failed to get stats: ${err.message}`);\r\n  }\r\n}\r\n\r\nasync function exportMemory(subArgs, loadMemory, namespace) {\r\n  const filename = subArgs[1] || `memory-export-${Date.now()}.json`;\r\n\r\n  try {\r\n    const data = await loadMemory();\r\n\r\n    let exportData = data;\r\n    if (namespace) {\r\n      exportData = { [namespace]: data[namespace] || [] };\r\n    }\r\n\r\n    await fs.writeFile(filename, JSON.stringify(exportData, null, 2, 'utf8'));\r\n    printSuccess(`Memory exported to ${filename}`);\r\n\r\n    let totalEntries = 0;\r\n    for (const entries of Object.values(exportData)) {\r\n      totalEntries += entries.length;\r\n    }\r\n    console.log(\r\n      `üì¶ Exported ${totalEntries} entries from ${Object.keys(exportData).length} namespace(s)`,\r\n    );\r\n  } catch (err) {\r\n    printError(`Failed to export memory: ${err.message}`);\r\n  }\r\n}\r\n\r\nasync function importMemory(subArgs, saveMemory, loadMemory) {\r\n  const filename = subArgs[1];\r\n\r\n  if (!filename) {\r\n    printError('Usage: memory import <filename>');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const importContent = await fs.readFile(filename, 'utf8');\r\n    const importData = JSON.parse(importContent);\r\n\r\n    // Load existing memory\r\n    const existingData = await loadMemory();\r\n\r\n    // Merge imported data\r\n    let totalImported = 0;\r\n    for (const [namespace, entries] of Object.entries(importData)) {\r\n      if (!existingData[namespace]) {\r\n        existingData[namespace] = [];\r\n      }\r\n\r\n      // Add entries that don't already exist (by key)\r\n      const existingKeys = new Set(existingData[namespace].map((e) => e.key));\r\n      const newEntries = entries.filter((e) => !existingKeys.has(e.key));\r\n\r\n      existingData[namespace].push(...newEntries);\r\n      totalImported += newEntries.length;\r\n    }\r\n\r\n    await saveMemory(existingData);\r\n    printSuccess(`Imported ${totalImported} new entries from ${filename}`);\r\n  } catch (err) {\r\n    printError(`Failed to import memory: ${err.message}`);\r\n  }\r\n}\r\n\r\nasync function clearMemory(subArgs, saveMemory, namespace) {\r\n  if (!namespace || namespace === 'default') {\r\n    const nsFromArgs = getNamespaceFromArgs(subArgs);\r\n    if (!nsFromArgs) {\r\n      printError('Usage: memory clear --namespace <namespace>');\r\n      printWarning('This will clear all entries in the specified namespace');\r\n      return;\r\n    }\r\n    namespace = nsFromArgs;\r\n  }\r\n\r\n  try {\r\n    // Helper to load memory data\r\n    async function loadMemory() {\r\n      try {\r\n        const content = await fs.readFile('./memory/memory-store.json', 'utf8');\r\n        return JSON.parse(content);\r\n      } catch {\r\n        return {};\r\n      }\r\n    }\r\n    \r\n    const data = await loadMemory();\r\n\r\n    if (!data[namespace]) {\r\n      printWarning(`Namespace '${namespace}' does not exist`);\r\n      return;\r\n    }\r\n\r\n    const entryCount = data[namespace].length;\r\n    delete data[namespace];\r\n\r\n    await saveMemory(data);\r\n    printSuccess(`Cleared ${entryCount} entries from namespace '${namespace}'`);\r\n  } catch (err) {\r\n    printError(`Failed to clear memory: ${err.message}`);\r\n  }\r\n}\r\n\r\nasync function listNamespaces(loadMemory) {\r\n  try {\r\n    const data = await loadMemory();\r\n    const namespaces = Object.keys(data);\r\n\r\n    if (namespaces.length === 0) {\r\n      printWarning('No namespaces found');\r\n      return;\r\n    }\r\n\r\n    printSuccess('Available namespaces:');\r\n    for (const namespace of namespaces) {\r\n      const count = data[namespace].length;\r\n      console.log(`  ${namespace} (${count} entries)`);\r\n    }\r\n  } catch (err) {\r\n    printError(`Failed to list namespaces: ${err.message}`);\r\n  }\r\n}\r\n\r\nfunction getNamespaceFromArgs(subArgs) {\r\n  const namespaceIndex = subArgs.indexOf('--namespace');\r\n  if (namespaceIndex !== -1 && namespaceIndex + 1 < subArgs.length) {\r\n    return subArgs[namespaceIndex + 1];\r\n  }\r\n\r\n  const nsIndex = subArgs.indexOf('--ns');\r\n  if (nsIndex !== -1 && nsIndex + 1 < subArgs.length) {\r\n    return subArgs[nsIndex + 1];\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n// Helper to load memory data (needed for import function)\r\nasync function loadMemory() {\r\n  try {\r\n    const content = await fs.readFile('./memory/memory-store.json', 'utf8');\r\n    return JSON.parse(content);\r\n  } catch {\r\n    return {};\r\n  }\r\n}\r\n\r\n// NEW: Mode detection function\r\nasync function detectMemoryMode(flags, subArgs) {\r\n  // Explicit ReasoningBank flag takes precedence\r\n  if (flags?.reasoningbank || flags?.rb || subArgs.includes('--reasoningbank') || subArgs.includes('--rb')) {\r\n    return 'reasoningbank';\r\n  }\r\n\r\n  // Auto mode: detect if ReasoningBank is initialized\r\n  if (flags?.auto || subArgs.includes('--auto')) {\r\n    const initialized = await isReasoningBankInitialized();\r\n    return initialized ? 'reasoningbank' : 'basic';\r\n  }\r\n\r\n  // Explicit basic mode flag\r\n  if (flags?.basic || subArgs.includes('--basic')) {\r\n    return 'basic';\r\n  }\r\n\r\n  // Default: AUTO MODE with SQLite preference\r\n  // Try to use ReasoningBank (SQLite) by default, initialize if needed\r\n  const initialized = await isReasoningBankInitialized();\r\n\r\n  if (initialized) {\r\n    return 'reasoningbank';\r\n  }\r\n\r\n  // Not initialized yet - try to auto-initialize on first use\r\n  try {\r\n    const { initializeReasoningBank } = await import('../../reasoningbank/reasoningbank-adapter.js');\r\n    const initialized = await initializeReasoningBank();\r\n\r\n    // Check if initialization succeeded (returns true) or failed (returns false)\r\n    if (!initialized) {\r\n      // Initialization failed but didn't throw - fall back to JSON\r\n      const isNpx = process.env.npm_config_user_agent?.includes('npx') ||\r\n                    process.cwd().includes('_npx');\r\n      if (isNpx) {\r\n        console.log('\\n‚úÖ Automatically using JSON fallback for this command\\n');\r\n      } else {\r\n        printWarning(`‚ö†Ô∏è  SQLite unavailable, using JSON fallback`);\r\n      }\r\n      return 'basic';\r\n    }\r\n\r\n    printInfo('üóÑÔ∏è  Initialized SQLite backend (.swarm/memory.db)');\r\n    return 'reasoningbank';\r\n  } catch (error) {\r\n    // SQLite initialization failed - fall back to JSON\r\n    const isSqliteError = error.message?.includes('BetterSqlite3') ||\r\n                          error.message?.includes('better-sqlite3') ||\r\n                          error.message?.includes('could not run migrations') ||\r\n                          error.message?.includes('ReasoningBank initialization failed');\r\n    const isNpx = process.env.npm_config_user_agent?.includes('npx') ||\r\n                  process.cwd().includes('_npx');\r\n\r\n    if (isSqliteError && isNpx) {\r\n      // Silent fallback for npx - error already shown by adapter\r\n      console.log('\\n‚úÖ Automatically using JSON fallback for this command\\n');\r\n      return 'basic';\r\n    } else {\r\n      printWarning(`‚ö†Ô∏è  SQLite unavailable, using JSON fallback`);\r\n      printWarning(`   Reason: ${error.message}`);\r\n      return 'basic';\r\n    }\r\n  }\r\n}\r\n\r\n// NEW: Check if ReasoningBank is initialized\r\nasync function isReasoningBankInitialized() {\r\n  try {\r\n    // Check if .swarm/memory.db exists\r\n    const dbPath = '.swarm/memory.db';\r\n    await fs.access(dbPath);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// NEW: Handle ReasoningBank commands\r\nasync function handleReasoningBankCommand(command, subArgs, flags) {\r\n  const initialized = await isReasoningBankInitialized();\r\n\r\n  // Lazy load the adapter (ES modules)\r\n  const { initializeReasoningBank, storeMemory, queryMemories, listMemories, getStatus, checkReasoningBankTables, migrateReasoningBank, cleanup } = await import('../../reasoningbank/reasoningbank-adapter.js');\r\n\r\n  // Special handling for 'init' command\r\n  if (command === 'init') {\r\n    const dbPath = '.swarm/memory.db';\r\n\r\n    if (initialized) {\r\n      // Database exists - check if migration is needed\r\n      printInfo('üîç Checking existing database for ReasoningBank schema...\\n');\r\n\r\n      try {\r\n        // Set the database path for ReasoningBank\r\n        process.env.CLAUDE_FLOW_DB_PATH = dbPath;\r\n\r\n        const tableCheck = await checkReasoningBankTables();\r\n\r\n        if (tableCheck.exists) {\r\n          printSuccess('‚úÖ ReasoningBank already complete');\r\n          console.log('Database: .swarm/memory.db');\r\n          console.log('All ReasoningBank tables present\\n');\r\n          console.log('Use --reasoningbank flag with memory commands to enable AI features');\r\n          return;\r\n        }\r\n\r\n        // Missing tables found - run migration\r\n        console.log(`üîÑ Migrating database: ${tableCheck.missingTables.length} tables missing`);\r\n        console.log(`   Missing: ${tableCheck.missingTables.join(', ')}\\n`);\r\n\r\n        const migrationResult = await migrateReasoningBank();\r\n\r\n        if (migrationResult.success) {\r\n          printSuccess(`‚úì Migration complete: added ${migrationResult.addedTables?.length || 0} tables`);\r\n          console.log('\\nNext steps:');\r\n          console.log('  1. Store memories: memory store key \"value\" --reasoningbank');\r\n          console.log('  2. Query memories: memory query \"search\" --reasoningbank');\r\n          console.log('  3. Check status: memory status --reasoningbank');\r\n        } else {\r\n          printError(`‚ùå Migration failed: ${migrationResult.message}`);\r\n          console.log('Try running: init --force to reinitialize');\r\n        }\r\n      } catch (error) {\r\n        printError('‚ùå Migration check failed');\r\n        console.error(error.message);\r\n        console.log('\\nTry running: init --force to reinitialize');\r\n      } finally {\r\n        // Cleanup after migration check\r\n        cleanup();\r\n        // Force exit to prevent hanging from embedding cache timers\r\n        setTimeout(() => process.exit(0), 100);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Fresh initialization\r\n    printInfo('üß† Initializing ReasoningBank...');\r\n    console.log('This will create: .swarm/memory.db\\n');\r\n\r\n    try {\r\n      await initializeReasoningBank();\r\n      printSuccess('‚úÖ ReasoningBank initialized successfully!');\r\n      console.log('\\nNext steps:');\r\n      console.log('  1. Store memories: memory store key \"value\" --reasoningbank');\r\n      console.log('  2. Query memories: memory query \"search\" --reasoningbank');\r\n      console.log('  3. Check status: memory status --reasoningbank');\r\n    } catch (error) {\r\n      printError('‚ùå Failed to initialize ReasoningBank');\r\n      console.error(error.message);\r\n    } finally {\r\n      // Cleanup after init\r\n      cleanup();\r\n      // Force exit to prevent hanging from embedding cache timers\r\n      setTimeout(() => process.exit(0), 100);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // All other commands require initialization\r\n  if (!initialized) {\r\n    printError('‚ùå ReasoningBank not initialized');\r\n    console.log('\\nTo use ReasoningBank mode, first run:');\r\n    console.log('  memory init --reasoningbank\\n');\r\n    return;\r\n  }\r\n\r\n  printInfo(`üß† Using ReasoningBank mode...`);\r\n\r\n  try {\r\n    // Handle different commands\r\n    switch (command) {\r\n      case 'store':\r\n        await handleReasoningBankStore(subArgs, flags, storeMemory);\r\n        break;\r\n\r\n      case 'query':\r\n        await handleReasoningBankQuery(subArgs, flags, queryMemories);\r\n        break;\r\n\r\n      case 'list':\r\n        await handleReasoningBankList(subArgs, flags, listMemories);\r\n        break;\r\n\r\n      case 'status':\r\n        await handleReasoningBankStatus(getStatus);\r\n        break;\r\n\r\n      case 'stats':\r\n        await handleReasoningBankStatus(getStatus);\r\n        break;\r\n\r\n      case 'consolidate':\r\n      case 'demo':\r\n      case 'test':\r\n      case 'benchmark':\r\n        // These still use CLI commands\r\n        const cmd = `npx agentic-flow reasoningbank ${command}`;\r\n        const { stdout } = await execAsync(cmd, { timeout: 60000 });\r\n        if (stdout) console.log(stdout);\r\n        break;\r\n\r\n      default:\r\n        printError(`Unknown ReasoningBank command: ${command}`);\r\n    }\r\n  } catch (error) {\r\n    printError(`‚ùå ReasoningBank command failed`);\r\n    console.error(error.message);\r\n  } finally {\r\n    // Always cleanup database connection\r\n    cleanup();\r\n\r\n    // Force process exit after cleanup (embedding cache timers prevent natural exit)\r\n    // This is necessary because agentic-flow's embedding cache uses setTimeout\r\n    // which keeps the event loop alive\r\n    setTimeout(() => {\r\n      process.exit(0);\r\n    }, 100);\r\n  }\r\n}\r\n\r\n// NEW: Handle ReasoningBank store\r\nasync function handleReasoningBankStore(subArgs, flags, storeMemory) {\r\n  const key = subArgs[1];\r\n  const value = subArgs.slice(2).join(' ');\r\n\r\n  if (!key || !value) {\r\n    printError('Usage: memory store <key> <value> --reasoningbank');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const namespace = flags?.namespace || flags?.ns || getArgValue(subArgs, '--namespace') || 'default';\r\n\r\n    const memoryId = await storeMemory(key, value, {\r\n      namespace,\r\n      agent: 'memory-agent',\r\n      domain: namespace,\r\n    });\r\n\r\n    printSuccess('‚úÖ Stored successfully in ReasoningBank');\r\n    console.log(`üìù Key: ${key}`);\r\n    console.log(`üß† Memory ID: ${memoryId}`);\r\n    console.log(`üì¶ Namespace: ${namespace}`);\r\n    console.log(`üíæ Size: ${new TextEncoder().encode(value).length} bytes`);\r\n    console.log(`üîç Semantic search: enabled`);\r\n  } catch (error) {\r\n    printError(`Failed to store: ${error.message}`);\r\n  }\r\n}\r\n\r\n// NEW: Handle ReasoningBank query\r\nasync function handleReasoningBankQuery(subArgs, flags, queryMemories) {\r\n  const search = subArgs.slice(1).join(' ');\r\n\r\n  if (!search) {\r\n    printError('Usage: memory query <search> --reasoningbank');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const namespace = flags?.namespace || flags?.ns || getArgValue(subArgs, '--namespace');\r\n    const results = await queryMemories(search, {\r\n      domain: namespace || 'general',\r\n      limit: 10,\r\n    });\r\n\r\n    if (results.length === 0) {\r\n      printWarning('No results found');\r\n      return;\r\n    }\r\n\r\n    printSuccess(`Found ${results.length} results (semantic search):`);\r\n\r\n    for (const entry of results) {\r\n      console.log(`\\nüìå ${entry.key}`);\r\n      console.log(`   Namespace: ${entry.namespace}`);\r\n      console.log(`   Value: ${entry.value.substring(0, 100)}${entry.value.length > 100 ? '...' : ''}`);\r\n      console.log(`   Confidence: ${(entry.confidence * 100).toFixed(1)}%`);\r\n      console.log(`   Usage: ${entry.usage_count} times`);\r\n      if (entry.score) {\r\n        console.log(`   Match Score: ${(entry.score * 100).toFixed(1)}%`);\r\n      }\r\n      console.log(`   Stored: ${new Date(entry.created_at).toLocaleString()}`);\r\n    }\r\n  } catch (error) {\r\n    printError(`Failed to query: ${error.message}`);\r\n  }\r\n}\r\n\r\n// NEW: Handle ReasoningBank list\r\nasync function handleReasoningBankList(subArgs, flags, listMemories) {\r\n  try {\r\n    const sort = flags?.sort || getArgValue(subArgs, '--sort') || 'created_at';\r\n    const limit = parseInt(flags?.limit || getArgValue(subArgs, '--limit') || '10');\r\n\r\n    const results = await listMemories({ sort, limit });\r\n\r\n    if (results.length === 0) {\r\n      printWarning('No memories found');\r\n      return;\r\n    }\r\n\r\n    printSuccess(`ReasoningBank memories (${results.length} shown):`);\r\n\r\n    for (const entry of results) {\r\n      console.log(`\\nüìå ${entry.key}`);\r\n      console.log(`   Value: ${entry.value.substring(0, 80)}${entry.value.length > 80 ? '...' : ''}`);\r\n      console.log(`   Confidence: ${(entry.confidence * 100).toFixed(1)}% | Usage: ${entry.usage_count}`);\r\n    }\r\n  } catch (error) {\r\n    printError(`Failed to list: ${error.message}`);\r\n  }\r\n}\r\n\r\n// NEW: Handle ReasoningBank status\r\nasync function handleReasoningBankStatus(getStatus) {\r\n  try {\r\n    const stats = await getStatus();\r\n\r\n    printSuccess('üìä ReasoningBank Status:');\r\n    console.log(`   Total memories: ${stats.total_memories}`);\r\n    console.log(`   Average confidence: ${(stats.avg_confidence * 100).toFixed(1)}%`);\r\n    console.log(`   Total usage: ${stats.total_usage}`);\r\n    console.log(`   Embeddings: ${stats.total_embeddings}`);\r\n    console.log(`   Trajectories: ${stats.total_trajectories}`);\r\n  } catch (error) {\r\n    printError(`Failed to get status: ${error.message}`);\r\n  }\r\n}\r\n\r\n// NEW: Build agentic-flow reasoningbank command\r\nfunction buildReasoningBankCommand(command, subArgs, flags) {\r\n  const parts = ['npx', 'agentic-flow', 'reasoningbank'];\r\n\r\n  // Map memory commands to reasoningbank commands\r\n  const commandMap = {\r\n    store: 'store',\r\n    query: 'query',\r\n    list: 'list',\r\n    status: 'status',\r\n    consolidate: 'consolidate',\r\n    demo: 'demo',\r\n    test: 'test',\r\n    benchmark: 'benchmark',\r\n  };\r\n\r\n  parts.push(commandMap[command] || command);\r\n\r\n  // Add arguments (skip the command itself)\r\n  const args = subArgs.slice(1);\r\n  args.forEach((arg) => {\r\n    if (!arg.startsWith('--reasoningbank') && !arg.startsWith('--rb') && !arg.startsWith('--auto')) {\r\n      parts.push(`\"${arg}\"`);\r\n    }\r\n  });\r\n\r\n  // Add required --agent parameter\r\n  parts.push('--agent', 'memory-agent');\r\n\r\n  return parts.join(' ');\r\n}\r\n\r\n// NEW: Handle mode management commands\r\nasync function handleModeCommand(command, subArgs, flags) {\r\n  switch (command) {\r\n    case 'detect':\r\n      await detectModes();\r\n      break;\r\n\r\n    case 'mode':\r\n      await showCurrentMode();\r\n      break;\r\n\r\n    case 'migrate':\r\n      await migrateMemory(subArgs, flags);\r\n      break;\r\n\r\n    default:\r\n      printError(`Unknown mode command: ${command}`);\r\n  }\r\n}\r\n\r\n// NEW: Detect and show available memory modes\r\nasync function detectModes() {\r\n  printInfo('üîç Detecting memory modes...\\n');\r\n\r\n  // Check basic mode\r\n  const basicAvailable = await checkBasicMode();\r\n  console.log(basicAvailable ? '‚úÖ Basic Mode (active)' : '‚ùå Basic Mode (unavailable)');\r\n  if (basicAvailable) {\r\n    console.log('   Location: ./memory/memory-store.json');\r\n    console.log('   Features: Simple key-value storage, fast');\r\n  }\r\n\r\n  console.log('');\r\n\r\n  // Check ReasoningBank mode\r\n  const rbAvailable = await isReasoningBankInitialized();\r\n  console.log(rbAvailable ? '‚úÖ ReasoningBank Mode (available)' : '‚ö†Ô∏è  ReasoningBank Mode (not initialized)');\r\n  if (rbAvailable) {\r\n    console.log('   Location: .swarm/memory.db');\r\n    console.log('   Features: AI-powered semantic search, learning');\r\n  } else {\r\n    console.log('   To enable: memory init --reasoningbank');\r\n  }\r\n\r\n  console.log('\\nüí° Usage:');\r\n  console.log('   Basic: memory store key \"value\"');\r\n  console.log('   ReasoningBank: memory store key \"value\" --reasoningbank');\r\n  console.log('   Auto-detect: memory query search --auto');\r\n}\r\n\r\n// NEW: Check if basic mode is available\r\nasync function checkBasicMode() {\r\n  try {\r\n    const memoryDir = './memory';\r\n    await fs.access(memoryDir);\r\n    return true;\r\n  } catch {\r\n    // Create directory if it doesn't exist\r\n    try {\r\n      await fs.mkdir(memoryDir, { recursive: true });\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\n// NEW: Show current default mode\r\nasync function showCurrentMode() {\r\n  const rbInitialized = await isReasoningBankInitialized();\r\n\r\n  printInfo('üìä Current Memory Configuration:\\n');\r\n  console.log('Default Mode: AUTO (smart selection with JSON fallback)');\r\n  console.log('Available Modes:');\r\n  console.log('  ‚Ä¢ Basic Mode: Always available (JSON storage)');\r\n  console.log(`  ‚Ä¢ ReasoningBank Mode: ${rbInitialized ? 'Initialized ‚úÖ (will be used by default)' : 'Not initialized ‚ö†Ô∏è (JSON fallback active)'}`);\r\n\r\n  console.log('\\nüí° Mode Behavior:');\r\n  console.log('   (no flag)                ‚Üí AUTO: Use ReasoningBank if initialized, else JSON');\r\n  console.log('   --reasoningbank or --rb  ‚Üí Force ReasoningBank mode');\r\n  console.log('   --basic                  ‚Üí Force JSON mode');\r\n  console.log('   --auto                   ‚Üí Same as default (explicit)');\r\n}\r\n\r\n// NEW: Migrate memory between modes\r\nasync function migrateMemory(subArgs, flags) {\r\n  const targetMode = flags?.to || getArgValue(subArgs, '--to');\r\n\r\n  if (!targetMode || !['basic', 'reasoningbank'].includes(targetMode)) {\r\n    printError('Usage: memory migrate --to <basic|reasoningbank>');\r\n    return;\r\n  }\r\n\r\n  printInfo(`üîÑ Migrating to ${targetMode} mode...\\n`);\r\n\r\n  if (targetMode === 'reasoningbank') {\r\n    // Migrate basic ‚Üí ReasoningBank\r\n    const rbInitialized = await isReasoningBankInitialized();\r\n    if (!rbInitialized) {\r\n      printError('‚ùå ReasoningBank not initialized');\r\n      console.log('First run: memory init --reasoningbank\\n');\r\n      return;\r\n    }\r\n\r\n    printWarning('‚ö†Ô∏è  Migration from basic to ReasoningBank is not yet implemented');\r\n    console.log('This feature is coming in v2.7.1\\n');\r\n    console.log('For now, you can:');\r\n    console.log('  1. Export basic memory: memory export backup.json');\r\n    console.log('  2. Manually import to ReasoningBank');\r\n  } else {\r\n    // Migrate ReasoningBank ‚Üí basic\r\n    printWarning('‚ö†Ô∏è  Migration from ReasoningBank to basic is not yet implemented');\r\n    console.log('This feature is coming in v2.7.1\\n');\r\n  }\r\n}\r\n\r\n// Helper to get argument value\r\nfunction getArgValue(args, flag) {\r\n  const index = args.indexOf(flag);\r\n  if (index !== -1 && index + 1 < args.length) {\r\n    return args[index + 1];\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction showMemoryHelp() {\r\n  console.log('Memory commands:');\r\n  console.log('  store <key> <value>    Store a key-value pair');\r\n  console.log('  query <search>         Search for entries');\r\n  console.log('  stats                  Show memory statistics');\r\n  console.log('  export [filename]      Export memory to file');\r\n  console.log('  import <filename>      Import memory from file');\r\n  console.log('  clear --namespace <ns> Clear a namespace');\r\n  console.log('  list                   List all namespaces');\r\n  console.log();\r\n  console.log('üß† ReasoningBank Commands (NEW in v2.7.0):');\r\n  console.log('  init --reasoningbank   Initialize ReasoningBank (AI-powered memory)');\r\n  console.log('  status --reasoningbank Show ReasoningBank statistics');\r\n  console.log('  detect                 Show available memory modes');\r\n  console.log('  mode                   Show current memory configuration');\r\n  console.log('  migrate --to <mode>    Migrate between basic/reasoningbank');\r\n  console.log();\r\n  console.log('Options:');\r\n  console.log('  --namespace <ns>       Specify namespace for operations');\r\n  console.log('  --ns <ns>              Short form of --namespace');\r\n  console.log('  --limit <n>            Limit number of results (default: 10)');\r\n  console.log('  --sort <field>         Sort results by: recent, oldest, key, value');\r\n  console.log('  --format <type>        Export format: json, yaml');\r\n  console.log('  --redact               üîí Enable API key redaction (security feature)');\r\n  console.log('  --secure               Alias for --redact');\r\n  console.log();\r\n  console.log('üéØ Mode Selection:');\r\n  console.log('  (no flag)              AUTO MODE (default) - Uses ReasoningBank if initialized, else JSON fallback');\r\n  console.log('  --reasoningbank, --rb  Force ReasoningBank mode (AI-powered)');\r\n  console.log('  --basic                Force Basic mode (JSON storage)');\r\n  console.log('  --auto                 Explicit auto-detect (same as default)');\r\n  console.log();\r\n  console.log('üîí Security Features (v2.6.0):');\r\n  console.log('  API Key Protection:    Automatically detects and redacts sensitive data');\r\n  console.log('  Patterns Detected:     Anthropic, OpenRouter, Gemini, Bearer tokens, etc.');\r\n  console.log('  Auto-Validation:       Warns when storing unredacted sensitive data');\r\n  console.log('  Display Redaction:     Redact sensitive data when querying with --redact');\r\n  console.log();\r\n  console.log('Examples:');\r\n  console.log('  # Basic mode (default - backward compatible)');\r\n  console.log('  memory store previous_work \"Research findings from yesterday\"');\r\n  console.log('  memory store api_config \"key=sk-ant-...\" --redact  # üîí Redacts API key');\r\n  console.log('  memory query research --namespace sparc');\r\n  console.log();\r\n  console.log('  # ReasoningBank mode (AI-powered, opt-in)');\r\n  console.log('  memory init --reasoningbank  # One-time setup');\r\n  console.log('  memory store api_pattern \"Always use env vars\" --reasoningbank');\r\n  console.log('  memory query \"API configuration\" --reasoningbank --limit 5  # Semantic search!');\r\n  console.log('  memory list --reasoningbank --sort recent --limit 20');\r\n  console.log('  memory export backup.json --format json --reasoningbank');\r\n  console.log('  memory status --reasoningbank  # Show AI metrics');\r\n  console.log();\r\n  console.log('  # Auto-detect mode (smart selection)');\r\n  console.log('  memory query config --auto  # Uses ReasoningBank if available');\r\n  console.log();\r\n  console.log('  # Mode management');\r\n  console.log('  memory detect  # Show available modes');\r\n  console.log('  memory mode    # Show current configuration');\r\n  console.log();\r\n  console.log('üí° Tips:');\r\n  console.log('  ‚Ä¢ AUTO MODE (default): Automatically uses best available storage');\r\n  console.log('  ‚Ä¢ ReasoningBank: AI-powered semantic search (learns from patterns)');\r\n  console.log('  ‚Ä¢ JSON fallback: Always available, fast, simple key-value storage');\r\n  console.log('  ‚Ä¢ Initialize ReasoningBank once: \"memory init --reasoningbank\"');\r\n  console.log('  ‚Ä¢ Always use --redact when storing API keys or secrets!');\r\n  console.log();\r\n  console.log('üöÄ Semantic Search (NEW in v2.7.25):');\r\n  console.log('  NPX Mode:              Uses hash-based embeddings (text similarity)');\r\n  console.log('                         ‚Ä¢ Fast, offline, zero dependencies');\r\n  console.log('                         ‚Ä¢ Good for exact/partial text matching');\r\n  console.log('  Local Install:         Uses transformer embeddings (semantic AI)');\r\n  console.log('                         ‚Ä¢ Finds conceptually related content');\r\n  console.log('                         ‚Ä¢ 384-dimensional vectors (Xenova/all-MiniLM-L6-v2)');\r\n  console.log('                         ‚Ä¢ Install: npm install -g claude-flow@alpha');\r\n  console.log('  Both modes work perfectly - choose based on your needs!');\r\n}\r\n"],"names":["printSuccess","printError","printWarning","printInfo","promises","fs","KeyRedactor","exec","promisify","execAsync","memoryCommand","subArgs","flags","memorySubcommand","memoryStore","namespace","ns","getNamespaceFromArgs","enableRedaction","redact","includes","mode","detectMemoryMode","loadMemory","content","readFile","JSON","parse","saveMemory","data","mkdir","recursive","writeFile","stringify","handleReasoningBankCommand","handleModeCommand","storeMemory","queryMemory","showMemoryStats","exportMemory","importMemory","clearMemory","listNamespaces","showMemoryHelp","key","value","slice","join","redactedValue","securityWarnings","validation","validate","safe","warnings","forEach","warning","console","log","filter","e","push","timestamp","Date","now","redacted","length","TextEncoder","encode","err","message","search","results","entries","Object","entry","sort","a","b","displayValue","substring","toLocaleString","rbInitialized","isReasoningBankInitialized","totalEntries","namespaceStats","keys","toFixed","count","getStatus","rbStats","total_memories","total_categories","avg_confidence","total_embeddings","total_trajectories","dbPath","database_path","stats","stat","size","sizeErr","rbErr","filename","exportData","values","importContent","importData","existingData","totalImported","existingKeys","Set","map","newEntries","has","nsFromArgs","entryCount","namespaces","namespaceIndex","indexOf","nsIndex","reasoningbank","rb","auto","initialized","basic","initializeReasoningBank","isNpx","process","env","npm_config_user_agent","cwd","error","isSqliteError","access","command","queryMemories","listMemories","checkReasoningBankTables","migrateReasoningBank","cleanup","CLAUDE_FLOW_DB_PATH","tableCheck","exists","missingTables","migrationResult","success","addedTables","setTimeout","exit","handleReasoningBankStore","handleReasoningBankQuery","handleReasoningBankList","handleReasoningBankStatus","cmd","stdout","timeout","getArgValue","memoryId","agent","domain","limit","confidence","usage_count","score","created_at","parseInt","total_usage","buildReasoningBankCommand","parts","commandMap","store","query","list","status","consolidate","demo","test","benchmark","args","arg","startsWith","detectModes","showCurrentMode","migrateMemory","basicAvailable","checkBasicMode","rbAvailable","memoryDir","targetMode","to","flag","index"],"mappings":"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XD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG;IACXD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;AACd"}
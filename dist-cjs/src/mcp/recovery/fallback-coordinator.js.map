{"version":3,"sources":["../../../../src/mcp/recovery/fallback-coordinator.ts"],"sourcesContent":["/**\r\n * Fallback Coordinator for MCP\r\n * Manages graceful degradation to CLI when MCP connection fails\r\n */\r\n\r\nimport { EventEmitter } from 'node:events';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport type { MCPRequest } from '../../utils/types.js';\r\nimport { exec } from 'node:child_process';\r\nimport { promisify } from 'node:util';\r\n\r\nconst execAsync = promisify(exec);\r\n\r\nexport interface FallbackOperation {\r\n  id: string;\r\n  type: 'tool' | 'resource' | 'notification';\r\n  method: string;\r\n  params: unknown;\r\n  timestamp: Date;\r\n  priority: 'high' | 'medium' | 'low';\r\n  retryable: boolean;\r\n}\r\n\r\nexport interface FallbackConfig {\r\n  enableFallback: boolean;\r\n  maxQueueSize: number;\r\n  queueTimeout: number;\r\n  cliPath: string;\r\n  fallbackNotificationInterval: number;\r\n}\r\n\r\nexport interface FallbackState {\r\n  isFallbackActive: boolean;\r\n  queuedOperations: number;\r\n  failedOperations: number;\r\n  successfulOperations: number;\r\n  lastFallbackActivation?: Date;\r\n}\r\n\r\nexport class FallbackCoordinator extends EventEmitter {\r\n  private operationQueue: FallbackOperation[] = [];\r\n  private state: FallbackState;\r\n  private notificationTimer?: NodeJS.Timeout;\r\n  private processingQueue = false;\r\n\r\n  private readonly defaultConfig: FallbackConfig = {\r\n    enableFallback: true,\r\n    maxQueueSize: 100,\r\n    queueTimeout: 300000, // 5 minutes\r\n    cliPath: 'npx ruv-swarm',\r\n    fallbackNotificationInterval: 30000, // 30 seconds\r\n  };\r\n\r\n  constructor(\r\n    private logger: ILogger,\r\n    config?: Partial<FallbackConfig>,\r\n  ) {\r\n    super();\r\n    this.config = { ...this.defaultConfig, ...config };\r\n\r\n    this.state = {\r\n      isFallbackActive: false,\r\n      queuedOperations: 0,\r\n      failedOperations: 0,\r\n      successfulOperations: 0,\r\n    };\r\n  }\r\n\r\n  private config: FallbackConfig;\r\n\r\n  /**\r\n   * Check if MCP is available\r\n   */\r\n  async isMCPAvailable(): Promise<boolean> {\r\n    try {\r\n      // Try to execute a simple MCP command\r\n      const { stdout } = await execAsync(`${this.config.cliPath} status --json`);\r\n      const status = JSON.parse(stdout);\r\n      return status.connected === true;\r\n    } catch (error) {\r\n      this.logger.debug('MCP availability check failed', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enable CLI fallback mode\r\n   */\r\n  enableCLIFallback(): void {\r\n    if (this.state.isFallbackActive) {\r\n      this.logger.debug('Fallback already active');\r\n      return;\r\n    }\r\n\r\n    this.logger.warn('Enabling CLI fallback mode');\r\n\r\n    this.state.isFallbackActive = true;\r\n    this.state.lastFallbackActivation = new Date();\r\n\r\n    // Start notification timer\r\n    this.startNotificationTimer();\r\n\r\n    this.emit('fallbackEnabled', this.state);\r\n  }\r\n\r\n  /**\r\n   * Disable CLI fallback mode\r\n   */\r\n  disableCLIFallback(): void {\r\n    if (!this.state.isFallbackActive) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Disabling CLI fallback mode');\r\n\r\n    this.state.isFallbackActive = false;\r\n\r\n    // Stop notification timer\r\n    this.stopNotificationTimer();\r\n\r\n    this.emit('fallbackDisabled', this.state);\r\n\r\n    // Process any queued operations\r\n    if (this.operationQueue.length > 0) {\r\n      this.processQueue().catch((error) => {\r\n        this.logger.error('Error processing queue after fallback disabled', error);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Queue an operation for later execution\r\n   */\r\n  queueOperation(operation: Omit<FallbackOperation, 'id' | 'timestamp'>): void {\r\n    if (!this.config.enableFallback) {\r\n      this.logger.debug('Fallback disabled, operation not queued');\r\n      return;\r\n    }\r\n\r\n    if (this.operationQueue.length >= this.config.maxQueueSize) {\r\n      this.logger.warn('Operation queue full, removing oldest operation');\r\n      this.operationQueue.shift();\r\n      this.state.failedOperations++;\r\n    }\r\n\r\n    const queuedOp: FallbackOperation = {\r\n      ...operation,\r\n      id: this.generateOperationId(),\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    this.operationQueue.push(queuedOp);\r\n    this.state.queuedOperations = this.operationQueue.length;\r\n\r\n    this.logger.debug('Operation queued', {\r\n      id: queuedOp.id,\r\n      type: queuedOp.type,\r\n      method: queuedOp.method,\r\n      queueSize: this.operationQueue.length,\r\n    });\r\n\r\n    this.emit('operationQueued', queuedOp);\r\n\r\n    // If in fallback mode, try to execute via CLI\r\n    if (this.state.isFallbackActive && !this.processingQueue) {\r\n      this.executeViaCliFallback(queuedOp).catch((error) => {\r\n        this.logger.error('CLI fallback execution failed', { operation: queuedOp, error });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process all queued operations\r\n   */\r\n  async processQueue(): Promise<void> {\r\n    if (this.processingQueue || this.operationQueue.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.processingQueue = true;\r\n    this.logger.info('Processing operation queue', {\r\n      queueSize: this.operationQueue.length,\r\n    });\r\n\r\n    this.emit('queueProcessingStart', this.operationQueue.length);\r\n\r\n    const results = {\r\n      successful: 0,\r\n      failed: 0,\r\n    };\r\n\r\n    // Process operations in order\r\n    while (this.operationQueue.length > 0) {\r\n      const operation = this.operationQueue.shift()!;\r\n\r\n      // Check if operation has expired\r\n      if (this.isOperationExpired(operation)) {\r\n        this.logger.warn('Operation expired', { id: operation.id });\r\n        results.failed++;\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        await this.replayOperation(operation);\r\n        results.successful++;\r\n        this.state.successfulOperations++;\r\n      } catch (error) {\r\n        this.logger.error('Failed to replay operation', {\r\n          operation,\r\n          error,\r\n        });\r\n        results.failed++;\r\n        this.state.failedOperations++;\r\n\r\n        // Re-queue if retryable\r\n        if (operation.retryable) {\r\n          this.operationQueue.push(operation);\r\n        }\r\n      }\r\n    }\r\n\r\n    this.state.queuedOperations = this.operationQueue.length;\r\n    this.processingQueue = false;\r\n\r\n    this.logger.info('Queue processing complete', results);\r\n    this.emit('queueProcessingComplete', results);\r\n  }\r\n\r\n  /**\r\n   * Get current fallback state\r\n   */\r\n  getState(): FallbackState {\r\n    return { ...this.state };\r\n  }\r\n\r\n  /**\r\n   * Get queued operations\r\n   */\r\n  getQueuedOperations(): FallbackOperation[] {\r\n    return [...this.operationQueue];\r\n  }\r\n\r\n  /**\r\n   * Clear operation queue\r\n   */\r\n  clearQueue(): void {\r\n    const clearedCount = this.operationQueue.length;\r\n    this.operationQueue = [];\r\n    this.state.queuedOperations = 0;\r\n\r\n    this.logger.info('Operation queue cleared', { clearedCount });\r\n    this.emit('queueCleared', clearedCount);\r\n  }\r\n\r\n  private async executeViaCliFallback(operation: FallbackOperation): Promise<void> {\r\n    this.logger.debug('Executing operation via CLI fallback', {\r\n      id: operation.id,\r\n      method: operation.method,\r\n    });\r\n\r\n    try {\r\n      // Map MCP operations to CLI commands\r\n      const cliCommand = this.mapOperationToCli(operation);\r\n\r\n      if (!cliCommand) {\r\n        throw new Error(`No CLI mapping for operation: ${operation.method}`);\r\n      }\r\n\r\n      const { stdout, stderr } = await execAsync(cliCommand);\r\n\r\n      if (stderr) {\r\n        this.logger.warn('CLI command stderr', { stderr });\r\n      }\r\n\r\n      this.logger.debug('CLI fallback execution successful', {\r\n        id: operation.id,\r\n        stdout: stdout.substring(0, 200), // Log first 200 chars\r\n      });\r\n\r\n      this.state.successfulOperations++;\r\n      this.emit('fallbackExecutionSuccess', { operation, result: stdout });\r\n    } catch (error) {\r\n      this.logger.error('CLI fallback execution failed', {\r\n        operation,\r\n        error,\r\n      });\r\n\r\n      this.state.failedOperations++;\r\n      this.emit('fallbackExecutionFailed', { operation, error });\r\n\r\n      // Re-queue if retryable\r\n      if (operation.retryable) {\r\n        this.queueOperation(operation);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async replayOperation(operation: FallbackOperation): Promise<void> {\r\n    // This would typically use the MCP client to replay the operation\r\n    // For now, we'll log it\r\n    this.logger.info('Replaying operation', {\r\n      id: operation.id,\r\n      method: operation.method,\r\n    });\r\n\r\n    // Emit event for handling by the MCP client\r\n    this.emit('replayOperation', operation);\r\n  }\r\n\r\n  private mapOperationToCli(operation: FallbackOperation): string | null {\r\n    // Map common MCP operations to CLI commands\r\n    const mappings: Record<string, (params: any) => string> = {\r\n      // Tool operations\r\n      'tools/list': () => `${this.config.cliPath} tools list`,\r\n      'tools/call': (params) =>\r\n        `${this.config.cliPath} tools call ${params.name} '${JSON.stringify(params.arguments)}'`,\r\n\r\n      // Resource operations\r\n      'resources/list': () => `${this.config.cliPath} resources list`,\r\n      'resources/read': (params) => `${this.config.cliPath} resources read ${params.uri}`,\r\n\r\n      // Session operations\r\n      initialize: () => `${this.config.cliPath} session init`,\r\n      shutdown: () => `${this.config.cliPath} session shutdown`,\r\n\r\n      // Custom operations\r\n      heartbeat: () => `${this.config.cliPath} health check`,\r\n    };\r\n\r\n    const mapper = mappings[operation.method];\r\n    return mapper ? mapper(operation.params) : null;\r\n  }\r\n\r\n  private isOperationExpired(operation: FallbackOperation): boolean {\r\n    const age = Date.now() - operation.timestamp.getTime();\r\n    return age > this.config.queueTimeout;\r\n  }\r\n\r\n  private generateOperationId(): string {\r\n    return `op-${Date.now()}-${Math.random().toString(36).slice(2)}`;\r\n  }\r\n\r\n  private startNotificationTimer(): void {\r\n    if (this.notificationTimer) {\r\n      return;\r\n    }\r\n\r\n    this.notificationTimer = setInterval(() => {\r\n      if (this.state.isFallbackActive && this.operationQueue.length > 0) {\r\n        this.logger.info('Fallback mode active', {\r\n          queuedOperations: this.operationQueue.length,\r\n          duration: Date.now() - (this.state.lastFallbackActivation?.getTime() || 0),\r\n        });\r\n\r\n        this.emit('fallbackStatus', this.state);\r\n      }\r\n    }, this.config.fallbackNotificationInterval);\r\n  }\r\n\r\n  private stopNotificationTimer(): void {\r\n    if (this.notificationTimer) {\r\n      clearInterval(this.notificationTimer);\r\n      this.notificationTimer = undefined;\r\n    }\r\n  }\r\n}\r\n"],"names":["EventEmitter","exec","promisify","execAsync","FallbackCoordinator","operationQueue","state","notificationTimer","processingQueue","defaultConfig","enableFallback","maxQueueSize","queueTimeout","cliPath","fallbackNotificationInterval","logger","config","isFallbackActive","queuedOperations","failedOperations","successfulOperations","isMCPAvailable","stdout","status","JSON","parse","connected","error","debug","enableCLIFallback","warn","lastFallbackActivation","Date","startNotificationTimer","emit","disableCLIFallback","info","stopNotificationTimer","length","processQueue","catch","queueOperation","operation","shift","queuedOp","id","generateOperationId","timestamp","push","type","method","queueSize","executeViaCliFallback","results","successful","failed","isOperationExpired","replayOperation","retryable","getState","getQueuedOperations","clearQueue","clearedCount","cliCommand","mapOperationToCli","Error","stderr","substring","result","mappings","params","name","stringify","arguments","uri","initialize","shutdown","heartbeat","mapper","age","now","getTime","Math","random","toString","slice","setInterval","duration","clearInterval","undefined"],"mappings":"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"}
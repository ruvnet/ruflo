{"version":3,"sources":["../../../src/utils/error-recovery.ts"],"sourcesContent":["/**\r\n * Error Recovery Utilities\r\n * Automatic error detection and recovery for common installation issues\r\n */\r\n\r\nimport { execSync } from 'child_process';\r\nimport * as fs from 'fs-extra';\r\nimport * as path from 'path';\r\nimport * as os from 'os';\r\n\r\nexport interface RecoveryResult {\r\n  success: boolean;\r\n  action: string;\r\n  message: string;\r\n  recovered: boolean;\r\n}\r\n\r\nexport interface RetryOptions {\r\n  maxRetries?: number;\r\n  delay?: number;\r\n  onRetry?: (attempt: number, error: Error) => void;\r\n  cleanupFn?: () => Promise<void>;\r\n}\r\n\r\n/**\r\n * Detect if an error is the ENOTEMPTY npm cache error\r\n */\r\nexport function isNpmCacheError(error: any): boolean {\r\n  const errorStr = error?.message || String(error);\r\n  return (\r\n    errorStr.includes('ENOTEMPTY') &&\r\n    (errorStr.includes('npm') || errorStr.includes('npx') || errorStr.includes('_npx'))\r\n  ) || errorStr.includes('better-sqlite3');\r\n}\r\n\r\n/**\r\n * Detect if running on WSL (Windows Subsystem for Linux)\r\n */\r\nexport function isWSL(): boolean {\r\n  if (process.platform !== 'linux') {\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const release = fs.readFileSync('/proc/version', 'utf8').toLowerCase();\r\n    return release.includes('microsoft') || release.includes('wsl');\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Clean npm and npx cache directories\r\n */\r\nexport async function cleanNpmCache(): Promise<RecoveryResult> {\r\n  const homeDir = os.homedir();\r\n  const npxCacheDir = path.join(homeDir, '.npm', '_npx');\r\n\r\n  try {\r\n    console.log('üßπ Cleaning npm cache...');\r\n\r\n    // Clean npm cache\r\n    try {\r\n      execSync('npm cache clean --force', { stdio: 'pipe' });\r\n      console.log('‚úÖ npm cache cleaned');\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è  npm cache clean failed, continuing...');\r\n    }\r\n\r\n    // Remove npx cache directory\r\n    if (await fs.pathExists(npxCacheDir)) {\r\n      console.log(`üóëÔ∏è  Removing npx cache: ${npxCacheDir}`);\r\n      await fs.remove(npxCacheDir);\r\n      console.log('‚úÖ npx cache removed');\r\n    }\r\n\r\n    // Fix permissions on WSL\r\n    if (isWSL()) {\r\n      const npmDir = path.join(homeDir, '.npm');\r\n      if (await fs.pathExists(npmDir)) {\r\n        try {\r\n          execSync(`chmod -R 755 \"${npmDir}\"`, { stdio: 'pipe' });\r\n          console.log('‚úÖ npm directory permissions fixed');\r\n        } catch (error) {\r\n          console.warn('‚ö†Ô∏è  Permission fix failed, continuing...');\r\n        }\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      action: 'cache-cleanup',\r\n      message: 'npm/npx cache cleaned successfully',\r\n      recovered: true\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      action: 'cache-cleanup',\r\n      message: `Failed to clean cache: ${error instanceof Error ? error.message : String(error)}`,\r\n      recovered: false\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Automatic retry with exponential backoff and error recovery\r\n */\r\nexport async function retryWithRecovery<T>(\r\n  fn: () => Promise<T>,\r\n  options: RetryOptions = {}\r\n): Promise<T> {\r\n  const {\r\n    maxRetries = 3,\r\n    delay = 1000,\r\n    onRetry,\r\n    cleanupFn\r\n  } = options;\r\n\r\n  let lastError: Error | undefined;\r\n\r\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n    try {\r\n      return await fn();\r\n    } catch (error) {\r\n      lastError = error as Error;\r\n\r\n      // Check if it's a recoverable error\r\n      if (isNpmCacheError(error)) {\r\n        console.log(`\\n‚ö†Ô∏è  Detected npm cache error (attempt ${attempt}/${maxRetries})`);\r\n\r\n        // Attempt automatic recovery\r\n        const recovery = await cleanNpmCache();\r\n        if (recovery.success) {\r\n          console.log('‚úÖ Cache cleaned, retrying...\\n');\r\n\r\n          // Run custom cleanup if provided\r\n          if (cleanupFn) {\r\n            await cleanupFn();\r\n          }\r\n\r\n          // Exponential backoff\r\n          const backoffDelay = delay * Math.pow(2, attempt - 1);\r\n          await new Promise(resolve => setTimeout(resolve, backoffDelay));\r\n\r\n          continue; // Retry\r\n        } else {\r\n          console.error('‚ùå Cache cleanup failed:', recovery.message);\r\n        }\r\n      }\r\n\r\n      // Call retry callback\r\n      if (onRetry && attempt < maxRetries) {\r\n        onRetry(attempt, lastError);\r\n        await new Promise(resolve => setTimeout(resolve, delay));\r\n        continue;\r\n      }\r\n\r\n      // Last attempt failed\r\n      if (attempt === maxRetries) {\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // All retries exhausted\r\n  throw new Error(\r\n    `Operation failed after ${maxRetries} attempts. ` +\r\n    `Last error: ${lastError?.message || 'Unknown error'}`\r\n  );\r\n}\r\n\r\n/**\r\n * WSL-specific error recovery\r\n */\r\nexport async function recoverWSLErrors(): Promise<RecoveryResult> {\r\n  if (!isWSL()) {\r\n    return {\r\n      success: true,\r\n      action: 'wsl-check',\r\n      message: 'Not running on WSL, no recovery needed',\r\n      recovered: false\r\n    };\r\n  }\r\n\r\n  console.log('üîç Detected WSL environment, applying fixes...');\r\n\r\n  try {\r\n    const homeDir = os.homedir();\r\n\r\n    // Check if running from Windows mount\r\n    const cwd = process.cwd();\r\n    if (cwd.startsWith('/mnt/')) {\r\n      console.warn('‚ö†Ô∏è  WARNING: Running from Windows filesystem (/mnt/)');\r\n      console.warn('   For best results, run from WSL filesystem (e.g., ~/projects/)');\r\n    }\r\n\r\n    // Ensure build tools are available\r\n    try {\r\n      execSync('which gcc', { stdio: 'pipe' });\r\n    } catch {\r\n      console.warn('‚ö†Ô∏è  build-essential not found. Install with:');\r\n      console.warn('   sudo apt-get update && sudo apt-get install -y build-essential python3');\r\n    }\r\n\r\n    // Clean cache with WSL-specific handling\r\n    return await cleanNpmCache();\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      action: 'wsl-recovery',\r\n      message: `WSL recovery failed: ${error instanceof Error ? error.message : String(error)}`,\r\n      recovered: false\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Verify better-sqlite3 installation\r\n */\r\nexport async function verifyBetterSqlite3(): Promise<boolean> {\r\n  try {\r\n    require.resolve('better-sqlite3');\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Install better-sqlite3 with retry and error recovery\r\n */\r\nexport async function installBetterSqlite3WithRecovery(): Promise<RecoveryResult> {\r\n  console.log('üì¶ Installing better-sqlite3...');\r\n\r\n  return retryWithRecovery(\r\n    async () => {\r\n      execSync('npm install better-sqlite3 --no-save', {\r\n        stdio: 'inherit',\r\n        cwd: process.cwd()\r\n      });\r\n\r\n      // Verify installation\r\n      if (await verifyBetterSqlite3()) {\r\n        return {\r\n          success: true,\r\n          action: 'install-sqlite',\r\n          message: 'better-sqlite3 installed successfully',\r\n          recovered: true\r\n        };\r\n      } else {\r\n        throw new Error('Installation completed but module not found');\r\n      }\r\n    },\r\n    {\r\n      maxRetries: 3,\r\n      delay: 2000,\r\n      onRetry: (attempt, error) => {\r\n        console.log(`‚ö†Ô∏è  Install attempt ${attempt} failed: ${error.message}`);\r\n        console.log('üîÑ Cleaning cache and retrying...');\r\n      }\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * Comprehensive error recovery for initialization\r\n */\r\nexport async function recoverInitErrors(error: any): Promise<RecoveryResult> {\r\n  console.log('\\nüö® Error detected during initialization');\r\n  console.log(`   Error: ${error?.message || String(error)}\\n`);\r\n\r\n  // WSL-specific recovery\r\n  if (isWSL()) {\r\n    console.log('üîß Applying WSL-specific fixes...');\r\n    const wslRecovery = await recoverWSLErrors();\r\n    if (!wslRecovery.success) {\r\n      return wslRecovery;\r\n    }\r\n  }\r\n\r\n  // npm cache error recovery\r\n  if (isNpmCacheError(error)) {\r\n    console.log('üîß Detected npm cache error, attempting recovery...');\r\n    const cacheRecovery = await cleanNpmCache();\r\n    if (!cacheRecovery.success) {\r\n      return cacheRecovery;\r\n    }\r\n\r\n    // Try to reinstall better-sqlite3\r\n    if (!await verifyBetterSqlite3()) {\r\n      console.log('üîß better-sqlite3 missing, attempting reinstall...');\r\n      return await installBetterSqlite3WithRecovery();\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      action: 'error-recovery',\r\n      message: 'Cache cleaned and dependencies verified',\r\n      recovered: true\r\n    };\r\n  }\r\n\r\n  // Generic error handling\r\n  return {\r\n    success: false,\r\n    action: 'error-recovery',\r\n    message: `Unable to automatically recover from error: ${error?.message || String(error)}`,\r\n    recovered: false\r\n  };\r\n}\r\n\r\n/**\r\n * Export utility functions\r\n */\r\nexport const errorRecovery = {\r\n  isNpmCacheError,\r\n  isWSL,\r\n  cleanNpmCache,\r\n  retryWithRecovery,\r\n  recoverWSLErrors,\r\n  verifyBetterSqlite3,\r\n  installBetterSqlite3WithRecovery,\r\n  recoverInitErrors\r\n};\r\n"],"names":["execSync","fs","path","os","isNpmCacheError","error","errorStr","message","String","includes","isWSL","process","platform","release","readFileSync","toLowerCase","cleanNpmCache","homeDir","homedir","npxCacheDir","join","console","log","stdio","warn","pathExists","remove","npmDir","success","action","recovered","Error","retryWithRecovery","fn","options","maxRetries","delay","onRetry","cleanupFn","lastError","attempt","recovery","backoffDelay","Math","pow","Promise","resolve","setTimeout","recoverWSLErrors","cwd","startsWith","verifyBetterSqlite3","require","installBetterSqlite3WithRecovery","recoverInitErrors","wslRecovery","cacheRecovery","errorRecovery"],"mappings":"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"}
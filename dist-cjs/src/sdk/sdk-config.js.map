{"version":3,"sources":["../../../src/sdk/sdk-config.ts"],"sourcesContent":["/**\r\n * Claude Agent SDK Configuration Adapter\r\n * Claude-Flow v2.5-alpha.130\r\n *\r\n * This module provides the configuration adapter for integrating\r\n * the Anthropic SDK as the foundation layer for Claude-Flow.\r\n */\r\n\r\nimport Anthropic from '@anthropic-ai/sdk';\r\n\r\nexport interface SDKConfiguration {\r\n  apiKey?: string;\r\n  baseURL?: string;\r\n  maxRetries?: number;\r\n  timeout?: number;\r\n  defaultHeaders?: Record<string, string>;\r\n\r\n  // Claude-Flow specific extensions\r\n  swarmMode?: boolean;\r\n  persistenceEnabled?: boolean;\r\n  checkpointInterval?: number;\r\n  memoryNamespace?: string;\r\n}\r\n\r\n/**\r\n * Claude-Flow SDK Adapter\r\n * Wraps the Anthropic SDK with Claude-Flow extensions\r\n */\r\nexport class ClaudeFlowSDKAdapter {\r\n  private sdk: Anthropic;\r\n  private config: SDKConfiguration;\r\n  private swarmMetadata: Map<string, Record<string, unknown>> = new Map();\r\n\r\n  constructor(config: SDKConfiguration = {}) {\r\n    this.config = {\r\n      apiKey: config.apiKey || process.env.ANTHROPIC_API_KEY || process.env.CLAUDE_API_KEY,\r\n      baseURL: config.baseURL,\r\n      maxRetries: config.maxRetries || 3,\r\n      timeout: config.timeout || 60000,\r\n      defaultHeaders: config.defaultHeaders || {},\r\n      swarmMode: config.swarmMode !== false,\r\n      persistenceEnabled: config.persistenceEnabled !== false,\r\n      checkpointInterval: config.checkpointInterval || 60000,\r\n      memoryNamespace: config.memoryNamespace || 'claude-flow'\r\n    };\r\n\r\n    // Initialize Anthropic SDK with configuration\r\n    this.sdk = new Anthropic({\r\n      apiKey: this.config.apiKey,\r\n      baseURL: this.config.baseURL,\r\n      maxRetries: this.config.maxRetries,\r\n      timeout: this.config.timeout,\r\n      defaultHeaders: this.config.defaultHeaders\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the underlying Anthropic SDK instance\r\n   */\r\n  getSDK(): Anthropic {\r\n    return this.sdk;\r\n  }\r\n\r\n  /**\r\n   * Get the current configuration\r\n   */\r\n  getConfig(): SDKConfiguration {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Create a message with automatic retry handling\r\n   */\r\n  async createMessage(params: Anthropic.MessageCreateParams): Promise<Anthropic.Message> {\r\n    try {\r\n      // SDK handles retry automatically based on configuration\r\n      const message = await this.sdk.messages.create(params);\r\n\r\n      // Store in swarm metadata if in swarm mode\r\n      if (this.config.swarmMode && message.id) {\r\n        this.swarmMetadata.set(message.id, {\r\n          timestamp: Date.now(),\r\n          model: params.model,\r\n          tokensUsed: message.usage\r\n        });\r\n      }\r\n\r\n      return message;\r\n    } catch (error) {\r\n      // Enhanced error handling for swarm mode\r\n      if (this.config.swarmMode) {\r\n        console.error('[SDK] Message creation failed in swarm mode:', error);\r\n        this.logSwarmError(error);\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a streaming message\r\n   */\r\n  async createStreamingMessage(\r\n    params: Anthropic.MessageCreateParams,\r\n    options?: { onChunk?: (chunk: any) => void }\r\n  ): Promise<Anthropic.Message> {\r\n    const stream = await this.sdk.messages.create({\r\n      ...params,\r\n      stream: true\r\n    });\r\n\r\n    let fullMessage: Partial<Anthropic.Message> = {};\r\n\r\n    for await (const chunk of stream) {\r\n      if (options?.onChunk) {\r\n        options.onChunk(chunk);\r\n      }\r\n\r\n      // Accumulate the message\r\n      if (chunk.type === 'message_start') {\r\n        fullMessage = chunk.message;\r\n      } else if (chunk.type === 'content_block_delta') {\r\n        // Handle content updates\r\n      } else if (chunk.type === 'message_delta') {\r\n        // Handle message updates\r\n        if (chunk.delta?.stop_reason) {\r\n          fullMessage.stop_reason = chunk.delta.stop_reason;\r\n        }\r\n      }\r\n    }\r\n\r\n    return fullMessage as Anthropic.Message;\r\n  }\r\n\r\n  /**\r\n   * Check if the SDK is properly configured\r\n   */\r\n  async validateConfiguration(): Promise<boolean> {\r\n    try {\r\n      // Test the configuration with a minimal request\r\n      await this.sdk.messages.create({\r\n        model: 'claude-3-haiku-20240307',\r\n        max_tokens: 1,\r\n        messages: [{ role: 'user', content: 'test' }]\r\n      });\r\n      return true;\r\n    } catch (error) {\r\n      if (error instanceof Anthropic.AuthenticationError) {\r\n        console.error('[SDK] Invalid API key');\r\n        return false;\r\n      }\r\n      if (error instanceof Anthropic.RateLimitError) {\r\n        console.warn('[SDK] Rate limit reached but configuration is valid');\r\n        return true;\r\n      }\r\n      console.error('[SDK] Configuration validation failed:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get swarm metadata for a message\r\n   */\r\n  getSwarmMetadata(messageId: string): Record<string, unknown> | undefined {\r\n    return this.swarmMetadata.get(messageId);\r\n  }\r\n\r\n  /**\r\n   * Clear swarm metadata\r\n   */\r\n  clearSwarmMetadata(): void {\r\n    this.swarmMetadata.clear();\r\n  }\r\n\r\n  /**\r\n   * Log error to swarm coordination system\r\n   */\r\n  private logSwarmError(error: unknown): void {\r\n    const errorMessage = error instanceof Error ? error.message : String(error);\r\n    const errorStack = error instanceof Error ? error.stack : undefined;\r\n    this.swarmMetadata.set(`error-${Date.now()}`, {\r\n      timestamp: Date.now(),\r\n      error: errorMessage,\r\n      stack: errorStack\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get usage statistics\r\n   */\r\n  getUsageStats(): { totalTokens: number; messageCount: number } {\r\n    let totalTokens = 0;\r\n    let messageCount = 0;\r\n\r\n    this.swarmMetadata.forEach((metadata) => {\r\n      if (metadata.tokensUsed) {\r\n        totalTokens += metadata.tokensUsed.total_tokens || 0;\r\n        messageCount++;\r\n      }\r\n    });\r\n\r\n    return { totalTokens, messageCount };\r\n  }\r\n}\r\n\r\n// Export a singleton instance for convenience\r\nexport const defaultSDKAdapter = new ClaudeFlowSDKAdapter();"],"names":["Anthropic","ClaudeFlowSDKAdapter","sdk","config","swarmMetadata","Map","apiKey","process","env","ANTHROPIC_API_KEY","CLAUDE_API_KEY","baseURL","maxRetries","timeout","defaultHeaders","swarmMode","persistenceEnabled","checkpointInterval","memoryNamespace","getSDK","getConfig","createMessage","params","message","messages","create","id","set","timestamp","Date","now","model","tokensUsed","usage","error","console","logSwarmError","createStreamingMessage","options","stream","fullMessage","chunk","onChunk","type","delta","stop_reason","validateConfiguration","max_tokens","role","content","AuthenticationError","RateLimitError","warn","getSwarmMetadata","messageId","get","clearSwarmMetadata","clear","errorMessage","Error","String","errorStack","stack","undefined","getUsageStats","totalTokens","messageCount","forEach","metadata","total_tokens","defaultSDKAdapter"],"mappings":"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"}
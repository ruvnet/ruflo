{"version":3,"sources":["../../../src/mcp/lifecycle-manager.ts"],"sourcesContent":["/**\r\n * MCP Server Lifecycle Manager\r\n * Handles server lifecycle operations including start, stop, restart, and health checks\r\n */\r\n\r\nimport { EventEmitter } from 'node:events';\r\nimport type { ILogger } from '../core/logger.js';\r\nimport type { MCPConfig, MCPSession, MCPMetrics, HealthStatus } from '../utils/types.js';\r\nimport { MCPError } from '../utils/errors.js';\r\nimport type { IMCPServer } from './server.js';\r\n\r\nexport enum LifecycleState {\r\n  STOPPED = 'stopped',\r\n  STARTING = 'starting',\r\n  RUNNING = 'running',\r\n  STOPPING = 'stopping',\r\n  RESTARTING = 'restarting',\r\n  ERROR = 'error',\r\n}\r\n\r\nexport interface LifecycleEvent {\r\n  timestamp: Date;\r\n  state: LifecycleState;\r\n  previousState?: LifecycleState;\r\n  error?: Error;\r\n  details?: Record<string, unknown>;\r\n}\r\n\r\nexport interface HealthCheckResult {\r\n  healthy: boolean;\r\n  state: LifecycleState;\r\n  uptime: number;\r\n  lastRestart?: Date;\r\n  error?: string;\r\n  metrics?: Record<string, number>;\r\n  components: {\r\n    server: boolean;\r\n    transport: boolean;\r\n    sessions: boolean;\r\n    tools: boolean;\r\n    auth: boolean;\r\n    loadBalancer: boolean;\r\n  };\r\n}\r\n\r\nexport interface LifecycleManagerConfig {\r\n  healthCheckInterval: number;\r\n  gracefulShutdownTimeout: number;\r\n  maxRestartAttempts: number;\r\n  restartDelay: number;\r\n  enableAutoRestart: boolean;\r\n  enableHealthChecks: boolean;\r\n}\r\n\r\n/**\r\n * MCP Server Lifecycle Manager\r\n * Manages the complete lifecycle of MCP servers with robust error handling\r\n */\r\nexport class MCPLifecycleManager extends EventEmitter {\r\n  private state: LifecycleState = LifecycleState.STOPPED;\r\n  private server?: IMCPServer;\r\n  private healthCheckTimer?: NodeJS.Timeout;\r\n  private startTime?: Date;\r\n  private lastRestart?: Date;\r\n  private restartAttempts = 0;\r\n  private shutdownPromise?: Promise<void>;\r\n  private history: LifecycleEvent[] = [];\r\n\r\n  private readonly config: LifecycleManagerConfig = {\r\n    healthCheckInterval: 30000, // 30 seconds\r\n    gracefulShutdownTimeout: 10000, // 10 seconds\r\n    maxRestartAttempts: 3,\r\n    restartDelay: 5000, // 5 seconds\r\n    enableAutoRestart: true,\r\n    enableHealthChecks: true,\r\n  };\r\n\r\n  constructor(\r\n    private mcpConfig: MCPConfig,\r\n    private logger: ILogger,\r\n    private serverFactory: () => IMCPServer,\r\n    config?: Partial<LifecycleManagerConfig>,\r\n  ) {\r\n    super();\r\n\r\n    if (config) {\r\n      Object.assign(this.config, config);\r\n    }\r\n\r\n    this.setupEventHandlers();\r\n  }\r\n\r\n  /**\r\n   * Start the MCP server\r\n   */\r\n  async start(): Promise<void> {\r\n    if (this.state !== LifecycleState.STOPPED) {\r\n      throw new MCPError(`Cannot start server in state: ${this.state}`);\r\n    }\r\n\r\n    this.setState(LifecycleState.STARTING);\r\n    this.logger.info('Starting MCP server lifecycle manager');\r\n\r\n    try {\r\n      // Create server instance\r\n      this.server = this.serverFactory();\r\n\r\n      // Start the server\r\n      await this.server.start();\r\n\r\n      // Record start time\r\n      this.startTime = new Date();\r\n      this.restartAttempts = 0;\r\n\r\n      // Start health checks\r\n      if (this.config.enableHealthChecks) {\r\n        this.startHealthChecks();\r\n      }\r\n\r\n      this.setState(LifecycleState.RUNNING);\r\n      this.logger.info('MCP server started successfully');\r\n    } catch (error) {\r\n      this.setState(LifecycleState.ERROR, error as Error);\r\n      this.logger.error('Failed to start MCP server', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop the MCP server gracefully\r\n   */\r\n  async stop(): Promise<void> {\r\n    if (this.state === LifecycleState.STOPPED) {\r\n      return;\r\n    }\r\n\r\n    if (this.shutdownPromise) {\r\n      return this.shutdownPromise;\r\n    }\r\n\r\n    this.setState(LifecycleState.STOPPING);\r\n    this.logger.info('Stopping MCP server');\r\n\r\n    this.shutdownPromise = this.performShutdown();\r\n    await this.shutdownPromise;\r\n    this.shutdownPromise = undefined;\r\n  }\r\n\r\n  /**\r\n   * Restart the MCP server\r\n   */\r\n  async restart(): Promise<void> {\r\n    if (this.state === LifecycleState.STOPPED) {\r\n      return this.start();\r\n    }\r\n\r\n    this.setState(LifecycleState.RESTARTING);\r\n    this.logger.info('Restarting MCP server');\r\n\r\n    try {\r\n      await this.stop();\r\n\r\n      // Add restart delay\r\n      if (this.config.restartDelay > 0) {\r\n        await new Promise((resolve) => setTimeout(resolve, this.config.restartDelay));\r\n      }\r\n\r\n      await this.start();\r\n      this.lastRestart = new Date();\r\n      this.restartAttempts++;\r\n\r\n      this.logger.info('MCP server restarted successfully');\r\n    } catch (error) {\r\n      this.setState(LifecycleState.ERROR, error as Error);\r\n      this.logger.error('Failed to restart MCP server', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Perform comprehensive health check\r\n   */\r\n  async healthCheck(): Promise<HealthCheckResult> {\r\n    const startTime = Date.now();\r\n    const result: HealthCheckResult = {\r\n      healthy: false,\r\n      state: this.state,\r\n      uptime: this.getUptime(),\r\n      lastRestart: this.lastRestart,\r\n      components: {\r\n        server: false,\r\n        transport: false,\r\n        sessions: false,\r\n        tools: false,\r\n        auth: false,\r\n        loadBalancer: false,\r\n      },\r\n    };\r\n\r\n    try {\r\n      if (!this.server || this.state !== LifecycleState.RUNNING) {\r\n        result.error = 'Server not running';\r\n        return result;\r\n      }\r\n\r\n      // Check server health\r\n      const serverHealth = await this.server.getHealthStatus();\r\n      result.components.server = serverHealth.healthy;\r\n      result.metrics = serverHealth.metrics;\r\n\r\n      if (serverHealth.error) {\r\n        result.error = serverHealth.error;\r\n      }\r\n\r\n      // Check individual components\r\n      result.components.transport = serverHealth.metrics?.transportConnections !== undefined;\r\n      result.components.sessions = serverHealth.metrics?.activeSessions !== undefined;\r\n      result.components.tools = (serverHealth.metrics?.registeredTools || 0) > 0;\r\n      result.components.auth = serverHealth.metrics?.authenticatedSessions !== undefined;\r\n      result.components.loadBalancer = serverHealth.metrics?.rateLimitedRequests !== undefined;\r\n\r\n      // Overall health assessment\r\n      result.healthy =\r\n        result.components.server &&\r\n        result.components.transport &&\r\n        result.components.sessions &&\r\n        result.components.tools;\r\n\r\n      const checkDuration = Date.now() - startTime;\r\n      if (result.metrics) {\r\n        result.metrics.healthCheckDuration = checkDuration;\r\n      }\r\n\r\n      this.logger.debug('Health check completed', {\r\n        healthy: result.healthy,\r\n        duration: checkDuration,\r\n        components: result.components,\r\n      });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      result.error = error instanceof Error ? error.message : 'Unknown error';\r\n      this.logger.error('Health check failed', error);\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current server state\r\n   */\r\n  getState(): LifecycleState {\r\n    return this.state;\r\n  }\r\n\r\n  /**\r\n   * Get server metrics\r\n   */\r\n  getMetrics(): MCPMetrics | undefined {\r\n    return this.server?.getMetrics();\r\n  }\r\n\r\n  /**\r\n   * Get active sessions\r\n   */\r\n  getSessions(): MCPSession[] {\r\n    return this.server?.getSessions() || [];\r\n  }\r\n\r\n  /**\r\n   * Get server uptime in milliseconds\r\n   */\r\n  getUptime(): number {\r\n    return this.startTime ? Date.now() - this.startTime.getTime() : 0;\r\n  }\r\n\r\n  /**\r\n   * Get lifecycle event history\r\n   */\r\n  getHistory(): LifecycleEvent[] {\r\n    return [...this.history];\r\n  }\r\n\r\n  /**\r\n   * Force terminate server (emergency stop)\r\n   */\r\n  async forceStop(): Promise<void> {\r\n    this.logger.warn('Force stopping MCP server');\r\n\r\n    // Stop health checks\r\n    this.stopHealthChecks();\r\n\r\n    // Force close server\r\n    if (this.server) {\r\n      try {\r\n        await this.server.stop();\r\n      } catch (error) {\r\n        this.logger.error('Error during force stop', error);\r\n      }\r\n      this.server = undefined;\r\n    }\r\n\r\n    this.setState(LifecycleState.STOPPED);\r\n    this.startTime = undefined;\r\n  }\r\n\r\n  /**\r\n   * Enable or disable auto-restart\r\n   */\r\n  setAutoRestart(enabled: boolean): void {\r\n    this.config.enableAutoRestart = enabled;\r\n    this.logger.info('Auto-restart', { enabled });\r\n  }\r\n\r\n  /**\r\n   * Enable or disable health checks\r\n   */\r\n  setHealthChecks(enabled: boolean): void {\r\n    this.config.enableHealthChecks = enabled;\r\n\r\n    if (enabled && this.state === LifecycleState.RUNNING) {\r\n      this.startHealthChecks();\r\n    } else {\r\n      this.stopHealthChecks();\r\n    }\r\n\r\n    this.logger.info('Health checks', { enabled });\r\n  }\r\n\r\n  private setState(newState: LifecycleState, error?: Error): void {\r\n    const previousState = this.state;\r\n    this.state = newState;\r\n\r\n    const event: LifecycleEvent = {\r\n      timestamp: new Date(),\r\n      state: newState,\r\n      previousState,\r\n      error,\r\n    };\r\n\r\n    this.history.push(event);\r\n\r\n    // Keep only last 100 events\r\n    if (this.history.length > 100) {\r\n      this.history.shift();\r\n    }\r\n\r\n    this.emit('stateChange', event);\r\n    this.logger.info('State change', {\r\n      from: previousState,\r\n      to: newState,\r\n      error: error?.message,\r\n    });\r\n  }\r\n\r\n  private setupEventHandlers(): void {\r\n    // Handle uncaught errors\r\n    process.on('uncaughtException', (error) => {\r\n      this.logger.error('Uncaught exception', error);\r\n      this.handleServerError(error);\r\n    });\r\n\r\n    process.on('unhandledRejection', (reason) => {\r\n      this.logger.error('Unhandled rejection', reason);\r\n      this.handleServerError(reason instanceof Error ? reason : new Error(String(reason)));\r\n    });\r\n\r\n    // Handle process signals\r\n    process.on('SIGINT', () => {\r\n      this.logger.info('Received SIGINT, shutting down gracefully');\r\n      this.stop().catch((error) => {\r\n        this.logger.error('Error during graceful shutdown', error);\r\n        process.exit(1);\r\n      });\r\n    });\r\n\r\n    process.on('SIGTERM', () => {\r\n      this.logger.info('Received SIGTERM, shutting down gracefully');\r\n      this.stop().catch((error) => {\r\n        this.logger.error('Error during graceful shutdown', error);\r\n        process.exit(1);\r\n      });\r\n    });\r\n  }\r\n\r\n  private async handleServerError(error: Error): Promise<void> {\r\n    this.logger.error('Server error detected', error);\r\n    this.setState(LifecycleState.ERROR, error);\r\n\r\n    if (this.config.enableAutoRestart && this.restartAttempts < this.config.maxRestartAttempts) {\r\n      this.logger.info('Attempting auto-restart', {\r\n        attempt: this.restartAttempts + 1,\r\n        maxAttempts: this.config.maxRestartAttempts,\r\n      });\r\n\r\n      try {\r\n        await this.restart();\r\n      } catch (restartError) {\r\n        this.logger.error('Auto-restart failed', restartError);\r\n      }\r\n    } else {\r\n      this.logger.error('Max restart attempts reached or auto-restart disabled');\r\n      await this.forceStop();\r\n    }\r\n  }\r\n\r\n  private startHealthChecks(): void {\r\n    if (this.healthCheckTimer) {\r\n      return;\r\n    }\r\n\r\n    this.healthCheckTimer = setInterval(async () => {\r\n      try {\r\n        const health = await this.healthCheck();\r\n\r\n        if (!health.healthy && this.state === LifecycleState.RUNNING) {\r\n          this.logger.warn('Health check failed', health);\r\n          this.handleServerError(new Error(health.error || 'Health check failed'));\r\n        }\r\n      } catch (error) {\r\n        this.logger.error('Health check error', error);\r\n      }\r\n    }, this.config.healthCheckInterval);\r\n\r\n    this.logger.debug('Health checks started', { interval: this.config.healthCheckInterval });\r\n  }\r\n\r\n  private stopHealthChecks(): void {\r\n    if (this.healthCheckTimer) {\r\n      clearInterval(this.healthCheckTimer);\r\n      this.healthCheckTimer = undefined;\r\n      this.logger.debug('Health checks stopped');\r\n    }\r\n  }\r\n\r\n  private async performShutdown(): Promise<void> {\r\n    try {\r\n      // Stop health checks\r\n      this.stopHealthChecks();\r\n\r\n      // Graceful shutdown with timeout\r\n      const shutdownPromise = this.server?.stop() || Promise.resolve();\r\n      const timeoutPromise = new Promise<never>((_, reject) => {\r\n        setTimeout(\r\n          () => reject(new Error('Shutdown timeout')),\r\n          this.config.gracefulShutdownTimeout,\r\n        );\r\n      });\r\n\r\n      await Promise.race([shutdownPromise, timeoutPromise]);\r\n\r\n      this.server = undefined;\r\n      this.setState(LifecycleState.STOPPED);\r\n      this.startTime = undefined;\r\n\r\n      this.logger.info('MCP server stopped successfully');\r\n    } catch (error) {\r\n      this.logger.error('Error during shutdown', error);\r\n      await this.forceStop();\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"names":["EventEmitter","MCPError","LifecycleState","MCPLifecycleManager","state","server","healthCheckTimer","startTime","lastRestart","restartAttempts","shutdownPromise","history","config","healthCheckInterval","gracefulShutdownTimeout","maxRestartAttempts","restartDelay","enableAutoRestart","enableHealthChecks","mcpConfig","logger","serverFactory","Object","assign","setupEventHandlers","start","setState","info","Date","startHealthChecks","error","stop","performShutdown","undefined","restart","Promise","resolve","setTimeout","healthCheck","now","result","healthy","uptime","getUptime","components","transport","sessions","tools","auth","loadBalancer","serverHealth","getHealthStatus","metrics","transportConnections","activeSessions","registeredTools","authenticatedSessions","rateLimitedRequests","checkDuration","healthCheckDuration","debug","duration","Error","message","getState","getMetrics","getSessions","getTime","getHistory","forceStop","warn","stopHealthChecks","setAutoRestart","enabled","setHealthChecks","newState","previousState","event","timestamp","push","length","shift","emit","from","to","process","on","handleServerError","reason","String","catch","exit","attempt","maxAttempts","restartError","setInterval","health","interval","clearInterval","timeoutPromise","_","reject","race"],"mappings":"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"}
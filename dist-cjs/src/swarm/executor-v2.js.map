{"version":3,"sources":["../../../src/swarm/executor-v2.ts"],"sourcesContent":["/**\r\n * Enhanced Task Executor v2.0 with improved environment handling\r\n */\r\n\r\nimport { spawn, ChildProcess } from 'node:child_process';\r\nimport { EventEmitter } from 'node:events';\r\nimport * as fs from 'node:fs/promises';\r\nimport * as path from 'node:path';\r\nimport * as os from 'node:os';\r\nimport chalk from 'chalk';\r\nimport { Logger } from '../core/logger.js';\r\nimport { generateId } from '../utils/helpers.js';\r\nimport {\r\n  detectExecutionEnvironment,\r\n  applySmartDefaults,\r\n} from '../cli/utils/environment-detector.js';\r\nimport {\r\n  TaskDefinition,\r\n  AgentState,\r\n  TaskResult,\r\n  SwarmEvent,\r\n  EventType,\r\n  SWARM_CONSTANTS,\r\n} from './types.js';\r\n\r\nexport interface ClaudeExecutionOptionsV2 extends ClaudeExecutionOptions {\r\n  nonInteractive?: boolean;\r\n  autoApprove?: boolean;\r\n  promptDefaults?: Record<string, any>;\r\n  environmentOverride?: Record<string, string>;\r\n  retryOnInteractiveError?: boolean;\r\n}\r\n\r\nexport class TaskExecutorV2 extends TaskExecutor {\r\n  private environment = detectExecutionEnvironment();\r\n\r\n  constructor(config: Partial<ExecutionConfig> = {}) {\r\n    super(config);\r\n\r\n    // Log environment info on initialization\r\n    this.logger.info('Task Executor v2.0 initialized', {\r\n      environment: this.environment.terminalType,\r\n      interactive: this.environment.isInteractive,\r\n      recommendations: this.environment.recommendedFlags,\r\n    });\r\n  }\r\n\r\n  async executeClaudeTask(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    claudeOptions: ClaudeExecutionOptionsV2 = {},\r\n  ): Promise<ExecutionResult> {\r\n    // Apply smart defaults based on environment\r\n    const enhancedOptions = applySmartDefaults(claudeOptions, this.environment);\r\n\r\n    // Log if defaults were applied\r\n    if (enhancedOptions.appliedDefaults.length > 0) {\r\n      this.logger.info('Applied environment-based defaults', {\r\n        defaults: enhancedOptions.appliedDefaults,\r\n        environment: this.environment.terminalType,\r\n      });\r\n    }\r\n\r\n    try {\r\n      return await this.executeClaudeWithTimeoutV2(\r\n        generateId('claude-execution'),\r\n        task,\r\n        agent,\r\n        await this.createExecutionContext(task, agent),\r\n        enhancedOptions,\r\n      );\r\n    } catch (error) {\r\n      // Handle interactive errors with retry\r\n      if (this.isInteractiveError(error) && enhancedOptions.retryOnInteractiveError) {\r\n        this.logger.warn('Interactive error detected, retrying with non-interactive mode', {\r\n          error: error.message,\r\n        });\r\n\r\n        // Force non-interactive mode and retry\r\n        enhancedOptions.nonInteractive = true;\r\n        enhancedOptions.dangerouslySkipPermissions = true;\r\n\r\n        return await this.executeClaudeWithTimeoutV2(\r\n          generateId('claude-execution-retry'),\r\n          task,\r\n          agent,\r\n          await this.createExecutionContext(task, agent),\r\n          enhancedOptions,\r\n        );\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async executeClaudeWithTimeoutV2(\r\n    sessionId: string,\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    context: ExecutionContext,\r\n    options: ClaudeExecutionOptionsV2,\r\n  ): Promise<ExecutionResult> {\r\n    const startTime = Date.now();\r\n    const timeout = options.timeout || this.config.timeoutMs;\r\n\r\n    // Build Claude command with v2 enhancements\r\n    const command = this.buildClaudeCommandV2(task, agent, options);\r\n\r\n    // Create execution environment with enhancements\r\n    const env = {\r\n      ...process.env,\r\n      ...context.environment,\r\n      ...options.environmentOverride,\r\n      CLAUDE_TASK_ID: task.id.id,\r\n      CLAUDE_AGENT_ID: agent.id.id,\r\n      CLAUDE_SESSION_ID: sessionId,\r\n      CLAUDE_WORKING_DIR: context.workingDirectory,\r\n      CLAUDE_NON_INTERACTIVE: options.nonInteractive ? '1' : '0',\r\n      CLAUDE_AUTO_APPROVE: options.autoApprove ? '1' : '0',\r\n    };\r\n\r\n    // Add prompt defaults if provided\r\n    if (options.promptDefaults) {\r\n      env.CLAUDE_PROMPT_DEFAULTS = JSON.stringify(options.promptDefaults);\r\n    }\r\n\r\n    this.logger.debug('Executing Claude command v2', {\r\n      sessionId,\r\n      command: command.command,\r\n      args: command.args,\r\n      workingDir: context.workingDirectory,\r\n      nonInteractive: options.nonInteractive,\r\n      environment: this.environment.terminalType,\r\n    });\r\n\r\n    return new Promise((resolve, reject) => {\r\n      let outputBuffer = '';\r\n      let errorBuffer = '';\r\n      let isTimeout = false;\r\n      let process: ChildProcess | null = null;\r\n\r\n      // Setup timeout\r\n      const timeoutHandle = setTimeout(() => {\r\n        isTimeout = true;\r\n        if (process) {\r\n          this.logger.warn('Claude execution timeout, killing process', {\r\n            sessionId,\r\n            pid: process.pid,\r\n            timeout,\r\n          });\r\n\r\n          process.kill('SIGTERM');\r\n          setTimeout(() => {\r\n            if (process && !process.killed) {\r\n              process.kill('SIGKILL');\r\n            }\r\n          }, this.config.killTimeout);\r\n        }\r\n      }, timeout);\r\n\r\n      try {\r\n        // Spawn Claude process with enhanced options\r\n        process = spawn(command.command, command.args, {\r\n          cwd: context.workingDirectory,\r\n          env,\r\n          stdio: options.nonInteractive ? ['ignore', 'pipe', 'pipe'] : ['pipe', 'pipe', 'pipe'],\r\n          detached: options.detached || false,\r\n          // Disable shell to avoid shell-specific issues\r\n          shell: false,\r\n        });\r\n\r\n        if (!process.pid) {\r\n          clearTimeout(timeoutHandle);\r\n          reject(new Error('Failed to spawn Claude process'));\r\n          return;\r\n        }\r\n\r\n        this.logger.info('Claude process started (v2)', {\r\n          sessionId,\r\n          pid: process.pid,\r\n          command: command.command,\r\n          mode: options.nonInteractive ? 'non-interactive' : 'interactive',\r\n        });\r\n\r\n        // Handle process output\r\n        if (process.stdout) {\r\n          process.stdout.on('data', (data: Buffer) => {\r\n            const chunk = data.toString();\r\n            outputBuffer += chunk;\r\n\r\n            if (this.config.streamOutput) {\r\n              this.emit('output', {\r\n                sessionId,\r\n                type: 'stdout',\r\n                data: chunk,\r\n              });\r\n            }\r\n          });\r\n        }\r\n\r\n        if (process.stderr) {\r\n          process.stderr.on('data', (data: Buffer) => {\r\n            const chunk = data.toString();\r\n            errorBuffer += chunk;\r\n\r\n            // Check for interactive mode errors\r\n            if (this.isInteractiveErrorMessage(chunk)) {\r\n              this.logger.warn('Interactive mode error detected in stderr', {\r\n                sessionId,\r\n                error: chunk.trim(),\r\n              });\r\n            }\r\n\r\n            if (this.config.streamOutput) {\r\n              this.emit('output', {\r\n                sessionId,\r\n                type: 'stderr',\r\n                data: chunk,\r\n              });\r\n            }\r\n          });\r\n        }\r\n\r\n        // Handle process errors\r\n        process.on('error', (error: Error) => {\r\n          clearTimeout(timeoutHandle);\r\n          this.logger.error('Process error', {\r\n            sessionId,\r\n            error: error.message,\r\n            code: (error as any).code,\r\n          });\r\n          reject(error);\r\n        });\r\n\r\n        // Handle process completion\r\n        process.on('close', async (code: number | null, signal: string | null) => {\r\n          clearTimeout(timeoutHandle);\r\n\r\n          const duration = Date.now() - startTime;\r\n          const exitCode = code || 0;\r\n\r\n          this.logger.info('Claude process completed (v2)', {\r\n            sessionId,\r\n            exitCode,\r\n            signal,\r\n            duration,\r\n            isTimeout,\r\n            hasErrors: errorBuffer.length > 0,\r\n          });\r\n\r\n          try {\r\n            // Collect resource usage\r\n            const resourceUsage = await this.collectResourceUsage(sessionId);\r\n\r\n            // Collect artifacts\r\n            const artifacts = await this.collectArtifacts(context);\r\n\r\n            const result: ExecutionResult = {\r\n              success: !isTimeout && exitCode === 0,\r\n              output: outputBuffer,\r\n              error: errorBuffer,\r\n              exitCode,\r\n              duration,\r\n              resourcesUsed: resourceUsage,\r\n              artifacts,\r\n              metadata: {\r\n                environment: this.environment.terminalType,\r\n                nonInteractive: options.nonInteractive || false,\r\n                appliedDefaults: (options as any).appliedDefaults || [],\r\n              },\r\n            };\r\n\r\n            if (isTimeout) {\r\n              reject(new Error(`Execution timed out after ${timeout}ms`));\r\n            } else if (exitCode !== 0 && this.isInteractiveErrorMessage(errorBuffer)) {\r\n              reject(new Error(`Interactive mode error: ${errorBuffer.trim()}`));\r\n            } else {\r\n              resolve(result);\r\n            }\r\n          } catch (collectionError) {\r\n            this.logger.error('Error collecting execution results', {\r\n              sessionId,\r\n              error: collectionError.message,\r\n            });\r\n\r\n            // Still resolve with basic result\r\n            resolve({\r\n              success: !isTimeout && exitCode === 0,\r\n              output: outputBuffer,\r\n              error: errorBuffer,\r\n              exitCode,\r\n              duration,\r\n              resourcesUsed: this.getDefaultResourceUsage(),\r\n              artifacts: {},\r\n              metadata: {},\r\n            });\r\n          }\r\n        });\r\n      } catch (spawnError) {\r\n        clearTimeout(timeoutHandle);\r\n        this.logger.error('Failed to spawn process', {\r\n          sessionId,\r\n          error: spawnError.message,\r\n        });\r\n        reject(spawnError);\r\n      }\r\n    });\r\n  }\r\n\r\n  private buildClaudeCommandV2(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    options: ClaudeExecutionOptionsV2,\r\n  ): ClaudeCommand {\r\n    const args: string[] = [];\r\n    let input = '';\r\n\r\n    // Build prompt\r\n    const prompt = this.buildClaudePrompt(task, agent);\r\n\r\n    if (options.useStdin) {\r\n      input = prompt;\r\n    } else {\r\n      args.push('-p', prompt);\r\n    }\r\n\r\n    // Add tools\r\n    if (task.requirements.tools.length > 0) {\r\n      args.push('--allowedTools', task.requirements.tools.join(','));\r\n    }\r\n\r\n    // Add model if specified\r\n    if (options.model) {\r\n      args.push('--model', options.model);\r\n    }\r\n\r\n    // Add max tokens if specified\r\n    if (options.maxTokens) {\r\n      args.push('--max-tokens', options.maxTokens.toString());\r\n    }\r\n\r\n    // Add temperature if specified\r\n    if (options.temperature !== undefined) {\r\n      args.push('--temperature', options.temperature.toString());\r\n    }\r\n\r\n    // Skip permissions check for non-interactive environments\r\n    if (\r\n      options.nonInteractive ||\r\n      options.dangerouslySkipPermissions ||\r\n      this.environment.recommendedFlags.includes('--dangerously-skip-permissions')\r\n    ) {\r\n      args.push('--dangerously-skip-permissions');\r\n    }\r\n\r\n    // Add non-interactive flag if needed\r\n    if (options.nonInteractive) {\r\n      args.push('--non-interactive');\r\n    }\r\n\r\n    // Add auto-approve if specified\r\n    if (options.autoApprove) {\r\n      args.push('--auto-approve');\r\n    }\r\n\r\n    // Add output format\r\n    if (options.outputFormat) {\r\n      args.push('--output-format', options.outputFormat);\r\n    } else if (options.nonInteractive) {\r\n      // Default to JSON for non-interactive mode\r\n      args.push('--output-format', 'json');\r\n    }\r\n\r\n    // Add environment info for debugging\r\n    args.push(\r\n      '--metadata',\r\n      JSON.stringify({\r\n        environment: this.environment.terminalType,\r\n        interactive: this.environment.isInteractive,\r\n        executor: 'v2',\r\n      }),\r\n    );\r\n\r\n    return {\r\n      command: options.claudePath || 'claude',\r\n      args,\r\n      input,\r\n    };\r\n  }\r\n\r\n  private isInteractiveError(error: any): boolean {\r\n    if (!(error instanceof Error)) return false;\r\n\r\n    const errorMessage = error.message.toLowerCase();\r\n    return (\r\n      errorMessage.includes('raw mode') ||\r\n      errorMessage.includes('stdin') ||\r\n      errorMessage.includes('interactive') ||\r\n      errorMessage.includes('tty') ||\r\n      errorMessage.includes('terminal')\r\n    );\r\n  }\r\n\r\n  private isInteractiveErrorMessage(message: string): boolean {\r\n    const lowerMessage = message.toLowerCase();\r\n    return (\r\n      lowerMessage.includes('raw mode is not supported') ||\r\n      lowerMessage.includes('stdin is not a tty') ||\r\n      lowerMessage.includes('requires interactive terminal') ||\r\n      lowerMessage.includes('manual ui agreement needed')\r\n    );\r\n  }\r\n\r\n  private getDefaultResourceUsage(): ResourceUsage {\r\n    return {\r\n      cpuTime: 0,\r\n      maxMemory: 0,\r\n      diskIO: 0,\r\n      networkIO: 0,\r\n      fileHandles: 0,\r\n    };\r\n  }\r\n}\r\n\r\nexport default TaskExecutorV2;\r\n"],"names":["spawn","generateId","detectExecutionEnvironment","applySmartDefaults","TaskExecutorV2","TaskExecutor","environment","config","logger","info","terminalType","interactive","isInteractive","recommendations","recommendedFlags","executeClaudeTask","task","agent","claudeOptions","enhancedOptions","appliedDefaults","length","defaults","executeClaudeWithTimeoutV2","createExecutionContext","error","isInteractiveError","retryOnInteractiveError","warn","message","nonInteractive","dangerouslySkipPermissions","sessionId","context","options","startTime","Date","now","timeout","timeoutMs","command","buildClaudeCommandV2","env","process","environmentOverride","CLAUDE_TASK_ID","id","CLAUDE_AGENT_ID","CLAUDE_SESSION_ID","CLAUDE_WORKING_DIR","workingDirectory","CLAUDE_NON_INTERACTIVE","CLAUDE_AUTO_APPROVE","autoApprove","promptDefaults","CLAUDE_PROMPT_DEFAULTS","JSON","stringify","debug","args","workingDir","Promise","resolve","reject","outputBuffer","errorBuffer","isTimeout","timeoutHandle","setTimeout","pid","kill","killed","killTimeout","cwd","stdio","detached","shell","clearTimeout","Error","mode","stdout","on","data","chunk","toString","streamOutput","emit","type","stderr","isInteractiveErrorMessage","trim","code","signal","duration","exitCode","hasErrors","resourceUsage","collectResourceUsage","artifacts","collectArtifacts","result","success","output","resourcesUsed","metadata","collectionError","getDefaultResourceUsage","spawnError","input","prompt","buildClaudePrompt","useStdin","push","requirements","tools","join","model","maxTokens","temperature","undefined","includes","outputFormat","executor","claudePath","errorMessage","toLowerCase","lowerMessage","cpuTime","maxMemory","diskIO","networkIO","fileHandles"],"mappings":"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"}
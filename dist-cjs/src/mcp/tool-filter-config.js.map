{"version":3,"sources":["../../../src/mcp/tool-filter-config.ts"],"sourcesContent":["/**\n * Tool Filter Configuration Loader\n *\n * Loads tool filter configuration from multiple sources:\n * 1. Dedicated config file (.claude-flow/mcp-tools.json)\n * 2. Alternative config files (.claude-flow/mcp-tools.yaml, mcp-tools.json)\n * 3. Environment variables\n *\n * Priority order (highest to lowest):\n * 1. Environment variables (override file config)\n * 2. Config files (first found wins)\n */\n\nimport { promises as fs } from 'node:fs';\nimport { join } from 'node:path';\nimport type { MCPToolFilterConfig } from '../utils/types.js';\nimport type { ILogger } from '../core/logger.js';\n\n/**\n * Default paths to search for tool filter configuration files\n * Searched in order, first found wins\n */\nconst DEFAULT_CONFIG_PATHS = [\n  '.claude-flow/mcp-tools.json',\n  '.claude-flow/mcp-tools.yaml',\n  'mcp-tools.json',\n];\n\n/**\n * Result of loading tool filter configuration\n */\nexport interface LoadedToolFilterConfig {\n  /** The loaded configuration */\n  config: MCPToolFilterConfig;\n  /** Source of the configuration (file path or 'environment') */\n  source: string;\n}\n\n/**\n * Default configuration when no config is found\n */\nconst DEFAULT_CONFIG: MCPToolFilterConfig = {\n  enabled: false,\n  mode: 'allowlist',\n  tools: [],\n};\n\n/**\n * Load tool filter configuration from multiple sources\n *\n * @param logger - Logger instance for debugging\n * @param workingDirectory - Base directory to search for config files (defaults to cwd)\n * @returns Loaded configuration or null if none found/disabled\n */\nexport async function loadToolFilterConfig(\n  logger: ILogger,\n  workingDirectory?: string\n): Promise<LoadedToolFilterConfig | null> {\n  const cwd = workingDirectory || process.cwd();\n\n  // First, try to load from config files\n  const fileConfig = await loadFromConfigFiles(cwd, logger);\n\n  // If we found a file config, optionally merge with env overrides\n  if (fileConfig) {\n    const envOverrides = loadEnvironmentOverrides();\n\n    // If env has explicit enabled setting, it overrides file\n    if (envOverrides.hasExplicitEnabled) {\n      fileConfig.config.enabled = envOverrides.config.enabled;\n    }\n\n    // Merge other env overrides if they exist\n    if (envOverrides.config.tools.length > 0) {\n      fileConfig.config.tools = envOverrides.config.tools;\n    }\n    if (envOverrides.config.maxTools !== undefined) {\n      fileConfig.config.maxTools = envOverrides.config.maxTools;\n    }\n    if (envOverrides.hasExplicitMode) {\n      fileConfig.config.mode = envOverrides.config.mode;\n    }\n\n    logger.debug('Tool filter config loaded', {\n      source: fileConfig.source,\n      enabled: fileConfig.config.enabled,\n      mode: fileConfig.config.mode,\n      toolCount: fileConfig.config.tools.length,\n    });\n\n    return fileConfig;\n  }\n\n  // No file config found, try environment-only configuration\n  const envConfig = loadFromEnvironment();\n  if (envConfig.enabled) {\n    logger.info('Tool filter config loaded from environment variables');\n    return {\n      config: envConfig,\n      source: 'environment',\n    };\n  }\n\n  // No configuration found\n  logger.debug('No tool filter configuration found, filtering disabled');\n  return null;\n}\n\n/**\n * Attempt to load configuration from config files\n */\nasync function loadFromConfigFiles(\n  cwd: string,\n  logger: ILogger\n): Promise<LoadedToolFilterConfig | null> {\n  for (const configPath of DEFAULT_CONFIG_PATHS) {\n    const fullPath = join(cwd, configPath);\n\n    try {\n      const content = await fs.readFile(fullPath, 'utf-8');\n      const parsed = parseConfigFile(content, configPath);\n\n      // Look for toolFilter in the parsed config\n      if (parsed.toolFilter) {\n        const config = validateAndNormalize(parsed.toolFilter);\n        logger.info('Loaded tool filter config from file', { source: configPath });\n        return {\n          config,\n          source: configPath,\n        };\n      }\n\n      // Also support root-level config (entire file is the tool filter config)\n      if (parsed.enabled !== undefined && parsed.mode !== undefined) {\n        const config = validateAndNormalize(parsed);\n        logger.info('Loaded tool filter config from file (root level)', { source: configPath });\n        return {\n          config,\n          source: configPath,\n        };\n      }\n    } catch (error) {\n      // File doesn't exist or can't be read, continue to next\n      if ((error as NodeJS.ErrnoException).code !== 'ENOENT') {\n        logger.warn(`Failed to parse config file: ${configPath}`, { error });\n      }\n      continue;\n    }\n  }\n\n  return null;\n}\n\n/**\n * Parse configuration file based on extension\n */\nfunction parseConfigFile(content: string, path: string): Record<string, unknown> {\n  if (path.endsWith('.json')) {\n    return JSON.parse(content);\n  }\n\n  if (path.endsWith('.yaml') || path.endsWith('.yml')) {\n    // Basic YAML support - for full YAML, consider adding js-yaml dependency\n    return parseBasicYaml(content);\n  }\n\n  // Try JSON by default\n  return JSON.parse(content);\n}\n\n/**\n * Load configuration entirely from environment variables\n */\nfunction loadFromEnvironment(): MCPToolFilterConfig {\n  const enabled = process.env.CLAUDE_FLOW_MCP_TOOL_FILTER_ENABLED === 'true';\n  const modeEnv = process.env.CLAUDE_FLOW_MCP_TOOL_FILTER_MODE;\n  const mode: 'allowlist' | 'denylist' =\n    modeEnv === 'allowlist' || modeEnv === 'denylist' ? modeEnv : 'allowlist';\n  const toolsEnv = process.env.CLAUDE_FLOW_MCP_TOOLS_ALLOWED || '';\n  const tools = toolsEnv\n    ? toolsEnv\n        .split(',')\n        .map((t) => t.trim())\n        .filter((t) => t.length > 0)\n    : [];\n  const maxToolsEnv = process.env.CLAUDE_FLOW_MCP_MAX_TOOLS;\n  const maxTools = maxToolsEnv ? parseInt(maxToolsEnv, 10) : undefined;\n\n  return {\n    enabled,\n    mode,\n    tools,\n    maxTools: maxTools && !isNaN(maxTools) ? maxTools : undefined,\n  };\n}\n\n/**\n * Load environment variable overrides (for merging with file config)\n */\nfunction loadEnvironmentOverrides(): {\n  config: MCPToolFilterConfig;\n  hasExplicitEnabled: boolean;\n  hasExplicitMode: boolean;\n} {\n  const enabledEnv = process.env.CLAUDE_FLOW_MCP_TOOL_FILTER_ENABLED;\n  const hasExplicitEnabled = enabledEnv === 'true' || enabledEnv === 'false';\n  const enabled = enabledEnv === 'true';\n\n  const modeEnv = process.env.CLAUDE_FLOW_MCP_TOOL_FILTER_MODE;\n  const hasExplicitMode = modeEnv === 'allowlist' || modeEnv === 'denylist';\n  const mode: 'allowlist' | 'denylist' = hasExplicitMode\n    ? (modeEnv as 'allowlist' | 'denylist')\n    : 'allowlist';\n\n  const toolsEnv = process.env.CLAUDE_FLOW_MCP_TOOLS_ALLOWED || '';\n  const tools = toolsEnv\n    ? toolsEnv\n        .split(',')\n        .map((t) => t.trim())\n        .filter((t) => t.length > 0)\n    : [];\n\n  const maxToolsEnv = process.env.CLAUDE_FLOW_MCP_MAX_TOOLS;\n  const maxTools = maxToolsEnv ? parseInt(maxToolsEnv, 10) : undefined;\n\n  return {\n    config: {\n      enabled,\n      mode,\n      tools,\n      maxTools: maxTools && !isNaN(maxTools) ? maxTools : undefined,\n    },\n    hasExplicitEnabled,\n    hasExplicitMode,\n  };\n}\n\n/**\n * Validate and normalize configuration to ensure all required fields are present\n */\nfunction validateAndNormalize(config: Partial<MCPToolFilterConfig>): MCPToolFilterConfig {\n  return {\n    enabled: config.enabled ?? DEFAULT_CONFIG.enabled,\n    mode: config.mode ?? DEFAULT_CONFIG.mode,\n    tools: Array.isArray(config.tools) ? config.tools : DEFAULT_CONFIG.tools,\n    categories: Array.isArray(config.categories) ? config.categories : undefined,\n    maxTools:\n      typeof config.maxTools === 'number' && config.maxTools > 0 ? config.maxTools : undefined,\n    priorities:\n      typeof config.priorities === 'object' && config.priorities !== null\n        ? config.priorities\n        : undefined,\n  };\n}\n\n/**\n * Basic YAML parser for simple key-value configurations\n *\n * Supports:\n * - Simple key: value pairs\n * - Nested objects\n * - Arrays with dash notation\n * - Comments (#)\n * - Quoted strings\n * - Booleans and numbers\n *\n * Note: For complex YAML, consider using js-yaml library.\n * This is a basic implementation for simple configuration files.\n */\nfunction parseBasicYaml(content: string): Record<string, unknown> {\n  const result: Record<string, unknown> = {};\n  const lines = content.split('\\n');\n  const stack: Array<{ obj: Record<string, unknown>; indent: number }> = [\n    { obj: result, indent: -1 },\n  ];\n  let currentArray: unknown[] | null = null;\n  let currentArrayKey = '';\n  let currentArrayIndent = -1;\n\n  for (const line of lines) {\n    // Skip empty lines and comments\n    const trimmed = line.trim();\n    if (!trimmed || trimmed.startsWith('#')) {\n      continue;\n    }\n\n    // Calculate indentation\n    const indent = line.search(/\\S/);\n\n    // Check if this is an array item\n    if (trimmed.startsWith('- ')) {\n      const value = trimmed.substring(2).trim();\n\n      if (currentArray && indent >= currentArrayIndent) {\n        currentArray.push(parseYamlValue(value));\n      }\n      continue;\n    }\n\n    // Reset array context if indentation decreased\n    if (indent <= currentArrayIndent) {\n      currentArray = null;\n      currentArrayKey = '';\n      currentArrayIndent = -1;\n    }\n\n    // Parse key: value pair\n    const colonIndex = trimmed.indexOf(':');\n    if (colonIndex === -1) {\n      continue;\n    }\n\n    const key = trimmed.substring(0, colonIndex).trim();\n    const rawValue = trimmed.substring(colonIndex + 1).trim();\n\n    // Pop stack until we find the correct parent\n    while (stack.length > 1 && stack[stack.length - 1].indent >= indent) {\n      stack.pop();\n    }\n\n    const parent = stack[stack.length - 1].obj;\n\n    if (rawValue === '' || rawValue === null) {\n      // This key introduces a new object or array\n      // Check if next line starts with '-' for array\n      const lineIdx = lines.indexOf(line);\n      const nextLineIdx = lines.findIndex(\n        (l, i) => i > lineIdx && l.trim() !== '' && !l.trim().startsWith('#')\n      );\n      const nextLine = nextLineIdx >= 0 ? lines[nextLineIdx] : '';\n\n      if (nextLine.trim().startsWith('- ')) {\n        // This is an array\n        const arr: unknown[] = [];\n        parent[key] = arr;\n        currentArray = arr;\n        currentArrayKey = key;\n        currentArrayIndent = nextLine.search(/\\S/);\n      } else {\n        // This is a nested object\n        const newObj: Record<string, unknown> = {};\n        parent[key] = newObj;\n        stack.push({ obj: newObj, indent });\n      }\n    } else {\n      // Simple value\n      parent[key] = parseYamlValue(rawValue);\n    }\n  }\n\n  return result;\n}\n\n/**\n * Parse a YAML value into its appropriate type\n */\nfunction parseYamlValue(value: string): unknown {\n  // Handle quoted strings\n  if ((value.startsWith('\"') && value.endsWith('\"')) || (value.startsWith(\"'\") && value.endsWith(\"'\"))) {\n    return value.slice(1, -1);\n  }\n\n  // Handle booleans\n  if (value === 'true') return true;\n  if (value === 'false') return false;\n\n  // Handle null\n  if (value === 'null' || value === '~') return null;\n\n  // Handle numbers\n  const num = Number(value);\n  if (!isNaN(num) && value !== '') return num;\n\n  // Default to string\n  return value;\n}\n"],"names":["promises","fs","join","DEFAULT_CONFIG_PATHS","DEFAULT_CONFIG","enabled","mode","tools","loadToolFilterConfig","logger","workingDirectory","cwd","process","fileConfig","loadFromConfigFiles","envOverrides","loadEnvironmentOverrides","hasExplicitEnabled","config","length","maxTools","undefined","hasExplicitMode","debug","source","toolCount","envConfig","loadFromEnvironment","info","configPath","fullPath","content","readFile","parsed","parseConfigFile","toolFilter","validateAndNormalize","error","code","warn","path","endsWith","JSON","parse","parseBasicYaml","env","CLAUDE_FLOW_MCP_TOOL_FILTER_ENABLED","modeEnv","CLAUDE_FLOW_MCP_TOOL_FILTER_MODE","toolsEnv","CLAUDE_FLOW_MCP_TOOLS_ALLOWED","split","map","t","trim","filter","maxToolsEnv","CLAUDE_FLOW_MCP_MAX_TOOLS","parseInt","isNaN","enabledEnv","Array","isArray","categories","priorities","result","lines","stack","obj","indent","currentArray","currentArrayKey","currentArrayIndent","line","trimmed","startsWith","search","value","substring","push","parseYamlValue","colonIndex","indexOf","key","rawValue","pop","parent","lineIdx","nextLineIdx","findIndex","l","i","nextLine","arr","newObj","slice","num","Number"],"mappings":"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"}
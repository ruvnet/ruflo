{
  "version": 3,
  "sources": ["../../../src/swarm/optimizations/connection-pool.ts"],
  "sourcesContent": ["/**\n * Connection Pool for Claude API\n * Manages reusable connections to improve performance\n */\n\nimport { EventEmitter } from 'node:events';\nimport { Logger } from '../../core/logger.js';\n// Mock ClaudeAPI for testing when service doesn't exist\nexport class ClaudeAPI {\n  id: string;\n  isHealthy: boolean;\n\n  constructor() {\n    this.id = `mock-api-${Date.now()}`;\n    this.isHealthy = true;\n  }\n\n  async healthCheck(): Promise<boolean> {\n    return this.isHealthy;\n  }\n\n  async complete(options: any): Promise<any> {\n    // Mock response for testing\n    return {\n      content: [{ text: `Mock response for: ${options.messages?.[0]?.content || 'test'}` }],\n      model: options.model || 'claude-3-5-sonnet-20241022',\n      usage: {\n        input_tokens: 10,\n        output_tokens: 20,\n      },\n    };\n  }\n}\n\nexport interface PoolConfig {\n  min: number;\n  max: number;\n  acquireTimeoutMillis: number;\n  idleTimeoutMillis: number;\n  evictionRunIntervalMillis: number;\n  testOnBorrow: boolean;\n}\n\nexport interface PooledConnection {\n  id: string;\n  api: ClaudeAPI;\n  inUse: boolean;\n  createdAt: Date;\n  lastUsedAt: Date;\n  useCount: number;\n}\n\nexport class ClaudeConnectionPool extends EventEmitter {\n  private connections: Map<string, PooledConnection> = new Map();\n  private waitingQueue: Array<{\n    resolve: (conn: PooledConnection) => void;\n    reject: (error: Error) => void;\n    timeout: NodeJS.Timeout;\n  }> = [];\n\n  private config: PoolConfig;\n  private logger: Logger;\n  private evictionTimer?: NodeJS.Timeout;\n  private isShuttingDown = false;\n\n  constructor(config: Partial<PoolConfig> = {}) {\n    super();\n\n    this.config = {\n      min: 2,\n      max: 10,\n      acquireTimeoutMillis: 30000,\n      idleTimeoutMillis: 30000,\n      evictionRunIntervalMillis: 10000,\n      testOnBorrow: true,\n      ...config,\n    };\n\n    this.logger = new Logger(\n      { level: 'info', format: 'json', destination: 'console' },\n      { component: 'ClaudeConnectionPool' },\n    );\n\n    this.initialize();\n  }\n\n  private async initialize(): Promise<void> {\n    // Create minimum connections\n    for (let i = 0; i < this.config.min; i++) {\n      await this.createConnection();\n    }\n\n    // Start eviction timer\n    this.evictionTimer = setInterval(() => {\n      this.evictIdleConnections();\n    }, this.config.evictionRunIntervalMillis);\n\n    this.logger.info('Connection pool initialized', {\n      min: this.config.min,\n      max: this.config.max,\n    });\n  }\n\n  private async createConnection(): Promise<PooledConnection> {\n    const id = `conn-${Date.now()}-${Math.random().toString(36).substring(7)}`;\n    const api = new ClaudeAPI();\n\n    const connection: PooledConnection = {\n      id,\n      api,\n      inUse: false,\n      createdAt: new Date(),\n      lastUsedAt: new Date(),\n      useCount: 0,\n    };\n\n    this.connections.set(id, connection);\n    this.emit('connection:created', connection);\n\n    return connection;\n  }\n\n  async acquire(): Promise<PooledConnection> {\n    if (this.isShuttingDown) {\n      throw new Error('Connection pool is shutting down');\n    }\n\n    // Try to find an available connection\n    for (const conn of this.connections.values()) {\n      if (!conn.inUse) {\n        conn.inUse = true;\n        conn.lastUsedAt = new Date();\n        conn.useCount++;\n\n        // Test connection if configured\n        if (this.config.testOnBorrow) {\n          const isHealthy = await this.testConnection(conn);\n          if (!isHealthy) {\n            await this.destroyConnection(conn);\n            continue;\n          }\n        }\n\n        this.emit('connection:acquired', conn);\n        return conn;\n      }\n    }\n\n    // Create new connection if under limit\n    if (this.connections.size < this.config.max) {\n      const conn = await this.createConnection();\n      conn.inUse = true;\n      conn.useCount++;\n      this.emit('connection:acquired', conn);\n      return conn;\n    }\n\n    // Wait for a connection to become available\n    return new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => {\n        const index = this.waitingQueue.findIndex((item) => item.resolve === resolve);\n        if (index !== -1) {\n          this.waitingQueue.splice(index, 1);\n        }\n        reject(new Error('Connection acquire timeout'));\n      }, this.config.acquireTimeoutMillis);\n\n      this.waitingQueue.push({ resolve, reject, timeout });\n    });\n  }\n\n  async release(connection: PooledConnection): Promise<void> {\n    const conn = this.connections.get(connection.id);\n    if (!conn) {\n      this.logger.warn('Attempted to release unknown connection', { id: connection.id });\n      return;\n    }\n\n    conn.inUse = false;\n    conn.lastUsedAt = new Date();\n\n    this.emit('connection:released', conn);\n\n    // Check if anyone is waiting for a connection\n    if (this.waitingQueue.length > 0) {\n      const waiter = this.waitingQueue.shift();\n      if (waiter) {\n        clearTimeout(waiter.timeout);\n        conn.inUse = true;\n        conn.useCount++;\n        waiter.resolve(conn);\n      }\n    }\n  }\n\n  async execute<T>(fn: (api: ClaudeAPI) => Promise<T>): Promise<T> {\n    const conn = await this.acquire();\n    try {\n      return await fn(conn.api);\n    } finally {\n      await this.release(conn);\n    }\n  }\n\n  private async testConnection(conn: PooledConnection): Promise<boolean> {\n    try {\n      // Simple health check - could be expanded\n      return true;\n    } catch (error) {\n      this.logger.warn('Connection health check failed', {\n        id: conn.id,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n      return false;\n    }\n  }\n\n  private async destroyConnection(conn: PooledConnection): Promise<void> {\n    this.connections.delete(conn.id);\n    this.emit('connection:destroyed', conn);\n\n    // Ensure minimum connections\n    if (this.connections.size < this.config.min && !this.isShuttingDown) {\n      await this.createConnection();\n    }\n  }\n\n  private evictIdleConnections(): void {\n    const now = Date.now();\n    const idleThreshold = now - this.config.idleTimeoutMillis;\n\n    for (const conn of this.connections.values()) {\n      if (\n        !conn.inUse &&\n        conn.lastUsedAt.getTime() < idleThreshold &&\n        this.connections.size > this.config.min\n      ) {\n        this.destroyConnection(conn);\n      }\n    }\n  }\n\n  async drain(): Promise<void> {\n    this.isShuttingDown = true;\n\n    // Clear eviction timer\n    if (this.evictionTimer) {\n      clearInterval(this.evictionTimer);\n      this.evictionTimer = undefined;\n    }\n\n    // Reject all waiting requests\n    for (const waiter of this.waitingQueue) {\n      clearTimeout(waiter.timeout);\n      waiter.reject(new Error('Connection pool is draining'));\n    }\n    this.waitingQueue = [];\n\n    // Wait for all connections to be released\n    const maxWaitTime = 30000; // 30 seconds\n    const startTime = Date.now();\n\n    while (true) {\n      const inUseCount = Array.from(this.connections.values()).filter((conn) => conn.inUse).length;\n\n      if (inUseCount === 0) break;\n\n      if (Date.now() - startTime > maxWaitTime) {\n        this.logger.warn('Timeout waiting for connections to be released', { inUseCount });\n        break;\n      }\n\n      await new Promise((resolve) => setTimeout(resolve, 100));\n    }\n\n    // Destroy all connections\n    for (const conn of this.connections.values()) {\n      await this.destroyConnection(conn);\n    }\n\n    this.logger.info('Connection pool drained');\n  }\n\n  getStats() {\n    const connections = Array.from(this.connections.values());\n    return {\n      total: connections.length,\n      inUse: connections.filter((c) => c.inUse).length,\n      idle: connections.filter((c) => !c.inUse).length,\n      waitingQueue: this.waitingQueue.length,\n      totalUseCount: connections.reduce((sum, c) => sum + c.useCount, 0),\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

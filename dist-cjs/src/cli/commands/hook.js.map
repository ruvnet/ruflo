{"version":3,"sources":["../../../../src/cli/commands/hook.ts"],"sourcesContent":["import { spawn } from 'child_process';\r\nimport { Logger } from '../../core/logger.js';\r\nimport type {\r\n  PreTaskOptions,\r\n  PostTaskOptions,\r\n  PreEditOptions,\r\n  PostEditOptions,\r\n  PreCommandOptions,\r\n  PostCommandOptions,\r\n  SessionStartOptions,\r\n  SessionEndOptions,\r\n  SessionRestoreOptions,\r\n  PreSearchOptions,\r\n  NotificationOptions,\r\n  HookCommandOptions,\r\n  PerformanceOptions,\r\n  MemorySyncOptions,\r\n  TelemetryOptions,\r\n} from './hook-types.js';\r\n\r\nconst logger = new Logger(\r\n  {\r\n    level: 'info',\r\n    format: 'text',\r\n    destination: 'console',\r\n  },\r\n  { prefix: 'Hook' },\r\n);\r\n\r\n// Helper function to build command arguments\r\nfunction buildArgs(hookType: string, options: Record<string, any>): string[] {\r\n  const args = [hookType];\r\n\r\n  Object.entries(options).forEach(([key, value]) => {\r\n    if (value !== undefined && value !== null) {\r\n      const flagName = key.replace(/([A-Z])/g, '-$1').toLowerCase();\r\n\r\n      if (typeof value === 'boolean') {\r\n        if (value) {\r\n          args.push(`--${flagName}`);\r\n        } else {\r\n          args.push(`--no-${flagName}`);\r\n        }\r\n      } else {\r\n        args.push(`--${flagName}`, String(value));\r\n      }\r\n    }\r\n  });\r\n\r\n  return args;\r\n}\r\n\r\n// Hook subcommand handlers\r\nconst hookHandlers: Record<string, (args: string[]) => Promise<void>> = {\r\n  'pre-task': async (args: string[]) => {\r\n    const options = parseArgs<PreTaskOptions>(args);\r\n    await executeHook('pre-task', options);\r\n  },\r\n\r\n  'post-task': async (args: string[]) => {\r\n    const options = parseArgs<PostTaskOptions>(args);\r\n    if (!options.taskId) {\r\n      throw new Error('--task-id is required for post-task hook');\r\n    }\r\n    await executeHook('post-task', options);\r\n  },\r\n\r\n  'pre-edit': async (args: string[]) => {\r\n    const options = parseArgs<PreEditOptions>(args);\r\n    if (!options.file) {\r\n      throw new Error('--file is required for pre-edit hook');\r\n    }\r\n    await executeHook('pre-edit', options);\r\n  },\r\n\r\n  'post-edit': async (args: string[]) => {\r\n    const options = parseArgs<PostEditOptions>(args);\r\n    if (!options.file) {\r\n      throw new Error('--file is required for post-edit hook');\r\n    }\r\n    await executeHook('post-edit', options);\r\n  },\r\n\r\n  'pre-command': async (args: string[]) => {\r\n    const options = parseArgs<PreCommandOptions>(args);\r\n    if (!options.command) {\r\n      throw new Error('--command is required for pre-command hook');\r\n    }\r\n    await executeHook('pre-command', options);\r\n  },\r\n\r\n  'post-command': async (args: string[]) => {\r\n    const options = parseArgs<PostCommandOptions>(args);\r\n    if (!options.command) {\r\n      throw new Error('--command is required for post-command hook');\r\n    }\r\n    await executeHook('post-command', options);\r\n  },\r\n\r\n  'session-start': async (args: string[]) => {\r\n    const options = parseArgs<SessionStartOptions>(args);\r\n    await executeHook('session-start', options);\r\n  },\r\n\r\n  'session-end': async (args: string[]) => {\r\n    const options = parseArgs<SessionEndOptions>(args);\r\n    await executeHook('session-end', options);\r\n  },\r\n\r\n  'session-restore': async (args: string[]) => {\r\n    const options = parseArgs<SessionRestoreOptions>(args);\r\n    if (!options.sessionId) {\r\n      throw new Error('--session-id is required for session-restore hook');\r\n    }\r\n    await executeHook('session-restore', options);\r\n  },\r\n\r\n  'pre-search': async (args: string[]) => {\r\n    const options = parseArgs<PreSearchOptions>(args);\r\n    if (!options.query) {\r\n      throw new Error('--query is required for pre-search hook');\r\n    }\r\n    await executeHook('pre-search', options);\r\n  },\r\n\r\n  notification: async (args: string[]) => {\r\n    const options = parseArgs<NotificationOptions>(args);\r\n    if (!options.message) {\r\n      throw new Error('--message is required for notification hook');\r\n    }\r\n    await executeHook('notification', options);\r\n  },\r\n\r\n  performance: async (args: string[]) => {\r\n    const options = parseArgs<PerformanceOptions>(args);\r\n    await executeHook('performance', options);\r\n  },\r\n\r\n  'memory-sync': async (args: string[]) => {\r\n    const options = parseArgs<MemorySyncOptions>(args);\r\n    await executeHook('memory-sync', options);\r\n  },\r\n\r\n  telemetry: async (args: string[]) => {\r\n    const options = parseArgs<TelemetryOptions>(args);\r\n    if (!options.event) {\r\n      throw new Error('--event is required for telemetry hook');\r\n    }\r\n    await executeHook('telemetry', options);\r\n  },\r\n};\r\n\r\n// Parse command line arguments\r\nfunction parseArgs<T extends Record<string, any>>(args: string[]): T {\r\n  const options: Record<string, any> = {};\r\n\r\n  for (let i = 0; i < args.length; i++) {\r\n    const arg = args[i];\r\n\r\n    if (arg.startsWith('--')) {\r\n      const key = arg.slice(2).replace(/-([a-z])/g, (_, letter) => letter.toUpperCase());\r\n      const nextArg = args[i + 1];\r\n\r\n      if (!nextArg || nextArg.startsWith('--')) {\r\n        // Boolean flag\r\n        options[key] = !arg.startsWith('--no-');\r\n      } else {\r\n        // Value flag\r\n        options[key] = nextArg;\r\n        i++; // Skip next arg\r\n      }\r\n    }\r\n  }\r\n\r\n  return options as T;\r\n}\r\n\r\n// Execute hook with ruv-swarm\r\nasync function executeHook(hookType: string, options: Record<string, any>): Promise<void> {\r\n  const args = buildArgs(hookType, options);\r\n\r\n  logger.debug(`Executing hook: ruv-swarm hook ${args.join(' ')}`);\r\n\r\n  const child = spawn('npx', ['ruv-swarm', 'hook', ...args], {\r\n    stdio: 'inherit',\r\n    shell: true,\r\n  });\r\n\r\n  await new Promise<void>((resolve, reject) => {\r\n    child.on('exit', (code) => {\r\n      if (code === 0) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error(`Hook ${hookType} failed with exit code ${code}`));\r\n      }\r\n    });\r\n\r\n    child.on('error', (error) => {\r\n      logger.error(`Failed to execute hook ${hookType}:`, error);\r\n      reject(error);\r\n    });\r\n  });\r\n}\r\n\r\n// Main hook command handler\r\nexport const hookCommand = {\r\n  name: 'hook',\r\n  description: 'Execute ruv-swarm hooks for agent coordination',\r\n  action: async ({ args }: HookCommandOptions): Promise<void> => {\r\n    try {\r\n      if (args.length === 0) {\r\n        showHookHelp();\r\n        return;\r\n      }\r\n\r\n      const subcommand = args[0];\r\n      const handler = hookHandlers[subcommand];\r\n\r\n      if (!handler) {\r\n        logger.error(`Unknown hook subcommand: ${subcommand}`);\r\n        showHookHelp();\r\n        throw new Error(`Unknown hook subcommand: ${subcommand}`);\r\n      }\r\n\r\n      await handler(args.slice(1));\r\n    } catch (error) {\r\n      logger.error('Hook command error:', error);\r\n      throw error;\r\n    }\r\n  },\r\n};\r\n\r\n// Show help for hook commands\r\nfunction showHookHelp(): void {\r\n  console.log(`\r\nClaude Flow Hook Commands\r\n========================\r\n\r\nAvailable hooks:\r\n\r\n  pre-task      - Run before starting a task\r\n    --description <desc>      Task description\r\n    --auto-spawn-agents       Auto-spawn agents (default: true)\r\n    --complexity <level>      Task complexity: low|medium|high\r\n    --estimated-minutes <n>   Estimated duration\r\n    --requires-research       Task requires research\r\n    --requires-testing        Task requires testing\r\n\r\n  post-task     - Run after completing a task\r\n    --task-id <id>           Task ID (required)\r\n    --analyze-performance    Analyze performance metrics\r\n    --generate-report        Generate completion report\r\n\r\n  pre-edit      - Run before editing a file\r\n    --file <path>            File path (required)\r\n    --operation <op>         Operation type: read|write|edit|delete\r\n    --validate               Validate file before edit\r\n\r\n  post-edit     - Run after editing a file\r\n    --file <path>            File path (required)\r\n    --memory-key <key>       Store in memory with key\r\n    --format                 Auto-format code\r\n    --analyze                Analyze changes\r\n\r\n  pre-command   - Run before executing a command\r\n    --command <cmd>          Command to execute (required)\r\n    --validate               Validate command safety\r\n    --sandbox                Run in sandbox mode\r\n\r\n  post-command  - Run after executing a command\r\n    --command <cmd>          Command executed (required)\r\n    --exit-code <code>       Command exit code\r\n    --duration <ms>          Execution duration\r\n\r\n  session-start - Run at session start\r\n    --session-id <id>        Session identifier\r\n    --load-previous          Load previous session data\r\n    --auto-restore           Auto-restore context\r\n\r\n  session-end   - Run at session end\r\n    --session-id <id>        Session identifier\r\n    --export-metrics         Export performance metrics\r\n    --generate-summary       Generate session summary\r\n    --save-to <path>         Save session data to path\r\n\r\n  session-restore - Restore a previous session\r\n    --session-id <id>        Session ID to restore (required)\r\n    --load-memory            Load memory state\r\n    --load-agents            Load agent configuration\r\n    --load-tasks             Load task list\r\n\r\n  pre-search    - Run before searching\r\n    --query <text>           Search query (required)\r\n    --cache-results          Cache search results\r\n    --max-results <n>        Maximum results to return\r\n\r\n  notification  - Send a notification\r\n    --message <text>         Notification message (required)\r\n    --level <level>          Message level: info|warning|error\r\n    --telemetry              Include in telemetry\r\n    --persist                Persist notification\r\n\r\n  performance   - Track performance metrics\r\n    --operation <name>       Operation name\r\n    --duration <ms>          Operation duration\r\n    --metrics <json>         Performance metrics as JSON\r\n\r\n  memory-sync   - Synchronize memory state\r\n    --namespace <name>       Memory namespace\r\n    --direction <dir>        Sync direction: push|pull|sync\r\n    --target <location>      Target location for sync\r\n\r\n  telemetry     - Send telemetry data\r\n    --event <name>           Event name (required)\r\n    --data <json>            Event data as JSON\r\n    --tags <list>            Comma-separated tags\r\n\r\nCommon options:\r\n  --verbose                  Show detailed output\r\n  --metadata <json>          Additional metadata as JSON\r\n\r\nExamples:\r\n  claude hook pre-task --description \"Build REST API\" --complexity high\r\n  claude hook post-edit --file src/index.js --memory-key \"api/implementation\"\r\n  claude hook session-end --export-metrics --generate-summary\r\n  claude hook performance --operation \"api-build\" --duration 1234\r\n  claude hook memory-sync --namespace \"project\" --direction push\r\n  claude hook telemetry --event \"task-completed\" --data '{\"taskId\":\"123\"}'\r\n`);\r\n}\r\n\r\n// Export hook subcommands for better CLI integration\r\nexport const hookSubcommands = [\r\n  'pre-task',\r\n  'post-task',\r\n  'pre-edit',\r\n  'post-edit',\r\n  'pre-command',\r\n  'post-command',\r\n  'session-start',\r\n  'session-end',\r\n  'session-restore',\r\n  'pre-search',\r\n  'notification',\r\n  'performance',\r\n  'memory-sync',\r\n  'telemetry',\r\n];\r\n"],"names":["spawn","Logger","logger","level","format","destination","prefix","buildArgs","hookType","options","args","Object","entries","forEach","key","value","undefined","flagName","replace","toLowerCase","push","String","hookHandlers","parseArgs","executeHook","taskId","Error","file","command","sessionId","query","notification","message","performance","telemetry","event","i","length","arg","startsWith","slice","_","letter","toUpperCase","nextArg","debug","join","child","stdio","shell","Promise","resolve","reject","on","code","error","hookCommand","name","description","action","showHookHelp","subcommand","handler","console","log","hookSubcommands"],"mappings":"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"}
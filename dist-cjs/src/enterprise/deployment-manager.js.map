{"version":3,"sources":["../../../src/enterprise/deployment-manager.ts"],"sourcesContent":["import { EventEmitter } from 'events';\r\nimport { writeFile, readFile, mkdir, readdir } from 'fs/promises';\r\nimport { join } from 'path';\r\nimport { spawn, ChildProcess } from 'child_process';\r\nimport { Logger } from '../core/logger.js';\r\nimport { ConfigManager } from '../core/config.js';\r\n\r\nexport interface DeploymentEnvironment {\r\n  id: string;\r\n  name: string;\r\n  type: 'development' | 'staging' | 'production' | 'testing' | 'custom';\r\n  status: 'active' | 'inactive' | 'maintenance' | 'error';\r\n  configuration: {\r\n    region: string;\r\n    provider: 'aws' | 'gcp' | 'azure' | 'kubernetes' | 'docker' | 'custom';\r\n    endpoints: string[];\r\n    secrets: Record<string, string>;\r\n    environment_variables: Record<string, string>;\r\n    resources: {\r\n      cpu: string;\r\n      memory: string;\r\n      storage: string;\r\n      replicas: number;\r\n    };\r\n  };\r\n  healthCheck: {\r\n    url: string;\r\n    method: 'GET' | 'POST' | 'HEAD';\r\n    expectedStatus: number;\r\n    timeout: number;\r\n    interval: number;\r\n    retries: number;\r\n  };\r\n  monitoring: {\r\n    enabled: boolean;\r\n    alerts: DeploymentAlert[];\r\n    metrics: string[];\r\n    logs: {\r\n      level: string;\r\n      retention: string;\r\n      aggregation: boolean;\r\n    };\r\n  };\r\n  security: {\r\n    tls: boolean;\r\n    authentication: boolean;\r\n    authorization: string[];\r\n    compliance: string[];\r\n    scanning: {\r\n      vulnerabilities: boolean;\r\n      secrets: boolean;\r\n      licenses: boolean;\r\n    };\r\n  };\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DeploymentStrategy {\r\n  id: string;\r\n  name: string;\r\n  type: 'blue-green' | 'canary' | 'rolling' | 'recreate' | 'custom';\r\n  configuration: {\r\n    rolloutPercentage?: number;\r\n    maxUnavailable?: number;\r\n    maxSurge?: number;\r\n    trafficSplitPercentage?: number;\r\n    monitoringDuration?: number;\r\n    rollbackThreshold?: number;\r\n    approvalRequired?: boolean;\r\n    automatedRollback?: boolean;\r\n  };\r\n  stages: DeploymentStage[];\r\n  rollbackStrategy: {\r\n    automatic: boolean;\r\n    conditions: RollbackCondition[];\r\n    timeout: number;\r\n  };\r\n  notifications: {\r\n    channels: string[];\r\n    events: string[];\r\n  };\r\n}\r\n\r\nexport interface DeploymentStage {\r\n  id: string;\r\n  name: string;\r\n  order: number;\r\n  type: 'build' | 'test' | 'deploy' | 'verify' | 'promote' | 'rollback' | 'custom';\r\n  status: 'pending' | 'running' | 'success' | 'failed' | 'skipped' | 'cancelled';\r\n  commands: DeploymentCommand[];\r\n  conditions: {\r\n    runIf: string[];\r\n    skipIf: string[];\r\n  };\r\n  timeout: number;\r\n  retryPolicy: {\r\n    maxRetries: number;\r\n    backoffMultiplier: number;\r\n    initialDelay: number;\r\n  };\r\n  artifacts: {\r\n    inputs: string[];\r\n    outputs: string[];\r\n  };\r\n  startTime?: Date;\r\n  endTime?: Date;\r\n  duration?: number;\r\n  logs: DeploymentLog[];\r\n}\r\n\r\nexport interface DeploymentCommand {\r\n  id: string;\r\n  command: string;\r\n  args: string[];\r\n  workingDirectory?: string;\r\n  environment?: Record<string, string>;\r\n  timeout: number;\r\n  retryOnFailure: boolean;\r\n  successCriteria: {\r\n    exitCode?: number;\r\n    outputContains?: string[];\r\n    outputNotContains?: string[];\r\n  };\r\n}\r\n\r\nexport interface DeploymentLog {\r\n  timestamp: Date;\r\n  level: 'debug' | 'info' | 'warn' | 'error';\r\n  message: string;\r\n  source: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface RollbackCondition {\r\n  metric: string;\r\n  threshold: number;\r\n  operator: '>' | '<' | '>=' | '<=' | '==' | '!=';\r\n  duration: number;\r\n  description: string;\r\n}\r\n\r\nexport interface DeploymentAlert {\r\n  id: string;\r\n  name: string;\r\n  condition: string;\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  channels: string[];\r\n  enabled: boolean;\r\n}\r\n\r\nexport interface Deployment {\r\n  id: string;\r\n  name: string;\r\n  version: string;\r\n  projectId: string;\r\n  environmentId: string;\r\n  strategyId: string;\r\n  status: 'pending' | 'running' | 'success' | 'failed' | 'rolled-back' | 'cancelled';\r\n  initiatedBy: string;\r\n  source: {\r\n    repository: string;\r\n    branch: string;\r\n    commit: string;\r\n    tag?: string;\r\n  };\r\n  artifacts: {\r\n    buildId?: string;\r\n    imageTag?: string;\r\n    packageVersion?: string;\r\n    files: string[];\r\n  };\r\n  metrics: {\r\n    startTime: Date;\r\n    endTime?: Date;\r\n    duration?: number;\r\n    deploymentSize: number;\r\n    rollbackTime?: number;\r\n    successRate: number;\r\n    errorRate: number;\r\n    performanceMetrics: Record<string, number>;\r\n  };\r\n  stages: DeploymentStage[];\r\n  rollback?: {\r\n    triggered: boolean;\r\n    reason: string;\r\n    timestamp: Date;\r\n    previousDeploymentId: string;\r\n    rollbackDuration: number;\r\n  };\r\n  approvals: DeploymentApproval[];\r\n  notifications: DeploymentNotification[];\r\n  auditLog: DeploymentAuditEntry[];\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DeploymentApproval {\r\n  id: string;\r\n  stage: string;\r\n  requiredApprovers: string[];\r\n  approvals: {\r\n    userId: string;\r\n    decision: 'approved' | 'rejected';\r\n    reason?: string;\r\n    timestamp: Date;\r\n  }[];\r\n  status: 'pending' | 'approved' | 'rejected' | 'expired';\r\n  expiresAt: Date;\r\n}\r\n\r\nexport interface DeploymentNotification {\r\n  id: string;\r\n  type: 'email' | 'slack' | 'teams' | 'webhook' | 'sms';\r\n  recipients: string[];\r\n  subject: string;\r\n  message: string;\r\n  timestamp: Date;\r\n  status: 'sent' | 'failed' | 'pending';\r\n}\r\n\r\nexport interface DeploymentAuditEntry {\r\n  id: string;\r\n  timestamp: Date;\r\n  userId: string;\r\n  action: string;\r\n  target: string;\r\n  details: Record<string, any>;\r\n  ipAddress?: string;\r\n}\r\n\r\nexport interface DeploymentPipeline {\r\n  id: string;\r\n  name: string;\r\n  projectId: string;\r\n  environments: string[];\r\n  promotionStrategy: 'manual' | 'automatic' | 'conditional';\r\n  promotionRules: {\r\n    environmentId: string;\r\n    conditions: string[];\r\n    approvers: string[];\r\n  }[];\r\n  triggers: {\r\n    type: 'webhook' | 'schedule' | 'manual' | 'git';\r\n    configuration: Record<string, any>;\r\n  }[];\r\n  configuration: {\r\n    parallelDeployments: boolean;\r\n    rollbackOnFailure: boolean;\r\n    notifications: boolean;\r\n    qualityGates: boolean;\r\n  };\r\n  metrics: {\r\n    totalDeployments: number;\r\n    successRate: number;\r\n    averageDeploymentTime: number;\r\n    mttr: number; // Mean Time To Recovery\r\n    changeFailureRate: number;\r\n    deploymentFrequency: number;\r\n  };\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DeploymentMetrics {\r\n  totalDeployments: number;\r\n  successfulDeployments: number;\r\n  failedDeployments: number;\r\n  rolledBackDeployments: number;\r\n  averageDeploymentTime: number;\r\n  deploymentFrequency: number;\r\n  meanTimeToRecovery: number;\r\n  changeFailureRate: number;\r\n  leadTime: number;\r\n  environmentMetrics: Record<\r\n    string,\r\n    {\r\n      deployments: number;\r\n      successRate: number;\r\n      averageTime: number;\r\n    }\r\n  >;\r\n  strategyMetrics: Record<\r\n    string,\r\n    {\r\n      deployments: number;\r\n      successRate: number;\r\n      rollbackRate: number;\r\n    }\r\n  >;\r\n}\r\n\r\nexport class DeploymentManager extends EventEmitter {\r\n  private deployments: Map<string, Deployment> = new Map();\r\n  private environments: Map<string, DeploymentEnvironment> = new Map();\r\n  private strategies: Map<string, DeploymentStrategy> = new Map();\r\n  private pipelines: Map<string, DeploymentPipeline> = new Map();\r\n  private activeProcesses: Map<string, ChildProcess> = new Map();\r\n  private deploymentsPath: string;\r\n  private logger: Logger;\r\n  private config: ConfigManager;\r\n\r\n  constructor(deploymentsPath: string = './deployments', logger?: Logger, config?: ConfigManager) {\r\n    super();\r\n    this.deploymentsPath = deploymentsPath;\r\n    this.logger = logger || new Logger({ level: 'info', format: 'text', destination: 'console' });\r\n    this.config = config || ConfigManager.getInstance();\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    try {\r\n      await mkdir(this.deploymentsPath, { recursive: true });\r\n      await mkdir(join(this.deploymentsPath, 'environments'), { recursive: true });\r\n      await mkdir(join(this.deploymentsPath, 'strategies'), { recursive: true });\r\n      await mkdir(join(this.deploymentsPath, 'pipelines'), { recursive: true });\r\n\r\n      await this.loadConfigurations();\r\n      await this.initializeDefaultStrategies();\r\n\r\n      this.logger.info('Deployment Manager initialized successfully');\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize Deployment Manager', { error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createEnvironment(\r\n    environmentData: Partial<DeploymentEnvironment>,\r\n  ): Promise<DeploymentEnvironment> {\r\n    const environment: DeploymentEnvironment = {\r\n      id: environmentData.id || `env-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: environmentData.name || 'Unnamed Environment',\r\n      type: environmentData.type || 'development',\r\n      status: 'inactive',\r\n      configuration: {\r\n        region: 'us-east-1',\r\n        provider: 'aws',\r\n        endpoints: [],\r\n        secrets: {},\r\n        environment_variables: {},\r\n        resources: {\r\n          cpu: '1',\r\n          memory: '1Gi',\r\n          storage: '10Gi',\r\n          replicas: 1,\r\n        },\r\n        ...environmentData.configuration,\r\n      },\r\n      healthCheck: {\r\n        url: '/health',\r\n        method: 'GET',\r\n        expectedStatus: 200,\r\n        timeout: 30000,\r\n        interval: 60000,\r\n        retries: 3,\r\n        ...environmentData.healthCheck,\r\n      },\r\n      monitoring: {\r\n        enabled: true,\r\n        alerts: [],\r\n        metrics: ['cpu', 'memory', 'requests', 'errors'],\r\n        logs: {\r\n          level: 'info',\r\n          retention: '30d',\r\n          aggregation: true,\r\n        },\r\n        ...environmentData.monitoring,\r\n      },\r\n      security: {\r\n        tls: true,\r\n        authentication: true,\r\n        authorization: ['admin', 'deploy'],\r\n        compliance: [],\r\n        scanning: {\r\n          vulnerabilities: true,\r\n          secrets: true,\r\n          licenses: true,\r\n        },\r\n        ...environmentData.security,\r\n      },\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    this.environments.set(environment.id, environment);\r\n    await this.saveEnvironment(environment);\r\n\r\n    this.emit('environment:created', environment);\r\n    this.logger.info(`Environment created: ${environment.name} (${environment.id})`);\r\n\r\n    return environment;\r\n  }\r\n\r\n  async createDeployment(deploymentData: {\r\n    name: string;\r\n    version: string;\r\n    projectId: string;\r\n    environmentId: string;\r\n    strategyId: string;\r\n    initiatedBy: string;\r\n    source: Deployment['source'];\r\n    artifacts?: Partial<Deployment['artifacts']>;\r\n  }): Promise<Deployment> {\r\n    const environment = this.environments.get(deploymentData.environmentId);\r\n    if (!environment) {\r\n      throw new Error(`Environment not found: ${deploymentData.environmentId}`);\r\n    }\r\n\r\n    const strategy = this.strategies.get(deploymentData.strategyId);\r\n    if (!strategy) {\r\n      throw new Error(`Strategy not found: ${deploymentData.strategyId}`);\r\n    }\r\n\r\n    const deployment: Deployment = {\r\n      id: `deploy-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: deploymentData.name,\r\n      version: deploymentData.version,\r\n      projectId: deploymentData.projectId,\r\n      environmentId: deploymentData.environmentId,\r\n      strategyId: deploymentData.strategyId,\r\n      status: 'pending',\r\n      initiatedBy: deploymentData.initiatedBy,\r\n      source: deploymentData.source,\r\n      artifacts: {\r\n        files: [],\r\n        ...deploymentData.artifacts,\r\n      },\r\n      metrics: {\r\n        startTime: new Date(),\r\n        deploymentSize: 0,\r\n        successRate: 0,\r\n        errorRate: 0,\r\n        performanceMetrics: {},\r\n      },\r\n      stages: strategy.stages.map((stage) => ({\r\n        ...stage,\r\n        status: 'pending',\r\n        logs: [],\r\n      })),\r\n      approvals: [],\r\n      notifications: [],\r\n      auditLog: [],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    this.addAuditEntry(deployment, deploymentData.initiatedBy, 'deployment_created', 'deployment', {\r\n      deploymentId: deployment.id,\r\n      environment: environment.name,\r\n      strategy: strategy.name,\r\n    });\r\n\r\n    this.deployments.set(deployment.id, deployment);\r\n    await this.saveDeployment(deployment);\r\n\r\n    this.emit('deployment:created', deployment);\r\n    this.logger.info(`Deployment created: ${deployment.name} (${deployment.id})`);\r\n\r\n    return deployment;\r\n  }\r\n\r\n  async executeDeployment(deploymentId: string): Promise<void> {\r\n    const deployment = this.deployments.get(deploymentId);\r\n    if (!deployment) {\r\n      throw new Error(`Deployment not found: ${deploymentId}`);\r\n    }\r\n\r\n    if (deployment.status !== 'pending') {\r\n      throw new Error(`Deployment ${deploymentId} is not in pending status`);\r\n    }\r\n\r\n    deployment.status = 'running';\r\n    deployment.metrics.startTime = new Date();\r\n    deployment.updatedAt = new Date();\r\n\r\n    this.addAuditEntry(deployment, 'system', 'deployment_started', 'deployment', {\r\n      deploymentId,\r\n    });\r\n\r\n    await this.saveDeployment(deployment);\r\n    this.emit('deployment:started', deployment);\r\n\r\n    try {\r\n      for (const stage of deployment.stages) {\r\n        await this.executeStage(deployment, stage);\r\n\r\n        if (stage.status === 'failed') {\r\n          await this.handleDeploymentFailure(deployment, stage);\r\n          return;\r\n        }\r\n      }\r\n\r\n      await this.completeDeployment(deployment);\r\n    } catch (error) {\r\n      await this.handleDeploymentError(deployment, error);\r\n    }\r\n  }\r\n\r\n  private async executeStage(deployment: Deployment, stage: DeploymentStage): Promise<void> {\r\n    stage.status = 'running';\r\n    stage.startTime = new Date();\r\n\r\n    this.addLog(stage, 'info', `Starting stage: ${stage.name}`, 'system');\r\n\r\n    try {\r\n      // Check conditions\r\n      if (!this.evaluateStageConditions(deployment, stage)) {\r\n        stage.status = 'skipped';\r\n        this.addLog(stage, 'info', 'Stage skipped due to conditions', 'system');\r\n        return;\r\n      }\r\n\r\n      // Handle approvals\r\n      if (stage.type === 'deploy' && (await this.requiresApproval(deployment, stage))) {\r\n        await this.requestApproval(deployment, stage);\r\n\r\n        // Wait for approval\r\n        while (await this.isPendingApproval(deployment, stage)) {\r\n          await new Promise((resolve) => setTimeout(resolve, 10000)); // Check every 10 seconds\r\n        }\r\n\r\n        if (!(await this.isApproved(deployment, stage))) {\r\n          stage.status = 'failed';\r\n          this.addLog(stage, 'error', 'Stage rejected by approver', 'system');\r\n          return;\r\n        }\r\n      }\r\n\r\n      // Execute commands\r\n      for (const command of stage.commands) {\r\n        await this.executeCommand(deployment, stage, command);\r\n      }\r\n\r\n      stage.status = 'success';\r\n      stage.endTime = new Date();\r\n      stage.duration = stage.endTime.getTime() - stage.startTime!.getTime();\r\n\r\n      this.addLog(stage, 'info', `Stage completed successfully in ${stage.duration}ms`, 'system');\r\n    } catch (error) {\r\n      stage.status = 'failed';\r\n      stage.endTime = new Date();\r\n\r\n      this.addLog(\r\n        stage,\r\n        'error',\r\n        `Stage failed: ${error instanceof Error ? error.message : String(error)}`,\r\n        'system',\r\n      );\r\n\r\n      // Retry logic\r\n      if (stage.retryPolicy.maxRetries > 0) {\r\n        await this.retryStage(deployment, stage);\r\n      }\r\n    }\r\n\r\n    await this.saveDeployment(deployment);\r\n    this.emit('stage:completed', { deployment, stage });\r\n  }\r\n\r\n  private async executeCommand(\r\n    deployment: Deployment,\r\n    stage: DeploymentStage,\r\n    command: DeploymentCommand,\r\n  ): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      const environment = this.environments.get(deployment.environmentId);\r\n\r\n      const processEnv = {\r\n        ...process.env,\r\n        ...environment?.configuration.environment_variables,\r\n        ...command.environment,\r\n        DEPLOYMENT_ID: deployment.id,\r\n        DEPLOYMENT_VERSION: deployment.version,\r\n        ENVIRONMENT_ID: deployment.environmentId,\r\n      };\r\n\r\n      this.addLog(\r\n        stage,\r\n        'info',\r\n        `Executing: ${command.command} ${command.args.join(' ')}`,\r\n        'command',\r\n      );\r\n\r\n      const childProcess = spawn(command.command, command.args, {\r\n        cwd: command.workingDirectory || process.cwd(),\r\n        env: processEnv,\r\n        stdio: ['pipe', 'pipe', 'pipe'],\r\n      });\r\n\r\n      this.activeProcesses.set(`${deployment.id}-${stage.id}-${command.id}`, childProcess);\r\n\r\n      let stdout = '';\r\n      let stderr = '';\r\n\r\n      childProcess.stdout?.on('data', (data) => {\r\n        const output = data.toString();\r\n        stdout += output;\r\n        this.addLog(stage, 'info', output.trim(), 'stdout');\r\n      });\r\n\r\n      childProcess.stderr?.on('data', (data) => {\r\n        const output = data.toString();\r\n        stderr += output;\r\n        this.addLog(stage, 'error', output.trim(), 'stderr');\r\n      });\r\n\r\n      const timeout = setTimeout(() => {\r\n        childProcess.kill('SIGTERM');\r\n        reject(new Error(`Command timed out after ${command.timeout}ms`));\r\n      }, command.timeout);\r\n\r\n      childProcess.on('close', (code) => {\r\n        clearTimeout(timeout);\r\n        this.activeProcesses.delete(`${deployment.id}-${stage.id}-${command.id}`);\r\n\r\n        // Check success criteria\r\n        const success = this.evaluateCommandSuccess(command, code, stdout, stderr);\r\n\r\n        if (success) {\r\n          this.addLog(\r\n            stage,\r\n            'info',\r\n            `Command completed successfully (exit code: ${code})`,\r\n            'command',\r\n          );\r\n          resolve();\r\n        } else {\r\n          this.addLog(stage, 'error', `Command failed (exit code: ${code})`, 'command');\r\n          reject(new Error(`Command failed with exit code ${code}`));\r\n        }\r\n      });\r\n\r\n      childProcess.on('error', (error) => {\r\n        clearTimeout(timeout);\r\n        this.activeProcesses.delete(`${deployment.id}-${stage.id}-${command.id}`);\r\n        this.addLog(\r\n          stage,\r\n          'error',\r\n          `Command error: ${error instanceof Error ? error.message : String(error)}`,\r\n          'command',\r\n        );\r\n        reject(error);\r\n      });\r\n    });\r\n  }\r\n\r\n  async rollbackDeployment(\r\n    deploymentId: string,\r\n    reason: string,\r\n    userId: string = 'system',\r\n  ): Promise<void> {\r\n    const deployment = this.deployments.get(deploymentId);\r\n    if (!deployment) {\r\n      throw new Error(`Deployment not found: ${deploymentId}`);\r\n    }\r\n\r\n    // Find previous successful deployment\r\n    const previousDeployment = await this.getPreviousSuccessfulDeployment(\r\n      deployment.projectId,\r\n      deployment.environmentId,\r\n      deploymentId,\r\n    );\r\n\r\n    if (!previousDeployment) {\r\n      throw new Error('No previous successful deployment found for rollback');\r\n    }\r\n\r\n    const rollbackStartTime = new Date();\r\n\r\n    deployment.rollback = {\r\n      triggered: true,\r\n      reason,\r\n      timestamp: rollbackStartTime,\r\n      previousDeploymentId: previousDeployment.id,\r\n      rollbackDuration: 0,\r\n    };\r\n\r\n    deployment.status = 'rolled-back';\r\n    deployment.updatedAt = new Date();\r\n\r\n    this.addAuditEntry(deployment, userId, 'rollback_initiated', 'deployment', {\r\n      deploymentId,\r\n      previousDeploymentId: previousDeployment.id,\r\n      reason,\r\n    });\r\n\r\n    try {\r\n      // Execute rollback strategy\r\n      await this.executeRollbackStrategy(deployment, previousDeployment);\r\n\r\n      deployment.rollback.rollbackDuration = Date.now() - rollbackStartTime.getTime();\r\n\r\n      this.addAuditEntry(deployment, userId, 'rollback_completed', 'deployment', {\r\n        deploymentId,\r\n        rollbackDuration: deployment.rollback.rollbackDuration,\r\n      });\r\n\r\n      this.emit('deployment:rolled-back', deployment);\r\n      this.logger.info(`Deployment rolled back: ${deploymentId}`);\r\n    } catch (error) {\r\n      this.addAuditEntry(deployment, userId, 'rollback_failed', 'deployment', {\r\n        deploymentId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n\r\n      this.logger.error(`Rollback failed for deployment ${deploymentId}`, { error });\r\n      throw error;\r\n    }\r\n\r\n    await this.saveDeployment(deployment);\r\n  }\r\n\r\n  async getDeploymentMetrics(filters?: {\r\n    projectId?: string;\r\n    environmentId?: string;\r\n    strategyId?: string;\r\n    timeRange?: { start: Date; end: Date };\r\n  }): Promise<DeploymentMetrics> {\r\n    let deployments = Array.from(this.deployments.values());\r\n\r\n    // Apply filters\r\n    if (filters) {\r\n      if (filters.projectId) {\r\n        deployments = deployments.filter((d) => d.projectId === filters.projectId);\r\n      }\r\n      if (filters.environmentId) {\r\n        deployments = deployments.filter((d) => d.environmentId === filters.environmentId);\r\n      }\r\n      if (filters.strategyId) {\r\n        deployments = deployments.filter((d) => d.strategyId === filters.strategyId);\r\n      }\r\n      if (filters.timeRange) {\r\n        deployments = deployments.filter(\r\n          (d) => d.createdAt >= filters.timeRange!.start && d.createdAt <= filters.timeRange!.end,\r\n        );\r\n      }\r\n    }\r\n\r\n    const totalDeployments = deployments.length;\r\n    const successfulDeployments = deployments.filter((d) => d.status === 'success').length;\r\n    const failedDeployments = deployments.filter((d) => d.status === 'failed').length;\r\n    const rolledBackDeployments = deployments.filter((d) => d.status === 'rolled-back').length;\r\n\r\n    const completedDeployments = deployments.filter(\r\n      (d) => d.metrics.endTime && d.metrics.startTime,\r\n    );\r\n\r\n    const averageDeploymentTime =\r\n      completedDeployments.length > 0\r\n        ? completedDeployments.reduce(\r\n            (sum, d) => sum + (d.metrics.endTime!.getTime() - d.metrics.startTime.getTime()),\r\n            0,\r\n          ) / completedDeployments.length\r\n        : 0;\r\n\r\n    // Calculate environment metrics\r\n    const environmentMetrics: Record<string, any> = {};\r\n    for (const env of this.environments.values()) {\r\n      const envDeployments = deployments.filter((d) => d.environmentId === env.id);\r\n      const envSuccessful = envDeployments.filter((d) => d.status === 'success').length;\r\n\r\n      environmentMetrics[env.id] = {\r\n        deployments: envDeployments.length,\r\n        successRate: envDeployments.length > 0 ? (envSuccessful / envDeployments.length) * 100 : 0,\r\n        averageTime:\r\n          envDeployments.length > 0\r\n            ? envDeployments.reduce((sum, d) => sum + (d.metrics.duration || 0), 0) /\r\n              envDeployments.length\r\n            : 0,\r\n      };\r\n    }\r\n\r\n    // Calculate strategy metrics\r\n    const strategyMetrics: Record<string, any> = {};\r\n    for (const strategy of this.strategies.values()) {\r\n      const strategyDeployments = deployments.filter((d) => d.strategyId === strategy.id);\r\n      const strategySuccessful = strategyDeployments.filter((d) => d.status === 'success').length;\r\n      const strategyRolledBack = strategyDeployments.filter(\r\n        (d) => d.status === 'rolled-back',\r\n      ).length;\r\n\r\n      strategyMetrics[strategy.id] = {\r\n        deployments: strategyDeployments.length,\r\n        successRate:\r\n          strategyDeployments.length > 0\r\n            ? (strategySuccessful / strategyDeployments.length) * 100\r\n            : 0,\r\n        rollbackRate:\r\n          strategyDeployments.length > 0\r\n            ? (strategyRolledBack / strategyDeployments.length) * 100\r\n            : 0,\r\n      };\r\n    }\r\n\r\n    return {\r\n      totalDeployments,\r\n      successfulDeployments,\r\n      failedDeployments,\r\n      rolledBackDeployments,\r\n      averageDeploymentTime,\r\n      deploymentFrequency: this.calculateDeploymentFrequency(deployments),\r\n      meanTimeToRecovery: this.calculateMTTR(deployments),\r\n      changeFailureRate:\r\n        ((failedDeployments + rolledBackDeployments) / Math.max(totalDeployments, 1)) * 100,\r\n      leadTime: this.calculateLeadTime(deployments),\r\n      environmentMetrics,\r\n      strategyMetrics,\r\n    };\r\n  }\r\n\r\n  // Private helper methods\r\n  private async loadConfigurations(): Promise<void> {\r\n    // Load environments, strategies, and pipelines from disk\r\n    try {\r\n      const envFiles = await readdir(join(this.deploymentsPath, 'environments'));\r\n      for (const file of envFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.deploymentsPath, 'environments', file), 'utf-8');\r\n        const env: DeploymentEnvironment = JSON.parse(content);\r\n        this.environments.set(env.id, env);\r\n      }\r\n\r\n      const strategyFiles = await readdir(join(this.deploymentsPath, 'strategies'));\r\n      for (const file of strategyFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.deploymentsPath, 'strategies', file), 'utf-8');\r\n        const strategy: DeploymentStrategy = JSON.parse(content);\r\n        this.strategies.set(strategy.id, strategy);\r\n      }\r\n\r\n      const pipelineFiles = await readdir(join(this.deploymentsPath, 'pipelines'));\r\n      for (const file of pipelineFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.deploymentsPath, 'pipelines', file), 'utf-8');\r\n        const pipeline: DeploymentPipeline = JSON.parse(content);\r\n        this.pipelines.set(pipeline.id, pipeline);\r\n      }\r\n\r\n      this.logger.info(\r\n        `Loaded ${this.environments.size} environments, ${this.strategies.size} strategies, ${this.pipelines.size} pipelines`,\r\n      );\r\n    } catch (error) {\r\n      this.logger.warn('Failed to load some configurations', { error });\r\n    }\r\n  }\r\n\r\n  private async initializeDefaultStrategies(): Promise<void> {\r\n    const defaultStrategies: Partial<DeploymentStrategy>[] = [\r\n      {\r\n        name: 'Blue-Green Deployment',\r\n        type: 'blue-green',\r\n        configuration: {\r\n          monitoringDuration: 300000, // 5 minutes\r\n          automatedRollback: true,\r\n          rollbackThreshold: 5,\r\n        },\r\n        stages: [\r\n          {\r\n            id: 'build',\r\n            name: 'Build',\r\n            order: 1,\r\n            type: 'build',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 600000,\r\n            retryPolicy: { maxRetries: 2, backoffMultiplier: 2, initialDelay: 1000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'deploy-green',\r\n            name: 'Deploy to Green',\r\n            order: 2,\r\n            type: 'deploy',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 900000,\r\n            retryPolicy: { maxRetries: 1, backoffMultiplier: 2, initialDelay: 5000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'verify',\r\n            name: 'Verify Green',\r\n            order: 3,\r\n            type: 'verify',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 300000,\r\n            retryPolicy: { maxRetries: 3, backoffMultiplier: 1.5, initialDelay: 2000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'switch-traffic',\r\n            name: 'Switch Traffic',\r\n            order: 4,\r\n            type: 'promote',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 60000,\r\n            retryPolicy: { maxRetries: 1, backoffMultiplier: 1, initialDelay: 1000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n        ],\r\n        rollbackStrategy: {\r\n          automatic: true,\r\n          conditions: [\r\n            {\r\n              metric: 'error_rate',\r\n              threshold: 5,\r\n              operator: '>',\r\n              duration: 60000,\r\n              description: 'Error rate exceeds 5%',\r\n            },\r\n          ],\r\n          timeout: 300000,\r\n        },\r\n      },\r\n      {\r\n        name: 'Canary Deployment',\r\n        type: 'canary',\r\n        configuration: {\r\n          trafficSplitPercentage: 10,\r\n          monitoringDuration: 600000, // 10 minutes\r\n          automatedRollback: true,\r\n          rollbackThreshold: 2,\r\n        },\r\n        stages: [\r\n          {\r\n            id: 'build',\r\n            name: 'Build',\r\n            order: 1,\r\n            type: 'build',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 600000,\r\n            retryPolicy: { maxRetries: 2, backoffMultiplier: 2, initialDelay: 1000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'deploy-canary',\r\n            name: 'Deploy Canary (10%)',\r\n            order: 2,\r\n            type: 'deploy',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 900000,\r\n            retryPolicy: { maxRetries: 1, backoffMultiplier: 2, initialDelay: 5000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'monitor-canary',\r\n            name: 'Monitor Canary',\r\n            order: 3,\r\n            type: 'verify',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 600000,\r\n            retryPolicy: { maxRetries: 1, backoffMultiplier: 1, initialDelay: 10000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'promote-full',\r\n            name: 'Promote to 100%',\r\n            order: 4,\r\n            type: 'promote',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 300000,\r\n            retryPolicy: { maxRetries: 1, backoffMultiplier: 1, initialDelay: 1000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n        ],\r\n        rollbackStrategy: {\r\n          automatic: true,\r\n          conditions: [\r\n            {\r\n              metric: 'error_rate',\r\n              threshold: 2,\r\n              operator: '>',\r\n              duration: 120000,\r\n              description: 'Canary error rate exceeds 2%',\r\n            },\r\n            {\r\n              metric: 'response_time',\r\n              threshold: 500,\r\n              operator: '>',\r\n              duration: 180000,\r\n              description: 'Response time exceeds 500ms',\r\n            },\r\n          ],\r\n          timeout: 180000,\r\n        },\r\n      },\r\n      {\r\n        name: 'Rolling Deployment',\r\n        type: 'rolling',\r\n        configuration: {\r\n          maxUnavailable: 1,\r\n          maxSurge: 1,\r\n          monitoringDuration: 120000,\r\n          automatedRollback: false,\r\n        },\r\n        stages: [\r\n          {\r\n            id: 'build',\r\n            name: 'Build',\r\n            order: 1,\r\n            type: 'build',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 600000,\r\n            retryPolicy: { maxRetries: 2, backoffMultiplier: 2, initialDelay: 1000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'rolling-update',\r\n            name: 'Rolling Update',\r\n            order: 2,\r\n            type: 'deploy',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 1200000,\r\n            retryPolicy: { maxRetries: 1, backoffMultiplier: 2, initialDelay: 5000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n          {\r\n            id: 'health-check',\r\n            name: 'Health Check',\r\n            order: 3,\r\n            type: 'verify',\r\n            status: 'pending',\r\n            commands: [],\r\n            conditions: { runIf: [], skipIf: [] },\r\n            timeout: 300000,\r\n            retryPolicy: { maxRetries: 3, backoffMultiplier: 1.5, initialDelay: 5000 },\r\n            artifacts: { inputs: [], outputs: [] },\r\n            logs: [],\r\n          },\r\n        ],\r\n        rollbackStrategy: {\r\n          automatic: false,\r\n          conditions: [],\r\n          timeout: 600000,\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const strategyData of defaultStrategies) {\r\n      if (!Array.from(this.strategies.values()).some((s) => s.name === strategyData.name)) {\r\n        const strategy: DeploymentStrategy = {\r\n          id: `strategy-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n          notifications: {\r\n            channels: [],\r\n            events: ['deployment:started', 'deployment:completed', 'deployment:failed'],\r\n          },\r\n          ...strategyData,\r\n        } as DeploymentStrategy;\r\n\r\n        this.strategies.set(strategy.id, strategy);\r\n        await this.saveStrategy(strategy);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async saveEnvironment(environment: DeploymentEnvironment): Promise<void> {\r\n    const filePath = join(this.deploymentsPath, 'environments', `${environment.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(environment, null, 2));\r\n  }\r\n\r\n  private async saveStrategy(strategy: DeploymentStrategy): Promise<void> {\r\n    const filePath = join(this.deploymentsPath, 'strategies', `${strategy.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(strategy, null, 2));\r\n  }\r\n\r\n  private async saveDeployment(deployment: Deployment): Promise<void> {\r\n    const filePath = join(this.deploymentsPath, `${deployment.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(deployment, null, 2));\r\n  }\r\n\r\n  private addAuditEntry(\r\n    deployment: Deployment,\r\n    userId: string,\r\n    action: string,\r\n    target: string,\r\n    details: Record<string, any>,\r\n  ): void {\r\n    const entry: DeploymentAuditEntry = {\r\n      id: `audit-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: new Date(),\r\n      userId,\r\n      action,\r\n      target,\r\n      details,\r\n    };\r\n\r\n    deployment.auditLog.push(entry);\r\n  }\r\n\r\n  private addLog(\r\n    stage: DeploymentStage,\r\n    level: DeploymentLog['level'],\r\n    message: string,\r\n    source: string,\r\n    metadata?: Record<string, any>,\r\n  ): void {\r\n    const log: DeploymentLog = {\r\n      timestamp: new Date(),\r\n      level,\r\n      message,\r\n      source,\r\n      metadata,\r\n    };\r\n\r\n    stage.logs.push(log);\r\n  }\r\n\r\n  private evaluateStageConditions(deployment: Deployment, stage: DeploymentStage): boolean {\r\n    // Implement condition evaluation logic\r\n    return true; // Simplified for now\r\n  }\r\n\r\n  private async requiresApproval(deployment: Deployment, stage: DeploymentStage): Promise<boolean> {\r\n    const strategy = this.strategies.get(deployment.strategyId);\r\n    return strategy?.configuration.approvalRequired || false;\r\n  }\r\n\r\n  private async requestApproval(deployment: Deployment, stage: DeploymentStage): Promise<void> {\r\n    // Implement approval request logic\r\n    this.emit('approval:requested', { deployment, stage });\r\n  }\r\n\r\n  private async isPendingApproval(\r\n    deployment: Deployment,\r\n    stage: DeploymentStage,\r\n  ): Promise<boolean> {\r\n    // Check if there are pending approvals for this stage\r\n    return false; // Simplified for now\r\n  }\r\n\r\n  private async isApproved(deployment: Deployment, stage: DeploymentStage): Promise<boolean> {\r\n    // Check if stage is approved\r\n    return true; // Simplified for now\r\n  }\r\n\r\n  private evaluateCommandSuccess(\r\n    command: DeploymentCommand,\r\n    exitCode: number | null,\r\n    stdout: string,\r\n    stderr: string,\r\n  ): boolean {\r\n    if (\r\n      command.successCriteria.exitCode !== undefined &&\r\n      exitCode !== command.successCriteria.exitCode\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    if (command.successCriteria.outputContains) {\r\n      for (const pattern of command.successCriteria.outputContains) {\r\n        if (!stdout.includes(pattern)) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (command.successCriteria.outputNotContains) {\r\n      for (const pattern of command.successCriteria.outputNotContains) {\r\n        if (stdout.includes(pattern) || stderr.includes(pattern)) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private async retryStage(deployment: Deployment, stage: DeploymentStage): Promise<void> {\r\n    // Implement retry logic\r\n    this.logger.info(`Retrying stage: ${stage.name}`);\r\n  }\r\n\r\n  private async handleDeploymentFailure(\r\n    deployment: Deployment,\r\n    failedStage: DeploymentStage,\r\n  ): Promise<void> {\r\n    deployment.status = 'failed';\r\n    deployment.metrics.endTime = new Date();\r\n    deployment.updatedAt = new Date();\r\n\r\n    this.addAuditEntry(deployment, 'system', 'deployment_failed', 'deployment', {\r\n      deploymentId: deployment.id,\r\n      failedStage: failedStage.name,\r\n      reason: 'Stage execution failed',\r\n    });\r\n\r\n    await this.saveDeployment(deployment);\r\n    this.emit('deployment:failed', { deployment, failedStage });\r\n\r\n    // Check if automatic rollback is enabled\r\n    const strategy = this.strategies.get(deployment.strategyId);\r\n    if (strategy?.rollbackStrategy.automatic) {\r\n      await this.rollbackDeployment(deployment.id, 'Automatic rollback due to deployment failure');\r\n    }\r\n  }\r\n\r\n  private async handleDeploymentError(deployment: Deployment, error: any): Promise<void> {\r\n    deployment.status = 'failed';\r\n    deployment.metrics.endTime = new Date();\r\n    deployment.updatedAt = new Date();\r\n\r\n    this.addAuditEntry(deployment, 'system', 'deployment_error', 'deployment', {\r\n      deploymentId: deployment.id,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n\r\n    await this.saveDeployment(deployment);\r\n    this.emit('deployment:error', { deployment, error });\r\n\r\n    this.logger.error(`Deployment error: ${deployment.id}`, { error });\r\n  }\r\n\r\n  private async completeDeployment(deployment: Deployment): Promise<void> {\r\n    deployment.status = 'success';\r\n    deployment.metrics.endTime = new Date();\r\n    deployment.metrics.duration =\r\n      deployment.metrics.endTime.getTime() - deployment.metrics.startTime.getTime();\r\n    deployment.updatedAt = new Date();\r\n\r\n    this.addAuditEntry(deployment, 'system', 'deployment_completed', 'deployment', {\r\n      deploymentId: deployment.id,\r\n      duration: deployment.metrics.duration,\r\n    });\r\n\r\n    await this.saveDeployment(deployment);\r\n    this.emit('deployment:completed', deployment);\r\n\r\n    this.logger.info(`Deployment completed: ${deployment.id} in ${deployment.metrics.duration}ms`);\r\n  }\r\n\r\n  private async getPreviousSuccessfulDeployment(\r\n    projectId: string,\r\n    environmentId: string,\r\n    currentDeploymentId: string,\r\n  ): Promise<Deployment | null> {\r\n    const deployments = Array.from(this.deployments.values())\r\n      .filter(\r\n        (d) =>\r\n          d.projectId === projectId &&\r\n          d.environmentId === environmentId &&\r\n          d.status === 'success' &&\r\n          d.id !== currentDeploymentId,\r\n      )\r\n      .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());\r\n\r\n    return deployments[0] || null;\r\n  }\r\n\r\n  private async executeRollbackStrategy(\r\n    deployment: Deployment,\r\n    previousDeployment: Deployment,\r\n  ): Promise<void> {\r\n    // Implement rollback execution logic\r\n    this.logger.info(`Executing rollback from ${deployment.id} to ${previousDeployment.id}`);\r\n\r\n    // This would typically involve:\r\n    // 1. Switching traffic back to previous version\r\n    // 2. Updating load balancer configuration\r\n    // 3. Rolling back container deployments\r\n    // 4. Reverting database migrations if needed\r\n    // 5. Updating DNS records\r\n\r\n    this.emit('rollback:executed', { deployment, previousDeployment });\r\n  }\r\n\r\n  private calculateDeploymentFrequency(deployments: Deployment[]): number {\r\n    if (deployments.length === 0) return 0;\r\n\r\n    const sortedDeployments = deployments.sort(\r\n      (a, b) => a.createdAt.getTime() - b.createdAt.getTime(),\r\n    );\r\n\r\n    const firstDeployment = sortedDeployments[0];\r\n    const lastDeployment = sortedDeployments[sortedDeployments.length - 1];\r\n\r\n    const timeSpan = lastDeployment.createdAt.getTime() - firstDeployment.createdAt.getTime();\r\n    const days = timeSpan / (1000 * 60 * 60 * 24);\r\n\r\n    return deployments.length / Math.max(days, 1);\r\n  }\r\n\r\n  private calculateMTTR(deployments: Deployment[]): number {\r\n    const failedDeployments = deployments.filter(\r\n      (d) => d.status === 'failed' || d.status === 'rolled-back',\r\n    );\r\n\r\n    if (failedDeployments.length === 0) return 0;\r\n\r\n    const recoveryTimes = failedDeployments\r\n      .map((d) => d.rollback?.rollbackDuration || 0)\r\n      .filter((time) => time > 0);\r\n\r\n    if (recoveryTimes.length === 0) return 0;\r\n\r\n    return recoveryTimes.reduce((sum, time) => sum + time, 0) / recoveryTimes.length;\r\n  }\r\n\r\n  private calculateLeadTime(deployments: Deployment[]): number {\r\n    // This would typically calculate from commit to production\r\n    // For now, return average deployment time\r\n    const completedDeployments = deployments.filter((d) => d.metrics.duration);\r\n\r\n    if (completedDeployments.length === 0) return 0;\r\n\r\n    return (\r\n      completedDeployments.reduce((sum, d) => sum + (d.metrics.duration || 0), 0) /\r\n      completedDeployments.length\r\n    );\r\n  }\r\n}\r\n"],"names":["EventEmitter","writeFile","readFile","mkdir","readdir","join","spawn","Logger","ConfigManager","DeploymentManager","deployments","Map","environments","strategies","pipelines","activeProcesses","deploymentsPath","logger","config","level","format","destination","getInstance","initialize","recursive","loadConfigurations","initializeDefaultStrategies","info","error","createEnvironment","environmentData","environment","id","Date","now","Math","random","toString","substr","name","type","status","configuration","region","provider","endpoints","secrets","environment_variables","resources","cpu","memory","storage","replicas","healthCheck","url","method","expectedStatus","timeout","interval","retries","monitoring","enabled","alerts","metrics","logs","retention","aggregation","security","tls","authentication","authorization","compliance","scanning","vulnerabilities","licenses","createdAt","updatedAt","set","saveEnvironment","emit","createDeployment","deploymentData","get","environmentId","Error","strategy","strategyId","deployment","version","projectId","initiatedBy","source","artifacts","files","startTime","deploymentSize","successRate","errorRate","performanceMetrics","stages","map","stage","approvals","notifications","auditLog","addAuditEntry","deploymentId","saveDeployment","executeDeployment","executeStage","handleDeploymentFailure","completeDeployment","handleDeploymentError","addLog","evaluateStageConditions","requiresApproval","requestApproval","isPendingApproval","Promise","resolve","setTimeout","isApproved","command","commands","executeCommand","endTime","duration","getTime","message","String","retryPolicy","maxRetries","retryStage","reject","processEnv","process","env","DEPLOYMENT_ID","DEPLOYMENT_VERSION","ENVIRONMENT_ID","args","childProcess","cwd","workingDirectory","stdio","stdout","stderr","on","data","output","trim","kill","code","clearTimeout","delete","success","evaluateCommandSuccess","rollbackDeployment","reason","userId","previousDeployment","getPreviousSuccessfulDeployment","rollbackStartTime","rollback","triggered","timestamp","previousDeploymentId","rollbackDuration","executeRollbackStrategy","getDeploymentMetrics","filters","Array","from","values","filter","d","timeRange","start","end","totalDeployments","length","successfulDeployments","failedDeployments","rolledBackDeployments","completedDeployments","averageDeploymentTime","reduce","sum","environmentMetrics","envDeployments","envSuccessful","averageTime","strategyMetrics","strategyDeployments","strategySuccessful","strategyRolledBack","rollbackRate","deploymentFrequency","calculateDeploymentFrequency","meanTimeToRecovery","calculateMTTR","changeFailureRate","max","leadTime","calculateLeadTime","envFiles","file","f","endsWith","content","JSON","parse","strategyFiles","pipelineFiles","pipeline","size","warn","defaultStrategies","monitoringDuration","automatedRollback","rollbackThreshold","order","conditions","runIf","skipIf","backoffMultiplier","initialDelay","inputs","outputs","rollbackStrategy","automatic","metric","threshold","operator","description","trafficSplitPercentage","maxUnavailable","maxSurge","strategyData","some","s","channels","events","saveStrategy","filePath","stringify","action","target","details","entry","push","metadata","log","approvalRequired","exitCode","successCriteria","undefined","outputContains","pattern","includes","outputNotContains","failedStage","currentDeploymentId","sort","a","b","sortedDeployments","firstDeployment","lastDeployment","timeSpan","days","recoveryTimes","time"],"mappings":"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"}
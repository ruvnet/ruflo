{"version":3,"sources":["../../../../src/hive-mind/core/DatabaseManager.ts"],"sourcesContent":["/**\r\n * DatabaseManager Class\r\n *\r\n * Manages all database operations for the Hive Mind system\r\n * using SQLite as the persistence layer.\r\n */\r\n\r\nimport path from 'path';\r\nimport fs from 'fs/promises';\r\nimport { EventEmitter } from 'events';\r\nimport { fileURLToPath } from 'url';\r\n\r\n// ES module compatibility - define __dirname\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = path.dirname(__filename);\r\n\r\n// Dynamic import for SQLite wrapper\r\nlet createDatabase: any;\r\nlet isSQLiteAvailable: any;\r\nlet isWindows: any;\r\n\r\nasync function loadSQLiteWrapper() {\r\n  const module = await import('../../memory/sqlite-wrapper.js');\r\n  createDatabase = module.createDatabase;\r\n  isSQLiteAvailable = module.isSQLiteAvailable;\r\n  isWindows = module.isWindows;\r\n}\r\n\r\nexport class DatabaseManager extends EventEmitter {\r\n  private static instance: DatabaseManager;\r\n  private db: any; // Database instance or in-memory fallback\r\n  private statements: Map<string, any>;\r\n  private dbPath: string;\r\n  private isInMemory: boolean = false;\r\n  private memoryStore: any = null;\r\n\r\n  private constructor() {\r\n    super();\r\n    this.statements = new Map();\r\n  }\r\n\r\n  /**\r\n   * Get singleton instance\r\n   */\r\n  static async getInstance(): Promise<DatabaseManager> {\r\n    if (!DatabaseManager.instance) {\r\n      DatabaseManager.instance = new DatabaseManager();\r\n      await DatabaseManager.instance.initialize();\r\n    }\r\n    return DatabaseManager.instance;\r\n  }\r\n\r\n  /**\r\n   * Initialize database\r\n   */\r\n  async initialize(): Promise<void> {\r\n    // Load SQLite wrapper functions\r\n    await loadSQLiteWrapper();\r\n    \r\n    // Check if SQLite is available\r\n    const sqliteAvailable = await isSQLiteAvailable();\r\n    \r\n    if (!sqliteAvailable) {\r\n      console.warn('SQLite not available, using in-memory storage for Hive Mind');\r\n      this.initializeInMemoryFallback();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Ensure data directory exists\r\n      const dataDir = path.join(process.cwd(), 'data');\r\n      await fs.mkdir(dataDir, { recursive: true });\r\n\r\n      // Set database path\r\n      this.dbPath = path.join(dataDir, 'hive-mind.db');\r\n\r\n      // Open database\r\n      this.db = await createDatabase(this.dbPath);\r\n\r\n      // Enable foreign keys\r\n      this.db.pragma('foreign_keys = ON');\r\n\r\n      // Load schema\r\n      await this.loadSchema();\r\n\r\n      // Prepare statements\r\n      this.prepareStatements();\r\n\r\n      this.emit('initialized');\r\n    } catch (error) {\r\n      console.error('Failed to initialize SQLite database:', error);\r\n      console.warn('Falling back to in-memory storage');\r\n      this.initializeInMemoryFallback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize in-memory fallback\r\n   */\r\n  private initializeInMemoryFallback(): void {\r\n    this.isInMemory = true;\r\n    this.memoryStore = {\r\n      swarms: new Map(),\r\n      agents: new Map(),\r\n      tasks: new Map(),\r\n      memory: new Map(),\r\n      communications: new Map(),\r\n      performance_metrics: new Map(),\r\n      consensus: new Map()\r\n    };\r\n\r\n    // Create mock statement methods\r\n    this.statements = new Map();\r\n    \r\n    if (isWindows && isWindows()) {\r\n      console.info(`\r\nNote: Hive Mind data will not persist between runs on Windows without SQLite.\r\nFor persistent storage options, see: https://github.com/ruvnet/claude-code-flow/docs/windows-installation.md\r\n`);\r\n    }\r\n\r\n    this.emit('initialized');\r\n  }\r\n\r\n  /**\r\n   * Load database schema\r\n   */\r\n  private async loadSchema(): Promise<void> {\r\n    const schemaPath = path.join(__dirname, '..', '..', 'db', 'hive-mind-schema.sql');\r\n    const schema = await fs.readFile(schemaPath, 'utf-8');\r\n\r\n    // Execute schema\r\n    this.db.exec(schema);\r\n  }\r\n\r\n  /**\r\n   * Prepare common SQL statements\r\n   */\r\n  private prepareStatements(): void {\r\n    // Swarm statements\r\n    this.statements.set(\r\n      'createSwarm',\r\n      this.db.prepare(`\r\n      INSERT INTO swarms (id, name, topology, queen_mode, max_agents, consensus_threshold, memory_ttl, config)\r\n      VALUES (@id, @name, @topology, @queenMode, @maxAgents, @consensusThreshold, @memoryTTL, @config)\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getSwarm',\r\n      this.db.prepare(`\r\n      SELECT * FROM swarms WHERE id = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getActiveSwarm',\r\n      this.db.prepare(`\r\n      SELECT id FROM swarms WHERE is_active = 1 LIMIT 1\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'setActiveSwarm',\r\n      this.db.prepare(`\r\n      UPDATE swarms SET is_active = CASE WHEN id = ? THEN 1 ELSE 0 END\r\n    `),\r\n    );\r\n\r\n    // Agent statements\r\n    this.statements.set(\r\n      'createAgent',\r\n      this.db.prepare(`\r\n      INSERT INTO agents (id, swarm_id, name, type, status, capabilities, metadata)\r\n      VALUES (@id, @swarmId, @name, @type, @status, @capabilities, @metadata)\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getAgent',\r\n      this.db.prepare(`\r\n      SELECT * FROM agents WHERE id = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getAgents',\r\n      this.db.prepare(`\r\n      SELECT * FROM agents WHERE swarm_id = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'updateAgent',\r\n      this.db.prepare(`\r\n      UPDATE agents SET ? WHERE id = ?\r\n    `),\r\n    );\r\n\r\n    // Task statements\r\n    this.statements.set(\r\n      'createTask',\r\n      this.db.prepare(`\r\n      INSERT INTO tasks (\r\n        id, swarm_id, description, priority, strategy, status, \r\n        dependencies, assigned_agents, require_consensus, max_agents, \r\n        required_capabilities, metadata\r\n      ) VALUES (\r\n        @id, @swarmId, @description, @priority, @strategy, @status,\r\n        @dependencies, @assignedAgents, @requireConsensus, @maxAgents,\r\n        @requiredCapabilities, @metadata\r\n      )\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getTask',\r\n      this.db.prepare(`\r\n      SELECT * FROM tasks WHERE id = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getTasks',\r\n      this.db.prepare(`\r\n      SELECT * FROM tasks WHERE swarm_id = ? ORDER BY created_at DESC\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'updateTaskStatus',\r\n      this.db.prepare(`\r\n      UPDATE tasks SET status = ? WHERE id = ?\r\n    `),\r\n    );\r\n\r\n    // Memory statements\r\n    this.statements.set(\r\n      'storeMemory',\r\n      this.db.prepare(`\r\n      INSERT OR REPLACE INTO memory (key, namespace, value, ttl, metadata)\r\n      VALUES (@key, @namespace, @value, @ttl, @metadata)\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'getMemory',\r\n      this.db.prepare(`\r\n      SELECT * FROM memory WHERE key = ? AND namespace = ?\r\n    `),\r\n    );\r\n\r\n    this.statements.set(\r\n      'searchMemory',\r\n      this.db.prepare(`\r\n      SELECT * FROM memory \r\n      WHERE namespace = ? AND (key LIKE ? OR value LIKE ?)\r\n      ORDER BY last_accessed_at DESC\r\n      LIMIT ?\r\n    `),\r\n    );\r\n\r\n    // Communication statements\r\n    this.statements.set(\r\n      'createCommunication',\r\n      this.db.prepare(`\r\n      INSERT INTO communications (\r\n        from_agent_id, to_agent_id, swarm_id, message_type, \r\n        content, priority, requires_response\r\n      ) VALUES (\r\n        @from_agent_id, @to_agent_id, @swarm_id, @message_type,\r\n        @content, @priority, @requires_response\r\n      )\r\n    `),\r\n    );\r\n\r\n    // Performance statements\r\n    this.statements.set(\r\n      'storeMetric',\r\n      this.db.prepare(`\r\n      INSERT INTO performance_metrics (swarm_id, agent_id, metric_type, metric_value, metadata)\r\n      VALUES (@swarm_id, @agent_id, @metric_type, @metric_value, @metadata)\r\n    `),\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Raw SQL helper for complex updates\r\n   */\r\n  raw(sql: string): any {\r\n    return { _raw: sql };\r\n  }\r\n\r\n  // Swarm operations\r\n\r\n  async createSwarm(data: any): Promise<void> {\r\n    this.statements.get('createSwarm')!.run(data);\r\n  }\r\n\r\n  async getSwarm(id: string): Promise<any> {\r\n    return this.statements.get('getSwarm')!.get(id);\r\n  }\r\n\r\n  async getActiveSwarmId(): Promise<string | null> {\r\n    const result = this.statements.get('getActiveSwarm')!.get();\r\n    return result ? result.id : null;\r\n  }\r\n\r\n  async setActiveSwarm(id: string): Promise<void> {\r\n    this.statements.get('setActiveSwarm')!.run(id);\r\n  }\r\n\r\n  async getAllSwarms(): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT s.*, COUNT(a.id) as agentCount \r\n      FROM swarms s \r\n      LEFT JOIN agents a ON s.id = a.swarm_id \r\n      GROUP BY s.id \r\n      ORDER BY s.created_at DESC\r\n    `,\r\n      )\r\n      .all();\r\n  }\r\n\r\n  // Agent operations\r\n\r\n  async createAgent(data: any): Promise<void> {\r\n    this.statements.get('createAgent')!.run(data);\r\n  }\r\n\r\n  async getAgent(id: string): Promise<any> {\r\n    return this.statements.get('getAgent')!.get(id);\r\n  }\r\n\r\n  async getAgents(swarmId: string): Promise<any[]> {\r\n    return this.statements.get('getAgents')!.all(swarmId);\r\n  }\r\n\r\n  async updateAgent(id: string, updates: any): Promise<void> {\r\n    const setClauses: string[] = [];\r\n    const values: any[] = [];\r\n\r\n    for (const [key, value] of Object.entries(updates)) {\r\n      if (value && typeof value === 'object' && value._raw) {\r\n        setClauses.push(`${key} = ${value._raw}`);\r\n      } else {\r\n        setClauses.push(`${key} = ?`);\r\n        values.push(value);\r\n      }\r\n    }\r\n\r\n    values.push(id);\r\n\r\n    const stmt = this.db.prepare(`\r\n      UPDATE agents SET ${setClauses.join(', ')} WHERE id = ?\r\n    `);\r\n\r\n    stmt.run(...values);\r\n  }\r\n\r\n  async updateAgentStatus(id: string, status: string): Promise<void> {\r\n    this.db.prepare('UPDATE agents SET status = ? WHERE id = ?').run(status, id);\r\n  }\r\n\r\n  async getAgentPerformance(agentId: string): Promise<any> {\r\n    const agent = await this.getAgent(agentId);\r\n    if (!agent) return null;\r\n\r\n    return {\r\n      successRate: agent.success_count / (agent.success_count + agent.error_count) || 0,\r\n      totalTasks: agent.success_count + agent.error_count,\r\n      messageCount: agent.message_count,\r\n    };\r\n  }\r\n\r\n  // Task operations\r\n\r\n  async createTask(data: any): Promise<void> {\r\n    this.statements.get('createTask')!.run({\r\n      ...data,\r\n      requireConsensus: data.requireConsensus ? 1 : 0,\r\n    });\r\n  }\r\n\r\n  async getTask(id: string): Promise<any> {\r\n    return this.statements.get('getTask')!.get(id);\r\n  }\r\n\r\n  async getTasks(swarmId: string): Promise<any[]> {\r\n    return this.statements.get('getTasks')!.all(swarmId);\r\n  }\r\n\r\n  async updateTask(id: string, updates: any): Promise<void> {\r\n    const setClauses: string[] = [];\r\n    const values: any[] = [];\r\n\r\n    for (const [key, value] of Object.entries(updates)) {\r\n      setClauses.push(`${key} = ?`);\r\n      values.push(value);\r\n    }\r\n\r\n    values.push(id);\r\n\r\n    const stmt = this.db.prepare(`\r\n      UPDATE tasks SET ${setClauses.join(', ')} WHERE id = ?\r\n    `);\r\n\r\n    stmt.run(...values);\r\n  }\r\n\r\n  async updateTaskStatus(id: string, status: string): Promise<void> {\r\n    this.statements.get('updateTaskStatus')!.run(status, id);\r\n  }\r\n\r\n  async getPendingTasks(swarmId: string): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM tasks \r\n      WHERE swarm_id = ? AND status = 'pending'\r\n      ORDER BY \r\n        CASE priority \r\n          WHEN 'critical' THEN 1 \r\n          WHEN 'high' THEN 2 \r\n          WHEN 'medium' THEN 3 \r\n          WHEN 'low' THEN 4 \r\n        END,\r\n        created_at ASC\r\n    `,\r\n      )\r\n      .all(swarmId);\r\n  }\r\n\r\n  async getActiveTasks(swarmId: string): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM tasks \r\n      WHERE swarm_id = ? AND status IN ('assigned', 'in_progress')\r\n    `,\r\n      )\r\n      .all(swarmId);\r\n  }\r\n\r\n  async reassignTask(taskId: string, newAgentId: string): Promise<void> {\r\n    const task = await this.getTask(taskId);\r\n    if (!task) return;\r\n\r\n    const assignedAgents = JSON.parse(task.assigned_agents || '[]');\r\n    if (!assignedAgents.includes(newAgentId)) {\r\n      assignedAgents.push(newAgentId);\r\n    }\r\n\r\n    await this.updateTask(taskId, {\r\n      assigned_agents: JSON.stringify(assignedAgents),\r\n    });\r\n  }\r\n\r\n  // Memory operations\r\n\r\n  async storeMemory(data: any): Promise<void> {\r\n    this.statements.get('storeMemory')!.run(data);\r\n  }\r\n\r\n  async getMemory(key: string, namespace: string): Promise<any> {\r\n    return this.statements.get('getMemory')!.get(key, namespace);\r\n  }\r\n\r\n  async updateMemoryAccess(key: string, namespace: string): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      UPDATE memory \r\n      SET access_count = access_count + 1, last_accessed_at = CURRENT_TIMESTAMP\r\n      WHERE key = ? AND namespace = ?\r\n    `,\r\n      )\r\n      .run(key, namespace);\r\n  }\r\n\r\n  async searchMemory(options: any): Promise<any[]> {\r\n    const pattern = `%${options.pattern || ''}%`;\r\n    return this.statements\r\n      .get('searchMemory')!\r\n      .all(options.namespace || 'default', pattern, pattern, options.limit || 10);\r\n  }\r\n\r\n  async deleteMemory(key: string, namespace: string): Promise<void> {\r\n    this.db.prepare('DELETE FROM memory WHERE key = ? AND namespace = ?').run(key, namespace);\r\n  }\r\n\r\n  async listMemory(namespace: string, limit: number): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM memory \r\n      WHERE namespace = ? \r\n      ORDER BY last_accessed_at DESC \r\n      LIMIT ?\r\n    `,\r\n      )\r\n      .all(namespace, limit);\r\n  }\r\n\r\n  async getMemoryStats(): Promise<any> {\r\n    const result = this.db\r\n      .prepare(\r\n        `\r\n      SELECT \r\n        COUNT(*) as totalEntries,\r\n        SUM(LENGTH(value)) as totalSize\r\n      FROM memory\r\n    `,\r\n      )\r\n      .get();\r\n\r\n    return result || { totalEntries: 0, totalSize: 0 };\r\n  }\r\n\r\n  async getNamespaceStats(namespace: string): Promise<any> {\r\n    return (\r\n      this.db\r\n        .prepare(\r\n          `\r\n      SELECT \r\n        COUNT(*) as entries,\r\n        SUM(LENGTH(value)) as size,\r\n        AVG(ttl) as avgTTL\r\n      FROM memory\r\n      WHERE namespace = ?\r\n    `,\r\n        )\r\n        .get(namespace) || { entries: 0, size: 0, avgTTL: 0 }\r\n    );\r\n  }\r\n\r\n  async getAllMemoryEntries(): Promise<any[]> {\r\n    return this.db.prepare('SELECT * FROM memory').all();\r\n  }\r\n\r\n  async getRecentMemoryEntries(limit: number): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM memory \r\n      ORDER BY last_accessed_at DESC \r\n      LIMIT ?\r\n    `,\r\n      )\r\n      .all(limit);\r\n  }\r\n\r\n  async getOldMemoryEntries(daysOld: number): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM memory \r\n      WHERE created_at < datetime('now', '-' || ? || ' days')\r\n    `,\r\n      )\r\n      .all(daysOld);\r\n  }\r\n\r\n  async updateMemoryEntry(entry: any): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      UPDATE memory \r\n      SET value = ?, access_count = ?, last_accessed_at = ?\r\n      WHERE key = ? AND namespace = ?\r\n    `,\r\n      )\r\n      .run(entry.value, entry.accessCount, entry.lastAccessedAt, entry.key, entry.namespace);\r\n  }\r\n\r\n  async clearMemory(swarmId: string): Promise<void> {\r\n    // Clear memory related to a specific swarm\r\n    this.db\r\n      .prepare(\r\n        `\r\n      DELETE FROM memory \r\n      WHERE metadata LIKE '%\"swarmId\":\"${swarmId}\"%'\r\n    `,\r\n      )\r\n      .run();\r\n  }\r\n\r\n  async deleteOldEntries(namespace: string, ttl: number): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      DELETE FROM memory \r\n      WHERE namespace = ? AND created_at < datetime('now', '-' || ? || ' seconds')\r\n    `,\r\n      )\r\n      .run(namespace, ttl);\r\n  }\r\n\r\n  async trimNamespace(namespace: string, maxEntries: number): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      DELETE FROM memory \r\n      WHERE namespace = ? AND key NOT IN (\r\n        SELECT key FROM memory \r\n        WHERE namespace = ? \r\n        ORDER BY last_accessed_at DESC \r\n        LIMIT ?\r\n      )\r\n    `,\r\n      )\r\n      .run(namespace, namespace, maxEntries);\r\n  }\r\n\r\n  // Communication operations\r\n\r\n  async createCommunication(data: any): Promise<void> {\r\n    this.statements.get('createCommunication')!.run(data);\r\n  }\r\n\r\n  async getPendingMessages(agentId: string): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM communications \r\n      WHERE to_agent_id = ? AND delivered_at IS NULL\r\n      ORDER BY \r\n        CASE priority \r\n          WHEN 'urgent' THEN 1 \r\n          WHEN 'high' THEN 2 \r\n          WHEN 'normal' THEN 3 \r\n          WHEN 'low' THEN 4 \r\n        END,\r\n        timestamp ASC\r\n    `,\r\n      )\r\n      .all(agentId);\r\n  }\r\n\r\n  async markMessageDelivered(messageId: string): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      UPDATE communications \r\n      SET delivered_at = CURRENT_TIMESTAMP \r\n      WHERE id = ?\r\n    `,\r\n      )\r\n      .run(messageId);\r\n  }\r\n\r\n  async markMessageRead(messageId: string): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      UPDATE communications \r\n      SET read_at = CURRENT_TIMESTAMP \r\n      WHERE id = ?\r\n    `,\r\n      )\r\n      .run(messageId);\r\n  }\r\n\r\n  async getRecentMessages(swarmId: string, timeWindow: number): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM communications \r\n      WHERE swarm_id = ? AND timestamp > datetime('now', '-' || ? || ' milliseconds')\r\n    `,\r\n      )\r\n      .all(swarmId, timeWindow);\r\n  }\r\n\r\n  // Consensus operations\r\n\r\n  async createConsensusProposal(proposal: any): Promise<void> {\r\n    this.db\r\n      .prepare(\r\n        `\r\n      INSERT INTO consensus (\r\n        id, swarm_id, task_id, proposal, required_threshold, \r\n        status, deadline_at\r\n      ) VALUES (\r\n        @id, @swarmId, @taskId, @proposal, @requiredThreshold,\r\n        'pending', @deadline\r\n      )\r\n    `,\r\n      )\r\n      .run({\r\n        id: proposal.id,\r\n        swarmId: proposal.swarmId,\r\n        taskId: proposal.taskId || null,\r\n        proposal: JSON.stringify(proposal.proposal),\r\n        requiredThreshold: proposal.requiredThreshold,\r\n        deadline: proposal.deadline,\r\n      });\r\n  }\r\n\r\n  async submitConsensusVote(\r\n    proposalId: string,\r\n    agentId: string,\r\n    vote: boolean,\r\n    reason?: string,\r\n  ): Promise<void> {\r\n    const proposal = this.db.prepare('SELECT * FROM consensus WHERE id = ?').get(proposalId);\r\n    if (!proposal) return;\r\n\r\n    const votes = JSON.parse(proposal.votes || '{}');\r\n    votes[agentId] = { vote, reason: reason || '', timestamp: new Date() };\r\n\r\n    const totalVoters = Object.keys(votes).length;\r\n    const positiveVotes = Object.values(votes).filter((v: any) => v.vote).length;\r\n    const currentRatio = positiveVotes / totalVoters;\r\n\r\n    const status = currentRatio >= proposal.required_threshold ? 'achieved' : 'pending';\r\n\r\n    this.db\r\n      .prepare(\r\n        `\r\n      UPDATE consensus \r\n      SET votes = ?, current_votes = ?, total_voters = ?, status = ?\r\n      WHERE id = ?\r\n    `,\r\n      )\r\n      .run(JSON.stringify(votes), positiveVotes, totalVoters, status, proposalId);\r\n  }\r\n\r\n  // Performance operations\r\n\r\n  async storePerformanceMetric(data: any): Promise<void> {\r\n    this.statements.get('storeMetric')!.run({\r\n      ...data,\r\n      metadata: data.metadata ? JSON.stringify(data.metadata) : null,\r\n    });\r\n  }\r\n\r\n  async getSwarmStats(swarmId: string): Promise<any> {\r\n    const agentStats = this.db\r\n      .prepare(\r\n        `\r\n      SELECT \r\n        COUNT(*) as agentCount,\r\n        SUM(CASE WHEN status = 'busy' THEN 1 ELSE 0 END) as busyAgents\r\n      FROM agents \r\n      WHERE swarm_id = ?\r\n    `,\r\n      )\r\n      .get(swarmId);\r\n\r\n    const taskStats = this.db\r\n      .prepare(\r\n        `\r\n      SELECT \r\n        COUNT(*) as taskBacklog\r\n      FROM tasks \r\n      WHERE swarm_id = ? AND status IN ('pending', 'assigned')\r\n    `,\r\n      )\r\n      .get(swarmId);\r\n\r\n    return {\r\n      ...agentStats,\r\n      ...taskStats,\r\n      agentUtilization:\r\n        agentStats.agentCount > 0 ? agentStats.busyAgents / agentStats.agentCount : 0,\r\n    };\r\n  }\r\n\r\n  async getStrategyPerformance(swarmId: string): Promise<any> {\r\n    const results = this.db\r\n      .prepare(\r\n        `\r\n      SELECT \r\n        strategy,\r\n        COUNT(*) as totalTasks,\r\n        SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as successful,\r\n        AVG(JULIANDAY(completed_at) - JULIANDAY(created_at)) * 24 * 60 * 60 * 1000 as avgCompletionTime\r\n      FROM tasks \r\n      WHERE swarm_id = ? AND completed_at IS NOT NULL\r\n      GROUP BY strategy\r\n    `,\r\n      )\r\n      .all(swarmId);\r\n\r\n    const performance: any = {};\r\n    for (const result of results) {\r\n      performance[result.strategy] = {\r\n        successRate: result.successful / result.totalTasks,\r\n        avgCompletionTime: result.avgCompletionTime,\r\n        totalTasks: result.totalTasks,\r\n      };\r\n    }\r\n\r\n    return performance;\r\n  }\r\n\r\n  async getSuccessfulDecisions(swarmId: string): Promise<any[]> {\r\n    return this.db\r\n      .prepare(\r\n        `\r\n      SELECT * FROM memory \r\n      WHERE namespace = 'queen-decisions' \r\n      AND key LIKE 'decision/%'\r\n      AND metadata LIKE '%\"swarmId\":\"${swarmId}\"%'\r\n      ORDER BY created_at DESC\r\n      LIMIT 100\r\n    `,\r\n      )\r\n      .all();\r\n  }\r\n\r\n  // Utility operations\r\n\r\n  async deleteMemoryEntry(key: string, namespace: string): Promise<void> {\r\n    const startTime = performance.now();\r\n\r\n    try {\r\n      this.db.prepare('DELETE FROM memory WHERE key = ? AND namespace = ?').run(key, namespace);\r\n\r\n      const duration = performance.now() - startTime;\r\n      this.recordPerformance('delete_memory', duration);\r\n    } catch (error) {\r\n      this.recordPerformance('delete_memory_error', performance.now() - startTime);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get database analytics\r\n   */\r\n  getDatabaseAnalytics(): any {\r\n    try {\r\n      const stats = this.db.prepare('PRAGMA table_info(swarms)').all();\r\n      return {\r\n        fragmentation: 0, // Placeholder - could implement actual fragmentation detection\r\n        tableCount: stats.length,\r\n        schemaVersion: '1.0.0',\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        fragmentation: 0,\r\n        tableCount: 0,\r\n        schemaVersion: 'unknown',\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Record performance metric\r\n   */\r\n  private recordPerformance(operation: string, duration: number): void {\r\n    // Simple performance tracking - could be expanded\r\n    console.debug(`DB Operation ${operation}: ${duration.toFixed(2)}ms`);\r\n  }\r\n\r\n  /**\r\n   * Close database connection\r\n   */\r\n  close(): void {\r\n    this.db.close();\r\n  }\r\n}\r\n"],"names":["path","fs","EventEmitter","fileURLToPath","__filename","url","__dirname","dirname","createDatabase","isSQLiteAvailable","isWindows","loadSQLiteWrapper","module","DatabaseManager","instance","db","statements","dbPath","isInMemory","memoryStore","Map","getInstance","initialize","sqliteAvailable","console","warn","initializeInMemoryFallback","dataDir","join","process","cwd","mkdir","recursive","pragma","loadSchema","prepareStatements","emit","error","swarms","agents","tasks","memory","communications","performance_metrics","consensus","info","schemaPath","schema","readFile","exec","set","prepare","raw","sql","_raw","createSwarm","data","get","run","getSwarm","id","getActiveSwarmId","result","setActiveSwarm","getAllSwarms","all","createAgent","getAgent","getAgents","swarmId","updateAgent","updates","setClauses","values","key","value","Object","entries","push","stmt","updateAgentStatus","status","getAgentPerformance","agentId","agent","successRate","success_count","error_count","totalTasks","messageCount","message_count","createTask","requireConsensus","getTask","getTasks","updateTask","updateTaskStatus","getPendingTasks","getActiveTasks","reassignTask","taskId","newAgentId","task","assignedAgents","JSON","parse","assigned_agents","includes","stringify","storeMemory","getMemory","namespace","updateMemoryAccess","searchMemory","options","pattern","limit","deleteMemory","listMemory","getMemoryStats","totalEntries","totalSize","getNamespaceStats","size","avgTTL","getAllMemoryEntries","getRecentMemoryEntries","getOldMemoryEntries","daysOld","updateMemoryEntry","entry","accessCount","lastAccessedAt","clearMemory","deleteOldEntries","ttl","trimNamespace","maxEntries","createCommunication","getPendingMessages","markMessageDelivered","messageId","markMessageRead","getRecentMessages","timeWindow","createConsensusProposal","proposal","requiredThreshold","deadline","submitConsensusVote","proposalId","vote","reason","votes","timestamp","Date","totalVoters","keys","length","positiveVotes","filter","v","currentRatio","required_threshold","storePerformanceMetric","metadata","getSwarmStats","agentStats","taskStats","agentUtilization","agentCount","busyAgents","getStrategyPerformance","results","performance","strategy","successful","avgCompletionTime","getSuccessfulDecisions","deleteMemoryEntry","startTime","now","duration","recordPerformance","getDatabaseAnalytics","stats","fragmentation","tableCount","schemaVersion","operation","debug","toFixed","close"],"mappings":"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"}
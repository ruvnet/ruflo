{"version":3,"sources":["../../../../../src/cli/simple-commands/hive-mind/auto-save-middleware.js"],"sourcesContent":["/**\r\n * Auto-save middleware for Hive Mind swarms\r\n * Automatically saves session state during operations\r\n */\r\n\r\nimport { HiveMindSessionManager } from './session-manager.js';\r\n\r\nexport class AutoSaveMiddleware {\r\n  constructor(sessionId, sessionManager, saveInterval = 30000) {\r\n    this.sessionId = sessionId;\r\n    this.saveInterval = saveInterval;\r\n    this.sessionManager = sessionManager; // Use provided session manager\r\n    this.saveTimer = null;\r\n    this.pendingChanges = [];\r\n    this.isActive = false;\r\n    this.childProcesses = new Set();\r\n  }\r\n\r\n  /**\r\n   * Start auto-save monitoring\r\n   */\r\n  start() {\r\n    if (this.isActive) {\r\n      return;\r\n    }\r\n\r\n    this.isActive = true;\r\n\r\n    // Set up periodic saves\r\n    this.saveTimer = setInterval(() => {\r\n      if (this.pendingChanges.length > 0) {\r\n        this.performAutoSave();\r\n      }\r\n    }, this.saveInterval);\r\n\r\n    // Also save on process exit\r\n    process.on('beforeExit', () => {\r\n      this.performAutoSave();\r\n    });\r\n\r\n    process.on('SIGINT', async () => {\r\n      console.log('\\n\\nReceived SIGINT, cleaning up...');\r\n      await this.cleanup();\r\n      process.exit(0);\r\n    });\r\n\r\n    process.on('SIGTERM', async () => {\r\n      console.log('\\n\\nReceived SIGTERM, cleaning up...');\r\n      await this.cleanup();\r\n      process.exit(0);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop auto-save monitoring\r\n   */\r\n  stop() {\r\n    if (this.saveTimer) {\r\n      clearInterval(this.saveTimer);\r\n      this.saveTimer = null;\r\n    }\r\n    this.isActive = false;\r\n\r\n    // Final save\r\n    if (this.pendingChanges.length > 0) {\r\n      this.performAutoSave();\r\n    }\r\n\r\n    this.sessionManager.close();\r\n  }\r\n\r\n  /**\r\n   * Track a change for auto-save\r\n   */\r\n  trackChange(changeType, data) {\r\n    this.pendingChanges.push({\r\n      type: changeType,\r\n      data: data,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n\r\n    // Trigger immediate save for critical changes\r\n    if (\r\n      changeType === 'task_completed' ||\r\n      changeType === 'agent_spawned' ||\r\n      changeType === 'consensus_reached'\r\n    ) {\r\n      this.performAutoSave();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Track task progress\r\n   */\r\n  trackTaskProgress(taskId, status, result = null) {\r\n    this.trackChange('task_progress', {\r\n      taskId,\r\n      status,\r\n      result,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Track agent activity\r\n   */\r\n  trackAgentActivity(agentId, activity, data = null) {\r\n    this.trackChange('agent_activity', {\r\n      agentId,\r\n      activity,\r\n      data,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Track memory updates\r\n   */\r\n  trackMemoryUpdate(key, value, type = 'general') {\r\n    this.trackChange('memory_update', {\r\n      key,\r\n      value,\r\n      type,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Track consensus decisions\r\n   */\r\n  trackConsensusDecision(topic, decision, votes) {\r\n    this.trackChange('consensus_reached', {\r\n      topic,\r\n      decision,\r\n      votes,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Perform auto-save\r\n   */\r\n  async performAutoSave() {\r\n    if (this.pendingChanges.length === 0) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Group changes by type\r\n      const changesByType = this.pendingChanges.reduce((acc, change) => {\r\n        if (!acc[change.type]) {\r\n          acc[change.type] = [];\r\n        }\r\n        acc[change.type].push(change);\r\n        return acc;\r\n      }, {});\r\n\r\n      // Calculate progress\r\n      const taskProgress = changesByType.task_progress || [];\r\n      const completedTasks = taskProgress.filter((t) => t.data.status === 'completed').length;\r\n      const totalTasks = taskProgress.length;\r\n      const completionPercentage =\r\n        totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;\r\n\r\n      // Create checkpoint data\r\n      const checkpointData = {\r\n        timestamp: new Date().toISOString(),\r\n        changeCount: this.pendingChanges.length,\r\n        changesByType,\r\n        statistics: {\r\n          tasksProcessed: taskProgress.length,\r\n          tasksCompleted: completedTasks,\r\n          memoryUpdates: (changesByType.memory_update || []).length,\r\n          agentActivities: (changesByType.agent_activity || []).length,\r\n          consensusDecisions: (changesByType.consensus_reached || []).length,\r\n        },\r\n      };\r\n\r\n      // Save checkpoint\r\n      const checkpointName = `auto-save-${Date.now()}`;\r\n      await this.sessionManager.saveCheckpoint(this.sessionId, checkpointName, checkpointData);\r\n\r\n      // Update session progress\r\n      if (completionPercentage > 0) {\r\n        await this.sessionManager.updateSessionProgress(this.sessionId, completionPercentage);\r\n      }\r\n\r\n      // Log all changes as session events\r\n      for (const change of this.pendingChanges) {\r\n        this.sessionManager.logSessionEvent(\r\n          this.sessionId,\r\n          'info',\r\n          `Auto-save: ${change.type}`,\r\n          change.data.agentId || null,\r\n          change.data,\r\n        );\r\n      }\r\n\r\n      // Clear pending changes\r\n      this.pendingChanges = [];\r\n    } catch (error) {\r\n      console.error('Auto-save failed:', error);\r\n      // Keep changes for next attempt\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Force immediate save\r\n   */\r\n  async forceSave() {\r\n    await this.performAutoSave();\r\n  }\r\n\r\n  /**\r\n   * Get pending changes count\r\n   */\r\n  getPendingChangesCount() {\r\n    return this.pendingChanges.length;\r\n  }\r\n\r\n  /**\r\n   * Check if auto-save is active\r\n   */\r\n  isAutoSaveActive() {\r\n    return this.isActive;\r\n  }\r\n\r\n  /**\r\n   * Register a child process\r\n   */\r\n  registerChildProcess(childProcess) {\r\n    if (childProcess && childProcess.pid) {\r\n      this.childProcesses.add(childProcess);\r\n      this.sessionManager.addChildPid(this.sessionId, childProcess.pid);\r\n\r\n      // Remove from tracking when process exits\r\n      childProcess.on('exit', () => {\r\n        this.childProcesses.delete(childProcess);\r\n        this.sessionManager.removeChildPid(this.sessionId, childProcess.pid);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up all resources and child processes\r\n   */\r\n  async cleanup() {\r\n    try {\r\n      // Stop the save timer\r\n      if (this.saveTimer) {\r\n        clearInterval(this.saveTimer);\r\n        this.saveTimer = null;\r\n      }\r\n\r\n      // Perform final save\r\n      await this.performAutoSave();\r\n\r\n      // Terminate all child processes\r\n      for (const childProcess of this.childProcesses) {\r\n        try {\r\n          if (childProcess.pid) {\r\n            console.log(`Terminating child process ${childProcess.pid}...`);\r\n            childProcess.kill('SIGTERM');\r\n\r\n            // Give it a moment to terminate gracefully\r\n            await new Promise((resolve) => setTimeout(resolve, 100));\r\n\r\n            // Force kill if still alive\r\n            try {\r\n              process.kill(childProcess.pid, 0); // Check if still alive\r\n              childProcess.kill('SIGKILL');\r\n            } catch (e) {\r\n              // Process already dead, good\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error(`Failed to terminate child process:`, error.message);\r\n        }\r\n      }\r\n\r\n      // Clear the set\r\n      this.childProcesses.clear();\r\n\r\n      // Stop the session if it's still active\r\n      const session = await this.sessionManager.getSession(this.sessionId);\r\n      if (session && (session.status === 'active' || session.status === 'paused')) {\r\n        await this.sessionManager.stopSession(this.sessionId);\r\n      }\r\n\r\n      // Close database connection\r\n      this.sessionManager.close();\r\n\r\n      console.log('Cleanup completed successfully');\r\n    } catch (error) {\r\n      console.error('Error during cleanup:', error);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Create auto-save middleware for a session\r\n */\r\nexport function createAutoSaveMiddleware(sessionId, sessionManager, options = {}) {\r\n  const saveInterval = options.saveInterval || 30000; // Default 30 seconds\r\n  const middleware = new AutoSaveMiddleware(sessionId, sessionManager, saveInterval);\r\n\r\n  if (options.autoStart !== false) {\r\n    middleware.start();\r\n  }\r\n\r\n  return middleware;\r\n}\r\n\r\n// Export for use in swarm operations\r\nexport default AutoSaveMiddleware;\r\n"],"names":["AutoSaveMiddleware","sessionId","sessionManager","saveInterval","saveTimer","pendingChanges","isActive","childProcesses","Set","start","setInterval","length","performAutoSave","process","on","console","log","cleanup","exit","stop","clearInterval","close","trackChange","changeType","data","push","type","timestamp","Date","toISOString","trackTaskProgress","taskId","status","result","trackAgentActivity","agentId","activity","trackMemoryUpdate","key","value","trackConsensusDecision","topic","decision","votes","changesByType","reduce","acc","change","taskProgress","task_progress","completedTasks","filter","t","totalTasks","completionPercentage","Math","round","checkpointData","changeCount","statistics","tasksProcessed","tasksCompleted","memoryUpdates","memory_update","agentActivities","agent_activity","consensusDecisions","consensus_reached","checkpointName","now","saveCheckpoint","updateSessionProgress","logSessionEvent","error","forceSave","getPendingChangesCount","isAutoSaveActive","registerChildProcess","childProcess","pid","add","addChildPid","delete","removeChildPid","kill","Promise","resolve","setTimeout","e","message","clear","session","getSession","stopSession","createAutoSaveMiddleware","options","middleware","autoStart"],"mappings":"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"}
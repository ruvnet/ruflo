{"version":3,"sources":["../../../src/sdk/compatibility-layer.ts"],"sourcesContent":["/**\r\n * SDK Compatibility Layer\r\n * Claude-Flow v2.5-alpha.130\r\n *\r\n * Maintains backward compatibility while transitioning to SDK\r\n */\r\n\r\nimport { ClaudeFlowSDKAdapter } from './sdk-config.js';\r\nimport Anthropic from '@anthropic-ai/sdk';\r\n\r\n/**\r\n * Compatibility layer to maintain backward compatibility\r\n * while transitioning from custom implementations to SDK\r\n */\r\nexport class SDKCompatibilityLayer {\r\n  private adapter: ClaudeFlowSDKAdapter;\r\n  private legacyMode: boolean = false;\r\n  private deprecationWarnings: Set<string> = new Set();\r\n\r\n  constructor(adapter: ClaudeFlowSDKAdapter) {\r\n    this.adapter = adapter;\r\n  }\r\n\r\n  /**\r\n   * Enable legacy mode for full backward compatibility\r\n   */\r\n  enableLegacyMode(): void {\r\n    this.legacyMode = true;\r\n    console.warn('[Compatibility] Legacy mode enabled. Please migrate to SDK methods.');\r\n  }\r\n\r\n  /**\r\n   * Wrapper for legacy retry logic that delegates to SDK\r\n   */\r\n  async executeWithRetry<T>(\r\n    fn: () => Promise<T>,\r\n    options?: {\r\n      maxRetries?: number;\r\n      backoffMultiplier?: number;\r\n      initialDelay?: number;\r\n    }\r\n  ): Promise<T> {\r\n    this.logDeprecation('executeWithRetry', 'SDK handles retry automatically');\r\n\r\n    if (this.legacyMode) {\r\n      // Fallback to legacy implementation if needed\r\n      return this.legacyRetry(fn, options);\r\n    }\r\n\r\n    // Use SDK's built-in retry by wrapping in a message call\r\n    try {\r\n      return await fn();\r\n    } catch (error) {\r\n      // SDK will have already retried based on configuration\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Legacy calculateBackoff - now handled by SDK\r\n   */\r\n  calculateBackoff(attempt: number): number {\r\n    this.logDeprecation('calculateBackoff', 'SDK handles backoff automatically');\r\n\r\n    if (this.legacyMode) {\r\n      const baseDelay = 1000;\r\n      const jitter = Math.random() * 1000;\r\n      return Math.min(\r\n        baseDelay * Math.pow(2, attempt - 1) + jitter,\r\n        30000 // Max 30 seconds\r\n      );\r\n    }\r\n\r\n    // Return a dummy value since SDK handles this\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Legacy persistToDisk - now handled by SDK artifacts\r\n   */\r\n  async persistToDisk(key: string, value: unknown): Promise<void> {\r\n    this.logDeprecation('persistToDisk', 'Use SDK artifacts for persistence');\r\n\r\n    if (this.legacyMode) {\r\n      // Legacy file-based persistence\r\n      const fs = await import('fs/promises');\r\n      const path = await import('path');\r\n      const storagePath = '.claude-flow/storage';\r\n      await fs.mkdir(storagePath, { recursive: true });\r\n      await fs.writeFile(\r\n        path.join(storagePath, `${key}.json`),\r\n        JSON.stringify(value, null, 2)\r\n      );\r\n      return;\r\n    }\r\n\r\n    // In SDK mode, this is a no-op as persistence is automatic\r\n    console.log(`[Compatibility] Persistence for '${key}' is handled automatically by SDK`);\r\n  }\r\n\r\n  /**\r\n   * Legacy executeValidations - now handled by SDK\r\n   */\r\n  async executeValidations(checkpointId: string): Promise<boolean> {\r\n    this.logDeprecation('executeValidations', 'SDK handles validations automatically');\r\n\r\n    if (this.legacyMode) {\r\n      // Legacy validation logic\r\n      console.log(`[Compatibility] Running legacy validations for checkpoint ${checkpointId}`);\r\n      return true;\r\n    }\r\n\r\n    // SDK handles this automatically\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Map old ClaudeRequest format to SDK format\r\n   */\r\n  mapLegacyRequest(legacyRequest: Record<string, unknown>): Anthropic.MessageCreateParams {\r\n    return {\r\n      model: this.mapLegacyModel(legacyRequest.model as string),\r\n      messages: (legacyRequest.messages as Anthropic.MessageParam[]) || [],\r\n      max_tokens: (legacyRequest.max_tokens as number) || 1024,\r\n      temperature: legacyRequest.temperature as number | undefined,\r\n      top_p: legacyRequest.top_p as number | undefined,\r\n      top_k: legacyRequest.top_k as number | undefined,\r\n      stop_sequences: legacyRequest.stop_sequences as string[] | undefined,\r\n      system: legacyRequest.system as string | undefined,\r\n      metadata: legacyRequest.metadata as Anthropic.Metadata | undefined\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Map old model names to SDK model names\r\n   */\r\n  private mapLegacyModel(model: string): Anthropic.Model {\r\n    const modelMap: Record<string, Anthropic.Model> = {\r\n      'claude-2.1': 'claude-2.1',\r\n      'claude-2.0': 'claude-2.1', // Map to closest available\r\n      'claude-instant-1.2': 'claude-instant-1.2',\r\n      'claude-3-opus-20240229': 'claude-3-opus-20240229',\r\n      'claude-3-sonnet-20240229': 'claude-3-sonnet-20240229',\r\n      'claude-3-haiku-20240307': 'claude-3-haiku-20240307'\r\n    };\r\n\r\n    return modelMap[model] || 'claude-3-sonnet-20240229';\r\n  }\r\n\r\n  /**\r\n   * Map SDK response to legacy format\r\n   */\r\n  mapSDKResponse(sdkResponse: Anthropic.Message): Record<string, unknown> {\r\n    return {\r\n      id: sdkResponse.id,\r\n      type: 'message',\r\n      role: sdkResponse.role,\r\n      content: sdkResponse.content,\r\n      model: sdkResponse.model,\r\n      stop_reason: sdkResponse.stop_reason,\r\n      stop_sequence: sdkResponse.stop_sequence,\r\n      usage: sdkResponse.usage\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Legacy retry implementation for fallback\r\n   */\r\n  private async legacyRetry<T>(\r\n    fn: () => Promise<T>,\r\n    options?: {\r\n      maxRetries?: number;\r\n      backoffMultiplier?: number;\r\n      initialDelay?: number;\r\n    }\r\n  ): Promise<T> {\r\n    const maxRetries = options?.maxRetries || 3;\r\n    const backoffMultiplier = options?.backoffMultiplier || 2;\r\n    const initialDelay = options?.initialDelay || 1000;\r\n\r\n    let lastError: any;\r\n\r\n    for (let i = 0; i < maxRetries; i++) {\r\n      try {\r\n        return await fn();\r\n      } catch (error) {\r\n        lastError = error;\r\n\r\n        if (i < maxRetries - 1) {\r\n          const delay = initialDelay * Math.pow(backoffMultiplier, i);\r\n          await this.sleep(delay);\r\n        }\r\n      }\r\n    }\r\n\r\n    throw lastError;\r\n  }\r\n\r\n  /**\r\n   * Helper sleep function\r\n   */\r\n  private sleep(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * Log deprecation warning once per method\r\n   */\r\n  private logDeprecation(method: string, suggestion: string): void {\r\n    if (!this.deprecationWarnings.has(method)) {\r\n      console.warn(\r\n        `[Deprecation] '${method}' is deprecated. ${suggestion}. ` +\r\n        `This will be removed in v3.0.0.`\r\n      );\r\n      this.deprecationWarnings.add(method);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get deprecation report\r\n   */\r\n  getDeprecationReport(): string[] {\r\n    return Array.from(this.deprecationWarnings);\r\n  }\r\n\r\n  /**\r\n   * Check if running in legacy mode\r\n   */\r\n  isLegacyMode(): boolean {\r\n    return this.legacyMode;\r\n  }\r\n}\r\n\r\n// Export singleton for convenience\r\nexport const createCompatibilityLayer = (\r\n  adapter: ClaudeFlowSDKAdapter\r\n): SDKCompatibilityLayer => {\r\n  return new SDKCompatibilityLayer(adapter);\r\n};"],"names":["SDKCompatibilityLayer","adapter","legacyMode","deprecationWarnings","Set","enableLegacyMode","console","warn","executeWithRetry","fn","options","logDeprecation","legacyRetry","error","calculateBackoff","attempt","baseDelay","jitter","Math","random","min","pow","persistToDisk","key","value","fs","path","storagePath","mkdir","recursive","writeFile","join","JSON","stringify","log","executeValidations","checkpointId","mapLegacyRequest","legacyRequest","model","mapLegacyModel","messages","max_tokens","temperature","top_p","top_k","stop_sequences","system","metadata","modelMap","mapSDKResponse","sdkResponse","id","type","role","content","stop_reason","stop_sequence","usage","maxRetries","backoffMultiplier","initialDelay","lastError","i","delay","sleep","ms","Promise","resolve","setTimeout","method","suggestion","has","add","getDeprecationReport","Array","from","isLegacyMode","createCompatibilityLayer"],"mappings":"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"}
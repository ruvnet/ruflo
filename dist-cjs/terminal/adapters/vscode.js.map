{
  "version": 3,
  "sources": ["../../../src/terminal/adapters/vscode.ts"],
  "sourcesContent": ["/**\n * VSCode terminal adapter implementation\n */\n\nimport { platform } from 'os';\nimport type { ITerminalAdapter, Terminal } from './base.js';\nimport type { ILogger } from '../../core/logger.js';\nimport { TerminalError } from '../../utils/errors.js';\nimport { generateId, delay, timeout, createDeferred } from '../../utils/helpers.js';\n\n/**\n * VSCode API interface (injected via extension)\n */\ninterface VSCodeAPI {\n  window: {\n    createTerminal(options: {\n      name: string;\n      shellPath?: string;\n      shellArgs?: string[];\n      env?: Record<string, string>;\n    }): VSCodeTerminal;\n    onDidCloseTerminal(listener: (terminal: VSCodeTerminal) => void): { dispose(): void };\n  };\n}\n\ninterface VSCodeTerminal {\n  name: string;\n  processId: Promise<number | undefined>;\n  sendText(text: string, addNewLine?: boolean): void;\n  show(preserveFocus?: boolean): void;\n  hide(): void;\n  dispose(): void;\n}\n\n/**\n * VSCode terminal implementation\n */\nclass VSCodeTerminalWrapper implements Terminal {\n  id: string;\n  pid?: number;\n  private vscodeTerminal?: VSCodeTerminal;\n  private outputBuffer = '';\n  private commandMarker: string;\n  private outputDeferred = createDeferred<string>();\n  private isDisposed = false;\n\n  constructor(\n    private vscodeApi: VSCodeAPI,\n    private shellType: string,\n    private logger: ILogger,\n  ) {\n    this.id = generateId('vscode-term');\n    this.commandMarker = `__CLAUDE_FLOW_${this.id}__`;\n  }\n\n  async initialize(): Promise<void> {\n    try {\n      // Create VSCode terminal\n      const shellPath = this.getShellPath();\n      const terminalOptions: any = {\n        name: `Claude-Flow Terminal ${this.id}`,\n        shellArgs: this.getShellArgs(),\n        env: {\n          CLAUDE_FLOW_TERMINAL: 'true',\n          CLAUDE_FLOW_TERMINAL_ID: this.id,\n          PS1: '$ ', // Simple prompt\n        },\n      };\n      if (shellPath !== undefined) {\n        terminalOptions.shellPath = shellPath;\n      }\n      this.vscodeTerminal = this.vscodeApi.window.createTerminal(terminalOptions);\n\n      // Get process ID\n      const processId = await this.vscodeTerminal.processId;\n      if (processId !== undefined) {\n        this.pid = processId;\n      }\n\n      // Show terminal (but don't steal focus)\n      this.vscodeTerminal.show(true);\n\n      // Wait for terminal to be ready\n      await this.waitForReady();\n\n      this.logger.debug('VSCode terminal initialized', { id: this.id, pid: this.pid });\n    } catch (error) {\n      throw new TerminalError('Failed to create VSCode terminal', { error });\n    }\n  }\n\n  async executeCommand(command: string): Promise<string> {\n    if (!this.vscodeTerminal || !this.isAlive()) {\n      throw new TerminalError('Terminal is not alive');\n    }\n\n    try {\n      // Clear output buffer\n      this.outputBuffer = '';\n      this.outputDeferred = createDeferred<string>();\n\n      // Send command with marker\n      const markedCommand = `${command} && echo \"${this.commandMarker}\"`;\n      this.vscodeTerminal.sendText(markedCommand, true);\n\n      // Wait for command to complete\n      const output = await timeout(this.outputDeferred.promise, 30000, 'Command execution timeout');\n\n      return output;\n    } catch (error) {\n      throw new TerminalError('Failed to execute command', { command, error });\n    }\n  }\n\n  async write(data: string): Promise<void> {\n    if (!this.vscodeTerminal || !this.isAlive()) {\n      throw new TerminalError('Terminal is not alive');\n    }\n\n    this.vscodeTerminal.sendText(data, false);\n  }\n\n  async read(): Promise<string> {\n    if (!this.vscodeTerminal || !this.isAlive()) {\n      throw new TerminalError('Terminal is not alive');\n    }\n\n    // Return buffered output\n    const output = this.outputBuffer;\n    this.outputBuffer = '';\n    return output;\n  }\n\n  isAlive(): boolean {\n    return !this.isDisposed && this.vscodeTerminal !== undefined;\n  }\n\n  async kill(): Promise<void> {\n    if (this.vscodeTerminal && !this.isDisposed) {\n      try {\n        // Try graceful shutdown first\n        this.vscodeTerminal.sendText('exit', true);\n        await delay(500);\n\n        // Dispose terminal\n        this.vscodeTerminal.dispose();\n        this.isDisposed = true;\n      } catch (error) {\n        this.logger.warn('Error killing VSCode terminal', { id: this.id, error });\n      }\n    }\n  }\n\n  /**\n   * Process terminal output (called by extension)\n   */\n  processOutput(data: string): void {\n    this.outputBuffer += data;\n\n    // Check for command completion marker\n    const markerIndex = this.outputBuffer.indexOf(this.commandMarker);\n    if (markerIndex !== -1) {\n      // Extract output before marker\n      const output = this.outputBuffer.substring(0, markerIndex).trim();\n\n      // Clear buffer up to after marker\n      this.outputBuffer = this.outputBuffer\n        .substring(markerIndex + this.commandMarker.length)\n        .trim();\n\n      // Resolve pending command\n      this.outputDeferred.resolve(output);\n    }\n  }\n\n  private getShellPath(): string | undefined {\n    switch (this.shellType) {\n      case 'bash':\n        return '/bin/bash';\n      case 'zsh':\n        return '/bin/zsh';\n      case 'powershell':\n        return platform() === 'win32' ? 'powershell.exe' : 'pwsh';\n      case 'cmd':\n        return platform() === 'win32' ? 'cmd.exe' : undefined;\n      default:\n        return undefined;\n    }\n  }\n\n  private getShellArgs(): string[] {\n    switch (this.shellType) {\n      case 'bash':\n        return ['--norc', '--noprofile'];\n      case 'zsh':\n        return ['--no-rcs'];\n      case 'powershell':\n        return ['-NoProfile', '-NonInteractive'];\n      case 'cmd':\n        return ['/Q'];\n      default:\n        return [];\n    }\n  }\n\n  private async waitForReady(): Promise<void> {\n    // Send a test command to ensure terminal is ready\n    this.vscodeTerminal!.sendText('echo \"READY\"', true);\n\n    const startTime = Date.now();\n    while (Date.now() - startTime < 5000) {\n      if (this.outputBuffer.includes('READY')) {\n        this.outputBuffer = '';\n        return;\n      }\n      await delay(100);\n    }\n\n    throw new TerminalError('Terminal failed to become ready');\n  }\n}\n\n/**\n * VSCode terminal adapter\n */\nexport class VSCodeAdapter implements ITerminalAdapter {\n  private terminals = new Map<string, VSCodeTerminalWrapper>();\n  private vscodeApi?: VSCodeAPI;\n  private shellType: string;\n  private terminalCloseListener?: { dispose(): void };\n\n  constructor(private logger: ILogger) {\n    this.shellType = this.detectShell();\n  }\n\n  async initialize(): Promise<void> {\n    this.logger.info('Initializing VSCode terminal adapter');\n\n    // Check if running in VSCode extension context\n    if (!this.isVSCodeExtensionContext()) {\n      throw new TerminalError('Not running in VSCode extension context');\n    }\n\n    // Get VSCode API from global\n    this.vscodeApi = (globalThis as any).vscode;\n    if (!this.vscodeApi) {\n      throw new TerminalError('VSCode API not available');\n    }\n\n    // Register terminal close listener\n    this.terminalCloseListener = this.vscodeApi.window.onDidCloseTerminal((terminal) => {\n      // Find and clean up closed terminal\n      for (const [id, wrapper] of this.terminals.entries()) {\n        if ((wrapper as any).vscodeTerminal === terminal) {\n          this.logger.info('VSCode terminal closed', { id });\n          this.terminals.delete(id);\n          break;\n        }\n      }\n    });\n\n    this.logger.info('VSCode terminal adapter initialized');\n  }\n\n  async shutdown(): Promise<void> {\n    this.logger.info('Shutting down VSCode terminal adapter');\n\n    // Dispose listener\n    if (this.terminalCloseListener) {\n      this.terminalCloseListener.dispose();\n    }\n\n    // Kill all terminals\n    const terminals = Array.from(this.terminals.values());\n    await Promise.all(terminals.map((term) => term.kill()));\n\n    this.terminals.clear();\n  }\n\n  async createTerminal(): Promise<Terminal> {\n    if (!this.vscodeApi) {\n      throw new TerminalError('VSCode API not initialized');\n    }\n\n    const terminal = new VSCodeTerminalWrapper(this.vscodeApi, this.shellType, this.logger);\n\n    await terminal.initialize();\n    this.terminals.set(terminal.id, terminal);\n\n    // Register output processor if extension provides it\n    const outputProcessor = (globalThis as any).registerTerminalOutputProcessor;\n    if (outputProcessor) {\n      outputProcessor(terminal.id, (data: string) => terminal.processOutput(data));\n    }\n\n    return terminal;\n  }\n\n  async destroyTerminal(terminal: Terminal): Promise<void> {\n    await terminal.kill();\n    this.terminals.delete(terminal.id);\n  }\n\n  private isVSCodeExtensionContext(): boolean {\n    // Check for VSCode extension environment\n    return (\n      typeof (globalThis as any).vscode !== 'undefined' &&\n      typeof (globalThis as any).vscode.window !== 'undefined'\n    );\n  }\n\n  private detectShell(): string {\n    // Get default shell from VSCode settings or environment\n    const osplatform = platform();\n\n    if (osplatform === 'win32') {\n      // Windows defaults\n      const comspec = process.env.COMSPEC;\n      if (comspec?.toLowerCase().includes('powershell')) {\n        return 'powershell';\n      }\n      return 'cmd';\n    } else {\n      // Unix-like defaults\n      const shell = process.env.SHELL;\n      if (shell) {\n        const shellName = shell.split('/').pop();\n        if (shellName && ['bash', 'zsh', 'fish', 'sh'].includes(shellName)) {\n          return shellName;\n        }\n      }\n      return 'bash';\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

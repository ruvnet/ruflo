{"version":3,"sources":["../../../../src/mcp/validation/schema-validator-2025.ts"],"sourcesContent":["/**\r\n * JSON Schema 1.1 Validator for MCP 2025-11\r\n *\r\n * Implements comprehensive schema validation per MCP 2025-11 specification\r\n * using JSON Schema Draft 2020-12\r\n */\r\n\r\nimport Ajv, { type ErrorObject } from 'ajv';\r\nimport addFormats from 'ajv-formats';\r\nimport addErrors from 'ajv-errors';\r\nimport type { ILogger } from '../../interfaces/logger.js';\r\n\r\n/**\r\n * Validation result\r\n */\r\nexport interface ValidationResult {\r\n  valid: boolean;\r\n  errors?: Array<{\r\n    path: string;\r\n    message: string;\r\n    params?: any;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Schema cache entry\r\n */\r\ninterface CachedSchema {\r\n  schema: object;\r\n  validate: any;\r\n  timestamp: number;\r\n}\r\n\r\n/**\r\n * MCP 2025-11 JSON Schema Validator\r\n *\r\n * Features:\r\n * - JSON Schema Draft 2020-12 support\r\n * - Format validation (uri, email, date-time, etc.)\r\n * - Schema caching for performance\r\n * - Custom error messages\r\n * - $ref support\r\n */\r\nexport class SchemaValidator {\r\n  private ajv: Ajv;\r\n  private schemaCache: Map<string, CachedSchema> = new Map();\r\n  private cacheTTL = 3600000; // 1 hour\r\n  private readonly MAX_CACHE_SIZE = 1000; // Maximum cached schemas\r\n\r\n  constructor(private logger: ILogger) {\r\n    this.ajv = new Ajv({\r\n      allErrors: true,\r\n      strict: true,\r\n      validateFormats: true,\r\n      allowUnionTypes: true,\r\n      // Support JSON Schema Draft 2020-12\r\n      schemaId: 'auto',\r\n    });\r\n\r\n    // Add format validators (email, uri, date-time, etc.)\r\n    addFormats(this.ajv);\r\n\r\n    // Add custom error messages support\r\n    addErrors(this.ajv);\r\n\r\n    this.logger.info('Schema validator initialized', {\r\n      draft: '2020-12',\r\n      formats: 'enabled',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate input against JSON Schema 1.1\r\n   */\r\n  validateInput(schema: object, input: unknown): ValidationResult {\r\n    try {\r\n      const validate = this.getValidator(schema);\r\n      const valid = validate(input);\r\n\r\n      if (!valid && validate.errors) {\r\n        return {\r\n          valid: false,\r\n          errors: this.formatErrors(validate.errors),\r\n        };\r\n      }\r\n\r\n      return { valid: true };\r\n    } catch (error) {\r\n      this.logger.error('Schema validation error', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n\r\n      return {\r\n        valid: false,\r\n        errors: [{\r\n          path: '',\r\n          message: 'Schema validation failed',\r\n        }],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate output against schema\r\n   */\r\n  validateOutput(schema: object, output: unknown): ValidationResult {\r\n    return this.validateInput(schema, output);\r\n  }\r\n\r\n  /**\r\n   * Validate tool schema itself\r\n   */\r\n  validateToolSchema(toolSchema: object): ValidationResult {\r\n    // Ensure schema has required fields\r\n    const requiredFields = ['$schema', 'type', 'properties'];\r\n    const schemaObj = toolSchema as any;\r\n\r\n    const missing = requiredFields.filter(field => !(field in schemaObj));\r\n    if (missing.length > 0) {\r\n      return {\r\n        valid: false,\r\n        errors: missing.map(field => ({\r\n          path: '/',\r\n          message: `Missing required field: ${field}`,\r\n        })),\r\n      };\r\n    }\r\n\r\n    // Validate schema is valid JSON Schema\r\n    try {\r\n      this.ajv.compile(toolSchema);\r\n      return { valid: true };\r\n    } catch (error) {\r\n      return {\r\n        valid: false,\r\n        errors: [{\r\n          path: '/',\r\n          message: error instanceof Error ? error.message : 'Invalid schema',\r\n        }],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or create validator for schema\r\n   */\r\n  private getValidator(schema: object): any {\r\n    const schemaKey = JSON.stringify(schema);\r\n    const cached = this.schemaCache.get(schemaKey);\r\n\r\n    // Return cached validator if still valid\r\n    if (cached && Date.now() - cached.timestamp < this.cacheTTL) {\r\n      return cached.validate;\r\n    }\r\n\r\n    // Compile new validator\r\n    try {\r\n      const validate = this.ajv.compile(schema);\r\n\r\n      // Enforce cache size limit (LRU eviction - remove oldest entry)\r\n      if (this.schemaCache.size >= this.MAX_CACHE_SIZE) {\r\n        const oldest = Array.from(this.schemaCache.entries())\r\n          .sort((a, b) => a[1].timestamp - b[1].timestamp)[0];\r\n\r\n        if (oldest) {\r\n          this.schemaCache.delete(oldest[0]);\r\n          this.logger.debug('Evicted oldest schema from cache', {\r\n            cacheSize: this.schemaCache.size,\r\n            maxSize: this.MAX_CACHE_SIZE,\r\n          });\r\n        }\r\n      }\r\n\r\n      // Cache for future use\r\n      this.schemaCache.set(schemaKey, {\r\n        schema,\r\n        validate,\r\n        timestamp: Date.now(),\r\n      });\r\n\r\n      return validate;\r\n    } catch (error) {\r\n      this.logger.error('Failed to compile schema', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Format ajv errors to user-friendly format\r\n   */\r\n  private formatErrors(errors: ErrorObject[]): ValidationResult['errors'] {\r\n    return errors.map(err => ({\r\n      path: err.instancePath || '/',\r\n      message: this.getErrorMessage(err),\r\n      params: err.params,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Get user-friendly error message\r\n   */\r\n  private getErrorMessage(error: ErrorObject): string {\r\n    const { keyword, message, params } = error;\r\n\r\n    switch (keyword) {\r\n      case 'required':\r\n        return `Missing required property: ${params.missingProperty}`;\r\n      case 'type':\r\n        return `Expected ${params.type} but got ${typeof params.data}`;\r\n      case 'format':\r\n        return `Invalid format for ${params.format}`;\r\n      case 'minimum':\r\n        return `Value must be >= ${params.limit}`;\r\n      case 'maximum':\r\n        return `Value must be <= ${params.limit}`;\r\n      case 'minLength':\r\n        return `String must be at least ${params.limit} characters`;\r\n      case 'maxLength':\r\n        return `String must be at most ${params.limit} characters`;\r\n      case 'pattern':\r\n        return `String must match pattern: ${params.pattern}`;\r\n      case 'enum':\r\n        return `Value must be one of: ${params.allowedValues?.join(', ')}`;\r\n      default:\r\n        return message || `Validation failed: ${keyword}`;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear schema cache\r\n   */\r\n  clearCache(): void {\r\n    this.schemaCache.clear();\r\n    this.logger.info('Schema cache cleared');\r\n  }\r\n\r\n  /**\r\n   * Get cache statistics\r\n   */\r\n  getCacheStats() {\r\n    return {\r\n      size: this.schemaCache.size,\r\n      entries: Array.from(this.schemaCache.values()).map(entry => ({\r\n        age: Date.now() - entry.timestamp,\r\n        expired: Date.now() - entry.timestamp > this.cacheTTL,\r\n      })),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Cleanup expired cache entries\r\n   */\r\n  cleanupCache(): number {\r\n    const now = Date.now();\r\n    let cleaned = 0;\r\n\r\n    for (const [key, entry] of this.schemaCache.entries()) {\r\n      if (now - entry.timestamp > this.cacheTTL) {\r\n        this.schemaCache.delete(key);\r\n        cleaned++;\r\n      }\r\n    }\r\n\r\n    if (cleaned > 0) {\r\n      this.logger.info('Cleaned up expired schema cache entries', { count: cleaned });\r\n    }\r\n\r\n    return cleaned;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert legacy tool schema to MCP 2025-11 format\r\n */\r\nexport function upgradeToolSchema(legacySchema: any): object {\r\n  // If already in 2025-11 format, return as-is\r\n  if (legacySchema.$schema && legacySchema.$schema.includes('2020-12')) {\r\n    return legacySchema;\r\n  }\r\n\r\n  // Convert to 2025-11 format\r\n  return {\r\n    $schema: 'https://json-schema.org/draft/2020-12/schema',\r\n    type: legacySchema.type || 'object',\r\n    properties: legacySchema.properties || {},\r\n    required: legacySchema.required || [],\r\n    additionalProperties: legacySchema.additionalProperties !== undefined\r\n      ? legacySchema.additionalProperties\r\n      : false,\r\n    description: legacySchema.description,\r\n  };\r\n}\r\n"],"names":["Ajv","addFormats","addErrors","SchemaValidator","ajv","schemaCache","Map","cacheTTL","MAX_CACHE_SIZE","logger","allErrors","strict","validateFormats","allowUnionTypes","schemaId","info","draft","formats","validateInput","schema","input","validate","getValidator","valid","errors","formatErrors","error","Error","message","String","path","validateOutput","output","validateToolSchema","toolSchema","requiredFields","schemaObj","missing","filter","field","length","map","compile","schemaKey","JSON","stringify","cached","get","Date","now","timestamp","size","oldest","Array","from","entries","sort","a","b","delete","debug","cacheSize","maxSize","set","err","instancePath","getErrorMessage","params","keyword","missingProperty","type","data","format","limit","pattern","allowedValues","join","clearCache","clear","getCacheStats","values","entry","age","expired","cleanupCache","cleaned","key","count","upgradeToolSchema","legacySchema","$schema","includes","properties","required","additionalProperties","undefined","description"],"mappings":"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"}
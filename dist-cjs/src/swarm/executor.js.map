{"version":3,"sources":["../../../src/swarm/executor.ts"],"sourcesContent":["/**\r\n * Advanced Task Executor with timeout handling and process management\r\n */\r\n\r\nimport { spawn, ChildProcess } from 'node:child_process';\r\nimport { EventEmitter } from 'node:events';\r\nimport * as fs from 'node:fs/promises';\r\nimport * as path from 'node:path';\r\nimport * as os from 'node:os';\r\nimport { Logger } from '../core/logger.js';\r\nimport { generateId } from '../utils/helpers.js';\r\nimport {\r\n  TaskDefinition,\r\n  AgentState,\r\n  TaskResult,\r\n  SwarmEvent,\r\n  EventType,\r\n  SWARM_CONSTANTS,\r\n} from './types.js';\r\n\r\nexport interface ExecutionContext {\r\n  task: TaskDefinition;\r\n  agent: AgentState;\r\n  workingDirectory: string;\r\n  tempDirectory: string;\r\n  logDirectory: string;\r\n  environment: Record<string, string>;\r\n  resources: ExecutionResources;\r\n}\r\n\r\nexport interface ExecutionResources {\r\n  maxMemory: number;\r\n  maxCpuTime: number;\r\n  maxDiskSpace: number;\r\n  maxNetworkConnections: number;\r\n  maxFileHandles: number;\r\n  priority: number;\r\n}\r\n\r\nexport interface ExecutionResult {\r\n  success: boolean;\r\n  output: string;\r\n  error?: string;\r\n  exitCode: number;\r\n  duration: number;\r\n  resourcesUsed: ResourceUsage;\r\n  artifacts: Record<string, any>;\r\n  metadata: Record<string, any>;\r\n}\r\n\r\nexport interface ResourceUsage {\r\n  cpuTime: number;\r\n  maxMemory: number;\r\n  diskIO: number;\r\n  networkIO: number;\r\n  fileHandles: number;\r\n}\r\n\r\nexport interface ExecutionConfig {\r\n  timeoutMs: number;\r\n  retryAttempts: number;\r\n  killTimeout: number;\r\n  resourceLimits: ExecutionResources;\r\n  sandboxed: boolean;\r\n  logLevel: string;\r\n  captureOutput: boolean;\r\n  streamOutput: boolean;\r\n  enableMetrics: boolean;\r\n}\r\n\r\nexport class TaskExecutor extends EventEmitter {\r\n  private logger: Logger;\r\n  private config: ExecutionConfig;\r\n  private activeExecutions: Map<string, ExecutionSession> = new Map();\r\n  private resourceMonitor: ResourceMonitor;\r\n  private processPool: ProcessPool;\r\n\r\n  constructor(config: Partial<ExecutionConfig> = {}) {\r\n    super();\r\n\r\n    this.config = this.mergeWithDefaults(config);\r\n    this.logger = new Logger(\r\n      { level: this.config.logLevel || 'info', format: 'text', destination: 'console' },\r\n      { component: 'TaskExecutor' },\r\n    );\r\n    this.resourceMonitor = new ResourceMonitor();\r\n    this.processPool = new ProcessPool(this.config);\r\n\r\n    this.setupEventHandlers();\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    this.logger.info('Initializing task executor...');\r\n\r\n    await this.resourceMonitor.initialize();\r\n    await this.processPool.initialize();\r\n\r\n    this.logger.info('Task executor initialized');\r\n  }\r\n\r\n  async shutdown(): Promise<void> {\r\n    this.logger.info('Shutting down task executor...');\r\n\r\n    // Stop all active executions\r\n    const stopPromises = Array.from(this.activeExecutions.values()).map((session) =>\r\n      this.stopExecution(session.id, 'Executor shutdown'),\r\n    );\r\n\r\n    await Promise.allSettled(stopPromises);\r\n\r\n    await this.processPool.shutdown();\r\n    await this.resourceMonitor.shutdown();\r\n\r\n    this.logger.info('Task executor shut down');\r\n  }\r\n\r\n  async executeTask(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    options: Partial<ExecutionConfig> = {},\r\n  ): Promise<ExecutionResult> {\r\n    const sessionId = generateId('execution');\r\n    const context = await this.createExecutionContext(task, agent);\r\n    const config = { ...this.config, ...options };\r\n\r\n    this.logger.info('Starting task execution', {\r\n      sessionId,\r\n      taskId: task.id.id,\r\n      agentId: agent.id.id,\r\n      timeout: config.timeoutMs,\r\n    });\r\n\r\n    const session = new ExecutionSession(sessionId, task, agent, context, config, this.logger);\r\n\r\n    this.activeExecutions.set(sessionId, session);\r\n\r\n    try {\r\n      // Setup monitoring\r\n      this.resourceMonitor.startMonitoring(sessionId, context.resources);\r\n\r\n      // Execute with timeout protection\r\n      const result = await this.executeWithTimeout(session);\r\n\r\n      // Cleanup\r\n      await this.cleanupExecution(session);\r\n\r\n      this.logger.info('Task execution completed', {\r\n        sessionId,\r\n        success: result.success,\r\n        duration: result.duration,\r\n      });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      this.logger.error('Task execution failed', {\r\n        sessionId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n        stack: error.stack,\r\n      });\r\n\r\n      await this.cleanupExecution(session);\r\n      throw error;\r\n    } finally {\r\n      this.activeExecutions.delete(sessionId);\r\n      this.resourceMonitor.stopMonitoring(sessionId);\r\n    }\r\n  }\r\n\r\n  async stopExecution(sessionId: string, reason: string): Promise<void> {\r\n    const session = this.activeExecutions.get(sessionId);\r\n    if (!session) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Stopping execution', { sessionId, reason });\r\n\r\n    try {\r\n      await session.stop(reason);\r\n    } catch (error) {\r\n      this.logger.error('Error stopping execution', { sessionId, error });\r\n    }\r\n  }\r\n\r\n  async executeClaudeTask(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    claudeOptions: ClaudeExecutionOptions = {},\r\n  ): Promise<ExecutionResult> {\r\n    const sessionId = generateId('claude-execution');\r\n    const context = await this.createExecutionContext(task, agent);\r\n\r\n    this.logger.info('Starting Claude task execution', {\r\n      sessionId,\r\n      taskId: task.id.id,\r\n      agentId: agent.id.id,\r\n    });\r\n\r\n    try {\r\n      return await this.executeClaudeWithTimeout(sessionId, task, agent, context, claudeOptions);\r\n    } catch (error) {\r\n      this.logger.error('Claude task execution failed', {\r\n        sessionId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  getActiveExecutions(): ExecutionSession[] {\r\n    return Array.from(this.activeExecutions.values());\r\n  }\r\n\r\n  getExecutionMetrics(): ExecutionMetrics {\r\n    return {\r\n      activeExecutions: this.activeExecutions.size,\r\n      totalExecutions: this.processPool.getTotalExecutions(),\r\n      averageDuration: this.processPool.getAverageDuration(),\r\n      successRate: this.processPool.getSuccessRate(),\r\n      resourceUtilization: this.resourceMonitor.getUtilization(),\r\n      errorRate: this.processPool.getErrorRate(),\r\n    };\r\n  }\r\n\r\n  private async executeWithTimeout(session: ExecutionSession): Promise<ExecutionResult> {\r\n    return new Promise((resolve, reject) => {\r\n      const timeout = setTimeout(() => {\r\n        this.logger.warn('Execution timeout', {\r\n          sessionId: session.id,\r\n          timeout: session.config.timeoutMs,\r\n        });\r\n\r\n        session.stop('Timeout').then(() => {\r\n          reject(new Error(`Execution timed out after ${session.config.timeoutMs}ms`));\r\n        });\r\n      }, session.config.timeoutMs);\r\n\r\n      session\r\n        .execute()\r\n        .then((result) => {\r\n          clearTimeout(timeout);\r\n          resolve(result);\r\n        })\r\n        .catch((error) => {\r\n          clearTimeout(timeout);\r\n          reject(error);\r\n        });\r\n    });\r\n  }\r\n\r\n  private async executeClaudeWithTimeout(\r\n    sessionId: string,\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    context: ExecutionContext,\r\n    options: ClaudeExecutionOptions,\r\n  ): Promise<ExecutionResult> {\r\n    const startTime = Date.now();\r\n    const timeout = options.timeout || this.config.timeoutMs;\r\n\r\n    // Build Claude command\r\n    const command = this.buildClaudeCommand(task, agent, options);\r\n\r\n    // Create execution environment\r\n    const env = {\r\n      ...process.env,\r\n      ...context.environment,\r\n      CLAUDE_TASK_ID: task.id.id,\r\n      CLAUDE_AGENT_ID: agent.id.id,\r\n      CLAUDE_SESSION_ID: sessionId,\r\n      CLAUDE_WORKING_DIR: context.workingDirectory,\r\n    };\r\n\r\n    this.logger.debug('Executing Claude command', {\r\n      sessionId,\r\n      command: command.command,\r\n      args: command.args,\r\n      workingDir: context.workingDirectory,\r\n    });\r\n\r\n    return new Promise((resolve, reject) => {\r\n      let outputBuffer = '';\r\n      let errorBuffer = '';\r\n      let isTimeout = false;\r\n      let process: ChildProcess | null = null;\r\n\r\n      // Setup timeout\r\n      const timeoutHandle = setTimeout(() => {\r\n        isTimeout = true;\r\n        if (process) {\r\n          this.logger.warn('Claude execution timeout, killing process', {\r\n            sessionId,\r\n            pid: process.pid,\r\n            timeout,\r\n          });\r\n\r\n          // Graceful shutdown first\r\n          process.kill('SIGTERM');\r\n\r\n          // Force kill after grace period\r\n          setTimeout(() => {\r\n            if (process && !process.killed) {\r\n              process.kill('SIGKILL');\r\n            }\r\n          }, this.config.killTimeout);\r\n        }\r\n      }, timeout);\r\n\r\n      try {\r\n        // Spawn Claude process\r\n        process = spawn(command.command, command.args, {\r\n          cwd: context.workingDirectory,\r\n          env,\r\n          stdio: ['pipe', 'pipe', 'pipe'],\r\n          detached: options.detached || false,\r\n        });\r\n\r\n        if (!process.pid) {\r\n          clearTimeout(timeoutHandle);\r\n          reject(new Error('Failed to spawn Claude process'));\r\n          return;\r\n        }\r\n\r\n        this.logger.info('Claude process started', {\r\n          sessionId,\r\n          pid: process.pid,\r\n          command: command.command,\r\n        });\r\n\r\n        // Handle process output\r\n        if (process.stdout) {\r\n          process.stdout.on('data', (data: Buffer) => {\r\n            const chunk = data.toString();\r\n            outputBuffer += chunk;\r\n\r\n            if (this.config.streamOutput) {\r\n              this.emit('output', {\r\n                sessionId,\r\n                type: 'stdout',\r\n                data: chunk,\r\n              });\r\n            }\r\n          });\r\n        }\r\n\r\n        if (process.stderr) {\r\n          process.stderr.on('data', (data: Buffer) => {\r\n            const chunk = data.toString();\r\n            errorBuffer += chunk;\r\n\r\n            if (this.config.streamOutput) {\r\n              this.emit('output', {\r\n                sessionId,\r\n                type: 'stderr',\r\n                data: chunk,\r\n              });\r\n            }\r\n          });\r\n        }\r\n\r\n        // Handle process completion\r\n        process.on('close', async (code: number | null, signal: string | null) => {\r\n          clearTimeout(timeoutHandle);\r\n\r\n          const duration = Date.now() - startTime;\r\n          const exitCode = code || 0;\r\n\r\n          this.logger.info('Claude process completed', {\r\n            sessionId,\r\n            exitCode,\r\n            signal,\r\n            duration,\r\n            isTimeout,\r\n          });\r\n\r\n          try {\r\n            // Collect resource usage\r\n            const resourceUsage = await this.collectResourceUsage(sessionId);\r\n\r\n            // Collect artifacts\r\n            const artifacts = await this.collectArtifacts(context);\r\n\r\n            const result: ExecutionResult = {\r\n              success: !isTimeout && exitCode === 0,\r\n              output: outputBuffer,\r\n              error: errorBuffer,\r\n              exitCode,\r\n              duration,\r\n              resourcesUsed: resourceUsage,\r\n              artifacts,\r\n              metadata: {\r\n                sessionId,\r\n                timeout: isTimeout,\r\n                signal,\r\n                command: command.command,\r\n                args: command.args,\r\n              },\r\n            };\r\n\r\n            if (isTimeout) {\r\n              reject(new Error(`Claude execution timed out after ${timeout}ms`));\r\n            } else if (exitCode !== 0) {\r\n              reject(\r\n                new Error(`Claude execution failed with exit code ${exitCode}: ${errorBuffer}`),\r\n              );\r\n            } else {\r\n              resolve(result);\r\n            }\r\n          } catch (error) {\r\n            reject(error);\r\n          }\r\n        });\r\n\r\n        // Handle process errors\r\n        process.on('error', (error: Error) => {\r\n          clearTimeout(timeoutHandle);\r\n          this.logger.error('Claude process error', {\r\n            sessionId,\r\n            error: error instanceof Error ? error.message : String(error),\r\n          });\r\n          reject(error);\r\n        });\r\n\r\n        // Send input if provided\r\n        if (command.input && process.stdin) {\r\n          process.stdin.write(command.input);\r\n          process.stdin.end();\r\n        }\r\n\r\n        // If detached, unreference to allow parent to exit\r\n        if (options.detached) {\r\n          process.unref();\r\n        }\r\n      } catch (error) {\r\n        clearTimeout(timeoutHandle);\r\n        reject(error);\r\n      }\r\n    });\r\n  }\r\n\r\n  private buildClaudeCommand(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    options: ClaudeExecutionOptions,\r\n  ): ClaudeCommand {\r\n    const args: string[] = [];\r\n    let input = '';\r\n\r\n    // Build prompt\r\n    const prompt = this.buildClaudePrompt(task, agent);\r\n\r\n    if (options.useStdin) {\r\n      // Send prompt via stdin\r\n      input = prompt;\r\n    } else {\r\n      // Send prompt as argument\r\n      args.push('-p', prompt);\r\n    }\r\n\r\n    // Add tools\r\n    if (task.requirements.tools.length > 0) {\r\n      args.push('--allowedTools', task.requirements.tools.join(','));\r\n    }\r\n\r\n    // Add model if specified\r\n    if (options.model) {\r\n      args.push('--model', options.model);\r\n    }\r\n\r\n    // Add max tokens if specified\r\n    if (options.maxTokens) {\r\n      args.push('--max-tokens', options.maxTokens.toString());\r\n    }\r\n\r\n    // Add temperature if specified\r\n    if (options.temperature !== undefined) {\r\n      args.push('--temperature', options.temperature.toString());\r\n    }\r\n\r\n    // Skip permissions check for swarm execution\r\n    args.push('--dangerously-skip-permissions');\r\n\r\n    // Add output format\r\n    if (options.outputFormat) {\r\n      args.push('--output-format', options.outputFormat);\r\n    }\r\n\r\n    return {\r\n      command: options.claudePath || 'claude',\r\n      args,\r\n      input,\r\n    };\r\n  }\r\n\r\n  private buildClaudePrompt(task: TaskDefinition, agent: AgentState): string {\r\n    const sections: string[] = [];\r\n\r\n    // Agent identification\r\n    sections.push(`You are ${agent.name}, a ${agent.type} agent in a swarm system.`);\r\n    sections.push(`Agent ID: ${agent.id.id}`);\r\n    sections.push(`Swarm ID: ${agent.id.swarmId}`);\r\n    sections.push('');\r\n\r\n    // Task information\r\n    sections.push(`TASK: ${task.name}`);\r\n    sections.push(`Type: ${task.type}`);\r\n    sections.push(`Priority: ${task.priority}`);\r\n    sections.push('');\r\n\r\n    // Task description\r\n    sections.push('DESCRIPTION:');\r\n    sections.push(task.description);\r\n    sections.push('');\r\n\r\n    // Task instructions\r\n    sections.push('INSTRUCTIONS:');\r\n    sections.push(task.instructions);\r\n    sections.push('');\r\n\r\n    // Context if provided\r\n    if (Object.keys(task.context).length > 0) {\r\n      sections.push('CONTEXT:');\r\n      sections.push(JSON.stringify(task.context, null, 2));\r\n      sections.push('');\r\n    }\r\n\r\n    // Input data if provided\r\n    if (task.input && Object.keys(task.input).length > 0) {\r\n      sections.push('INPUT DATA:');\r\n      sections.push(JSON.stringify(task.input, null, 2));\r\n      sections.push('');\r\n    }\r\n\r\n    // Examples if provided\r\n    if (task.examples && task.examples.length > 0) {\r\n      sections.push('EXAMPLES:');\r\n      task.examples.forEach((example, index) => {\r\n        sections.push(`Example ${index + 1}:`);\r\n        sections.push(JSON.stringify(example, null, 2));\r\n        sections.push('');\r\n      });\r\n    }\r\n\r\n    // Expected output format\r\n    sections.push('EXPECTED OUTPUT:');\r\n    if (task.expectedOutput) {\r\n      sections.push(JSON.stringify(task.expectedOutput, null, 2));\r\n    } else {\r\n      sections.push('Provide a structured response with:');\r\n      sections.push('- Summary of what was accomplished');\r\n      sections.push('- Any artifacts created (files, data, etc.)');\r\n      sections.push('- Recommendations or next steps');\r\n      sections.push('- Any issues encountered');\r\n    }\r\n    sections.push('');\r\n\r\n    // Quality requirements\r\n    sections.push('QUALITY REQUIREMENTS:');\r\n    sections.push(`- Quality threshold: ${task.requirements.minReliability || 0.8}`);\r\n    if (task.requirements.reviewRequired) {\r\n      sections.push('- Review required before completion');\r\n    }\r\n    if (task.requirements.testingRequired) {\r\n      sections.push('- Testing required before completion');\r\n    }\r\n    if (task.requirements.documentationRequired) {\r\n      sections.push('- Documentation required');\r\n    }\r\n    sections.push('');\r\n\r\n    // Capabilities and constraints\r\n    sections.push('CAPABILITIES:');\r\n    const capabilities = Object.entries(agent.capabilities)\r\n      .filter(([key, value]) => typeof value === 'boolean' && value)\r\n      .map(([key]) => key);\r\n    sections.push(capabilities.join(', '));\r\n    sections.push('');\r\n\r\n    sections.push('CONSTRAINTS:');\r\n    sections.push(\r\n      `- Maximum execution time: ${task.constraints.timeoutAfter || SWARM_CONSTANTS.DEFAULT_TASK_TIMEOUT}ms`,\r\n    );\r\n    sections.push(\r\n      `- Maximum retries: ${task.constraints.maxRetries || SWARM_CONSTANTS.MAX_RETRIES}`,\r\n    );\r\n    if (task.constraints.deadline) {\r\n      sections.push(`- Deadline: ${task.constraints.deadline.toISOString()}`);\r\n    }\r\n    sections.push('');\r\n\r\n    // Final instructions\r\n    sections.push('EXECUTION GUIDELINES:');\r\n    sections.push('1. Read and understand the task completely before starting');\r\n    sections.push('2. Use your capabilities efficiently and effectively');\r\n    sections.push('3. Provide detailed output about your progress and results');\r\n    sections.push('4. Handle errors gracefully and report issues clearly');\r\n    sections.push('5. Ensure your work meets the quality requirements');\r\n    sections.push('6. When complete, provide a clear summary of what was accomplished');\r\n    sections.push('');\r\n\r\n    sections.push('Begin your task execution now.');\r\n\r\n    return sections.join('\\n');\r\n  }\r\n\r\n  private async createExecutionContext(\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n  ): Promise<ExecutionContext> {\r\n    const baseDir = path.join(os.tmpdir(), 'swarm-execution', task.id.id);\r\n    const workingDir = path.join(baseDir, 'work');\r\n    const tempDir = path.join(baseDir, 'temp');\r\n    const logDir = path.join(baseDir, 'logs');\r\n\r\n    // Create directories\r\n    await fs.mkdir(workingDir, { recursive: true });\r\n    await fs.mkdir(tempDir, { recursive: true });\r\n    await fs.mkdir(logDir, { recursive: true });\r\n\r\n    return {\r\n      task,\r\n      agent,\r\n      workingDirectory: workingDir,\r\n      tempDirectory: tempDir,\r\n      logDirectory: logDir,\r\n      environment: {\r\n        NODE_ENV: 'production',\r\n        SWARM_MODE: 'execution',\r\n        AGENT_TYPE: agent.type,\r\n        TASK_TYPE: task.type,\r\n        ...agent.environment.credentials,\r\n      },\r\n      resources: {\r\n        maxMemory: task.requirements.memoryRequired || SWARM_CONSTANTS.DEFAULT_MEMORY_LIMIT,\r\n        maxCpuTime: task.requirements.maxDuration || SWARM_CONSTANTS.DEFAULT_TASK_TIMEOUT,\r\n        maxDiskSpace: 1024 * 1024 * 1024, // 1GB\r\n        maxNetworkConnections: 10,\r\n        maxFileHandles: 100,\r\n        priority: this.getPriorityNumber(task.priority),\r\n      },\r\n    };\r\n  }\r\n\r\n  private async cleanupExecution(session: ExecutionSession): Promise<void> {\r\n    try {\r\n      await session.cleanup();\r\n      this.logger.debug('Execution cleanup completed', { sessionId: session.id });\r\n    } catch (error) {\r\n      this.logger.warn('Error during execution cleanup', {\r\n        sessionId: session.id,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n\r\n  private async collectResourceUsage(sessionId: string): Promise<ResourceUsage> {\r\n    return this.resourceMonitor.getUsage(sessionId);\r\n  }\r\n\r\n  private async collectArtifacts(context: ExecutionContext): Promise<Record<string, any>> {\r\n    const artifacts: Record<string, any> = {};\r\n\r\n    try {\r\n      // Scan working directory for artifacts\r\n      const files = await this.scanDirectory(context.workingDirectory);\r\n      artifacts.files = files;\r\n\r\n      // Check for specific artifact types\r\n      artifacts.logs = await this.collectLogs(context.logDirectory);\r\n      artifacts.outputs = await this.collectOutputs(context.workingDirectory);\r\n    } catch (error) {\r\n      this.logger.warn('Error collecting artifacts', {\r\n        workingDir: context.workingDirectory,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n\r\n    return artifacts;\r\n  }\r\n\r\n  private async scanDirectory(dirPath: string): Promise<string[]> {\r\n    try {\r\n      const entries = await fs.readdir(dirPath, { withFileTypes: true });\r\n      const files: string[] = [];\r\n\r\n      for (const entry of entries) {\r\n        const fullPath = path.join(dirPath, entry.name);\r\n        if (entry.isFile()) {\r\n          files.push(fullPath);\r\n        } else if (entry.isDirectory()) {\r\n          const subFiles = await this.scanDirectory(fullPath);\r\n          files.push(...subFiles);\r\n        }\r\n      }\r\n\r\n      return files;\r\n    } catch (error) {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async collectLogs(logDir: string): Promise<Record<string, string>> {\r\n    const logs: Record<string, string> = {};\r\n\r\n    try {\r\n      const files = await fs.readdir(logDir);\r\n      for (const file of files) {\r\n        if (file.endsWith('.log')) {\r\n          const filePath = path.join(logDir, file);\r\n          const content = await fs.readFile(filePath, 'utf-8');\r\n          logs[file] = content;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // Log directory might not exist\r\n    }\r\n\r\n    return logs;\r\n  }\r\n\r\n  private async collectOutputs(workingDir: string): Promise<Record<string, any>> {\r\n    const outputs: Record<string, any> = {};\r\n\r\n    try {\r\n      // Look for common output files\r\n      const outputFiles = ['output.json', 'result.json', 'response.json'];\r\n\r\n      for (const fileName of outputFiles) {\r\n        const filePath = path.join(workingDir, fileName);\r\n        try {\r\n          const content = await fs.readFile(filePath, 'utf-8');\r\n          outputs[fileName] = JSON.parse(content);\r\n        } catch (error) {\r\n          // File doesn't exist or isn't valid JSON\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // Working directory might not exist\r\n    }\r\n\r\n    return outputs;\r\n  }\r\n\r\n  private getPriorityNumber(priority: string): number {\r\n    switch (priority) {\r\n      case 'critical':\r\n        return 0;\r\n      case 'high':\r\n        return 1;\r\n      case 'normal':\r\n        return 2;\r\n      case 'low':\r\n        return 3;\r\n      case 'background':\r\n        return 4;\r\n      default:\r\n        return 2;\r\n    }\r\n  }\r\n\r\n  private mergeWithDefaults(config: Partial<ExecutionConfig>): ExecutionConfig {\r\n    return {\r\n      timeoutMs: SWARM_CONSTANTS.DEFAULT_TASK_TIMEOUT,\r\n      retryAttempts: SWARM_CONSTANTS.MAX_RETRIES,\r\n      killTimeout: 5000, // 5 seconds\r\n      resourceLimits: {\r\n        maxMemory: SWARM_CONSTANTS.DEFAULT_MEMORY_LIMIT,\r\n        maxCpuTime: SWARM_CONSTANTS.DEFAULT_TASK_TIMEOUT,\r\n        maxDiskSpace: 1024 * 1024 * 1024, // 1GB\r\n        maxNetworkConnections: 10,\r\n        maxFileHandles: 100,\r\n        priority: 2,\r\n      },\r\n      sandboxed: true,\r\n      logLevel: 'info',\r\n      captureOutput: true,\r\n      streamOutput: false,\r\n      enableMetrics: true,\r\n      ...config,\r\n    };\r\n  }\r\n\r\n  private setupEventHandlers(): void {\r\n    // Handle resource limit violations\r\n    this.resourceMonitor.on('limit-violation', (data: any) => {\r\n      this.logger.warn('Resource limit violation', data);\r\n\r\n      const session = this.activeExecutions.get(data.sessionId);\r\n      if (session) {\r\n        session.stop('Resource limit violation').catch((error) => {\r\n          this.logger.error('Error stopping session due to resource violation', {\r\n            sessionId: data.sessionId,\r\n            error,\r\n          });\r\n        });\r\n      }\r\n    });\r\n\r\n    // Handle process pool events\r\n    this.processPool.on('process-failed', (data: any) => {\r\n      this.logger.error('Process failed in pool', data);\r\n    });\r\n  }\r\n}\r\n\r\n// ===== SUPPORTING CLASSES =====\r\n\r\nclass ExecutionSession {\r\n  public id: string;\r\n  public task: TaskDefinition;\r\n  public agent: AgentState;\r\n  public context: ExecutionContext;\r\n  public config: ExecutionConfig;\r\n  private logger: Logger;\r\n  private process?: ChildProcess;\r\n  private startTime?: Date;\r\n  private endTime?: Date;\r\n\r\n  constructor(\r\n    id: string,\r\n    task: TaskDefinition,\r\n    agent: AgentState,\r\n    context: ExecutionContext,\r\n    config: ExecutionConfig,\r\n    logger: Logger,\r\n  ) {\r\n    this.id = id;\r\n    this.task = task;\r\n    this.agent = agent;\r\n    this.context = context;\r\n    this.config = config;\r\n    this.logger = logger;\r\n  }\r\n\r\n  async execute(): Promise<ExecutionResult> {\r\n    this.startTime = new Date();\r\n\r\n    // Implementation would go here for actual task execution\r\n    // This is a placeholder that simulates execution\r\n\r\n    await new Promise((resolve) => setTimeout(resolve, 1000));\r\n\r\n    this.endTime = new Date();\r\n\r\n    return {\r\n      success: true,\r\n      output: 'Task completed successfully',\r\n      exitCode: 0,\r\n      duration: this.endTime.getTime() - this.startTime.getTime(),\r\n      resourcesUsed: {\r\n        cpuTime: 1000,\r\n        maxMemory: 50 * 1024 * 1024,\r\n        diskIO: 1024,\r\n        networkIO: 0,\r\n        fileHandles: 5,\r\n      },\r\n      artifacts: {},\r\n      metadata: {\r\n        sessionId: this.id,\r\n        agentId: this.agent.id.id,\r\n        taskId: this.task.id.id,\r\n      },\r\n    };\r\n  }\r\n\r\n  async stop(reason: string): Promise<void> {\r\n    this.logger.info('Stopping execution session', { sessionId: this.id, reason });\r\n\r\n    if (this.process) {\r\n      this.process.kill('SIGTERM');\r\n\r\n      // Force kill after timeout\r\n      setTimeout(() => {\r\n        if (this.process && !this.process.killed) {\r\n          this.process.kill('SIGKILL');\r\n        }\r\n      }, 5000);\r\n    }\r\n  }\r\n\r\n  async cleanup(): Promise<void> {\r\n    // Cleanup temporary files and resources\r\n    try {\r\n      await fs.rm(this.context.tempDirectory, { recursive: true, force: true });\r\n    } catch (error) {\r\n      // Ignore cleanup errors\r\n    }\r\n  }\r\n}\r\n\r\nclass ResourceMonitor extends EventEmitter {\r\n  private activeMonitors: Map<string, NodeJS.Timeout> = new Map();\r\n  private usage: Map<string, ResourceUsage> = new Map();\r\n\r\n  async initialize(): Promise<void> {\r\n    // Initialize resource monitoring\r\n  }\r\n\r\n  async shutdown(): Promise<void> {\r\n    // Stop all monitors\r\n    for (const [sessionId, timer] of this.activeMonitors) {\r\n      clearInterval(timer);\r\n    }\r\n    this.activeMonitors.clear();\r\n  }\r\n\r\n  startMonitoring(sessionId: string, limits: ExecutionResources): void {\r\n    const timer = setInterval(() => {\r\n      this.checkResources(sessionId, limits);\r\n    }, 1000);\r\n\r\n    this.activeMonitors.set(sessionId, timer);\r\n  }\r\n\r\n  stopMonitoring(sessionId: string): void {\r\n    const timer = this.activeMonitors.get(sessionId);\r\n    if (timer) {\r\n      clearInterval(timer);\r\n      this.activeMonitors.delete(sessionId);\r\n    }\r\n  }\r\n\r\n  getUsage(sessionId: string): ResourceUsage {\r\n    return (\r\n      this.usage.get(sessionId) || {\r\n        cpuTime: 0,\r\n        maxMemory: 0,\r\n        diskIO: 0,\r\n        networkIO: 0,\r\n        fileHandles: 0,\r\n      }\r\n    );\r\n  }\r\n\r\n  getUtilization(): Record<string, number> {\r\n    // Return overall system utilization\r\n    return {\r\n      cpu: 0.1,\r\n      memory: 0.2,\r\n      disk: 0.05,\r\n      network: 0.01,\r\n    };\r\n  }\r\n\r\n  private checkResources(sessionId: string, limits: ExecutionResources): void {\r\n    // Check if any limits are exceeded\r\n    const usage = this.collectCurrentUsage(sessionId);\r\n    this.usage.set(sessionId, usage);\r\n\r\n    if (usage.maxMemory > limits.maxMemory) {\r\n      this.emit('limit-violation', {\r\n        sessionId,\r\n        type: 'memory',\r\n        current: usage.maxMemory,\r\n        limit: limits.maxMemory,\r\n      });\r\n    }\r\n\r\n    if (usage.cpuTime > limits.maxCpuTime) {\r\n      this.emit('limit-violation', {\r\n        sessionId,\r\n        type: 'cpu',\r\n        current: usage.cpuTime,\r\n        limit: limits.maxCpuTime,\r\n      });\r\n    }\r\n  }\r\n\r\n  private collectCurrentUsage(sessionId: string): ResourceUsage {\r\n    // Collect actual resource usage - this would interface with system APIs\r\n    return {\r\n      cpuTime: Math.random() * 1000,\r\n      maxMemory: Math.random() * 100 * 1024 * 1024,\r\n      diskIO: Math.random() * 1024,\r\n      networkIO: Math.random() * 1024,\r\n      fileHandles: Math.floor(Math.random() * 10),\r\n    };\r\n  }\r\n}\r\n\r\nclass ProcessPool extends EventEmitter {\r\n  private config: ExecutionConfig;\r\n  private totalExecutions = 0;\r\n  private totalDuration = 0;\r\n  private successCount = 0;\r\n  private errorCount = 0;\r\n\r\n  constructor(config: ExecutionConfig) {\r\n    super();\r\n    this.config = config;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    // Initialize process pool\r\n  }\r\n\r\n  async shutdown(): Promise<void> {\r\n    // Shutdown process pool\r\n  }\r\n\r\n  getTotalExecutions(): number {\r\n    return this.totalExecutions;\r\n  }\r\n\r\n  getAverageDuration(): number {\r\n    return this.totalExecutions > 0 ? this.totalDuration / this.totalExecutions : 0;\r\n  }\r\n\r\n  getSuccessRate(): number {\r\n    return this.totalExecutions > 0 ? this.successCount / this.totalExecutions : 0;\r\n  }\r\n\r\n  getErrorRate(): number {\r\n    return this.totalExecutions > 0 ? this.errorCount / this.totalExecutions : 0;\r\n  }\r\n}\r\n\r\n// ===== INTERFACES =====\r\n\r\nexport interface ClaudeExecutionOptions {\r\n  model?: string;\r\n  maxTokens?: number;\r\n  temperature?: number;\r\n  timeout?: number;\r\n  claudePath?: string;\r\n  useStdin?: boolean;\r\n  detached?: boolean;\r\n  outputFormat?: string;\r\n}\r\n\r\nexport interface ClaudeCommand {\r\n  command: string;\r\n  args: string[];\r\n  input?: string;\r\n}\r\n\r\nexport interface ExecutionMetrics {\r\n  activeExecutions: number;\r\n  totalExecutions: number;\r\n  averageDuration: number;\r\n  successRate: number;\r\n  resourceUtilization: Record<string, number>;\r\n  errorRate: number;\r\n}\r\n\r\nexport default TaskExecutor;\r\n"],"names":["spawn","EventEmitter","fs","path","os","Logger","generateId","SWARM_CONSTANTS","TaskExecutor","logger","config","activeExecutions","Map","resourceMonitor","processPool","mergeWithDefaults","level","logLevel","format","destination","component","ResourceMonitor","ProcessPool","setupEventHandlers","initialize","info","shutdown","stopPromises","Array","from","values","map","session","stopExecution","id","Promise","allSettled","executeTask","task","agent","options","sessionId","context","createExecutionContext","taskId","agentId","timeout","timeoutMs","ExecutionSession","set","startMonitoring","resources","result","executeWithTimeout","cleanupExecution","success","duration","error","Error","message","String","stack","delete","stopMonitoring","reason","get","stop","executeClaudeTask","claudeOptions","executeClaudeWithTimeout","getActiveExecutions","getExecutionMetrics","size","totalExecutions","getTotalExecutions","averageDuration","getAverageDuration","successRate","getSuccessRate","resourceUtilization","getUtilization","errorRate","getErrorRate","resolve","reject","setTimeout","warn","then","execute","clearTimeout","catch","startTime","Date","now","command","buildClaudeCommand","env","process","environment","CLAUDE_TASK_ID","CLAUDE_AGENT_ID","CLAUDE_SESSION_ID","CLAUDE_WORKING_DIR","workingDirectory","debug","args","workingDir","outputBuffer","errorBuffer","isTimeout","timeoutHandle","pid","kill","killed","killTimeout","cwd","stdio","detached","stdout","on","data","chunk","toString","streamOutput","emit","type","stderr","code","signal","exitCode","resourceUsage","collectResourceUsage","artifacts","collectArtifacts","output","resourcesUsed","metadata","input","stdin","write","end","unref","prompt","buildClaudePrompt","useStdin","push","requirements","tools","length","join","model","maxTokens","temperature","undefined","outputFormat","claudePath","sections","name","swarmId","priority","description","instructions","Object","keys","JSON","stringify","examples","forEach","example","index","expectedOutput","minReliability","reviewRequired","testingRequired","documentationRequired","capabilities","entries","filter","key","value","constraints","timeoutAfter","DEFAULT_TASK_TIMEOUT","maxRetries","MAX_RETRIES","deadline","toISOString","baseDir","tmpdir","tempDir","logDir","mkdir","recursive","tempDirectory","logDirectory","NODE_ENV","SWARM_MODE","AGENT_TYPE","TASK_TYPE","credentials","maxMemory","memoryRequired","DEFAULT_MEMORY_LIMIT","maxCpuTime","maxDuration","maxDiskSpace","maxNetworkConnections","maxFileHandles","getPriorityNumber","cleanup","getUsage","files","scanDirectory","logs","collectLogs","outputs","collectOutputs","dirPath","readdir","withFileTypes","entry","fullPath","isFile","isDirectory","subFiles","file","endsWith","filePath","content","readFile","outputFiles","fileName","parse","retryAttempts","resourceLimits","sandboxed","captureOutput","enableMetrics","endTime","getTime","cpuTime","diskIO","networkIO","fileHandles","rm","force","activeMonitors","usage","timer","clearInterval","clear","limits","setInterval","checkResources","cpu","memory","disk","network","collectCurrentUsage","current","limit","Math","random","floor","totalDuration","successCount","errorCount"],"mappings":"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"}
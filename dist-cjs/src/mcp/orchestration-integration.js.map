{"version":3,"sources":["../../../src/mcp/orchestration-integration.ts"],"sourcesContent":["/**\r\n * MCP Integration with Claude-Flow Orchestration System\r\n * Provides seamless integration between MCP servers and the broader orchestration components\r\n */\r\n\r\nimport { EventEmitter } from 'node:events';\r\nimport type { ILogger } from '../core/logger.js';\r\nimport { MCPConfig, MCPSession, MCPTool, SystemEvents } from '../utils/types.js';\r\nimport { MCPError } from '../utils/errors.js';\r\nimport { MCPServer, IMCPServer } from './server.js';\r\nimport { MCPLifecycleManager, LifecycleState } from './lifecycle-manager.js';\r\nimport { MCPPerformanceMonitor } from './performance-monitor.js';\r\nimport { MCPProtocolManager } from './protocol-manager.js';\r\n\r\nexport interface OrchestrationComponents {\r\n  orchestrator?: any;\r\n  swarmCoordinator?: any;\r\n  agentManager?: any;\r\n  resourceManager?: any;\r\n  memoryManager?: any;\r\n  messageBus?: any;\r\n  monitor?: any;\r\n  eventBus?: any;\r\n  terminalManager?: any;\r\n}\r\n\r\nexport interface MCPOrchestrationConfig {\r\n  enabledIntegrations: {\r\n    orchestrator: boolean;\r\n    swarm: boolean;\r\n    agents: boolean;\r\n    resources: boolean;\r\n    memory: boolean;\r\n    monitoring: boolean;\r\n    terminals: boolean;\r\n  };\r\n  autoStart: boolean;\r\n  healthCheckInterval: number;\r\n  reconnectAttempts: number;\r\n  reconnectDelay: number;\r\n  enableMetrics: boolean;\r\n  enableAlerts: boolean;\r\n}\r\n\r\nexport interface IntegrationStatus {\r\n  component: string;\r\n  enabled: boolean;\r\n  connected: boolean;\r\n  healthy: boolean;\r\n  lastCheck: Date;\r\n  error?: string;\r\n  metrics?: Record<string, number>;\r\n}\r\n\r\n/**\r\n * MCP Orchestration Integration Manager\r\n * Manages the integration between MCP servers and orchestration components\r\n */\r\nexport class MCPOrchestrationIntegration extends EventEmitter {\r\n  private server?: IMCPServer;\r\n  private lifecycleManager?: MCPLifecycleManager;\r\n  private performanceMonitor?: MCPPerformanceMonitor;\r\n  private protocolManager?: MCPProtocolManager;\r\n\r\n  private integrationStatus = new Map<string, IntegrationStatus>();\r\n  private healthCheckTimer?: NodeJS.Timeout;\r\n  private reconnectTimers = new Map<string, NodeJS.Timeout>();\r\n\r\n  private readonly defaultConfig: MCPOrchestrationConfig = {\r\n    enabledIntegrations: {\r\n      orchestrator: true,\r\n      swarm: true,\r\n      agents: true,\r\n      resources: true,\r\n      memory: true,\r\n      monitoring: true,\r\n      terminals: true,\r\n    },\r\n    autoStart: true,\r\n    healthCheckInterval: 30000, // 30 seconds\r\n    reconnectAttempts: 3,\r\n    reconnectDelay: 5000, // 5 seconds\r\n    enableMetrics: true,\r\n    enableAlerts: true,\r\n  };\r\n\r\n  constructor(\r\n    private mcpConfig: MCPConfig,\r\n    private orchestrationConfig: MCPOrchestrationConfig,\r\n    private components: OrchestrationComponents,\r\n    private logger: ILogger,\r\n  ) {\r\n    super();\r\n\r\n    this.orchestrationConfig = { ...this.defaultConfig, ...orchestrationConfig };\r\n    this.initializeIntegration();\r\n  }\r\n\r\n  /**\r\n   * Start the MCP orchestration integration\r\n   */\r\n  async start(): Promise<void> {\r\n    this.logger.info('Starting MCP orchestration integration');\r\n\r\n    try {\r\n      // Initialize protocol manager\r\n      this.protocolManager = new MCPProtocolManager(this.logger);\r\n\r\n      // Initialize performance monitor\r\n      if (this.orchestrationConfig.enableMetrics) {\r\n        this.performanceMonitor = new MCPPerformanceMonitor(this.logger);\r\n        this.setupPerformanceMonitoring();\r\n      }\r\n\r\n      // Create MCP server\r\n      this.server = new MCPServer(\r\n        this.mcpConfig,\r\n        this.components.eventBus || new EventEmitter(),\r\n        this.logger,\r\n        this.components.orchestrator,\r\n        this.components.swarmCoordinator,\r\n        this.components.agentManager,\r\n        this.components.resourceManager,\r\n        this.components.messageBus,\r\n        this.components.monitor,\r\n      );\r\n\r\n      // Initialize lifecycle manager\r\n      this.lifecycleManager = new MCPLifecycleManager(\r\n        this.mcpConfig,\r\n        this.logger,\r\n        () => this.server!,\r\n      );\r\n\r\n      // Setup lifecycle event handlers\r\n      this.setupLifecycleHandlers();\r\n\r\n      // Register orchestration tools\r\n      this.registerOrchestrationTools();\r\n\r\n      // Start the server\r\n      if (this.orchestrationConfig.autoStart) {\r\n        await this.lifecycleManager.start();\r\n      }\r\n\r\n      // Start health monitoring\r\n      this.startHealthMonitoring();\r\n\r\n      // Setup component integrations\r\n      await this.setupComponentIntegrations();\r\n\r\n      this.logger.info('MCP orchestration integration started successfully');\r\n      this.emit('integrationStarted');\r\n    } catch (error) {\r\n      this.logger.error('Failed to start MCP orchestration integration', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop the MCP orchestration integration\r\n   */\r\n  async stop(): Promise<void> {\r\n    this.logger.info('Stopping MCP orchestration integration');\r\n\r\n    try {\r\n      // Stop health monitoring\r\n      this.stopHealthMonitoring();\r\n\r\n      // Stop lifecycle manager\r\n      if (this.lifecycleManager) {\r\n        await this.lifecycleManager.stop();\r\n      }\r\n\r\n      // Stop performance monitor\r\n      if (this.performanceMonitor) {\r\n        this.performanceMonitor.stop();\r\n      }\r\n\r\n      // Clear reconnect timers\r\n      for (const timer of this.reconnectTimers.values()) {\r\n        clearTimeout(timer);\r\n      }\r\n      this.reconnectTimers.clear();\r\n\r\n      this.logger.info('MCP orchestration integration stopped');\r\n      this.emit('integrationStopped');\r\n    } catch (error) {\r\n      this.logger.error('Error stopping MCP orchestration integration', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get integration status for all components\r\n   */\r\n  getIntegrationStatus(): IntegrationStatus[] {\r\n    return Array.from(this.integrationStatus.values());\r\n  }\r\n\r\n  /**\r\n   * Get status for a specific component\r\n   */\r\n  getComponentStatus(component: string): IntegrationStatus | undefined {\r\n    return this.integrationStatus.get(component);\r\n  }\r\n\r\n  /**\r\n   * Get MCP server instance\r\n   */\r\n  getServer(): IMCPServer | undefined {\r\n    return this.server;\r\n  }\r\n\r\n  /**\r\n   * Get lifecycle manager\r\n   */\r\n  getLifecycleManager(): MCPLifecycleManager | undefined {\r\n    return this.lifecycleManager;\r\n  }\r\n\r\n  /**\r\n   * Get performance monitor\r\n   */\r\n  getPerformanceMonitor(): MCPPerformanceMonitor | undefined {\r\n    return this.performanceMonitor;\r\n  }\r\n\r\n  /**\r\n   * Get protocol manager\r\n   */\r\n  getProtocolManager(): MCPProtocolManager | undefined {\r\n    return this.protocolManager;\r\n  }\r\n\r\n  /**\r\n   * Force reconnection to a component\r\n   */\r\n  async reconnectComponent(component: string): Promise<void> {\r\n    const status = this.integrationStatus.get(component);\r\n    if (!status || !status.enabled) {\r\n      throw new MCPError(`Component ${component} is not enabled`);\r\n    }\r\n\r\n    this.logger.info('Reconnecting to component', { component });\r\n\r\n    try {\r\n      await this.connectComponent(component);\r\n      this.logger.info('Successfully reconnected to component', { component });\r\n    } catch (error) {\r\n      this.logger.error('Failed to reconnect to component', { component, error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enable/disable component integration\r\n   */\r\n  async setComponentEnabled(component: string, enabled: boolean): Promise<void> {\r\n    const status = this.integrationStatus.get(component);\r\n    if (!status) {\r\n      throw new MCPError(`Unknown component: ${component}`);\r\n    }\r\n\r\n    status.enabled = enabled;\r\n\r\n    if (enabled) {\r\n      await this.connectComponent(component);\r\n    } else {\r\n      await this.disconnectComponent(component);\r\n    }\r\n\r\n    this.logger.info('Component integration updated', { component, enabled });\r\n    this.emit('componentToggled', { component, enabled });\r\n  }\r\n\r\n  private initializeIntegration(): void {\r\n    const components = [\r\n      'orchestrator',\r\n      'swarm',\r\n      'agents',\r\n      'resources',\r\n      'memory',\r\n      'monitoring',\r\n      'terminals',\r\n    ];\r\n\r\n    for (const component of components) {\r\n      this.integrationStatus.set(component, {\r\n        component,\r\n        enabled:\r\n          this.orchestrationConfig.enabledIntegrations[\r\n            component as keyof typeof this.orchestrationConfig.enabledIntegrations\r\n          ],\r\n        connected: false,\r\n        healthy: false,\r\n        lastCheck: new Date(),\r\n      });\r\n    }\r\n  }\r\n\r\n  private setupLifecycleHandlers(): void {\r\n    if (!this.lifecycleManager) return;\r\n\r\n    this.lifecycleManager.on('stateChange', (event) => {\r\n      this.logger.info('MCP server state changed', {\r\n        from: event.previousState,\r\n        to: event.state,\r\n        error: event.error?.message,\r\n      });\r\n\r\n      // Emit to orchestration event bus\r\n      if (this.components.eventBus) {\r\n        this.components.eventBus.emit(SystemEvents.SYSTEM_HEALTHCHECK, {\r\n          status: event.state === LifecycleState.RUNNING ? 'healthy' : 'unhealthy',\r\n          component: 'mcp-server',\r\n          timestamp: event.timestamp,\r\n        });\r\n      }\r\n\r\n      this.emit('lifecycleStateChanged', event);\r\n    });\r\n  }\r\n\r\n  private setupPerformanceMonitoring(): void {\r\n    if (!this.performanceMonitor) return;\r\n\r\n    this.performanceMonitor.on('metricsCollected', (metrics) => {\r\n      // Forward metrics to orchestration monitor\r\n      if (this.components.monitor && typeof this.components.monitor.recordMetrics === 'function') {\r\n        this.components.monitor.recordMetrics('mcp', metrics);\r\n      }\r\n\r\n      this.emit('metricsCollected', metrics);\r\n    });\r\n\r\n    this.performanceMonitor.on('alertTriggered', (alert) => {\r\n      this.logger.warn('MCP performance alert triggered', {\r\n        alertId: alert.id,\r\n        ruleName: alert.ruleName,\r\n        severity: alert.severity,\r\n        message: alert.message,\r\n      });\r\n\r\n      // Forward to orchestration alert system\r\n      if (this.orchestrationConfig.enableAlerts && this.components.monitor) {\r\n        if (typeof this.components.monitor.sendAlert === 'function') {\r\n          this.components.monitor.sendAlert({\r\n            source: 'mcp',\r\n            severity: alert.severity,\r\n            message: alert.message,\r\n            metadata: alert,\r\n          });\r\n        }\r\n      }\r\n\r\n      this.emit('performanceAlert', alert);\r\n    });\r\n\r\n    this.performanceMonitor.on('optimizationSuggestion', (suggestion) => {\r\n      this.logger.info('MCP optimization suggestion', {\r\n        type: suggestion.type,\r\n        priority: suggestion.priority,\r\n        title: suggestion.title,\r\n      });\r\n\r\n      this.emit('optimizationSuggestion', suggestion);\r\n    });\r\n  }\r\n\r\n  private registerOrchestrationTools(): void {\r\n    if (!this.server) return;\r\n\r\n    // Register orchestrator tools\r\n    if (this.orchestrationConfig.enabledIntegrations.orchestrator && this.components.orchestrator) {\r\n      this.registerOrchestratorTools();\r\n    }\r\n\r\n    // Register swarm tools\r\n    if (this.orchestrationConfig.enabledIntegrations.swarm && this.components.swarmCoordinator) {\r\n      this.registerSwarmTools();\r\n    }\r\n\r\n    // Register agent tools\r\n    if (this.orchestrationConfig.enabledIntegrations.agents && this.components.agentManager) {\r\n      this.registerAgentTools();\r\n    }\r\n\r\n    // Register resource tools\r\n    if (this.orchestrationConfig.enabledIntegrations.resources && this.components.resourceManager) {\r\n      this.registerResourceTools();\r\n    }\r\n\r\n    // Register memory tools\r\n    if (this.orchestrationConfig.enabledIntegrations.memory && this.components.memoryManager) {\r\n      this.registerMemoryTools();\r\n    }\r\n\r\n    // Register monitoring tools\r\n    if (this.orchestrationConfig.enabledIntegrations.monitoring && this.components.monitor) {\r\n      this.registerMonitoringTools();\r\n    }\r\n\r\n    // Register terminal tools\r\n    if (this.orchestrationConfig.enabledIntegrations.terminals && this.components.terminalManager) {\r\n      this.registerTerminalTools();\r\n    }\r\n  }\r\n\r\n  private registerOrchestratorTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'orchestrator/status',\r\n        description: 'Get orchestrator status and metrics',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.orchestrator?.getStatus === 'function') {\r\n            return await this.components.orchestrator.getStatus();\r\n          }\r\n          throw new MCPError('Orchestrator status not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'orchestrator/tasks',\r\n        description: 'List all tasks in the orchestrator',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            status: { type: 'string', enum: ['pending', 'running', 'completed', 'failed'] },\r\n            limit: { type: 'number', minimum: 1, maximum: 100 },\r\n          },\r\n        },\r\n        handler: async (input: any) => {\r\n          if (typeof this.components.orchestrator?.listTasks === 'function') {\r\n            return await this.components.orchestrator.listTasks(input);\r\n          }\r\n          throw new MCPError('Orchestrator task listing not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private registerSwarmTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'swarm/status',\r\n        description: 'Get swarm coordinator status',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.swarmCoordinator?.getStatus === 'function') {\r\n            return await this.components.swarmCoordinator.getStatus();\r\n          }\r\n          throw new MCPError('Swarm coordinator status not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'swarm/agents',\r\n        description: 'List active swarm agents',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.swarmCoordinator?.listAgents === 'function') {\r\n            return await this.components.swarmCoordinator.listAgents();\r\n          }\r\n          throw new MCPError('Swarm agent listing not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private registerAgentTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'agents/list',\r\n        description: 'List all managed agents',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.agentManager?.listAgents === 'function') {\r\n            return await this.components.agentManager.listAgents();\r\n          }\r\n          throw new MCPError('Agent listing not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'agents/spawn',\r\n        description: 'Spawn a new agent',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            profile: { type: 'object' },\r\n            config: { type: 'object' },\r\n          },\r\n          required: ['profile'],\r\n        },\r\n        handler: async (input: any) => {\r\n          if (typeof this.components.agentManager?.spawnAgent === 'function') {\r\n            return await this.components.agentManager.spawnAgent(input.profile, input.config);\r\n          }\r\n          throw new MCPError('Agent spawning not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private registerResourceTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'resources/list',\r\n        description: 'List available resources',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.resourceManager?.listResources === 'function') {\r\n            return await this.components.resourceManager.listResources();\r\n          }\r\n          throw new MCPError('Resource listing not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'resources/status',\r\n        description: 'Get resource manager status',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.resourceManager?.getStatus === 'function') {\r\n            return await this.components.resourceManager.getStatus();\r\n          }\r\n          throw new MCPError('Resource manager status not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private registerMemoryTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'memory/query',\r\n        description: 'Query memory bank',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            query: { type: 'string' },\r\n            namespace: { type: 'string' },\r\n            limit: { type: 'number' },\r\n          },\r\n          required: ['query'],\r\n        },\r\n        handler: async (input: any) => {\r\n          if (typeof this.components.memoryManager?.query === 'function') {\r\n            return await this.components.memoryManager.query(input);\r\n          }\r\n          throw new MCPError('Memory query not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'memory/store',\r\n        description: 'Store data in memory bank',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            data: { type: 'object' },\r\n            namespace: { type: 'string' },\r\n            tags: { type: 'array', items: { type: 'string' } },\r\n          },\r\n          required: ['data'],\r\n        },\r\n        handler: async (input: any) => {\r\n          if (typeof this.components.memoryManager?.store === 'function') {\r\n            return await this.components.memoryManager.store(input);\r\n          }\r\n          throw new MCPError('Memory storage not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private registerMonitoringTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'monitoring/metrics',\r\n        description: 'Get system monitoring metrics',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.monitor?.getMetrics === 'function') {\r\n            return await this.components.monitor.getMetrics();\r\n          }\r\n          throw new MCPError('Monitoring metrics not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'monitoring/alerts',\r\n        description: 'List active alerts',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.monitor?.getAlerts === 'function') {\r\n            return await this.components.monitor.getAlerts();\r\n          }\r\n          throw new MCPError('Alert listing not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private registerTerminalTools(): void {\r\n    const tools: MCPTool[] = [\r\n      {\r\n        name: 'terminals/list',\r\n        description: 'List active terminal sessions',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          if (typeof this.components.terminalManager?.listSessions === 'function') {\r\n            return await this.components.terminalManager.listSessions();\r\n          }\r\n          throw new MCPError('Terminal session listing not available');\r\n        },\r\n      },\r\n      {\r\n        name: 'terminals/execute',\r\n        description: 'Execute command in terminal',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            command: { type: 'string' },\r\n            sessionId: { type: 'string' },\r\n          },\r\n          required: ['command'],\r\n        },\r\n        handler: async (input: any) => {\r\n          if (typeof this.components.terminalManager?.execute === 'function') {\r\n            return await this.components.terminalManager.execute(input.command, input.sessionId);\r\n          }\r\n          throw new MCPError('Terminal execution not available');\r\n        },\r\n      },\r\n    ];\r\n\r\n    for (const tool of tools) {\r\n      this.server!.registerTool(tool);\r\n    }\r\n  }\r\n\r\n  private async setupComponentIntegrations(): Promise<void> {\r\n    const promises = [];\r\n\r\n    for (const [component, status] of this.integrationStatus.entries()) {\r\n      if (status.enabled) {\r\n        promises.push(this.connectComponent(component));\r\n      }\r\n    }\r\n\r\n    await Promise.allSettled(promises);\r\n  }\r\n\r\n  private async connectComponent(component: string): Promise<void> {\r\n    const status = this.integrationStatus.get(component);\r\n    if (!status) return;\r\n\r\n    try {\r\n      // Component-specific connection logic\r\n      switch (component) {\r\n        case 'orchestrator':\r\n          await this.connectOrchestrator();\r\n          break;\r\n        case 'swarm':\r\n          await this.connectSwarmCoordinator();\r\n          break;\r\n        case 'agents':\r\n          await this.connectAgentManager();\r\n          break;\r\n        case 'resources':\r\n          await this.connectResourceManager();\r\n          break;\r\n        case 'memory':\r\n          await this.connectMemoryManager();\r\n          break;\r\n        case 'monitoring':\r\n          await this.connectMonitor();\r\n          break;\r\n        case 'terminals':\r\n          await this.connectTerminalManager();\r\n          break;\r\n      }\r\n\r\n      status.connected = true;\r\n      status.healthy = true;\r\n      status.lastCheck = new Date();\r\n      status.error = undefined;\r\n\r\n      this.logger.info('Component connected', { component });\r\n      this.emit('componentConnected', { component });\r\n    } catch (error) {\r\n      status.connected = false;\r\n      status.healthy = false;\r\n      status.error = error instanceof Error ? error.message : 'Unknown error';\r\n\r\n      this.logger.error('Failed to connect component', { component, error });\r\n      this.scheduleReconnect(component);\r\n    }\r\n  }\r\n\r\n  private async disconnectComponent(component: string): Promise<void> {\r\n    const status = this.integrationStatus.get(component);\r\n    if (!status) return;\r\n\r\n    status.connected = false;\r\n    status.healthy = false;\r\n    status.lastCheck = new Date();\r\n\r\n    // Clear any reconnect timers\r\n    const timer = this.reconnectTimers.get(component);\r\n    if (timer) {\r\n      clearTimeout(timer);\r\n      this.reconnectTimers.delete(component);\r\n    }\r\n\r\n    this.logger.info('Component disconnected', { component });\r\n    this.emit('componentDisconnected', { component });\r\n  }\r\n\r\n  private scheduleReconnect(component: string): void {\r\n    const timer = this.reconnectTimers.get(component);\r\n    if (timer) return; // Already scheduled\r\n\r\n    const reconnectTimer = setTimeout(async () => {\r\n      this.reconnectTimers.delete(component);\r\n      try {\r\n        await this.connectComponent(component);\r\n      } catch (error) {\r\n        // Will be handled by connectComponent\r\n      }\r\n    }, this.orchestrationConfig.reconnectDelay);\r\n\r\n    this.reconnectTimers.set(component, reconnectTimer);\r\n  }\r\n\r\n  private startHealthMonitoring(): void {\r\n    this.healthCheckTimer = setInterval(async () => {\r\n      await this.performHealthChecks();\r\n    }, this.orchestrationConfig.healthCheckInterval);\r\n  }\r\n\r\n  private stopHealthMonitoring(): void {\r\n    if (this.healthCheckTimer) {\r\n      clearInterval(this.healthCheckTimer);\r\n      this.healthCheckTimer = undefined;\r\n    }\r\n  }\r\n\r\n  private async performHealthChecks(): Promise<void> {\r\n    for (const [component, status] of this.integrationStatus.entries()) {\r\n      if (!status.enabled || !status.connected) continue;\r\n\r\n      try {\r\n        const healthy = await this.checkComponentHealth(component);\r\n        status.healthy = healthy;\r\n        status.lastCheck = new Date();\r\n        status.error = undefined;\r\n      } catch (error) {\r\n        status.healthy = false;\r\n        status.error =\r\n          error instanceof Error\r\n            ? error instanceof Error\r\n              ? error.message\r\n              : String(error)\r\n            : 'Health check failed';\r\n        this.logger.warn('Component health check failed', { component, error });\r\n      }\r\n    }\r\n  }\r\n\r\n  private async checkComponentHealth(component: string): Promise<boolean> {\r\n    const componentInstance = this.getComponentInstance(component);\r\n    if (!componentInstance) return false;\r\n\r\n    // Check if component has health check method\r\n    if (typeof componentInstance.healthCheck === 'function') {\r\n      const result = await componentInstance.healthCheck();\r\n      return result === true || (typeof result === 'object' && result.healthy === true);\r\n    }\r\n\r\n    // Basic check - component exists and is not null\r\n    return true;\r\n  }\r\n\r\n  private getComponentInstance(component: string): any {\r\n    switch (component) {\r\n      case 'orchestrator':\r\n        return this.components.orchestrator;\r\n      case 'swarm':\r\n        return this.components.swarmCoordinator;\r\n      case 'agents':\r\n        return this.components.agentManager;\r\n      case 'resources':\r\n        return this.components.resourceManager;\r\n      case 'memory':\r\n        return this.components.memoryManager;\r\n      case 'monitoring':\r\n        return this.components.monitor;\r\n      case 'terminals':\r\n        return this.components.terminalManager;\r\n      default:\r\n        return null;\r\n    }\r\n  }\r\n\r\n  // Component-specific connection methods\r\n  private async connectOrchestrator(): Promise<void> {\r\n    if (!this.components.orchestrator) {\r\n      throw new MCPError('Orchestrator component not available');\r\n    }\r\n    // Add orchestrator-specific connection logic here\r\n  }\r\n\r\n  private async connectSwarmCoordinator(): Promise<void> {\r\n    if (!this.components.swarmCoordinator) {\r\n      throw new MCPError('Swarm coordinator component not available');\r\n    }\r\n    // Add swarm coordinator-specific connection logic here\r\n  }\r\n\r\n  private async connectAgentManager(): Promise<void> {\r\n    if (!this.components.agentManager) {\r\n      throw new MCPError('Agent manager component not available');\r\n    }\r\n    // Add agent manager-specific connection logic here\r\n  }\r\n\r\n  private async connectResourceManager(): Promise<void> {\r\n    if (!this.components.resourceManager) {\r\n      throw new MCPError('Resource manager component not available');\r\n    }\r\n    // Add resource manager-specific connection logic here\r\n  }\r\n\r\n  private async connectMemoryManager(): Promise<void> {\r\n    if (!this.components.memoryManager) {\r\n      throw new MCPError('Memory manager component not available');\r\n    }\r\n    // Add memory manager-specific connection logic here\r\n  }\r\n\r\n  private async connectMonitor(): Promise<void> {\r\n    if (!this.components.monitor) {\r\n      throw new MCPError('Monitor component not available');\r\n    }\r\n    // Add monitor-specific connection logic here\r\n  }\r\n\r\n  private async connectTerminalManager(): Promise<void> {\r\n    if (!this.components.terminalManager) {\r\n      throw new MCPError('Terminal manager component not available');\r\n    }\r\n    // Add terminal manager-specific connection logic here\r\n  }\r\n}\r\n"],"names":["EventEmitter","SystemEvents","MCPError","MCPServer","MCPLifecycleManager","LifecycleState","MCPPerformanceMonitor","MCPProtocolManager","MCPOrchestrationIntegration","server","lifecycleManager","performanceMonitor","protocolManager","integrationStatus","Map","healthCheckTimer","reconnectTimers","defaultConfig","enabledIntegrations","orchestrator","swarm","agents","resources","memory","monitoring","terminals","autoStart","healthCheckInterval","reconnectAttempts","reconnectDelay","enableMetrics","enableAlerts","mcpConfig","orchestrationConfig","components","logger","initializeIntegration","start","info","setupPerformanceMonitoring","eventBus","swarmCoordinator","agentManager","resourceManager","messageBus","monitor","setupLifecycleHandlers","registerOrchestrationTools","startHealthMonitoring","setupComponentIntegrations","emit","error","stop","stopHealthMonitoring","timer","values","clearTimeout","clear","getIntegrationStatus","Array","from","getComponentStatus","component","get","getServer","getLifecycleManager","getPerformanceMonitor","getProtocolManager","reconnectComponent","status","enabled","connectComponent","setComponentEnabled","disconnectComponent","set","connected","healthy","lastCheck","Date","on","event","previousState","to","state","message","SYSTEM_HEALTHCHECK","RUNNING","timestamp","metrics","recordMetrics","alert","warn","alertId","id","ruleName","severity","sendAlert","source","metadata","suggestion","type","priority","title","registerOrchestratorTools","registerSwarmTools","registerAgentTools","registerResourceTools","memoryManager","registerMemoryTools","registerMonitoringTools","terminalManager","registerTerminalTools","tools","name","description","inputSchema","properties","handler","getStatus","enum","limit","minimum","maximum","input","listTasks","tool","registerTool","listAgents","profile","config","required","spawnAgent","listResources","query","namespace","data","tags","items","store","getMetrics","getAlerts","listSessions","command","sessionId","execute","promises","entries","push","Promise","allSettled","connectOrchestrator","connectSwarmCoordinator","connectAgentManager","connectResourceManager","connectMemoryManager","connectMonitor","connectTerminalManager","undefined","Error","scheduleReconnect","delete","reconnectTimer","setTimeout","setInterval","performHealthChecks","clearInterval","checkComponentHealth","String","componentInstance","getComponentInstance","healthCheck","result"],"mappings":"AAKA,SAASA,YAAY,QAAQ,cAAc;AAE3C,SAAyCC,YAAY,QAAQ,oBAAoB;AACjF,SAASC,QAAQ,QAAQ,qBAAqB;AAC9C,SAASC,SAAS,QAAoB,cAAc;AACpD,SAASC,mBAAmB,EAAEC,cAAc,QAAQ,yBAAyB;AAC7E,SAASC,qBAAqB,QAAQ,2BAA2B;AACjE,SAASC,kBAAkB,QAAQ,wBAAwB;AA8C3D,OAAO,MAAMC,oCAAoCR;;;;;IACvCS,OAAoB;IACpBC,iBAAuC;IACvCC,mBAA2C;IAC3CC,gBAAqC;IAErCC,oBAAoB,IAAIC,MAAiC;IACzDC,iBAAkC;IAClCC,kBAAkB,IAAIF,MAA8B;IAE3CG,gBAAwC;QACvDC,qBAAqB;YACnBC,cAAc;YACdC,OAAO;YACPC,QAAQ;YACRC,WAAW;YACXC,QAAQ;YACRC,YAAY;YACZC,WAAW;QACb;QACAC,WAAW;QACXC,qBAAqB;QACrBC,mBAAmB;QACnBC,gBAAgB;QAChBC,eAAe;QACfC,cAAc;IAChB,EAAE;IAEF,YACE,AAAQC,SAAoB,EAC5B,AAAQC,mBAA2C,EACnD,AAAQC,UAAmC,EAC3C,AAAQC,MAAe,CACvB;QACA,KAAK,SALGH,YAAAA,gBACAC,sBAAAA,0BACAC,aAAAA,iBACAC,SAAAA;QAIR,IAAI,CAACF,mBAAmB,GAAG;YAAE,GAAG,IAAI,CAAChB,aAAa;YAAE,GAAGgB,mBAAmB;QAAC;QAC3E,IAAI,CAACG,qBAAqB;IAC5B;IAKA,MAAMC,QAAuB;QAC3B,IAAI,CAACF,MAAM,CAACG,IAAI,CAAC;QAEjB,IAAI;YAEF,IAAI,CAAC1B,eAAe,GAAG,IAAIL,mBAAmB,IAAI,CAAC4B,MAAM;YAGzD,IAAI,IAAI,CAACF,mBAAmB,CAACH,aAAa,EAAE;gBAC1C,IAAI,CAACnB,kBAAkB,GAAG,IAAIL,sBAAsB,IAAI,CAAC6B,MAAM;gBAC/D,IAAI,CAACI,0BAA0B;YACjC;YAGA,IAAI,CAAC9B,MAAM,GAAG,IAAIN,UAChB,IAAI,CAAC6B,SAAS,EACd,IAAI,CAACE,UAAU,CAACM,QAAQ,IAAI,IAAIxC,gBAChC,IAAI,CAACmC,MAAM,EACX,IAAI,CAACD,UAAU,CAACf,YAAY,EAC5B,IAAI,CAACe,UAAU,CAACO,gBAAgB,EAChC,IAAI,CAACP,UAAU,CAACQ,YAAY,EAC5B,IAAI,CAACR,UAAU,CAACS,eAAe,EAC/B,IAAI,CAACT,UAAU,CAACU,UAAU,EAC1B,IAAI,CAACV,UAAU,CAACW,OAAO;YAIzB,IAAI,CAACnC,gBAAgB,GAAG,IAAIN,oBAC1B,IAAI,CAAC4B,SAAS,EACd,IAAI,CAACG,MAAM,EACX,IAAM,IAAI,CAAC1B,MAAM;YAInB,IAAI,CAACqC,sBAAsB;YAG3B,IAAI,CAACC,0BAA0B;YAG/B,IAAI,IAAI,CAACd,mBAAmB,CAACP,SAAS,EAAE;gBACtC,MAAM,IAAI,CAAChB,gBAAgB,CAAC2B,KAAK;YACnC;YAGA,IAAI,CAACW,qBAAqB;YAG1B,MAAM,IAAI,CAACC,0BAA0B;YAErC,IAAI,CAACd,MAAM,CAACG,IAAI,CAAC;YACjB,IAAI,CAACY,IAAI,CAAC;QACZ,EAAE,OAAOC,OAAO;YACd,IAAI,CAAChB,MAAM,CAACgB,KAAK,CAAC,iDAAiDA;YACnE,MAAMA;QACR;IACF;IAKA,MAAMC,OAAsB;QAC1B,IAAI,CAACjB,MAAM,CAACG,IAAI,CAAC;QAEjB,IAAI;YAEF,IAAI,CAACe,oBAAoB;YAGzB,IAAI,IAAI,CAAC3C,gBAAgB,EAAE;gBACzB,MAAM,IAAI,CAACA,gBAAgB,CAAC0C,IAAI;YAClC;YAGA,IAAI,IAAI,CAACzC,kBAAkB,EAAE;gBAC3B,IAAI,CAACA,kBAAkB,CAACyC,IAAI;YAC9B;YAGA,KAAK,MAAME,SAAS,IAAI,CAACtC,eAAe,CAACuC,MAAM,GAAI;gBACjDC,aAAaF;YACf;YACA,IAAI,CAACtC,eAAe,CAACyC,KAAK;YAE1B,IAAI,CAACtB,MAAM,CAACG,IAAI,CAAC;YACjB,IAAI,CAACY,IAAI,CAAC;QACZ,EAAE,OAAOC,OAAO;YACd,IAAI,CAAChB,MAAM,CAACgB,KAAK,CAAC,gDAAgDA;YAClE,MAAMA;QACR;IACF;IAKAO,uBAA4C;QAC1C,OAAOC,MAAMC,IAAI,CAAC,IAAI,CAAC/C,iBAAiB,CAAC0C,MAAM;IACjD;IAKAM,mBAAmBC,SAAiB,EAAiC;QACnE,OAAO,IAAI,CAACjD,iBAAiB,CAACkD,GAAG,CAACD;IACpC;IAKAE,YAAoC;QAClC,OAAO,IAAI,CAACvD,MAAM;IACpB;IAKAwD,sBAAuD;QACrD,OAAO,IAAI,CAACvD,gBAAgB;IAC9B;IAKAwD,wBAA2D;QACzD,OAAO,IAAI,CAACvD,kBAAkB;IAChC;IAKAwD,qBAAqD;QACnD,OAAO,IAAI,CAACvD,eAAe;IAC7B;IAKA,MAAMwD,mBAAmBN,SAAiB,EAAiB;QACzD,MAAMO,SAAS,IAAI,CAACxD,iBAAiB,CAACkD,GAAG,CAACD;QAC1C,IAAI,CAACO,UAAU,CAACA,OAAOC,OAAO,EAAE;YAC9B,MAAM,IAAIpE,SAAS,CAAC,UAAU,EAAE4D,UAAU,eAAe,CAAC;QAC5D;QAEA,IAAI,CAAC3B,MAAM,CAACG,IAAI,CAAC,6BAA6B;YAAEwB;QAAU;QAE1D,IAAI;YACF,MAAM,IAAI,CAACS,gBAAgB,CAACT;YAC5B,IAAI,CAAC3B,MAAM,CAACG,IAAI,CAAC,yCAAyC;gBAAEwB;YAAU;QACxE,EAAE,OAAOX,OAAO;YACd,IAAI,CAAChB,MAAM,CAACgB,KAAK,CAAC,oCAAoC;gBAAEW;gBAAWX;YAAM;YACzE,MAAMA;QACR;IACF;IAKA,MAAMqB,oBAAoBV,SAAiB,EAAEQ,OAAgB,EAAiB;QAC5E,MAAMD,SAAS,IAAI,CAACxD,iBAAiB,CAACkD,GAAG,CAACD;QAC1C,IAAI,CAACO,QAAQ;YACX,MAAM,IAAInE,SAAS,CAAC,mBAAmB,EAAE4D,WAAW;QACtD;QAEAO,OAAOC,OAAO,GAAGA;QAEjB,IAAIA,SAAS;YACX,MAAM,IAAI,CAACC,gBAAgB,CAACT;QAC9B,OAAO;YACL,MAAM,IAAI,CAACW,mBAAmB,CAACX;QACjC;QAEA,IAAI,CAAC3B,MAAM,CAACG,IAAI,CAAC,iCAAiC;YAAEwB;YAAWQ;QAAQ;QACvE,IAAI,CAACpB,IAAI,CAAC,oBAAoB;YAAEY;YAAWQ;QAAQ;IACrD;IAEQlC,wBAA8B;QACpC,MAAMF,aAAa;YACjB;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAED,KAAK,MAAM4B,aAAa5B,WAAY;YAClC,IAAI,CAACrB,iBAAiB,CAAC6D,GAAG,CAACZ,WAAW;gBACpCA;gBACAQ,SACE,IAAI,CAACrC,mBAAmB,CAACf,mBAAmB,CAC1C4C,UACD;gBACHa,WAAW;gBACXC,SAAS;gBACTC,WAAW,IAAIC;YACjB;QACF;IACF;IAEQhC,yBAA+B;QACrC,IAAI,CAAC,IAAI,CAACpC,gBAAgB,EAAE;QAE5B,IAAI,CAACA,gBAAgB,CAACqE,EAAE,CAAC,eAAe,CAACC;YACvC,IAAI,CAAC7C,MAAM,CAACG,IAAI,CAAC,4BAA4B;gBAC3CsB,MAAMoB,MAAMC,aAAa;gBACzBC,IAAIF,MAAMG,KAAK;gBACfhC,OAAO6B,MAAM7B,KAAK,EAAEiC;YACtB;YAGA,IAAI,IAAI,CAAClD,UAAU,CAACM,QAAQ,EAAE;gBAC5B,IAAI,CAACN,UAAU,CAACM,QAAQ,CAACU,IAAI,CAACjD,aAAaoF,kBAAkB,EAAE;oBAC7DhB,QAAQW,MAAMG,KAAK,KAAK9E,eAAeiF,OAAO,GAAG,YAAY;oBAC7DxB,WAAW;oBACXyB,WAAWP,MAAMO,SAAS;gBAC5B;YACF;YAEA,IAAI,CAACrC,IAAI,CAAC,yBAAyB8B;QACrC;IACF;IAEQzC,6BAAmC;QACzC,IAAI,CAAC,IAAI,CAAC5B,kBAAkB,EAAE;QAE9B,IAAI,CAACA,kBAAkB,CAACoE,EAAE,CAAC,oBAAoB,CAACS;YAE9C,IAAI,IAAI,CAACtD,UAAU,CAACW,OAAO,IAAI,OAAO,IAAI,CAACX,UAAU,CAACW,OAAO,CAAC4C,aAAa,KAAK,YAAY;gBAC1F,IAAI,CAACvD,UAAU,CAACW,OAAO,CAAC4C,aAAa,CAAC,OAAOD;YAC/C;YAEA,IAAI,CAACtC,IAAI,CAAC,oBAAoBsC;QAChC;QAEA,IAAI,CAAC7E,kBAAkB,CAACoE,EAAE,CAAC,kBAAkB,CAACW;YAC5C,IAAI,CAACvD,MAAM,CAACwD,IAAI,CAAC,mCAAmC;gBAClDC,SAASF,MAAMG,EAAE;gBACjBC,UAAUJ,MAAMI,QAAQ;gBACxBC,UAAUL,MAAMK,QAAQ;gBACxBX,SAASM,MAAMN,OAAO;YACxB;YAGA,IAAI,IAAI,CAACnD,mBAAmB,CAACF,YAAY,IAAI,IAAI,CAACG,UAAU,CAACW,OAAO,EAAE;gBACpE,IAAI,OAAO,IAAI,CAACX,UAAU,CAACW,OAAO,CAACmD,SAAS,KAAK,YAAY;oBAC3D,IAAI,CAAC9D,UAAU,CAACW,OAAO,CAACmD,SAAS,CAAC;wBAChCC,QAAQ;wBACRF,UAAUL,MAAMK,QAAQ;wBACxBX,SAASM,MAAMN,OAAO;wBACtBc,UAAUR;oBACZ;gBACF;YACF;YAEA,IAAI,CAACxC,IAAI,CAAC,oBAAoBwC;QAChC;QAEA,IAAI,CAAC/E,kBAAkB,CAACoE,EAAE,CAAC,0BAA0B,CAACoB;YACpD,IAAI,CAAChE,MAAM,CAACG,IAAI,CAAC,+BAA+B;gBAC9C8D,MAAMD,WAAWC,IAAI;gBACrBC,UAAUF,WAAWE,QAAQ;gBAC7BC,OAAOH,WAAWG,KAAK;YACzB;YAEA,IAAI,CAACpD,IAAI,CAAC,0BAA0BiD;QACtC;IACF;IAEQpD,6BAAmC;QACzC,IAAI,CAAC,IAAI,CAACtC,MAAM,EAAE;QAGlB,IAAI,IAAI,CAACwB,mBAAmB,CAACf,mBAAmB,CAACC,YAAY,IAAI,IAAI,CAACe,UAAU,CAACf,YAAY,EAAE;YAC7F,IAAI,CAACoF,yBAAyB;QAChC;QAGA,IAAI,IAAI,CAACtE,mBAAmB,CAACf,mBAAmB,CAACE,KAAK,IAAI,IAAI,CAACc,UAAU,CAACO,gBAAgB,EAAE;YAC1F,IAAI,CAAC+D,kBAAkB;QACzB;QAGA,IAAI,IAAI,CAACvE,mBAAmB,CAACf,mBAAmB,CAACG,MAAM,IAAI,IAAI,CAACa,UAAU,CAACQ,YAAY,EAAE;YACvF,IAAI,CAAC+D,kBAAkB;QACzB;QAGA,IAAI,IAAI,CAACxE,mBAAmB,CAACf,mBAAmB,CAACI,SAAS,IAAI,IAAI,CAACY,UAAU,CAACS,eAAe,EAAE;YAC7F,IAAI,CAAC+D,qBAAqB;QAC5B;QAGA,IAAI,IAAI,CAACzE,mBAAmB,CAACf,mBAAmB,CAACK,MAAM,IAAI,IAAI,CAACW,UAAU,CAACyE,aAAa,EAAE;YACxF,IAAI,CAACC,mBAAmB;QAC1B;QAGA,IAAI,IAAI,CAAC3E,mBAAmB,CAACf,mBAAmB,CAACM,UAAU,IAAI,IAAI,CAACU,UAAU,CAACW,OAAO,EAAE;YACtF,IAAI,CAACgE,uBAAuB;QAC9B;QAGA,IAAI,IAAI,CAAC5E,mBAAmB,CAACf,mBAAmB,CAACO,SAAS,IAAI,IAAI,CAACS,UAAU,CAAC4E,eAAe,EAAE;YAC7F,IAAI,CAACC,qBAAqB;QAC5B;IACF;IAEQR,4BAAkC;QACxC,MAAMS,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACf,YAAY,EAAEmG,cAAc,YAAY;wBACjE,OAAO,MAAM,IAAI,CAACpF,UAAU,CAACf,YAAY,CAACmG,SAAS;oBACrD;oBACA,MAAM,IAAIpH,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBACXf,MAAM;oBACNgB,YAAY;wBACV/C,QAAQ;4BAAE+B,MAAM;4BAAUmB,MAAM;gCAAC;gCAAW;gCAAW;gCAAa;6BAAS;wBAAC;wBAC9EC,OAAO;4BAAEpB,MAAM;4BAAUqB,SAAS;4BAAGC,SAAS;wBAAI;oBACpD;gBACF;gBACAL,SAAS,OAAOM;oBACd,IAAI,OAAO,IAAI,CAACzF,UAAU,CAACf,YAAY,EAAEyG,cAAc,YAAY;wBACjE,OAAO,MAAM,IAAI,CAAC1F,UAAU,CAACf,YAAY,CAACyG,SAAS,CAACD;oBACtD;oBACA,MAAM,IAAIzH,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEQrB,qBAA2B;QACjC,MAAMQ,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACO,gBAAgB,EAAE6E,cAAc,YAAY;wBACrE,OAAO,MAAM,IAAI,CAACpF,UAAU,CAACO,gBAAgB,CAAC6E,SAAS;oBACzD;oBACA,MAAM,IAAIpH,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACO,gBAAgB,EAAEsF,eAAe,YAAY;wBACtE,OAAO,MAAM,IAAI,CAAC7F,UAAU,CAACO,gBAAgB,CAACsF,UAAU;oBAC1D;oBACA,MAAM,IAAI7H,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEQpB,qBAA2B;QACjC,MAAMO,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACQ,YAAY,EAAEqF,eAAe,YAAY;wBAClE,OAAO,MAAM,IAAI,CAAC7F,UAAU,CAACQ,YAAY,CAACqF,UAAU;oBACtD;oBACA,MAAM,IAAI7H,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBACXf,MAAM;oBACNgB,YAAY;wBACVY,SAAS;4BAAE5B,MAAM;wBAAS;wBAC1B6B,QAAQ;4BAAE7B,MAAM;wBAAS;oBAC3B;oBACA8B,UAAU;wBAAC;qBAAU;gBACvB;gBACAb,SAAS,OAAOM;oBACd,IAAI,OAAO,IAAI,CAACzF,UAAU,CAACQ,YAAY,EAAEyF,eAAe,YAAY;wBAClE,OAAO,MAAM,IAAI,CAACjG,UAAU,CAACQ,YAAY,CAACyF,UAAU,CAACR,MAAMK,OAAO,EAAEL,MAAMM,MAAM;oBAClF;oBACA,MAAM,IAAI/H,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEQnB,wBAA8B;QACpC,MAAMM,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACS,eAAe,EAAEyF,kBAAkB,YAAY;wBACxE,OAAO,MAAM,IAAI,CAAClG,UAAU,CAACS,eAAe,CAACyF,aAAa;oBAC5D;oBACA,MAAM,IAAIlI,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACS,eAAe,EAAE2E,cAAc,YAAY;wBACpE,OAAO,MAAM,IAAI,CAACpF,UAAU,CAACS,eAAe,CAAC2E,SAAS;oBACxD;oBACA,MAAM,IAAIpH,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEQjB,sBAA4B;QAClC,MAAMI,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBACXf,MAAM;oBACNgB,YAAY;wBACViB,OAAO;4BAAEjC,MAAM;wBAAS;wBACxBkC,WAAW;4BAAElC,MAAM;wBAAS;wBAC5BoB,OAAO;4BAAEpB,MAAM;wBAAS;oBAC1B;oBACA8B,UAAU;wBAAC;qBAAQ;gBACrB;gBACAb,SAAS,OAAOM;oBACd,IAAI,OAAO,IAAI,CAACzF,UAAU,CAACyE,aAAa,EAAE0B,UAAU,YAAY;wBAC9D,OAAO,MAAM,IAAI,CAACnG,UAAU,CAACyE,aAAa,CAAC0B,KAAK,CAACV;oBACnD;oBACA,MAAM,IAAIzH,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBACXf,MAAM;oBACNgB,YAAY;wBACVmB,MAAM;4BAAEnC,MAAM;wBAAS;wBACvBkC,WAAW;4BAAElC,MAAM;wBAAS;wBAC5BoC,MAAM;4BAAEpC,MAAM;4BAASqC,OAAO;gCAAErC,MAAM;4BAAS;wBAAE;oBACnD;oBACA8B,UAAU;wBAAC;qBAAO;gBACpB;gBACAb,SAAS,OAAOM;oBACd,IAAI,OAAO,IAAI,CAACzF,UAAU,CAACyE,aAAa,EAAE+B,UAAU,YAAY;wBAC9D,OAAO,MAAM,IAAI,CAACxG,UAAU,CAACyE,aAAa,CAAC+B,KAAK,CAACf;oBACnD;oBACA,MAAM,IAAIzH,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEQhB,0BAAgC;QACtC,MAAMG,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACW,OAAO,EAAE8F,eAAe,YAAY;wBAC7D,OAAO,MAAM,IAAI,CAACzG,UAAU,CAACW,OAAO,CAAC8F,UAAU;oBACjD;oBACA,MAAM,IAAIzI,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAACW,OAAO,EAAE+F,cAAc,YAAY;wBAC5D,OAAO,MAAM,IAAI,CAAC1G,UAAU,CAACW,OAAO,CAAC+F,SAAS;oBAChD;oBACA,MAAM,IAAI1I,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEQd,wBAA8B;QACpC,MAAMC,QAAmB;YACvB;gBACEC,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBAAEf,MAAM;oBAAUgB,YAAY,CAAC;gBAAE;gBAC9CC,SAAS;oBACP,IAAI,OAAO,IAAI,CAACnF,UAAU,CAAC4E,eAAe,EAAE+B,iBAAiB,YAAY;wBACvE,OAAO,MAAM,IAAI,CAAC3G,UAAU,CAAC4E,eAAe,CAAC+B,YAAY;oBAC3D;oBACA,MAAM,IAAI3I,SAAS;gBACrB;YACF;YACA;gBACE+G,MAAM;gBACNC,aAAa;gBACbC,aAAa;oBACXf,MAAM;oBACNgB,YAAY;wBACV0B,SAAS;4BAAE1C,MAAM;wBAAS;wBAC1B2C,WAAW;4BAAE3C,MAAM;wBAAS;oBAC9B;oBACA8B,UAAU;wBAAC;qBAAU;gBACvB;gBACAb,SAAS,OAAOM;oBACd,IAAI,OAAO,IAAI,CAACzF,UAAU,CAAC4E,eAAe,EAAEkC,YAAY,YAAY;wBAClE,OAAO,MAAM,IAAI,CAAC9G,UAAU,CAAC4E,eAAe,CAACkC,OAAO,CAACrB,MAAMmB,OAAO,EAAEnB,MAAMoB,SAAS;oBACrF;oBACA,MAAM,IAAI7I,SAAS;gBACrB;YACF;SACD;QAED,KAAK,MAAM2H,QAAQb,MAAO;YACxB,IAAI,CAACvG,MAAM,CAAEqH,YAAY,CAACD;QAC5B;IACF;IAEA,MAAc5E,6BAA4C;QACxD,MAAMgG,WAAW,EAAE;QAEnB,KAAK,MAAM,CAACnF,WAAWO,OAAO,IAAI,IAAI,CAACxD,iBAAiB,CAACqI,OAAO,GAAI;YAClE,IAAI7E,OAAOC,OAAO,EAAE;gBAClB2E,SAASE,IAAI,CAAC,IAAI,CAAC5E,gBAAgB,CAACT;YACtC;QACF;QAEA,MAAMsF,QAAQC,UAAU,CAACJ;IAC3B;IAEA,MAAc1E,iBAAiBT,SAAiB,EAAiB;QAC/D,MAAMO,SAAS,IAAI,CAACxD,iBAAiB,CAACkD,GAAG,CAACD;QAC1C,IAAI,CAACO,QAAQ;QAEb,IAAI;YAEF,OAAQP;gBACN,KAAK;oBACH,MAAM,IAAI,CAACwF,mBAAmB;oBAC9B;gBACF,KAAK;oBACH,MAAM,IAAI,CAACC,uBAAuB;oBAClC;gBACF,KAAK;oBACH,MAAM,IAAI,CAACC,mBAAmB;oBAC9B;gBACF,KAAK;oBACH,MAAM,IAAI,CAACC,sBAAsB;oBACjC;gBACF,KAAK;oBACH,MAAM,IAAI,CAACC,oBAAoB;oBAC/B;gBACF,KAAK;oBACH,MAAM,IAAI,CAACC,cAAc;oBACzB;gBACF,KAAK;oBACH,MAAM,IAAI,CAACC,sBAAsB;oBACjC;YACJ;YAEAvF,OAAOM,SAAS,GAAG;YACnBN,OAAOO,OAAO,GAAG;YACjBP,OAAOQ,SAAS,GAAG,IAAIC;YACvBT,OAAOlB,KAAK,GAAG0G;YAEf,IAAI,CAAC1H,MAAM,CAACG,IAAI,CAAC,uBAAuB;gBAAEwB;YAAU;YACpD,IAAI,CAACZ,IAAI,CAAC,sBAAsB;gBAAEY;YAAU;QAC9C,EAAE,OAAOX,OAAO;YACdkB,OAAOM,SAAS,GAAG;YACnBN,OAAOO,OAAO,GAAG;YACjBP,OAAOlB,KAAK,GAAGA,iBAAiB2G,QAAQ3G,MAAMiC,OAAO,GAAG;YAExD,IAAI,CAACjD,MAAM,CAACgB,KAAK,CAAC,+BAA+B;gBAAEW;gBAAWX;YAAM;YACpE,IAAI,CAAC4G,iBAAiB,CAACjG;QACzB;IACF;IAEA,MAAcW,oBAAoBX,SAAiB,EAAiB;QAClE,MAAMO,SAAS,IAAI,CAACxD,iBAAiB,CAACkD,GAAG,CAACD;QAC1C,IAAI,CAACO,QAAQ;QAEbA,OAAOM,SAAS,GAAG;QACnBN,OAAOO,OAAO,GAAG;QACjBP,OAAOQ,SAAS,GAAG,IAAIC;QAGvB,MAAMxB,QAAQ,IAAI,CAACtC,eAAe,CAAC+C,GAAG,CAACD;QACvC,IAAIR,OAAO;YACTE,aAAaF;YACb,IAAI,CAACtC,eAAe,CAACgJ,MAAM,CAAClG;QAC9B;QAEA,IAAI,CAAC3B,MAAM,CAACG,IAAI,CAAC,0BAA0B;YAAEwB;QAAU;QACvD,IAAI,CAACZ,IAAI,CAAC,yBAAyB;YAAEY;QAAU;IACjD;IAEQiG,kBAAkBjG,SAAiB,EAAQ;QACjD,MAAMR,QAAQ,IAAI,CAACtC,eAAe,CAAC+C,GAAG,CAACD;QACvC,IAAIR,OAAO;QAEX,MAAM2G,iBAAiBC,WAAW;YAChC,IAAI,CAAClJ,eAAe,CAACgJ,MAAM,CAAClG;YAC5B,IAAI;gBACF,MAAM,IAAI,CAACS,gBAAgB,CAACT;YAC9B,EAAE,OAAOX,OAAO,CAEhB;QACF,GAAG,IAAI,CAAClB,mBAAmB,CAACJ,cAAc;QAE1C,IAAI,CAACb,eAAe,CAAC0D,GAAG,CAACZ,WAAWmG;IACtC;IAEQjH,wBAA8B;QACpC,IAAI,CAACjC,gBAAgB,GAAGoJ,YAAY;YAClC,MAAM,IAAI,CAACC,mBAAmB;QAChC,GAAG,IAAI,CAACnI,mBAAmB,CAACN,mBAAmB;IACjD;IAEQ0B,uBAA6B;QACnC,IAAI,IAAI,CAACtC,gBAAgB,EAAE;YACzBsJ,cAAc,IAAI,CAACtJ,gBAAgB;YACnC,IAAI,CAACA,gBAAgB,GAAG8I;QAC1B;IACF;IAEA,MAAcO,sBAAqC;QACjD,KAAK,MAAM,CAACtG,WAAWO,OAAO,IAAI,IAAI,CAACxD,iBAAiB,CAACqI,OAAO,GAAI;YAClE,IAAI,CAAC7E,OAAOC,OAAO,IAAI,CAACD,OAAOM,SAAS,EAAE;YAE1C,IAAI;gBACF,MAAMC,UAAU,MAAM,IAAI,CAAC0F,oBAAoB,CAACxG;gBAChDO,OAAOO,OAAO,GAAGA;gBACjBP,OAAOQ,SAAS,GAAG,IAAIC;gBACvBT,OAAOlB,KAAK,GAAG0G;YACjB,EAAE,OAAO1G,OAAO;gBACdkB,OAAOO,OAAO,GAAG;gBACjBP,OAAOlB,KAAK,GACVA,iBAAiB2G,QACb3G,iBAAiB2G,QACf3G,MAAMiC,OAAO,GACbmF,OAAOpH,SACT;gBACN,IAAI,CAAChB,MAAM,CAACwD,IAAI,CAAC,iCAAiC;oBAAE7B;oBAAWX;gBAAM;YACvE;QACF;IACF;IAEA,MAAcmH,qBAAqBxG,SAAiB,EAAoB;QACtE,MAAM0G,oBAAoB,IAAI,CAACC,oBAAoB,CAAC3G;QACpD,IAAI,CAAC0G,mBAAmB,OAAO;QAG/B,IAAI,OAAOA,kBAAkBE,WAAW,KAAK,YAAY;YACvD,MAAMC,SAAS,MAAMH,kBAAkBE,WAAW;YAClD,OAAOC,WAAW,QAAS,OAAOA,WAAW,YAAYA,OAAO/F,OAAO,KAAK;QAC9E;QAGA,OAAO;IACT;IAEQ6F,qBAAqB3G,SAAiB,EAAO;QACnD,OAAQA;YACN,KAAK;gBACH,OAAO,IAAI,CAAC5B,UAAU,CAACf,YAAY;YACrC,KAAK;gBACH,OAAO,IAAI,CAACe,UAAU,CAACO,gBAAgB;YACzC,KAAK;gBACH,OAAO,IAAI,CAACP,UAAU,CAACQ,YAAY;YACrC,KAAK;gBACH,OAAO,IAAI,CAACR,UAAU,CAACS,eAAe;YACxC,KAAK;gBACH,OAAO,IAAI,CAACT,UAAU,CAACyE,aAAa;YACtC,KAAK;gBACH,OAAO,IAAI,CAACzE,UAAU,CAACW,OAAO;YAChC,KAAK;gBACH,OAAO,IAAI,CAACX,UAAU,CAAC4E,eAAe;YACxC;gBACE,OAAO;QACX;IACF;IAGA,MAAcwC,sBAAqC;QACjD,IAAI,CAAC,IAAI,CAACpH,UAAU,CAACf,YAAY,EAAE;YACjC,MAAM,IAAIjB,SAAS;QACrB;IAEF;IAEA,MAAcqJ,0BAAyC;QACrD,IAAI,CAAC,IAAI,CAACrH,UAAU,CAACO,gBAAgB,EAAE;YACrC,MAAM,IAAIvC,SAAS;QACrB;IAEF;IAEA,MAAcsJ,sBAAqC;QACjD,IAAI,CAAC,IAAI,CAACtH,UAAU,CAACQ,YAAY,EAAE;YACjC,MAAM,IAAIxC,SAAS;QACrB;IAEF;IAEA,MAAcuJ,yBAAwC;QACpD,IAAI,CAAC,IAAI,CAACvH,UAAU,CAACS,eAAe,EAAE;YACpC,MAAM,IAAIzC,SAAS;QACrB;IAEF;IAEA,MAAcwJ,uBAAsC;QAClD,IAAI,CAAC,IAAI,CAACxH,UAAU,CAACyE,aAAa,EAAE;YAClC,MAAM,IAAIzG,SAAS;QACrB;IAEF;IAEA,MAAcyJ,iBAAgC;QAC5C,IAAI,CAAC,IAAI,CAACzH,UAAU,CAACW,OAAO,EAAE;YAC5B,MAAM,IAAI3C,SAAS;QACrB;IAEF;IAEA,MAAc0J,yBAAwC;QACpD,IAAI,CAAC,IAAI,CAAC1H,UAAU,CAAC4E,eAAe,EAAE;YACpC,MAAM,IAAI5G,SAAS;QACrB;IAEF;AACF"}
{"version":3,"sources":["../../../../../src/cli/simple-commands/sparc-modes/supabase-admin.js"],"sourcesContent":["// supabase-admin.js - Supabase Admin mode orchestration template\r\nexport function getSupabaseAdminOrchestration(taskDescription, memoryNamespace) {\r\n  return `\r\n## Task Orchestration Steps - Supabase MCP Mode\r\n\r\n1. **Requirements Analysis & MCP Setup** (10 mins)\r\n   - Analyze database requirements: \"${taskDescription}\"\r\n   - Query existing project context:\r\n     \\`\\`\\`bash\r\n     npx claude-flow memory query ${memoryNamespace}_architecture\r\n     npx claude-flow memory query ${memoryNamespace}_data_models\r\n     npx claude-flow memory query ${memoryNamespace}_auth_requirements\r\n     \\`\\`\\`\r\n   - Connect to Supabase via MCP:\r\n     - List organizations: \\`list_organizations\\`\r\n     - List existing projects: \\`list_projects\\`\r\n     - Get project details if exists\r\n   - Review cost implications:\r\n     - Use \\`get_cost\\` before creating resources\r\n     - Confirm costs with user via \\`confirm_cost\\`\r\n   - Store analysis: \\`npx claude-flow memory store ${memoryNamespace}_supabase_requirements \"Requirements: ${taskDescription}. Tables needed: users, profiles, permissions. Auth: Email + OAuth. Storage: user avatars, documents.\"\\`\r\n\r\n2. **Database Schema Design** (15 mins)\r\n   - Design PostgreSQL schemas optimized for Supabase:\r\n     - Normalize data structures\r\n     - Plan for real-time subscriptions\r\n     - Design for RLS efficiency\r\n   - Define table relationships:\r\n     - Foreign keys and constraints\r\n     - Cascade rules\r\n     - Junction tables for many-to-many\r\n   - Plan indexes for performance:\r\n     - Primary key indexes\r\n     - Foreign key indexes\r\n     - Composite indexes for queries\r\n   - Design audit/history tables if needed\r\n   - Create modular migration approach (<500 lines per file)\r\n   - Store design: \\`npx claude-flow memory store ${memoryNamespace}_db_design \"Tables: users (id, email, created_at), profiles (user_id, full_name, avatar_url), roles (id, name), user_roles (user_id, role_id). Indexes: users_email_idx, profiles_user_id_idx.\"\\`\r\n\r\n3. **Schema Implementation via MCP** (20 mins)\r\n   - Create development branch (if needed):\r\n     - Check costs: \\`get_cost type:\"branch\"\\`\r\n     - Create branch: \\`create_branch\\`\r\n   - Implement schema using \\`execute_sql\\`:\r\n     \\`\\`\\`sql\r\n     -- Create schemas\r\n     CREATE SCHEMA IF NOT EXISTS auth_ext;\r\n     CREATE SCHEMA IF NOT EXISTS app;\r\n     \r\n     -- Create tables\r\n     CREATE TABLE app.profiles (\r\n       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n       user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,\r\n       full_name TEXT,\r\n       avatar_url TEXT,\r\n       created_at TIMESTAMPTZ DEFAULT NOW()\r\n     );\r\n     \\`\\`\\`\r\n   - Add performance indexes\r\n   - Create database functions and triggers\r\n   - Set up audit trails\r\n   - Store migrations: \\`npx claude-flow memory store ${memoryNamespace}_migrations \"Created: 5 tables, 8 indexes, 3 functions, 2 triggers. Branch: dev-${Date.now()}. Ready for RLS policies.\"\\`\r\n\r\n4. **Security & RLS Implementation** (15 mins)\r\n   - Implement Row Level Security policies:\r\n     - Enable RLS on all tables\r\n     - Create policies for CRUD operations\r\n     - Test policy effectiveness\r\n   - Configure authentication:\r\n     - Set up auth providers\r\n     - Configure JWT claims\r\n     - Create custom auth functions\r\n   - Implement data access patterns:\r\n     - User can only see own data\r\n     - Role-based access for admins\r\n     - Public read for certain tables\r\n   - Create security functions:\r\n     \\`\\`\\`sql\r\n     CREATE FUNCTION auth.user_has_role(role_name TEXT) \r\n     RETURNS BOOLEAN AS $$\r\n       SELECT EXISTS (\r\n         SELECT 1 FROM app.user_roles ur\r\n         JOIN app.roles r ON ur.role_id = r.id\r\n         WHERE ur.user_id = auth.uid() \r\n         AND r.name = role_name\r\n       );\r\n     $$ LANGUAGE SQL SECURITY DEFINER;\r\n     \\`\\`\\`\r\n   - Store security config: \\`npx claude-flow memory store ${memoryNamespace}_security \"RLS enabled on all tables. Policies: 15 created (CRUD + special cases). Auth providers: email, google. Custom claims: user_role, organization_id.\"\\`\r\n\r\n5. **API & Storage Configuration** (10 mins)\r\n   - Generate TypeScript types:\r\n     - Use \\`generate_typescript_types\\`\r\n     - Save to project repository\r\n   - Configure storage buckets:\r\n     - Create buckets for different file types\r\n     - Set up access policies\r\n     - Configure file size limits\r\n   - Document API endpoints:\r\n     - Get project URL: \\`get_project_url\\`\r\n     - Get anon key: \\`get_anon_key\\`\r\n     - Create API documentation\r\n   - Set up Edge Functions (if needed)\r\n   - Test API access patterns\r\n   - Store completion: \\`npx claude-flow memory store ${memoryNamespace}_supabase_complete \"Supabase setup complete. API URL: https://xxx.supabase.co. Types generated. Storage buckets: avatars (public), documents (authenticated). Ready for integration.\"\\`\r\n\r\n## Deliverables\r\n- migrations/\r\n  - 001_initial_schema.sql\r\n  - 002_create_profiles.sql\r\n  - 003_add_indexes.sql\r\n  - 004_rls_policies.sql\r\n  - 005_auth_functions.sql\r\n- types/\r\n  - supabase.ts (generated types)\r\n  - database.types.ts\r\n- docs/\r\n  - SCHEMA_DESIGN.md\r\n  - RLS_POLICIES.md\r\n  - API_ENDPOINTS.md\r\n  - STORAGE_GUIDE.md\r\n- config/\r\n  - supabase-config.json\r\n  - .env.example (with Supabase URLs)\r\n\r\n## Supabase Best Practices\r\n- NEVER expose service role key in code\r\n- Always use RLS for data protection\r\n- Test policies thoroughly before production\r\n- Use \\`execute_sql\\` for data operations, not \\`apply_migration\\`\r\n- Keep migration files modular and < 500 lines\r\n- Document all custom functions and triggers\r\n- Use parameterized queries to prevent SQL injection\r\n- Monitor database performance and optimize queries\r\n\r\n## MCP Tool Reminders\r\n- Always check costs before creating resources\r\n- Use development branches for testing\r\n- Verify changes with \\`list_tables\\` and \\`list_migrations\\`\r\n- Use \\`get_logs\\` to debug issues\r\n- Test API access with generated types\r\n- Document all database objects\r\n\r\n## Next Steps\r\nAfter Supabase setup:\r\n- \\`npx claude-flow sparc run code \"Integrate Supabase client in application\" --non-interactive\\`\r\n- \\`npx claude-flow sparc run tdd \"Write tests for Supabase operations\" --non-interactive\\`\r\n- \\`npx claude-flow sparc run docs-writer \"Create Supabase integration guide\" --non-interactive\\``;\r\n}\r\n"],"names":["getSupabaseAdminOrchestration","taskDescription","memoryNamespace","Date","now"],"mappings":"AACA,OAAO,SAASA,8BAA8BC,eAAe,EAAEC,eAAe;IAC5E,OAAO,CAAC;;;;qCAI2B,EAAED,gBAAgB;;;kCAGrB,EAAEC,gBAAgB;kCAClB,EAAEA,gBAAgB;kCAClB,EAAEA,gBAAgB;;;;;;;;;oDASA,EAAEA,gBAAgB,sCAAsC,EAAED,gBAAgB;;;;;;;;;;;;;;;;;kDAiB5E,EAAEC,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;sDAwBd,EAAEA,gBAAgB,gFAAgF,EAAEC,KAAKC,GAAG,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;2DA2B1G,EAAEF,gBAAgB;;;;;;;;;;;;;;;;sDAgBvB,EAAEA,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;iGA2CyB,CAAC;AAClG"}
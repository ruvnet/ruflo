{"version":3,"sources":["../../../../src/mcp/recovery/connection-health-monitor.ts"],"sourcesContent":["/**\r\n * Connection Health Monitor for MCP\r\n * Monitors connection health and triggers recovery when needed\r\n */\r\n\r\nimport { EventEmitter } from 'node:events';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport type { MCPClient } from '../client.js';\r\n\r\nexport interface HealthStatus {\r\n  healthy: boolean;\r\n  lastHeartbeat: Date;\r\n  missedHeartbeats: number;\r\n  latency: number;\r\n  connectionState: 'connected' | 'disconnected' | 'reconnecting';\r\n  error?: string;\r\n}\r\n\r\nexport interface HealthMonitorConfig {\r\n  heartbeatInterval: number;\r\n  heartbeatTimeout: number;\r\n  maxMissedHeartbeats: number;\r\n  enableAutoRecovery: boolean;\r\n}\r\n\r\nexport class ConnectionHealthMonitor extends EventEmitter {\r\n  private heartbeatTimer?: NodeJS.Timeout;\r\n  private timeoutTimer?: NodeJS.Timeout;\r\n  private lastHeartbeat: Date = new Date();\r\n  private missedHeartbeats = 0;\r\n  private currentLatency = 0;\r\n  private isMonitoring = false;\r\n  private healthStatus: HealthStatus;\r\n\r\n  private readonly defaultConfig: HealthMonitorConfig = {\r\n    heartbeatInterval: 5000,\r\n    heartbeatTimeout: 10000,\r\n    maxMissedHeartbeats: 3,\r\n    enableAutoRecovery: true,\r\n  };\r\n\r\n  constructor(\r\n    private client: MCPClient,\r\n    private logger: ILogger,\r\n    config?: Partial<HealthMonitorConfig>,\r\n  ) {\r\n    super();\r\n    this.config = { ...this.defaultConfig, ...config };\r\n\r\n    this.healthStatus = {\r\n      healthy: false,\r\n      lastHeartbeat: new Date(),\r\n      missedHeartbeats: 0,\r\n      latency: 0,\r\n      connectionState: 'disconnected',\r\n    };\r\n  }\r\n\r\n  private config: HealthMonitorConfig;\r\n\r\n  /**\r\n   * Start health monitoring\r\n   */\r\n  async start(): Promise<void> {\r\n    if (this.isMonitoring) {\r\n      this.logger.warn('Health monitor already running');\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Starting connection health monitor', {\r\n      config: this.config,\r\n    });\r\n\r\n    this.isMonitoring = true;\r\n    this.missedHeartbeats = 0;\r\n    this.lastHeartbeat = new Date();\r\n\r\n    // Start heartbeat cycle\r\n    this.scheduleHeartbeat();\r\n\r\n    // Update initial status\r\n    this.updateHealthStatus('connected');\r\n    this.emit('started');\r\n  }\r\n\r\n  /**\r\n   * Stop health monitoring\r\n   */\r\n  async stop(): Promise<void> {\r\n    if (!this.isMonitoring) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Stopping connection health monitor');\r\n    this.isMonitoring = false;\r\n\r\n    if (this.heartbeatTimer) {\r\n      clearTimeout(this.heartbeatTimer);\r\n      this.heartbeatTimer = undefined;\r\n    }\r\n\r\n    if (this.timeoutTimer) {\r\n      clearTimeout(this.timeoutTimer);\r\n      this.timeoutTimer = undefined;\r\n    }\r\n\r\n    this.updateHealthStatus('disconnected');\r\n    this.emit('stopped');\r\n  }\r\n\r\n  /**\r\n   * Get current health status\r\n   */\r\n  getHealthStatus(): HealthStatus {\r\n    return { ...this.healthStatus };\r\n  }\r\n\r\n  /**\r\n   * Check connection health immediately\r\n   */\r\n  async checkHealth(): Promise<HealthStatus> {\r\n    try {\r\n      const startTime = Date.now();\r\n\r\n      // Send heartbeat ping\r\n      await this.sendHeartbeat();\r\n\r\n      // Calculate latency\r\n      this.currentLatency = Date.now() - startTime;\r\n      this.lastHeartbeat = new Date();\r\n      this.missedHeartbeats = 0;\r\n\r\n      this.updateHealthStatus('connected', true);\r\n\r\n      return this.getHealthStatus();\r\n    } catch (error) {\r\n      this.logger.error('Health check failed', error);\r\n      this.handleHeartbeatFailure(error as Error);\r\n      return this.getHealthStatus();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Force a health check\r\n   */\r\n  async forceCheck(): Promise<void> {\r\n    this.logger.debug('Forcing health check');\r\n\r\n    // Cancel current timers\r\n    if (this.heartbeatTimer) {\r\n      clearTimeout(this.heartbeatTimer);\r\n    }\r\n    if (this.timeoutTimer) {\r\n      clearTimeout(this.timeoutTimer);\r\n    }\r\n\r\n    // Perform immediate check\r\n    await this.performHeartbeat();\r\n  }\r\n\r\n  private scheduleHeartbeat(): void {\r\n    if (!this.isMonitoring) {\r\n      return;\r\n    }\r\n\r\n    this.heartbeatTimer = setTimeout(() => {\r\n      this.performHeartbeat().catch((error) => {\r\n        this.logger.error('Heartbeat error', error);\r\n      });\r\n    }, this.config.heartbeatInterval);\r\n  }\r\n\r\n  private async performHeartbeat(): Promise<void> {\r\n    if (!this.isMonitoring) {\r\n      return;\r\n    }\r\n\r\n    this.logger.debug('Performing heartbeat');\r\n\r\n    try {\r\n      // Set timeout for heartbeat response\r\n      this.setHeartbeatTimeout();\r\n\r\n      const startTime = Date.now();\r\n      await this.sendHeartbeat();\r\n\r\n      // Clear timeout on success\r\n      this.clearHeartbeatTimeout();\r\n\r\n      // Update metrics\r\n      this.currentLatency = Date.now() - startTime;\r\n      this.lastHeartbeat = new Date();\r\n      this.missedHeartbeats = 0;\r\n\r\n      this.logger.debug('Heartbeat successful', {\r\n        latency: this.currentLatency,\r\n      });\r\n\r\n      this.updateHealthStatus('connected', true);\r\n\r\n      // Schedule next heartbeat\r\n      this.scheduleHeartbeat();\r\n    } catch (error) {\r\n      this.handleHeartbeatFailure(error as Error);\r\n    }\r\n  }\r\n\r\n  private async sendHeartbeat(): Promise<void> {\r\n    // Send heartbeat notification via MCP\r\n    await this.client.notify('heartbeat', {\r\n      timestamp: Date.now(),\r\n      sessionId: this.generateSessionId(),\r\n    });\r\n  }\r\n\r\n  private setHeartbeatTimeout(): void {\r\n    this.timeoutTimer = setTimeout(() => {\r\n      this.handleHeartbeatTimeout();\r\n    }, this.config.heartbeatTimeout);\r\n  }\r\n\r\n  private clearHeartbeatTimeout(): void {\r\n    if (this.timeoutTimer) {\r\n      clearTimeout(this.timeoutTimer);\r\n      this.timeoutTimer = undefined;\r\n    }\r\n  }\r\n\r\n  private handleHeartbeatTimeout(): void {\r\n    this.logger.warn('Heartbeat timeout');\r\n    this.handleHeartbeatFailure(new Error('Heartbeat timeout'));\r\n  }\r\n\r\n  private handleHeartbeatFailure(error: Error): void {\r\n    this.clearHeartbeatTimeout();\r\n\r\n    this.missedHeartbeats++;\r\n    this.logger.warn('Heartbeat failed', {\r\n      missedHeartbeats: this.missedHeartbeats,\r\n      maxMissed: this.config.maxMissedHeartbeats,\r\n      error: error instanceof Error ? error.message : String(error),\r\n    });\r\n\r\n    if (this.missedHeartbeats >= this.config.maxMissedHeartbeats) {\r\n      this.logger.error('Max missed heartbeats exceeded, connection unhealthy');\r\n      this.updateHealthStatus(\r\n        'disconnected',\r\n        false,\r\n        error instanceof Error ? error.message : String(error),\r\n      );\r\n\r\n      if (this.config.enableAutoRecovery) {\r\n        this.emit('connectionLost', { error });\r\n      }\r\n    } else {\r\n      // Schedule next heartbeat with backoff\r\n      const backoffDelay = this.config.heartbeatInterval * (this.missedHeartbeats + 1);\r\n      this.logger.debug('Scheduling heartbeat with backoff', { delay: backoffDelay });\r\n\r\n      this.heartbeatTimer = setTimeout(() => {\r\n        this.performHeartbeat().catch((err) => {\r\n          this.logger.error('Backoff heartbeat error', err);\r\n        });\r\n      }, backoffDelay);\r\n    }\r\n  }\r\n\r\n  private updateHealthStatus(\r\n    connectionState: 'connected' | 'disconnected' | 'reconnecting',\r\n    healthy?: boolean,\r\n    error?: string,\r\n  ): void {\r\n    const previousStatus = { ...this.healthStatus };\r\n\r\n    this.healthStatus = {\r\n      healthy: healthy ?? connectionState === 'connected',\r\n      lastHeartbeat: this.lastHeartbeat,\r\n      missedHeartbeats: this.missedHeartbeats,\r\n      latency: this.currentLatency,\r\n      connectionState,\r\n      error,\r\n    };\r\n\r\n    // Emit event if health changed\r\n    if (\r\n      previousStatus.healthy !== this.healthStatus.healthy ||\r\n      previousStatus.connectionState !== this.healthStatus.connectionState\r\n    ) {\r\n      this.logger.info('Health status changed', {\r\n        from: previousStatus.connectionState,\r\n        to: this.healthStatus.connectionState,\r\n        healthy: this.healthStatus.healthy,\r\n      });\r\n\r\n      this.emit('healthChange', this.healthStatus, previousStatus);\r\n    }\r\n  }\r\n\r\n  private generateSessionId(): string {\r\n    return `session-${Date.now()}-${Math.random().toString(36).slice(2)}`;\r\n  }\r\n\r\n  /**\r\n   * Reset monitor state\r\n   */\r\n  reset(): void {\r\n    this.missedHeartbeats = 0;\r\n    this.currentLatency = 0;\r\n    this.lastHeartbeat = new Date();\r\n\r\n    if (this.isMonitoring) {\r\n      this.logger.debug('Resetting health monitor');\r\n      this.clearHeartbeatTimeout();\r\n      this.scheduleHeartbeat();\r\n    }\r\n  }\r\n}\r\n"],"names":["EventEmitter","ConnectionHealthMonitor","heartbeatTimer","timeoutTimer","lastHeartbeat","Date","missedHeartbeats","currentLatency","isMonitoring","healthStatus","defaultConfig","heartbeatInterval","heartbeatTimeout","maxMissedHeartbeats","enableAutoRecovery","client","logger","config","healthy","latency","connectionState","start","warn","info","scheduleHeartbeat","updateHealthStatus","emit","stop","clearTimeout","undefined","getHealthStatus","checkHealth","startTime","now","sendHeartbeat","error","handleHeartbeatFailure","forceCheck","debug","performHeartbeat","setTimeout","catch","setHeartbeatTimeout","clearHeartbeatTimeout","notify","timestamp","sessionId","generateSessionId","handleHeartbeatTimeout","Error","maxMissed","message","String","backoffDelay","delay","err","previousStatus","from","to","Math","random","toString","slice","reset"],"mappings":"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"}
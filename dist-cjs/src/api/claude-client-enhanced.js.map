{"version":3,"sources":["../../../src/api/claude-client-enhanced.ts"],"sourcesContent":["/**\r\n * Enhanced Claude API client with comprehensive error handling\r\n * Implements exponential backoff, health checks, and improved error messages\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport { ILogger } from '../core/logger.js';\r\nimport { ConfigManager } from '../config/config-manager.js';\r\nimport { \r\n  ClaudeAPIError,\r\n  ClaudeInternalServerError,\r\n  ClaudeServiceUnavailableError,\r\n  ClaudeRateLimitError,\r\n  ClaudeTimeoutError,\r\n  ClaudeNetworkError,\r\n  ClaudeAuthenticationError,\r\n  ClaudeValidationError,\r\n  HealthCheckResult,\r\n  getUserFriendlyError,\r\n} from './claude-api-errors.js';\r\nimport { circuitBreaker, CircuitBreaker } from '../utils/helpers.js';\r\nimport { \r\n  ClaudeAPIConfig, \r\n  ClaudeModel, \r\n  ClaudeMessage, \r\n  ClaudeRequest, \r\n  ClaudeResponse,\r\n  ClaudeStreamEvent,\r\n} from './claude-client.js';\r\n\r\nexport interface EnhancedClaudeAPIConfig extends ClaudeAPIConfig {\r\n  enableHealthCheck?: boolean;\r\n  healthCheckInterval?: number;\r\n  circuitBreakerThreshold?: number;\r\n  circuitBreakerTimeout?: number;\r\n  circuitBreakerResetTimeout?: number;\r\n  maxRetries?: number;\r\n  retryBaseDelay?: number;\r\n  retryMaxDelay?: number;\r\n  retryJitter?: boolean;\r\n}\r\n\r\nexport class EnhancedClaudeAPIClient extends EventEmitter {\r\n  private config: EnhancedClaudeAPIConfig;\r\n  private logger: ILogger;\r\n  private configManager: ConfigManager;\r\n  private circuitBreaker: CircuitBreaker;\r\n  private lastHealthCheck?: HealthCheckResult;\r\n  private healthCheckTimer?: NodeJS.Timeout;\r\n\r\n  constructor(logger: ILogger, configManager: ConfigManager, config?: Partial<EnhancedClaudeAPIConfig>) {\r\n    super();\r\n    this.logger = logger;\r\n    this.configManager = configManager;\r\n    this.config = this.loadConfiguration(config);\r\n    \r\n    // Initialize circuit breaker\r\n    this.circuitBreaker = circuitBreaker('claude-api', {\r\n      threshold: this.config.circuitBreakerThreshold || 5,\r\n      timeout: this.config.circuitBreakerTimeout || 60000,\r\n      resetTimeout: this.config.circuitBreakerResetTimeout || 300000,\r\n    });\r\n\r\n    // Start health check if enabled\r\n    if (this.config.enableHealthCheck) {\r\n      this.startHealthCheck();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load configuration with enhanced defaults\r\n   */\r\n  private loadConfiguration(overrides?: Partial<EnhancedClaudeAPIConfig>): EnhancedClaudeAPIConfig {\r\n    const config: EnhancedClaudeAPIConfig = {\r\n      apiKey: '',\r\n      apiUrl: 'https://api.anthropic.com/v1/messages',\r\n      model: 'claude-3-sonnet-20240229',\r\n      temperature: 0.7,\r\n      maxTokens: 4096,\r\n      topP: 1,\r\n      topK: undefined,\r\n      systemPrompt: undefined,\r\n      timeout: 60000,\r\n      retryAttempts: 3,\r\n      retryDelay: 1000,\r\n      // Enhanced configurations\r\n      enableHealthCheck: true,\r\n      healthCheckInterval: 300000, // 5 minutes\r\n      circuitBreakerThreshold: 5,\r\n      circuitBreakerTimeout: 60000,\r\n      circuitBreakerResetTimeout: 300000,\r\n      maxRetries: 3,\r\n      retryBaseDelay: 1000,\r\n      retryMaxDelay: 30000,\r\n      retryJitter: true,\r\n    };\r\n\r\n    // Load from environment\r\n    if (process.env.ANTHROPIC_API_KEY) {\r\n      config.apiKey = process.env.ANTHROPIC_API_KEY;\r\n    }\r\n\r\n    // Load from config manager\r\n    const claudeConfig = this.configManager.get('claude');\r\n    if (claudeConfig) {\r\n      Object.assign(config, claudeConfig);\r\n    }\r\n\r\n    // Apply overrides\r\n    if (overrides) {\r\n      Object.assign(config, overrides);\r\n    }\r\n\r\n    this.validateConfiguration(config);\r\n    return config;\r\n  }\r\n\r\n  /**\r\n   * Validate configuration\r\n   */\r\n  private validateConfiguration(config: EnhancedClaudeAPIConfig): void {\r\n    if (!config.apiKey) {\r\n      throw new ClaudeAuthenticationError('Claude API key is required. Set ANTHROPIC_API_KEY environment variable.');\r\n    }\r\n\r\n    if (config.temperature !== undefined && (config.temperature < 0 || config.temperature > 1)) {\r\n      throw new ClaudeValidationError('Temperature must be between 0 and 1');\r\n    }\r\n\r\n    if (config.maxTokens !== undefined && (config.maxTokens < 1 || config.maxTokens > 100000)) {\r\n      throw new ClaudeValidationError('Max tokens must be between 1 and 100000');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start periodic health checks\r\n   */\r\n  private startHealthCheck(): void {\r\n    this.performHealthCheck(); // Initial check\r\n    \r\n    this.healthCheckTimer = setInterval(\r\n      () => this.performHealthCheck(),\r\n      this.config.healthCheckInterval || 300000,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Perform a health check on the API\r\n   */\r\n  async performHealthCheck(): Promise<HealthCheckResult> {\r\n    const startTime = Date.now();\r\n    \r\n    try {\r\n      // Simple health check request\r\n      const controller = new AbortController();\r\n      const timeout = setTimeout(() => controller.abort(), 10000); // 10 second timeout\r\n\r\n      const response = await fetch(this.config.apiUrl || '', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'anthropic-version': '2023-06-01',\r\n          'x-api-key': this.config.apiKey,\r\n        },\r\n        body: JSON.stringify({\r\n          model: this.config.model,\r\n          messages: [{ role: 'user', content: 'Hi' }],\r\n          max_tokens: 1,\r\n        }),\r\n        signal: controller.signal,\r\n      });\r\n\r\n      clearTimeout(timeout);\r\n      \r\n      const latency = Date.now() - startTime;\r\n      const healthy = response.ok || response.status === 429; // Rate limit is still \"healthy\"\r\n      \r\n      this.lastHealthCheck = {\r\n        healthy,\r\n        latency,\r\n        error: healthy ? undefined : `Status: ${response.status}`,\r\n        timestamp: new Date(),\r\n      };\r\n\r\n      this.logger.debug('Claude API health check completed', this.lastHealthCheck);\r\n      this.emit('health_check', this.lastHealthCheck);\r\n      \r\n      return this.lastHealthCheck;\r\n    } catch (error) {\r\n      const latency = Date.now() - startTime;\r\n      \r\n      this.lastHealthCheck = {\r\n        healthy: false,\r\n        latency,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        timestamp: new Date(),\r\n      };\r\n\r\n      this.logger.warn('Claude API health check failed', this.lastHealthCheck);\r\n      this.emit('health_check', this.lastHealthCheck);\r\n      \r\n      return this.lastHealthCheck;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get last health check result\r\n   */\r\n  getHealthStatus(): HealthCheckResult | undefined {\r\n    return this.lastHealthCheck;\r\n  }\r\n\r\n  /**\r\n   * Send a message with enhanced error handling\r\n   */\r\n  async sendMessage(\r\n    messages: ClaudeMessage[],\r\n    options?: {\r\n      model?: ClaudeModel;\r\n      temperature?: number;\r\n      maxTokens?: number;\r\n      systemPrompt?: string;\r\n      stream?: boolean;\r\n    },\r\n  ): Promise<ClaudeResponse | AsyncIterable<ClaudeStreamEvent>> {\r\n    const request: ClaudeRequest = {\r\n      model: options?.model || this.config.model || 'claude-3-sonnet-20240229',\r\n      messages,\r\n      system: options?.systemPrompt || this.config.systemPrompt,\r\n      max_tokens: options?.maxTokens || this.config.maxTokens || 4096,\r\n      temperature: options?.temperature ?? this.config.temperature,\r\n      top_p: this.config.topP,\r\n      top_k: this.config.topK,\r\n      stream: options?.stream || false,\r\n    };\r\n\r\n    this.logger.debug('Sending Claude API request', {\r\n      model: request.model,\r\n      temperature: request.temperature,\r\n      maxTokens: request.max_tokens,\r\n      messageCount: messages.length,\r\n      stream: request.stream,\r\n    });\r\n\r\n    try {\r\n      // Use circuit breaker for the request\r\n      const result = await this.circuitBreaker.execute(async () => {\r\n        if (request.stream) {\r\n          return this.streamRequestWithRetry(request);\r\n        } else {\r\n          return this.sendRequestWithRetry(request);\r\n        }\r\n      });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      // Handle circuit breaker open state\r\n      if (error instanceof Error && error.message.includes('Circuit breaker')) {\r\n        const apiError = new ClaudeServiceUnavailableError(\r\n          'Claude API is temporarily unavailable due to repeated failures. Please try again later.',\r\n        );\r\n        this.handleError(apiError);\r\n        throw apiError;\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Send request with retry logic and enhanced error handling\r\n   */\r\n  private async sendRequestWithRetry(request: ClaudeRequest): Promise<ClaudeResponse> {\r\n    let lastError: ClaudeAPIError | undefined;\r\n    const maxRetries = this.config.maxRetries || 3;\r\n\r\n    for (let attempt = 0; attempt < maxRetries; attempt++) {\r\n      try {\r\n        return await this.sendRequestOnce(request);\r\n      } catch (error) {\r\n        lastError = this.transformError(error);\r\n        \r\n        // Don't retry non-retryable errors\r\n        if (!lastError.retryable) {\r\n          this.handleError(lastError);\r\n          throw lastError;\r\n        }\r\n\r\n        this.logger.warn(\r\n          `Claude API request failed (attempt ${attempt + 1}/${maxRetries})`,\r\n          {\r\n            error: lastError.message,\r\n            statusCode: lastError.statusCode,\r\n            retryable: lastError.retryable,\r\n          },\r\n        );\r\n\r\n        // Don't retry on the last attempt\r\n        if (attempt < maxRetries - 1) {\r\n          const delay = this.calculateRetryDelay(attempt, lastError);\r\n          this.logger.info(`Retrying after ${delay}ms...`);\r\n          await this.delay(delay);\r\n        }\r\n      }\r\n    }\r\n\r\n    this.handleError(lastError!);\r\n    throw lastError;\r\n  }\r\n\r\n  /**\r\n   * Send a single request\r\n   */\r\n  private async sendRequestOnce(request: ClaudeRequest): Promise<ClaudeResponse> {\r\n    const controller = new AbortController();\r\n    const timeout = setTimeout(() => controller.abort(), this.config.timeout || 60000);\r\n\r\n    try {\r\n      const response = await fetch(this.config.apiUrl || '', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'anthropic-version': '2023-06-01',\r\n          'x-api-key': this.config.apiKey,\r\n        },\r\n        body: JSON.stringify(request),\r\n        signal: controller.signal,\r\n      });\r\n\r\n      clearTimeout(timeout);\r\n\r\n      // Handle different error status codes\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        let errorData: any;\r\n        \r\n        try {\r\n          errorData = JSON.parse(errorText);\r\n        } catch {\r\n          errorData = { message: errorText };\r\n        }\r\n\r\n        throw this.createAPIError(response.status, errorData);\r\n      }\r\n\r\n      const data = (await response.json()) as ClaudeResponse;\r\n\r\n      this.logger.info('Claude API response received', {\r\n        model: data.model,\r\n        inputTokens: data.usage.input_tokens,\r\n        outputTokens: data.usage.output_tokens,\r\n        stopReason: data.stop_reason,\r\n      });\r\n\r\n      this.emit('response', data);\r\n      return data;\r\n    } catch (error) {\r\n      clearTimeout(timeout);\r\n      \r\n      // Handle abort/timeout\r\n      if (error instanceof Error && error.name === 'AbortError') {\r\n        throw new ClaudeTimeoutError(\r\n          'Request timed out',\r\n          this.config.timeout || 60000,\r\n        );\r\n      }\r\n      \r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stream request with retry logic\r\n   */\r\n  private async *streamRequestWithRetry(request: ClaudeRequest): AsyncIterable<ClaudeStreamEvent> {\r\n    let lastError: ClaudeAPIError | undefined;\r\n    const maxRetries = this.config.maxRetries || 3;\r\n\r\n    for (let attempt = 0; attempt < maxRetries; attempt++) {\r\n      try {\r\n        yield* this.streamRequestOnce(request);\r\n        return;\r\n      } catch (error) {\r\n        lastError = this.transformError(error);\r\n        \r\n        if (!lastError.retryable) {\r\n          this.handleError(lastError);\r\n          throw lastError;\r\n        }\r\n\r\n        this.logger.warn(\r\n          `Claude API stream request failed (attempt ${attempt + 1}/${maxRetries})`,\r\n          { error: lastError.message },\r\n        );\r\n\r\n        if (attempt < maxRetries - 1) {\r\n          const delay = this.calculateRetryDelay(attempt, lastError);\r\n          await this.delay(delay);\r\n        }\r\n      }\r\n    }\r\n\r\n    this.handleError(lastError!);\r\n    throw lastError;\r\n  }\r\n\r\n  /**\r\n   * Send a single streaming request\r\n   */\r\n  private async *streamRequestOnce(request: ClaudeRequest): AsyncIterable<ClaudeStreamEvent> {\r\n    const controller = new AbortController();\r\n    const timeout = setTimeout(() => controller.abort(), (this.config.timeout || 60000) * 2);\r\n\r\n    try {\r\n      const response = await fetch(this.config.apiUrl || '', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'anthropic-version': '2023-06-01',\r\n          'x-api-key': this.config.apiKey,\r\n        },\r\n        body: JSON.stringify({ ...request, stream: true }),\r\n        signal: controller.signal,\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        let errorData: any;\r\n        \r\n        try {\r\n          errorData = JSON.parse(errorText);\r\n        } catch {\r\n          errorData = { message: errorText };\r\n        }\r\n\r\n        throw this.createAPIError(response.status, errorData);\r\n      }\r\n\r\n      if (!response.body) {\r\n        throw new ClaudeAPIError('Response body is null');\r\n      }\r\n\r\n      const reader = response.body.getReader();\r\n      const decoder = new TextDecoder();\r\n      let buffer = '';\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6);\r\n            if (data === '[DONE]') continue;\r\n\r\n            try {\r\n              const event = JSON.parse(data) as ClaudeStreamEvent;\r\n              this.emit('stream_event', event);\r\n              yield event;\r\n            } catch (e) {\r\n              this.logger.warn('Failed to parse stream event', { data, error: e });\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } finally {\r\n      clearTimeout(timeout);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create appropriate error based on status code\r\n   */\r\n  private createAPIError(statusCode: number, errorData: any): ClaudeAPIError {\r\n    const message = errorData.error?.message || errorData.message || 'Unknown error';\r\n\r\n    switch (statusCode) {\r\n      case 400:\r\n        return new ClaudeValidationError(message, errorData);\r\n      case 401:\r\n      case 403:\r\n        return new ClaudeAuthenticationError(message, errorData);\r\n      case 429: {\r\n        const retryAfter = errorData.error?.retry_after;\r\n        return new ClaudeRateLimitError(message, retryAfter, errorData);\r\n      }\r\n      case 500:\r\n        return new ClaudeInternalServerError(message, errorData);\r\n      case 503:\r\n        return new ClaudeServiceUnavailableError(message, errorData);\r\n      default:\r\n        return new ClaudeAPIError(message, statusCode, statusCode >= 500, errorData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform generic errors to Claude API errors\r\n   */\r\n  private transformError(error: unknown): ClaudeAPIError {\r\n    if (error instanceof ClaudeAPIError) {\r\n      return error;\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      // Network errors\r\n      if (error.message.includes('fetch failed') || error.message.includes('ECONNREFUSED')) {\r\n        return new ClaudeNetworkError(error.message);\r\n      }\r\n      \r\n      // Timeout errors\r\n      if (error.name === 'AbortError' || error.message.includes('timeout')) {\r\n        return new ClaudeTimeoutError(error.message, this.config.timeout || 60000);\r\n      }\r\n    }\r\n\r\n    return new ClaudeAPIError(\r\n      error instanceof Error ? error.message : String(error),\r\n      undefined,\r\n      true, // Assume unknown errors are retryable\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Calculate retry delay with exponential backoff and jitter\r\n   */\r\n  private calculateRetryDelay(attempt: number, error: ClaudeAPIError): number {\r\n    // If rate limit error with retry-after header, use that\r\n    if (error instanceof ClaudeRateLimitError && error.retryAfter) {\r\n      return error.retryAfter * 1000; // Convert to milliseconds\r\n    }\r\n\r\n    const baseDelay = this.config.retryBaseDelay || 1000;\r\n    const maxDelay = this.config.retryMaxDelay || 30000;\r\n    \r\n    // Exponential backoff: delay = baseDelay * (2 ^ attempt)\r\n    let delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);\r\n    \r\n    // Add jitter to prevent thundering herd\r\n    if (this.config.retryJitter) {\r\n      const jitter = Math.random() * 0.3 * delay; // Up to 30% jitter\r\n      delay = delay + jitter;\r\n    }\r\n\r\n    return Math.floor(delay);\r\n  }\r\n\r\n  /**\r\n   * Handle errors with user-friendly messages and logging\r\n   */\r\n  private handleError(error: ClaudeAPIError): void {\r\n    const errorInfo = getUserFriendlyError(error);\r\n    \r\n    this.logger.error(`${errorInfo.title}: ${errorInfo.message}`, {\r\n      error: error.message,\r\n      code: error.code,\r\n      statusCode: error.statusCode,\r\n      retryable: error.retryable,\r\n      details: error.details,\r\n    });\r\n\r\n    // Log suggestions in debug mode\r\n    if (this.logger.level === 'debug' && errorInfo.suggestions.length > 0) {\r\n      this.logger.debug('Suggestions to resolve the issue:', errorInfo.suggestions);\r\n    }\r\n\r\n    this.emit('error', {\r\n      error,\r\n      userFriendly: errorInfo,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Helper method for simple completions with error handling\r\n   */\r\n  async complete(\r\n    prompt: string,\r\n    options?: {\r\n      model?: ClaudeModel;\r\n      temperature?: number;\r\n      maxTokens?: number;\r\n      systemPrompt?: string;\r\n    },\r\n  ): Promise<string> {\r\n    try {\r\n      const messages: ClaudeMessage[] = [{ role: 'user', content: prompt }];\r\n      const response = (await this.sendMessage(messages, options)) as ClaudeResponse;\r\n      return response.content[0].text;\r\n    } catch (error) {\r\n      if (error instanceof ClaudeAPIError) {\r\n        const errorInfo = getUserFriendlyError(error);\r\n        throw new Error(`${errorInfo.title}: ${errorInfo.message}`);\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delay helper\r\n   */\r\n  private delay(ms: number): Promise<void> {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n\r\n  /**\r\n   * Clean up resources\r\n   */\r\n  destroy(): void {\r\n    if (this.healthCheckTimer) {\r\n      clearInterval(this.healthCheckTimer);\r\n      this.healthCheckTimer = undefined;\r\n    }\r\n    this.removeAllListeners();\r\n  }\r\n}"],"names":["EventEmitter","ClaudeAPIError","ClaudeInternalServerError","ClaudeServiceUnavailableError","ClaudeRateLimitError","ClaudeTimeoutError","ClaudeNetworkError","ClaudeAuthenticationError","ClaudeValidationError","getUserFriendlyError","circuitBreaker","EnhancedClaudeAPIClient","config","logger","configManager","lastHealthCheck","healthCheckTimer","loadConfiguration","threshold","circuitBreakerThreshold","timeout","circuitBreakerTimeout","resetTimeout","circuitBreakerResetTimeout","enableHealthCheck","startHealthCheck","overrides","apiKey","apiUrl","model","temperature","maxTokens","topP","topK","undefined","systemPrompt","retryAttempts","retryDelay","healthCheckInterval","maxRetries","retryBaseDelay","retryMaxDelay","retryJitter","process","env","ANTHROPIC_API_KEY","claudeConfig","get","Object","assign","validateConfiguration","performHealthCheck","setInterval","startTime","Date","now","controller","AbortController","setTimeout","abort","response","fetch","method","headers","body","JSON","stringify","messages","role","content","max_tokens","signal","clearTimeout","latency","healthy","ok","status","error","timestamp","debug","emit","Error","message","warn","getHealthStatus","sendMessage","options","request","system","top_p","top_k","stream","messageCount","length","result","execute","streamRequestWithRetry","sendRequestWithRetry","includes","apiError","handleError","lastError","attempt","sendRequestOnce","transformError","retryable","statusCode","delay","calculateRetryDelay","info","errorText","text","errorData","parse","createAPIError","data","json","inputTokens","usage","input_tokens","outputTokens","output_tokens","stopReason","stop_reason","name","streamRequestOnce","reader","getReader","decoder","TextDecoder","buffer","done","value","read","decode","lines","split","pop","line","startsWith","slice","event","e","retryAfter","retry_after","String","baseDelay","maxDelay","Math","min","pow","jitter","random","floor","errorInfo","title","code","details","level","suggestions","userFriendly","complete","prompt","ms","Promise","resolve","destroy","clearInterval","removeAllListeners"],"mappings":"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"}
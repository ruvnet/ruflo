{"version":3,"sources":["../../../src/api/claude-client-v2.5.ts"],"sourcesContent":["/**\r\n * Claude Client v2.5 - SDK-Based Implementation\r\n * Claude-Flow v2.5-alpha.130\r\n *\r\n * Refactored to use Anthropic SDK instead of custom retry/error handling\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport Anthropic from '@anthropic-ai/sdk';\r\nimport { ClaudeFlowSDKAdapter } from '../sdk/sdk-config.js';\r\nimport { SDKCompatibilityLayer } from '../sdk/compatibility-layer.js';\r\nimport { ILogger } from '../core/logger.js';\r\nimport {\r\n  ClaudeAPIError,\r\n  ClaudeRateLimitError,\r\n  ClaudeAuthenticationError,\r\n  ClaudeValidationError,\r\n} from './claude-api-errors.js';\r\n\r\nexport interface ClaudeAPIConfig {\r\n  apiKey: string;\r\n  apiUrl?: string;\r\n  model?: ClaudeModel;\r\n  temperature?: number;\r\n  maxTokens?: number;\r\n  topP?: number;\r\n  topK?: number;\r\n  systemPrompt?: string;\r\n  timeout?: number;\r\n  retryAttempts?: number;\r\n  retryDelay?: number;\r\n  enableSwarmMode?: boolean;\r\n}\r\n\r\nexport type ClaudeModel =\r\n  | 'claude-3-opus-20240229'\r\n  | 'claude-3-sonnet-20240229'\r\n  | 'claude-3-haiku-20240307'\r\n  | 'claude-2.1'\r\n  | 'claude-2.0'\r\n  | 'claude-instant-1.2';\r\n\r\nexport interface ClaudeMessage {\r\n  role: 'user' | 'assistant';\r\n  content: string;\r\n}\r\n\r\nexport interface ClaudeRequest {\r\n  model: ClaudeModel;\r\n  messages: ClaudeMessage[];\r\n  system?: string;\r\n  max_tokens: number;\r\n  temperature?: number;\r\n  top_p?: number;\r\n  top_k?: number;\r\n  metadata?: {\r\n    user_id?: string;\r\n  };\r\n  stop_sequences?: string[];\r\n  stream?: boolean;\r\n}\r\n\r\nexport interface ClaudeResponse {\r\n  id: string;\r\n  type: 'message';\r\n  role: 'assistant';\r\n  content: Array<{\r\n    type: 'text';\r\n    text: string;\r\n  }>;\r\n  model: ClaudeModel;\r\n  stop_reason: 'end_turn' | 'max_tokens' | 'stop_sequence';\r\n  stop_sequence?: string;\r\n  usage: {\r\n    input_tokens: number;\r\n    output_tokens: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Claude Client v2.5 using Anthropic SDK\r\n */\r\nexport class ClaudeClientV25 extends EventEmitter {\r\n  private adapter: ClaudeFlowSDKAdapter;\r\n  private compatibility: SDKCompatibilityLayer;\r\n  private sdk: Anthropic;\r\n  private config: ClaudeAPIConfig;\r\n  private logger?: ILogger;\r\n\r\n  constructor(config: ClaudeAPIConfig, logger?: ILogger) {\r\n    super();\r\n    this.config = config;\r\n    this.logger = logger;\r\n\r\n    // Initialize SDK adapter\r\n    this.adapter = new ClaudeFlowSDKAdapter({\r\n      apiKey: config.apiKey,\r\n      maxRetries: config.retryAttempts || 3,\r\n      timeout: config.timeout || 60000,\r\n      swarmMode: config.enableSwarmMode,\r\n      baseURL: config.apiUrl\r\n    });\r\n\r\n    this.sdk = this.adapter.getSDK();\r\n    this.compatibility = new SDKCompatibilityLayer(this.adapter);\r\n\r\n    this.logger?.info('Claude Client v2.5 initialized with SDK', {\r\n      model: config.model,\r\n      swarmMode: config.enableSwarmMode\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Main request method using SDK\r\n   */\r\n  async makeRequest(request: ClaudeRequest): Promise<ClaudeResponse> {\r\n    try {\r\n      this.emit('request:start', request);\r\n\r\n      // Convert to SDK format\r\n      const sdkParams: Anthropic.MessageCreateParams = {\r\n        model: request.model as Anthropic.Model,\r\n        messages: request.messages.map(msg => ({\r\n          role: msg.role as 'user' | 'assistant',\r\n          content: msg.content\r\n        })),\r\n        max_tokens: request.max_tokens,\r\n        temperature: request.temperature,\r\n        top_p: request.top_p,\r\n        top_k: request.top_k,\r\n        system: request.system,\r\n        stop_sequences: request.stop_sequences,\r\n        metadata: request.metadata as Anthropic.Metadata | undefined\r\n      };\r\n\r\n      // SDK handles retry automatically\r\n      const response = await this.adapter.createMessage(sdkParams);\r\n\r\n      // Convert SDK response to legacy format for compatibility\r\n      const legacyResponse = this.convertSDKResponse(response);\r\n\r\n      this.emit('request:success', legacyResponse);\r\n      this.logger?.info('Request successful', {\r\n        model: request.model,\r\n        tokensUsed: response.usage\r\n      });\r\n\r\n      return legacyResponse;\r\n\r\n    } catch (error) {\r\n      this.handleSDKError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Streaming request using SDK\r\n   */\r\n  async makeStreamingRequest(\r\n    request: ClaudeRequest,\r\n    onChunk?: (chunk: Anthropic.MessageStreamEvent) => void\r\n  ): Promise<ClaudeResponse> {\r\n    try {\r\n      this.emit('stream:start', request);\r\n\r\n      const sdkParams: Anthropic.MessageCreateParams = {\r\n        model: request.model as Anthropic.Model,\r\n        messages: request.messages.map(msg => ({\r\n          role: msg.role as 'user' | 'assistant',\r\n          content: msg.content\r\n        })),\r\n        max_tokens: request.max_tokens,\r\n        temperature: request.temperature,\r\n        system: request.system,\r\n        stream: true\r\n      };\r\n\r\n      const response = await this.adapter.createStreamingMessage(\r\n        sdkParams,\r\n        {\r\n          onChunk: (chunk) => {\r\n            this.emit('stream:chunk', chunk);\r\n            onChunk?.(chunk);\r\n          }\r\n        }\r\n      );\r\n\r\n      const legacyResponse = this.convertSDKResponse(response);\r\n      this.emit('stream:complete', legacyResponse);\r\n\r\n      return legacyResponse;\r\n\r\n    } catch (error) {\r\n      this.handleSDKError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * DEPRECATED: Legacy method for backward compatibility\r\n   * SDK handles retry automatically\r\n   */\r\n  async executeWithRetry(request: ClaudeRequest): Promise<ClaudeResponse> {\r\n    console.warn('[ClaudeClientV25] executeWithRetry is deprecated. SDK handles retry automatically.');\r\n    return this.makeRequest(request);\r\n  }\r\n\r\n  /**\r\n   * Convert SDK response to legacy format\r\n   */\r\n  private convertSDKResponse(sdkResponse: Anthropic.Message): ClaudeResponse {\r\n    return {\r\n      id: sdkResponse.id,\r\n      type: 'message',\r\n      role: 'assistant',\r\n      content: sdkResponse.content.map((block) => ({\r\n        type: block.type,\r\n        text: block.type === 'text' ? block.text : ''\r\n      })),\r\n      model: sdkResponse.model as ClaudeModel,\r\n      stop_reason: (sdkResponse.stop_reason || 'end_turn') as 'end_turn' | 'max_tokens' | 'stop_sequence',\r\n      stop_sequence: sdkResponse.stop_sequence || undefined,\r\n      usage: {\r\n        input_tokens: sdkResponse.usage.input_tokens,\r\n        output_tokens: sdkResponse.usage.output_tokens\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle SDK-specific errors\r\n   */\r\n  private handleSDKError(error: unknown): void {\r\n    this.emit('request:error', error);\r\n\r\n    let mappedError: ClaudeAPIError;\r\n\r\n    if (error instanceof Anthropic.APIError) {\r\n      if (error instanceof Anthropic.AuthenticationError) {\r\n        mappedError = new ClaudeAuthenticationError('Invalid API key');\r\n      } else if (error instanceof Anthropic.RateLimitError) {\r\n        mappedError = new ClaudeRateLimitError('Rate limit exceeded');\r\n      } else if (error instanceof Anthropic.BadRequestError) {\r\n        mappedError = new ClaudeValidationError(error.message);\r\n      } else {\r\n        mappedError = new ClaudeAPIError(error.message, error.status || 500);\r\n      }\r\n    } else {\r\n      mappedError = new ClaudeAPIError(\r\n        error.message || 'Unknown error',\r\n        500\r\n      );\r\n    }\r\n\r\n    this.logger?.error('SDK request failed', {\r\n      error: mappedError.message,\r\n      status: mappedError.status\r\n    });\r\n\r\n    throw mappedError;\r\n  }\r\n\r\n  /**\r\n   * Validate configuration\r\n   */\r\n  async validateConfiguration(): Promise<boolean> {\r\n    return this.adapter.validateConfiguration();\r\n  }\r\n\r\n  /**\r\n   * Get usage statistics\r\n   */\r\n  getUsageStats(): { totalTokens: number; messageCount: number } {\r\n    return this.adapter.getUsageStats();\r\n  }\r\n\r\n  /**\r\n   * Get swarm metadata (if in swarm mode)\r\n   */\r\n  getSwarmMetadata(messageId: string): Record<string, unknown> | null {\r\n    if (this.config.enableSwarmMode) {\r\n      return this.adapter.getSwarmMetadata(messageId);\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Check health status\r\n   */\r\n  async checkHealth(): Promise<{\r\n    status: 'healthy' | 'degraded' | 'unhealthy';\r\n    details: Record<string, unknown>;\r\n  }> {\r\n    try {\r\n      const isValid = await this.validateConfiguration();\r\n\r\n      if (isValid) {\r\n        return {\r\n          status: 'healthy',\r\n          details: {\r\n            sdkVersion: '2.5.0',\r\n            model: this.config.model,\r\n            swarmMode: this.config.enableSwarmMode\r\n          }\r\n        };\r\n      }\r\n\r\n      return {\r\n        status: 'unhealthy',\r\n        details: { error: 'Invalid configuration' }\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        status: 'unhealthy',\r\n        details: { error: error instanceof Error ? error.message : 'Unknown error' }\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get deprecation warnings\r\n   */\r\n  getDeprecationWarnings(): string[] {\r\n    return this.compatibility.getDeprecationReport();\r\n  }\r\n}\r\n\r\n// Export for backward compatibility\r\nexport { ClaudeClientV25 as ClaudeClient };"],"names":["EventEmitter","Anthropic","ClaudeFlowSDKAdapter","SDKCompatibilityLayer","ClaudeAPIError","ClaudeRateLimitError","ClaudeAuthenticationError","ClaudeValidationError","ClaudeClientV25","adapter","compatibility","sdk","config","logger","apiKey","maxRetries","retryAttempts","timeout","swarmMode","enableSwarmMode","baseURL","apiUrl","getSDK","info","model","makeRequest","request","emit","sdkParams","messages","map","msg","role","content","max_tokens","temperature","top_p","top_k","system","stop_sequences","metadata","response","createMessage","legacyResponse","convertSDKResponse","tokensUsed","usage","error","handleSDKError","makeStreamingRequest","onChunk","stream","createStreamingMessage","chunk","executeWithRetry","console","warn","sdkResponse","id","type","block","text","stop_reason","stop_sequence","undefined","input_tokens","output_tokens","mappedError","APIError","AuthenticationError","RateLimitError","BadRequestError","message","status","validateConfiguration","getUsageStats","getSwarmMetadata","messageId","checkHealth","isValid","details","sdkVersion","Error","getDeprecationWarnings","getDeprecationReport","ClaudeClient"],"mappings":"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"}
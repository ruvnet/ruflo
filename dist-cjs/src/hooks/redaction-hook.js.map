{"version":3,"sources":["../../../src/hooks/redaction-hook.ts"],"sourcesContent":["/**\r\n * Git Pre-commit Hook for API Key Redaction\r\n * Prevents sensitive data from being committed\r\n */\r\n\r\nimport { KeyRedactor } from '../utils/key-redactor.js';\r\nimport { readFileSync } from 'fs';\r\nimport { execSync } from 'child_process';\r\n\r\nexport async function validateNoSensitiveData(): Promise<{ safe: boolean; issues: string[] }> {\r\n  const issues: string[] = [];\r\n\r\n  try {\r\n    // Get staged files\r\n    const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf-8' })\r\n      .split('\\n')\r\n      .filter(f => f.trim() && !f.includes('.env') && !f.includes('node_modules') && !f.endsWith('.map'));\r\n\r\n    // Common documentation placeholder patterns (these are safe)\r\n    const placeholderPatterns = [\r\n      /API_KEY=\\(paste/i,\r\n      /API_KEY=\\(your/i,\r\n      /API_KEY=\\.\\.\\./i,\r\n      /API_KEY=\"\\.\\.\\.\"/i,\r\n      /API_KEY=\"\\(paste/i,\r\n      /API_KEY=\"\\(your/i,\r\n      /API_KEY=sk-ant-\\.\\.\\./i,       // Truncated example keys\r\n      /API_KEY=sk-or-v1-\\.\\.\\./i,     // Truncated example keys\r\n      /API_KEY=\"sk-ant-\\.\\.\\.\"/i,     // Quoted truncated keys\r\n      /API_KEY=\"sk-or-v1-\\.\\.\\.\"/i,   // Quoted truncated keys\r\n      /API_KEY=sk-ant-xxxxx/i,        // xxxxx format examples\r\n      /API_KEY=sk-or-v1-xxxxx/i,      // xxxxx format examples\r\n      /TOKEN=\\(paste/i,\r\n      /TOKEN=\\(your/i,\r\n      /SECRET=\\(paste/i,\r\n      /SECRET=\\(your/i,\r\n    ];\r\n\r\n    // Check each staged file\r\n    for (const file of stagedFiles) {\r\n      try {\r\n        // Skip documentation files with obvious placeholders\r\n        if (file.startsWith('docs/') || file.includes('/docs/')) {\r\n          const content = readFileSync(file, 'utf-8');\r\n          // Check if file only contains placeholder patterns\r\n          const hasOnlyPlaceholders = placeholderPatterns.some(pattern => pattern.test(content));\r\n          if (hasOnlyPlaceholders) {\r\n            continue; // Skip - these are documentation examples\r\n          }\r\n        }\r\n\r\n        const content = readFileSync(file, 'utf-8');\r\n\r\n        // Check for placeholder patterns in the content\r\n        const hasPlaceholders = placeholderPatterns.some(pattern => pattern.test(content));\r\n        if (hasPlaceholders && (file.includes('example') || file.includes('template') || file.includes('/docs/'))) {\r\n          continue; // Skip - these are examples/templates with placeholders\r\n        }\r\n\r\n        const validation = KeyRedactor.validate(content);\r\n\r\n        if (!validation.safe) {\r\n          // Double-check: if warnings are only about placeholder patterns, skip\r\n          const warningsText = validation.warnings.join(' ');\r\n          if (hasPlaceholders && !warningsText.includes('sk-ant-a') && !warningsText.includes('sk-or-v')) {\r\n            continue; // Likely a false positive from documentation\r\n          }\r\n          issues.push(`‚ö†Ô∏è  ${file}: ${validation.warnings.join(', ')}`);\r\n        }\r\n      } catch (error) {\r\n        // File might be deleted or binary\r\n        continue;\r\n      }\r\n    }\r\n\r\n    return {\r\n      safe: issues.length === 0,\r\n      issues,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error validating sensitive data:', error);\r\n    return {\r\n      safe: false,\r\n      issues: ['Failed to validate files'],\r\n    };\r\n  }\r\n}\r\n\r\nexport async function runRedactionCheck(): Promise<number> {\r\n  console.log('üîí Running API key redaction check...\\n');\r\n\r\n  const result = await validateNoSensitiveData();\r\n\r\n  if (!result.safe) {\r\n    console.error('‚ùå COMMIT BLOCKED - Sensitive data detected:\\n');\r\n    result.issues.forEach(issue => console.error(issue));\r\n    console.error('\\n‚ö†Ô∏è  Please remove sensitive data before committing.');\r\n    console.error('üí° Tip: Use environment variables instead of hardcoding keys.\\n');\r\n    return 1;\r\n  }\r\n\r\n  console.log('‚úÖ No sensitive data detected - safe to commit\\n');\r\n  return 0;\r\n}\r\n\r\n// CLI execution (ES module compatible)\r\nconst isMainModule = import.meta.url === `file://${process.argv[1]}`;\r\nif (isMainModule) {\r\n  runRedactionCheck()\r\n    .then(code => process.exit(code))\r\n    .catch(error => {\r\n      console.error('Error:', error);\r\n      process.exit(1);\r\n    });\r\n}\r\n"],"names":["KeyRedactor","readFileSync","execSync","validateNoSensitiveData","issues","stagedFiles","encoding","split","filter","f","trim","includes","endsWith","placeholderPatterns","file","startsWith","content","hasOnlyPlaceholders","some","pattern","test","hasPlaceholders","validation","validate","safe","warningsText","warnings","join","push","error","length","console","runRedactionCheck","log","result","forEach","issue","isMainModule","url","process","argv","then","code","exit","catch"],"mappings":"AAKA,SAASA,WAAW,QAAQ,2BAA2B;AACvD,SAASC,YAAY,QAAQ,KAAK;AAClC,SAASC,QAAQ,QAAQ,gBAAgB;AAEzC,OAAO,eAAeC;IACpB,MAAMC,SAAmB,EAAE;IAE3B,IAAI;QAEF,MAAMC,cAAcH,SAAS,iCAAiC;YAAEI,UAAU;QAAQ,GAC/EC,KAAK,CAAC,MACNC,MAAM,CAACC,CAAAA,IAAKA,EAAEC,IAAI,MAAM,CAACD,EAAEE,QAAQ,CAAC,WAAW,CAACF,EAAEE,QAAQ,CAAC,mBAAmB,CAACF,EAAEG,QAAQ,CAAC;QAG7F,MAAMC,sBAAsB;YAC1B;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAGD,KAAK,MAAMC,QAAQT,YAAa;YAC9B,IAAI;gBAEF,IAAIS,KAAKC,UAAU,CAAC,YAAYD,KAAKH,QAAQ,CAAC,WAAW;oBACvD,MAAMK,UAAUf,aAAaa,MAAM;oBAEnC,MAAMG,sBAAsBJ,oBAAoBK,IAAI,CAACC,CAAAA,UAAWA,QAAQC,IAAI,CAACJ;oBAC7E,IAAIC,qBAAqB;wBACvB;oBACF;gBACF;gBAEA,MAAMD,UAAUf,aAAaa,MAAM;gBAGnC,MAAMO,kBAAkBR,oBAAoBK,IAAI,CAACC,CAAAA,UAAWA,QAAQC,IAAI,CAACJ;gBACzE,IAAIK,mBAAoBP,CAAAA,KAAKH,QAAQ,CAAC,cAAcG,KAAKH,QAAQ,CAAC,eAAeG,KAAKH,QAAQ,CAAC,SAAQ,GAAI;oBACzG;gBACF;gBAEA,MAAMW,aAAatB,YAAYuB,QAAQ,CAACP;gBAExC,IAAI,CAACM,WAAWE,IAAI,EAAE;oBAEpB,MAAMC,eAAeH,WAAWI,QAAQ,CAACC,IAAI,CAAC;oBAC9C,IAAIN,mBAAmB,CAACI,aAAad,QAAQ,CAAC,eAAe,CAACc,aAAad,QAAQ,CAAC,YAAY;wBAC9F;oBACF;oBACAP,OAAOwB,IAAI,CAAC,CAAC,IAAI,EAAEd,KAAK,EAAE,EAAEQ,WAAWI,QAAQ,CAACC,IAAI,CAAC,OAAO;gBAC9D;YACF,EAAE,OAAOE,OAAO;gBAEd;YACF;QACF;QAEA,OAAO;YACLL,MAAMpB,OAAO0B,MAAM,KAAK;YACxB1B;QACF;IACF,EAAE,OAAOyB,OAAO;QACdE,QAAQF,KAAK,CAAC,oCAAoCA;QAClD,OAAO;YACLL,MAAM;YACNpB,QAAQ;gBAAC;aAA2B;QACtC;IACF;AACF;AAEA,OAAO,eAAe4B;IACpBD,QAAQE,GAAG,CAAC;IAEZ,MAAMC,SAAS,MAAM/B;IAErB,IAAI,CAAC+B,OAAOV,IAAI,EAAE;QAChBO,QAAQF,KAAK,CAAC;QACdK,OAAO9B,MAAM,CAAC+B,OAAO,CAACC,CAAAA,QAASL,QAAQF,KAAK,CAACO;QAC7CL,QAAQF,KAAK,CAAC;QACdE,QAAQF,KAAK,CAAC;QACd,OAAO;IACT;IAEAE,QAAQE,GAAG,CAAC;IACZ,OAAO;AACT;AAGA,MAAMI,eAAe,YAAYC,GAAG,KAAK,CAAC,OAAO,EAAEC,QAAQC,IAAI,CAAC,EAAE,EAAE;AACpE,IAAIH,cAAc;IAChBL,oBACGS,IAAI,CAACC,CAAAA,OAAQH,QAAQI,IAAI,CAACD,OAC1BE,KAAK,CAACf,CAAAA;QACLE,QAAQF,KAAK,CAAC,UAAUA;QACxBU,QAAQI,IAAI,CAAC;IACf;AACJ"}
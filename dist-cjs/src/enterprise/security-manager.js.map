{"version":3,"sources":["../../../src/enterprise/security-manager.ts"],"sourcesContent":["import { EventEmitter } from 'events';\r\nimport { writeFile, readFile, mkdir, readdir } from 'fs/promises';\r\nimport { join } from 'path';\r\nimport { spawn } from 'child_process';\r\nimport { Logger } from '../core/logger.js';\r\nimport { ConfigManager } from '../core/config.js';\r\n\r\nexport interface SecurityScan {\r\n  id: string;\r\n  name: string;\r\n  type:\r\n    | 'vulnerability'\r\n    | 'dependency'\r\n    | 'code-quality'\r\n    | 'secrets'\r\n    | 'compliance'\r\n    | 'infrastructure'\r\n    | 'container';\r\n  status: 'pending' | 'running' | 'completed' | 'failed' | 'cancelled';\r\n  projectId?: string;\r\n  target: {\r\n    type: 'repository' | 'container' | 'infrastructure' | 'application' | 'dependencies';\r\n    path: string;\r\n    branch?: string;\r\n    commit?: string;\r\n    image?: string;\r\n    tag?: string;\r\n  };\r\n  configuration: {\r\n    scanner: string;\r\n    rules: string[];\r\n    excludes: string[];\r\n    severity: SecuritySeverity[];\r\n    formats: string[];\r\n    outputPath: string;\r\n  };\r\n  results: SecurityFinding[];\r\n  metrics: {\r\n    totalFindings: number;\r\n    criticalFindings: number;\r\n    highFindings: number;\r\n    mediumFindings: number;\r\n    lowFindings: number;\r\n    falsePositives: number;\r\n    suppressed: number;\r\n    scanDuration: number;\r\n    filesScanned: number;\r\n    linesScanned: number;\r\n  };\r\n  compliance: {\r\n    frameworks: string[];\r\n    requirements: ComplianceCheck[];\r\n    overallScore: number;\r\n    passedChecks: number;\r\n    failedChecks: number;\r\n  };\r\n  remediation: {\r\n    autoFixAvailable: SecurityFinding[];\r\n    manualReview: SecurityFinding[];\r\n    recommendations: SecurityRecommendation[];\r\n  };\r\n  schedule?: {\r\n    frequency: 'manual' | 'daily' | 'weekly' | 'monthly' | 'on-commit' | 'on-deploy';\r\n    nextRun?: Date;\r\n    lastRun?: Date;\r\n  };\r\n  notifications: {\r\n    channels: string[];\r\n    thresholds: {\r\n      critical: number;\r\n      high: number;\r\n      medium: number;\r\n    };\r\n  };\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  createdBy: string;\r\n  auditLog: SecurityAuditEntry[];\r\n}\r\n\r\nexport type SecuritySeverity = 'critical' | 'high' | 'medium' | 'low' | 'info';\r\n\r\nexport interface SecurityFinding {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  severity: SecuritySeverity;\r\n  category:\r\n    | 'vulnerability'\r\n    | 'secret'\r\n    | 'misconfiguration'\r\n    | 'compliance'\r\n    | 'code-quality'\r\n    | 'license';\r\n  cwe?: string; // Common Weakness Enumeration\r\n  cve?: string; // Common Vulnerabilities and Exposures\r\n  cvss?: {\r\n    score: number;\r\n    vector: string;\r\n    version: string;\r\n  };\r\n  location: {\r\n    file: string;\r\n    line?: number;\r\n    column?: number;\r\n    function?: string;\r\n    component?: string;\r\n  };\r\n  evidence: {\r\n    snippet?: string;\r\n    context?: string;\r\n    references?: string[];\r\n  };\r\n  impact: string;\r\n  remediation: {\r\n    description: string;\r\n    effort: 'low' | 'medium' | 'high';\r\n    priority: 'low' | 'medium' | 'high' | 'critical';\r\n    autoFixable: boolean;\r\n    steps: string[];\r\n    references: string[];\r\n  };\r\n  status: 'open' | 'triaged' | 'in-progress' | 'resolved' | 'suppressed' | 'false-positive';\r\n  assignedTo?: string;\r\n  dueDate?: Date;\r\n  tags: string[];\r\n  metadata: Record<string, any>;\r\n  firstSeen: Date;\r\n  lastSeen: Date;\r\n  occurrences: number;\r\n}\r\n\r\nexport interface ComplianceCheck {\r\n  id: string;\r\n  framework: string; // e.g., 'SOC2', 'GDPR', 'HIPAA', 'PCI-DSS', 'CIS', 'NIST'\r\n  control: string;\r\n  description: string;\r\n  status: 'passed' | 'failed' | 'not-applicable' | 'manual-review';\r\n  severity: SecuritySeverity;\r\n  evidence?: string;\r\n  remediation?: string;\r\n  lastChecked: Date;\r\n}\r\n\r\nexport interface SecurityRecommendation {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  category:\r\n    | 'security-hardening'\r\n    | 'vulnerability-management'\r\n    | 'access-control'\r\n    | 'monitoring'\r\n    | 'compliance';\r\n  priority: 'low' | 'medium' | 'high' | 'critical';\r\n  effort: 'low' | 'medium' | 'high';\r\n  impact: string;\r\n  implementation: {\r\n    steps: string[];\r\n    tools: string[];\r\n    timeEstimate: string;\r\n    cost: string;\r\n  };\r\n  references: string[];\r\n  applicableFrameworks: string[];\r\n}\r\n\r\nexport interface SecurityPolicy {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  type: 'scanning' | 'access-control' | 'compliance' | 'incident-response' | 'data-protection';\r\n  version: string;\r\n  status: 'draft' | 'active' | 'deprecated';\r\n  rules: SecurityRule[];\r\n  enforcement: {\r\n    level: 'advisory' | 'warning' | 'blocking';\r\n    exceptions: string[];\r\n    approvers: string[];\r\n  };\r\n  applicability: {\r\n    projects: string[];\r\n    environments: string[];\r\n    resources: string[];\r\n  };\r\n  schedule: {\r\n    reviewFrequency: 'quarterly' | 'annually' | 'as-needed';\r\n    nextReview: Date;\r\n    lastReview?: Date;\r\n    reviewer: string;\r\n  };\r\n  metrics: {\r\n    violations: number;\r\n    compliance: number;\r\n    exceptions: number;\r\n  };\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  createdBy: string;\r\n}\r\n\r\nexport interface SecurityRule {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  condition: string; // Query or condition syntax\r\n  action: 'allow' | 'deny' | 'alert' | 'audit';\r\n  severity: SecuritySeverity;\r\n  parameters: Record<string, any>;\r\n  enabled: boolean;\r\n}\r\n\r\nexport interface SecurityIncident {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  severity: SecuritySeverity;\r\n  status: 'open' | 'investigating' | 'contained' | 'resolved' | 'closed';\r\n  type:\r\n    | 'security-breach'\r\n    | 'vulnerability-exploit'\r\n    | 'policy-violation'\r\n    | 'suspicious-activity'\r\n    | 'compliance-violation';\r\n  source: {\r\n    type: 'scan' | 'alert' | 'user-report' | 'automated-detection';\r\n    details: Record<string, any>;\r\n  };\r\n  affected: {\r\n    systems: string[];\r\n    data: string[];\r\n    users: string[];\r\n  };\r\n  timeline: {\r\n    detected: Date;\r\n    reported: Date;\r\n    acknowledged: Date;\r\n    contained?: Date;\r\n    resolved?: Date;\r\n    closed?: Date;\r\n  };\r\n  response: {\r\n    assignedTo: string[];\r\n    actions: SecurityAction[];\r\n    communications: SecurityCommunication[];\r\n    lessons: string[];\r\n  };\r\n  evidence: {\r\n    logs: string[];\r\n    files: string[];\r\n    screenshots: string[];\r\n    forensics: string[];\r\n  };\r\n  impact: {\r\n    confidentiality: 'none' | 'low' | 'medium' | 'high';\r\n    integrity: 'none' | 'low' | 'medium' | 'high';\r\n    availability: 'none' | 'low' | 'medium' | 'high';\r\n    financialLoss?: number;\r\n    reputationalDamage?: string;\r\n    regulatoryImplications?: string[];\r\n  };\r\n  rootCause: {\r\n    primary: string;\r\n    contributing: string[];\r\n    analysis: string;\r\n  };\r\n  remediation: {\r\n    immediate: string[];\r\n    shortTerm: string[];\r\n    longTerm: string[];\r\n    preventive: string[];\r\n  };\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  createdBy: string;\r\n  auditLog: SecurityAuditEntry[];\r\n}\r\n\r\nexport interface SecurityAction {\r\n  id: string;\r\n  type:\r\n    | 'investigation'\r\n    | 'containment'\r\n    | 'eradication'\r\n    | 'recovery'\r\n    | 'notification'\r\n    | 'documentation';\r\n  description: string;\r\n  assignedTo: string;\r\n  status: 'pending' | 'in-progress' | 'completed' | 'cancelled';\r\n  dueDate?: Date;\r\n  completedAt?: Date;\r\n  notes: string;\r\n}\r\n\r\nexport interface SecurityCommunication {\r\n  id: string;\r\n  type: 'internal' | 'external' | 'regulatory' | 'customer' | 'media';\r\n  audience: string[];\r\n  subject: string;\r\n  message: string;\r\n  sentAt: Date;\r\n  sentBy: string;\r\n  channel: 'email' | 'phone' | 'meeting' | 'document' | 'portal';\r\n}\r\n\r\nexport interface SecurityAuditEntry {\r\n  id: string;\r\n  timestamp: Date;\r\n  userId: string;\r\n  action: string;\r\n  target: string;\r\n  details: Record<string, any>;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n}\r\n\r\nexport interface VulnerabilityDatabase {\r\n  id: string;\r\n  name: string;\r\n  type: 'nvd' | 'github' | 'snyk' | 'custom';\r\n  url: string;\r\n  updateFrequency: 'hourly' | 'daily' | 'weekly';\r\n  lastUpdate: Date;\r\n  status: 'active' | 'inactive' | 'error';\r\n  configuration: Record<string, any>;\r\n}\r\n\r\nexport interface SecurityMetrics {\r\n  scans: {\r\n    total: number;\r\n    completed: number;\r\n    failed: number;\r\n    inProgress: number;\r\n    byType: Record<string, number>;\r\n    averageDuration: number;\r\n  };\r\n  findings: {\r\n    total: number;\r\n    open: number;\r\n    resolved: number;\r\n    suppressed: number;\r\n    bySeverity: Record<SecuritySeverity, number>;\r\n    byCategory: Record<string, number>;\r\n    meanTimeToResolution: number;\r\n  };\r\n  compliance: {\r\n    frameworks: Record<\r\n      string,\r\n      {\r\n        total: number;\r\n        passed: number;\r\n        failed: number;\r\n        score: number;\r\n      }\r\n    >;\r\n    overallScore: number;\r\n    trending: 'improving' | 'stable' | 'declining';\r\n  };\r\n  incidents: {\r\n    total: number;\r\n    open: number;\r\n    resolved: number;\r\n    bySeverity: Record<SecuritySeverity, number>;\r\n    meanTimeToDetection: number;\r\n    meanTimeToResponse: number;\r\n    meanTimeToResolution: number;\r\n  };\r\n  policies: {\r\n    total: number;\r\n    active: number;\r\n    violations: number;\r\n    compliance: number;\r\n  };\r\n  trends: {\r\n    findingsTrend: Array<{ date: Date; count: number }>;\r\n    complianceTrend: Array<{ date: Date; score: number }>;\r\n    incidentsTrend: Array<{ date: Date; count: number }>;\r\n  };\r\n}\r\n\r\nexport class SecurityManager extends EventEmitter {\r\n  private scans: Map<string, SecurityScan> = new Map();\r\n  private policies: Map<string, SecurityPolicy> = new Map();\r\n  private incidents: Map<string, SecurityIncident> = new Map();\r\n  private vulnerabilityDatabases: Map<string, VulnerabilityDatabase> = new Map();\r\n  private securityPath: string;\r\n  private logger: Logger;\r\n  private config: ConfigManager;\r\n\r\n  constructor(securityPath: string = './security', logger?: Logger, config?: ConfigManager) {\r\n    super();\r\n    this.securityPath = securityPath;\r\n    this.logger = logger || new Logger({ level: 'info', format: 'text', destination: 'console' });\r\n    this.config = config || ConfigManager.getInstance();\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    try {\r\n      await mkdir(this.securityPath, { recursive: true });\r\n      await mkdir(join(this.securityPath, 'scans'), { recursive: true });\r\n      await mkdir(join(this.securityPath, 'policies'), { recursive: true });\r\n      await mkdir(join(this.securityPath, 'incidents'), { recursive: true });\r\n      await mkdir(join(this.securityPath, 'reports'), { recursive: true });\r\n      await mkdir(join(this.securityPath, 'databases'), { recursive: true });\r\n\r\n      await this.loadConfigurations();\r\n      await this.initializeDefaultPolicies();\r\n      await this.initializeVulnerabilityDatabases();\r\n\r\n      this.logger.info('Security Manager initialized successfully');\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize Security Manager', { error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createSecurityScan(scanData: {\r\n    name: string;\r\n    type: SecurityScan['type'];\r\n    target: SecurityScan['target'];\r\n    configuration?: Partial<SecurityScan['configuration']>;\r\n    projectId?: string;\r\n    schedule?: SecurityScan['schedule'];\r\n  }): Promise<SecurityScan> {\r\n    const scan: SecurityScan = {\r\n      id: `scan-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: scanData.name,\r\n      type: scanData.type,\r\n      status: 'pending',\r\n      projectId: scanData.projectId,\r\n      target: scanData.target,\r\n      configuration: {\r\n        scanner: this.getDefaultScanner(scanData.type),\r\n        rules: [],\r\n        excludes: [],\r\n        severity: ['critical', 'high', 'medium', 'low'],\r\n        formats: ['json', 'html'],\r\n        outputPath: join(this.securityPath, 'reports'),\r\n        ...scanData.configuration,\r\n      },\r\n      results: [],\r\n      metrics: {\r\n        totalFindings: 0,\r\n        criticalFindings: 0,\r\n        highFindings: 0,\r\n        mediumFindings: 0,\r\n        lowFindings: 0,\r\n        falsePositives: 0,\r\n        suppressed: 0,\r\n        scanDuration: 0,\r\n        filesScanned: 0,\r\n        linesScanned: 0,\r\n      },\r\n      compliance: {\r\n        frameworks: [],\r\n        requirements: [],\r\n        overallScore: 0,\r\n        passedChecks: 0,\r\n        failedChecks: 0,\r\n      },\r\n      remediation: {\r\n        autoFixAvailable: [],\r\n        manualReview: [],\r\n        recommendations: [],\r\n      },\r\n      schedule: scanData.schedule,\r\n      notifications: {\r\n        channels: [],\r\n        thresholds: {\r\n          critical: 1,\r\n          high: 5,\r\n          medium: 10,\r\n        },\r\n      },\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      createdBy: 'system',\r\n      auditLog: [],\r\n    };\r\n\r\n    this.addAuditEntry(scan, 'system', 'scan_created', 'scan', {\r\n      scanId: scan.id,\r\n      scanName: scan.name,\r\n      scanType: scan.type,\r\n    });\r\n\r\n    this.scans.set(scan.id, scan);\r\n    await this.saveScan(scan);\r\n\r\n    this.emit('scan:created', scan);\r\n    this.logger.info(`Security scan created: ${scan.name} (${scan.id})`);\r\n\r\n    return scan;\r\n  }\r\n\r\n  async executeScan(scanId: string): Promise<void> {\r\n    const scan = this.scans.get(scanId);\r\n    if (!scan) {\r\n      throw new Error(`Scan not found: ${scanId}`);\r\n    }\r\n\r\n    if (scan.status !== 'pending') {\r\n      throw new Error(`Scan ${scanId} is not in pending status`);\r\n    }\r\n\r\n    scan.status = 'running';\r\n    scan.updatedAt = new Date();\r\n\r\n    this.addAuditEntry(scan, 'system', 'scan_started', 'scan', {\r\n      scanId,\r\n      target: scan.target,\r\n    });\r\n\r\n    await this.saveScan(scan);\r\n    this.emit('scan:started', scan);\r\n\r\n    try {\r\n      const startTime = Date.now();\r\n\r\n      // Execute the appropriate scanner\r\n      const findings = await this.executeScanEngine(scan);\r\n\r\n      const endTime = Date.now();\r\n      scan.metrics.scanDuration = endTime - startTime;\r\n      scan.results = findings;\r\n      scan.status = 'completed';\r\n\r\n      // Calculate metrics\r\n      this.calculateScanMetrics(scan);\r\n\r\n      // Run compliance checks\r\n      await this.runComplianceChecks(scan);\r\n\r\n      // Generate remediation recommendations\r\n      await this.generateRemediationRecommendations(scan);\r\n\r\n      // Check notification thresholds\r\n      await this.checkNotificationThresholds(scan);\r\n\r\n      scan.updatedAt = new Date();\r\n\r\n      this.addAuditEntry(scan, 'system', 'scan_completed', 'scan', {\r\n        scanId,\r\n        duration: scan.metrics.scanDuration,\r\n        findingsCount: scan.results.length,\r\n      });\r\n\r\n      await this.saveScan(scan);\r\n      this.emit('scan:completed', scan);\r\n\r\n      this.logger.info(\r\n        `Security scan completed: ${scan.name} (${scan.id}) - ${scan.results.length} findings`,\r\n      );\r\n    } catch (error) {\r\n      scan.status = 'failed';\r\n      scan.updatedAt = new Date();\r\n\r\n      this.addAuditEntry(scan, 'system', 'scan_failed', 'scan', {\r\n        scanId,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n\r\n      await this.saveScan(scan);\r\n      this.emit('scan:failed', { scan, error });\r\n\r\n      this.logger.error(`Security scan failed: ${scan.name} (${scanId})`, { error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createSecurityIncident(incidentData: {\r\n    title: string;\r\n    description: string;\r\n    severity: SecuritySeverity;\r\n    type: SecurityIncident['type'];\r\n    source: SecurityIncident['source'];\r\n    affected?: Partial<SecurityIncident['affected']>;\r\n  }): Promise<SecurityIncident> {\r\n    const incident: SecurityIncident = {\r\n      id: `incident-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      title: incidentData.title,\r\n      description: incidentData.description,\r\n      severity: incidentData.severity,\r\n      status: 'open',\r\n      type: incidentData.type,\r\n      source: incidentData.source,\r\n      affected: {\r\n        systems: [],\r\n        data: [],\r\n        users: [],\r\n        ...incidentData.affected,\r\n      },\r\n      timeline: {\r\n        detected: new Date(),\r\n        reported: new Date(),\r\n        acknowledged: new Date(),\r\n      },\r\n      response: {\r\n        assignedTo: [],\r\n        actions: [],\r\n        communications: [],\r\n        lessons: [],\r\n      },\r\n      evidence: {\r\n        logs: [],\r\n        files: [],\r\n        screenshots: [],\r\n        forensics: [],\r\n      },\r\n      impact: {\r\n        confidentiality: 'none',\r\n        integrity: 'none',\r\n        availability: 'none',\r\n      },\r\n      rootCause: {\r\n        primary: '',\r\n        contributing: [],\r\n        analysis: '',\r\n      },\r\n      remediation: {\r\n        immediate: [],\r\n        shortTerm: [],\r\n        longTerm: [],\r\n        preventive: [],\r\n      },\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      createdBy: 'system',\r\n      auditLog: [],\r\n    };\r\n\r\n    this.addAuditEntry(incident, 'system', 'incident_created', 'incident', {\r\n      incidentId: incident.id,\r\n      severity: incident.severity,\r\n      type: incident.type,\r\n    });\r\n\r\n    this.incidents.set(incident.id, incident);\r\n    await this.saveIncident(incident);\r\n\r\n    // Auto-assign based on severity and type\r\n    await this.autoAssignIncident(incident);\r\n\r\n    // Send immediate notifications for high/critical incidents\r\n    if (incident.severity === 'critical' || incident.severity === 'high') {\r\n      await this.sendIncidentNotification(incident);\r\n    }\r\n\r\n    this.emit('incident:created', incident);\r\n    this.logger.info(`Security incident created: ${incident.title} (${incident.id})`);\r\n\r\n    return incident;\r\n  }\r\n\r\n  async updateIncident(\r\n    incidentId: string,\r\n    updates: Partial<SecurityIncident>,\r\n    userId: string = 'system',\r\n  ): Promise<SecurityIncident> {\r\n    const incident = this.incidents.get(incidentId);\r\n    if (!incident) {\r\n      throw new Error(`Incident not found: ${incidentId}`);\r\n    }\r\n\r\n    const oldStatus = incident.status;\r\n    Object.assign(incident, updates);\r\n    incident.updatedAt = new Date();\r\n\r\n    // Update timeline based on status changes\r\n    if (updates.status && updates.status !== oldStatus) {\r\n      this.updateIncidentTimeline(incident, updates.status);\r\n    }\r\n\r\n    this.addAuditEntry(incident, userId, 'incident_updated', 'incident', {\r\n      incidentId,\r\n      changes: Object.keys(updates),\r\n      oldStatus,\r\n      newStatus: incident.status,\r\n    });\r\n\r\n    await this.saveIncident(incident);\r\n    this.emit('incident:updated', { incident, updates });\r\n\r\n    this.logger.info(`Security incident updated: ${incident.title} (${incidentId})`);\r\n\r\n    return incident;\r\n  }\r\n\r\n  async runComplianceAssessment(\r\n    frameworks: string[],\r\n    scope?: {\r\n      projectId?: string;\r\n      environment?: string;\r\n      resources?: string[];\r\n    },\r\n  ): Promise<ComplianceCheck[]> {\r\n    const checks: ComplianceCheck[] = [];\r\n\r\n    for (const framework of frameworks) {\r\n      const frameworkChecks = await this.runFrameworkChecks(framework, scope);\r\n      checks.push(...frameworkChecks);\r\n    }\r\n\r\n    this.logger.info(\r\n      `Compliance assessment completed: ${checks.length} checks across ${frameworks.length} frameworks`,\r\n    );\r\n    this.emit('compliance:assessed', { frameworks, checks, scope });\r\n\r\n    return checks;\r\n  }\r\n\r\n  async createSecurityPolicy(policyData: {\r\n    name: string;\r\n    description: string;\r\n    type: SecurityPolicy['type'];\r\n    rules: Omit<SecurityRule, 'id'>[];\r\n    enforcement?: Partial<SecurityPolicy['enforcement']>;\r\n    applicability?: Partial<SecurityPolicy['applicability']>;\r\n  }): Promise<SecurityPolicy> {\r\n    const policy: SecurityPolicy = {\r\n      id: `policy-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: policyData.name,\r\n      description: policyData.description,\r\n      type: policyData.type,\r\n      version: '1.0.0',\r\n      status: 'draft',\r\n      rules: policyData.rules.map((rule) => ({\r\n        id: `rule-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n        ...rule,\r\n      })),\r\n      enforcement: {\r\n        level: 'warning',\r\n        exceptions: [],\r\n        approvers: [],\r\n        ...policyData.enforcement,\r\n      },\r\n      applicability: {\r\n        projects: [],\r\n        environments: [],\r\n        resources: [],\r\n        ...policyData.applicability,\r\n      },\r\n      schedule: {\r\n        reviewFrequency: 'annually',\r\n        nextReview: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year\r\n        reviewer: 'security-team',\r\n      },\r\n      metrics: {\r\n        violations: 0,\r\n        compliance: 100,\r\n        exceptions: 0,\r\n      },\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      createdBy: 'system',\r\n    };\r\n\r\n    this.policies.set(policy.id, policy);\r\n    await this.savePolicy(policy);\r\n\r\n    this.emit('policy:created', policy);\r\n    this.logger.info(`Security policy created: ${policy.name} (${policy.id})`);\r\n\r\n    return policy;\r\n  }\r\n\r\n  async getSecurityMetrics(filters?: {\r\n    timeRange?: { start: Date; end: Date };\r\n    projectId?: string;\r\n    environment?: string;\r\n    severity?: SecuritySeverity[];\r\n  }): Promise<SecurityMetrics> {\r\n    let scans = Array.from(this.scans.values());\r\n    let incidents = Array.from(this.incidents.values());\r\n\r\n    // Apply filters\r\n    if (filters) {\r\n      if (filters.timeRange) {\r\n        scans = scans.filter(\r\n          (s) => s.createdAt >= filters.timeRange!.start && s.createdAt <= filters.timeRange!.end,\r\n        );\r\n        incidents = incidents.filter(\r\n          (i) => i.createdAt >= filters.timeRange!.start && i.createdAt <= filters.timeRange!.end,\r\n        );\r\n      }\r\n      if (filters.projectId) {\r\n        scans = scans.filter((s) => s.projectId === filters.projectId);\r\n      }\r\n    }\r\n\r\n    // Calculate scan metrics\r\n    const scanMetrics = {\r\n      total: scans.length,\r\n      completed: scans.filter((s) => s.status === 'completed').length,\r\n      failed: scans.filter((s) => s.status === 'failed').length,\r\n      inProgress: scans.filter((s) => s.status === 'running').length,\r\n      byType: this.groupBy(scans, 'type'),\r\n      averageDuration:\r\n        scans.length > 0\r\n          ? scans.reduce((sum, s) => sum + s.metrics.scanDuration, 0) / scans.length\r\n          : 0,\r\n    };\r\n\r\n    // Calculate finding metrics\r\n    const allFindings = scans.flatMap((s) => s.results);\r\n    const findingMetrics = {\r\n      total: allFindings.length,\r\n      open: allFindings.filter((f) => f.status === 'open').length,\r\n      resolved: allFindings.filter((f) => f.status === 'resolved').length,\r\n      suppressed: allFindings.filter((f) => f.status === 'suppressed').length,\r\n      bySeverity: this.groupBy(allFindings, 'severity') as Record<SecuritySeverity, number>,\r\n      byCategory: this.groupBy(allFindings, 'category'),\r\n      meanTimeToResolution: this.calculateMTTR(allFindings),\r\n    };\r\n\r\n    // Calculate compliance metrics\r\n    const allComplianceChecks = scans.flatMap((s) => s.compliance.requirements);\r\n    const complianceFrameworks: Record<string, any> = {};\r\n\r\n    for (const check of allComplianceChecks) {\r\n      if (!complianceFrameworks[check.framework]) {\r\n        complianceFrameworks[check.framework] = {\r\n          total: 0,\r\n          passed: 0,\r\n          failed: 0,\r\n          score: 0,\r\n        };\r\n      }\r\n\r\n      complianceFrameworks[check.framework].total++;\r\n      if (check.status === 'passed') {\r\n        complianceFrameworks[check.framework].passed++;\r\n      } else if (check.status === 'failed') {\r\n        complianceFrameworks[check.framework].failed++;\r\n      }\r\n    }\r\n\r\n    // Calculate scores\r\n    for (const framework in complianceFrameworks) {\r\n      const fw = complianceFrameworks[framework];\r\n      fw.score = fw.total > 0 ? (fw.passed / fw.total) * 100 : 0;\r\n    }\r\n\r\n    const overallComplianceScore =\r\n      Object.values(complianceFrameworks).length > 0\r\n        ? Object.values(complianceFrameworks).reduce((sum: number, fw: any) => sum + fw.score, 0) /\r\n          Object.values(complianceFrameworks).length\r\n        : 0;\r\n\r\n    // Calculate incident metrics\r\n    const incidentMetrics = {\r\n      total: incidents.length,\r\n      open: incidents.filter((i) => i.status === 'open' || i.status === 'investigating').length,\r\n      resolved: incidents.filter((i) => i.status === 'resolved' || i.status === 'closed').length,\r\n      bySeverity: this.groupBy(incidents, 'severity') as Record<SecuritySeverity, number>,\r\n      meanTimeToDetection: this.calculateMTTD(incidents),\r\n      meanTimeToResponse: this.calculateMTTResponse(incidents),\r\n      meanTimeToResolution: this.calculateIncidentMTTR(incidents),\r\n    };\r\n\r\n    // Policy metrics\r\n    const policies = Array.from(this.policies.values());\r\n    const policyMetrics = {\r\n      total: policies.length,\r\n      active: policies.filter((p) => p.status === 'active').length,\r\n      violations: policies.reduce((sum, p) => sum + p.metrics.violations, 0),\r\n      compliance:\r\n        policies.length > 0\r\n          ? policies.reduce((sum, p) => sum + p.metrics.compliance, 0) / policies.length\r\n          : 0,\r\n    };\r\n\r\n    return {\r\n      scans: scanMetrics,\r\n      findings: findingMetrics,\r\n      compliance: {\r\n        frameworks: complianceFrameworks,\r\n        overallScore: overallComplianceScore,\r\n        trending: 'stable', // Would be calculated from historical data\r\n      },\r\n      incidents: incidentMetrics,\r\n      policies: policyMetrics,\r\n      trends: {\r\n        findingsTrend: [], // Would be calculated from historical data\r\n        complianceTrend: [], // Would be calculated from historical data\r\n        incidentsTrend: [], // Would be calculated from historical data\r\n      },\r\n    };\r\n  }\r\n\r\n  // Private helper methods\r\n  private async loadConfigurations(): Promise<void> {\r\n    try {\r\n      // Load scans\r\n      const scanFiles = await readdir(join(this.securityPath, 'scans'));\r\n      for (const file of scanFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.securityPath, 'scans', file), 'utf-8');\r\n        const scan: SecurityScan = JSON.parse(content);\r\n        this.scans.set(scan.id, scan);\r\n      }\r\n\r\n      // Load policies\r\n      const policyFiles = await readdir(join(this.securityPath, 'policies'));\r\n      for (const file of policyFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.securityPath, 'policies', file), 'utf-8');\r\n        const policy: SecurityPolicy = JSON.parse(content);\r\n        this.policies.set(policy.id, policy);\r\n      }\r\n\r\n      // Load incidents\r\n      const incidentFiles = await readdir(join(this.securityPath, 'incidents'));\r\n      for (const file of incidentFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.securityPath, 'incidents', file), 'utf-8');\r\n        const incident: SecurityIncident = JSON.parse(content);\r\n        this.incidents.set(incident.id, incident);\r\n      }\r\n\r\n      this.logger.info(\r\n        `Loaded ${this.scans.size} scans, ${this.policies.size} policies, ${this.incidents.size} incidents`,\r\n      );\r\n    } catch (error) {\r\n      this.logger.warn('Failed to load some security configurations', { error });\r\n    }\r\n  }\r\n\r\n  private async initializeDefaultPolicies(): Promise<void> {\r\n    const defaultPolicies = [\r\n      {\r\n        name: 'Critical Vulnerability Policy',\r\n        description: 'Immediate action required for critical vulnerabilities',\r\n        type: 'scanning' as const,\r\n        rules: [\r\n          {\r\n            name: 'Critical CVSS Score',\r\n            description: 'Alert on vulnerabilities with CVSS score >= 9.0',\r\n            condition: 'cvss.score >= 9.0',\r\n            action: 'alert' as const,\r\n            severity: 'critical' as const,\r\n            parameters: { threshold: 9.0 },\r\n            enabled: true,\r\n          },\r\n        ],\r\n        enforcement: {\r\n          level: 'blocking' as const,\r\n          exceptions: [],\r\n          approvers: ['security-lead'],\r\n        },\r\n      },\r\n      {\r\n        name: 'Secret Detection Policy',\r\n        description: 'Detect exposed secrets and credentials',\r\n        type: 'scanning' as const,\r\n        rules: [\r\n          {\r\n            name: 'API Key Detection',\r\n            description: 'Detect exposed API keys',\r\n            condition: 'category == \"secret\" && type == \"api-key\"',\r\n            action: 'deny' as const,\r\n            severity: 'high' as const,\r\n            parameters: {},\r\n            enabled: true,\r\n          },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    for (const policyData of defaultPolicies) {\r\n      if (!Array.from(this.policies.values()).some((p) => p.name === policyData.name)) {\r\n        await this.createSecurityPolicy(policyData);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async initializeVulnerabilityDatabases(): Promise<void> {\r\n    const databases: VulnerabilityDatabase[] = [\r\n      {\r\n        id: 'nvd',\r\n        name: 'National Vulnerability Database',\r\n        type: 'nvd',\r\n        url: 'https://nvd.nist.gov/feeds/json/cve/1.1/',\r\n        updateFrequency: 'daily',\r\n        lastUpdate: new Date(),\r\n        status: 'active',\r\n        configuration: {},\r\n      },\r\n      {\r\n        id: 'github-advisories',\r\n        name: 'GitHub Security Advisories',\r\n        type: 'github',\r\n        url: 'https://api.github.com/advisories',\r\n        updateFrequency: 'daily',\r\n        lastUpdate: new Date(),\r\n        status: 'active',\r\n        configuration: {},\r\n      },\r\n    ];\r\n\r\n    for (const db of databases) {\r\n      this.vulnerabilityDatabases.set(db.id, db);\r\n    }\r\n  }\r\n\r\n  private getDefaultScanner(type: SecurityScan['type']): string {\r\n    const scanners: Record<SecurityScan['type'], string> = {\r\n      vulnerability: 'trivy',\r\n      dependency: 'npm-audit',\r\n      'code-quality': 'sonarqube',\r\n      secrets: 'gitleaks',\r\n      compliance: 'inspec',\r\n      infrastructure: 'checkov',\r\n      container: 'clair',\r\n    };\r\n\r\n    return scanners[type] || 'generic';\r\n  }\r\n\r\n  private async executeScanEngine(scan: SecurityScan): Promise<SecurityFinding[]> {\r\n    const findings: SecurityFinding[] = [];\r\n\r\n    switch (scan.configuration.scanner) {\r\n      case 'trivy':\r\n        return this.executeTrivyScan(scan);\r\n      case 'npm-audit':\r\n        return this.executeNpmAuditScan(scan);\r\n      case 'gitleaks':\r\n        return this.executeGitleaksScan(scan);\r\n      case 'checkov':\r\n        return this.executeCheckovScan(scan);\r\n      default:\r\n        return this.executeGenericScan(scan);\r\n    }\r\n  }\r\n\r\n  private async executeTrivyScan(scan: SecurityScan): Promise<SecurityFinding[]> {\r\n    return new Promise((resolve, reject) => {\r\n      const findings: SecurityFinding[] = [];\r\n\r\n      // Mock Trivy execution\r\n      const mockFindings = [\r\n        {\r\n          id: `finding-${Date.now()}-1`,\r\n          title: 'CVE-2023-12345: Remote Code Execution in libxml2',\r\n          description: 'A buffer overflow vulnerability in libxml2 allows remote code execution',\r\n          severity: 'critical' as const,\r\n          category: 'vulnerability' as const,\r\n          cve: 'CVE-2023-12345',\r\n          cvss: {\r\n            score: 9.8,\r\n            vector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',\r\n            version: '3.1',\r\n          },\r\n          location: {\r\n            file: 'package-lock.json',\r\n            line: 125,\r\n            component: 'libxml2@2.9.10',\r\n          },\r\n          evidence: {\r\n            snippet: '\"libxml2\": \"2.9.10\"',\r\n            context: 'Dependency declaration',\r\n            references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-12345'],\r\n          },\r\n          impact: 'Remote attackers could execute arbitrary code',\r\n          remediation: {\r\n            description: 'Update libxml2 to version 2.9.14 or later',\r\n            effort: 'low' as const,\r\n            priority: 'critical' as const,\r\n            autoFixable: true,\r\n            steps: ['npm update libxml2'],\r\n            references: ['https://github.com/GNOME/libxml2/releases'],\r\n          },\r\n          status: 'open' as const,\r\n          tags: ['cve', 'rce', 'dependency'],\r\n          metadata: {},\r\n          firstSeen: new Date(),\r\n          lastSeen: new Date(),\r\n          occurrences: 1,\r\n        },\r\n      ];\r\n\r\n      // Simulate scan delay\r\n      setTimeout(() => {\r\n        resolve(mockFindings);\r\n      }, 2000);\r\n    });\r\n  }\r\n\r\n  private async executeNpmAuditScan(scan: SecurityScan): Promise<SecurityFinding[]> {\r\n    return new Promise((resolve, reject) => {\r\n      const command = 'npm';\r\n      const args = ['audit', '--json'];\r\n\r\n      const child = spawn(command, args, {\r\n        cwd: scan.target.path,\r\n        stdio: ['pipe', 'pipe', 'pipe'],\r\n      });\r\n\r\n      let stdout = '';\r\n      let stderr = '';\r\n\r\n      child.stdout?.on('data', (data) => {\r\n        stdout += data.toString();\r\n      });\r\n\r\n      child.stderr?.on('data', (data) => {\r\n        stderr += data.toString();\r\n      });\r\n\r\n      child.on('close', (code) => {\r\n        try {\r\n          const auditResult = JSON.parse(stdout);\r\n          const findings = this.parseNpmAuditResults(auditResult);\r\n          resolve(findings);\r\n        } catch (error) {\r\n          reject(\r\n            new Error(\r\n              `Failed to parse npm audit results: ${error instanceof Error ? error.message : String(error)}`,\r\n            ),\r\n          );\r\n        }\r\n      });\r\n\r\n      child.on('error', (error) => {\r\n        reject(error);\r\n      });\r\n    });\r\n  }\r\n\r\n  private async executeGitleaksScan(scan: SecurityScan): Promise<SecurityFinding[]> {\r\n    // Mock Gitleaks scan for secrets detection\r\n    return [\r\n      {\r\n        id: `finding-${Date.now()}-2`,\r\n        title: 'Exposed AWS Access Key',\r\n        description: 'AWS access key found in source code',\r\n        severity: 'high' as const,\r\n        category: 'secret' as const,\r\n        location: {\r\n          file: 'config/aws.js',\r\n          line: 12,\r\n          column: 20,\r\n        },\r\n        evidence: {\r\n          snippet: 'const accessKey = \"AKIA123456789...\"',\r\n          context: 'Hardcoded AWS credentials',\r\n        },\r\n        impact: 'Unauthorized access to AWS resources',\r\n        remediation: {\r\n          description: 'Remove hardcoded credentials and use environment variables or IAM roles',\r\n          effort: 'medium' as const,\r\n          priority: 'high' as const,\r\n          autoFixable: false,\r\n          steps: [\r\n            'Remove hardcoded credentials',\r\n            'Use environment variables',\r\n            'Rotate compromised keys',\r\n          ],\r\n          references: ['https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html'],\r\n        },\r\n        status: 'open' as const,\r\n        tags: ['secret', 'aws', 'credentials'],\r\n        metadata: {},\r\n        firstSeen: new Date(),\r\n        lastSeen: new Date(),\r\n        occurrences: 1,\r\n      },\r\n    ];\r\n  }\r\n\r\n  private async executeCheckovScan(scan: SecurityScan): Promise<SecurityFinding[]> {\r\n    // Mock Checkov scan for infrastructure as code\r\n    return [];\r\n  }\r\n\r\n  private async executeGenericScan(scan: SecurityScan): Promise<SecurityFinding[]> {\r\n    // Generic scan implementation\r\n    return [];\r\n  }\r\n\r\n  private parseNpmAuditResults(auditResult: any): SecurityFinding[] {\r\n    const findings: SecurityFinding[] = [];\r\n\r\n    if (auditResult.vulnerabilities) {\r\n      for (const [packageName, vulnData] of Object.entries(auditResult.vulnerabilities)) {\r\n        const vuln = vulnData as any;\r\n\r\n        findings.push({\r\n          id: `finding-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n          title: `${vuln.severity} vulnerability in ${packageName}`,\r\n          description: vuln.title || 'Vulnerability detected',\r\n          severity: vuln.severity as SecuritySeverity,\r\n          category: 'vulnerability',\r\n          cve: vuln.cve,\r\n          location: {\r\n            file: 'package.json',\r\n            component: packageName,\r\n          },\r\n          evidence: {\r\n            snippet: `\"${packageName}\": \"${vuln.range}\"`,\r\n            references: vuln.url ? [vuln.url] : [],\r\n          },\r\n          impact: vuln.overview || 'Security vulnerability',\r\n          remediation: {\r\n            description: vuln.recommendation || 'Update to a secure version',\r\n            effort: 'low' as const,\r\n            priority:\r\n              vuln.severity === 'info'\r\n                ? 'low'\r\n                : (vuln.severity as 'low' | 'medium' | 'high' | 'critical'),\r\n            autoFixable: true,\r\n            steps: [`npm update ${packageName}`],\r\n            references: vuln.url ? [vuln.url] : [],\r\n          },\r\n          status: 'open',\r\n          tags: ['npm', 'dependency'],\r\n          metadata: { packageName, range: vuln.range },\r\n          firstSeen: new Date(),\r\n          lastSeen: new Date(),\r\n          occurrences: 1,\r\n        });\r\n      }\r\n    }\r\n\r\n    return findings;\r\n  }\r\n\r\n  private calculateScanMetrics(scan: SecurityScan): void {\r\n    const findings = scan.results;\r\n\r\n    scan.metrics.totalFindings = findings.length;\r\n    scan.metrics.criticalFindings = findings.filter((f) => f.severity === 'critical').length;\r\n    scan.metrics.highFindings = findings.filter((f) => f.severity === 'high').length;\r\n    scan.metrics.mediumFindings = findings.filter((f) => f.severity === 'medium').length;\r\n    scan.metrics.lowFindings = findings.filter((f) => f.severity === 'low').length;\r\n    scan.metrics.falsePositives = findings.filter((f) => f.status === 'false-positive').length;\r\n    scan.metrics.suppressed = findings.filter((f) => f.status === 'suppressed').length;\r\n  }\r\n\r\n  private async runComplianceChecks(scan: SecurityScan): Promise<void> {\r\n    // Mock compliance checks\r\n    const frameworks = ['SOC2', 'GDPR', 'PCI-DSS'];\r\n\r\n    for (const framework of frameworks) {\r\n      const checks = await this.runFrameworkChecks(framework, { projectId: scan.projectId });\r\n      scan.compliance.requirements.push(...checks);\r\n    }\r\n\r\n    scan.compliance.frameworks = frameworks;\r\n    scan.compliance.passedChecks = scan.compliance.requirements.filter(\r\n      (r) => r.status === 'passed',\r\n    ).length;\r\n    scan.compliance.failedChecks = scan.compliance.requirements.filter(\r\n      (r) => r.status === 'failed',\r\n    ).length;\r\n    scan.compliance.overallScore =\r\n      scan.compliance.requirements.length > 0\r\n        ? (scan.compliance.passedChecks / scan.compliance.requirements.length) * 100\r\n        : 0;\r\n  }\r\n\r\n  private async runFrameworkChecks(framework: string, scope?: any): Promise<ComplianceCheck[]> {\r\n    // Mock compliance checks for different frameworks\r\n    const mockChecks: ComplianceCheck[] = [\r\n      {\r\n        id: `check-${Date.now()}-1`,\r\n        framework,\r\n        control: 'CC6.1',\r\n        description: 'Encryption in transit',\r\n        status: 'passed',\r\n        severity: 'high',\r\n        evidence: 'TLS 1.2+ configured',\r\n        lastChecked: new Date(),\r\n      },\r\n      {\r\n        id: `check-${Date.now()}-2`,\r\n        framework,\r\n        control: 'CC6.7',\r\n        description: 'Encryption at rest',\r\n        status: 'failed',\r\n        severity: 'medium',\r\n        remediation: 'Enable database encryption',\r\n        lastChecked: new Date(),\r\n      },\r\n    ];\r\n\r\n    return mockChecks;\r\n  }\r\n\r\n  private async generateRemediationRecommendations(scan: SecurityScan): Promise<void> {\r\n    const autoFixable = scan.results.filter((f) => f.remediation.autoFixable);\r\n    const manualReview = scan.results.filter((f) => !f.remediation.autoFixable);\r\n\r\n    scan.remediation.autoFixAvailable = autoFixable;\r\n    scan.remediation.manualReview = manualReview;\r\n\r\n    // Generate general recommendations\r\n    scan.remediation.recommendations = [\r\n      {\r\n        id: `rec-${Date.now()}-1`,\r\n        title: 'Implement Automated Dependency Updates',\r\n        description: 'Set up automated dependency updates to reduce vulnerability exposure',\r\n        category: 'vulnerability-management',\r\n        priority: 'high',\r\n        effort: 'medium',\r\n        impact: 'Reduces time to patch vulnerabilities',\r\n        implementation: {\r\n          steps: [\r\n            'Configure Dependabot or Renovate',\r\n            'Set up automated testing pipeline',\r\n            'Enable auto-merge for low-risk updates',\r\n          ],\r\n          tools: ['Dependabot', 'Renovate', 'GitHub Actions'],\r\n          timeEstimate: '2-4 hours',\r\n          cost: 'Free',\r\n        },\r\n        references: [\r\n          'https://docs.github.com/en/code-security/dependabot',\r\n          'https://renovatebot.com/',\r\n        ],\r\n        applicableFrameworks: ['SOC2', 'ISO27001'],\r\n      },\r\n    ];\r\n  }\r\n\r\n  private async checkNotificationThresholds(scan: SecurityScan): Promise<void> {\r\n    const thresholds = scan.notifications.thresholds;\r\n\r\n    if (\r\n      scan.metrics.criticalFindings >= thresholds.critical ||\r\n      scan.metrics.highFindings >= thresholds.high ||\r\n      scan.metrics.mediumFindings >= thresholds.medium\r\n    ) {\r\n      await this.sendScanNotification(scan);\r\n    }\r\n  }\r\n\r\n  private async sendScanNotification(scan: SecurityScan): Promise<void> {\r\n    const message = `Security scan '${scan.name}' completed with ${scan.metrics.totalFindings} findings (${scan.metrics.criticalFindings} critical, ${scan.metrics.highFindings} high)`;\r\n\r\n    this.emit('notification:scan', {\r\n      scan,\r\n      message,\r\n      severity:\r\n        scan.metrics.criticalFindings > 0\r\n          ? 'critical'\r\n          : scan.metrics.highFindings > 0\r\n            ? 'high'\r\n            : 'medium',\r\n    });\r\n\r\n    this.logger.warn(message);\r\n  }\r\n\r\n  private async autoAssignIncident(incident: SecurityIncident): Promise<void> {\r\n    // Auto-assign based on severity and type\r\n    const assignmentRules: Record<string, string[]> = {\r\n      critical: ['security-lead', 'ciso'],\r\n      high: ['security-team'],\r\n      medium: ['security-analyst'],\r\n      low: ['security-analyst'],\r\n    };\r\n\r\n    incident.response.assignedTo = assignmentRules[incident.severity] || ['security-team'];\r\n  }\r\n\r\n  private async sendIncidentNotification(incident: SecurityIncident): Promise<void> {\r\n    const message = `SECURITY INCIDENT: ${incident.title} (${incident.severity.toUpperCase()})`;\r\n\r\n    this.emit('notification:incident', {\r\n      incident,\r\n      message,\r\n      urgency: incident.severity === 'critical' ? 'immediate' : 'high',\r\n    });\r\n\r\n    this.logger.error(message);\r\n  }\r\n\r\n  private updateIncidentTimeline(incident: SecurityIncident, newStatus: string): void {\r\n    const now = new Date();\r\n\r\n    switch (newStatus) {\r\n      case 'investigating':\r\n        incident.timeline.acknowledged = now;\r\n        break;\r\n      case 'contained':\r\n        incident.timeline.contained = now;\r\n        break;\r\n      case 'resolved':\r\n        incident.timeline.resolved = now;\r\n        break;\r\n      case 'closed':\r\n        incident.timeline.closed = now;\r\n        break;\r\n    }\r\n  }\r\n\r\n  private async saveScan(scan: SecurityScan): Promise<void> {\r\n    const filePath = join(this.securityPath, 'scans', `${scan.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(scan, null, 2));\r\n  }\r\n\r\n  private async savePolicy(policy: SecurityPolicy): Promise<void> {\r\n    const filePath = join(this.securityPath, 'policies', `${policy.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(policy, null, 2));\r\n  }\r\n\r\n  private async saveIncident(incident: SecurityIncident): Promise<void> {\r\n    const filePath = join(this.securityPath, 'incidents', `${incident.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(incident, null, 2));\r\n  }\r\n\r\n  private addAuditEntry(\r\n    target: SecurityScan | SecurityIncident,\r\n    userId: string,\r\n    action: string,\r\n    targetType: string,\r\n    details: Record<string, any>,\r\n  ): void {\r\n    const entry: SecurityAuditEntry = {\r\n      id: `audit-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: new Date(),\r\n      userId,\r\n      action,\r\n      target: targetType,\r\n      details,\r\n    };\r\n\r\n    target.auditLog.push(entry);\r\n  }\r\n\r\n  private groupBy<T>(array: T[], key: keyof T): Record<string, number> {\r\n    return array.reduce(\r\n      (groups, item) => {\r\n        const value = String(item[key]);\r\n        groups[value] = (groups[value] || 0) + 1;\r\n        return groups;\r\n      },\r\n      {} as Record<string, number>,\r\n    );\r\n  }\r\n\r\n  private calculateMTTR(findings: SecurityFinding[]): number {\r\n    const resolvedFindings = findings.filter(\r\n      (f) => f.status === 'resolved' && f.firstSeen && f.lastSeen,\r\n    );\r\n\r\n    if (resolvedFindings.length === 0) return 0;\r\n\r\n    const totalTime = resolvedFindings.reduce(\r\n      (sum, f) => sum + (f.lastSeen.getTime() - f.firstSeen.getTime()),\r\n      0,\r\n    );\r\n\r\n    return totalTime / resolvedFindings.length;\r\n  }\r\n\r\n  private calculateMTTD(incidents: SecurityIncident[]): number {\r\n    const detectedIncidents = incidents.filter((i) => i.timeline.detected && i.timeline.reported);\r\n\r\n    if (detectedIncidents.length === 0) return 0;\r\n\r\n    const totalTime = detectedIncidents.reduce(\r\n      (sum, i) => sum + (i.timeline.reported.getTime() - i.timeline.detected.getTime()),\r\n      0,\r\n    );\r\n\r\n    return totalTime / detectedIncidents.length;\r\n  }\r\n\r\n  private calculateMTTResponse(incidents: SecurityIncident[]): number {\r\n    const respondedIncidents = incidents.filter(\r\n      (i) => i.timeline.reported && i.timeline.acknowledged,\r\n    );\r\n\r\n    if (respondedIncidents.length === 0) return 0;\r\n\r\n    const totalTime = respondedIncidents.reduce(\r\n      (sum, i) => sum + (i.timeline.acknowledged.getTime() - i.timeline.reported.getTime()),\r\n      0,\r\n    );\r\n\r\n    return totalTime / respondedIncidents.length;\r\n  }\r\n\r\n  private calculateIncidentMTTR(incidents: SecurityIncident[]): number {\r\n    const resolvedIncidents = incidents.filter((i) => i.timeline.reported && i.timeline.resolved);\r\n\r\n    if (resolvedIncidents.length === 0) return 0;\r\n\r\n    const totalTime = resolvedIncidents.reduce(\r\n      (sum, i) => sum + (i.timeline.resolved!.getTime() - i.timeline.reported.getTime()),\r\n      0,\r\n    );\r\n\r\n    return totalTime / resolvedIncidents.length;\r\n  }\r\n}\r\n"],"names":["EventEmitter","writeFile","readFile","mkdir","readdir","join","spawn","Logger","ConfigManager","SecurityManager","scans","Map","policies","incidents","vulnerabilityDatabases","securityPath","logger","config","level","format","destination","getInstance","initialize","recursive","loadConfigurations","initializeDefaultPolicies","initializeVulnerabilityDatabases","info","error","createSecurityScan","scanData","scan","id","Date","now","Math","random","toString","substr","name","type","status","projectId","target","configuration","scanner","getDefaultScanner","rules","excludes","severity","formats","outputPath","results","metrics","totalFindings","criticalFindings","highFindings","mediumFindings","lowFindings","falsePositives","suppressed","scanDuration","filesScanned","linesScanned","compliance","frameworks","requirements","overallScore","passedChecks","failedChecks","remediation","autoFixAvailable","manualReview","recommendations","schedule","notifications","channels","thresholds","critical","high","medium","createdAt","updatedAt","createdBy","auditLog","addAuditEntry","scanId","scanName","scanType","set","saveScan","emit","executeScan","get","Error","startTime","findings","executeScanEngine","endTime","calculateScanMetrics","runComplianceChecks","generateRemediationRecommendations","checkNotificationThresholds","duration","findingsCount","length","message","String","createSecurityIncident","incidentData","incident","title","description","source","affected","systems","data","users","timeline","detected","reported","acknowledged","response","assignedTo","actions","communications","lessons","evidence","logs","files","screenshots","forensics","impact","confidentiality","integrity","availability","rootCause","primary","contributing","analysis","immediate","shortTerm","longTerm","preventive","incidentId","saveIncident","autoAssignIncident","sendIncidentNotification","updateIncident","updates","userId","oldStatus","Object","assign","updateIncidentTimeline","changes","keys","newStatus","runComplianceAssessment","scope","checks","framework","frameworkChecks","runFrameworkChecks","push","createSecurityPolicy","policyData","policy","version","map","rule","enforcement","exceptions","approvers","applicability","projects","environments","resources","reviewFrequency","nextReview","reviewer","violations","savePolicy","getSecurityMetrics","filters","Array","from","values","timeRange","filter","s","start","end","i","scanMetrics","total","completed","failed","inProgress","byType","groupBy","averageDuration","reduce","sum","allFindings","flatMap","findingMetrics","open","f","resolved","bySeverity","byCategory","meanTimeToResolution","calculateMTTR","allComplianceChecks","complianceFrameworks","check","passed","score","fw","overallComplianceScore","incidentMetrics","meanTimeToDetection","calculateMTTD","meanTimeToResponse","calculateMTTResponse","calculateIncidentMTTR","policyMetrics","active","p","trending","trends","findingsTrend","complianceTrend","incidentsTrend","scanFiles","file","endsWith","content","JSON","parse","policyFiles","incidentFiles","size","warn","defaultPolicies","condition","action","parameters","threshold","enabled","some","databases","url","updateFrequency","lastUpdate","db","scanners","vulnerability","dependency","secrets","infrastructure","container","executeTrivyScan","executeNpmAuditScan","executeGitleaksScan","executeCheckovScan","executeGenericScan","Promise","resolve","reject","mockFindings","category","cve","cvss","vector","location","line","component","snippet","context","references","effort","priority","autoFixable","steps","tags","metadata","firstSeen","lastSeen","occurrences","setTimeout","command","args","child","cwd","path","stdio","stdout","stderr","on","code","auditResult","parseNpmAuditResults","column","vulnerabilities","packageName","vulnData","entries","vuln","range","overview","recommendation","r","mockChecks","control","lastChecked","implementation","tools","timeEstimate","cost","applicableFrameworks","sendScanNotification","assignmentRules","low","toUpperCase","urgency","contained","closed","filePath","stringify","targetType","details","entry","timestamp","array","key","groups","item","value","resolvedFindings","totalTime","getTime","detectedIncidents","respondedIncidents","resolvedIncidents"],"mappings":"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"}
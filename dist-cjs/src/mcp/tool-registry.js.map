{"version":3,"sources":["../../../src/mcp/tool-registry.ts"],"sourcesContent":["/**\r\n * Tool Registry for In-Process MCP Server\r\n *\r\n * Registers all 50+ Claude-Flow MCP tools for in-process execution.\r\n * Provides tool discovery, validation, and routing.\r\n */\r\n\r\nimport { createInProcessServer, InProcessMCPServer } from './in-process-server.js';\r\nimport { createClaudeFlowTools } from './claude-flow-tools.js';\r\nimport { logger } from '../core/logger.js';\r\nimport type { MCPTool } from '../utils/types.js';\r\nimport type { McpSdkServerConfigWithInstance } from '@anthropic-ai/claude-code/sdk.d.ts';\r\n\r\n// Import SDK tool creation function\r\nimport { tool, createSdkMcpServer } from '@anthropic-ai/claude-code/sdk';\r\nimport { z } from 'zod';\r\n\r\nexport interface ToolRegistryConfig {\r\n  enableInProcess: boolean;\r\n  enableMetrics: boolean;\r\n  enableCaching: boolean;\r\n  orchestratorContext?: any;\r\n}\r\n\r\n/**\r\n * Global tool registry for managing all MCP tools\r\n */\r\nexport class ClaudeFlowToolRegistry {\r\n  private inProcessServer?: InProcessMCPServer;\r\n  private sdkServer?: McpSdkServerConfigWithInstance;\r\n  private tools: Map<string, MCPTool>;\r\n  private config: ToolRegistryConfig;\r\n\r\n  constructor(config: ToolRegistryConfig) {\r\n    this.config = config;\r\n    this.tools = new Map();\r\n\r\n    logger.info('ClaudeFlowToolRegistry initialized', {\r\n      enableInProcess: config.enableInProcess,\r\n      enableMetrics: config.enableMetrics,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initialize the tool registry with all Claude-Flow tools\r\n   */\r\n  async initialize(): Promise<void> {\r\n    logger.info('Loading Claude-Flow tools...');\r\n\r\n    // Load all tools from claude-flow-tools.ts\r\n    const claudeFlowTools = await createClaudeFlowTools(logger);\r\n\r\n    // Register each tool\r\n    for (const tool of claudeFlowTools) {\r\n      this.tools.set(tool.name, tool);\r\n    }\r\n\r\n    logger.info(`Loaded ${this.tools.size} Claude-Flow tools`);\r\n\r\n    // Create in-process server if enabled\r\n    if (this.config.enableInProcess) {\r\n      await this.createInProcessServer();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create SDK-compatible in-process server\r\n   */\r\n  private async createInProcessServer(): Promise<void> {\r\n    logger.info('Creating in-process MCP server...');\r\n\r\n    // Create in-process server\r\n    this.inProcessServer = createInProcessServer({\r\n      name: 'claude-flow',\r\n      version: '2.0.0',\r\n      enableMetrics: this.config.enableMetrics,\r\n      enableCaching: this.config.enableCaching,\r\n    });\r\n\r\n    // Register all tools\r\n    for (const [name, tool] of this.tools) {\r\n      this.inProcessServer.registerTool(tool);\r\n    }\r\n\r\n    // Set orchestrator context if provided\r\n    if (this.config.orchestratorContext) {\r\n      this.inProcessServer.setContext({\r\n        orchestrator: this.config.orchestratorContext,\r\n        sessionId: 'in-process-session',\r\n      });\r\n    }\r\n\r\n    // Create SDK MCP server for integration\r\n    await this.createSdkServer();\r\n\r\n    logger.info('In-process MCP server created', {\r\n      toolCount: this.inProcessServer.getToolNames().length,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create SDK-compatible MCP server using SDK's createSdkMcpServer\r\n   */\r\n  private async createSdkServer(): Promise<void> {\r\n    if (!this.inProcessServer) {\r\n      throw new Error('In-process server not initialized');\r\n    }\r\n\r\n    // Convert Claude-Flow tools to SDK tool format\r\n    const sdkTools = Array.from(this.tools.values()).map(tool => {\r\n      return this.convertToSdkTool(tool);\r\n    });\r\n\r\n    // Create SDK MCP server\r\n    this.sdkServer = createSdkMcpServer({\r\n      name: 'claude-flow',\r\n      version: '2.0.0',\r\n      tools: sdkTools,\r\n    });\r\n\r\n    logger.info('SDK MCP server created', { toolCount: sdkTools.length });\r\n  }\r\n\r\n  /**\r\n   * Convert Claude-Flow tool to SDK tool format\r\n   */\r\n  private convertToSdkTool(mcpTool: MCPTool): any {\r\n    // Convert JSON Schema to Zod schema\r\n    const zodSchema = this.jsonSchemaToZod(mcpTool.inputSchema);\r\n\r\n    // Create SDK tool using the 'tool' helper\r\n    return tool(\r\n      mcpTool.name,\r\n      mcpTool.description,\r\n      zodSchema,\r\n      async (args: any, extra: unknown) => {\r\n        // Execute via in-process server\r\n        if (this.inProcessServer) {\r\n          return await this.inProcessServer.callTool(mcpTool.name, args);\r\n        }\r\n\r\n        // Fallback to direct execution\r\n        const result = await mcpTool.handler(args, {\r\n          orchestrator: this.config.orchestratorContext,\r\n          sessionId: 'sdk-session',\r\n        });\r\n\r\n        return {\r\n          content: [\r\n            {\r\n              type: 'text',\r\n              text: typeof result === 'string' ? result : JSON.stringify(result, null, 2),\r\n            },\r\n          ],\r\n          isError: false,\r\n        };\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Convert JSON Schema to Zod schema (simplified)\r\n   */\r\n  private jsonSchemaToZod(schema: any): any {\r\n    const zodSchema: any = {};\r\n\r\n    if (!schema.properties) {\r\n      return {};\r\n    }\r\n\r\n    for (const [key, prop] of Object.entries(schema.properties)) {\r\n      const p = prop as any;\r\n\r\n      // Basic type conversion\r\n      if (p.type === 'string') {\r\n        zodSchema[key] = p.enum ? z.enum(p.enum) : z.string();\r\n        if (p.default !== undefined) {\r\n          zodSchema[key] = zodSchema[key].default(p.default);\r\n        }\r\n        if (!schema.required?.includes(key)) {\r\n          zodSchema[key] = zodSchema[key].optional();\r\n        }\r\n      } else if (p.type === 'number' || p.type === 'integer') {\r\n        zodSchema[key] = z.number();\r\n        if (p.default !== undefined) {\r\n          zodSchema[key] = zodSchema[key].default(p.default);\r\n        }\r\n        if (!schema.required?.includes(key)) {\r\n          zodSchema[key] = zodSchema[key].optional();\r\n        }\r\n      } else if (p.type === 'boolean') {\r\n        zodSchema[key] = z.boolean();\r\n        if (p.default !== undefined) {\r\n          zodSchema[key] = zodSchema[key].default(p.default);\r\n        }\r\n        if (!schema.required?.includes(key)) {\r\n          zodSchema[key] = zodSchema[key].optional();\r\n        }\r\n      } else if (p.type === 'array') {\r\n        zodSchema[key] = z.array(z.any());\r\n        if (!schema.required?.includes(key)) {\r\n          zodSchema[key] = zodSchema[key].optional();\r\n        }\r\n      } else if (p.type === 'object') {\r\n        zodSchema[key] = z.record(z.any());\r\n        if (!schema.required?.includes(key)) {\r\n          zodSchema[key] = zodSchema[key].optional();\r\n        }\r\n      } else {\r\n        // Default to any\r\n        zodSchema[key] = z.any();\r\n        if (!schema.required?.includes(key)) {\r\n          zodSchema[key] = zodSchema[key].optional();\r\n        }\r\n      }\r\n\r\n      // Add description\r\n      if (p.description) {\r\n        zodSchema[key] = zodSchema[key].describe(p.description);\r\n      }\r\n    }\r\n\r\n    return zodSchema;\r\n  }\r\n\r\n  /**\r\n   * Get SDK server config for use in query() options\r\n   */\r\n  getSdkServerConfig(): McpSdkServerConfigWithInstance | undefined {\r\n    return this.sdkServer;\r\n  }\r\n\r\n  /**\r\n   * Get in-process server instance\r\n   */\r\n  getInProcessServer(): InProcessMCPServer | undefined {\r\n    return this.inProcessServer;\r\n  }\r\n\r\n  /**\r\n   * Get tool by name\r\n   */\r\n  getTool(name: string): MCPTool | undefined {\r\n    return this.tools.get(name);\r\n  }\r\n\r\n  /**\r\n   * Get all tool names\r\n   */\r\n  getToolNames(): string[] {\r\n    return Array.from(this.tools.keys());\r\n  }\r\n\r\n  /**\r\n   * Check if tool should use in-process execution\r\n   */\r\n  shouldUseInProcess(toolName: string): boolean {\r\n    // All Claude-Flow tools use in-process\r\n    return this.tools.has(toolName);\r\n  }\r\n\r\n  /**\r\n   * Route tool call to appropriate transport\r\n   */\r\n  async routeToolCall(\r\n    toolName: string,\r\n    args: Record<string, unknown>,\r\n    context?: any\r\n  ): Promise<any> {\r\n    const startTime = performance.now();\r\n\r\n    try {\r\n      if (this.shouldUseInProcess(toolName) && this.inProcessServer) {\r\n        logger.debug('Routing to in-process server', { toolName });\r\n        const result = await this.inProcessServer.callTool(toolName, args, context);\r\n        const duration = performance.now() - startTime;\r\n\r\n        logger.info('In-process tool call completed', {\r\n          toolName,\r\n          duration: `${duration.toFixed(2)}ms`,\r\n          transport: 'in-process',\r\n        });\r\n\r\n        return result;\r\n      }\r\n\r\n      // External tools would use stdio/SSE (not implemented in this phase)\r\n      logger.warn('Tool not found in in-process registry', { toolName });\r\n      throw new Error(`Tool not available: ${toolName}`);\r\n    } catch (error) {\r\n      logger.error('Tool routing failed', { toolName, error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get performance metrics\r\n   */\r\n  getMetrics() {\r\n    if (!this.inProcessServer) {\r\n      return { error: 'In-process server not initialized' };\r\n    }\r\n\r\n    const stats = this.inProcessServer.getStats();\r\n    const metrics = this.inProcessServer.getMetrics();\r\n\r\n    return {\r\n      stats,\r\n      recentMetrics: metrics.slice(-10), // Last 10 calls\r\n      summary: {\r\n        totalCalls: metrics.length,\r\n        averageLatency: stats.averageDuration,\r\n        cacheHitRate: stats.cacheHitRate,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get performance comparison (in-process vs IPC)\r\n   */\r\n  getPerformanceComparison() {\r\n    const metrics = this.getMetrics();\r\n\r\n    if ('error' in metrics) {\r\n      return metrics;\r\n    }\r\n\r\n    const avgInProcessLatency = metrics.stats.averageDuration;\r\n\r\n    // Estimated IPC latency (based on typical MCP stdio overhead)\r\n    const estimatedIPCLatency = avgInProcessLatency * 50; // 50x overhead estimate\r\n\r\n    return {\r\n      inProcessLatency: `${avgInProcessLatency.toFixed(2)}ms`,\r\n      estimatedIPCLatency: `${estimatedIPCLatency.toFixed(2)}ms`,\r\n      speedupFactor: `${(estimatedIPCLatency / avgInProcessLatency).toFixed(1)}x`,\r\n      recommendation: 'Use in-process for all Claude-Flow tools for maximum performance',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  async cleanup(): Promise<void> {\r\n    if (this.inProcessServer) {\r\n      this.inProcessServer.clearCache();\r\n      this.inProcessServer.clearMetrics();\r\n    }\r\n\r\n    this.tools.clear();\r\n    logger.info('Tool registry cleaned up');\r\n  }\r\n}\r\n\r\n/**\r\n * Create a global tool registry instance\r\n */\r\nexport async function createToolRegistry(\r\n  config: ToolRegistryConfig\r\n): Promise<ClaudeFlowToolRegistry> {\r\n  const registry = new ClaudeFlowToolRegistry(config);\r\n  await registry.initialize();\r\n  return registry;\r\n}\r\n\r\n/**\r\n * Export SDK server creation helper\r\n */\r\nexport async function createClaudeFlowSdkServer(\r\n  orchestratorContext?: any\r\n): Promise<McpSdkServerConfigWithInstance> {\r\n  const registry = await createToolRegistry({\r\n    enableInProcess: true,\r\n    enableMetrics: true,\r\n    enableCaching: true,\r\n    orchestratorContext,\r\n  });\r\n\r\n  const sdkServer = registry.getSdkServerConfig();\r\n  if (!sdkServer) {\r\n    throw new Error('Failed to create SDK server');\r\n  }\r\n\r\n  return sdkServer;\r\n}"],"names":["createInProcessServer","createClaudeFlowTools","logger","tool","createSdkMcpServer","z","ClaudeFlowToolRegistry","inProcessServer","sdkServer","tools","config","Map","info","enableInProcess","enableMetrics","initialize","claudeFlowTools","set","name","size","version","enableCaching","registerTool","orchestratorContext","setContext","orchestrator","sessionId","createSdkServer","toolCount","getToolNames","length","Error","sdkTools","Array","from","values","map","convertToSdkTool","mcpTool","zodSchema","jsonSchemaToZod","inputSchema","description","args","extra","callTool","result","handler","content","type","text","JSON","stringify","isError","schema","properties","key","prop","Object","entries","p","enum","string","default","undefined","required","includes","optional","number","boolean","array","any","record","describe","getSdkServerConfig","getInProcessServer","getTool","get","keys","shouldUseInProcess","toolName","has","routeToolCall","context","startTime","performance","now","debug","duration","toFixed","transport","warn","error","getMetrics","stats","getStats","metrics","recentMetrics","slice","summary","totalCalls","averageLatency","averageDuration","cacheHitRate","getPerformanceComparison","avgInProcessLatency","estimatedIPCLatency","inProcessLatency","speedupFactor","recommendation","cleanup","clearCache","clearMetrics","clear","createToolRegistry","registry","createClaudeFlowSdkServer"],"mappings":"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"}
{
  "version": 3,
  "sources": ["../../src/memory/cache.ts"],
  "sourcesContent": ["/**\n * Memory cache implementation with LRU eviction\n */\n\nimport type { MemoryEntry } from '../utils/types.js';\nimport type { ILogger } from '../core/logger.js';\n\ninterface CacheEntry {\n  data: MemoryEntry;\n  size: number;\n  lastAccessed: number;\n  dirty: boolean;\n}\n\n/**\n * LRU cache for memory entries\n */\nexport class MemoryCache {\n  private cache = new Map<string, CacheEntry>();\n  private currentSize = 0;\n  private hits = 0;\n  private misses = 0;\n\n  constructor(\n    private maxSize: number,\n    private logger: ILogger,\n  ) {}\n\n  /**\n   * Gets an entry from the cache\n   */\n  get(id: string): MemoryEntry | undefined {\n    const entry = this.cache.get(id);\n\n    if (!entry) {\n      this.misses++;\n      return undefined;\n    }\n\n    // Update access time\n    entry.lastAccessed = Date.now();\n    this.hits++;\n\n    return entry.data;\n  }\n\n  /**\n   * Sets an entry in the cache\n   */\n  set(id: string, data: MemoryEntry, dirty = true): void {\n    const size = this.calculateSize(data);\n\n    // Check if we need to evict entries\n    if (this.currentSize + size > this.maxSize) {\n      this.evict(size);\n    }\n\n    const entry: CacheEntry = {\n      data,\n      size,\n      lastAccessed: Date.now(),\n      dirty,\n    };\n\n    // Update size if replacing existing entry\n    const existing = this.cache.get(id);\n    if (existing) {\n      this.currentSize -= existing.size;\n    }\n\n    this.cache.set(id, entry);\n    this.currentSize += size;\n  }\n\n  /**\n   * Deletes an entry from the cache\n   */\n  delete(id: string): void {\n    const entry = this.cache.get(id);\n    if (entry) {\n      this.currentSize -= entry.size;\n      this.cache.delete(id);\n    }\n  }\n\n  /**\n   * Gets entries by prefix\n   */\n  getByPrefix(prefix: string): MemoryEntry[] {\n    const results: MemoryEntry[] = [];\n\n    for (const [id, entry] of this.cache) {\n      if (id.startsWith(prefix)) {\n        entry.lastAccessed = Date.now();\n        results.push(entry.data);\n      }\n    }\n\n    return results;\n  }\n\n  /**\n   * Gets all dirty entries\n   */\n  getDirtyEntries(): MemoryEntry[] {\n    const dirtyEntries: MemoryEntry[] = [];\n\n    for (const entry of this.cache.values()) {\n      if (entry.dirty) {\n        dirtyEntries.push(entry.data);\n      }\n    }\n\n    return dirtyEntries;\n  }\n\n  /**\n   * Marks entries as clean\n   */\n  markClean(ids: string[]): void {\n    for (const id of ids) {\n      const entry = this.cache.get(id);\n      if (entry) {\n        entry.dirty = false;\n      }\n    }\n  }\n\n  /**\n   * Gets all entries\n   */\n  getAllEntries(): MemoryEntry[] {\n    return Array.from(this.cache.values()).map((entry) => entry.data);\n  }\n\n  /**\n   * Gets cache metrics\n   */\n  getMetrics(): {\n    size: number;\n    entries: number;\n    hitRate: number;\n    maxSize: number;\n  } {\n    const totalRequests = this.hits + this.misses;\n    const hitRate = totalRequests > 0 ? this.hits / totalRequests : 0;\n\n    return {\n      size: this.currentSize,\n      entries: this.cache.size,\n      hitRate,\n      maxSize: this.maxSize,\n    };\n  }\n\n  /**\n   * Clears the cache\n   */\n  clear(): void {\n    this.cache.clear();\n    this.currentSize = 0;\n    this.hits = 0;\n    this.misses = 0;\n  }\n\n  /**\n   * Performs cache maintenance\n   */\n  performMaintenance(): void {\n    // Remove expired entries if needed\n    // For now, just log metrics\n    const metrics = this.getMetrics();\n    this.logger.debug('Cache maintenance', metrics);\n  }\n\n  private calculateSize(entry: MemoryEntry): number {\n    // Rough estimate of memory size\n    let size = 0;\n\n    // String fields\n    size += entry.id.length * 2; // UTF-16\n    size += entry.agentId.length * 2;\n    size += entry.sessionId.length * 2;\n    size += entry.type.length * 2;\n    size += entry.content.length * 2;\n\n    // Tags\n    size += entry.tags.reduce((sum, tag) => sum + tag.length * 2, 0);\n\n    // JSON objects (rough estimate)\n    size += JSON.stringify(entry.context).length * 2;\n    if (entry.metadata) {\n      size += JSON.stringify(entry.metadata).length * 2;\n    }\n\n    // Fixed size fields\n    size += 8; // timestamp\n    size += 4; // version\n    size += 100; // overhead\n\n    return size;\n  }\n\n  private evict(requiredSpace: number): void {\n    this.logger.debug('Cache eviction triggered', {\n      requiredSpace,\n      currentSize: this.currentSize,\n    });\n\n    // Sort entries by last accessed time (oldest first)\n    const entries = Array.from(this.cache.entries()).sort(\n      (a, b) => a[1].lastAccessed - b[1].lastAccessed,\n    );\n\n    let freedSpace = 0;\n    const evicted: string[] = [];\n\n    for (const [id, entry] of entries) {\n      if (freedSpace >= requiredSpace) {\n        break;\n      }\n\n      // Don't evict dirty entries if possible\n      if (entry.dirty && evicted.length > 0) {\n        continue;\n      }\n\n      this.cache.delete(id);\n      this.currentSize -= entry.size;\n      freedSpace += entry.size;\n      evicted.push(id);\n    }\n\n    this.logger.debug('Cache entries evicted', {\n      count: evicted.length,\n      freedSpace,\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

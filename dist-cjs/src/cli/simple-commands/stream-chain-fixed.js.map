{"version":3,"sources":["../../../../src/cli/simple-commands/stream-chain-fixed.js"],"sourcesContent":["/**\r\n * Execute a single step in the stream chain\r\n */\r\nasync function executeStreamStep(prompt, inputStream, isLast, flags = {}) {\r\n  return new Promise((resolve) => {\r\n    const startTime = Date.now();\r\n    let resolved = false; // Prevent double resolution\r\n    \r\n    const safeResolve = (result) => {\r\n      if (!resolved) {\r\n        resolved = true;\r\n        resolve(result);\r\n      }\r\n    };\r\n    \r\n    // Check if we should use mock mode\r\n    const useMock = flags.mock || !checkClaudeAvailable();\r\n    \r\n    if (useMock) {\r\n      // Mock implementation when claude CLI isn't available or mock flag is set\r\n      return mockStreamStep(prompt, inputStream, isLast, flags, safeResolve, startTime);\r\n    }\r\n    \r\n    // Set a reasonable timeout for real Claude CLI (15 seconds - more realistic)\r\n    const stepTimeout = flags.timeout ? parseInt(flags.timeout) * 1000 : 15000;\r\n    \r\n    // Build command arguments\r\n    const args = ['-p'];\r\n    \r\n    // For now, avoid stream-json input chaining due to format complexity\r\n    // Each step runs independently for better reliability\r\n    if (!isLast || flags.json) {\r\n      args.push('--output-format', 'stream-json');\r\n      // stream-json output requires --verbose\r\n      args.push('--verbose');\r\n    }\r\n    \r\n    // Add the prompt\r\n    args.push(prompt);\r\n\r\n    if (flags.verbose) {\r\n      console.log(`   Debug: Executing: claude ${args.join(' ')}`);\r\n    }\r\n\r\n    // Use exec with built-in timeout for better reliability\r\n    const command = `claude ${args.join(' ')}`;\r\n    \r\n    exec(command, { \r\n      timeout: stepTimeout,\r\n      maxBuffer: 1024 * 1024 * 10 // 10MB buffer\r\n    }, (error, stdout, stderr) => {\r\n      if (resolved) {\r\n        return; // Already resolved\r\n      }\r\n      \r\n      const duration = Date.now() - startTime;\r\n      \r\n      if (error && error.code === 'TIMEOUT') {\r\n        // Handle timeout via exec\r\n        console.log('⚠️  Claude CLI timed out, falling back to mock mode...');\r\n        mockStreamStep(prompt, inputStream, isLast, { ...flags, mock: true }, safeResolve, Date.now());\r\n        return;\r\n      }\r\n      \r\n      if (flags.verbose && stderr) {\r\n        console.error('Error output:', stderr);\r\n      }\r\n      \r\n      safeResolve({\r\n        success: !error || error.code === 0,\r\n        duration,\r\n        output: stdout || '',\r\n        stream: (!isLast && stdout) ? stdout : null,\r\n        error: stderr || (error ? error.message : null)\r\n      });\r\n    });\r\n  });\r\n}"],"names":["executeStreamStep","prompt","inputStream","isLast","flags","Promise","resolve","startTime","Date","now","resolved","safeResolve","result","useMock","mock","checkClaudeAvailable","mockStreamStep","stepTimeout","timeout","parseInt","args","json","push","verbose","console","log","join","command","exec","maxBuffer","error","stdout","stderr","duration","code","success","output","stream","message"],"mappings":"AAGA,eAAeA,kBAAkBC,MAAM,EAAEC,WAAW,EAAEC,MAAM,EAAEC,QAAQ,CAAC,CAAC;IACtE,OAAO,IAAIC,QAAQ,CAACC;QAClB,MAAMC,YAAYC,KAAKC,GAAG;QAC1B,IAAIC,WAAW;QAEf,MAAMC,cAAc,CAACC;YACnB,IAAI,CAACF,UAAU;gBACbA,WAAW;gBACXJ,QAAQM;YACV;QACF;QAGA,MAAMC,UAAUT,MAAMU,IAAI,IAAI,CAACC;QAE/B,IAAIF,SAAS;YAEX,OAAOG,eAAef,QAAQC,aAAaC,QAAQC,OAAOO,aAAaJ;QACzE;QAGA,MAAMU,cAAcb,MAAMc,OAAO,GAAGC,SAASf,MAAMc,OAAO,IAAI,OAAO;QAGrE,MAAME,OAAO;YAAC;SAAK;QAInB,IAAI,CAACjB,UAAUC,MAAMiB,IAAI,EAAE;YACzBD,KAAKE,IAAI,CAAC,mBAAmB;YAE7BF,KAAKE,IAAI,CAAC;QACZ;QAGAF,KAAKE,IAAI,CAACrB;QAEV,IAAIG,MAAMmB,OAAO,EAAE;YACjBC,QAAQC,GAAG,CAAC,CAAC,4BAA4B,EAAEL,KAAKM,IAAI,CAAC,MAAM;QAC7D;QAGA,MAAMC,UAAU,CAAC,OAAO,EAAEP,KAAKM,IAAI,CAAC,MAAM;QAE1CE,KAAKD,SAAS;YACZT,SAASD;YACTY,WAAW,OAAO,OAAO;QAC3B,GAAG,CAACC,OAAOC,QAAQC;YACjB,IAAItB,UAAU;gBACZ;YACF;YAEA,MAAMuB,WAAWzB,KAAKC,GAAG,KAAKF;YAE9B,IAAIuB,SAASA,MAAMI,IAAI,KAAK,WAAW;gBAErCV,QAAQC,GAAG,CAAC;gBACZT,eAAef,QAAQC,aAAaC,QAAQ;oBAAE,GAAGC,KAAK;oBAAEU,MAAM;gBAAK,GAAGH,aAAaH,KAAKC,GAAG;gBAC3F;YACF;YAEA,IAAIL,MAAMmB,OAAO,IAAIS,QAAQ;gBAC3BR,QAAQM,KAAK,CAAC,iBAAiBE;YACjC;YAEArB,YAAY;gBACVwB,SAAS,CAACL,SAASA,MAAMI,IAAI,KAAK;gBAClCD;gBACAG,QAAQL,UAAU;gBAClBM,QAAQ,AAAC,CAAClC,UAAU4B,SAAUA,SAAS;gBACvCD,OAAOE,UAAWF,CAAAA,QAAQA,MAAMQ,OAAO,GAAG,IAAG;YAC/C;QACF;IACF;AACF"}
{"version":3,"sources":["../../../src/mcp/sdk-integration.ts"],"sourcesContent":["/**\r\n * SDK Integration Layer for In-Process MCP Server\r\n *\r\n * Provides seamless integration between Claude Code SDK and Claude-Flow's\r\n * in-process MCP server for 10-100x performance improvement.\r\n */\r\n\r\nimport { query, type Query, type Options } from '@anthropic-ai/claude-code/sdk';\r\nimport { createClaudeFlowSdkServer, ClaudeFlowToolRegistry } from './tool-registry.js';\r\nimport type { McpSdkServerConfigWithInstance } from '@anthropic-ai/claude-code/sdk.d.ts';\r\nimport { logger } from '../core/logger.js';\r\n\r\nexport interface SDKIntegrationConfig {\r\n  enableInProcess: boolean;\r\n  enableMetrics: boolean;\r\n  enableCaching: boolean;\r\n  orchestratorContext?: any;\r\n  fallbackToStdio?: boolean;\r\n}\r\n\r\n/**\r\n * SDK Integration Manager\r\n * Manages in-process MCP server and SDK query integration\r\n */\r\nexport class SDKIntegration {\r\n  private sdkServer?: McpSdkServerConfigWithInstance;\r\n  private registry?: ClaudeFlowToolRegistry;\r\n  private config: SDKIntegrationConfig;\r\n\r\n  constructor(config: SDKIntegrationConfig) {\r\n    this.config = {\r\n      fallbackToStdio: true,\r\n      ...config,\r\n    };\r\n\r\n    logger.info('SDKIntegration initialized', {\r\n      enableInProcess: config.enableInProcess,\r\n      enableMetrics: config.enableMetrics,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initialize SDK integration with in-process server\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (!this.config.enableInProcess) {\r\n      logger.info('In-process MCP server disabled, using stdio fallback');\r\n      return;\r\n    }\r\n\r\n    logger.info('Initializing in-process MCP server...');\r\n\r\n    try {\r\n      // Create SDK server with all Claude-Flow tools\r\n      this.sdkServer = await createClaudeFlowSdkServer(this.config.orchestratorContext);\r\n\r\n      logger.info('In-process MCP server initialized successfully', {\r\n        serverName: this.sdkServer.name,\r\n        transport: 'in-process',\r\n      });\r\n    } catch (error) {\r\n      logger.error('Failed to initialize in-process MCP server', { error });\r\n\r\n      if (!this.config.fallbackToStdio) {\r\n        throw error;\r\n      }\r\n\r\n      logger.warn('Falling back to stdio transport');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create SDK query with in-process MCP server\r\n   */\r\n  query(prompt: string, options?: Partial<Options>): Query {\r\n    const queryOptions: Options = {\r\n      ...options,\r\n    };\r\n\r\n    // Add in-process MCP server if available\r\n    if (this.sdkServer) {\r\n      queryOptions.mcpServers = {\r\n        ...queryOptions.mcpServers,\r\n        'claude-flow': this.sdkServer,\r\n      };\r\n\r\n      logger.debug('Query created with in-process MCP server', {\r\n        mcpServers: Object.keys(queryOptions.mcpServers || {}),\r\n      });\r\n    } else {\r\n      logger.debug('Query created without in-process server (fallback mode)');\r\n    }\r\n\r\n    return query({ prompt, options: queryOptions });\r\n  }\r\n\r\n  /**\r\n   * Create SDK query for agent with in-process tools\r\n   */\r\n  async queryAgent(\r\n    agentId: string,\r\n    prompt: string,\r\n    options?: Partial<Options>\r\n  ): Promise<Query> {\r\n    const queryOptions: Options = {\r\n      ...options,\r\n      mcpServers: {\r\n        ...options?.mcpServers,\r\n      },\r\n    };\r\n\r\n    // Add in-process server\r\n    if (this.sdkServer) {\r\n      queryOptions.mcpServers!['claude-flow'] = this.sdkServer;\r\n    }\r\n\r\n    // Create agent-specific context\r\n    if (this.config.orchestratorContext) {\r\n      logger.debug('Creating agent query with orchestrator context', { agentId });\r\n    }\r\n\r\n    return query({ prompt, options: queryOptions });\r\n  }\r\n\r\n  /**\r\n   * Get SDK server config for direct use\r\n   */\r\n  getSdkServer(): McpSdkServerConfigWithInstance | undefined {\r\n    return this.sdkServer;\r\n  }\r\n\r\n  /**\r\n   * Check if in-process server is available\r\n   */\r\n  isInProcessAvailable(): boolean {\r\n    return this.sdkServer !== undefined;\r\n  }\r\n\r\n  /**\r\n   * Get performance metrics\r\n   */\r\n  getMetrics() {\r\n    if (!this.registry) {\r\n      return { error: 'Tool registry not available' };\r\n    }\r\n\r\n    return this.registry.getMetrics();\r\n  }\r\n\r\n  /**\r\n   * Get performance comparison\r\n   */\r\n  getPerformanceComparison() {\r\n    if (!this.registry) {\r\n      return { error: 'Tool registry not available' };\r\n    }\r\n\r\n    return this.registry.getPerformanceComparison();\r\n  }\r\n\r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  async cleanup(): Promise<void> {\r\n    if (this.registry) {\r\n      await this.registry.cleanup();\r\n    }\r\n\r\n    this.sdkServer = undefined;\r\n    logger.info('SDK integration cleaned up');\r\n  }\r\n}\r\n\r\n/**\r\n * Global SDK integration instance\r\n */\r\nlet globalIntegration: SDKIntegration | undefined;\r\n\r\n/**\r\n * Initialize global SDK integration\r\n */\r\nexport async function initializeSDKIntegration(\r\n  config: SDKIntegrationConfig\r\n): Promise<SDKIntegration> {\r\n  if (globalIntegration) {\r\n    logger.warn('SDK integration already initialized, returning existing instance');\r\n    return globalIntegration;\r\n  }\r\n\r\n  globalIntegration = new SDKIntegration(config);\r\n  await globalIntegration.initialize();\r\n\r\n  return globalIntegration;\r\n}\r\n\r\n/**\r\n * Get global SDK integration instance\r\n */\r\nexport function getSDKIntegration(): SDKIntegration | undefined {\r\n  return globalIntegration;\r\n}\r\n\r\n/**\r\n * Create a query with in-process MCP server\r\n * Convenience function for direct use\r\n */\r\nexport async function createInProcessQuery(\r\n  prompt: string,\r\n  options?: Partial<Options>,\r\n  orchestratorContext?: any\r\n): Promise<Query> {\r\n  // Initialize if not already done\r\n  if (!globalIntegration) {\r\n    await initializeSDKIntegration({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n      orchestratorContext,\r\n    });\r\n  }\r\n\r\n  return globalIntegration!.query(prompt, options);\r\n}\r\n\r\n/**\r\n * Get in-process MCP server config for use in SDK queries\r\n */\r\nexport async function getInProcessServerConfig(\r\n  orchestratorContext?: any\r\n): Promise<McpSdkServerConfigWithInstance> {\r\n  // Initialize if needed\r\n  if (!globalIntegration) {\r\n    await initializeSDKIntegration({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n      orchestratorContext,\r\n    });\r\n  }\r\n\r\n  const server = globalIntegration?.getSdkServer();\r\n  if (!server) {\r\n    throw new Error('In-process MCP server not available');\r\n  }\r\n\r\n  return server;\r\n}\r\n\r\n/**\r\n * Measure performance difference between in-process and IPC\r\n */\r\nexport async function measurePerformance(\r\n  toolName: string,\r\n  args: Record<string, unknown>,\r\n  iterations: number = 10\r\n): Promise<{\r\n  inProcessAvg: number;\r\n  inProcessMin: number;\r\n  inProcessMax: number;\r\n  estimatedIPCAvg: number;\r\n  speedupFactor: number;\r\n}> {\r\n  if (!globalIntegration || !globalIntegration.isInProcessAvailable()) {\r\n    throw new Error('In-process server not available for performance testing');\r\n  }\r\n\r\n  const durations: number[] = [];\r\n\r\n  logger.info('Starting performance measurement', { toolName, iterations });\r\n\r\n  for (let i = 0; i < iterations; i++) {\r\n    const start = performance.now();\r\n\r\n    // Execute via in-process (through SDK integration)\r\n    const query = globalIntegration.query(`Execute tool: ${toolName}`, {\r\n      allowedTools: [toolName],\r\n    });\r\n\r\n    // Wait for completion\r\n    for await (const message of query) {\r\n      if (message.type === 'result') {\r\n        break;\r\n      }\r\n    }\r\n\r\n    const duration = performance.now() - start;\r\n    durations.push(duration);\r\n  }\r\n\r\n  const inProcessAvg = durations.reduce((a, b) => a + b, 0) / durations.length;\r\n  const inProcessMin = Math.min(...durations);\r\n  const inProcessMax = Math.max(...durations);\r\n\r\n  // Estimate IPC overhead (based on typical stdio/SSE latency)\r\n  // Conservative estimate: 50x slower for IPC due to serialization, process spawning, etc.\r\n  const estimatedIPCAvg = inProcessAvg * 50;\r\n  const speedupFactor = estimatedIPCAvg / inProcessAvg;\r\n\r\n  logger.info('Performance measurement complete', {\r\n    toolName,\r\n    inProcessAvg: `${inProcessAvg.toFixed(2)}ms`,\r\n    estimatedIPCAvg: `${estimatedIPCAvg.toFixed(2)}ms`,\r\n    speedupFactor: `${speedupFactor.toFixed(1)}x`,\r\n  });\r\n\r\n  return {\r\n    inProcessAvg,\r\n    inProcessMin,\r\n    inProcessMax,\r\n    estimatedIPCAvg,\r\n    speedupFactor,\r\n  };\r\n}"],"names":["query","createClaudeFlowSdkServer","logger","SDKIntegration","sdkServer","registry","config","fallbackToStdio","info","enableInProcess","enableMetrics","initialize","orchestratorContext","serverName","name","transport","error","warn","prompt","options","queryOptions","mcpServers","debug","Object","keys","queryAgent","agentId","getSdkServer","isInProcessAvailable","undefined","getMetrics","getPerformanceComparison","cleanup","globalIntegration","initializeSDKIntegration","getSDKIntegration","createInProcessQuery","enableCaching","getInProcessServerConfig","server","Error","measurePerformance","toolName","args","iterations","durations","i","start","performance","now","allowedTools","message","type","duration","push","inProcessAvg","reduce","a","b","length","inProcessMin","Math","min","inProcessMax","max","estimatedIPCAvg","speedupFactor","toFixed"],"mappings":"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"}
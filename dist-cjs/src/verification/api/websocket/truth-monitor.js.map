{"version":3,"sources":["../../../../../src/verification/api/websocket/truth-monitor.js"],"sourcesContent":["/**\r\n * WebSocket Truth Monitoring Server\r\n * Real-time verification and truth monitoring via WebSocket\r\n * \r\n * Following patterns from existing WebSocket implementation in analysis.js\r\n */\r\n\r\nconst WebSocket = require('ws');\r\nconst { nanoid } = require('nanoid');\r\nconst EventEmitter = require('events');\r\n\r\nclass TruthMonitoringServer extends EventEmitter {\r\n  constructor(options = {}) {\r\n    super();\r\n    this.port = options.port || 8080;\r\n    this.server = null;\r\n    this.clients = new Map();\r\n    this.subscriptions = new Map();\r\n    this.heartbeatInterval = options.heartbeatInterval || 30000;\r\n    this.messageBuffer = [];\r\n    this.maxBufferSize = options.maxBufferSize || 1000;\r\n    \r\n    this.setupEventHandlers();\r\n  }\r\n  \r\n  start() {\r\n    this.server = new WebSocket.Server({ port: this.port });\r\n    \r\n    this.server.on('connection', (ws, req) => {\r\n      this.handleConnection(ws, req);\r\n    });\r\n    \r\n    this.server.on('error', (error) => {\r\n      console.error('WebSocket server error:', error);\r\n      this.emit('error', error);\r\n    });\r\n    \r\n    // Start heartbeat interval\r\n    this.startHeartbeat();\r\n    \r\n    console.log(`Truth monitoring WebSocket server started on port ${this.port}`);\r\n    this.emit('started', { port: this.port });\r\n  }\r\n  \r\n  stop() {\r\n    if (this.heartbeatTimer) {\r\n      clearInterval(this.heartbeatTimer);\r\n    }\r\n    \r\n    if (this.server) {\r\n      this.server.close(() => {\r\n        console.log('Truth monitoring WebSocket server stopped');\r\n        this.emit('stopped');\r\n      });\r\n    }\r\n  }\r\n  \r\n  handleConnection(ws, req) {\r\n    const clientId = nanoid();\r\n    const clientInfo = {\r\n      id: clientId,\r\n      ws,\r\n      ip: req.socket.remoteAddress,\r\n      userAgent: req.headers['user-agent'],\r\n      connectedAt: Date.now(),\r\n      subscriptions: new Set(),\r\n      lastHeartbeat: Date.now(),\r\n    };\r\n    \r\n    this.clients.set(clientId, clientInfo);\r\n    \r\n    console.log(`Truth monitoring client connected: ${clientId}`);\r\n    \r\n    // Send welcome message\r\n    this.sendMessage(ws, {\r\n      type: 'connected',\r\n      payload: {\r\n        client_id: clientId,\r\n        server_time: Date.now(),\r\n        available_events: this.getAvailableEventTypes(),\r\n      },\r\n    });\r\n    \r\n    // Send buffered messages if any\r\n    this.sendBufferedMessages(ws);\r\n    \r\n    ws.on('message', (data) => {\r\n      try {\r\n        const message = JSON.parse(data);\r\n        this.handleMessage(clientId, message);\r\n      } catch (error) {\r\n        console.error('Invalid message format:', error);\r\n        this.sendError(ws, 'INVALID_MESSAGE_FORMAT', 'Message must be valid JSON');\r\n      }\r\n    });\r\n    \r\n    ws.on('close', () => {\r\n      this.handleDisconnection(clientId);\r\n    });\r\n    \r\n    ws.on('error', (error) => {\r\n      console.error(`Client ${clientId} error:`, error);\r\n      this.handleDisconnection(clientId);\r\n    });\r\n    \r\n    ws.on('pong', () => {\r\n      if (this.clients.has(clientId)) {\r\n        this.clients.get(clientId).lastHeartbeat = Date.now();\r\n      }\r\n    });\r\n    \r\n    this.emit('client_connected', { clientId, clientInfo });\r\n  }\r\n  \r\n  handleDisconnection(clientId) {\r\n    const client = this.clients.get(clientId);\r\n    if (client) {\r\n      // Clean up subscriptions\r\n      client.subscriptions.forEach(subscriptionId => {\r\n        this.removeSubscription(subscriptionId);\r\n      });\r\n      \r\n      this.clients.delete(clientId);\r\n      console.log(`Truth monitoring client disconnected: ${clientId}`);\r\n      this.emit('client_disconnected', { clientId });\r\n    }\r\n  }\r\n  \r\n  handleMessage(clientId, message) {\r\n    const client = this.clients.get(clientId);\r\n    if (!client) return;\r\n    \r\n    switch (message.type) {\r\n      case 'subscribe':\r\n        this.handleSubscribe(clientId, message);\r\n        break;\r\n        \r\n      case 'unsubscribe':\r\n        this.handleUnsubscribe(clientId, message);\r\n        break;\r\n        \r\n      case 'heartbeat':\r\n        this.handleHeartbeat(clientId, message);\r\n        break;\r\n        \r\n      case 'get_status':\r\n        this.handleGetStatus(clientId, message);\r\n        break;\r\n        \r\n      case 'get_metrics':\r\n        this.handleGetMetrics(clientId, message);\r\n        break;\r\n        \r\n      default:\r\n        this.sendError(client.ws, 'UNKNOWN_MESSAGE_TYPE', `Unknown message type: ${message.type}`);\r\n    }\r\n  }\r\n  \r\n  handleSubscribe(clientId, message) {\r\n    const client = this.clients.get(clientId);\r\n    if (!client) return;\r\n    \r\n    const { payload } = message;\r\n    const subscriptionId = nanoid();\r\n    \r\n    const subscription = {\r\n      id: subscriptionId,\r\n      clientId,\r\n      filter: this.validateSubscriptionFilter(payload.filter),\r\n      createdAt: Date.now(),\r\n    };\r\n    \r\n    this.subscriptions.set(subscriptionId, subscription);\r\n    client.subscriptions.add(subscriptionId);\r\n    \r\n    this.sendMessage(client.ws, {\r\n      type: 'subscription_created',\r\n      payload: {\r\n        subscription_id: subscriptionId,\r\n        filter: subscription.filter,\r\n      },\r\n      id: message.id,\r\n    });\r\n    \r\n    console.log(`Client ${clientId} subscribed with filter:`, subscription.filter);\r\n  }\r\n  \r\n  handleUnsubscribe(clientId, message) {\r\n    const client = this.clients.get(clientId);\r\n    if (!client) return;\r\n    \r\n    const { subscription_id } = message.payload;\r\n    \r\n    if (this.removeSubscription(subscription_id)) {\r\n      client.subscriptions.delete(subscription_id);\r\n      \r\n      this.sendMessage(client.ws, {\r\n        type: 'subscription_removed',\r\n        payload: {\r\n          subscription_id,\r\n        },\r\n        id: message.id,\r\n      });\r\n      \r\n      console.log(`Client ${clientId} unsubscribed from ${subscription_id}`);\r\n    } else {\r\n      this.sendError(client.ws, 'SUBSCRIPTION_NOT_FOUND', `Subscription ${subscription_id} not found`);\r\n    }\r\n  }\r\n  \r\n  handleHeartbeat(clientId, message) {\r\n    const client = this.clients.get(clientId);\r\n    if (!client) return;\r\n    \r\n    client.lastHeartbeat = Date.now();\r\n    \r\n    this.sendMessage(client.ws, {\r\n      type: 'heartbeat_ack',\r\n      payload: {\r\n        server_time: Date.now(),\r\n      },\r\n      id: message.id,\r\n    });\r\n  }\r\n  \r\n  handleGetStatus(clientId, message) {\r\n    const client = this.clients.get(clientId);\r\n    if (!client) return;\r\n    \r\n    const status = {\r\n      server_uptime: Date.now() - this.startTime,\r\n      connected_clients: this.clients.size,\r\n      active_subscriptions: this.subscriptions.size,\r\n      message_buffer_size: this.messageBuffer.length,\r\n      server_time: Date.now(),\r\n    };\r\n    \r\n    this.sendMessage(client.ws, {\r\n      type: 'status_response',\r\n      payload: status,\r\n      id: message.id,\r\n    });\r\n  }\r\n  \r\n  handleGetMetrics(clientId, message) {\r\n    const client = this.clients.get(clientId);\r\n    if (!client) return;\r\n    \r\n    const metrics = this.calculateServerMetrics();\r\n    \r\n    this.sendMessage(client.ws, {\r\n      type: 'metrics_response',\r\n      payload: metrics,\r\n      id: message.id,\r\n    });\r\n  }\r\n  \r\n  // Broadcast truth monitoring events\r\n  broadcastTruthEvent(event) {\r\n    const truthEvent = {\r\n      id: nanoid(),\r\n      type: event.type || 'truth_change',\r\n      timestamp: Date.now(),\r\n      data: event.data,\r\n      severity: event.severity || 'medium',\r\n      source: event.source,\r\n      confidence: event.confidence,\r\n      metadata: event.metadata || {},\r\n    };\r\n    \r\n    // Add to message buffer\r\n    this.addToBuffer(truthEvent);\r\n    \r\n    // Find matching subscriptions\r\n    const matchingSubscriptions = Array.from(this.subscriptions.values())\r\n      .filter(sub => this.eventMatchesFilter(truthEvent, sub.filter));\r\n    \r\n    // Send to subscribed clients\r\n    matchingSubscriptions.forEach(subscription => {\r\n      const client = this.clients.get(subscription.clientId);\r\n      if (client && client.ws.readyState === WebSocket.OPEN) {\r\n        this.sendMessage(client.ws, {\r\n          type: 'truth_event',\r\n          payload: truthEvent,\r\n        });\r\n      }\r\n    });\r\n    \r\n    this.emit('truth_event_broadcast', { event: truthEvent, subscribers: matchingSubscriptions.length });\r\n  }\r\n  \r\n  // Broadcast verification updates\r\n  broadcastVerificationUpdate(verification) {\r\n    const event = {\r\n      id: nanoid(),\r\n      type: 'verification_update',\r\n      timestamp: Date.now(),\r\n      data: verification,\r\n      severity: verification.status === 'failed' ? 'high' : 'medium',\r\n      source: verification.source,\r\n      confidence: verification.confidence,\r\n    };\r\n    \r\n    this.broadcastTruthEvent(event);\r\n  }\r\n  \r\n  // Broadcast system alerts\r\n  broadcastAlert(alert) {\r\n    const event = {\r\n      id: nanoid(),\r\n      type: 'system_alert',\r\n      timestamp: Date.now(),\r\n      data: alert,\r\n      severity: alert.severity || 'high',\r\n      source: 'system',\r\n      confidence: 1.0,\r\n    };\r\n    \r\n    this.broadcastTruthEvent(event);\r\n  }\r\n  \r\n  validateSubscriptionFilter(filter = {}) {\r\n    return {\r\n      event_types: Array.isArray(filter.event_types) ? filter.event_types : ['truth_change', 'verification_update', 'system_alert'],\r\n      severity_levels: Array.isArray(filter.severity_levels) ? filter.severity_levels : ['low', 'medium', 'high', 'critical'],\r\n      sources: Array.isArray(filter.sources) ? filter.sources : [],\r\n      targets: Array.isArray(filter.targets) ? filter.targets : [],\r\n      confidence_min: typeof filter.confidence_min === 'number' ? filter.confidence_min : 0,\r\n      confidence_max: typeof filter.confidence_max === 'number' ? filter.confidence_max : 1,\r\n    };\r\n  }\r\n  \r\n  eventMatchesFilter(event, filter) {\r\n    // Check event type\r\n    if (filter.event_types.length > 0 && !filter.event_types.includes(event.type)) {\r\n      return false;\r\n    }\r\n    \r\n    // Check severity\r\n    if (filter.severity_levels.length > 0 && !filter.severity_levels.includes(event.severity)) {\r\n      return false;\r\n    }\r\n    \r\n    // Check source\r\n    if (filter.sources.length > 0 && !filter.sources.includes(event.source)) {\r\n      return false;\r\n    }\r\n    \r\n    // Check confidence range\r\n    if (event.confidence < filter.confidence_min || event.confidence > filter.confidence_max) {\r\n      return false;\r\n    }\r\n    \r\n    return true;\r\n  }\r\n  \r\n  removeSubscription(subscriptionId) {\r\n    return this.subscriptions.delete(subscriptionId);\r\n  }\r\n  \r\n  sendMessage(ws, message) {\r\n    if (ws.readyState === WebSocket.OPEN) {\r\n      try {\r\n        ws.send(JSON.stringify(message));\r\n      } catch (error) {\r\n        console.error('Error sending message:', error);\r\n      }\r\n    }\r\n  }\r\n  \r\n  sendError(ws, code, message) {\r\n    this.sendMessage(ws, {\r\n      type: 'error',\r\n      payload: {\r\n        code,\r\n        message,\r\n        timestamp: Date.now(),\r\n      },\r\n    });\r\n  }\r\n  \r\n  addToBuffer(event) {\r\n    this.messageBuffer.push(event);\r\n    \r\n    // Keep buffer size under limit\r\n    if (this.messageBuffer.length > this.maxBufferSize) {\r\n      this.messageBuffer = this.messageBuffer.slice(-this.maxBufferSize);\r\n    }\r\n  }\r\n  \r\n  sendBufferedMessages(ws) {\r\n    // Send last 10 buffered messages to new clients\r\n    const recentMessages = this.messageBuffer.slice(-10);\r\n    \r\n    recentMessages.forEach(event => {\r\n      this.sendMessage(ws, {\r\n        type: 'truth_event',\r\n        payload: {\r\n          ...event,\r\n          is_historical: true,\r\n        },\r\n      });\r\n    });\r\n  }\r\n  \r\n  startHeartbeat() {\r\n    this.heartbeatTimer = setInterval(() => {\r\n      const now = Date.now();\r\n      \r\n      // Check for stale connections\r\n      this.clients.forEach((client, clientId) => {\r\n        const timeSinceLastHeartbeat = now - client.lastHeartbeat;\r\n        \r\n        if (timeSinceLastHeartbeat > this.heartbeatInterval * 2) {\r\n          // Client is stale, close connection\r\n          console.log(`Closing stale connection: ${clientId}`);\r\n          client.ws.terminate();\r\n          this.handleDisconnection(clientId);\r\n        } else {\r\n          // Send ping\r\n          if (client.ws.readyState === WebSocket.OPEN) {\r\n            client.ws.ping();\r\n          }\r\n        }\r\n      });\r\n    }, this.heartbeatInterval);\r\n  }\r\n  \r\n  calculateServerMetrics() {\r\n    const now = Date.now();\r\n    const clients = Array.from(this.clients.values());\r\n    \r\n    return {\r\n      server_uptime: now - (this.startTime || now),\r\n      connected_clients: clients.length,\r\n      active_subscriptions: this.subscriptions.size,\r\n      message_buffer_size: this.messageBuffer.length,\r\n      client_stats: {\r\n        newest_connection: Math.min(...clients.map(c => now - c.connectedAt)),\r\n        oldest_connection: Math.max(...clients.map(c => now - c.connectedAt)),\r\n        average_connection_age: clients.length > 0 \r\n          ? clients.reduce((sum, c) => sum + (now - c.connectedAt), 0) / clients.length \r\n          : 0,\r\n      },\r\n      subscription_stats: {\r\n        subscriptions_per_client: this.subscriptions.size / Math.max(clients.length, 1),\r\n        most_popular_event_types: this.getMostPopularEventTypes(),\r\n      },\r\n      performance: {\r\n        memory_usage: process.memoryUsage(),\r\n        cpu_usage: process.cpuUsage(),\r\n      },\r\n    };\r\n  }\r\n  \r\n  getMostPopularEventTypes() {\r\n    const eventTypeCounts = {};\r\n    \r\n    this.subscriptions.forEach(sub => {\r\n      sub.filter.event_types.forEach(type => {\r\n        eventTypeCounts[type] = (eventTypeCounts[type] || 0) + 1;\r\n      });\r\n    });\r\n    \r\n    return Object.entries(eventTypeCounts)\r\n      .sort(([,a], [,b]) => b - a)\r\n      .slice(0, 5)\r\n      .map(([type, count]) => ({ type, count }));\r\n  }\r\n  \r\n  getAvailableEventTypes() {\r\n    return [\r\n      'truth_change',\r\n      'verification_update',\r\n      'verification_complete',\r\n      'system_alert',\r\n      'confidence_update',\r\n      'error',\r\n      'batch_update',\r\n    ];\r\n  }\r\n  \r\n  setupEventHandlers() {\r\n    this.startTime = Date.now();\r\n    \r\n    // Handle process signals\r\n    process.on('SIGINT', () => {\r\n      console.log('Received SIGINT, shutting down truth monitoring server...');\r\n      this.stop();\r\n      process.exit(0);\r\n    });\r\n    \r\n    process.on('SIGTERM', () => {\r\n      console.log('Received SIGTERM, shutting down truth monitoring server...');\r\n      this.stop();\r\n      process.exit(0);\r\n    });\r\n  }\r\n  \r\n  // Utility methods for external integration\r\n  getClientCount() {\r\n    return this.clients.size;\r\n  }\r\n  \r\n  getSubscriptionCount() {\r\n    return this.subscriptions.size;\r\n  }\r\n  \r\n  getConnectedClients() {\r\n    return Array.from(this.clients.values()).map(client => ({\r\n      id: client.id,\r\n      ip: client.ip,\r\n      connectedAt: client.connectedAt,\r\n      subscriptions: client.subscriptions.size,\r\n    }));\r\n  }\r\n}\r\n\r\nmodule.exports = TruthMonitoringServer;\r\n"],"names":["WebSocket","require","nanoid","EventEmitter","TruthMonitoringServer","options","port","server","clients","Map","subscriptions","heartbeatInterval","messageBuffer","maxBufferSize","setupEventHandlers","start","Server","on","ws","req","handleConnection","error","console","emit","startHeartbeat","log","stop","heartbeatTimer","clearInterval","close","clientId","clientInfo","id","ip","socket","remoteAddress","userAgent","headers","connectedAt","Date","now","Set","lastHeartbeat","set","sendMessage","type","payload","client_id","server_time","available_events","getAvailableEventTypes","sendBufferedMessages","data","message","JSON","parse","handleMessage","sendError","handleDisconnection","has","get","client","forEach","subscriptionId","removeSubscription","delete","handleSubscribe","handleUnsubscribe","handleHeartbeat","handleGetStatus","handleGetMetrics","subscription","filter","validateSubscriptionFilter","createdAt","add","subscription_id","status","server_uptime","startTime","connected_clients","size","active_subscriptions","message_buffer_size","length","metrics","calculateServerMetrics","broadcastTruthEvent","event","truthEvent","timestamp","severity","source","confidence","metadata","addToBuffer","matchingSubscriptions","Array","from","values","sub","eventMatchesFilter","readyState","OPEN","subscribers","broadcastVerificationUpdate","verification","broadcastAlert","alert","event_types","isArray","severity_levels","sources","targets","confidence_min","confidence_max","includes","send","stringify","code","push","slice","recentMessages","is_historical","setInterval","timeSinceLastHeartbeat","terminate","ping","client_stats","newest_connection","Math","min","map","c","oldest_connection","max","average_connection_age","reduce","sum","subscription_stats","subscriptions_per_client","most_popular_event_types","getMostPopularEventTypes","performance","memory_usage","process","memoryUsage","cpu_usage","cpuUsage","eventTypeCounts","Object","entries","sort","a","b","count","exit","getClientCount","getSubscriptionCount","getConnectedClients","module","exports"],"mappings":"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"}
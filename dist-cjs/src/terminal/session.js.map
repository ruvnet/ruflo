{"version":3,"sources":["../../../src/terminal/session.ts"],"sourcesContent":["/**\r\n * Terminal session management\r\n */\r\n\r\nimport type { Terminal } from './adapters/base.js';\r\nimport type { AgentProfile } from '../utils/types.js';\r\nimport type { ILogger } from '../core/logger.js';\r\nimport { TerminalCommandError } from '../utils/errors.js';\r\nimport { generateId, timeout } from '../utils/helpers.js';\r\n\r\n/**\r\n * Terminal session wrapper\r\n */\r\nexport class TerminalSession {\r\n  readonly id: string;\r\n  readonly startTime: Date;\r\n  private initialized = false;\r\n  private commandHistory: string[] = [];\r\n  private lastCommandTime?: Date;\r\n  private outputListeners = new Set<(output: string) => void>();\r\n\r\n  constructor(\r\n    public readonly terminal: Terminal,\r\n    public readonly profile: AgentProfile,\r\n    private commandTimeout: number,\r\n    private logger: ILogger,\r\n  ) {\r\n    this.id = generateId('session');\r\n    this.startTime = new Date();\r\n  }\r\n\r\n  get lastActivity(): Date {\r\n    return this.lastCommandTime || this.startTime;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    if (this.initialized) {\r\n      return;\r\n    }\r\n\r\n    this.logger.debug('Initializing terminal session', {\r\n      sessionId: this.id,\r\n      agentId: this.profile.id,\r\n    });\r\n\r\n    try {\r\n      // Set up environment\r\n      await this.setupEnvironment();\r\n\r\n      // Run initialization commands\r\n      await this.runInitializationCommands();\r\n\r\n      this.initialized = true;\r\n\r\n      this.logger.info('Terminal session initialized', {\r\n        sessionId: this.id,\r\n        agentId: this.profile.id,\r\n      });\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize terminal session', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async executeCommand(command: string): Promise<string> {\r\n    if (!this.initialized) {\r\n      throw new TerminalCommandError('Session not initialized');\r\n    }\r\n\r\n    if (!this.terminal.isAlive()) {\r\n      throw new TerminalCommandError('Terminal is not alive');\r\n    }\r\n\r\n    this.logger.debug('Executing command', {\r\n      sessionId: this.id,\r\n      command: command.substring(0, 100),\r\n    });\r\n\r\n    try {\r\n      // Notify listeners of command\r\n      this.notifyOutputListeners(`$ ${command}\\n`);\r\n\r\n      // Execute with timeout\r\n      const result = await timeout(\r\n        this.terminal.executeCommand(command),\r\n        this.commandTimeout,\r\n        `Command timeout after ${this.commandTimeout}ms`,\r\n      );\r\n\r\n      // Notify listeners of output\r\n      this.notifyOutputListeners(result);\r\n\r\n      // Update history\r\n      this.commandHistory.push(command);\r\n      this.lastCommandTime = new Date();\r\n\r\n      this.logger.debug('Command executed successfully', {\r\n        sessionId: this.id,\r\n        outputLength: result.length,\r\n      });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      this.logger.error('Command execution failed', {\r\n        sessionId: this.id,\r\n        command,\r\n        error,\r\n      });\r\n      throw new TerminalCommandError('Command execution failed', {\r\n        command,\r\n        error,\r\n      });\r\n    }\r\n  }\r\n\r\n  async cleanup(): Promise<void> {\r\n    this.logger.debug('Cleaning up terminal session', { sessionId: this.id });\r\n\r\n    try {\r\n      // Run cleanup commands\r\n      await this.runCleanupCommands();\r\n    } catch (error) {\r\n      this.logger.warn('Error during session cleanup', {\r\n        sessionId: this.id,\r\n        error,\r\n      });\r\n    }\r\n  }\r\n\r\n  isHealthy(): boolean {\r\n    if (!this.terminal.isAlive()) {\r\n      return false;\r\n    }\r\n\r\n    // Check if terminal is responsive\r\n    if (this.lastCommandTime) {\r\n      const timeSinceLastCommand = Date.now() - this.lastCommandTime.getTime();\r\n      if (timeSinceLastCommand > 300000) {\r\n        // 5 minutes\r\n        // Terminal might be stale, do a health check\r\n        this.performHealthCheck().catch((error) => {\r\n          this.logger.warn('Health check failed', { sessionId: this.id, error });\r\n        });\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  getCommandHistory(): string[] {\r\n    return [...this.commandHistory];\r\n  }\r\n\r\n  private async setupEnvironment(): Promise<void> {\r\n    // Set environment variables\r\n    const envVars = {\r\n      CLAUDE_FLOW_SESSION: this.id,\r\n      CLAUDE_FLOW_AGENT: this.profile.id,\r\n      CLAUDE_FLOW_AGENT_TYPE: this.profile.type,\r\n    };\r\n\r\n    for (const [key, value] of Object.entries(envVars)) {\r\n      await this.terminal.executeCommand(`export ${key}=\"${value}\"`);\r\n    }\r\n\r\n    // Set working directory if specified\r\n    if (this.profile.metadata?.workingDirectory) {\r\n      await this.terminal.executeCommand(`cd \"${this.profile.metadata.workingDirectory}\"`);\r\n    }\r\n  }\r\n\r\n  private async runInitializationCommands(): Promise<void> {\r\n    // Run any profile-specific initialization commands\r\n    if (this.profile.metadata?.initCommands) {\r\n      const commands = this.profile.metadata.initCommands as string[];\r\n      for (const command of commands) {\r\n        await this.terminal.executeCommand(command);\r\n      }\r\n    }\r\n\r\n    // Set up command prompt\r\n    await this.terminal.executeCommand('export PS1=\"[claude-flow]$ \"');\r\n  }\r\n\r\n  private async runCleanupCommands(): Promise<void> {\r\n    // Run any profile-specific cleanup commands\r\n    if (this.profile.metadata?.cleanupCommands) {\r\n      const commands = this.profile.metadata.cleanupCommands as string[];\r\n      for (const command of commands) {\r\n        try {\r\n          await this.terminal.executeCommand(command);\r\n        } catch {\r\n          // Ignore cleanup errors\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async performHealthCheck(): Promise<void> {\r\n    try {\r\n      const result = await timeout(\r\n        this.terminal.executeCommand('echo \"HEALTH_CHECK_OK\"'),\r\n        5000,\r\n        'Health check timeout',\r\n      );\r\n\r\n      if (!result.includes('HEALTH_CHECK_OK')) {\r\n        throw new Error('Invalid health check response');\r\n      }\r\n\r\n      this.lastCommandTime = new Date();\r\n    } catch (error) {\r\n      throw new Error(\r\n        `Health check failed: ${error instanceof Error ? error.message : String(error)}`,\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stream terminal output\r\n   */\r\n  streamOutput(callback: (output: string) => void): () => void {\r\n    this.outputListeners.add(callback);\r\n\r\n    // Set up terminal output listener if supported\r\n    if (this.terminal.addOutputListener) {\r\n      this.terminal.addOutputListener(callback);\r\n    }\r\n\r\n    // Return unsubscribe function\r\n    return () => {\r\n      this.outputListeners.delete(callback);\r\n      if (this.terminal.removeOutputListener) {\r\n        this.terminal.removeOutputListener(callback);\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify output listeners\r\n   */\r\n  private notifyOutputListeners(output: string): void {\r\n    this.outputListeners.forEach((listener) => {\r\n      try {\r\n        listener(output);\r\n      } catch (error) {\r\n        this.logger.error('Error in output listener', { sessionId: this.id, error });\r\n      }\r\n    });\r\n  }\r\n}\r\n"],"names":["TerminalCommandError","generateId","timeout","TerminalSession","id","startTime","initialized","commandHistory","lastCommandTime","outputListeners","Set","terminal","profile","commandTimeout","logger","Date","lastActivity","initialize","debug","sessionId","agentId","setupEnvironment","runInitializationCommands","info","error","executeCommand","command","isAlive","substring","notifyOutputListeners","result","push","outputLength","length","cleanup","runCleanupCommands","warn","isHealthy","timeSinceLastCommand","now","getTime","performHealthCheck","catch","getCommandHistory","envVars","CLAUDE_FLOW_SESSION","CLAUDE_FLOW_AGENT","CLAUDE_FLOW_AGENT_TYPE","type","key","value","Object","entries","metadata","workingDirectory","initCommands","commands","cleanupCommands","includes","Error","message","String","streamOutput","callback","add","addOutputListener","delete","removeOutputListener","output","forEach","listener"],"mappings":"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"}
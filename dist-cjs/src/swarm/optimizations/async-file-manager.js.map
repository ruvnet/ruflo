{"version":3,"sources":["../../../../src/swarm/optimizations/async-file-manager.ts"],"sourcesContent":["/**\r\n * Async File Manager\r\n * Handles non-blocking file operations with queuing\r\n */\r\n\r\nimport { promises as fs } from 'node:fs';\r\nimport { pipeline } from 'node:stream/promises';\r\nimport { createWriteStream, createReadStream } from 'node:fs';\r\nimport { Readable } from 'node:stream';\r\nimport { join, dirname } from 'node:path';\r\nimport PQueue from 'p-queue';\r\nimport { Logger } from '../../core/logger.js';\r\n\r\nexport interface FileOperationResult {\r\n  path: string;\r\n  operation: 'read' | 'write' | 'delete' | 'mkdir';\r\n  success: boolean;\r\n  duration: number;\r\n  size?: number;\r\n  error?: Error;\r\n}\r\n\r\nexport class AsyncFileManager {\r\n  private writeQueue: PQueue;\r\n  private readQueue: PQueue;\r\n  private logger: Logger;\r\n  private metrics = {\r\n    operations: new Map<string, number>(),\r\n    totalBytes: 0,\r\n    errors: 0,\r\n  };\r\n\r\n  constructor(\r\n    private concurrency = {\r\n      write: 10,\r\n      read: 20,\r\n    },\r\n  ) {\r\n    this.writeQueue = new PQueue({ concurrency: this.concurrency.write });\r\n    this.readQueue = new PQueue({ concurrency: this.concurrency.read });\r\n\r\n    // Use test-safe logger configuration\r\n    const loggerConfig =\r\n      process.env.CLAUDE_FLOW_ENV === 'test'\r\n        ? { level: 'error' as const, format: 'json' as const, destination: 'console' as const }\r\n        : { level: 'info' as const, format: 'json' as const, destination: 'console' as const };\r\n\r\n    this.logger = new Logger(loggerConfig, { component: 'AsyncFileManager' });\r\n  }\r\n\r\n  async writeFile(path: string, data: string | Buffer): Promise<FileOperationResult> {\r\n    const start = Date.now();\r\n\r\n    return await this.writeQueue.add(async () => {\r\n      try {\r\n        // Ensure directory exists\r\n        await this.ensureDirectory(dirname(path));\r\n\r\n        // Use streaming for large files\r\n        if (data.length > 1024 * 1024) {\r\n          // > 1MB\r\n          await this.streamWrite(path, data);\r\n        } else {\r\n          await fs.writeFile(path, data, 'utf8');\r\n        }\r\n\r\n        const duration = Date.now() - start;\r\n        const size = Buffer.byteLength(data);\r\n\r\n        this.trackOperation('write', size);\r\n\r\n        return {\r\n          path,\r\n          operation: 'write' as const,\r\n          success: true,\r\n          duration,\r\n          size,\r\n        };\r\n      } catch (error) {\r\n        this.metrics.errors++;\r\n        this.logger.error('Failed to write file', { path, error });\r\n\r\n        return {\r\n          path,\r\n          operation: 'write' as const,\r\n          success: false,\r\n          duration: Date.now() - start,\r\n          error: error as Error,\r\n        };\r\n      }\r\n    });\r\n  }\r\n\r\n  async readFile(path: string): Promise<FileOperationResult & { data?: string }> {\r\n    const start = Date.now();\r\n\r\n    return await this.readQueue.add(async () => {\r\n      try {\r\n        const data = await fs.readFile(path, 'utf8');\r\n        const duration = Date.now() - start;\r\n        const size = Buffer.byteLength(data);\r\n\r\n        this.trackOperation('read', size);\r\n\r\n        return {\r\n          path,\r\n          operation: 'read' as const,\r\n          success: true,\r\n          duration,\r\n          size,\r\n          data,\r\n        };\r\n      } catch (error) {\r\n        this.metrics.errors++;\r\n        this.logger.error('Failed to read file', { path, error });\r\n\r\n        return {\r\n          path,\r\n          operation: 'read' as const,\r\n          success: false,\r\n          duration: Date.now() - start,\r\n          error: error as Error,\r\n        };\r\n      }\r\n    });\r\n  }\r\n\r\n  async writeJSON(path: string, data: any, pretty = true): Promise<FileOperationResult> {\r\n    const jsonString = pretty ? JSON.stringify(data, null, 2) : JSON.stringify(data);\r\n\r\n    return this.writeFile(path, jsonString);\r\n  }\r\n\r\n  async readJSON(path: string): Promise<FileOperationResult & { data?: any }> {\r\n    const result = await this.readFile(path);\r\n\r\n    if (result.success && result.data) {\r\n      try {\r\n        const parsed = JSON.parse(result.data);\r\n        return { ...result, data: parsed };\r\n      } catch (error) {\r\n        return {\r\n          ...result,\r\n          success: false,\r\n          error: new Error('Invalid JSON format'),\r\n        };\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  async deleteFile(path: string): Promise<FileOperationResult> {\r\n    const start = Date.now();\r\n\r\n    return this.writeQueue.add(async () => {\r\n      try {\r\n        await fs.unlink(path);\r\n\r\n        this.trackOperation('delete', 0);\r\n\r\n        return {\r\n          path,\r\n          operation: 'delete',\r\n          success: true,\r\n          duration: Date.now() - start,\r\n        };\r\n      } catch (error) {\r\n        this.metrics.errors++;\r\n        this.logger.error('Failed to delete file', { path, error });\r\n\r\n        return {\r\n          path,\r\n          operation: 'delete',\r\n          success: false,\r\n          duration: Date.now() - start,\r\n          error: error as Error,\r\n        };\r\n      }\r\n    });\r\n  }\r\n\r\n  async ensureDirectory(path: string): Promise<FileOperationResult> {\r\n    const start = Date.now();\r\n\r\n    try {\r\n      await fs.mkdir(path, { recursive: true });\r\n\r\n      this.trackOperation('mkdir', 0);\r\n\r\n      return {\r\n        path,\r\n        operation: 'mkdir',\r\n        success: true,\r\n        duration: Date.now() - start,\r\n      };\r\n    } catch (error) {\r\n      this.metrics.errors++;\r\n      this.logger.error('Failed to create directory', { path, error });\r\n\r\n      return {\r\n        path,\r\n        operation: 'mkdir',\r\n        success: false,\r\n        duration: Date.now() - start,\r\n        error: error as Error,\r\n      };\r\n    }\r\n  }\r\n\r\n  async ensureDirectories(paths: string[]): Promise<FileOperationResult[]> {\r\n    return Promise.all(paths.map((path) => this.ensureDirectory(path)));\r\n  }\r\n\r\n  private async streamWrite(path: string, data: string | Buffer): Promise<void> {\r\n    const stream = createWriteStream(path);\r\n    await pipeline(Readable.from(data), stream);\r\n  }\r\n\r\n  async streamRead(path: string): Promise<NodeJS.ReadableStream> {\r\n    return createReadStream(path);\r\n  }\r\n\r\n  async copyFile(source: string, destination: string): Promise<FileOperationResult> {\r\n    const start = Date.now();\r\n\r\n    return this.writeQueue.add(async () => {\r\n      try {\r\n        await this.ensureDirectory(dirname(destination));\r\n        await fs.copyFile(source, destination);\r\n\r\n        const stats = await fs.stat(destination);\r\n        this.trackOperation('write', stats.size);\r\n\r\n        return {\r\n          path: destination,\r\n          operation: 'write',\r\n          success: true,\r\n          duration: Date.now() - start,\r\n          size: stats.size,\r\n        };\r\n      } catch (error) {\r\n        this.metrics.errors++;\r\n        this.logger.error('Failed to copy file', { source, destination, error });\r\n\r\n        return {\r\n          path: destination,\r\n          operation: 'write',\r\n          success: false,\r\n          duration: Date.now() - start,\r\n          error: error as Error,\r\n        };\r\n      }\r\n    });\r\n  }\r\n\r\n  async moveFile(source: string, destination: string): Promise<FileOperationResult> {\r\n    const copyResult = await this.copyFile(source, destination);\r\n    if (copyResult.success) {\r\n      await this.deleteFile(source);\r\n    }\r\n    return copyResult;\r\n  }\r\n\r\n  private trackOperation(type: string, bytes: number): void {\r\n    const count = this.metrics.operations.get(type) || 0;\r\n    this.metrics.operations.set(type, count + 1);\r\n    this.metrics.totalBytes += bytes;\r\n  }\r\n\r\n  getMetrics() {\r\n    return {\r\n      operations: Object.fromEntries(this.metrics.operations),\r\n      totalBytes: this.metrics.totalBytes,\r\n      errors: this.metrics.errors,\r\n      writeQueueSize: this.writeQueue.size,\r\n      readQueueSize: this.readQueue.size,\r\n      writeQueuePending: this.writeQueue.pending,\r\n      readQueuePending: this.readQueue.pending,\r\n    };\r\n  }\r\n\r\n  async waitForPendingOperations(): Promise<void> {\r\n    await Promise.all([this.writeQueue.onIdle(), this.readQueue.onIdle()]);\r\n  }\r\n\r\n  clearQueues(): void {\r\n    this.writeQueue.clear();\r\n    this.readQueue.clear();\r\n  }\r\n}\r\n"],"names":["promises","fs","pipeline","createWriteStream","createReadStream","Readable","dirname","PQueue","Logger","AsyncFileManager","writeQueue","readQueue","logger","metrics","operations","Map","totalBytes","errors","concurrency","write","read","loggerConfig","process","env","CLAUDE_FLOW_ENV","level","format","destination","component","writeFile","path","data","start","Date","now","add","ensureDirectory","length","streamWrite","duration","size","Buffer","byteLength","trackOperation","operation","success","error","readFile","writeJSON","pretty","jsonString","JSON","stringify","readJSON","result","parsed","parse","Error","deleteFile","unlink","mkdir","recursive","ensureDirectories","paths","Promise","all","map","stream","from","streamRead","copyFile","source","stats","stat","moveFile","copyResult","type","bytes","count","get","set","getMetrics","Object","fromEntries","writeQueueSize","readQueueSize","writeQueuePending","pending","readQueuePending","waitForPendingOperations","onIdle","clearQueues","clear"],"mappings":"AAKA,SAASA,YAAYC,EAAE,QAAQ,UAAU;AACzC,SAASC,QAAQ,QAAQ,uBAAuB;AAChD,SAASC,iBAAiB,EAAEC,gBAAgB,QAAQ,UAAU;AAC9D,SAASC,QAAQ,QAAQ,cAAc;AACvC,SAAeC,OAAO,QAAQ,YAAY;AAC1C,OAAOC,YAAY,UAAU;AAC7B,SAASC,MAAM,QAAQ,uBAAuB;AAW9C,OAAO,MAAMC;;IACHC,WAAmB;IACnBC,UAAkB;IAClBC,OAAe;IACfC,UAAU;QAChBC,YAAY,IAAIC;QAChBC,YAAY;QACZC,QAAQ;IACV,EAAE;IAEF,YACE,AAAQC,cAAc;QACpBC,OAAO;QACPC,MAAM;IACR,CAAC,CACD;aAJQF,cAAAA;QAKR,IAAI,CAACR,UAAU,GAAG,IAAIH,OAAO;YAAEW,aAAa,IAAI,CAACA,WAAW,CAACC,KAAK;QAAC;QACnE,IAAI,CAACR,SAAS,GAAG,IAAIJ,OAAO;YAAEW,aAAa,IAAI,CAACA,WAAW,CAACE,IAAI;QAAC;QAGjE,MAAMC,eACJC,QAAQC,GAAG,CAACC,eAAe,KAAK,SAC5B;YAAEC,OAAO;YAAkBC,QAAQ;YAAiBC,aAAa;QAAmB,IACpF;YAAEF,OAAO;YAAiBC,QAAQ;YAAiBC,aAAa;QAAmB;QAEzF,IAAI,CAACf,MAAM,GAAG,IAAIJ,OAAOa,cAAc;YAAEO,WAAW;QAAmB;IACzE;IAEA,MAAMC,UAAUC,IAAY,EAAEC,IAAqB,EAAgC;QACjF,MAAMC,QAAQC,KAAKC,GAAG;QAEtB,OAAO,MAAM,IAAI,CAACxB,UAAU,CAACyB,GAAG,CAAC;YAC/B,IAAI;gBAEF,MAAM,IAAI,CAACC,eAAe,CAAC9B,QAAQwB;gBAGnC,IAAIC,KAAKM,MAAM,GAAG,OAAO,MAAM;oBAE7B,MAAM,IAAI,CAACC,WAAW,CAACR,MAAMC;gBAC/B,OAAO;oBACL,MAAM9B,GAAG4B,SAAS,CAACC,MAAMC,MAAM;gBACjC;gBAEA,MAAMQ,WAAWN,KAAKC,GAAG,KAAKF;gBAC9B,MAAMQ,OAAOC,OAAOC,UAAU,CAACX;gBAE/B,IAAI,CAACY,cAAc,CAAC,SAASH;gBAE7B,OAAO;oBACLV;oBACAc,WAAW;oBACXC,SAAS;oBACTN;oBACAC;gBACF;YACF,EAAE,OAAOM,OAAO;gBACd,IAAI,CAACjC,OAAO,CAACI,MAAM;gBACnB,IAAI,CAACL,MAAM,CAACkC,KAAK,CAAC,wBAAwB;oBAAEhB;oBAAMgB;gBAAM;gBAExD,OAAO;oBACLhB;oBACAc,WAAW;oBACXC,SAAS;oBACTN,UAAUN,KAAKC,GAAG,KAAKF;oBACvBc,OAAOA;gBACT;YACF;QACF;IACF;IAEA,MAAMC,SAASjB,IAAY,EAAoD;QAC7E,MAAME,QAAQC,KAAKC,GAAG;QAEtB,OAAO,MAAM,IAAI,CAACvB,SAAS,CAACwB,GAAG,CAAC;YAC9B,IAAI;gBACF,MAAMJ,OAAO,MAAM9B,GAAG8C,QAAQ,CAACjB,MAAM;gBACrC,MAAMS,WAAWN,KAAKC,GAAG,KAAKF;gBAC9B,MAAMQ,OAAOC,OAAOC,UAAU,CAACX;gBAE/B,IAAI,CAACY,cAAc,CAAC,QAAQH;gBAE5B,OAAO;oBACLV;oBACAc,WAAW;oBACXC,SAAS;oBACTN;oBACAC;oBACAT;gBACF;YACF,EAAE,OAAOe,OAAO;gBACd,IAAI,CAACjC,OAAO,CAACI,MAAM;gBACnB,IAAI,CAACL,MAAM,CAACkC,KAAK,CAAC,uBAAuB;oBAAEhB;oBAAMgB;gBAAM;gBAEvD,OAAO;oBACLhB;oBACAc,WAAW;oBACXC,SAAS;oBACTN,UAAUN,KAAKC,GAAG,KAAKF;oBACvBc,OAAOA;gBACT;YACF;QACF;IACF;IAEA,MAAME,UAAUlB,IAAY,EAAEC,IAAS,EAAEkB,SAAS,IAAI,EAAgC;QACpF,MAAMC,aAAaD,SAASE,KAAKC,SAAS,CAACrB,MAAM,MAAM,KAAKoB,KAAKC,SAAS,CAACrB;QAE3E,OAAO,IAAI,CAACF,SAAS,CAACC,MAAMoB;IAC9B;IAEA,MAAMG,SAASvB,IAAY,EAAiD;QAC1E,MAAMwB,SAAS,MAAM,IAAI,CAACP,QAAQ,CAACjB;QAEnC,IAAIwB,OAAOT,OAAO,IAAIS,OAAOvB,IAAI,EAAE;YACjC,IAAI;gBACF,MAAMwB,SAASJ,KAAKK,KAAK,CAACF,OAAOvB,IAAI;gBACrC,OAAO;oBAAE,GAAGuB,MAAM;oBAAEvB,MAAMwB;gBAAO;YACnC,EAAE,OAAOT,OAAO;gBACd,OAAO;oBACL,GAAGQ,MAAM;oBACTT,SAAS;oBACTC,OAAO,IAAIW,MAAM;gBACnB;YACF;QACF;QAEA,OAAOH;IACT;IAEA,MAAMI,WAAW5B,IAAY,EAAgC;QAC3D,MAAME,QAAQC,KAAKC,GAAG;QAEtB,OAAO,IAAI,CAACxB,UAAU,CAACyB,GAAG,CAAC;YACzB,IAAI;gBACF,MAAMlC,GAAG0D,MAAM,CAAC7B;gBAEhB,IAAI,CAACa,cAAc,CAAC,UAAU;gBAE9B,OAAO;oBACLb;oBACAc,WAAW;oBACXC,SAAS;oBACTN,UAAUN,KAAKC,GAAG,KAAKF;gBACzB;YACF,EAAE,OAAOc,OAAO;gBACd,IAAI,CAACjC,OAAO,CAACI,MAAM;gBACnB,IAAI,CAACL,MAAM,CAACkC,KAAK,CAAC,yBAAyB;oBAAEhB;oBAAMgB;gBAAM;gBAEzD,OAAO;oBACLhB;oBACAc,WAAW;oBACXC,SAAS;oBACTN,UAAUN,KAAKC,GAAG,KAAKF;oBACvBc,OAAOA;gBACT;YACF;QACF;IACF;IAEA,MAAMV,gBAAgBN,IAAY,EAAgC;QAChE,MAAME,QAAQC,KAAKC,GAAG;QAEtB,IAAI;YACF,MAAMjC,GAAG2D,KAAK,CAAC9B,MAAM;gBAAE+B,WAAW;YAAK;YAEvC,IAAI,CAAClB,cAAc,CAAC,SAAS;YAE7B,OAAO;gBACLb;gBACAc,WAAW;gBACXC,SAAS;gBACTN,UAAUN,KAAKC,GAAG,KAAKF;YACzB;QACF,EAAE,OAAOc,OAAO;YACd,IAAI,CAACjC,OAAO,CAACI,MAAM;YACnB,IAAI,CAACL,MAAM,CAACkC,KAAK,CAAC,8BAA8B;gBAAEhB;gBAAMgB;YAAM;YAE9D,OAAO;gBACLhB;gBACAc,WAAW;gBACXC,SAAS;gBACTN,UAAUN,KAAKC,GAAG,KAAKF;gBACvBc,OAAOA;YACT;QACF;IACF;IAEA,MAAMgB,kBAAkBC,KAAe,EAAkC;QACvE,OAAOC,QAAQC,GAAG,CAACF,MAAMG,GAAG,CAAC,CAACpC,OAAS,IAAI,CAACM,eAAe,CAACN;IAC9D;IAEA,MAAcQ,YAAYR,IAAY,EAAEC,IAAqB,EAAiB;QAC5E,MAAMoC,SAAShE,kBAAkB2B;QACjC,MAAM5B,SAASG,SAAS+D,IAAI,CAACrC,OAAOoC;IACtC;IAEA,MAAME,WAAWvC,IAAY,EAAkC;QAC7D,OAAO1B,iBAAiB0B;IAC1B;IAEA,MAAMwC,SAASC,MAAc,EAAE5C,WAAmB,EAAgC;QAChF,MAAMK,QAAQC,KAAKC,GAAG;QAEtB,OAAO,IAAI,CAACxB,UAAU,CAACyB,GAAG,CAAC;YACzB,IAAI;gBACF,MAAM,IAAI,CAACC,eAAe,CAAC9B,QAAQqB;gBACnC,MAAM1B,GAAGqE,QAAQ,CAACC,QAAQ5C;gBAE1B,MAAM6C,QAAQ,MAAMvE,GAAGwE,IAAI,CAAC9C;gBAC5B,IAAI,CAACgB,cAAc,CAAC,SAAS6B,MAAMhC,IAAI;gBAEvC,OAAO;oBACLV,MAAMH;oBACNiB,WAAW;oBACXC,SAAS;oBACTN,UAAUN,KAAKC,GAAG,KAAKF;oBACvBQ,MAAMgC,MAAMhC,IAAI;gBAClB;YACF,EAAE,OAAOM,OAAO;gBACd,IAAI,CAACjC,OAAO,CAACI,MAAM;gBACnB,IAAI,CAACL,MAAM,CAACkC,KAAK,CAAC,uBAAuB;oBAAEyB;oBAAQ5C;oBAAamB;gBAAM;gBAEtE,OAAO;oBACLhB,MAAMH;oBACNiB,WAAW;oBACXC,SAAS;oBACTN,UAAUN,KAAKC,GAAG,KAAKF;oBACvBc,OAAOA;gBACT;YACF;QACF;IACF;IAEA,MAAM4B,SAASH,MAAc,EAAE5C,WAAmB,EAAgC;QAChF,MAAMgD,aAAa,MAAM,IAAI,CAACL,QAAQ,CAACC,QAAQ5C;QAC/C,IAAIgD,WAAW9B,OAAO,EAAE;YACtB,MAAM,IAAI,CAACa,UAAU,CAACa;QACxB;QACA,OAAOI;IACT;IAEQhC,eAAeiC,IAAY,EAAEC,KAAa,EAAQ;QACxD,MAAMC,QAAQ,IAAI,CAACjE,OAAO,CAACC,UAAU,CAACiE,GAAG,CAACH,SAAS;QACnD,IAAI,CAAC/D,OAAO,CAACC,UAAU,CAACkE,GAAG,CAACJ,MAAME,QAAQ;QAC1C,IAAI,CAACjE,OAAO,CAACG,UAAU,IAAI6D;IAC7B;IAEAI,aAAa;QACX,OAAO;YACLnE,YAAYoE,OAAOC,WAAW,CAAC,IAAI,CAACtE,OAAO,CAACC,UAAU;YACtDE,YAAY,IAAI,CAACH,OAAO,CAACG,UAAU;YACnCC,QAAQ,IAAI,CAACJ,OAAO,CAACI,MAAM;YAC3BmE,gBAAgB,IAAI,CAAC1E,UAAU,CAAC8B,IAAI;YACpC6C,eAAe,IAAI,CAAC1E,SAAS,CAAC6B,IAAI;YAClC8C,mBAAmB,IAAI,CAAC5E,UAAU,CAAC6E,OAAO;YAC1CC,kBAAkB,IAAI,CAAC7E,SAAS,CAAC4E,OAAO;QAC1C;IACF;IAEA,MAAME,2BAA0C;QAC9C,MAAMzB,QAAQC,GAAG,CAAC;YAAC,IAAI,CAACvD,UAAU,CAACgF,MAAM;YAAI,IAAI,CAAC/E,SAAS,CAAC+E,MAAM;SAAG;IACvE;IAEAC,cAAoB;QAClB,IAAI,CAACjF,UAAU,CAACkF,KAAK;QACrB,IAAI,CAACjF,SAAS,CAACiF,KAAK;IACtB;AACF"}
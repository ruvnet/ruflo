{"version":3,"sources":["../../../src/sdk/query-control.ts"],"sourcesContent":["/**\r\n * Real-Time Query Control\r\n * Claude-Flow v2.5-alpha.130\r\n *\r\n * Implements real-time control of running agent queries:\r\n * - Pause/resume execution\r\n * - Terminate agents dynamically\r\n * - Change model or permissions mid-execution\r\n * - Monitor agent status in real-time\r\n */\r\n\r\nimport { type Query, type PermissionMode, type ModelInfo } from '@anthropic-ai/claude-code/sdk';\r\nimport { EventEmitter } from 'events';\r\nimport { Logger } from '../core/logger.js';\r\n\r\nexport interface QueryControlOptions {\r\n  allowPause?: boolean;\r\n  allowModelChange?: boolean;\r\n  allowPermissionChange?: boolean;\r\n  monitoringInterval?: number;\r\n}\r\n\r\nexport interface ControlledQuery {\r\n  queryId: string;\r\n  agentId: string;\r\n  query: Query;\r\n  status: 'running' | 'paused' | 'terminated' | 'completed' | 'failed';\r\n  isPaused: boolean;\r\n  canControl: boolean;\r\n  startTime: number;\r\n  pausedAt?: number;\r\n  resumedAt?: number;\r\n  terminatedAt?: number;\r\n  currentModel?: string;\r\n  permissionMode?: PermissionMode;\r\n}\r\n\r\nexport interface QueryControlCommand {\r\n  type: 'pause' | 'resume' | 'terminate' | 'changeModel' | 'changePermissions';\r\n  queryId: string;\r\n  params?: {\r\n    model?: string;\r\n    permissionMode?: PermissionMode;\r\n    reason?: string;\r\n  };\r\n}\r\n\r\nexport interface QueryStatusUpdate {\r\n  queryId: string;\r\n  status: ControlledQuery['status'];\r\n  timestamp: number;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\n/**\r\n * RealTimeQueryController - Control running queries dynamically\r\n * Enables pause, resume, terminate, and configuration changes during execution\r\n */\r\nexport class RealTimeQueryController extends EventEmitter {\r\n  private logger: Logger;\r\n  private controlledQueries: Map<string, ControlledQuery> = new Map();\r\n  private monitoringIntervals: Map<string, NodeJS.Timeout> = new Map();\r\n  private commandQueue: Map<string, QueryControlCommand[]> = new Map();\r\n  private options: QueryControlOptions;\r\n\r\n  constructor(options: QueryControlOptions = {}) {\r\n    super();\r\n    this.options = {\r\n      allowPause: options.allowPause !== false,\r\n      allowModelChange: options.allowModelChange !== false,\r\n      allowPermissionChange: options.allowPermissionChange !== false,\r\n      monitoringInterval: options.monitoringInterval || 1000\r\n    };\r\n\r\n    this.logger = new Logger(\r\n      { level: 'info', format: 'text', destination: 'console' },\r\n      { component: 'RealTimeQueryController' }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Register a query for control\r\n   */\r\n  registerQuery(queryId: string, agentId: string, query: Query): ControlledQuery {\r\n    const controlled: ControlledQuery = {\r\n      queryId,\r\n      agentId,\r\n      query,\r\n      status: 'running',\r\n      isPaused: false,\r\n      canControl: true,\r\n      startTime: Date.now()\r\n    };\r\n\r\n    this.controlledQueries.set(queryId, controlled);\r\n    this.startMonitoring(queryId);\r\n\r\n    this.logger.info('Query registered for control', { queryId, agentId });\r\n    this.emit('query:registered', { queryId, agentId });\r\n\r\n    return controlled;\r\n  }\r\n\r\n  /**\r\n   * Pause a running query\r\n   * Note: SDK interrupt() will stop the query, not pause it\r\n   * True pause/resume requires custom implementation\r\n   */\r\n  async pauseQuery(queryId: string, reason?: string): Promise<boolean> {\r\n    if (!this.options.allowPause) {\r\n      throw new Error('Pause is not enabled in controller options');\r\n    }\r\n\r\n    const controlled = this.controlledQueries.get(queryId);\r\n    if (!controlled) {\r\n      throw new Error(`Query not found: ${queryId}`);\r\n    }\r\n\r\n    if (controlled.isPaused || controlled.status !== 'running') {\r\n      this.logger.warn('Query is not in a state to be paused', {\r\n        queryId,\r\n        status: controlled.status,\r\n        isPaused: controlled.isPaused\r\n      });\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      // SDK doesn't support true pause, so we interrupt\r\n      // In a real implementation, we'd need to track state and resume\r\n      await controlled.query.interrupt();\r\n\r\n      controlled.isPaused = true;\r\n      controlled.status = 'paused';\r\n      controlled.pausedAt = Date.now();\r\n\r\n      this.logger.info('Query paused', { queryId, reason });\r\n      this.emit('query:paused', { queryId, reason });\r\n\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error('Failed to pause query', {\r\n        queryId,\r\n        error: error instanceof Error ? error.message : String(error)\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resume a paused query\r\n   * Note: Actual resume requires storing state and restarting\r\n   */\r\n  async resumeQuery(queryId: string): Promise<boolean> {\r\n    const controlled = this.controlledQueries.get(queryId);\r\n    if (!controlled) {\r\n      throw new Error(`Query not found: ${queryId}`);\r\n    }\r\n\r\n    if (!controlled.isPaused || controlled.status !== 'paused') {\r\n      this.logger.warn('Query is not paused', { queryId, status: controlled.status });\r\n      return false;\r\n    }\r\n\r\n    // In a real implementation, we'd resume from saved state\r\n    // For now, mark as resumed\r\n    controlled.isPaused = false;\r\n    controlled.status = 'running';\r\n    controlled.resumedAt = Date.now();\r\n\r\n    this.logger.info('Query resumed', { queryId });\r\n    this.emit('query:resumed', { queryId });\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Terminate a query immediately\r\n   */\r\n  async terminateQuery(queryId: string, reason?: string): Promise<boolean> {\r\n    const controlled = this.controlledQueries.get(queryId);\r\n    if (!controlled) {\r\n      throw new Error(`Query not found: ${queryId}`);\r\n    }\r\n\r\n    if (controlled.status === 'terminated') {\r\n      return true;\r\n    }\r\n\r\n    try {\r\n      await controlled.query.interrupt();\r\n\r\n      controlled.status = 'terminated';\r\n      controlled.terminatedAt = Date.now();\r\n      this.stopMonitoring(queryId);\r\n\r\n      this.logger.info('Query terminated', { queryId, reason });\r\n      this.emit('query:terminated', { queryId, reason });\r\n\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error('Failed to terminate query', {\r\n        queryId,\r\n        error: error instanceof Error ? error.message : String(error)\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Change model for a running query\r\n   */\r\n  async changeModel(queryId: string, model: string): Promise<boolean> {\r\n    if (!this.options.allowModelChange) {\r\n      throw new Error('Model change is not enabled in controller options');\r\n    }\r\n\r\n    const controlled = this.controlledQueries.get(queryId);\r\n    if (!controlled) {\r\n      throw new Error(`Query not found: ${queryId}`);\r\n    }\r\n\r\n    if (controlled.status !== 'running') {\r\n      throw new Error('Can only change model for running queries');\r\n    }\r\n\r\n    try {\r\n      await controlled.query.setModel(model);\r\n      controlled.currentModel = model;\r\n\r\n      this.logger.info('Model changed for query', { queryId, model });\r\n      this.emit('query:modelChanged', { queryId, model });\r\n\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error('Failed to change model', {\r\n        queryId,\r\n        model,\r\n        error: error instanceof Error ? error.message : String(error)\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Change permission mode for a running query\r\n   */\r\n  async changePermissionMode(queryId: string, mode: PermissionMode): Promise<boolean> {\r\n    if (!this.options.allowPermissionChange) {\r\n      throw new Error('Permission change is not enabled in controller options');\r\n    }\r\n\r\n    const controlled = this.controlledQueries.get(queryId);\r\n    if (!controlled) {\r\n      throw new Error(`Query not found: ${queryId}`);\r\n    }\r\n\r\n    if (controlled.status !== 'running') {\r\n      throw new Error('Can only change permissions for running queries');\r\n    }\r\n\r\n    try {\r\n      await controlled.query.setPermissionMode(mode);\r\n      controlled.permissionMode = mode;\r\n\r\n      this.logger.info('Permission mode changed for query', { queryId, mode });\r\n      this.emit('query:permissionChanged', { queryId, mode });\r\n\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error('Failed to change permission mode', {\r\n        queryId,\r\n        mode,\r\n        error: error instanceof Error ? error.message : String(error)\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get supported models for a query\r\n   */\r\n  async getSupportedModels(queryId: string): Promise<ModelInfo[]> {\r\n    const controlled = this.controlledQueries.get(queryId);\r\n    if (!controlled) {\r\n      throw new Error(`Query not found: ${queryId}`);\r\n    }\r\n\r\n    try {\r\n      return await controlled.query.supportedModels();\r\n    } catch (error) {\r\n      this.logger.error('Failed to get supported models', { queryId });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute a control command\r\n   */\r\n  async executeCommand(command: QueryControlCommand): Promise<boolean> {\r\n    this.logger.debug('Executing control command', { command });\r\n\r\n    switch (command.type) {\r\n      case 'pause':\r\n        return this.pauseQuery(command.queryId, command.params?.reason);\r\n\r\n      case 'resume':\r\n        return this.resumeQuery(command.queryId);\r\n\r\n      case 'terminate':\r\n        return this.terminateQuery(command.queryId, command.params?.reason);\r\n\r\n      case 'changeModel':\r\n        if (!command.params?.model) {\r\n          throw new Error('Model parameter required for changeModel command');\r\n        }\r\n        return this.changeModel(command.queryId, command.params.model);\r\n\r\n      case 'changePermissions':\r\n        if (!command.params?.permissionMode) {\r\n          throw new Error('Permission mode required for changePermissions command');\r\n        }\r\n        return this.changePermissionMode(command.queryId, command.params.permissionMode);\r\n\r\n      default:\r\n        throw new Error(`Unknown command type: ${(command as any).type}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Queue a command for execution\r\n   */\r\n  queueCommand(command: QueryControlCommand): void {\r\n    const queue = this.commandQueue.get(command.queryId) || [];\r\n    queue.push(command);\r\n    this.commandQueue.set(command.queryId, queue);\r\n\r\n    this.emit('command:queued', command);\r\n  }\r\n\r\n  /**\r\n   * Process queued commands for a query\r\n   */\r\n  async processQueuedCommands(queryId: string): Promise<void> {\r\n    const queue = this.commandQueue.get(queryId);\r\n    if (!queue || queue.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.logger.debug('Processing queued commands', {\r\n      queryId,\r\n      commandCount: queue.length\r\n    });\r\n\r\n    while (queue.length > 0) {\r\n      const command = queue.shift()!;\r\n      try {\r\n        await this.executeCommand(command);\r\n      } catch (error) {\r\n        this.logger.error('Failed to execute queued command', {\r\n          queryId,\r\n          command,\r\n          error: error instanceof Error ? error.message : String(error)\r\n        });\r\n      }\r\n    }\r\n\r\n    this.commandQueue.delete(queryId);\r\n  }\r\n\r\n  /**\r\n   * Get query status\r\n   */\r\n  getQueryStatus(queryId: string): ControlledQuery | undefined {\r\n    return this.controlledQueries.get(queryId);\r\n  }\r\n\r\n  /**\r\n   * Get all controlled queries\r\n   */\r\n  getAllQueries(): Map<string, ControlledQuery> {\r\n    return new Map(this.controlledQueries);\r\n  }\r\n\r\n  /**\r\n   * Start monitoring a query\r\n   */\r\n  private startMonitoring(queryId: string): void {\r\n    const interval = setInterval(() => {\r\n      const controlled = this.controlledQueries.get(queryId);\r\n      if (!controlled) {\r\n        this.stopMonitoring(queryId);\r\n        return;\r\n      }\r\n\r\n      const update: QueryStatusUpdate = {\r\n        queryId,\r\n        status: controlled.status,\r\n        timestamp: Date.now(),\r\n        metadata: {\r\n          isPaused: controlled.isPaused,\r\n          duration: Date.now() - controlled.startTime\r\n        }\r\n      };\r\n\r\n      this.emit('query:status', update);\r\n\r\n    }, this.options.monitoringInterval);\r\n\r\n    this.monitoringIntervals.set(queryId, interval);\r\n  }\r\n\r\n  /**\r\n   * Stop monitoring a query\r\n   */\r\n  private stopMonitoring(queryId: string): void {\r\n    const interval = this.monitoringIntervals.get(queryId);\r\n    if (interval) {\r\n      clearInterval(interval);\r\n      this.monitoringIntervals.delete(queryId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unregister a query\r\n   */\r\n  unregisterQuery(queryId: string): void {\r\n    this.stopMonitoring(queryId);\r\n    this.controlledQueries.delete(queryId);\r\n    this.commandQueue.delete(queryId);\r\n\r\n    this.logger.info('Query unregistered', { queryId });\r\n    this.emit('query:unregistered', { queryId });\r\n  }\r\n\r\n  /**\r\n   * Cleanup completed queries\r\n   */\r\n  cleanup(olderThan: number = 3600000): void {\r\n    const cutoff = Date.now() - olderThan;\r\n\r\n    for (const [queryId, controlled] of this.controlledQueries.entries()) {\r\n      const endTime = controlled.terminatedAt || controlled.startTime;\r\n\r\n      if (controlled.status === 'completed' || controlled.status === 'terminated') {\r\n        if (endTime < cutoff) {\r\n          this.unregisterQuery(queryId);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Shutdown controller\r\n   */\r\n  shutdown(): void {\r\n    // Stop all monitoring\r\n    for (const queryId of this.monitoringIntervals.keys()) {\r\n      this.stopMonitoring(queryId);\r\n    }\r\n\r\n    // Clear all data\r\n    this.controlledQueries.clear();\r\n    this.commandQueue.clear();\r\n\r\n    this.logger.info('Query controller shutdown complete');\r\n  }\r\n}"],"names":["EventEmitter","Logger","RealTimeQueryController","logger","controlledQueries","Map","monitoringIntervals","commandQueue","options","allowPause","allowModelChange","allowPermissionChange","monitoringInterval","level","format","destination","component","registerQuery","queryId","agentId","query","controlled","status","isPaused","canControl","startTime","Date","now","set","startMonitoring","info","emit","pauseQuery","reason","Error","get","warn","interrupt","pausedAt","error","message","String","resumeQuery","resumedAt","terminateQuery","terminatedAt","stopMonitoring","changeModel","model","setModel","currentModel","changePermissionMode","mode","setPermissionMode","permissionMode","getSupportedModels","supportedModels","executeCommand","command","debug","type","params","queueCommand","queue","push","processQueuedCommands","length","commandCount","shift","delete","getQueryStatus","getAllQueries","interval","setInterval","update","timestamp","metadata","duration","clearInterval","unregisterQuery","cleanup","olderThan","cutoff","entries","endTime","shutdown","keys","clear"],"mappings":"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"}
{"version":3,"sources":["../../../src/cli/runtime-detector.js"],"sourcesContent":["/**\r\n * Runtime Environment Detection\r\n * Cross-platform detection and compatibility layer for Node.js and Deno\r\n */\r\n\r\n// Runtime detection\r\nconst isNode = typeof process !== 'undefined' && process.versions && process.versions.node;\r\nconst isDeno = typeof Deno !== 'undefined';\r\n\r\n// Environment-specific imports\r\nlet runtime;\r\nlet stdin, stdout, stderr;\r\nlet TextEncoder, TextDecoder;\r\nlet exit, pid, addSignalListener;\r\n\r\nif (isDeno) {\r\n  // Deno environment\r\n  runtime = 'deno';\r\n  stdin = Deno.stdin;\r\n  stdout = Deno.stdout;\r\n  stderr = Deno.stderr;\r\n  TextEncoder = globalThis.TextEncoder;\r\n  TextDecoder = globalThis.TextDecoder;\r\n  exit = Deno.exit;\r\n  pid = Deno.pid;\r\n  addSignalListener = Deno.addSignalListener;\r\n} else if (isNode) {\r\n  // Node.js environment\r\n  runtime = 'node';\r\n  stdin = process.stdin;\r\n  stdout = process.stdout;\r\n  stderr = process.stderr;\r\n  TextEncoder = globalThis.TextEncoder || require('util').TextEncoder;\r\n  TextDecoder = globalThis.TextDecoder || require('util').TextDecoder;\r\n  exit = process.exit;\r\n  pid = process.pid;\r\n  addSignalListener = (signal, handler) => {\r\n    process.on(signal, handler);\r\n  };\r\n} else {\r\n  throw new Error('Unsupported runtime environment');\r\n}\r\n\r\n/**\r\n * Cross-platform terminal I/O layer\r\n */\r\nexport class UnifiedTerminalIO {\r\n  constructor() {\r\n    this.decoder = new TextDecoder();\r\n    this.encoder = new TextEncoder();\r\n    this.runtime = runtime;\r\n  }\r\n\r\n  /**\r\n   * Write to stdout\r\n   */\r\n  async write(data) {\r\n    if (typeof data === 'string') {\r\n      data = this.encoder.encode(data);\r\n    }\r\n\r\n    if (runtime === 'deno') {\r\n      await stdout.write(data);\r\n    } else {\r\n      return new Promise((resolve) => {\r\n        stdout.write(data, resolve);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Read from stdin\r\n   */\r\n  async read(buffer) {\r\n    if (runtime === 'deno') {\r\n      return await stdin.read(buffer);\r\n    } else {\r\n      return new Promise((resolve) => {\r\n        let data = '';\r\n        const onData = (chunk) => {\r\n          data += chunk;\r\n          if (data.includes('\\n')) {\r\n            stdin.removeListener('data', onData);\r\n            const encoded = this.encoder.encode(data);\r\n            const bytesToCopy = Math.min(encoded.length, buffer.length);\r\n            buffer.set(encoded.slice(0, bytesToCopy));\r\n            resolve(bytesToCopy);\r\n          }\r\n        };\r\n\r\n        // Only set raw mode if available (terminal environments)\r\n        if (stdin.setRawMode && typeof stdin.setRawMode === 'function') {\r\n          try {\r\n            stdin.setRawMode(true);\r\n          } catch (err) {\r\n            // Ignore errors if not in a TTY\r\n          }\r\n        }\r\n\r\n        if (stdin.resume && typeof stdin.resume === 'function') {\r\n          stdin.resume();\r\n        }\r\n\r\n        stdin.on('data', onData);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set up signal handlers\r\n   */\r\n  onSignal(signal, handler) {\r\n    if (runtime === 'deno') {\r\n      addSignalListener(signal, handler);\r\n    } else {\r\n      process.on(signal, handler);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Exit the process\r\n   */\r\n  exit(code = 0) {\r\n    exit(code);\r\n  }\r\n\r\n  /**\r\n   * Get process ID\r\n   */\r\n  getPid() {\r\n    return pid;\r\n  }\r\n\r\n  /**\r\n   * Set raw mode for stdin (Node.js only)\r\n   */\r\n  setRawMode(enabled) {\r\n    if (runtime === 'node' && stdin.setRawMode && typeof stdin.setRawMode === 'function') {\r\n      try {\r\n        stdin.setRawMode(enabled);\r\n      } catch (err) {\r\n        // Ignore errors if not in a TTY\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resume stdin (Node.js only)\r\n   */\r\n  resume() {\r\n    if (runtime === 'node' && stdin.resume) {\r\n      stdin.resume();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Pause stdin (Node.js only)\r\n   */\r\n  pause() {\r\n    if (runtime === 'node' && stdin.pause) {\r\n      stdin.pause();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Environment detection utilities\r\n */\r\nexport const RuntimeDetector = {\r\n  isNode: () => isNode,\r\n  isDeno: () => isDeno,\r\n  getRuntime: () => runtime,\r\n\r\n  /**\r\n   * Get platform-specific information\r\n   */\r\n  getPlatform: () => {\r\n    if (runtime === 'deno') {\r\n      return {\r\n        os: Deno.build.os,\r\n        arch: Deno.build.arch,\r\n        target: Deno.build.target,\r\n      };\r\n    } else {\r\n      return {\r\n        os:\r\n          process.platform === 'win32'\r\n            ? 'windows'\r\n            : process.platform === 'darwin'\r\n              ? 'darwin'\r\n              : process.platform === 'linux'\r\n                ? 'linux'\r\n                : process.platform,\r\n        arch: process.arch,\r\n        target: `${process.arch}-${process.platform}`,\r\n      };\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Check if API is available\r\n   */\r\n  hasAPI: (apiName) => {\r\n    switch (apiName) {\r\n      case 'deno':\r\n        return isDeno;\r\n      case 'node':\r\n        return isNode;\r\n      case 'fs':\r\n        return runtime === 'node' || (runtime === 'deno' && typeof Deno.readFile !== 'undefined');\r\n      case 'process':\r\n        return runtime === 'node' || (runtime === 'deno' && typeof Deno.run !== 'undefined');\r\n      default:\r\n        return false;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Get environment variables\r\n   */\r\n  getEnv: (key) => {\r\n    if (runtime === 'deno') {\r\n      return process.env[key];\r\n    } else {\r\n      return process.env[key];\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Set environment variables\r\n   */\r\n  setEnv: (key, value) => {\r\n    if (runtime === 'deno') {\r\n      process.env[key] = value;\r\n    } else {\r\n      process.env[key] = value;\r\n    }\r\n  },\r\n};\r\n\r\n/**\r\n * Cross-platform compatibility layer\r\n */\r\nexport const createCompatibilityLayer = () => {\r\n  return {\r\n    runtime,\r\n    terminal: new UnifiedTerminalIO(),\r\n    detector: RuntimeDetector,\r\n\r\n    // Unified APIs\r\n    TextEncoder,\r\n    TextDecoder,\r\n\r\n    // Platform info\r\n    platform: RuntimeDetector.getPlatform(),\r\n\r\n    // Environment\r\n    getEnv: RuntimeDetector.getEnv,\r\n    setEnv: RuntimeDetector.setEnv,\r\n\r\n    // Process control\r\n    exit,\r\n    pid,\r\n\r\n    // Graceful degradation helpers\r\n    safeCall: async (fn, fallback = null) => {\r\n      try {\r\n        return await fn();\r\n      } catch (error) {\r\n        console.warn(`Runtime compatibility warning: ${error.message}`);\r\n        return fallback;\r\n      }\r\n    },\r\n\r\n    // Feature detection\r\n    hasFeature: (feature) => {\r\n      return RuntimeDetector.hasAPI(feature);\r\n    },\r\n  };\r\n};\r\n\r\n// Export the compatibility layer instance\r\nexport const compat = createCompatibilityLayer();\r\n\r\n// Export runtime detection results\r\nexport { runtime, isNode, isDeno };\r\n"],"names":["isNode","process","versions","node","isDeno","Deno","runtime","stdin","stdout","stderr","TextEncoder","TextDecoder","exit","pid","addSignalListener","globalThis","require","signal","handler","on","Error","UnifiedTerminalIO","decoder","encoder","write","data","encode","Promise","resolve","read","buffer","onData","chunk","includes","removeListener","encoded","bytesToCopy","Math","min","length","set","slice","setRawMode","err","resume","onSignal","code","getPid","enabled","pause","RuntimeDetector","getRuntime","getPlatform","os","build","arch","target","platform","hasAPI","apiName","readFile","run","getEnv","key","env","setEnv","value","createCompatibilityLayer","terminal","detector","safeCall","fn","fallback","error","console","warn","message","hasFeature","feature","compat"],"mappings":"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"}
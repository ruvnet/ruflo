{"version":3,"sources":["../../../../src/cli/simple-commands/claude-track.js"],"sourcesContent":["#!/usr/bin/env node\r\n\r\n/**\r\n * Claude Token Tracking - Extracts token usage from Claude sessions\r\n * Works in background without interfering with Claude CLI\r\n */\r\n\r\nimport { spawn } from 'child_process';\r\nimport { trackTokens } from './token-tracker.js';\r\n\r\n/**\r\n * Parse token information from Claude telemetry output\r\n */\r\nfunction parseTokensFromTelemetry(data) {\r\n  try {\r\n    // Look for lines containing token information\r\n    const lines = data.split('\\n');\r\n    \r\n    for (const line of lines) {\r\n      if (line.includes('api_request') && line.includes('attributes')) {\r\n        // Try to extract from structured output\r\n        const match = line.match(/input_tokens['\":\\s]+(\\d+).*output_tokens['\":\\s]+(\\d+)/);\r\n        if (match) {\r\n          return {\r\n            inputTokens: parseInt(match[1]),\r\n            outputTokens: parseInt(match[2])\r\n          };\r\n        }\r\n      }\r\n      \r\n      // Also look for simpler patterns\r\n      if (line.includes('input_tokens:') || line.includes('output_tokens:')) {\r\n        const inputMatch = line.match(/input_tokens:\\s*'?(\\d+)'?/);\r\n        const outputMatch = line.match(/output_tokens:\\s*'?(\\d+)'?/);\r\n        \r\n        if (inputMatch || outputMatch) {\r\n          return {\r\n            inputTokens: inputMatch ? parseInt(inputMatch[1]) : 0,\r\n            outputTokens: outputMatch ? parseInt(outputMatch[1]) : 0\r\n          };\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    // Silently ignore parse errors\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Background token tracker for Claude sessions\r\n */\r\nexport async function trackClaudeSession() {\r\n  console.log('ðŸ” Claude token tracker started (running in background)');\r\n  console.log('   Token usage will be saved to .claude-flow/metrics/token-usage.json');\r\n  \r\n  let totalInput = 0;\r\n  let totalOutput = 0;\r\n  let lastUpdate = Date.now();\r\n  \r\n  // Monitor Claude's telemetry output\r\n  process.stdin.on('data', async (data) => {\r\n    const output = data.toString();\r\n    const tokens = parseTokensFromTelemetry(output);\r\n    \r\n    if (tokens && (tokens.inputTokens > 0 || tokens.outputTokens > 0)) {\r\n      totalInput += tokens.inputTokens;\r\n      totalOutput += tokens.outputTokens;\r\n      \r\n      // Track tokens\r\n      await trackTokens({\r\n        sessionId: `claude-session-${Date.now()}`,\r\n        agentType: 'claude-cli',\r\n        command: 'interactive',\r\n        inputTokens: tokens.inputTokens,\r\n        outputTokens: tokens.outputTokens,\r\n        metadata: {\r\n          source: 'telemetry_stream'\r\n        }\r\n      });\r\n      \r\n      // Show update every 10 seconds max\r\n      if (Date.now() - lastUpdate > 10000) {\r\n        console.log(`ðŸ“Š Token Update: Input: ${totalInput}, Output: ${totalOutput}`);\r\n        lastUpdate = Date.now();\r\n      }\r\n    }\r\n  });\r\n  \r\n  // Handle shutdown\r\n  process.on('SIGINT', () => {\r\n    console.log(`\\nðŸ“Š Session Total: Input: ${totalInput}, Output: ${totalOutput}`);\r\n    console.log('âœ… Token tracking data saved');\r\n    process.exit(0);\r\n  });\r\n}\r\n\r\n// CLI interface\r\nif (import.meta.url === `file://${process.argv[1]}`) {\r\n  trackClaudeSession();\r\n}"],"names":["trackTokens","parseTokensFromTelemetry","data","lines","split","line","includes","match","inputTokens","parseInt","outputTokens","inputMatch","outputMatch","error","trackClaudeSession","console","log","totalInput","totalOutput","lastUpdate","Date","now","process","stdin","on","output","toString","tokens","sessionId","agentType","command","metadata","source","exit","url","argv"],"mappings":";AAQA,SAASA,WAAW,QAAQ,qBAAqB;AAKjD,SAASC,yBAAyBC,IAAI;IACpC,IAAI;QAEF,MAAMC,QAAQD,KAAKE,KAAK,CAAC;QAEzB,KAAK,MAAMC,QAAQF,MAAO;YACxB,IAAIE,KAAKC,QAAQ,CAAC,kBAAkBD,KAAKC,QAAQ,CAAC,eAAe;gBAE/D,MAAMC,QAAQF,KAAKE,KAAK,CAAC;gBACzB,IAAIA,OAAO;oBACT,OAAO;wBACLC,aAAaC,SAASF,KAAK,CAAC,EAAE;wBAC9BG,cAAcD,SAASF,KAAK,CAAC,EAAE;oBACjC;gBACF;YACF;YAGA,IAAIF,KAAKC,QAAQ,CAAC,oBAAoBD,KAAKC,QAAQ,CAAC,mBAAmB;gBACrE,MAAMK,aAAaN,KAAKE,KAAK,CAAC;gBAC9B,MAAMK,cAAcP,KAAKE,KAAK,CAAC;gBAE/B,IAAII,cAAcC,aAAa;oBAC7B,OAAO;wBACLJ,aAAaG,aAAaF,SAASE,UAAU,CAAC,EAAE,IAAI;wBACpDD,cAAcE,cAAcH,SAASG,WAAW,CAAC,EAAE,IAAI;oBACzD;gBACF;YACF;QACF;IACF,EAAE,OAAOC,OAAO,CAEhB;IAEA,OAAO;AACT;AAKA,OAAO,eAAeC;IACpBC,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC;IAEZ,IAAIC,aAAa;IACjB,IAAIC,cAAc;IAClB,IAAIC,aAAaC,KAAKC,GAAG;IAGzBC,QAAQC,KAAK,CAACC,EAAE,CAAC,QAAQ,OAAOtB;QAC9B,MAAMuB,SAASvB,KAAKwB,QAAQ;QAC5B,MAAMC,SAAS1B,yBAAyBwB;QAExC,IAAIE,UAAWA,CAAAA,OAAOnB,WAAW,GAAG,KAAKmB,OAAOjB,YAAY,GAAG,CAAA,GAAI;YACjEO,cAAcU,OAAOnB,WAAW;YAChCU,eAAeS,OAAOjB,YAAY;YAGlC,MAAMV,YAAY;gBAChB4B,WAAW,CAAC,eAAe,EAAER,KAAKC,GAAG,IAAI;gBACzCQ,WAAW;gBACXC,SAAS;gBACTtB,aAAamB,OAAOnB,WAAW;gBAC/BE,cAAciB,OAAOjB,YAAY;gBACjCqB,UAAU;oBACRC,QAAQ;gBACV;YACF;YAGA,IAAIZ,KAAKC,GAAG,KAAKF,aAAa,OAAO;gBACnCJ,QAAQC,GAAG,CAAC,CAAC,wBAAwB,EAAEC,WAAW,UAAU,EAAEC,aAAa;gBAC3EC,aAAaC,KAAKC,GAAG;YACvB;QACF;IACF;IAGAC,QAAQE,EAAE,CAAC,UAAU;QACnBT,QAAQC,GAAG,CAAC,CAAC,2BAA2B,EAAEC,WAAW,UAAU,EAAEC,aAAa;QAC9EH,QAAQC,GAAG,CAAC;QACZM,QAAQW,IAAI,CAAC;IACf;AACF;AAGA,IAAI,YAAYC,GAAG,KAAK,CAAC,OAAO,EAAEZ,QAAQa,IAAI,CAAC,EAAE,EAAE,EAAE;IACnDrB;AACF"}
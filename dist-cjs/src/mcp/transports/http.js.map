{"version":3,"sources":["../../../../src/mcp/transports/http.ts"],"sourcesContent":["/**\r\n * HTTP transport for MCP\r\n */\r\n\r\nimport express, { Express, Request, Response } from 'express';\r\nimport { createServer, Server } from 'node:http';\r\nimport { WebSocketServer, WebSocket } from 'ws';\r\nimport cors from 'cors';\r\nimport helmet from 'helmet';\r\nimport { join, dirname } from 'node:path';\r\nimport { fileURLToPath } from 'node:url';\r\nimport type { ITransport, RequestHandler, NotificationHandler } from './base.js';\r\nimport type { MCPRequest, MCPResponse, MCPNotification, MCPConfig } from '../../utils/types.js';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport { MCPTransportError } from '../../utils/errors.js';\r\n\r\n/**\r\n * HTTP transport implementation\r\n */\r\nexport class HttpTransport implements ITransport {\r\n  private requestHandler?: RequestHandler;\r\n  private notificationHandler?: NotificationHandler;\r\n  private app: Express;\r\n  private server?: Server;\r\n  private wss?: WebSocketServer;\r\n  private messageCount = 0;\r\n  private notificationCount = 0;\r\n  private running = false;\r\n  private connections = new Set<WebSocket>();\r\n  private activeWebSockets = new Set<WebSocket>();\r\n\r\n  constructor(\r\n    private host: string,\r\n    private port: number,\r\n    private tlsEnabled: boolean,\r\n    private logger: ILogger,\r\n    private config?: MCPConfig,\r\n  ) {\r\n    this.app = express();\r\n    this.setupMiddleware();\r\n    this.setupRoutes();\r\n  }\r\n\r\n  async start(): Promise<void> {\r\n    if (this.running) {\r\n      throw new MCPTransportError('Transport already running');\r\n    }\r\n\r\n    this.logger.info('Starting HTTP transport', {\r\n      host: this.host,\r\n      port: this.port,\r\n      tls: this.tlsEnabled,\r\n    });\r\n\r\n    try {\r\n      // Create HTTP server\r\n      this.server = createServer(this.app);\r\n\r\n      // Create WebSocket server\r\n      this.wss = new WebSocketServer({\r\n        server: this.server,\r\n        path: '/ws',\r\n      });\r\n\r\n      this.setupWebSocketHandlers();\r\n\r\n      // Start server\r\n      await new Promise<void>((resolve, reject) => {\r\n        this.server!.listen(this.port, this.host, () => {\r\n          this.logger.info(`HTTP server listening on ${this.host}:${this.port}`);\r\n          resolve();\r\n        });\r\n\r\n        this.server!.on('error', reject);\r\n      });\r\n\r\n      this.running = true;\r\n      this.logger.info('HTTP transport started');\r\n    } catch (error) {\r\n      throw new MCPTransportError('Failed to start HTTP transport', { error });\r\n    }\r\n  }\r\n\r\n  async stop(): Promise<void> {\r\n    if (!this.running) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Stopping HTTP transport');\r\n\r\n    this.running = false;\r\n\r\n    // Close all WebSocket connections\r\n    for (const ws of this.activeWebSockets) {\r\n      try {\r\n        ws.close();\r\n      } catch {\r\n        // Ignore errors\r\n      }\r\n    }\r\n    this.activeWebSockets.clear();\r\n    this.connections.clear();\r\n\r\n    // Close WebSocket server\r\n    if (this.wss) {\r\n      this.wss.close();\r\n      this.wss = undefined;\r\n    }\r\n\r\n    // Shutdown HTTP server\r\n    if (this.server) {\r\n      await new Promise<void>((resolve) => {\r\n        this.server!.close(() => resolve());\r\n      });\r\n      this.server = undefined;\r\n    }\r\n\r\n    this.logger.info('HTTP transport stopped');\r\n  }\r\n\r\n  onRequest(handler: RequestHandler): void {\r\n    this.requestHandler = handler;\r\n  }\r\n\r\n  onNotification(handler: NotificationHandler): void {\r\n    this.notificationHandler = handler;\r\n  }\r\n\r\n  async getHealthStatus(): Promise<{\r\n    healthy: boolean;\r\n    error?: string;\r\n    metrics?: Record<string, number>;\r\n  }> {\r\n    return {\r\n      healthy: this.running,\r\n      metrics: {\r\n        messagesReceived: this.messageCount,\r\n        notificationsSent: this.notificationCount,\r\n        activeConnections: this.connections.size,\r\n        activeWebSockets: this.activeWebSockets.size,\r\n      },\r\n    };\r\n  }\r\n\r\n  private setupMiddleware(): void {\r\n    // Security middleware\r\n    this.app.use(helmet());\r\n\r\n    // CORS middleware\r\n    if (this.config?.corsEnabled) {\r\n      const origins = this.config.corsOrigins || ['*'];\r\n      this.app.use(\r\n        cors({\r\n          origin: origins,\r\n          credentials: true,\r\n          maxAge: 86400, // 24 hours\r\n        }),\r\n      );\r\n    }\r\n\r\n    // Body parsing middleware\r\n    this.app.use(express.json({ limit: '10mb' }));\r\n    this.app.use(express.text());\r\n  }\r\n\r\n  private setupRoutes(): void {\r\n    // Get current file directory for static files\r\n    const __filename =\r\n      typeof import.meta?.url !== 'undefined'\r\n        ? fileURLToPath(import.meta.url)\r\n        : __filename || __dirname + '/http.ts';\r\n    const __dirname = dirname(__filename);\r\n    const consoleDir = join(__dirname, '../../ui/console');\r\n\r\n    // Serve static files for the web console\r\n    this.app.use('/console', express.static(consoleDir));\r\n\r\n    // Web console route\r\n    this.app.get('/', (req, res) => {\r\n      res.redirect('/console');\r\n    });\r\n\r\n    this.app.get('/console', (req, res) => {\r\n      res.sendFile(join(consoleDir, 'index.html'));\r\n    });\r\n\r\n    // Health check endpoint\r\n    this.app.get('/health', (req, res) => {\r\n      res.json({ status: 'ok', timestamp: new Date().toISOString() });\r\n    });\r\n\r\n    // MCP JSON-RPC endpoint\r\n    this.app.post('/rpc', async (req, res) => {\r\n      await this.handleJsonRpcRequest(req, res);\r\n    });\r\n\r\n    // Handle preflight requests\r\n    this.app.options('*', (req, res) => {\r\n      res.status(204).end();\r\n    });\r\n\r\n    // 404 handler\r\n    this.app.use((req, res) => {\r\n      res.status(404).json({ error: 'Not found' });\r\n    });\r\n\r\n    // Error handler\r\n    this.app.use(\r\n      (err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {\r\n        this.logger.error('Express error', err);\r\n        res.status(500).json({\r\n          error: 'Internal server error',\r\n          message: err.message,\r\n        });\r\n      },\r\n    );\r\n  }\r\n\r\n  private setupWebSocketHandlers(): void {\r\n    if (!this.wss) return;\r\n\r\n    this.wss.on('connection', (ws: WebSocket, req) => {\r\n      this.activeWebSockets.add(ws);\r\n      this.logger.info('WebSocket client connected', {\r\n        totalClients: this.activeWebSockets.size,\r\n      });\r\n\r\n      ws.on('close', () => {\r\n        this.activeWebSockets.delete(ws);\r\n        this.logger.info('WebSocket client disconnected', {\r\n          totalClients: this.activeWebSockets.size,\r\n        });\r\n      });\r\n\r\n      ws.on('error', (error) => {\r\n        this.logger.error('WebSocket error', error);\r\n        this.activeWebSockets.delete(ws);\r\n      });\r\n\r\n      ws.on('message', async (data) => {\r\n        try {\r\n          const message = JSON.parse(data.toString());\r\n\r\n          if (message.id === undefined) {\r\n            // Notification from client\r\n            await this.handleNotificationMessage(message as MCPNotification);\r\n          } else {\r\n            // Request from client\r\n            const response = await this.handleRequestMessage(message as MCPRequest);\r\n            ws.send(JSON.stringify(response));\r\n          }\r\n        } catch (error) {\r\n          this.logger.error('Error processing WebSocket message', error);\r\n\r\n          // Send error response if it was a request\r\n          try {\r\n            const parsed = JSON.parse(data.toString());\r\n            if (parsed.id !== undefined) {\r\n              ws.send(\r\n                JSON.stringify({\r\n                  jsonrpc: '2.0',\r\n                  id: parsed.id,\r\n                  error: {\r\n                    code: -32603,\r\n                    message: 'Internal error',\r\n                  },\r\n                }),\r\n              );\r\n            }\r\n          } catch {\r\n            // Ignore parse errors for error responses\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private async handleJsonRpcRequest(req: Request, res: Response): Promise<void> {\r\n    // Check content type\r\n    if (!req.is('application/json')) {\r\n      res.status(400).json({\r\n        jsonrpc: '2.0',\r\n        id: null,\r\n        error: {\r\n          code: -32600,\r\n          message: 'Invalid content type - expected application/json',\r\n        },\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Check authorization if authentication is enabled\r\n    if (this.config?.auth?.enabled) {\r\n      const authResult = await this.validateAuth(req);\r\n      if (!authResult.valid) {\r\n        res.status(401).json({\r\n          error: authResult.error || 'Unauthorized',\r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    try {\r\n      const mcpMessage = req.body;\r\n\r\n      // Validate JSON-RPC format\r\n      if (!mcpMessage.jsonrpc || mcpMessage.jsonrpc !== '2.0') {\r\n        res.status(400).json({\r\n          jsonrpc: '2.0',\r\n          id: mcpMessage.id || null,\r\n          error: {\r\n            code: -32600,\r\n            message: 'Invalid request - missing or invalid jsonrpc version',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!mcpMessage.method) {\r\n        res.status(400).json({\r\n          jsonrpc: '2.0',\r\n          id: mcpMessage.id || null,\r\n          error: {\r\n            code: -32600,\r\n            message: 'Invalid request - missing method',\r\n          },\r\n        });\r\n        return;\r\n      }\r\n\r\n      this.messageCount++;\r\n\r\n      // Check if this is a notification (no id) or request\r\n      if (mcpMessage.id === undefined) {\r\n        // Handle notification\r\n        await this.handleNotificationMessage(mcpMessage as MCPNotification);\r\n        // Notifications don't get responses\r\n        res.status(204).end();\r\n      } else {\r\n        // Handle request\r\n        const response = await this.handleRequestMessage(mcpMessage as MCPRequest);\r\n        res.json(response);\r\n      }\r\n    } catch (error) {\r\n      this.logger.error('Error handling JSON-RPC request', error);\r\n\r\n      res.status(500).json({\r\n        jsonrpc: '2.0',\r\n        id: null,\r\n        error: {\r\n          code: -32603,\r\n          message: 'Internal error',\r\n          data: error instanceof Error ? error.message : String(error),\r\n        },\r\n      });\r\n    }\r\n  }\r\n\r\n  private async handleRequestMessage(request: MCPRequest): Promise<MCPResponse> {\r\n    if (!this.requestHandler) {\r\n      return {\r\n        jsonrpc: '2.0',\r\n        id: request.id,\r\n        error: {\r\n          code: -32603,\r\n          message: 'No request handler registered',\r\n        },\r\n      };\r\n    }\r\n\r\n    try {\r\n      return await this.requestHandler(request);\r\n    } catch (error) {\r\n      this.logger.error('Request handler error', { request, error });\r\n\r\n      return {\r\n        jsonrpc: '2.0',\r\n        id: request.id,\r\n        error: {\r\n          code: -32603,\r\n          message: 'Internal error',\r\n          data: error instanceof Error ? error.message : String(error),\r\n        },\r\n      };\r\n    }\r\n  }\r\n\r\n  private async handleNotificationMessage(notification: MCPNotification): Promise<void> {\r\n    if (!this.notificationHandler) {\r\n      this.logger.warn('Received notification but no handler registered', {\r\n        method: notification.method,\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await this.notificationHandler(notification);\r\n    } catch (error) {\r\n      this.logger.error('Notification handler error', { notification, error });\r\n      // Notifications don't send error responses\r\n    }\r\n  }\r\n\r\n  private async validateAuth(req: Request): Promise<{ valid: boolean; error?: string }> {\r\n    const auth = req.headers.authorization;\r\n\r\n    if (!auth) {\r\n      return { valid: false, error: 'Authorization header required' };\r\n    }\r\n\r\n    // Extract token from Authorization header\r\n    const tokenMatch = auth.match(/^Bearer\\s+(.+)$/i);\r\n    if (!tokenMatch) {\r\n      return { valid: false, error: 'Invalid authorization format - use Bearer token' };\r\n    }\r\n\r\n    const token = tokenMatch[1];\r\n\r\n    // Validate against configured tokens\r\n    if (this.config?.auth?.tokens && this.config.auth.tokens.length > 0) {\r\n      const isValid = this.config.auth.tokens.includes(token);\r\n      if (!isValid) {\r\n        return { valid: false, error: 'Invalid token' };\r\n      }\r\n    }\r\n\r\n    return { valid: true };\r\n  }\r\n\r\n  async connect(): Promise<void> {\r\n    // For HTTP transport, connect is handled by start()\r\n    if (!this.running) {\r\n      await this.start();\r\n    }\r\n  }\r\n\r\n  async disconnect(): Promise<void> {\r\n    // For HTTP transport, disconnect is handled by stop()\r\n    await this.stop();\r\n  }\r\n\r\n  async sendRequest(request: MCPRequest): Promise<MCPResponse> {\r\n    // HTTP transport is server-side, it doesn't send requests\r\n    throw new Error('HTTP transport does not support sending requests');\r\n  }\r\n\r\n  async sendNotification(notification: MCPNotification): Promise<void> {\r\n    // Broadcast notification to all connected WebSocket clients\r\n    const message = JSON.stringify(notification);\r\n\r\n    for (const ws of this.activeWebSockets) {\r\n      try {\r\n        if (ws.readyState === WebSocket.OPEN) {\r\n          ws.send(message);\r\n        }\r\n      } catch (error) {\r\n        this.logger.error('Failed to send notification to WebSocket', error);\r\n      }\r\n    }\r\n\r\n    this.notificationCount++;\r\n  }\r\n}\r\n"],"names":["express","createServer","WebSocketServer","WebSocket","cors","helmet","join","dirname","fileURLToPath","MCPTransportError","HttpTransport","requestHandler","notificationHandler","app","server","wss","messageCount","notificationCount","running","connections","Set","activeWebSockets","host","port","tlsEnabled","logger","config","setupMiddleware","setupRoutes","start","info","tls","path","setupWebSocketHandlers","Promise","resolve","reject","listen","on","error","stop","ws","close","clear","undefined","onRequest","handler","onNotification","getHealthStatus","healthy","metrics","messagesReceived","notificationsSent","activeConnections","size","use","corsEnabled","origins","corsOrigins","origin","credentials","maxAge","json","limit","text","__filename","url","__dirname","consoleDir","static","get","req","res","redirect","sendFile","status","timestamp","Date","toISOString","post","handleJsonRpcRequest","options","end","err","next","message","add","totalClients","delete","data","JSON","parse","toString","id","handleNotificationMessage","response","handleRequestMessage","send","stringify","parsed","jsonrpc","code","is","auth","enabled","authResult","validateAuth","valid","mcpMessage","body","method","Error","String","request","notification","warn","headers","authorization","tokenMatch","match","token","tokens","length","isValid","includes","connect","disconnect","sendRequest","sendNotification","readyState","OPEN"],"mappings":"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"}
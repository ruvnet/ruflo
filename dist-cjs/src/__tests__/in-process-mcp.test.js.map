{"version":3,"sources":["../../../src/__tests__/in-process-mcp.test.ts"],"sourcesContent":["/**\r\n * Comprehensive Test Suite for In-Process MCP Server\r\n *\r\n * Tests in-process MCP server implementation, SDK integration,\r\n * performance improvements, and tool routing.\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';\r\nimport { InProcessMCPServer, createInProcessServer } from '../mcp/in-process-server.js';\r\nimport { ClaudeFlowToolRegistry, createToolRegistry } from '../mcp/tool-registry.js';\r\nimport {\r\n  SDKIntegration,\r\n  initializeSDKIntegration,\r\n  measurePerformance,\r\n} from '../mcp/sdk-integration.js';\r\nimport type { MCPTool } from '../utils/types.js';\r\n\r\ndescribe('InProcessMCPServer', () => {\r\n  let server: InProcessMCPServer;\r\n\r\n  beforeEach(() => {\r\n    server = createInProcessServer({\r\n      name: 'test-server',\r\n      version: '1.0.0',\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n    });\r\n  });\r\n\r\n  afterEach(() => {\r\n    server.clearMetrics();\r\n    server.clearCache();\r\n  });\r\n\r\n  describe('Tool Registration', () => {\r\n    it('should register a tool', () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/tool',\r\n        description: 'Test tool',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            message: { type: 'string' },\r\n          },\r\n          required: ['message'],\r\n        },\r\n        handler: async (args: any) => ({ result: `Hello ${args.message}` }),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      expect(server.getToolNames()).toContain('test/tool');\r\n    });\r\n\r\n    it('should unregister a tool', () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/tool',\r\n        description: 'Test tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => ({ result: 'ok' }),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      expect(server.getToolNames()).toContain('test/tool');\r\n\r\n      const removed = server.unregisterTool('test/tool');\r\n      expect(removed).toBe(true);\r\n      expect(server.getToolNames()).not.toContain('test/tool');\r\n    });\r\n\r\n    it('should get tool metadata', () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/tool',\r\n        description: 'Test tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => ({ result: 'ok' }),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      const retrieved = server.getTool('test/tool');\r\n      expect(retrieved).toBeDefined();\r\n      expect(retrieved?.name).toBe('test/tool');\r\n    });\r\n  });\r\n\r\n  describe('Tool Execution', () => {\r\n    it('should execute a tool successfully', async () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/echo',\r\n        description: 'Echo tool',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            message: { type: 'string' },\r\n          },\r\n          required: ['message'],\r\n        },\r\n        handler: async (args: any) => ({ echo: args.message }),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n\r\n      const result = await server.callTool('test/echo', { message: 'Hello World' });\r\n\r\n      expect(result.isError).toBe(false);\r\n      expect(result.content[0].type).toBe('text');\r\n      expect(result.content[0].text).toContain('Hello World');\r\n    });\r\n\r\n    it('should handle tool execution errors', async () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/error',\r\n        description: 'Error tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          throw new Error('Test error');\r\n        },\r\n      };\r\n\r\n      server.registerTool(tool);\r\n\r\n      const result = await server.callTool('test/error', {});\r\n\r\n      expect(result.isError).toBe(true);\r\n      expect(result.content[0].text).toContain('Test error');\r\n    });\r\n\r\n    it('should throw error for non-existent tool', async () => {\r\n      const result = await server.callTool('non/existent', {});\r\n      expect(result.isError).toBe(true);\r\n      expect(result.content[0].text).toContain('Tool not found');\r\n    });\r\n  });\r\n\r\n  describe('Performance Metrics', () => {\r\n    it('should record metrics for tool calls', async () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/metric',\r\n        description: 'Metric test tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => ({ result: 'ok' }),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      await server.callTool('test/metric', {});\r\n\r\n      const metrics = server.getMetrics();\r\n      expect(metrics.length).toBeGreaterThan(0);\r\n      expect(metrics[0].toolName).toBe('test/metric');\r\n      expect(metrics[0].transport).toBe('in-process');\r\n    });\r\n\r\n    it('should calculate performance statistics', async () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/stats',\r\n        description: 'Stats test tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          await new Promise(resolve => setTimeout(resolve, 10));\r\n          return { result: 'ok' };\r\n        },\r\n      };\r\n\r\n      server.registerTool(tool);\r\n\r\n      // Execute multiple times\r\n      for (let i = 0; i < 5; i++) {\r\n        await server.callTool('test/stats', {});\r\n      }\r\n\r\n      const stats = server.getStats();\r\n      expect(stats.totalCalls).toBe(5);\r\n      expect(stats.toolStats['test/stats']).toBeDefined();\r\n      expect(stats.toolStats['test/stats'].totalCalls).toBe(5);\r\n      expect(stats.toolStats['test/stats'].successRate).toBe(1);\r\n    });\r\n\r\n    it('should track latency accurately', async () => {\r\n      const tool: MCPTool = {\r\n        name: 'test/latency',\r\n        description: 'Latency test tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async () => {\r\n          await new Promise(resolve => setTimeout(resolve, 5));\r\n          return { result: 'ok' };\r\n        },\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      await server.callTool('test/latency', {});\r\n\r\n      const metrics = server.getMetrics();\r\n      expect(metrics[0].duration).toBeGreaterThan(5);\r\n      expect(metrics[0].duration).toBeLessThan(50); // Should be fast\r\n    });\r\n  });\r\n\r\n  describe('Caching', () => {\r\n    it('should cache read-only tool results', async () => {\r\n      const mockHandler = vi.fn(async () => ({ result: 'cached' }));\r\n\r\n      const tool: MCPTool = {\r\n        name: 'agents/list',\r\n        description: 'List agents (cacheable)',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: mockHandler,\r\n      };\r\n\r\n      server.registerTool(tool);\r\n\r\n      // First call - should execute handler\r\n      await server.callTool('agents/list', {});\r\n      expect(mockHandler).toHaveBeenCalledTimes(1);\r\n\r\n      // Second call - should use cache\r\n      await server.callTool('agents/list', {});\r\n      expect(mockHandler).toHaveBeenCalledTimes(1); // Still 1, from cache\r\n    });\r\n\r\n    it('should not cache write operations', async () => {\r\n      const mockHandler = vi.fn(async () => ({ result: 'not cached' }));\r\n\r\n      const tool: MCPTool = {\r\n        name: 'agents/spawn',\r\n        description: 'Spawn agent (not cacheable)',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: mockHandler,\r\n      };\r\n\r\n      server.registerTool(tool);\r\n\r\n      await server.callTool('agents/spawn', {});\r\n      await server.callTool('agents/spawn', {});\r\n\r\n      expect(mockHandler).toHaveBeenCalledTimes(2);\r\n    });\r\n\r\n    it('should expire cache entries', async () => {\r\n      const mockHandler = vi.fn(async () => ({ result: 'expires' }));\r\n\r\n      const tool: MCPTool = {\r\n        name: 'system/status',\r\n        description: 'System status (short TTL)',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: mockHandler,\r\n      };\r\n\r\n      server.registerTool(tool);\r\n\r\n      // First call\r\n      await server.callTool('system/status', {});\r\n      expect(mockHandler).toHaveBeenCalledTimes(1);\r\n\r\n      // Wait for cache expiry (TTL = 2s for system/status)\r\n      await new Promise(resolve => setTimeout(resolve, 2100));\r\n\r\n      // Second call - cache expired, should execute again\r\n      await server.callTool('system/status', {});\r\n      expect(mockHandler).toHaveBeenCalledTimes(2);\r\n    });\r\n  });\r\n\r\n  describe('Context Management', () => {\r\n    it('should set and use execution context', async () => {\r\n      const mockOrchestrator = { id: 'test-orchestrator' };\r\n\r\n      server.setContext({\r\n        orchestrator: mockOrchestrator,\r\n        sessionId: 'test-session',\r\n      });\r\n\r\n      const tool: MCPTool = {\r\n        name: 'test/context',\r\n        description: 'Context test tool',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: async (args: any, context: any) => ({\r\n          orchestrator: context?.orchestrator?.id,\r\n          sessionId: context?.sessionId,\r\n        }),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      const result = await server.callTool('test/context', {});\r\n\r\n      expect(result.content[0].text).toContain('test-orchestrator');\r\n      expect(result.content[0].text).toContain('test-session');\r\n    });\r\n  });\r\n\r\n  describe('Server Info', () => {\r\n    it('should return server information', () => {\r\n      const info = server.getInfo();\r\n      expect(info.name).toBe('test-server');\r\n      expect(info.version).toBe('1.0.0');\r\n      expect(info.toolCount).toBe(0);\r\n      expect(Array.isArray(info.tools)).toBe(true);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('ClaudeFlowToolRegistry', () => {\r\n  let registry: ClaudeFlowToolRegistry;\r\n\r\n  beforeEach(async () => {\r\n    registry = await createToolRegistry({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n    });\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await registry.cleanup();\r\n  });\r\n\r\n  it('should load all Claude-Flow tools', async () => {\r\n    const toolNames = registry.getToolNames();\r\n    expect(toolNames.length).toBeGreaterThan(20); // At least 20+ tools\r\n\r\n    // Check for key tool categories\r\n    expect(toolNames.some(name => name.startsWith('agents/'))).toBe(true);\r\n    expect(toolNames.some(name => name.startsWith('tasks/'))).toBe(true);\r\n    expect(toolNames.some(name => name.startsWith('memory/'))).toBe(true);\r\n    expect(toolNames.some(name => name.startsWith('system/'))).toBe(true);\r\n  });\r\n\r\n  it('should route tool calls correctly', async () => {\r\n    const result = await registry.routeToolCall('agents/list', { includeTerminated: false });\r\n    expect(result).toBeDefined();\r\n  });\r\n\r\n  it('should provide SDK server config', () => {\r\n    const sdkServer = registry.getSdkServerConfig();\r\n    expect(sdkServer).toBeDefined();\r\n    expect(sdkServer?.type).toBe('sdk');\r\n    expect(sdkServer?.name).toBe('claude-flow');\r\n  });\r\n\r\n  it('should return performance metrics', () => {\r\n    const metrics = registry.getMetrics();\r\n    expect(metrics).toBeDefined();\r\n    expect('stats' in metrics || 'error' in metrics).toBe(true);\r\n  });\r\n});\r\n\r\ndescribe('SDKIntegration', () => {\r\n  let integration: SDKIntegration;\r\n\r\n  beforeEach(async () => {\r\n    integration = await initializeSDKIntegration({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n    });\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await integration.cleanup();\r\n  });\r\n\r\n  it('should initialize in-process server', () => {\r\n    expect(integration.isInProcessAvailable()).toBe(true);\r\n  });\r\n\r\n  it('should create query with in-process server', () => {\r\n    const query = integration.query('Test prompt', {\r\n      maxTurns: 1,\r\n    });\r\n\r\n    expect(query).toBeDefined();\r\n  });\r\n\r\n  it('should get SDK server config', () => {\r\n    const server = integration.getSdkServer();\r\n    expect(server).toBeDefined();\r\n    expect(server?.name).toBe('claude-flow');\r\n  });\r\n\r\n  it('should provide performance comparison', () => {\r\n    const comparison = integration.getPerformanceComparison();\r\n    expect(comparison).toBeDefined();\r\n  });\r\n});\r\n\r\ndescribe('Performance Benchmarks', () => {\r\n  it('should demonstrate 10-100x speedup vs IPC', async () => {\r\n    // Initialize in-process server\r\n    await initializeSDKIntegration({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: false, // Disable cache for accurate measurement\r\n    });\r\n\r\n    // Create a simple test tool\r\n    const registry = await createToolRegistry({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: false,\r\n    });\r\n\r\n    const inProcessServer = registry.getInProcessServer();\r\n    expect(inProcessServer).toBeDefined();\r\n\r\n    const testTool: MCPTool = {\r\n      name: 'test/benchmark',\r\n      description: 'Benchmark test tool',\r\n      inputSchema: { type: 'object', properties: {} },\r\n      handler: async () => ({ result: 'ok' }),\r\n    };\r\n\r\n    inProcessServer!.registerTool(testTool);\r\n\r\n    // Measure in-process latency\r\n    const iterations = 10;\r\n    const durations: number[] = [];\r\n\r\n    for (let i = 0; i < iterations; i++) {\r\n      const start = performance.now();\r\n      await inProcessServer!.callTool('test/benchmark', {});\r\n      durations.push(performance.now() - start);\r\n    }\r\n\r\n    const avgInProcessLatency =\r\n      durations.reduce((a, b) => a + b, 0) / durations.length;\r\n\r\n    // In-process should be < 5ms (typically < 1ms)\r\n    expect(avgInProcessLatency).toBeLessThan(5);\r\n\r\n    // Estimated IPC latency (conservative: 50x slower)\r\n    const estimatedIPCLatency = avgInProcessLatency * 50;\r\n\r\n    console.log('Performance Benchmark Results:');\r\n    console.log(`In-Process Latency: ${avgInProcessLatency.toFixed(2)}ms`);\r\n    console.log(`Estimated IPC Latency: ${estimatedIPCLatency.toFixed(2)}ms`);\r\n    console.log(`Speedup Factor: ${(estimatedIPCLatency / avgInProcessLatency).toFixed(1)}x`);\r\n\r\n    // Verify at least 10x improvement\r\n    expect(estimatedIPCLatency / avgInProcessLatency).toBeGreaterThan(10);\r\n  }, 30000); // 30s timeout for benchmark\r\n});\r\n\r\ndescribe('Fallback Behavior', () => {\r\n  it('should fallback to stdio when in-process fails', async () => {\r\n    const integration = new SDKIntegration({\r\n      enableInProcess: false, // Explicitly disabled\r\n      enableMetrics: false,\r\n      enableCaching: false,\r\n      fallbackToStdio: true,\r\n    });\r\n\r\n    await integration.initialize();\r\n\r\n    expect(integration.isInProcessAvailable()).toBe(false);\r\n  });\r\n});\r\n\r\ndescribe('Edge Cases', () => {\r\n  let server: InProcessMCPServer;\r\n\r\n  beforeEach(() => {\r\n    server = createInProcessServer({\r\n      name: 'edge-test',\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n    });\r\n  });\r\n\r\n  it('should handle concurrent tool calls', async () => {\r\n    const tool: MCPTool = {\r\n      name: 'test/concurrent',\r\n      description: 'Concurrent test',\r\n      inputSchema: { type: 'object', properties: {} },\r\n      handler: async () => {\r\n        await new Promise(resolve => setTimeout(resolve, 10));\r\n        return { result: 'ok' };\r\n      },\r\n    };\r\n\r\n    server.registerTool(tool);\r\n\r\n    // Execute 10 concurrent calls\r\n    const promises = Array.from({ length: 10 }, () =>\r\n      server.callTool('test/concurrent', {})\r\n    );\r\n\r\n    const results = await Promise.all(promises);\r\n    expect(results).toHaveLength(10);\r\n    expect(results.every(r => !r.isError)).toBe(true);\r\n  });\r\n\r\n  it('should handle large payloads', async () => {\r\n    const tool: MCPTool = {\r\n      name: 'test/large',\r\n      description: 'Large payload test',\r\n      inputSchema: { type: 'object', properties: {} },\r\n      handler: async (args: any) => ({ echo: args }),\r\n    };\r\n\r\n    server.registerTool(tool);\r\n\r\n    const largePayload = {\r\n      data: Array.from({ length: 1000 }, (_, i) => ({ id: i, value: `item-${i}` })),\r\n    };\r\n\r\n    const result = await server.callTool('test/large', largePayload);\r\n    expect(result.isError).toBe(false);\r\n  });\r\n\r\n  it('should handle rapid sequential calls', async () => {\r\n    const tool: MCPTool = {\r\n      name: 'test/rapid',\r\n      description: 'Rapid test',\r\n      inputSchema: { type: 'object', properties: {} },\r\n      handler: async () => ({ result: 'ok' }),\r\n    };\r\n\r\n    server.registerTool(tool);\r\n\r\n    // Execute 100 rapid sequential calls\r\n    for (let i = 0; i < 100; i++) {\r\n      await server.callTool('test/rapid', {});\r\n    }\r\n\r\n    const stats = server.getStats();\r\n    expect(stats.totalCalls).toBe(100);\r\n  });\r\n});"],"names":["describe","it","expect","beforeEach","afterEach","vi","createInProcessServer","createToolRegistry","SDKIntegration","initializeSDKIntegration","server","name","version","enableMetrics","enableCaching","clearMetrics","clearCache","tool","description","inputSchema","type","properties","message","required","handler","args","result","registerTool","getToolNames","toContain","removed","unregisterTool","toBe","not","retrieved","getTool","toBeDefined","echo","callTool","isError","content","text","Error","metrics","getMetrics","length","toBeGreaterThan","toolName","transport","Promise","resolve","setTimeout","i","stats","getStats","totalCalls","toolStats","successRate","duration","toBeLessThan","mockHandler","fn","toHaveBeenCalledTimes","mockOrchestrator","id","setContext","orchestrator","sessionId","context","info","getInfo","toolCount","Array","isArray","tools","registry","enableInProcess","cleanup","toolNames","some","startsWith","routeToolCall","includeTerminated","sdkServer","getSdkServerConfig","integration","isInProcessAvailable","query","maxTurns","getSdkServer","comparison","getPerformanceComparison","inProcessServer","getInProcessServer","testTool","iterations","durations","start","performance","now","push","avgInProcessLatency","reduce","a","b","estimatedIPCLatency","console","log","toFixed","fallbackToStdio","initialize","promises","from","results","all","toHaveLength","every","r","largePayload","data","_","value"],"mappings":"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"}
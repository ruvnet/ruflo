{"version":3,"sources":["../../../../../src/cli/commands/start/start-command.ts"],"sourcesContent":["import { promises as fs } from 'node:fs';\r\n/**\r\n * Unified start command implementation with robust service management\r\n */\r\n\r\nimport { Command } from '@cliffy/command';\r\nimport chalk from 'chalk';\r\nimport inquirer from 'inquirer';\r\nimport { ProcessManager } from './process-manager.js';\r\nimport { ProcessUI } from './process-ui.js';\r\nimport { SystemMonitor } from './system-monitor.js';\r\nimport type { StartOptions } from './types.js';\r\nimport { eventBus } from '../../../core/event-bus.js';\r\nimport { logger } from '../../../core/logger.js';\r\nimport { formatDuration } from '../../formatter.js';\r\n\r\nexport const startCommand = new Command()\r\n  .description('Start the Claude-Flow orchestration system')\r\n  .option('-d, --daemon', 'Run as daemon in background')\r\n  .option('-p, --port <port:number>', 'MCP server port', { default: 3000 })\r\n  .option('--mcp-transport <transport:string>', 'MCP transport type (stdio, http)', {\r\n    default: 'stdio',\r\n  })\r\n  .option('-u, --ui', 'Launch interactive process management UI')\r\n  .option('-v, --verbose', 'Enable verbose logging')\r\n  .option('--auto-start', 'Automatically start all processes')\r\n  .option('--config <path:string>', 'Configuration file path')\r\n  .option('--force', 'Force start even if already running')\r\n  .option('--health-check', 'Perform health checks before starting')\r\n  .option('--timeout <seconds:number>', 'Startup timeout in seconds', { default: 60 })\r\n  .action(async (options: StartOptions) => {\r\n    console.log(chalk.cyan('ðŸ§  Claude-Flow Orchestration System'));\r\n    console.log(chalk.gray('â”€'.repeat(60)));\r\n\r\n    try {\r\n      // Check if already running\r\n      if (!options.force && (await isSystemRunning())) {\r\n        console.log(chalk.yellow('âš  Claude-Flow is already running'));\r\n        const { shouldContinue } = await inquirer.prompt([\r\n          {\r\n            type: 'confirm',\r\n            name: 'shouldContinue',\r\n            message: 'Stop existing instance and restart?',\r\n            default: false,\r\n          },\r\n        ]);\r\n\r\n        if (!shouldContinue) {\r\n          console.log(chalk.gray('Use --force to override or \"claude-flow stop\" first'));\r\n          return;\r\n        }\r\n\r\n        await stopExistingInstance();\r\n      }\r\n\r\n      // Perform pre-flight checks\r\n      if (options.healthCheck) {\r\n        console.log(chalk.blue('Running pre-flight health checks...'));\r\n        await performHealthChecks();\r\n      }\r\n\r\n      // Initialize process manager with timeout\r\n      const processManager = new ProcessManager();\r\n      console.log(chalk.blue('Initializing system components...'));\r\n      const initPromise = processManager.initialize(options.config);\r\n      const timeoutPromise = new Promise((_, reject) =>\r\n        setTimeout(\r\n          () => reject(new Error('Initialization timeout')),\r\n          (options.timeout || 30) * 1000,\r\n        ),\r\n      );\r\n\r\n      await Promise.race([initPromise, timeoutPromise]);\r\n\r\n      // Initialize system monitor with enhanced monitoring\r\n      const systemMonitor = new SystemMonitor(processManager);\r\n      systemMonitor.start();\r\n\r\n      // Setup system event handlers\r\n      setupSystemEventHandlers(processManager, systemMonitor, options);\r\n\r\n      // Override MCP settings from CLI options\r\n      if (options.port) {\r\n        const mcpProcess = processManager.getProcess('mcp-server');\r\n        if (mcpProcess) {\r\n          mcpProcess.config = { ...mcpProcess.config, port: options.port };\r\n        }\r\n      }\r\n\r\n      // Configure transport settings\r\n      if (options.mcpTransport) {\r\n        const mcpProcess = processManager.getProcess('mcp-server');\r\n        if (mcpProcess) {\r\n          mcpProcess.config = { ...mcpProcess.config, transport: options.mcpTransport };\r\n        }\r\n      }\r\n\r\n      // Setup event listeners for logging\r\n      if (options.verbose) {\r\n        setupVerboseLogging(systemMonitor);\r\n      }\r\n\r\n      // Launch UI mode\r\n      if (options.ui) {\r\n        // Check if web server is available\r\n        try {\r\n          const { ClaudeCodeWebServer } = await import('../../simple-commands/web-server.js');\r\n\r\n          // Start the web server\r\n          console.log(chalk.blue('Starting Web UI server...'));\r\n          const webServer = new ClaudeCodeWebServer(options.port);\r\n          await webServer.start();\r\n\r\n          // Open browser if possible\r\n          const openCommand =\r\n            process.platform === 'darwin'\r\n              ? 'open'\r\n              : process.platform === 'win32'\r\n                ? 'start'\r\n                : 'xdg-open';\r\n\r\n          try {\r\n            const { exec } = await import('child_process');\r\n            exec(`${openCommand} http://localhost:${options.port}/console`);\r\n          } catch {\r\n            // Browser opening failed, that's okay\r\n          }\r\n\r\n          // Keep process running\r\n          console.log(\r\n            chalk.green('âœ¨ Web UI is running at:'),\r\n            chalk.cyan(`http://localhost:${options.port}/console`),\r\n          );\r\n          console.log(chalk.gray('Press Ctrl+C to stop'));\r\n\r\n          // Handle shutdown\r\n          const shutdownWebUI = async () => {\r\n            console.log('\\n' + chalk.yellow('Shutting down Web UI...'));\r\n            await webServer.stop();\r\n            systemMonitor.stop();\r\n            await processManager.stopAll();\r\n            console.log(chalk.green('âœ“ Shutdown complete'));\r\n            process.exit(0);\r\n          };\r\n\r\n          Deno.addSignalListener('SIGINT', shutdownWebUI);\r\n          Deno.addSignalListener('SIGTERM', shutdownWebUI);\r\n\r\n          // Keep process alive\r\n          await new Promise<void>(() => {});\r\n        } catch (webError) {\r\n          // Fall back to TUI if web server is not available\r\n          console.log(chalk.yellow('Web UI not available, falling back to Terminal UI'));\r\n          const ui = new ProcessUI(processManager);\r\n          await ui.start();\r\n\r\n          // Cleanup on exit\r\n          systemMonitor.stop();\r\n          await processManager.stopAll();\r\n          console.log(chalk.green.bold('âœ“'), 'Shutdown complete');\r\n          process.exit(0);\r\n        }\r\n      }\r\n      // Daemon mode\r\n      else if (options.daemon) {\r\n        console.log(chalk.yellow('Starting in daemon mode...'));\r\n\r\n        // Auto-start all processes\r\n        if (options.autoStart) {\r\n          console.log(chalk.blue('Starting all system processes...'));\r\n          await startWithProgress(processManager, 'all');\r\n        } else {\r\n          // Start only core processes\r\n          console.log(chalk.blue('Starting core processes...'));\r\n          await startWithProgress(processManager, 'core');\r\n        }\r\n\r\n        // Create PID file with metadata\r\n        const pid = Deno.pid;\r\n        const pidData = {\r\n          pid,\r\n          startTime: Date.now(),\r\n          config: options.config || 'default',\r\n          processes: processManager.getAllProcesses().map((p) => ({ id: p.id, status: p.status })),\r\n        };\r\n        await fs.writeFile('.claude-flow.pid', JSON.stringify(pidData, null, 2));\r\n        console.log(chalk.gray(`Process ID: ${pid}`));\r\n\r\n        // Wait for services to be fully ready\r\n        await waitForSystemReady(processManager);\r\n\r\n        console.log(chalk.green.bold('âœ“'), 'Daemon started successfully');\r\n        console.log(chalk.gray('Use \"claude-flow status\" to check system status'));\r\n        console.log(chalk.gray('Use \"claude-flow monitor\" for real-time monitoring'));\r\n\r\n        // Keep process running\r\n        await new Promise<void>(() => {});\r\n      }\r\n      // Interactive mode (default)\r\n      else {\r\n        console.log(chalk.cyan('Starting in interactive mode...'));\r\n        console.log();\r\n\r\n        // Show available options\r\n        console.log(chalk.white.bold('Quick Actions:'));\r\n        console.log('  [1] Start all processes');\r\n        console.log('  [2] Start core processes only');\r\n        console.log('  [3] Launch process management UI');\r\n        console.log('  [4] Show system status');\r\n        console.log('  [q] Quit');\r\n        console.log();\r\n        console.log(chalk.gray('Press a key to select an option...'));\r\n\r\n        // Handle user input\r\n        const decoder = new TextDecoder();\r\n        while (true) {\r\n          const buf = new Uint8Array(1);\r\n          await Deno.stdin.read(buf);\r\n          const key = decoder.decode(buf);\r\n\r\n          switch (key) {\r\n            case '1':\r\n              console.log(chalk.cyan('\\nStarting all processes...'));\r\n              await startWithProgress(processManager, 'all');\r\n              console.log(chalk.green.bold('âœ“'), 'All processes started');\r\n              break;\r\n\r\n            case '2':\r\n              console.log(chalk.cyan('\\nStarting core processes...'));\r\n              await startWithProgress(processManager, 'core');\r\n              console.log(chalk.green.bold('âœ“'), 'Core processes started');\r\n              break;\r\n\r\n            case '3':\r\n              const ui = new ProcessUI(processManager);\r\n              await ui.start();\r\n              break;\r\n\r\n            case '4':\r\n              console.clear();\r\n              systemMonitor.printSystemHealth();\r\n              console.log();\r\n              systemMonitor.printEventLog(10);\r\n              console.log();\r\n              console.log(chalk.gray('Press any key to continue...'));\r\n              await Deno.stdin.read(new Uint8Array(1));\r\n              break;\r\n\r\n            case 'q':\r\n            case 'Q':\r\n              console.log(chalk.yellow('\\nShutting down...'));\r\n              await processManager.stopAll();\r\n              systemMonitor.stop();\r\n              console.log(chalk.green.bold('âœ“'), 'Shutdown complete');\r\n              process.exit(0);\r\n              break;\r\n          }\r\n\r\n          // Redraw menu\r\n          console.clear();\r\n          console.log(chalk.cyan('ðŸ§  Claude-Flow Interactive Mode'));\r\n          console.log(chalk.gray('â”€'.repeat(60)));\r\n\r\n          // Show current status\r\n          const stats = processManager.getSystemStats();\r\n          console.log(\r\n            chalk.white('System Status:'),\r\n            chalk.green(`${stats.runningProcesses}/${stats.totalProcesses} processes running`),\r\n          );\r\n          console.log();\r\n\r\n          console.log(chalk.white.bold('Quick Actions:'));\r\n          console.log('  [1] Start all processes');\r\n          console.log('  [2] Start core processes only');\r\n          console.log('  [3] Launch process management UI');\r\n          console.log('  [4] Show system status');\r\n          console.log('  [q] Quit');\r\n          console.log();\r\n          console.log(chalk.gray('Press a key to select an option...'));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(chalk.red.bold('Failed to start:'), (error as Error).message);\r\n      if (options.verbose) {\r\n        console.error((error as Error).stack);\r\n      }\r\n\r\n      // Cleanup on failure\r\n      console.log(chalk.yellow('Performing cleanup...'));\r\n      try {\r\n        await cleanupOnFailure();\r\n      } catch (cleanupError) {\r\n        console.error(chalk.red('Cleanup failed:'), (cleanupError as Error).message);\r\n      }\r\n\r\n      process.exit(1);\r\n    }\r\n  });\r\n\r\n// Enhanced helper functions\r\n\r\nasync function isSystemRunning(): Promise<boolean> {\r\n  try {\r\n    const pidData = await fs.readFile('.claude-flow.pid', 'utf-8');\r\n    const data = JSON.parse(pidData);\r\n\r\n    // Check if process is still running\r\n    try {\r\n      Deno.kill(data.pid, 'SIGTERM');\r\n      return false; // Process was killed, so it was running\r\n    } catch {\r\n      return false; // Process not found\r\n    }\r\n  } catch {\r\n    return false; // No PID file\r\n  }\r\n}\r\n\r\nasync function stopExistingInstance(): Promise<void> {\r\n  try {\r\n    const pidData = await fs.readFile('.claude-flow.pid', 'utf-8');\r\n    const data = JSON.parse(pidData);\r\n\r\n    console.log(chalk.yellow('Stopping existing instance...'));\r\n    Deno.kill(data.pid, 'SIGTERM');\r\n\r\n    // Wait for graceful shutdown\r\n    await new Promise((resolve) => setTimeout(resolve, 2000));\r\n\r\n    // Force kill if still running\r\n    try {\r\n      Deno.kill(data.pid, 'SIGKILL');\r\n    } catch {\r\n      // Process already stopped\r\n    }\r\n\r\n    await Deno.remove('.claude-flow.pid').catch(() => {});\r\n    console.log(chalk.green('âœ“ Existing instance stopped'));\r\n  } catch (error) {\r\n    console.warn(\r\n      chalk.yellow('Warning: Could not stop existing instance'),\r\n      (error as Error).message,\r\n    );\r\n  }\r\n}\r\n\r\nasync function performHealthChecks(): Promise<void> {\r\n  const checks = [\r\n    { name: 'Disk Space', check: checkDiskSpace },\r\n    { name: 'Memory Available', check: checkMemoryAvailable },\r\n    { name: 'Network Connectivity', check: checkNetworkConnectivity },\r\n    { name: 'Required Dependencies', check: checkDependencies },\r\n  ];\r\n\r\n  for (const { name, check } of checks) {\r\n    try {\r\n      console.log(chalk.gray(`  Checking ${name}...`));\r\n      await check();\r\n      console.log(chalk.green(`  âœ“ ${name} OK`));\r\n    } catch (error) {\r\n      console.log(chalk.red(`  âœ— ${name} Failed: ${(error as Error).message}`));\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nasync function checkDiskSpace(): Promise<void> {\r\n  // Basic disk space check - would need platform-specific implementation\r\n  const stats = await fs.stat('.');\r\n  if (!stats.isDirectory) {\r\n    throw new Error('Current directory is not accessible');\r\n  }\r\n}\r\n\r\nasync function checkMemoryAvailable(): Promise<void> {\r\n  // Memory check - would integrate with system memory monitoring\r\n  const memoryInfo = Deno.memoryUsage();\r\n  if (memoryInfo.heapUsed > 500 * 1024 * 1024) {\r\n    // 500MB threshold\r\n    throw new Error('High memory usage detected');\r\n  }\r\n}\r\n\r\nasync function checkNetworkConnectivity(): Promise<void> {\r\n  // Basic network check\r\n  try {\r\n    const response = await fetch('https://httpbin.org/status/200', {\r\n      method: 'GET',\r\n      signal: AbortSignal.timeout(5000),\r\n    });\r\n    if (!response.ok) {\r\n      throw new Error(`Network check failed: ${response.status}`);\r\n    }\r\n  } catch {\r\n    console.log(chalk.yellow('  âš  Network connectivity check skipped (offline mode?)'));\r\n  }\r\n}\r\n\r\nasync function checkDependencies(): Promise<void> {\r\n  // Check for required directories and files\r\n  const requiredDirs = ['.claude-flow', 'memory', 'logs'];\r\n  for (const dir of requiredDirs) {\r\n    try {\r\n      await Deno.mkdir(dir, { recursive: true });\r\n    } catch (error) {\r\n      throw new Error(`Cannot create required directory: ${dir}`);\r\n    }\r\n  }\r\n}\r\n\r\nfunction setupSystemEventHandlers(\r\n  processManager: ProcessManager,\r\n  systemMonitor: SystemMonitor,\r\n  options: StartOptions,\r\n): void {\r\n  // Handle graceful shutdown signals\r\n  const shutdownHandler = async () => {\r\n    console.log('\\n' + chalk.yellow('Received shutdown signal, shutting down gracefully...'));\r\n    systemMonitor.stop();\r\n    await processManager.stopAll();\r\n    await cleanupOnShutdown();\r\n    console.log(chalk.green('âœ“ Shutdown complete'));\r\n    process.exit(0);\r\n  };\r\n\r\n  Deno.addSignalListener('SIGINT', shutdownHandler);\r\n  Deno.addSignalListener('SIGTERM', shutdownHandler);\r\n\r\n  // Setup verbose logging if requested\r\n  if (options.verbose) {\r\n    setupVerboseLogging(systemMonitor);\r\n  }\r\n\r\n  // Monitor for critical errors\r\n  processManager.on('processError', (event: any) => {\r\n    console.error(chalk.red(`Process error in ${event.processId}:`), event.error);\r\n    if (event.processId === 'orchestrator') {\r\n      console.error(chalk.red.bold('Critical process failed, initiating recovery...'));\r\n      // Could implement auto-recovery logic here\r\n    }\r\n  });\r\n}\r\n\r\nasync function startWithProgress(\r\n  processManager: ProcessManager,\r\n  mode: 'all' | 'core',\r\n): Promise<void> {\r\n  const processes =\r\n    mode === 'all'\r\n      ? [\r\n          'event-bus',\r\n          'memory-manager',\r\n          'terminal-pool',\r\n          'coordinator',\r\n          'mcp-server',\r\n          'orchestrator',\r\n        ]\r\n      : ['event-bus', 'memory-manager', 'mcp-server'];\r\n\r\n  for (let i = 0; i < processes.length; i++) {\r\n    const processId = processes[i];\r\n    const progress = `[${i + 1}/${processes.length}]`;\r\n\r\n    console.log(chalk.gray(`${progress} Starting ${processId}...`));\r\n    try {\r\n      await processManager.startProcess(processId);\r\n      console.log(chalk.green(`${progress} âœ“ ${processId} started`));\r\n    } catch (error) {\r\n      console.log(chalk.red(`${progress} âœ— ${processId} failed: ${(error as Error).message}`));\r\n      if (processId === 'orchestrator' || processId === 'mcp-server') {\r\n        throw error; // Critical processes\r\n      }\r\n    }\r\n\r\n    // Brief delay between starts\r\n    if (i < processes.length - 1) {\r\n      await new Promise((resolve) => setTimeout(resolve, 500));\r\n    }\r\n  }\r\n}\r\n\r\nasync function waitForSystemReady(processManager: ProcessManager): Promise<void> {\r\n  console.log(chalk.blue('Waiting for system to be ready...'));\r\n\r\n  const maxWait = 30000; // 30 seconds\r\n  const checkInterval = 1000; // 1 second\r\n  let waited = 0;\r\n\r\n  while (waited < maxWait) {\r\n    const stats = processManager.getSystemStats();\r\n    if (stats.errorProcesses === 0 && stats.runningProcesses >= 3) {\r\n      console.log(chalk.green('âœ“ System ready'));\r\n      return;\r\n    }\r\n\r\n    await new Promise((resolve) => setTimeout(resolve, checkInterval));\r\n    waited += checkInterval;\r\n  }\r\n\r\n  console.log(\r\n    chalk.yellow('âš  System startup completed but some processes may not be fully ready'),\r\n  );\r\n}\r\n\r\nasync function cleanupOnFailure(): Promise<void> {\r\n  try {\r\n    await Deno.remove('.claude-flow.pid').catch(() => {});\r\n    console.log(chalk.gray('Cleaned up PID file'));\r\n  } catch {\r\n    // Ignore cleanup errors\r\n  }\r\n}\r\n\r\nasync function cleanupOnShutdown(): Promise<void> {\r\n  try {\r\n    await Deno.remove('.claude-flow.pid').catch(() => {});\r\n    console.log(chalk.gray('Cleaned up PID file'));\r\n  } catch {\r\n    // Ignore cleanup errors\r\n  }\r\n}\r\n\r\nfunction setupVerboseLogging(monitor: SystemMonitor): void {\r\n  // Enhanced verbose logging\r\n  console.log(chalk.gray('Verbose logging enabled'));\r\n\r\n  // Periodically print system health\r\n  setInterval(() => {\r\n    console.log();\r\n    console.log(chalk.cyan('--- System Health Report ---'));\r\n    monitor.printSystemHealth();\r\n    console.log(chalk.cyan('--- End Report ---'));\r\n  }, 30000);\r\n\r\n  // Log critical events\r\n  eventBus.on('process:started', (data: any) => {\r\n    console.log(chalk.green(`[VERBOSE] Process started: ${data.processId}`));\r\n  });\r\n\r\n  eventBus.on('process:stopped', (data: any) => {\r\n    console.log(chalk.yellow(`[VERBOSE] Process stopped: ${data.processId}`));\r\n  });\r\n\r\n  eventBus.on('process:error', (data: any) => {\r\n    console.log(chalk.red(`[VERBOSE] Process error: ${data.processId} - ${data.error}`));\r\n  });\r\n}\r\n"],"names":["promises","fs","Command","chalk","inquirer","ProcessManager","ProcessUI","SystemMonitor","eventBus","startCommand","description","option","default","action","options","console","log","cyan","gray","repeat","force","isSystemRunning","yellow","shouldContinue","prompt","type","name","message","stopExistingInstance","healthCheck","blue","performHealthChecks","processManager","initPromise","initialize","config","timeoutPromise","Promise","_","reject","setTimeout","Error","timeout","race","systemMonitor","start","setupSystemEventHandlers","port","mcpProcess","getProcess","mcpTransport","transport","verbose","setupVerboseLogging","ui","ClaudeCodeWebServer","webServer","openCommand","process","platform","exec","green","shutdownWebUI","stop","stopAll","exit","Deno","addSignalListener","webError","bold","daemon","autoStart","startWithProgress","pid","pidData","startTime","Date","now","processes","getAllProcesses","map","p","id","status","writeFile","JSON","stringify","waitForSystemReady","white","decoder","TextDecoder","buf","Uint8Array","stdin","read","key","decode","clear","printSystemHealth","printEventLog","stats","getSystemStats","runningProcesses","totalProcesses","error","red","stack","cleanupOnFailure","cleanupError","readFile","data","parse","kill","resolve","remove","catch","warn","checks","check","checkDiskSpace","checkMemoryAvailable","checkNetworkConnectivity","checkDependencies","stat","isDirectory","memoryInfo","memoryUsage","heapUsed","response","fetch","method","signal","AbortSignal","ok","requiredDirs","dir","mkdir","recursive","shutdownHandler","cleanupOnShutdown","on","event","processId","mode","i","length","progress","startProcess","maxWait","checkInterval","waited","errorProcesses","monitor","setInterval"],"mappings":"AAAA,SAASA,YAAYC,EAAE,QAAQ,UAAU;AAKzC,SAASC,OAAO,QAAQ,kBAAkB;AAC1C,OAAOC,WAAW,QAAQ;AAC1B,OAAOC,cAAc,WAAW;AAChC,SAASC,cAAc,QAAQ,uBAAuB;AACtD,SAASC,SAAS,QAAQ,kBAAkB;AAC5C,SAASC,aAAa,QAAQ,sBAAsB;AAEpD,SAASC,QAAQ,QAAQ,6BAA6B;AAItD,OAAO,MAAMC,eAAe,IAAIP,UAC7BQ,WAAW,CAAC,8CACZC,MAAM,CAAC,gBAAgB,+BACvBA,MAAM,CAAC,4BAA4B,mBAAmB;IAAEC,SAAS;AAAK,GACtED,MAAM,CAAC,sCAAsC,oCAAoC;IAChFC,SAAS;AACX,GACCD,MAAM,CAAC,YAAY,4CACnBA,MAAM,CAAC,iBAAiB,0BACxBA,MAAM,CAAC,gBAAgB,qCACvBA,MAAM,CAAC,0BAA0B,2BACjCA,MAAM,CAAC,WAAW,uCAClBA,MAAM,CAAC,kBAAkB,yCACzBA,MAAM,CAAC,8BAA8B,8BAA8B;IAAEC,SAAS;AAAG,GACjFC,MAAM,CAAC,OAAOC;IACbC,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;IACvBF,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC,IAAIC,MAAM,CAAC;IAElC,IAAI;QAEF,IAAI,CAACL,QAAQM,KAAK,IAAK,MAAMC,mBAAoB;YAC/CN,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;YACzB,MAAM,EAAEC,cAAc,EAAE,GAAG,MAAMnB,SAASoB,MAAM,CAAC;gBAC/C;oBACEC,MAAM;oBACNC,MAAM;oBACNC,SAAS;oBACTf,SAAS;gBACX;aACD;YAED,IAAI,CAACW,gBAAgB;gBACnBR,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;gBACvB;YACF;YAEA,MAAMU;QACR;QAGA,IAAId,QAAQe,WAAW,EAAE;YACvBd,QAAQC,GAAG,CAACb,MAAM2B,IAAI,CAAC;YACvB,MAAMC;QACR;QAGA,MAAMC,iBAAiB,IAAI3B;QAC3BU,QAAQC,GAAG,CAACb,MAAM2B,IAAI,CAAC;QACvB,MAAMG,cAAcD,eAAeE,UAAU,CAACpB,QAAQqB,MAAM;QAC5D,MAAMC,iBAAiB,IAAIC,QAAQ,CAACC,GAAGC,SACrCC,WACE,IAAMD,OAAO,IAAIE,MAAM,4BACvB,AAAC3B,CAAAA,QAAQ4B,OAAO,IAAI,EAAC,IAAK;QAI9B,MAAML,QAAQM,IAAI,CAAC;YAACV;YAAaG;SAAe;QAGhD,MAAMQ,gBAAgB,IAAIrC,cAAcyB;QACxCY,cAAcC,KAAK;QAGnBC,yBAAyBd,gBAAgBY,eAAe9B;QAGxD,IAAIA,QAAQiC,IAAI,EAAE;YAChB,MAAMC,aAAahB,eAAeiB,UAAU,CAAC;YAC7C,IAAID,YAAY;gBACdA,WAAWb,MAAM,GAAG;oBAAE,GAAGa,WAAWb,MAAM;oBAAEY,MAAMjC,QAAQiC,IAAI;gBAAC;YACjE;QACF;QAGA,IAAIjC,QAAQoC,YAAY,EAAE;YACxB,MAAMF,aAAahB,eAAeiB,UAAU,CAAC;YAC7C,IAAID,YAAY;gBACdA,WAAWb,MAAM,GAAG;oBAAE,GAAGa,WAAWb,MAAM;oBAAEgB,WAAWrC,QAAQoC,YAAY;gBAAC;YAC9E;QACF;QAGA,IAAIpC,QAAQsC,OAAO,EAAE;YACnBC,oBAAoBT;QACtB;QAGA,IAAI9B,QAAQwC,EAAE,EAAE;YAEd,IAAI;gBACF,MAAM,EAAEC,mBAAmB,EAAE,GAAG,MAAM,MAAM,CAAC;gBAG7CxC,QAAQC,GAAG,CAACb,MAAM2B,IAAI,CAAC;gBACvB,MAAM0B,YAAY,IAAID,oBAAoBzC,QAAQiC,IAAI;gBACtD,MAAMS,UAAUX,KAAK;gBAGrB,MAAMY,cACJC,QAAQC,QAAQ,KAAK,WACjB,SACAD,QAAQC,QAAQ,KAAK,UACnB,UACA;gBAER,IAAI;oBACF,MAAM,EAAEC,IAAI,EAAE,GAAG,MAAM,MAAM,CAAC;oBAC9BA,KAAK,GAAGH,YAAY,kBAAkB,EAAE3C,QAAQiC,IAAI,CAAC,QAAQ,CAAC;gBAChE,EAAE,OAAM,CAER;gBAGAhC,QAAQC,GAAG,CACTb,MAAM0D,KAAK,CAAC,4BACZ1D,MAAMc,IAAI,CAAC,CAAC,iBAAiB,EAAEH,QAAQiC,IAAI,CAAC,QAAQ,CAAC;gBAEvDhC,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;gBAGvB,MAAM4C,gBAAgB;oBACpB/C,QAAQC,GAAG,CAAC,OAAOb,MAAMmB,MAAM,CAAC;oBAChC,MAAMkC,UAAUO,IAAI;oBACpBnB,cAAcmB,IAAI;oBAClB,MAAM/B,eAAegC,OAAO;oBAC5BjD,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC;oBACxBH,QAAQO,IAAI,CAAC;gBACf;gBAEAC,KAAKC,iBAAiB,CAAC,UAAUL;gBACjCI,KAAKC,iBAAiB,CAAC,WAAWL;gBAGlC,MAAM,IAAIzB,QAAc,KAAO;YACjC,EAAE,OAAO+B,UAAU;gBAEjBrD,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;gBACzB,MAAMgC,KAAK,IAAIhD,UAAU0B;gBACzB,MAAMsB,GAAGT,KAAK;gBAGdD,cAAcmB,IAAI;gBAClB,MAAM/B,eAAegC,OAAO;gBAC5BjD,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAACQ,IAAI,CAAC,MAAM;gBACnCX,QAAQO,IAAI,CAAC;YACf;QACF,OAEK,IAAInD,QAAQwD,MAAM,EAAE;YACvBvD,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;YAGzB,IAAIR,QAAQyD,SAAS,EAAE;gBACrBxD,QAAQC,GAAG,CAACb,MAAM2B,IAAI,CAAC;gBACvB,MAAM0C,kBAAkBxC,gBAAgB;YAC1C,OAAO;gBAELjB,QAAQC,GAAG,CAACb,MAAM2B,IAAI,CAAC;gBACvB,MAAM0C,kBAAkBxC,gBAAgB;YAC1C;YAGA,MAAMyC,MAAMP,KAAKO,GAAG;YACpB,MAAMC,UAAU;gBACdD;gBACAE,WAAWC,KAAKC,GAAG;gBACnB1C,QAAQrB,QAAQqB,MAAM,IAAI;gBAC1B2C,WAAW9C,eAAe+C,eAAe,GAAGC,GAAG,CAAC,CAACC,IAAO,CAAA;wBAAEC,IAAID,EAAEC,EAAE;wBAAEC,QAAQF,EAAEE,MAAM;oBAAC,CAAA;YACvF;YACA,MAAMlF,GAAGmF,SAAS,CAAC,oBAAoBC,KAAKC,SAAS,CAACZ,SAAS,MAAM;YACrE3D,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC,CAAC,YAAY,EAAEuD,KAAK;YAG3C,MAAMc,mBAAmBvD;YAEzBjB,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAACQ,IAAI,CAAC,MAAM;YACnCtD,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;YACvBH,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;YAGvB,MAAM,IAAImB,QAAc,KAAO;QACjC,OAEK;YACHtB,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;YACvBF,QAAQC,GAAG;YAGXD,QAAQC,GAAG,CAACb,MAAMqF,KAAK,CAACnB,IAAI,CAAC;YAC7BtD,QAAQC,GAAG,CAAC;YACZD,QAAQC,GAAG,CAAC;YACZD,QAAQC,GAAG,CAAC;YACZD,QAAQC,GAAG,CAAC;YACZD,QAAQC,GAAG,CAAC;YACZD,QAAQC,GAAG;YACXD,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;YAGvB,MAAMuE,UAAU,IAAIC;YACpB,MAAO,KAAM;gBACX,MAAMC,MAAM,IAAIC,WAAW;gBAC3B,MAAM1B,KAAK2B,KAAK,CAACC,IAAI,CAACH;gBACtB,MAAMI,MAAMN,QAAQO,MAAM,CAACL;gBAE3B,OAAQI;oBACN,KAAK;wBACHhF,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;wBACvB,MAAMuD,kBAAkBxC,gBAAgB;wBACxCjB,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAACQ,IAAI,CAAC,MAAM;wBACnC;oBAEF,KAAK;wBACHtD,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;wBACvB,MAAMuD,kBAAkBxC,gBAAgB;wBACxCjB,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAACQ,IAAI,CAAC,MAAM;wBACnC;oBAEF,KAAK;wBACH,MAAMf,KAAK,IAAIhD,UAAU0B;wBACzB,MAAMsB,GAAGT,KAAK;wBACd;oBAEF,KAAK;wBACH9B,QAAQkF,KAAK;wBACbrD,cAAcsD,iBAAiB;wBAC/BnF,QAAQC,GAAG;wBACX4B,cAAcuD,aAAa,CAAC;wBAC5BpF,QAAQC,GAAG;wBACXD,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;wBACvB,MAAMgD,KAAK2B,KAAK,CAACC,IAAI,CAAC,IAAIF,WAAW;wBACrC;oBAEF,KAAK;oBACL,KAAK;wBACH7E,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;wBACzB,MAAMU,eAAegC,OAAO;wBAC5BpB,cAAcmB,IAAI;wBAClBhD,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAACQ,IAAI,CAAC,MAAM;wBACnCX,QAAQO,IAAI,CAAC;wBACb;gBACJ;gBAGAlD,QAAQkF,KAAK;gBACblF,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;gBACvBF,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC,IAAIC,MAAM,CAAC;gBAGlC,MAAMiF,QAAQpE,eAAeqE,cAAc;gBAC3CtF,QAAQC,GAAG,CACTb,MAAMqF,KAAK,CAAC,mBACZrF,MAAM0D,KAAK,CAAC,GAAGuC,MAAME,gBAAgB,CAAC,CAAC,EAAEF,MAAMG,cAAc,CAAC,kBAAkB,CAAC;gBAEnFxF,QAAQC,GAAG;gBAEXD,QAAQC,GAAG,CAACb,MAAMqF,KAAK,CAACnB,IAAI,CAAC;gBAC7BtD,QAAQC,GAAG,CAAC;gBACZD,QAAQC,GAAG,CAAC;gBACZD,QAAQC,GAAG,CAAC;gBACZD,QAAQC,GAAG,CAAC;gBACZD,QAAQC,GAAG,CAAC;gBACZD,QAAQC,GAAG;gBACXD,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;YACzB;QACF;IACF,EAAE,OAAOsF,OAAO;QACdzF,QAAQyF,KAAK,CAACrG,MAAMsG,GAAG,CAACpC,IAAI,CAAC,qBAAqB,AAACmC,MAAgB7E,OAAO;QAC1E,IAAIb,QAAQsC,OAAO,EAAE;YACnBrC,QAAQyF,KAAK,CAAC,AAACA,MAAgBE,KAAK;QACtC;QAGA3F,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;QACzB,IAAI;YACF,MAAMqF;QACR,EAAE,OAAOC,cAAc;YACrB7F,QAAQyF,KAAK,CAACrG,MAAMsG,GAAG,CAAC,oBAAoB,AAACG,aAAuBjF,OAAO;QAC7E;QAEA+B,QAAQO,IAAI,CAAC;IACf;AACF,GAAG;AAIL,eAAe5C;IACb,IAAI;QACF,MAAMqD,UAAU,MAAMzE,GAAG4G,QAAQ,CAAC,oBAAoB;QACtD,MAAMC,OAAOzB,KAAK0B,KAAK,CAACrC;QAGxB,IAAI;YACFR,KAAK8C,IAAI,CAACF,KAAKrC,GAAG,EAAE;YACpB,OAAO;QACT,EAAE,OAAM;YACN,OAAO;QACT;IACF,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEA,eAAe7C;IACb,IAAI;QACF,MAAM8C,UAAU,MAAMzE,GAAG4G,QAAQ,CAAC,oBAAoB;QACtD,MAAMC,OAAOzB,KAAK0B,KAAK,CAACrC;QAExB3D,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;QACzB4C,KAAK8C,IAAI,CAACF,KAAKrC,GAAG,EAAE;QAGpB,MAAM,IAAIpC,QAAQ,CAAC4E,UAAYzE,WAAWyE,SAAS;QAGnD,IAAI;YACF/C,KAAK8C,IAAI,CAACF,KAAKrC,GAAG,EAAE;QACtB,EAAE,OAAM,CAER;QAEA,MAAMP,KAAKgD,MAAM,CAAC,oBAAoBC,KAAK,CAAC,KAAO;QACnDpG,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC;IAC1B,EAAE,OAAO2C,OAAO;QACdzF,QAAQqG,IAAI,CACVjH,MAAMmB,MAAM,CAAC,8CACb,AAACkF,MAAgB7E,OAAO;IAE5B;AACF;AAEA,eAAeI;IACb,MAAMsF,SAAS;QACb;YAAE3F,MAAM;YAAc4F,OAAOC;QAAe;QAC5C;YAAE7F,MAAM;YAAoB4F,OAAOE;QAAqB;QACxD;YAAE9F,MAAM;YAAwB4F,OAAOG;QAAyB;QAChE;YAAE/F,MAAM;YAAyB4F,OAAOI;QAAkB;KAC3D;IAED,KAAK,MAAM,EAAEhG,IAAI,EAAE4F,KAAK,EAAE,IAAID,OAAQ;QACpC,IAAI;YACFtG,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC,CAAC,WAAW,EAAEQ,KAAK,GAAG,CAAC;YAC9C,MAAM4F;YACNvG,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC,CAAC,IAAI,EAAEnC,KAAK,GAAG,CAAC;QAC1C,EAAE,OAAO8E,OAAO;YACdzF,QAAQC,GAAG,CAACb,MAAMsG,GAAG,CAAC,CAAC,IAAI,EAAE/E,KAAK,SAAS,EAAE,AAAC8E,MAAgB7E,OAAO,EAAE;YACvE,MAAM6E;QACR;IACF;AACF;AAEA,eAAee;IAEb,MAAMnB,QAAQ,MAAMnG,GAAG0H,IAAI,CAAC;IAC5B,IAAI,CAACvB,MAAMwB,WAAW,EAAE;QACtB,MAAM,IAAInF,MAAM;IAClB;AACF;AAEA,eAAe+E;IAEb,MAAMK,aAAa3D,KAAK4D,WAAW;IACnC,IAAID,WAAWE,QAAQ,GAAG,MAAM,OAAO,MAAM;QAE3C,MAAM,IAAItF,MAAM;IAClB;AACF;AAEA,eAAegF;IAEb,IAAI;QACF,MAAMO,WAAW,MAAMC,MAAM,kCAAkC;YAC7DC,QAAQ;YACRC,QAAQC,YAAY1F,OAAO,CAAC;QAC9B;QACA,IAAI,CAACsF,SAASK,EAAE,EAAE;YAChB,MAAM,IAAI5F,MAAM,CAAC,sBAAsB,EAAEuF,SAAS7C,MAAM,EAAE;QAC5D;IACF,EAAE,OAAM;QACNpE,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC;IAC3B;AACF;AAEA,eAAeoG;IAEb,MAAMY,eAAe;QAAC;QAAgB;QAAU;KAAO;IACvD,KAAK,MAAMC,OAAOD,aAAc;QAC9B,IAAI;YACF,MAAMpE,KAAKsE,KAAK,CAACD,KAAK;gBAAEE,WAAW;YAAK;QAC1C,EAAE,OAAOjC,OAAO;YACd,MAAM,IAAI/D,MAAM,CAAC,kCAAkC,EAAE8F,KAAK;QAC5D;IACF;AACF;AAEA,SAASzF,yBACPd,cAA8B,EAC9BY,aAA4B,EAC5B9B,OAAqB;IAGrB,MAAM4H,kBAAkB;QACtB3H,QAAQC,GAAG,CAAC,OAAOb,MAAMmB,MAAM,CAAC;QAChCsB,cAAcmB,IAAI;QAClB,MAAM/B,eAAegC,OAAO;QAC5B,MAAM2E;QACN5H,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC;QACxBH,QAAQO,IAAI,CAAC;IACf;IAEAC,KAAKC,iBAAiB,CAAC,UAAUuE;IACjCxE,KAAKC,iBAAiB,CAAC,WAAWuE;IAGlC,IAAI5H,QAAQsC,OAAO,EAAE;QACnBC,oBAAoBT;IACtB;IAGAZ,eAAe4G,EAAE,CAAC,gBAAgB,CAACC;QACjC9H,QAAQyF,KAAK,CAACrG,MAAMsG,GAAG,CAAC,CAAC,iBAAiB,EAAEoC,MAAMC,SAAS,CAAC,CAAC,CAAC,GAAGD,MAAMrC,KAAK;QAC5E,IAAIqC,MAAMC,SAAS,KAAK,gBAAgB;YACtC/H,QAAQyF,KAAK,CAACrG,MAAMsG,GAAG,CAACpC,IAAI,CAAC;QAE/B;IACF;AACF;AAEA,eAAeG,kBACbxC,cAA8B,EAC9B+G,IAAoB;IAEpB,MAAMjE,YACJiE,SAAS,QACL;QACE;QACA;QACA;QACA;QACA;QACA;KACD,GACD;QAAC;QAAa;QAAkB;KAAa;IAEnD,IAAK,IAAIC,IAAI,GAAGA,IAAIlE,UAAUmE,MAAM,EAAED,IAAK;QACzC,MAAMF,YAAYhE,SAAS,CAACkE,EAAE;QAC9B,MAAME,WAAW,CAAC,CAAC,EAAEF,IAAI,EAAE,CAAC,EAAElE,UAAUmE,MAAM,CAAC,CAAC,CAAC;QAEjDlI,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC,GAAGgI,SAAS,UAAU,EAAEJ,UAAU,GAAG,CAAC;QAC7D,IAAI;YACF,MAAM9G,eAAemH,YAAY,CAACL;YAClC/H,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC,GAAGqF,SAAS,GAAG,EAAEJ,UAAU,QAAQ,CAAC;QAC9D,EAAE,OAAOtC,OAAO;YACdzF,QAAQC,GAAG,CAACb,MAAMsG,GAAG,CAAC,GAAGyC,SAAS,GAAG,EAAEJ,UAAU,SAAS,EAAE,AAACtC,MAAgB7E,OAAO,EAAE;YACtF,IAAImH,cAAc,kBAAkBA,cAAc,cAAc;gBAC9D,MAAMtC;YACR;QACF;QAGA,IAAIwC,IAAIlE,UAAUmE,MAAM,GAAG,GAAG;YAC5B,MAAM,IAAI5G,QAAQ,CAAC4E,UAAYzE,WAAWyE,SAAS;QACrD;IACF;AACF;AAEA,eAAe1B,mBAAmBvD,cAA8B;IAC9DjB,QAAQC,GAAG,CAACb,MAAM2B,IAAI,CAAC;IAEvB,MAAMsH,UAAU;IAChB,MAAMC,gBAAgB;IACtB,IAAIC,SAAS;IAEb,MAAOA,SAASF,QAAS;QACvB,MAAMhD,QAAQpE,eAAeqE,cAAc;QAC3C,IAAID,MAAMmD,cAAc,KAAK,KAAKnD,MAAME,gBAAgB,IAAI,GAAG;YAC7DvF,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC;YACxB;QACF;QAEA,MAAM,IAAIxB,QAAQ,CAAC4E,UAAYzE,WAAWyE,SAASoC;QACnDC,UAAUD;IACZ;IAEAtI,QAAQC,GAAG,CACTb,MAAMmB,MAAM,CAAC;AAEjB;AAEA,eAAeqF;IACb,IAAI;QACF,MAAMzC,KAAKgD,MAAM,CAAC,oBAAoBC,KAAK,CAAC,KAAO;QACnDpG,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;IACzB,EAAE,OAAM,CAER;AACF;AAEA,eAAeyH;IACb,IAAI;QACF,MAAMzE,KAAKgD,MAAM,CAAC,oBAAoBC,KAAK,CAAC,KAAO;QACnDpG,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;IACzB,EAAE,OAAM,CAER;AACF;AAEA,SAASmC,oBAAoBmG,OAAsB;IAEjDzI,QAAQC,GAAG,CAACb,MAAMe,IAAI,CAAC;IAGvBuI,YAAY;QACV1I,QAAQC,GAAG;QACXD,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;QACvBuI,QAAQtD,iBAAiB;QACzBnF,QAAQC,GAAG,CAACb,MAAMc,IAAI,CAAC;IACzB,GAAG;IAGHT,SAASoI,EAAE,CAAC,mBAAmB,CAAC9B;QAC9B/F,QAAQC,GAAG,CAACb,MAAM0D,KAAK,CAAC,CAAC,2BAA2B,EAAEiD,KAAKgC,SAAS,EAAE;IACxE;IAEAtI,SAASoI,EAAE,CAAC,mBAAmB,CAAC9B;QAC9B/F,QAAQC,GAAG,CAACb,MAAMmB,MAAM,CAAC,CAAC,2BAA2B,EAAEwF,KAAKgC,SAAS,EAAE;IACzE;IAEAtI,SAASoI,EAAE,CAAC,iBAAiB,CAAC9B;QAC5B/F,QAAQC,GAAG,CAACb,MAAMsG,GAAG,CAAC,CAAC,yBAAyB,EAAEK,KAAKgC,SAAS,CAAC,GAAG,EAAEhC,KAAKN,KAAK,EAAE;IACpF;AACF"}
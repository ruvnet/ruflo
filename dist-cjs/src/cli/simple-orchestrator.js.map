{"version":3,"sources":["../../../src/cli/simple-orchestrator.ts"],"sourcesContent":["/**\r\n * Simple orchestrator implementation for Node.js compatibility\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport express from 'express';\r\nimport { WebSocketServer } from 'ws';\r\nimport { createServer } from 'http';\r\nimport { spawn } from 'child_process';\r\nimport path from 'path';\r\nimport { fileURLToPath } from 'url';\r\nimport cors from 'cors';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = path.dirname(__filename);\r\n\r\n// Simple in-memory stores\r\nconst agents = new Map();\r\nconst tasks = new Map();\r\nconst memory = new Map();\r\n\r\n// Event bus\r\nconst eventBus = new EventEmitter();\r\n\r\n// Component status\r\nconst componentStatus = {\r\n  eventBus: false,\r\n  orchestrator: false,\r\n  memoryManager: false,\r\n  terminalPool: false,\r\n  mcpServer: false,\r\n  coordinationManager: false,\r\n  webUI: false,\r\n};\r\n\r\n// Simple MCP server\r\nfunction startMCPServer(port: number) {\r\n  console.log(`üåê Starting MCP server on port ${port}...`);\r\n  // In a real implementation, this would start the actual MCP server\r\n  componentStatus.mcpServer = true;\r\n  return true;\r\n}\r\n\r\n// Enhanced web UI with console interface\r\nfunction startWebUI(host: string, port: number) {\r\n  const app = express();\r\n  const server = createServer(app);\r\n  const wss = new WebSocketServer({ server });\r\n\r\n  // Add CORS middleware for cross-origin support\r\n  app.use(\r\n    cors({\r\n      origin: '*',\r\n      methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\r\n      allowedHeaders: ['Content-Type', 'Authorization'],\r\n      credentials: true,\r\n    }),\r\n  );\r\n\r\n  // Global error handler middleware\r\n  app.use((err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {\r\n    console.error('Global error handler:', err);\r\n    res.status(err.status || 500).json({\r\n      error: err.message || 'Internal server error',\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  });\r\n\r\n  // Request logging middleware\r\n  app.use((req, res, next) => {\r\n    console.log(`${new Date().toISOString()} ${req.method} ${req.path}`);\r\n    next();\r\n  });\r\n\r\n  // Store CLI output history and active connections\r\n  const outputHistory: string[] = [];\r\n  const activeConnections: Set<any> = new Set();\r\n\r\n  // CLI output capture system\r\n  const cliProcess: any = null;\r\n\r\n  const consoleHTML = `\r\n    <!DOCTYPE html>\r\n    <html lang=\"en\">\r\n    <head>\r\n        <meta charset=\"UTF-8\">\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n        <title>Claude-Flow Console</title>\r\n        <style>\r\n            * {\r\n                margin: 0;\r\n                padding: 0;\r\n                box-sizing: border-box;\r\n            }\r\n            body {\r\n                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;\r\n                background: #0d1117;\r\n                color: #c9d1d9;\r\n                height: 100vh;\r\n                display: flex;\r\n                flex-direction: column;\r\n                overflow: hidden;\r\n            }\r\n            .header {\r\n                background: #161b22;\r\n                border-bottom: 1px solid #21262d;\r\n                padding: 10px 20px;\r\n                display: flex;\r\n                justify-content: space-between;\r\n                align-items: center;\r\n            }\r\n            .title {\r\n                font-weight: bold;\r\n                color: #58a6ff;\r\n            }\r\n            .connection-status {\r\n                font-size: 12px;\r\n                color: #7c3aed;\r\n            }\r\n            .console-container {\r\n                flex: 1;\r\n                display: flex;\r\n                flex-direction: column;\r\n                overflow: hidden;\r\n            }\r\n            .console-output {\r\n                flex: 1;\r\n                overflow-y: auto;\r\n                padding: 10px;\r\n                background: #0d1117;\r\n                font-size: 13px;\r\n                line-height: 1.4;\r\n                white-space: pre-wrap;\r\n                word-wrap: break-word;\r\n            }\r\n            .console-input {\r\n                background: #161b22;\r\n                border: none;\r\n                border-top: 1px solid #21262d;\r\n                padding: 10px;\r\n                color: #c9d1d9;\r\n                font-family: inherit;\r\n                font-size: 13px;\r\n                outline: none;\r\n            }\r\n            .console-input:focus {\r\n                background: #21262d;\r\n            }\r\n            .prompt {\r\n                color: #58a6ff;\r\n                font-weight: bold;\r\n            }\r\n            .error {\r\n                color: #ff7b72;\r\n            }\r\n            .success {\r\n                color: #3fb950;\r\n            }\r\n            .warning {\r\n                color: #ffa657;\r\n            }\r\n            .info {\r\n                color: #79c0ff;\r\n            }\r\n            .dim {\r\n                color: #8b949e;\r\n            }\r\n            .scrollbar {\r\n                scrollbar-width: thin;\r\n                scrollbar-color: #21262d #0d1117;\r\n            }\r\n            .scrollbar::-webkit-scrollbar {\r\n                width: 8px;\r\n            }\r\n            .scrollbar::-webkit-scrollbar-track {\r\n                background: #0d1117;\r\n            }\r\n            .scrollbar::-webkit-scrollbar-thumb {\r\n                background: #21262d;\r\n                border-radius: 4px;\r\n            }\r\n            .scrollbar::-webkit-scrollbar-thumb:hover {\r\n                background: #30363d;\r\n            }\r\n            .system-status {\r\n                display: flex;\r\n                gap: 15px;\r\n                font-size: 11px;\r\n            }\r\n            .status-item {\r\n                display: flex;\r\n                align-items: center;\r\n                gap: 5px;\r\n            }\r\n            .status-dot {\r\n                width: 6px;\r\n                height: 6px;\r\n                border-radius: 50%;\r\n                background: #3fb950;\r\n            }\r\n            .status-dot.inactive {\r\n                background: #f85149;\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div class=\"header\">\r\n            <div class=\"title\">üß† Claude-Flow Console</div>\r\n            <div class=\"system-status\">\r\n                <div class=\"status-item\">\r\n                    <div class=\"status-dot\" id=\"ws-status\"></div>\r\n                    <span id=\"ws-text\">Connecting...</span>\r\n                </div>\r\n                <div class=\"status-item\">\r\n                    <div class=\"status-dot\" id=\"cli-status\"></div>\r\n                    <span id=\"cli-text\">CLI Ready</span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        <div class=\"console-container\">\r\n            <div class=\"console-output scrollbar\" id=\"output\"></div>\r\n            <input type=\"text\" class=\"console-input\" id=\"input\" placeholder=\"Enter claude-flow command...\" autocomplete=\"off\">\r\n        </div>\r\n\r\n        <script>\r\n            const output = document.getElementById('output');\r\n            const input = document.getElementById('input');\r\n            const wsStatus = document.getElementById('ws-status');\r\n            const wsText = document.getElementById('ws-text');\r\n            const cliStatus = document.getElementById('cli-status');\r\n            const cliText = document.getElementById('cli-text');\r\n            \r\n            let ws = null;\r\n            let commandHistory = [];\r\n            let historyIndex = -1;\r\n            let reconnectAttempts = 0;\r\n            let reconnectTimer = null;\r\n            let isReconnecting = false;\r\n            const MAX_RECONNECT_ATTEMPTS = 10;\r\n            const BASE_RECONNECT_DELAY = 1000;\r\n            \r\n            function getReconnectDelay() {\r\n                // Exponential backoff with jitter\r\n                const exponentialDelay = Math.min(BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts), 30000);\r\n                const jitter = Math.random() * 0.3 * exponentialDelay;\r\n                return exponentialDelay + jitter;\r\n            }\r\n            \r\n            function connect() {\r\n                if (isReconnecting || (ws && ws.readyState === WebSocket.CONNECTING)) {\r\n                    console.log('Already connecting, skipping duplicate attempt');\r\n                    return;\r\n                }\r\n                \r\n                isReconnecting = true;\r\n                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n                const wsUrl = \\`\\${protocol}//\\${window.location.host}\\`;\r\n                \r\n                try {\r\n                    console.log(\\`Attempting WebSocket connection to \\${wsUrl}\\`);\r\n                    ws = new WebSocket(wsUrl);\r\n                    \r\n                    ws.onopen = () => {\r\n                        console.log('WebSocket connected successfully');\r\n                        wsStatus.classList.remove('inactive');\r\n                        wsText.textContent = 'Connected';\r\n                        reconnectAttempts = 0;\r\n                        isReconnecting = false;\r\n                        \r\n                        if (reconnectTimer) {\r\n                            clearTimeout(reconnectTimer);\r\n                            reconnectTimer = null;\r\n                        }\r\n                        \r\n                        appendOutput('\\n<span class=\"success\">üîó Connected to Claude-Flow Console</span>\\n');\r\n                        appendOutput('<span class=\"info\">Type \"help\" for available commands or use any claude-flow command</span>\\n\\n');\r\n                    };\r\n                    \r\n                    ws.onmessage = (event) => {\r\n                        try {\r\n                            const data = JSON.parse(event.data);\r\n                            handleMessage(data);\r\n                        } catch (error) {\r\n                            console.error('Failed to parse WebSocket message:', error);\r\n                            appendOutput(\\`\\n<span class=\"error\">‚ùå Invalid message received: \\${(error instanceof Error ? error.message : String(error))}</span>\\n\\`);\r\n                        }\r\n                    };\r\n                    \r\n                    ws.onclose = (event) => {\r\n                        console.log(\\`WebSocket closed: code=\\${event.code}, reason=\\${event.reason}\\`);\r\n                        wsStatus.classList.add('inactive');\r\n                        wsText.textContent = 'Disconnected';\r\n                        isReconnecting = false;\r\n                        \r\n                        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\r\n                            reconnectAttempts++;\r\n                            const delay = getReconnectDelay();\r\n                            appendOutput(\\`\\n<span class=\"error\">üîó Connection lost. Reconnecting in \\${Math.round(delay/1000)}s... (attempt \\${reconnectAttempts}/\\${MAX_RECONNECT_ATTEMPTS})</span>\\n\\`);\r\n                            \r\n                            reconnectTimer = setTimeout(() => {\r\n                                reconnectTimer = null;\r\n                                connect();\r\n                            }, delay);\r\n                        } else {\r\n                            appendOutput(\\`\\n<span class=\"error\">‚ùå Failed to reconnect after \\${MAX_RECONNECT_ATTEMPTS} attempts. Please refresh the page.</span>\\n\\`);\r\n                            wsText.textContent = 'Failed to connect';\r\n                        }\r\n                    };\r\n                    \r\n                    ws.onerror = (error) => {\r\n                        console.error('WebSocket error:', error);\r\n                        appendOutput(\\`\\n<span class=\"error\">‚ùå WebSocket error: \\${(error instanceof Error ? error.message : String(error)) || 'Connection failed'}</span>\\n\\`);\r\n                        isReconnecting = false;\r\n                    };\r\n                    \r\n                } catch (error) {\r\n                    console.error('Failed to create WebSocket:', error);\r\n                    appendOutput(\\`\\n<span class=\"error\">‚ùå Failed to create WebSocket connection: \\${(error instanceof Error ? error.message : String(error))}</span>\\n\\`);\r\n                    isReconnecting = false;\r\n                    \r\n                    // Try reconnect if not exceeded max attempts\r\n                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\r\n                        reconnectAttempts++;\r\n                        const delay = getReconnectDelay();\r\n                        reconnectTimer = setTimeout(() => {\r\n                            reconnectTimer = null;\r\n                            connect();\r\n                        }, delay);\r\n                    }\r\n                }\r\n            }\r\n            \r\n            function handleMessage(data) {\r\n                switch (data.type) {\r\n                    case 'output':\r\n                        appendOutput(data.data);\r\n                        break;\r\n                    case 'error':\r\n                        appendOutput('<span class=\"error\">' + data.data + '</span>');\r\n                        break;\r\n                    case 'command_complete':\r\n                        appendOutput('\\n<span class=\"prompt\">claude-flow> </span>');\r\n                        break;\r\n                    case 'status':\r\n                        updateStatus(data.data);\r\n                        break;\r\n                }\r\n            }\r\n            \r\n            function appendOutput(text) {\r\n                output.innerHTML += text;\r\n                output.scrollTop = output.scrollHeight;\r\n            }\r\n            \r\n            function updateStatus(status) {\r\n                // Update CLI status based on server response\r\n                if (status.cliActive) {\r\n                    cliStatus.classList.remove('inactive');\r\n                    cliText.textContent = 'CLI Active';\r\n                } else {\r\n                    cliStatus.classList.add('inactive');\r\n                    cliText.textContent = 'CLI Inactive';\r\n                }\r\n            }\r\n            \r\n            function sendCommand(command) {\r\n                if (ws && ws.readyState === WebSocket.OPEN) {\r\n                    appendOutput('<span class=\"prompt\">claude-flow> </span>' + command + '\\n');\r\n                    ws.send(JSON.stringify({\r\n                        type: 'command',\r\n                        data: command\r\n                    }));\r\n                    \r\n                    // Add to history\r\n                    if (command.trim() && commandHistory[commandHistory.length - 1] !== command) {\r\n                        commandHistory.push(command);\r\n                        if (commandHistory.length > 100) {\r\n                            commandHistory.shift();\r\n                        }\r\n                    }\r\n                    historyIndex = commandHistory.length;\r\n                }\r\n            }\r\n            \r\n            // Input handling\r\n            input.addEventListener('keydown', (e) => {\r\n                if (e.key === 'Enter') {\r\n                    const command = input.value.trim();\r\n                    if (command) {\r\n                        sendCommand(command);\r\n                        input.value = '';\r\n                    }\r\n                } else if (e.key === 'ArrowUp') {\r\n                    e.preventDefault();\r\n                    if (historyIndex > 0) {\r\n                        historyIndex--;\r\n                        input.value = commandHistory[historyIndex] || '';\r\n                    }\r\n                } else if (e.key === 'ArrowDown') {\r\n                    e.preventDefault();\r\n                    if (historyIndex < commandHistory.length - 1) {\r\n                        historyIndex++;\r\n                        input.value = commandHistory[historyIndex] || '';\r\n                    } else {\r\n                        historyIndex = commandHistory.length;\r\n                        input.value = '';\r\n                    }\r\n                } else if (e.key === 'Tab') {\r\n                    e.preventDefault();\r\n                    // Basic tab completion for common commands\r\n                    const value = input.value;\r\n                    const commands = ['help', 'status', 'agent', 'task', 'memory', 'config', 'start', 'stop'];\r\n                    const matches = commands.filter(cmd => cmd.startsWith(value));\r\n                    if (matches.length === 1) {\r\n                        input.value = matches[0] + ' ';\r\n                    }\r\n                }\r\n            });\r\n            \r\n            // Focus input on page load\r\n            window.addEventListener('load', () => {\r\n                input.focus();\r\n                connect();\r\n            });\r\n            \r\n            // Implement heartbeat to detect stale connections\r\n            setInterval(() => {\r\n                if (ws && ws.readyState === WebSocket.OPEN) {\r\n                    ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));\r\n                }\r\n            }, 30000); // Ping every 30 seconds\r\n            \r\n            // Handle page visibility changes\r\n            document.addEventListener('visibilitychange', () => {\r\n                if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) {\r\n                    console.log('Page became visible, checking connection...');\r\n                    reconnectAttempts = 0; // Reset attempts when page becomes visible\r\n                    connect();\r\n                }\r\n            });\r\n            \r\n            // Keep input focused\r\n            document.addEventListener('click', () => {\r\n                input.focus();\r\n            });\r\n        </script>\r\n    </body>\r\n    </html>\r\n  `;\r\n\r\n  app.get('/', (req, res) => {\r\n    res.send(consoleHTML);\r\n  });\r\n\r\n  // API endpoints\r\n  app.get('/api/status', (req, res) => {\r\n    res.json({\r\n      components: componentStatus,\r\n      metrics: {\r\n        agents: agents.size,\r\n        tasks: tasks.size,\r\n        memory: memory.size,\r\n        connectedClients: activeConnections.size,\r\n      },\r\n    });\r\n  });\r\n\r\n  app.get('/api/history', (req, res) => {\r\n    const limit = parseInt(req.query.limit as string) || 100;\r\n    res.json({\r\n      history: outputHistory.slice(-limit),\r\n      total: outputHistory.length,\r\n    });\r\n  });\r\n\r\n  app.post('/api/command', express.json(), (req, res) => {\r\n    const { command } = req.body;\r\n    if (!command) {\r\n      res.status(400).json({ error: 'Command is required' });\r\n      return;\r\n    }\r\n\r\n    // Execute command and return immediately\r\n    // Output will be sent via WebSocket\r\n    try {\r\n      broadcastToClients({\r\n        type: 'output',\r\n        data: `<span class=\"prompt\">API> </span>${command}\\\\n`,\r\n      });\r\n\r\n      executeCliCommand(command, null);\r\n\r\n      res.json({ success: true, message: 'Command executed' });\r\n    } catch (error) {\r\n      res.status(500).json({ error: error instanceof Error ? error.message : String(error) });\r\n    }\r\n  });\r\n\r\n  app.get('/api/agents', (req, res) => {\r\n    const agentList = Array.from(agents.entries()).map(([id, agent]) => ({\r\n      id,\r\n      ...agent,\r\n    }));\r\n    res.json(agentList);\r\n  });\r\n\r\n  app.get('/api/tasks', (req, res) => {\r\n    const taskList = Array.from(tasks.entries()).map(([id, task]) => ({\r\n      id,\r\n      ...task,\r\n    }));\r\n    res.json(taskList);\r\n  });\r\n\r\n  app.get('/api/memory', (req, res) => {\r\n    const memoryList = Array.from(memory.entries()).map(([key, value]) => ({\r\n      key,\r\n      value,\r\n      type: typeof value,\r\n      size: JSON.stringify(value).length,\r\n    }));\r\n    res.json(memoryList);\r\n  });\r\n\r\n  // Health check endpoint\r\n  app.get('/health', (req, res) => {\r\n    res.json({\r\n      status: 'healthy',\r\n      timestamp: new Date().toISOString(),\r\n      uptime: process.uptime(),\r\n      components: componentStatus,\r\n    });\r\n  });\r\n\r\n  // WebSocket for real-time CLI interaction\r\n  wss.on('connection', (ws, req) => {\r\n    const clientIp = req.headers['x-forwarded-for'] || req.socket.remoteAddress;\r\n    console.log(`üîå WebSocket client connected from ${clientIp}`);\r\n    activeConnections.add(ws);\r\n\r\n    // Send initial status and history\r\n    ws.send(\r\n      JSON.stringify({\r\n        type: 'status',\r\n        data: { ...componentStatus, cliActive: true },\r\n      }),\r\n    );\r\n\r\n    // Send recent output history\r\n    outputHistory.slice(-50).forEach((line) => {\r\n      ws.send(\r\n        JSON.stringify({\r\n          type: 'output',\r\n          data: line,\r\n        }),\r\n      );\r\n    });\r\n\r\n    // Handle incoming commands\r\n    ws.on('message', (message) => {\r\n      try {\r\n        const data = JSON.parse(message.toString());\r\n        console.log(`Received command from client: ${data.type}`);\r\n\r\n        if (data.type === 'command') {\r\n          handleCliCommand(data.data, ws);\r\n        } else if (data.type === 'ping') {\r\n          // Handle ping/pong for connection keepalive\r\n          ws.send(JSON.stringify({ type: 'pong', timestamp: Date.now() }));\r\n        }\r\n      } catch (error) {\r\n        console.error('Failed to handle WebSocket message:', error);\r\n        ws.send(\r\n          JSON.stringify({\r\n            type: 'error',\r\n            data: `Invalid message format: ${error instanceof Error ? error.message : String(error)}`,\r\n            timestamp: new Date().toISOString(),\r\n          }),\r\n        );\r\n      }\r\n    });\r\n\r\n    ws.on('close', () => {\r\n      console.log('üîå WebSocket client disconnected');\r\n      activeConnections.delete(ws);\r\n    });\r\n\r\n    ws.on('error', (error) => {\r\n      console.error('WebSocket client error:', error);\r\n      // Send detailed error information to client before closing\r\n      try {\r\n        ws.send(\r\n          JSON.stringify({\r\n            type: 'error',\r\n            data: `Server WebSocket error: ${(error instanceof Error ? error.message : String(error)) || 'Unknown error'}`,\r\n            timestamp: new Date().toISOString(),\r\n          }),\r\n        );\r\n      } catch (sendError) {\r\n        console.error('Failed to send error to client:', sendError);\r\n      }\r\n      activeConnections.delete(ws);\r\n    });\r\n  });\r\n\r\n  // Helper function to send response to specific client or broadcast\r\n  function sendResponse(ws: any, data: any) {\r\n    if (ws) {\r\n      ws.send(JSON.stringify(data));\r\n    } else {\r\n      broadcastToClients(data);\r\n    }\r\n  }\r\n\r\n  // CLI command execution handler\r\n  function handleCliCommand(command: string, ws: any) {\r\n    try {\r\n      // Add timestamp and format output\r\n      const timestamp = new Date().toLocaleTimeString();\r\n      const logEntry = `[${timestamp}] Executing: ${command}`;\r\n      outputHistory.push(logEntry);\r\n\r\n      // Broadcast to all connected clients\r\n      broadcastToClients({\r\n        type: 'output',\r\n        data: `<span class=\"dim\">[${timestamp}]</span> <span class=\"info\">Executing:</span> ${command}\\\\n`,\r\n      });\r\n\r\n      // Execute the command\r\n      executeCliCommand(command, ws);\r\n    } catch (error) {\r\n      const errorMsg = `Error executing command: ${error instanceof Error ? error.message : String(error)}`;\r\n      outputHistory.push(errorMsg);\r\n      sendResponse(ws, {\r\n        type: 'error',\r\n        data: errorMsg,\r\n      });\r\n    }\r\n  }\r\n\r\n  // Execute CLI commands and capture output\r\n  function executeCliCommand(command: string, ws: any) {\r\n    // Handle built-in commands first\r\n    if (command === 'help') {\r\n      const helpText = `<span class=\"success\">Available Commands:</span>\r\n‚Ä¢ <span class=\"info\">help</span> - Show this help message\r\n‚Ä¢ <span class=\"info\">status</span> - Show system status\r\n‚Ä¢ <span class=\"info\">agent list</span> - List all agents\r\n‚Ä¢ <span class=\"info\">agent spawn [type]</span> - Spawn a new agent\r\n‚Ä¢ <span class=\"info\">task list</span> - List all tasks\r\n‚Ä¢ <span class=\"info\">memory list</span> - List memory entries\r\n‚Ä¢ <span class=\"info\">config show</span> - Show configuration\r\n‚Ä¢ <span class=\"info\">clear</span> - Clear console\r\n‚Ä¢ <span class=\"info\">version</span> - Show version information\r\n\r\n<span class=\"warning\">Note:</span> This is a web console interface for claude-flow CLI commands.\r\n`;\r\n      sendResponse(ws, {\r\n        type: 'output',\r\n        data: helpText,\r\n      });\r\n      sendResponse(ws, { type: 'command_complete' });\r\n      return;\r\n    }\r\n\r\n    if (command === 'clear') {\r\n      sendResponse(ws, {\r\n        type: 'output',\r\n        data: '\\\\x1b[2J\\\\x1b[H', // ANSI clear screen\r\n      });\r\n      sendResponse(ws, { type: 'command_complete' });\r\n      return;\r\n    }\r\n\r\n    if (command === 'status') {\r\n      const statusText = `<span class=\"success\">System Status:</span>\r\n‚Ä¢ Event Bus: <span class=\"${componentStatus.eventBus ? 'success' : 'error'}\">${componentStatus.eventBus ? 'Active' : 'Inactive'}</span>\r\n‚Ä¢ Orchestrator: <span class=\"${componentStatus.orchestrator ? 'success' : 'error'}\">${componentStatus.orchestrator ? 'Active' : 'Inactive'}</span>\r\n‚Ä¢ Memory Manager: <span class=\"${componentStatus.memoryManager ? 'success' : 'error'}\">${componentStatus.memoryManager ? 'Active' : 'Inactive'}</span>\r\n‚Ä¢ Terminal Pool: <span class=\"${componentStatus.terminalPool ? 'success' : 'error'}\">${componentStatus.terminalPool ? 'Active' : 'Inactive'}</span>\r\n‚Ä¢ MCP Server: <span class=\"${componentStatus.mcpServer ? 'success' : 'error'}\">${componentStatus.mcpServer ? 'Active' : 'Inactive'}</span>\r\n‚Ä¢ Coordination Manager: <span class=\"${componentStatus.coordinationManager ? 'success' : 'error'}\">${componentStatus.coordinationManager ? 'Active' : 'Inactive'}</span>\r\n‚Ä¢ Web UI: <span class=\"${componentStatus.webUI ? 'success' : 'error'}\">${componentStatus.webUI ? 'Active' : 'Inactive'}</span>\r\n\r\n<span class=\"info\">Metrics:</span>\r\n‚Ä¢ Active Agents: ${agents.size}\r\n‚Ä¢ Pending Tasks: ${tasks.size}\r\n‚Ä¢ Memory Entries: ${memory.size}\r\n`;\r\n      sendResponse(ws, {\r\n        type: 'output',\r\n        data: statusText,\r\n      });\r\n      sendResponse(ws, { type: 'command_complete' });\r\n      return;\r\n    }\r\n\r\n    // For other commands, spawn a subprocess\r\n    const args = command.split(' ');\r\n    const cmd = args[0];\r\n    const cmdArgs = args.slice(1);\r\n\r\n    // Determine the correct claude-flow executable path\r\n    const rootDir = path.resolve(__dirname, '../..');\r\n    const cliPath = path.join(rootDir, 'bin', 'claude-flow');\r\n\r\n    // Spawn the command\r\n    const child = spawn('node', [path.join(rootDir, 'src/cli/simple-cli.js'), ...cmdArgs], {\r\n      stdio: ['pipe', 'pipe', 'pipe'],\r\n      env: { ...process.env, CLAUDE_FLOW_WEB_MODE: 'true' },\r\n    });\r\n\r\n    // Handle stdout\r\n    child.stdout.on('data', (data) => {\r\n      const output = data.toString();\r\n      outputHistory.push(output);\r\n\r\n      // Convert ANSI colors to HTML spans\r\n      const htmlOutput = convertAnsiToHtml(output);\r\n\r\n      broadcastToClients({\r\n        type: 'output',\r\n        data: htmlOutput,\r\n      });\r\n    });\r\n\r\n    // Handle stderr\r\n    child.stderr.on('data', (data) => {\r\n      const error = data.toString();\r\n      outputHistory.push(error);\r\n\r\n      broadcastToClients({\r\n        type: 'error',\r\n        data: convertAnsiToHtml(error),\r\n      });\r\n    });\r\n\r\n    // Handle process exit\r\n    child.on('close', (code) => {\r\n      const exitMsg =\r\n        code === 0\r\n          ? `<span class=\"success\">Command completed successfully</span>`\r\n          : `<span class=\"error\">Command failed with exit code ${code}</span>`;\r\n\r\n      broadcastToClients({\r\n        type: 'output',\r\n        data: `\\\\n${exitMsg}\\\\n`,\r\n      });\r\n\r\n      sendResponse(ws, { type: 'command_complete' });\r\n    });\r\n\r\n    child.on('error', (error) => {\r\n      const errorMsg = `<span class=\"error\">Failed to execute command: ${error instanceof Error ? error.message : String(error)}</span>`;\r\n      outputHistory.push(errorMsg);\r\n\r\n      sendResponse(ws, {\r\n        type: 'error',\r\n        data: errorMsg,\r\n      });\r\n\r\n      sendResponse(ws, { type: 'command_complete' });\r\n    });\r\n  }\r\n\r\n  // Broadcast message to all connected clients\r\n  function broadcastToClients(message: any) {\r\n    const messageStr = JSON.stringify(message);\r\n    activeConnections.forEach((client) => {\r\n      if (client.readyState === 1) {\r\n        // WebSocket.OPEN\r\n        client.send(messageStr);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Convert ANSI escape codes to HTML\r\n  function convertAnsiToHtml(text: string): string {\r\n    return text\r\n      .replace(/\\x1b\\[0m/g, '</span>')\r\n      .replace(/\\x1b\\[1m/g, '<span style=\"font-weight: bold;\">')\r\n      .replace(/\\x1b\\[31m/g, '<span class=\"error\">')\r\n      .replace(/\\x1b\\[32m/g, '<span class=\"success\">')\r\n      .replace(/\\x1b\\[33m/g, '<span class=\"warning\">')\r\n      .replace(/\\x1b\\[34m/g, '<span class=\"info\">')\r\n      .replace(/\\x1b\\[35m/g, '<span style=\"color: #d946ef;\">')\r\n      .replace(/\\x1b\\[36m/g, '<span style=\"color: #06b6d4;\">')\r\n      .replace(/\\x1b\\[37m/g, '<span class=\"dim\">')\r\n      .replace(/\\x1b\\[90m/g, '<span class=\"dim\">')\r\n      .replace(/\\x1b\\[[0-9;]*m/g, '') // Remove any remaining ANSI codes\r\n      .replace(/\\n/g, '\\\\n')\r\n      .replace(/</g, '&lt;')\r\n      .replace(/>/g, '&gt;')\r\n      .replace(/&lt;span/g, '<span')\r\n      .replace(/span&gt;/g, 'span>');\r\n  }\r\n\r\n  return new Promise((resolve, reject) => {\r\n    server.on('error', (err: any) => {\r\n      if (err.code === 'EADDRINUSE') {\r\n        console.error(`\\n‚ùå Port ${port} is already in use`);\r\n        console.log(`üí° Try a different port: claude-flow start --ui --port ${port + 1}`);\r\n        console.log(`üí° Or stop the process using port ${port}: lsof -ti:${port} | xargs kill -9`);\r\n        componentStatus.webUI = false;\r\n        reject(err);\r\n      } else {\r\n        console.error('‚ùå Web UI server error:', err.message, err.stack);\r\n        reject(err);\r\n      }\r\n    });\r\n\r\n    server.listen(port, host, () => {\r\n      console.log(`üåê Web UI available at http://${host}:${port}`);\r\n      componentStatus.webUI = true;\r\n      resolve(server);\r\n    });\r\n  });\r\n}\r\n\r\n// Start all components\r\nexport async function startOrchestrator(options: any) {\r\n  console.log('\\nüöÄ Starting orchestration components...\\n');\r\n\r\n  // Start Event Bus\r\n  console.log('‚ö° Starting Event Bus...');\r\n  componentStatus.eventBus = true;\r\n  eventBus.emit('system:start');\r\n  console.log('‚úÖ Event Bus started');\r\n\r\n  // Start Orchestrator Engine\r\n  console.log('üß† Starting Orchestrator Engine...');\r\n  componentStatus.orchestrator = true;\r\n  console.log('‚úÖ Orchestrator Engine started');\r\n\r\n  // Start Memory Manager\r\n  console.log('üíæ Starting Memory Manager...');\r\n  componentStatus.memoryManager = true;\r\n  console.log('‚úÖ Memory Manager started');\r\n\r\n  // Start Terminal Pool\r\n  console.log('üñ•Ô∏è  Starting Terminal Pool...');\r\n  componentStatus.terminalPool = true;\r\n  console.log('‚úÖ Terminal Pool started');\r\n\r\n  // Start MCP Server\r\n  const mcpPort = options.mcpPort || 3001;\r\n  startMCPServer(mcpPort);\r\n  console.log('‚úÖ MCP Server started');\r\n\r\n  // Start Coordination Manager\r\n  console.log('üîÑ Starting Coordination Manager...');\r\n  componentStatus.coordinationManager = true;\r\n  console.log('‚úÖ Coordination Manager started');\r\n\r\n  // Start Web UI if requested\r\n  if (options.ui && !options.noUi) {\r\n    const host = options.host || 'localhost';\r\n    const port = options.port || 3000;\r\n    try {\r\n      await startWebUI(host, port);\r\n    } catch (err: any) {\r\n      if (err.code === 'EADDRINUSE') {\r\n        console.log('\\n‚ö†Ô∏è  Web UI could not start due to port conflict');\r\n        console.log('   Orchestrator is running without Web UI');\r\n      } else {\r\n        console.error('\\n‚ö†Ô∏è  Web UI failed to start:', err.message);\r\n      }\r\n    }\r\n  }\r\n\r\n  console.log('\\n‚úÖ All components started successfully!');\r\n  console.log('\\nüìä System Status:');\r\n  console.log('   ‚Ä¢ Event Bus: Active');\r\n  console.log('   ‚Ä¢ Orchestrator: Active');\r\n  console.log('   ‚Ä¢ Memory Manager: Active');\r\n  console.log('   ‚Ä¢ Terminal Pool: Active');\r\n  console.log('   ‚Ä¢ MCP Server: Active');\r\n  console.log('   ‚Ä¢ Coordination Manager: Active');\r\n  if (options.ui && !options.noUi) {\r\n    console.log(\r\n      `   ‚Ä¢ Web UI: Active at http://${options.host || 'localhost'}:${options.port || 3000}`,\r\n    );\r\n  }\r\n\r\n  console.log('\\nüí° Use \"claude-flow status\" to check system status');\r\n  console.log('üí° Use \"claude-flow stop\" to stop the orchestrator');\r\n\r\n  // Keep the process running\r\n  if (!options.daemon) {\r\n    console.log('\\nüìå Press Ctrl+C to stop the orchestrator...\\n');\r\n\r\n    // Handle graceful shutdown\r\n    process.on('SIGINT', () => {\r\n      console.log('\\n\\nüõë Shutting down orchestrator...');\r\n      process.exit(0);\r\n    });\r\n  }\r\n}\r\n\r\n// Export component status for other commands\r\nexport function getComponentStatus() {\r\n  return componentStatus;\r\n}\r\n\r\n// Export stores for other commands\r\nexport function getStores() {\r\n  return { agents, tasks, memory };\r\n}\r\n"],"names":["EventEmitter","express","WebSocketServer","createServer","spawn","path","fileURLToPath","cors","__filename","url","__dirname","dirname","agents","Map","tasks","memory","eventBus","componentStatus","orchestrator","memoryManager","terminalPool","mcpServer","coordinationManager","webUI","startMCPServer","port","console","log","startWebUI","host","app","server","wss","use","origin","methods","allowedHeaders","credentials","err","req","res","next","error","status","json","message","timestamp","Date","toISOString","method","outputHistory","activeConnections","Set","cliProcess","consoleHTML","get","send","components","metrics","size","connectedClients","limit","parseInt","query","history","slice","total","length","post","command","body","broadcastToClients","type","data","executeCliCommand","success","Error","String","agentList","Array","from","entries","map","id","agent","taskList","task","memoryList","key","value","JSON","stringify","uptime","process","on","ws","clientIp","headers","socket","remoteAddress","add","cliActive","forEach","line","parse","toString","handleCliCommand","now","delete","sendError","sendResponse","toLocaleTimeString","logEntry","push","errorMsg","helpText","statusText","args","split","cmd","cmdArgs","rootDir","resolve","cliPath","join","child","stdio","env","CLAUDE_FLOW_WEB_MODE","stdout","output","htmlOutput","convertAnsiToHtml","stderr","code","exitMsg","messageStr","client","readyState","text","replace","Promise","reject","stack","listen","startOrchestrator","options","emit","mcpPort","ui","noUi","daemon","exit","getComponentStatus","getStores"],"mappings":"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"}
{"version":3,"sources":["../../../../src/cli/simple-commands/automation-executor.js"],"sourcesContent":["/**\r\n * Modular Automation Executor for Claude Flow\r\n * \r\n * This module provides the core infrastructure for executing automation\r\n * workflows with Claude CLI integration, while preserving existing \r\n * swarm and hive-mind functionality.\r\n */\r\n\r\nimport { promises as fs } from 'fs';\r\nimport { spawn } from 'child_process';\r\nimport { join, dirname } from 'path';\r\nimport { printSuccess, printError, printWarning } from '../utils.js';\r\n\r\n// Simple ID generator\r\nfunction generateId(prefix = 'id') {\r\n  return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n}\r\n\r\n/**\r\n * WorkflowExecutor - Core class for executing automation workflows\r\n */\r\nexport class WorkflowExecutor {\r\n  constructor(options = {}) {\r\n    this.options = {\r\n      enableClaude: false,\r\n      nonInteractive: false,\r\n      outputFormat: 'text',\r\n      maxConcurrency: 3,\r\n      timeout: 3600000, // 1 hour default\r\n      logLevel: 'info',\r\n      ...options\r\n    };\r\n    \r\n    // Increase timeout for ML workflows\r\n    if (options.workflowType === 'ml' || options.workflowName?.toLowerCase().includes('mle')) {\r\n      this.options.timeout = 7200000; // 2 hours for ML workflows\r\n    }\r\n    \r\n    // Execution state\r\n    this.executionId = generateId('workflow-exec');\r\n    this.startTime = Date.now();\r\n    this.activeTasks = new Map();\r\n    this.claudeInstances = new Map();\r\n    this.results = new Map();\r\n    this.errors = [];\r\n    this.currentWorkflow = null;\r\n    \r\n    // Stream chaining support\r\n    this.taskOutputStreams = new Map(); // Store output streams for chaining\r\n    this.enableChaining = options.enableChaining !== false; // Default to true\r\n    \r\n    // Hooks integration\r\n    this.hooksEnabled = true;\r\n    this.sessionId = generateId('automation-session');\r\n  }\r\n\r\n  /**\r\n   * Execute a workflow from JSON definition\r\n   */\r\n  async executeWorkflow(workflowData, variables = {}) {\r\n    try {\r\n      // Store workflow for reference\r\n      this.currentWorkflow = workflowData;\r\n      \r\n      if (this.options.logLevel === 'quiet') {\r\n        console.log(`ğŸš€ Executing workflow: ${this.executionId}`);\r\n      } else {\r\n        console.log(`ğŸš€ Starting workflow execution: ${this.executionId}`);\r\n        console.log(`ğŸ“‹ Workflow: ${workflowData.name}`);\r\n        console.log(`ğŸ¯ Strategy: MLE-STAR Machine Learning Engineering`);\r\n        \r\n        if (this.options.enableClaude) {\r\n          console.log(`ğŸ¤– Claude CLI Integration: Enabled`);\r\n        }\r\n        \r\n        if (this.options.nonInteractive) {\r\n          console.log(`ğŸ–¥ï¸  Non-Interactive Mode: Enabled`);\r\n          if (this.options.outputFormat === 'stream-json') {\r\n            console.log();\r\n            console.log('â— Running MLE-STAR workflow with Claude CLI integration');\r\n            console.log('  â¿  Command format: claude --print --output-format stream-json --verbose --dangerously-skip-permissions');\r\n            console.log('  â¿  Each agent will show real-time stream output below');\r\n            console.log('  â¿  Interactive-style formatting enabled');\r\n          }\r\n        }\r\n      }\r\n      \r\n      console.log();\r\n\r\n      // Pre-execution hooks\r\n      if (this.hooksEnabled) {\r\n        await this.executeHook('pre-task', {\r\n          description: `Execute workflow: ${workflowData.name}`,\r\n          sessionId: this.sessionId\r\n        });\r\n      }\r\n\r\n      // Validate workflow\r\n      this.validateWorkflow(workflowData);\r\n      \r\n      // Apply variable substitutions\r\n      const processedWorkflow = this.applyVariables(workflowData, variables);\r\n      \r\n      // Initialize agents if Claude integration is enabled\r\n      if (this.options.enableClaude) {\r\n        await this.initializeClaudeAgents(processedWorkflow.agents);\r\n      }\r\n      \r\n      // Execute workflow phases\r\n      const result = await this.executeWorkflowTasks(processedWorkflow);\r\n      \r\n      // Post-execution hooks\r\n      if (this.hooksEnabled) {\r\n        await this.executeHook('post-task', {\r\n          taskId: this.executionId,\r\n          sessionId: this.sessionId,\r\n          result: result.success ? 'success' : 'failure'\r\n        });\r\n      }\r\n      \r\n      const duration = Date.now() - this.startTime;\r\n      \r\n      if (result.success) {\r\n        printSuccess(`âœ… Workflow completed successfully in ${this.formatDuration(duration)}`);\r\n        console.log(`ğŸ“Š Tasks: ${result.completedTasks}/${result.totalTasks} completed`);\r\n        console.log(`ğŸ†” Execution ID: ${this.executionId}`);\r\n      } else {\r\n        printError(`âŒ Workflow failed after ${this.formatDuration(duration)}`);\r\n        console.log(`ğŸ“Š Tasks: ${result.completedTasks}/${result.totalTasks} completed`);\r\n        console.log(`âŒ Errors: ${this.errors.length}`);\r\n      }\r\n      \r\n      // Cleanup Claude instances\r\n      if (this.options.enableClaude) {\r\n        await this.cleanupClaudeInstances();\r\n      }\r\n      \r\n      return result;\r\n      \r\n    } catch (error) {\r\n      printError(`Workflow execution failed: ${error.message}`);\r\n      await this.cleanupClaudeInstances();\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize Claude CLI instances for agents\r\n   */\r\n  async initializeClaudeAgents(agents) {\r\n    if (!agents || agents.length === 0) {\r\n      return;\r\n    }\r\n    \r\n    // Check if Claude CLI is available\r\n    if (!await this.isClaudeAvailable()) {\r\n      throw new Error('Claude CLI not found. Please install Claude Code: https://claude.ai/code');\r\n    }\r\n\r\n    if (this.options.nonInteractive) {\r\n      // Non-interactive mode: agents are spawned per task instead\r\n      if (this.options.logLevel !== 'quiet') {\r\n        console.log(`ğŸ¤– Non-interactive mode: Claude instances will be spawned per task`);\r\n        console.log(`ğŸ“‹ Each task will launch its own Claude process with specific prompts`);\r\n      }\r\n      return;\r\n    } else {\r\n      // Interactive mode: spawn single Claude instance with master coordination prompt\r\n      console.log(`ğŸ¤– Interactive mode: Initializing single Claude instance for workflow coordination...`);\r\n      \r\n      try {\r\n        // Create master coordination prompt for all agents and workflow\r\n        const masterPrompt = this.createMasterCoordinationPrompt(agents);\r\n        \r\n        // Spawn single Claude instance for workflow coordination\r\n        const claudeProcess = await this.spawnClaudeInstance({\r\n          id: 'master-coordinator',\r\n          name: 'Workflow Coordinator',\r\n          type: 'coordinator'\r\n        }, masterPrompt);\r\n        \r\n        // Store as master coordinator\r\n        this.claudeInstances.set('master-coordinator', {\r\n          process: claudeProcess,\r\n          agent: { id: 'master-coordinator', name: 'Workflow Coordinator', type: 'coordinator' },\r\n          status: 'active',\r\n          startTime: Date.now(),\r\n          agents: agents // Store agent definitions for reference\r\n        });\r\n        \r\n        console.log(`  âœ… Master Workflow Coordinator (PID: ${claudeProcess.pid})`);\r\n        console.log(`  ğŸ¯ Coordinating ${agents.length} sub-agents via concurrent streams`);\r\n        console.log(`  ğŸ“‹ Agents: ${agents.map(a => a.name).join(', ')}`);\r\n        \r\n      } catch (error) {\r\n        console.error(`  âŒ Failed to initialize master coordinator: ${error.message}`);\r\n        this.errors.push({\r\n          type: 'master_coordinator_initialization',\r\n          error: error.message,\r\n          timestamp: new Date()\r\n        });\r\n      }\r\n      \r\n      console.log();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if Claude CLI is available\r\n   */\r\n  async isClaudeAvailable() {\r\n    try {\r\n      const { execSync } = await import('child_process');\r\n      execSync('which claude', { stdio: 'ignore' });\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Spawn a Claude CLI instance for an agent\r\n   * @param {Object} agent - The agent configuration\r\n   * @param {string} prompt - The prompt for the agent\r\n   * @param {Object} options - Additional options\r\n   * @param {Stream} options.inputStream - Optional input stream from previous agent\r\n   * @param {boolean} options.enableChaining - Whether to enable stream-json chaining\r\n   */\r\n  async spawnClaudeInstance(agent, prompt, options = {}) {\r\n    const claudeArgs = [];\r\n    \r\n    // Add flags based on mode\r\n    if (this.options.nonInteractive) {\r\n      // Non-interactive mode: use --print with stream-json output\r\n      claudeArgs.push('--print');\r\n      if (this.options.outputFormat === 'stream-json') {\r\n        claudeArgs.push('--output-format', 'stream-json');\r\n        claudeArgs.push('--verbose'); // Required for stream-json\r\n        \r\n        // Add input format if we're chaining from a previous agent\r\n        if (options.inputStream) {\r\n          claudeArgs.push('--input-format', 'stream-json');\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Always skip permissions for automated workflows (both interactive and non-interactive)\r\n    claudeArgs.push('--dangerously-skip-permissions');\r\n    \r\n    // Always add the prompt as the final argument\r\n    claudeArgs.push(prompt);\r\n    \r\n    // Only show command details in verbose mode\r\n    if (this.options.logLevel === 'debug') {\r\n      const displayPrompt = prompt.length > 100 ? prompt.substring(0, 100) + '...' : prompt;\r\n      const flagsDisplay = this.options.nonInteractive ? \r\n        (this.options.outputFormat === 'stream-json' ? \r\n          (options.inputStream ? '--print --input-format stream-json --output-format stream-json --verbose --dangerously-skip-permissions' : '--print --output-format stream-json --verbose --dangerously-skip-permissions') : \r\n          '--print --dangerously-skip-permissions') : \r\n        '--dangerously-skip-permissions';\r\n      console.log(`    ğŸ¤– Spawning Claude for ${agent.name}: claude ${flagsDisplay} \"${displayPrompt}\"`);\r\n    } else if (this.options.logLevel !== 'quiet') {\r\n      console.log(`    ğŸš€ Starting ${agent.name}`);\r\n    }\r\n    \r\n    // Determine stdio configuration based on mode and chaining\r\n    const stdioConfig = this.options.nonInteractive ? \r\n      [options.inputStream ? 'pipe' : 'inherit', 'pipe', 'pipe'] : // Non-interactive: pipe for chaining\r\n      ['inherit', 'inherit', 'inherit']; // Interactive: inherit all for normal Claude interaction\r\n    \r\n    // Spawn Claude process\r\n    const claudeProcess = spawn('claude', claudeArgs, {\r\n      stdio: stdioConfig,\r\n      shell: false,\r\n    });\r\n    \r\n    // If we have an input stream, pipe it to Claude's stdin\r\n    if (options.inputStream && claudeProcess.stdin) {\r\n      console.log(`    ğŸ”— Chaining: Piping output from previous agent to ${agent.name}`);\r\n      options.inputStream.pipe(claudeProcess.stdin);\r\n    }\r\n    \r\n    // Handle stdout with stream processor for better formatting (only in non-interactive mode)\r\n    if (this.options.nonInteractive && this.options.outputFormat === 'stream-json' && claudeProcess.stdout) {\r\n      // Import and use stream processor\r\n      const { createStreamProcessor } = await import('./stream-processor.js');\r\n      const streamProcessor = createStreamProcessor(\r\n        agent.name,\r\n        this.getAgentIcon(agent.id),\r\n        {\r\n          verbose: this.options.logLevel === 'debug',\r\n          logLevel: this.options.logLevel,\r\n          taskId: agent.taskId,\r\n          agentId: agent.id,\r\n          display: null // Interactive-style formatting instead of concurrent display\r\n        }\r\n      );\r\n      \r\n      // Pipe stdout through processor\r\n      claudeProcess.stdout.pipe(streamProcessor);\r\n      \r\n      // Handle stderr for non-interactive mode\r\n      claudeProcess.stderr.on('data', (data) => {\r\n        const message = data.toString().trim();\r\n        if (message) {\r\n          console.error(`    âŒ [${agent.name}] Error: ${message}`);\r\n        }\r\n      });\r\n    } else if (this.options.nonInteractive && this.options.outputFormat !== 'stream-json') {\r\n      // For non-interactive non-stream-json output, show stdout directly\r\n      claudeProcess.stdout.on('data', (data) => {\r\n        console.log(data.toString().trimEnd());\r\n      });\r\n      \r\n      claudeProcess.stderr.on('data', (data) => {\r\n        console.error(data.toString().trimEnd());\r\n      });\r\n    }\r\n    // Note: In interactive mode, stdio is inherited so Claude handles its own I/O\r\n    \r\n    // Handle process events\r\n    claudeProcess.on('error', (error) => {\r\n      console.error(`âŒ Claude instance error for ${agent.name}:`, error.message);\r\n      this.errors.push({\r\n        type: 'claude_instance_error',\r\n        agent: agent.id,\r\n        error: error.message,\r\n        timestamp: new Date()\r\n      });\r\n    });\r\n    \r\n    claudeProcess.on('exit', (code) => {\r\n      const instance = this.claudeInstances.get(agent.id);\r\n      if (instance) {\r\n        instance.status = code === 0 ? 'completed' : 'failed';\r\n        instance.exitCode = code;\r\n        instance.endTime = Date.now();\r\n      }\r\n    });\r\n    \r\n    return claudeProcess;\r\n  }\r\n\r\n  /**\r\n   * Handle Claude stream events\r\n   */\r\n  handleClaudeStreamEvent(agent, event) {\r\n    if (this.options.outputFormat === 'stream-json') {\r\n      // Create concise formatted JSON with summary\r\n      const summary = this.getEventSummary(event);\r\n      const icon = this.getEventIcon(event.type);\r\n      \r\n      // Simplified output for better readability\r\n      const output = {\r\n        t: new Date().toISOString().split('T')[1].split('.')[0], // HH:MM:SS\r\n        agent: `${this.getAgentIcon(agent.id)} ${agent.name}`,\r\n        phase: this.currentPhase,\r\n        event: `${icon} ${summary}`\r\n      };\r\n      \r\n      // Add relevant details based on event type\r\n      if (event.type === 'tool_use' && event.name) {\r\n        output.tool = event.name;\r\n      } else if (event.type === 'error' && event.error) {\r\n        output.error = event.error;\r\n      }\r\n      \r\n      console.log(JSON.stringify(output));\r\n    } else {\r\n      // Format output for text mode\r\n      switch (event.type) {\r\n        case 'tool_use':\r\n          console.log(`    [${agent.name}] ğŸ”§ Using tool: ${event.name}`);\r\n          break;\r\n        case 'message':\r\n          console.log(`    [${agent.name}] ğŸ’¬ ${event.content}`);\r\n          break;\r\n        case 'completion':\r\n          console.log(`    [${agent.name}] âœ… Task completed`);\r\n          break;\r\n        case 'error':\r\n          console.error(`    [${agent.name}] âŒ Error: ${event.error}`);\r\n          break;\r\n        default:\r\n          // Log other events in debug mode\r\n          if (this.options.logLevel === 'debug') {\r\n            console.log(`    [${agent.name}] ${event.type}: ${JSON.stringify(event)}`);\r\n          }\r\n      }\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Get a brief summary of an event\r\n   */\r\n  getEventSummary(event) {\r\n    switch (event.type) {\r\n      case 'tool_use':\r\n        return `Using ${event.name} tool`;\r\n      case 'message':\r\n        return event.content?.substring(0, 100) + (event.content?.length > 100 ? '...' : '');\r\n      case 'completion':\r\n        return 'Task completed successfully';\r\n      case 'error':\r\n        return `Error: ${event.error}`;\r\n      case 'status':\r\n        return event.status || 'Status update';\r\n      default:\r\n        return event.type;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Get icon for event type\r\n   */\r\n  getEventIcon(eventType) {\r\n    const icons = {\r\n      'tool_use': 'ğŸ”§',\r\n      'message': 'ğŸ’¬',\r\n      'completion': 'âœ…',\r\n      'error': 'âŒ',\r\n      'status': 'ğŸ“Š',\r\n      'init': 'ğŸš€',\r\n      'thinking': 'ğŸ¤”',\r\n      'result': 'ğŸ“‹'\r\n    };\r\n    return icons[eventType] || 'ğŸ“Œ';\r\n  }\r\n\r\n  /**\r\n   * Create task-specific Claude prompt with comprehensive MLE-STAR instructions\r\n   */\r\n  createTaskPrompt(task, agent, workflow) {\r\n    // Use the claudePrompt from the task if available\r\n    if (task.claudePrompt) {\r\n      // Apply variable substitutions to the prompt\r\n      let basePrompt = task.claudePrompt;\r\n      const allVariables = { ...workflow.variables, ...task.input };\r\n      \r\n      for (const [key, value] of Object.entries(allVariables)) {\r\n        const pattern = new RegExp(`\\\\$\\\\{${key}\\\\}`, 'g');\r\n        basePrompt = basePrompt.replace(pattern, value);\r\n      }\r\n      \r\n      // Create comprehensive task prompt with MLE-STAR methodology\r\n      return `ğŸ¯ MLE-STAR AGENT TASK EXECUTION\r\n\r\nYou are the **${agent.name}** (${agent.type}) in a coordinated MLE-STAR automation workflow.\r\n\r\nğŸ“‹ IMMEDIATE TASK:\r\n${basePrompt}\r\n\r\nğŸ¤– AGENT ROLE & SPECIALIZATION:\r\n${this.getAgentRoleDescription(agent.type)}\r\n\r\nğŸ¯ AGENT CAPABILITIES:\r\n${agent.config?.capabilities?.join(', ') || 'general automation'}\r\n\r\nğŸ”¬ MLE-STAR METHODOLOGY FOCUS:\r\n${this.getMethodologyGuidance(agent.type)}\r\n\r\nğŸ”§ COORDINATION REQUIREMENTS:\r\n1. **HOOKS INTEGRATION** (CRITICAL):\r\n   - BEFORE starting: \\`npx claude-flow@alpha hooks pre-task --description \"${task.description}\"\\`\r\n   - AFTER each file operation: \\`npx claude-flow@alpha hooks post-edit --file \"[filepath]\"\\`\r\n   - WHEN complete: \\`npx claude-flow@alpha hooks post-task --task-id \"${task.id}\"\\`\r\n\r\n2. **MEMORY STORAGE** (CRITICAL):\r\n   - Store findings: \\`npx claude-flow@alpha memory store \"agent/${agent.id}/findings\" \"[your_findings]\"\\`\r\n   - Store results: \\`npx claude-flow@alpha memory store \"agent/${agent.id}/results\" \"[your_results]\"\\`\r\n   - Check other agents: \\`npx claude-flow@alpha memory search \"agent/*\"\\`\r\n\r\n3. **SESSION COORDINATION**:\r\n   - Session ID: ${this.sessionId}\r\n   - Execution ID: ${this.executionId}\r\n   - Task ID: ${task.id}\r\n   - Agent ID: ${agent.id}\r\n\r\n4. **WORKFLOW PIPELINE AWARENESS**:\r\n   - Your position: ${this.getAgentPositionInPipeline(agent.type)}\r\n   - Coordinate with: ${this.getCoordinationPartners(agent.type)}\r\n   - File naming: Use \\`${agent.id}_[component].[ext]\\` convention\r\n\r\n5. **OUTPUT REQUIREMENTS**:\r\n   - Use detailed progress reporting\r\n   - Document methodology decisions\r\n   - Provide clear deliverables\r\n   - Follow MLE-STAR best practices for your role\r\n\r\nğŸš€ EXECUTION INSTRUCTIONS:\r\n1. Start with hooks pre-task command\r\n2. Execute your specialized MLE-STAR role\r\n3. Store all findings and results in memory\r\n4. Coordinate with other agents as needed\r\n5. Complete with hooks post-task command\r\n6. Exit when task is fully complete\r\n\r\nğŸ¯ SUCCESS CRITERIA:\r\n- Task objective completed according to MLE-STAR methodology\r\n- All coordination hooks executed successfully  \r\n- Results stored in memory for other agents\r\n- Clear documentation of approach and findings\r\n- Ready for next pipeline phase\r\n\r\nBegin execution now with the hooks pre-task command.`;\r\n    } else {\r\n      // Fallback to full agent prompt\r\n      return this.createAgentPrompt(agent);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create agent-specific Claude prompt\r\n   */\r\n  createAgentPrompt(agent) {\r\n    const { config } = agent;\r\n    const capabilities = config?.capabilities?.join(', ') || 'general automation';\r\n    \r\n    return `You are the ${agent.name} in a coordinated MLE-STAR automation workflow.\r\n\r\nğŸ¯ AGENT ROLE: ${agent.type.toUpperCase()}\r\nğŸ“‹ CAPABILITIES: ${capabilities}\r\nğŸ†” AGENT ID: ${agent.id}\r\n\r\nCRITICAL COORDINATION REQUIREMENTS:\r\n1. HOOKS: Use claude-flow hooks for coordination:\r\n   - Run \"npx claude-flow@alpha hooks pre-task --description '[your task]'\" before starting\r\n   - Run \"npx claude-flow@alpha hooks post-edit --file '[file]'\" after each file operation  \r\n   - Run \"npx claude-flow@alpha hooks post-task --task-id '${agent.id}'\" when complete\r\n\r\n2. MEMORY: Store all findings and results:\r\n   - Use \"npx claude-flow@alpha memory store 'agent/${agent.id}/[key]' '[value]'\" for important data\r\n   - Check \"npx claude-flow@alpha memory search 'agent/*'\" for coordination with other agents\r\n\r\n3. SESSION: Maintain session coordination:\r\n   - Session ID: ${this.sessionId}\r\n   - Execution ID: ${this.executionId}\r\n\r\nAGENT-SPECIFIC CONFIGURATION:\r\n${JSON.stringify(config, null, 2)}\r\n\r\nMLE-STAR METHODOLOGY FOCUS:\r\n${this.getMethodologyGuidance(agent.type)}\r\n\r\nWORKFLOW COORDINATION:\r\n- Work with other agents in the pipeline: Search â†’ Foundation â†’ Refinement â†’ Ensemble â†’ Validation\r\n- Share findings through memory system\r\n- Use proper file naming conventions: ${agent.id}_[component].[ext]\r\n- Follow MLE-STAR best practices for your role\r\n\r\nExecute your role in the MLE-STAR workflow with full coordination and hook integration.`;\r\n  }\r\n\r\n  /**\r\n   * Create master coordination prompt for interactive mode\r\n   */\r\n  createMasterCoordinationPrompt(agents) {\r\n    const workflowData = this.currentWorkflow || { name: 'MLE-STAR Workflow', description: 'Machine Learning Engineering via Search and Targeted Refinement' };\r\n    \r\n    return `ğŸš€ MLE-STAR WORKFLOW COORDINATION MASTER\r\n\r\nYou are the MASTER COORDINATOR for a comprehensive MLE-STAR (Machine Learning Engineering via Search and Targeted Refinement) workflow. \r\n\r\nğŸ“‹ WORKFLOW: ${workflowData.name}\r\nğŸ¯ DESCRIPTION: ${workflowData.description}\r\nğŸ†” EXECUTION ID: ${this.executionId}\r\nğŸ”„ SESSION ID: ${this.sessionId}\r\n\r\nğŸ¤– SUB-AGENTS TO COORDINATE (${agents.length} total):\r\n${agents.map((agent, index) => `\r\n${index + 1}. ${agent.name} (${agent.type})\r\n   ğŸ¯ Role: ${this.getAgentRoleDescription(agent.type)}\r\n   ğŸ“‹ Capabilities: ${agent.config?.capabilities?.join(', ') || 'general automation'}\r\n   ğŸ†” ID: ${agent.id}`).join('')}\r\n\r\nğŸ”§ CRITICAL: USE CONCURRENT STREAMS FOR PARALLEL EXECUTION\r\n\r\nYou MUST coordinate these agents using Claude's concurrent execution capabilities:\r\n\r\n1. **USE TASK TOOL FOR CONCURRENT AGENTS**: \r\n   For each sub-agent, use the Task tool to spawn them with detailed prompts:\r\n   \r\n   Task(\"You are ${agent.name}. ${detailed_role_prompt}\", \"${agent.id}\", \"agent-${agent.type}\")\r\n\r\n2. **PARALLEL EXECUTION PATTERN**:\r\n   Execute multiple agents simultaneously using the Task tool in a single response:\r\n   \r\n   \\`\\`\\`\r\n   Task(\"Detailed prompt for Search Agent...\", \"search_agent\", \"researcher\")\r\n   Task(\"Detailed prompt for Foundation Agent...\", \"foundation_agent\", \"coder\") \r\n   Task(\"Detailed prompt for Refinement Agent...\", \"refinement_agent\", \"optimizer\")\r\n   Task(\"Detailed prompt for Ensemble Agent...\", \"ensemble_agent\", \"analyst\")\r\n   Task(\"Detailed prompt for Validation Agent...\", \"validation_agent\", \"tester\")\r\n   \\`\\`\\`\r\n\r\n3. **DETAILED SUB-AGENT PROMPTS**:\r\n   Each Task call should include comprehensive instructions:\r\n   - Specific MLE-STAR role and responsibilities\r\n   - Required actions and deliverables\r\n   - Coordination requirements with other agents\r\n   - Output format specifications\r\n   - Use of --output-format stream-json for progress tracking\r\n\r\n4. **COORDINATION WORKFLOW**:\r\n   Phase 1: Search & Foundation (parallel)\r\n   Phase 2: Refinement & Optimization (depends on Phase 1)\r\n   Phase 3: Ensemble & Validation (depends on Phase 2)\r\n\r\n5. **OUTPUT MANAGEMENT**:\r\n   Instruct each agent to use appropriate Claude CLI flags:\r\n   - Use --print --output-format stream-json --verbose for real-time progress\r\n   - Coordinate results through file system and memory\r\n\r\nğŸ¯ YOUR MISSION:\r\n1. Launch all ${agents.length} sub-agents using concurrent Task calls\r\n2. Provide detailed, specific prompts for each agent's MLE-STAR role\r\n3. Coordinate the workflow execution phases\r\n4. Monitor progress and provide updates\r\n5. Synthesize final results\r\n\r\nMETHODOLOGY PHASES:\r\n${this.getMasterMethodologyGuide()}\r\n\r\nğŸš€ BEGIN: Start by deploying all sub-agents with detailed prompts using the Task tool for concurrent execution. Each agent should receive comprehensive instructions for their specific MLE-STAR role.`;\r\n  }\r\n\r\n  /**\r\n   * Get agent role description for coordination\r\n   */\r\n  getAgentRoleDescription(agentType) {\r\n    const roles = {\r\n      researcher: 'Web Search & Foundation Discovery - Find state-of-the-art approaches',\r\n      coder: 'Model Implementation & Training Pipeline - Build foundation models',  \r\n      optimizer: 'Performance Tuning & Architecture Refinement - Optimize models',\r\n      analyst: 'Ensemble Methods & Meta-Learning - Combine multiple approaches',\r\n      tester: 'Validation & Debugging - Ensure quality and performance',\r\n      coordinator: 'Workflow Orchestration - Manage overall pipeline'\r\n    };\r\n    return roles[agentType] || 'Specialized automation task execution';\r\n  }\r\n\r\n  /**\r\n   * Get comprehensive methodology guide for master coordinator\r\n   */\r\n  getMasterMethodologyGuide() {\r\n    return `\r\nPHASE 1 - SEARCH & FOUNDATION (Parallel):\r\nğŸ”¬ Search Agent: Research ML approaches, algorithms, and best practices\r\nğŸ’» Foundation Agent: Implement baseline models and training infrastructure\r\n\r\nPHASE 2 - REFINEMENT (Sequential, depends on Phase 1):\r\nâš¡ Refinement Agent: Optimize models, tune hyperparameters, improve performance\r\n\r\nPHASE 3 - ENSEMBLE & VALIDATION (Parallel, depends on Phase 2):\r\nğŸ›ï¸ Ensemble Agent: Combine models, implement voting/stacking strategies\r\nğŸ§ª Validation Agent: Test, debug, validate performance, generate reports\r\n\r\nCOORDINATION KEY POINTS:\r\n- Use shared file system for intermediate results\r\n- Maintain communication through progress updates\r\n- Each phase builds on previous phases\r\n- Final deliverable: Production-ready ML pipeline`;\r\n  }\r\n\r\n  /**\r\n   * Get agent position in MLE-STAR pipeline\r\n   */\r\n  getAgentPositionInPipeline(agentType) {\r\n    const positions = {\r\n      researcher: 'Phase 1: Search & Foundation Discovery (Parallel with Foundation)',\r\n      coder: 'Phase 1: Foundation Model Building (Parallel with Search)',\r\n      optimizer: 'Phase 2: Refinement & Optimization (Sequential, depends on Phase 1)',\r\n      analyst: 'Phase 3: Ensemble & Meta-Learning (Parallel with Validation)',\r\n      tester: 'Phase 3: Validation & Debugging (Parallel with Ensemble)',\r\n      coordinator: 'All Phases: Workflow Orchestration & Coordination'\r\n    };\r\n    return positions[agentType] || 'Specialized task execution';\r\n  }\r\n\r\n  /**\r\n   * Get coordination partners for agent type\r\n   */\r\n  getCoordinationPartners(agentType) {\r\n    const partners = {\r\n      researcher: 'Foundation Agent (parallel), Refinement Agent (handoff)',\r\n      coder: 'Search Agent (parallel), Refinement Agent (handoff)',\r\n      optimizer: 'Search & Foundation Agents (input), Ensemble & Validation Agents (handoff)',\r\n      analyst: 'Refinement Agent (input), Validation Agent (parallel)',\r\n      tester: 'All previous agents (validation), Ensemble Agent (parallel)',\r\n      coordinator: 'All agents (orchestration and monitoring)'\r\n    };\r\n    return partners[agentType] || 'Other workflow agents as needed';\r\n  }\r\n\r\n  /**\r\n   * Get methodology guidance for agent type\r\n   */\r\n  getMethodologyGuidance(agentType) {\r\n    const guidance = {\r\n      researcher: `SEARCH PHASE - Web Research & Foundation Discovery:\r\n- Search for state-of-the-art ML approaches for the problem domain\r\n- Find winning Kaggle solutions and benchmark results\r\n- Identify promising model architectures and techniques\r\n- Document implementation examples and model cards\r\n- Focus on proven, recent approaches with good performance`,\r\n\r\n      coder: `FOUNDATION PHASE - Initial Model Building:\r\n- Analyze dataset characteristics and problem type\r\n- Implement baseline models based on research findings\r\n- Create robust preprocessing pipelines\r\n- Build modular, testable code components\r\n- Establish performance baselines for comparison`,\r\n\r\n      optimizer: `REFINEMENT PHASE - Targeted Component Optimization:\r\n- Perform ablation analysis to identify high-impact components\r\n- Focus deep optimization on most impactful pipeline elements\r\n- Use iterative improvement with structured feedback\r\n- Implement advanced feature engineering techniques\r\n- Optimize hyperparameters systematically`,\r\n\r\n      architect: `ENSEMBLE PHASE - Intelligent Model Combination:\r\n- Create sophisticated ensemble strategies beyond simple averaging\r\n- Implement stacking with meta-learners\r\n- Use dynamic weighting and mixture of experts\r\n- Apply Bayesian model averaging where appropriate\r\n- Optimize ensemble composition for maximum performance`,\r\n\r\n      tester: `VALIDATION PHASE - Comprehensive Testing & Debugging:\r\n- Implement rigorous cross-validation strategies\r\n- Detect and prevent data leakage\r\n- Perform error analysis and debugging\r\n- Validate model robustness and generalization\r\n- Ensure production readiness with quality checks`,\r\n\r\n      coordinator: `ORCHESTRATION PHASE - Workflow Management:\r\n- Coordinate between all agents and phases\r\n- Monitor progress and performance metrics\r\n- Manage resource allocation and scheduling\r\n- Handle error recovery and workflow adaptation\r\n- Prepare final deployment and documentation`\r\n    };\r\n\r\n    return guidance[agentType] || 'Focus on your specialized capabilities and coordinate with other agents.';\r\n  }\r\n\r\n  /**\r\n   * Execute workflow tasks with dependency management\r\n   */\r\n  async executeWorkflowTasks(workflow) {\r\n    const { tasks, dependencies = {} } = workflow;\r\n    \r\n    let completedTasks = 0;\r\n    let failedTasks = 0;\r\n    const totalTasks = tasks.length;\r\n    \r\n    // Task status tracking\r\n    const taskStatuses = new Map();\r\n    tasks.forEach(task => {\r\n      taskStatuses.set(task.id, {\r\n        name: task.name || task.id,\r\n        status: 'pending',\r\n        agent: task.assignTo,\r\n        startTime: null,\r\n        endTime: null,\r\n        summary: ''\r\n      });\r\n    });\r\n    \r\n    // Create task execution plan based on dependencies\r\n    const executionPlan = this.createExecutionPlan(tasks, dependencies);\r\n    \r\n    console.log(`ğŸ“‹ Executing ${totalTasks} tasks in ${executionPlan.length} phases...`);\r\n    console.log();\r\n    \r\n    // Note: Concurrent display disabled in favor of interactive-style stream processing\r\n    let concurrentDisplay = null;\r\n    // if (this.options.nonInteractive && this.options.outputFormat === 'stream-json') {\r\n    //   const { createConcurrentDisplay } = await import('./concurrent-display.js');\r\n    //   \r\n    //   // Get all agents and their tasks\r\n    //   const agentTasks = workflow.agents?.map(agent => ({\r\n    //     id: agent.id,\r\n    //     name: agent.name,\r\n    //     type: agent.type,\r\n    //     tasks: tasks.filter(t => t.assignTo === agent.id).map(t => t.name)\r\n    //   })) || [];\r\n    //   \r\n    //   concurrentDisplay = createConcurrentDisplay(agentTasks);\r\n    //   concurrentDisplay.start();\r\n    //   \r\n    //   // Store reference for stream processors\r\n    //   this.concurrentDisplay = concurrentDisplay;\r\n    // }\r\n    \r\n    // Execute tasks phase by phase\r\n    for (const [phaseIndex, phaseTasks] of executionPlan.entries()) {\r\n      this.currentPhase = `Phase ${phaseIndex + 1}`;\r\n      \r\n      // Show regular task board or update concurrent display\r\n      if (!concurrentDisplay) {\r\n        if (this.options.logLevel === 'quiet') {\r\n          console.log(`\\nğŸ”„ Phase ${phaseIndex + 1}: Running ${phaseTasks.length} tasks`);\r\n        } else {\r\n          console.log(`\\nğŸ”„ Phase ${phaseIndex + 1}: ${phaseTasks.length} concurrent tasks`);\r\n        }\r\n        this.displayTaskBoard(taskStatuses, phaseTasks);\r\n      }\r\n      \r\n      // Mark tasks as in-progress\r\n      phaseTasks.forEach(task => {\r\n        const status = taskStatuses.get(task.id);\r\n        status.status = 'in-progress';\r\n        status.startTime = Date.now();\r\n      });\r\n      \r\n      // Execute tasks in this phase (potentially in parallel)\r\n      const phasePromises = phaseTasks.map(async (task) => {\r\n        const taskStatus = taskStatuses.get(task.id);\r\n        \r\n        try {\r\n          // Show task starting\r\n          console.log(`\\n  ğŸš€ Starting: ${task.name || task.id}`);\r\n          console.log(`     Agent: ${task.assignTo}`);\r\n          console.log(`     Description: ${task.description?.substring(0, 80)}...`);\r\n          \r\n          const result = await this.executeTask(task, workflow);\r\n          \r\n          taskStatus.status = result.success ? 'completed' : 'failed';\r\n          taskStatus.endTime = Date.now();\r\n          taskStatus.summary = result.success ? \r\n            `âœ… Completed in ${this.formatDuration(result.duration)}` :\r\n            `âŒ Failed: ${result.error?.message || 'Unknown error'}`;\r\n          \r\n          return result;\r\n        } catch (error) {\r\n          taskStatus.status = 'failed';\r\n          taskStatus.endTime = Date.now();\r\n          taskStatus.summary = `âŒ Error: ${error.message}`;\r\n          throw error;\r\n        }\r\n      });\r\n      \r\n      // Wait for all phase tasks to complete\r\n      const phaseResults = await Promise.allSettled(phasePromises);\r\n      \r\n      // Process phase results\r\n      for (const [taskIndex, result] of phaseResults.entries()) {\r\n        const task = phaseTasks[taskIndex];\r\n        const taskStatus = taskStatuses.get(task.id);\r\n        \r\n        if (result.status === 'fulfilled' && result.value.success) {\r\n          completedTasks++;\r\n          this.results.set(task.id, result.value);\r\n        } else {\r\n          failedTasks++;\r\n          const error = result.status === 'rejected' ? result.reason : result.value.error;\r\n          this.errors.push({\r\n            type: 'task_execution',\r\n            task: task.id,\r\n            error: error.message || error,\r\n            timestamp: new Date()\r\n          });\r\n          \r\n          // Check if we should fail fast\r\n          if (workflow.settings?.failurePolicy === 'fail-fast') {\r\n            console.log(`\\nğŸ›‘ Failing fast due to task failure`);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Show updated task board\r\n      if (!concurrentDisplay) {\r\n        console.log(`\\nğŸ“Š Phase ${phaseIndex + 1} Complete:`);\r\n        this.displayTaskBoard(taskStatuses);\r\n      }\r\n      \r\n      // Stop if fail-fast and we have failures\r\n      if (workflow.settings?.failurePolicy === 'fail-fast' && failedTasks > 0) {\r\n        break;\r\n      }\r\n    }\r\n    \r\n    // Final summary\r\n    if (!concurrentDisplay) {\r\n      console.log(`\\nğŸ“Š Final Workflow Summary:`);\r\n      this.displayTaskBoard(taskStatuses);\r\n    } else {\r\n      // Stop concurrent display\r\n      concurrentDisplay.stop();\r\n      console.log(); // Add some space after display\r\n    }\r\n    \r\n    return {\r\n      success: failedTasks === 0,\r\n      totalTasks,\r\n      completedTasks,\r\n      failedTasks,\r\n      executionId: this.executionId,\r\n      duration: Date.now() - this.startTime,\r\n      results: Object.fromEntries(this.results),\r\n      errors: this.errors\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Display task board showing current status\r\n   */\r\n  displayTaskBoard(taskStatuses, highlightTasks = []) {\r\n    // In quiet mode, just show simple progress\r\n    if (this.options.logLevel === 'quiet') {\r\n      const totalTasks = taskStatuses.size;\r\n      const completedTasks = Array.from(taskStatuses.values()).filter(s => s.status === 'completed').length;\r\n      const activeTasks = Array.from(taskStatuses.values()).filter(s => s.status === 'in-progress').length;\r\n      console.log(`ğŸ“Š Progress: ${completedTasks}/${totalTasks} completed, ${activeTasks} active`);\r\n      return;\r\n    }\r\n    \r\n    const frames = ['â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â '];\r\n    const frameIndex = Math.floor(Date.now() / 100) % frames.length;\r\n    const spinner = frames[frameIndex];\r\n    \r\n    console.log('\\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');\r\n    console.log('â•‘                    ğŸ¤– CONCURRENT TASK STATUS                   â•‘');\r\n    console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');\r\n    \r\n    // Group by status\r\n    const statusGroups = {\r\n      'in-progress': [],\r\n      'completed': [],\r\n      'failed': [],\r\n      'pending': []\r\n    };\r\n    \r\n    taskStatuses.forEach((status, taskId) => {\r\n      statusGroups[status.status].push({ taskId, ...status });\r\n    });\r\n    \r\n    // Show in-progress tasks with animation\r\n    if (statusGroups['in-progress'].length > 0) {\r\n      console.log(`â•‘ ${spinner} RUNNING (${statusGroups['in-progress'].length} agents):                                      â•‘`);\r\n      statusGroups['in-progress'].forEach(task => {\r\n        const duration = task.startTime ? this.formatDuration(Date.now() - task.startTime) : '';\r\n        const progress = this.getProgressBar(Date.now() - task.startTime, 60000); // 1 min expected\r\n        const agentIcon = this.getAgentIcon(task.agent);\r\n        console.log(`â•‘   ${agentIcon} ${task.name.padEnd(25)} ${progress} ${duration.padStart(8)} â•‘`);\r\n      });\r\n    }\r\n    \r\n    // Show completed tasks\r\n    if (statusGroups['completed'].length > 0) {\r\n      console.log(`â•‘ âœ… COMPLETED (${statusGroups['completed'].length}):                                           â•‘`);\r\n      statusGroups['completed'].forEach(task => {\r\n        const duration = task.endTime && task.startTime ? \r\n          this.formatDuration(task.endTime - task.startTime) : '';\r\n        console.log(`â•‘   âœ“ ${task.name.padEnd(35)} ${duration.padStart(10)} â•‘`);\r\n      });\r\n    }\r\n    \r\n    // Show failed tasks\r\n    if (statusGroups['failed'].length > 0) {\r\n      console.log(`â•‘ âŒ FAILED (${statusGroups['failed'].length}):                                              â•‘`);\r\n      statusGroups['failed'].forEach(task => {\r\n        const errorMsg = (task.summary || '').substring(0, 25);\r\n        console.log(`â•‘   âœ— ${task.name.padEnd(25)} ${errorMsg.padEnd(20)} â•‘`);\r\n      });\r\n    }\r\n    \r\n    // Show pending tasks count\r\n    if (statusGroups['pending'].length > 0) {\r\n      console.log(`â•‘ â³ QUEUED: ${statusGroups['pending'].length} tasks waiting                                 â•‘`);\r\n    }\r\n    \r\n    // Summary stats\r\n    const total = taskStatuses.size;\r\n    const completed = statusGroups['completed'].length;\r\n    const failed = statusGroups['failed'].length;\r\n    const progress = total > 0 ? Math.floor((completed + failed) / total * 100) : 0;\r\n    \r\n    console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');\r\n    console.log(`â•‘ ğŸ“Š Progress: ${progress}% (${completed}/${total}) â”‚ âš¡ Active: ${statusGroups['in-progress'].length} â”‚ âŒ Failed: ${failed}  â•‘`);\r\n    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\r\n  }\r\n  \r\n  /**\r\n   * Get progress bar visualization\r\n   */\r\n  getProgressBar(elapsed, expected) {\r\n    const progress = Math.min(elapsed / expected, 1);\r\n    const filled = Math.floor(progress * 10);\r\n    const empty = 10 - filled;\r\n    return '[' + 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty) + ']';\r\n  }\r\n  \r\n  /**\r\n   * Get agent icon based on type\r\n   */\r\n  getAgentIcon(agentId) {\r\n    const icons = {\r\n      'search': 'ğŸ”',\r\n      'foundation': 'ğŸ—ï¸',\r\n      'refinement': 'ğŸ”§',\r\n      'ensemble': 'ğŸ¯',\r\n      'validation': 'âœ…',\r\n      'coordinator': 'ğŸ®',\r\n      'researcher': 'ğŸ”¬',\r\n      'coder': 'ğŸ’»',\r\n      'optimizer': 'âš¡',\r\n      'architect': 'ğŸ›ï¸',\r\n      'tester': 'ğŸ§ª'\r\n    };\r\n    \r\n    // Extract agent type from ID\r\n    const type = agentId?.split('_')[0] || 'default';\r\n    return icons[type] || 'ğŸ¤–';\r\n  }\r\n\r\n  /**\r\n   * Execute a single task\r\n   */\r\n  async executeTask(task, workflow) {\r\n    const startTime = Date.now();\r\n    \r\n    try {\r\n      // Store task execution in memory if hooks enabled\r\n      if (this.hooksEnabled) {\r\n        await this.executeHook('notify', {\r\n          message: `Starting task: ${task.name || task.id}`,\r\n          sessionId: this.sessionId\r\n        });\r\n      }\r\n      \r\n      if (this.options.nonInteractive && this.options.outputFormat === 'stream-json') {\r\n        console.log(`\\nâ— ${task.name || task.id} - Starting Execution`);\r\n        console.log(`  â¿  ${task.description}`);\r\n        console.log(`  â¿  Agent: ${task.assignTo}`);\r\n      } else {\r\n        console.log(`    ğŸ”„ Executing: ${task.description}`);\r\n      }\r\n      \r\n      // For demonstration/testing mode (when Claude integration is disabled)\r\n      // we simulate successful task completion\r\n      if (!this.options.enableClaude) {\r\n        // Simulate variable execution time\r\n        const executionTime = Math.min(\r\n          1000 + Math.random() * 3000, // 1-4 seconds simulation\r\n          task.timeout || 30000\r\n        );\r\n        \r\n        await new Promise(resolve => setTimeout(resolve, executionTime));\r\n        \r\n        // Simulate successful completion for demo/testing\r\n        const result = {\r\n          success: true,\r\n          taskId: task.id,\r\n          duration: Date.now() - startTime,\r\n          output: {\r\n            status: 'completed',\r\n            agent: task.assignTo,\r\n            executionTime: Date.now() - startTime,\r\n            metadata: {\r\n              timestamp: new Date().toISOString(),\r\n              executionId: this.executionId,\r\n              mode: 'simulation'\r\n            }\r\n          }\r\n        };\r\n        \r\n        // Store result in memory\r\n        if (this.hooksEnabled) {\r\n          await this.storeTaskResult(task.id, result.output);\r\n        }\r\n        \r\n        return result;\r\n      } else {\r\n        // When Claude integration is enabled, delegate to actual Claude instance\r\n        \r\n        // Check if we have a master coordinator (interactive mode)\r\n        const masterCoordinator = this.claudeInstances.get('master-coordinator');\r\n        if (masterCoordinator && !this.options.nonInteractive) {\r\n          // Interactive mode: All tasks are coordinated by the master coordinator\r\n          console.log(`    ğŸ¯ Task delegated to Master Coordinator: ${task.description}`);\r\n          \r\n          // In interactive mode, the master coordinator handles all tasks\r\n          // We just wait for the master coordinator process to complete\r\n          const completionPromise = new Promise((resolve, reject) => {\r\n            masterCoordinator.process.on('exit', (code) => {\r\n              if (code === 0) {\r\n                resolve({ success: true, code });\r\n              } else {\r\n                reject(new Error(`Master coordinator exited with code ${code}`));\r\n              }\r\n            });\r\n            \r\n            masterCoordinator.process.on('error', (err) => {\r\n              reject(err);\r\n            });\r\n          });\r\n          \r\n          // For interactive mode, we use a longer timeout since user interaction is involved\r\n          const timeout = Math.max(this.options.timeout, 1800000); // 30 minutes minimum for interactive\r\n          const timeoutPromise = new Promise((_, reject) => {\r\n            setTimeout(() => reject(new Error('Interactive session timeout')), timeout);\r\n          });\r\n          \r\n          try {\r\n            await Promise.race([completionPromise, timeoutPromise]);\r\n            \r\n            const result = {\r\n              success: true,\r\n              taskId: task.id,\r\n              duration: Date.now() - startTime,\r\n              output: {\r\n                status: 'completed',\r\n                agent: 'master-coordinator',\r\n                executionTime: Date.now() - startTime,\r\n                metadata: {\r\n                  timestamp: new Date().toISOString(),\r\n                  executionId: this.executionId,\r\n                  mode: 'interactive-coordination'\r\n                }\r\n              }\r\n            };\r\n            \r\n            // Store result in memory\r\n            if (this.hooksEnabled) {\r\n              await this.storeTaskResult(task.id, result.output);\r\n            }\r\n            \r\n            return result;\r\n            \r\n          } catch (error) {\r\n            throw new Error(`Task execution failed: ${error.message}`);\r\n          }\r\n        }\r\n        \r\n        // Non-interactive mode or no master coordinator: use individual Claude instances\r\n        const claudeInstance = this.claudeInstances.get(task.assignTo);\r\n        if (!claudeInstance) {\r\n          // If no pre-spawned instance, create one for this task\r\n          const agent = workflow.agents.find(a => a.id === task.assignTo);\r\n          if (!agent) {\r\n            throw new Error(`No agent definition found for: ${task.assignTo}`);\r\n          }\r\n          \r\n          // Create task-specific prompt\r\n          const taskPrompt = this.createTaskPrompt(task, agent, workflow);\r\n          \r\n          // Check if we should chain from a previous task\r\n          let chainOptions = {};\r\n          if (this.enableChaining && this.options.outputFormat === 'stream-json' && task.depends?.length > 0) {\r\n            // Get the output stream from the last dependency\r\n            const lastDependency = task.depends[task.depends.length - 1];\r\n            const dependencyStream = this.taskOutputStreams.get(lastDependency);\r\n            if (dependencyStream) {\r\n              console.log(`    ğŸ”— Enabling stream chaining from ${lastDependency} to ${task.id}`);\r\n              chainOptions.inputStream = dependencyStream;\r\n            }\r\n          }\r\n          \r\n          // Spawn Claude instance for this specific task\r\n          const taskClaudeProcess = await this.spawnClaudeInstance(agent, taskPrompt, chainOptions);\r\n          \r\n          // Store the output stream for potential chaining\r\n          if (this.enableChaining && this.options.outputFormat === 'stream-json' && taskClaudeProcess.stdout) {\r\n            this.taskOutputStreams.set(task.id, taskClaudeProcess.stdout);\r\n          }\r\n          \r\n          // Store the instance\r\n          this.claudeInstances.set(agent.id, {\r\n            process: taskClaudeProcess,\r\n            agent: agent,\r\n            status: 'active',\r\n            startTime: Date.now(),\r\n            taskId: task.id\r\n          });\r\n          \r\n          // Wait for task completion or timeout\r\n          // Use longer timeout for ML tasks\r\n          const baseTimeout = this.options.timeout || 60000;\r\n          const isMLTask = task.type?.toLowerCase().includes('ml') || \r\n                          task.type?.toLowerCase().includes('model') ||\r\n                          task.type?.toLowerCase().includes('search') ||\r\n                          task.type?.toLowerCase().includes('analysis') ||\r\n                          this.options.workflowType === 'ml';\r\n          const timeout = task.timeout || (isMLTask ? Math.max(baseTimeout, 300000) : baseTimeout); // Min 5 minutes for ML tasks\r\n          \r\n          if (this.options.logLevel === 'debug' || this.options.verbose) {\r\n            console.log(`    â±ï¸  Timeout: ${this.formatDuration(timeout)} (Base: ${this.formatDuration(baseTimeout)}, ML Task: ${isMLTask})`);\r\n          }\r\n          \r\n          const completionPromise = new Promise((resolve, reject) => {\r\n            taskClaudeProcess.on('exit', (code) => {\r\n              if (code === 0) {\r\n                resolve({ success: true, code });\r\n              } else {\r\n                reject(new Error(`Process exited with code ${code}`));\r\n              }\r\n            });\r\n            \r\n            taskClaudeProcess.on('error', (err) => {\r\n              reject(err);\r\n            });\r\n          });\r\n          \r\n          const timeoutPromise = new Promise((_, reject) => {\r\n            // Use a much longer timeout for ML tasks since Claude is actively working\r\n            const actualTimeout = isMLTask ? Math.max(timeout, 600000) : timeout; // 10 min minimum for ML\r\n            setTimeout(() => reject(new Error('Task timeout')), actualTimeout);\r\n          });\r\n          \r\n          try {\r\n            await Promise.race([completionPromise, timeoutPromise]);\r\n            \r\n            const result = {\r\n              success: true,\r\n              taskId: task.id,\r\n              duration: Date.now() - startTime,\r\n              output: {\r\n                status: 'completed',\r\n                agent: task.assignTo,\r\n                executionTime: Date.now() - startTime,\r\n                metadata: {\r\n                  timestamp: new Date().toISOString(),\r\n                  executionId: this.executionId,\r\n                  mode: 'claude-task-execution'\r\n                }\r\n              }\r\n            };\r\n            \r\n            // Store result in memory\r\n            if (this.hooksEnabled) {\r\n              await this.storeTaskResult(task.id, result.output);\r\n            }\r\n            \r\n            return result;\r\n          } catch (error) {\r\n            throw error;\r\n          }\r\n        } else {\r\n          // Use existing Claude instance\r\n          // In a full implementation, this would send the task to the running instance\r\n          // For now, we'll spawn a new instance per task for simplicity\r\n          \r\n          const agent = claudeInstance.agent;\r\n          const taskPrompt = this.createTaskPrompt(task, agent, workflow);\r\n          \r\n          // Check if we should chain from a previous task\r\n          let chainOptions = {};\r\n          if (this.enableChaining && this.options.outputFormat === 'stream-json' && task.depends?.length > 0) {\r\n            // Get the output stream from the last dependency\r\n            const lastDependency = task.depends[task.depends.length - 1];\r\n            const dependencyStream = this.taskOutputStreams.get(lastDependency);\r\n            if (dependencyStream) {\r\n              console.log(`    ğŸ”— Enabling stream chaining from ${lastDependency} to ${task.id}`);\r\n              chainOptions.inputStream = dependencyStream;\r\n            }\r\n          }\r\n          \r\n          // For now, spawn a new instance for each task\r\n          const taskClaudeProcess = await this.spawnClaudeInstance(agent, taskPrompt, chainOptions);\r\n          \r\n          // Store the output stream for potential chaining\r\n          if (this.enableChaining && this.options.outputFormat === 'stream-json' && taskClaudeProcess.stdout) {\r\n            this.taskOutputStreams.set(task.id, taskClaudeProcess.stdout);\r\n          }\r\n          \r\n          // Wait for completion\r\n          // Use longer timeout for ML tasks\r\n          const baseTimeout = this.options.timeout || 60000;\r\n          const isMLTask = task.type?.toLowerCase().includes('ml') || \r\n                          task.type?.toLowerCase().includes('model') ||\r\n                          task.type?.toLowerCase().includes('search') ||\r\n                          task.type?.toLowerCase().includes('analysis') ||\r\n                          this.options.workflowType === 'ml';\r\n          const timeout = task.timeout || (isMLTask ? Math.max(baseTimeout, 300000) : baseTimeout); // Min 5 minutes for ML tasks\r\n          \r\n          if (this.options.logLevel === 'debug' || this.options.verbose) {\r\n            console.log(`    â±ï¸  Timeout: ${this.formatDuration(timeout)} (Base: ${this.formatDuration(baseTimeout)}, ML Task: ${isMLTask})`);\r\n          }\r\n          \r\n          const completionPromise = new Promise((resolve, reject) => {\r\n            taskClaudeProcess.on('exit', (code) => {\r\n              if (code === 0) {\r\n                resolve({ success: true, code });\r\n              } else {\r\n                reject(new Error(`Process exited with code ${code}`));\r\n              }\r\n            });\r\n            \r\n            taskClaudeProcess.on('error', (err) => {\r\n              reject(err);\r\n            });\r\n          });\r\n          \r\n          const timeoutPromise = new Promise((_, reject) => {\r\n            // Use a much longer timeout for ML tasks since Claude is actively working\r\n            const actualTimeout = isMLTask ? Math.max(timeout, 600000) : timeout; // 10 min minimum for ML\r\n            setTimeout(() => reject(new Error('Task timeout')), actualTimeout);\r\n          });\r\n          \r\n          try {\r\n            await Promise.race([completionPromise, timeoutPromise]);\r\n            \r\n            const result = {\r\n              success: true,\r\n              taskId: task.id,\r\n              duration: Date.now() - startTime,\r\n              output: {\r\n                status: 'completed',\r\n                agent: task.assignTo,\r\n                executionTime: Date.now() - startTime,\r\n                metadata: {\r\n                  timestamp: new Date().toISOString(),\r\n                  executionId: this.executionId,\r\n                  mode: 'claude-task-execution'\r\n                }\r\n              }\r\n            };\r\n            \r\n            // Store result in memory\r\n            if (this.hooksEnabled) {\r\n              await this.storeTaskResult(task.id, result.output);\r\n            }\r\n            \r\n            return result;\r\n          } catch (error) {\r\n            throw error;\r\n          }\r\n        }\r\n      }\r\n      \r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        taskId: task.id,\r\n        duration: Date.now() - startTime,\r\n        error: error\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create execution plan based on task dependencies\r\n   */\r\n  createExecutionPlan(tasks, dependencies) {\r\n    const taskMap = new Map(tasks.map(task => [task.id, task]));\r\n    const completed = new Set();\r\n    const phases = [];\r\n    \r\n    while (completed.size < tasks.length) {\r\n      const readyTasks = tasks.filter(task => {\r\n        if (completed.has(task.id)) return false;\r\n        \r\n        const deps = task.depends || dependencies[task.id] || [];\r\n        return deps.every(dep => completed.has(dep));\r\n      });\r\n      \r\n      if (readyTasks.length === 0) {\r\n        throw new Error('Circular dependency detected or invalid dependencies');\r\n      }\r\n      \r\n      phases.push(readyTasks);\r\n      readyTasks.forEach(task => completed.add(task.id));\r\n    }\r\n    \r\n    return phases;\r\n  }\r\n\r\n  /**\r\n   * Execute a hook command\r\n   */\r\n  async executeHook(hookType, params) {\r\n    try {\r\n      const { execSync } = await import('child_process');\r\n      \r\n      let hookCommand = `npx claude-flow@alpha hooks ${hookType}`;\r\n      \r\n      if (params.description) {\r\n        hookCommand += ` --description \"${params.description}\"`;\r\n      }\r\n      if (params.file) {\r\n        hookCommand += ` --file \"${params.file}\"`;\r\n      }\r\n      if (params.taskId) {\r\n        hookCommand += ` --task-id \"${params.taskId}\"`;\r\n      }\r\n      if (params.sessionId) {\r\n        hookCommand += ` --session-id \"${params.sessionId}\"`;\r\n      }\r\n      if (params.message) {\r\n        hookCommand += ` --message \"${params.message}\"`;\r\n      }\r\n      \r\n      execSync(hookCommand, { stdio: 'pipe' });\r\n      \r\n    } catch (error) {\r\n      // Hooks are optional, don't fail the workflow if they fail\r\n      console.debug(`Hook ${hookType} failed:`, error.message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Store task result in memory\r\n   */\r\n  async storeTaskResult(taskId, result) {\r\n    try {\r\n      const { execSync } = await import('child_process');\r\n      const resultJson = JSON.stringify(result);\r\n      \r\n      execSync(`npx claude-flow@alpha memory store \"workflow/${this.executionId}/${taskId}\" '${resultJson}'`, {\r\n        stdio: 'pipe'\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.debug(`Failed to store task result for ${taskId}:`, error.message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate workflow definition\r\n   */\r\n  validateWorkflow(workflow) {\r\n    if (!workflow.name) {\r\n      throw new Error('Workflow name is required');\r\n    }\r\n    \r\n    if (!workflow.tasks || workflow.tasks.length === 0) {\r\n      throw new Error('Workflow must contain at least one task');\r\n    }\r\n    \r\n    // Validate task structure\r\n    for (const task of workflow.tasks) {\r\n      if (!task.id || !task.type || !task.description) {\r\n        throw new Error(`Task ${task.id || 'unknown'} is missing required fields`);\r\n      }\r\n    }\r\n    \r\n    // Validate agent assignments\r\n    if (workflow.agents) {\r\n      const agentIds = new Set(workflow.agents.map(a => a.id));\r\n      for (const task of workflow.tasks) {\r\n        if (task.assignTo && !agentIds.has(task.assignTo)) {\r\n          throw new Error(`Task ${task.id} assigned to unknown agent: ${task.assignTo}`);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply variable substitutions to workflow\r\n   */\r\n  applyVariables(workflow, variables) {\r\n    const allVariables = { ...workflow.variables, ...variables };\r\n    const workflowStr = JSON.stringify(workflow);\r\n    \r\n    // Simple variable substitution\r\n    let processedStr = workflowStr;\r\n    for (const [key, value] of Object.entries(allVariables)) {\r\n      const pattern = new RegExp(`\\\\$\\\\{${key}\\\\}`, 'g');\r\n      processedStr = processedStr.replace(pattern, value);\r\n    }\r\n    \r\n    return JSON.parse(processedStr);\r\n  }\r\n\r\n  /**\r\n   * Cleanup Claude instances\r\n   */\r\n  async cleanupClaudeInstances() {\r\n    if (this.claudeInstances.size === 0) return;\r\n    \r\n    console.log('ğŸ§¹ Cleaning up Claude instances...');\r\n    \r\n    for (const [agentId, instance] of this.claudeInstances.entries()) {\r\n      try {\r\n        if (instance.process && !instance.process.killed) {\r\n          instance.process.kill('SIGTERM');\r\n          \r\n          // Wait for graceful shutdown, then force kill if needed\r\n          setTimeout(() => {\r\n            if (!instance.process.killed) {\r\n              instance.process.kill('SIGKILL');\r\n            }\r\n          }, 5000);\r\n        }\r\n        \r\n        console.log(`  âœ… Cleaned up ${instance.agent.name}`);\r\n        \r\n      } catch (error) {\r\n        console.error(`  âŒ Error cleaning up ${instance.agent.name}:`, error.message);\r\n      }\r\n    }\r\n    \r\n    this.claudeInstances.clear();\r\n  }\r\n\r\n  /**\r\n   * Format duration in human readable format\r\n   */\r\n  formatDuration(ms) {\r\n    const seconds = Math.floor(ms / 1000);\r\n    const minutes = Math.floor(seconds / 60);\r\n    const hours = Math.floor(minutes / 60);\r\n    \r\n    if (hours > 0) {\r\n      return `${hours}h ${minutes % 60}m ${seconds % 60}s`;\r\n    } else if (minutes > 0) {\r\n      return `${minutes}m ${seconds % 60}s`;\r\n    } else {\r\n      return `${seconds}s`;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Load workflow from file\r\n */\r\nexport async function loadWorkflowFromFile(filePath) {\r\n  try {\r\n    const content = await fs.readFile(filePath, 'utf-8');\r\n    \r\n    if (filePath.endsWith('.json')) {\r\n      return JSON.parse(content);\r\n    } else if (filePath.endsWith('.yaml') || filePath.endsWith('.yml')) {\r\n      // For now, just return error - YAML support can be added later\r\n      throw new Error('YAML workflows not yet supported');\r\n    } else {\r\n      throw new Error('Unsupported workflow file format. Use .json or .yaml');\r\n    }\r\n    \r\n  } catch (error) {\r\n    throw new Error(`Failed to load workflow: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Get default MLE-STAR workflow path\r\n */\r\nexport function getMLEStarWorkflowPath() {\r\n  return join(process.cwd(), 'src', 'cli', 'simple-commands', 'templates', 'mle-star-workflow.json');\r\n}"],"names":["promises","fs","spawn","join","printSuccess","printError","generateId","prefix","Date","now","Math","random","toString","substr","WorkflowExecutor","options","enableClaude","nonInteractive","outputFormat","maxConcurrency","timeout","logLevel","workflowType","workflowName","toLowerCase","includes","executionId","startTime","activeTasks","Map","claudeInstances","results","errors","currentWorkflow","taskOutputStreams","enableChaining","hooksEnabled","sessionId","executeWorkflow","workflowData","variables","console","log","name","executeHook","description","validateWorkflow","processedWorkflow","applyVariables","initializeClaudeAgents","agents","result","executeWorkflowTasks","taskId","success","duration","formatDuration","completedTasks","totalTasks","length","cleanupClaudeInstances","error","message","isClaudeAvailable","Error","masterPrompt","createMasterCoordinationPrompt","claudeProcess","spawnClaudeInstance","id","type","set","process","agent","status","pid","map","a","push","timestamp","execSync","stdio","prompt","claudeArgs","inputStream","displayPrompt","substring","flagsDisplay","stdioConfig","shell","stdin","pipe","stdout","createStreamProcessor","streamProcessor","getAgentIcon","verbose","agentId","display","stderr","on","data","trim","trimEnd","code","instance","get","exitCode","endTime","handleClaudeStreamEvent","event","summary","getEventSummary","icon","getEventIcon","output","t","toISOString","split","phase","currentPhase","tool","JSON","stringify","content","eventType","icons","createTaskPrompt","task","workflow","claudePrompt","basePrompt","allVariables","input","key","value","Object","entries","pattern","RegExp","replace","getAgentRoleDescription","config","capabilities","getMethodologyGuidance","getAgentPositionInPipeline","getCoordinationPartners","createAgentPrompt","toUpperCase","index","detailed_role_prompt","getMasterMethodologyGuide","agentType","roles","researcher","coder","optimizer","analyst","tester","coordinator","positions","partners","guidance","architect","tasks","dependencies","failedTasks","taskStatuses","forEach","assignTo","executionPlan","createExecutionPlan","concurrentDisplay","phaseIndex","phaseTasks","displayTaskBoard","phasePromises","taskStatus","executeTask","phaseResults","Promise","allSettled","taskIndex","reason","settings","failurePolicy","stop","fromEntries","highlightTasks","size","Array","from","values","filter","s","frames","frameIndex","floor","spinner","statusGroups","progress","getProgressBar","agentIcon","padEnd","padStart","errorMsg","total","completed","failed","elapsed","expected","min","filled","empty","repeat","executionTime","resolve","setTimeout","metadata","mode","storeTaskResult","masterCoordinator","completionPromise","reject","err","max","timeoutPromise","_","race","claudeInstance","find","taskPrompt","chainOptions","depends","lastDependency","dependencyStream","taskClaudeProcess","baseTimeout","isMLTask","actualTimeout","taskMap","Set","phases","readyTasks","has","deps","every","dep","add","hookType","params","hookCommand","file","debug","resultJson","agentIds","workflowStr","processedStr","parse","killed","kill","clear","ms","seconds","minutes","hours","loadWorkflowFromFile","filePath","readFile","endsWith","getMLEStarWorkflowPath","cwd"],"mappings":"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"}
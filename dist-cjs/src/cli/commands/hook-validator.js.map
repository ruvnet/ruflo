{"version":3,"sources":["../../../../src/cli/commands/hook-validator.ts"],"sourcesContent":["/**\r\n * Hook validation utilities\r\n */\r\n\r\nimport type { HookType } from './hook-types.js';\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean;\r\n  errors: string[];\r\n  warnings: string[];\r\n}\r\n\r\n/**\r\n * Validate hook parameters before execution\r\n */\r\nexport function validateHookParams(\r\n  hookType: HookType,\r\n  params: Record<string, any>,\r\n): ValidationResult {\r\n  const result: ValidationResult = {\r\n    valid: true,\r\n    errors: [],\r\n    warnings: [],\r\n  };\r\n\r\n  // Common validations\r\n  if (params.metadata && typeof params.metadata === 'string') {\r\n    try {\r\n      JSON.parse(params.metadata);\r\n    } catch {\r\n      result.errors.push('Invalid JSON in --metadata parameter');\r\n      result.valid = false;\r\n    }\r\n  }\r\n\r\n  // Hook-specific validations\r\n  switch (hookType) {\r\n    case 'pre-task':\r\n      if (params.complexity && !['low', 'medium', 'high'].includes(params.complexity)) {\r\n        result.errors.push('--complexity must be one of: low, medium, high');\r\n        result.valid = false;\r\n      }\r\n      if (params.estimatedMinutes && isNaN(Number(params.estimatedMinutes))) {\r\n        result.errors.push('--estimated-minutes must be a number');\r\n        result.valid = false;\r\n      }\r\n      break;\r\n\r\n    case 'post-task':\r\n      if (!params.taskId) {\r\n        result.errors.push('--task-id is required for post-task hook');\r\n        result.valid = false;\r\n      }\r\n      break;\r\n\r\n    case 'pre-edit':\r\n    case 'post-edit':\r\n      if (!params.file) {\r\n        result.errors.push(`--file is required for ${hookType} hook`);\r\n        result.valid = false;\r\n      }\r\n      if (hookType === 'pre-edit' && params.operation) {\r\n        if (!['read', 'write', 'edit', 'delete'].includes(params.operation)) {\r\n          result.errors.push('--operation must be one of: read, write, edit, delete');\r\n          result.valid = false;\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'pre-command':\r\n    case 'post-command':\r\n      if (!params.command) {\r\n        result.errors.push(`--command is required for ${hookType} hook`);\r\n        result.valid = false;\r\n      }\r\n      if (hookType === 'post-command' && params.exitCode) {\r\n        if (isNaN(Number(params.exitCode))) {\r\n          result.errors.push('--exit-code must be a number');\r\n          result.valid = false;\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'session-restore':\r\n      if (!params.sessionId) {\r\n        result.errors.push('--session-id is required for session-restore hook');\r\n        result.valid = false;\r\n      }\r\n      break;\r\n\r\n    case 'pre-search':\r\n      if (!params.query) {\r\n        result.errors.push('--query is required for pre-search hook');\r\n        result.valid = false;\r\n      }\r\n      if (params.maxResults && isNaN(Number(params.maxResults))) {\r\n        result.errors.push('--max-results must be a number');\r\n        result.valid = false;\r\n      }\r\n      break;\r\n\r\n    case 'notification':\r\n      if (!params.message) {\r\n        result.errors.push('--message is required for notification hook');\r\n        result.valid = false;\r\n      }\r\n      if (params.level && !['info', 'warning', 'error'].includes(params.level)) {\r\n        result.errors.push('--level must be one of: info, warning, error');\r\n        result.valid = false;\r\n      }\r\n      break;\r\n\r\n    case 'performance':\r\n      if (params.duration && isNaN(Number(params.duration))) {\r\n        result.errors.push('--duration must be a number');\r\n        result.valid = false;\r\n      }\r\n      if (params.metrics && typeof params.metrics === 'string') {\r\n        try {\r\n          JSON.parse(params.metrics);\r\n        } catch {\r\n          result.errors.push('Invalid JSON in --metrics parameter');\r\n          result.valid = false;\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'memory-sync':\r\n      if (params.direction && !['push', 'pull', 'sync'].includes(params.direction)) {\r\n        result.errors.push('--direction must be one of: push, pull, sync');\r\n        result.valid = false;\r\n      }\r\n      break;\r\n\r\n    case 'telemetry':\r\n      if (!params.event) {\r\n        result.errors.push('--event is required for telemetry hook');\r\n        result.valid = false;\r\n      }\r\n      if (params.data && typeof params.data === 'string') {\r\n        try {\r\n          JSON.parse(params.data);\r\n        } catch {\r\n          result.errors.push('Invalid JSON in --data parameter');\r\n          result.valid = false;\r\n        }\r\n      }\r\n      break;\r\n  }\r\n\r\n  // Add warnings for deprecated or unusual usage\r\n  if (hookType === 'session-start' && params.loadPrevious && !params.sessionId) {\r\n    result.warnings.push('--load-previous without --session-id may load unexpected data');\r\n  }\r\n\r\n  if (\r\n    hookType === 'post-edit' &&\r\n    params.format &&\r\n    !params.file?.match(/\\.(js|ts|jsx|tsx|py|java|cpp|cs)$/)\r\n  ) {\r\n    result.warnings.push('--format may not work correctly for this file type');\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Sanitize hook parameters for safe execution\r\n */\r\nexport function sanitizeHookParams(params: Record<string, any>): Record<string, any> {\r\n  const sanitized: Record<string, any> = {};\r\n\r\n  for (const [key, value] of Object.entries(params)) {\r\n    if (value === undefined || value === null) {\r\n      continue;\r\n    }\r\n\r\n    // Sanitize file paths\r\n    if (['file', 'saveTo', 'target'].includes(key) && typeof value === 'string') {\r\n      // Remove potentially dangerous characters\r\n      sanitized[key] = value.replace(/[<>\"|?*]/g, '');\r\n    }\r\n    // Sanitize commands\r\n    else if (key === 'command' && typeof value === 'string') {\r\n      // Basic command injection prevention\r\n      sanitized[key] = value.replace(/[;&|`$()]/g, '');\r\n    }\r\n    // Keep other values as-is\r\n    else {\r\n      sanitized[key] = value;\r\n    }\r\n  }\r\n\r\n  return sanitized;\r\n}\r\n"],"names":["validateHookParams","hookType","params","result","valid","errors","warnings","metadata","JSON","parse","push","complexity","includes","estimatedMinutes","isNaN","Number","taskId","file","operation","command","exitCode","sessionId","query","maxResults","message","level","duration","metrics","direction","event","data","loadPrevious","format","match","sanitizeHookParams","sanitized","key","value","Object","entries","undefined","replace"],"mappings":"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"}
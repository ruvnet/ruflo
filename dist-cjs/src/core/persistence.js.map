{"version":3,"sources":["../../../src/core/persistence.ts"],"sourcesContent":["/**\r\n * Persistence layer for Claude-Flow using SQLite\r\n */\r\n\r\nimport Database from 'better-sqlite3';\r\nimport { join } from 'path';\r\nimport { mkdir } from 'fs/promises';\r\n\r\nexport interface PersistedAgent {\r\n  id: string;\r\n  type: string;\r\n  name: string;\r\n  status: string;\r\n  capabilities: string;\r\n  systemPrompt: string;\r\n  maxConcurrentTasks: number;\r\n  priority: number;\r\n  createdAt: number;\r\n}\r\n\r\nexport interface PersistedTask {\r\n  id: string;\r\n  type: string;\r\n  description: string;\r\n  status: string;\r\n  priority: number;\r\n  dependencies: string;\r\n  metadata: string;\r\n  assignedAgent?: string;\r\n  progress: number;\r\n  error?: string;\r\n  createdAt: number;\r\n  completedAt?: number;\r\n}\r\n\r\nexport class PersistenceManager {\r\n  private db: Database.Database;\r\n  private dbPath: string;\r\n\r\n  constructor(dataDir: string = './memory') {\r\n    this.dbPath = join(dataDir, 'claude-flow.db');\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    // Ensure directory exists\r\n    await mkdir(join(this.dbPath, '..'), { recursive: true });\r\n\r\n    // Open database\r\n    this.db = new Database(this.dbPath);\r\n\r\n    // Create tables if they don't exist\r\n    this.createTables();\r\n  }\r\n\r\n  private createTables(): void {\r\n    // Agents table\r\n    this.db.execute(`\r\n      CREATE TABLE IF NOT EXISTS agents (\r\n        id TEXT PRIMARY KEY,\r\n        type TEXT NOT NULL,\r\n        name TEXT NOT NULL,\r\n        status TEXT NOT NULL,\r\n        capabilities TEXT NOT NULL,\r\n        system_prompt TEXT NOT NULL,\r\n        max_concurrent_tasks INTEGER NOT NULL,\r\n        priority INTEGER NOT NULL,\r\n        created_at INTEGER NOT NULL\r\n      )\r\n    `);\r\n\r\n    // Tasks table\r\n    this.db.execute(`\r\n      CREATE TABLE IF NOT EXISTS tasks (\r\n        id TEXT PRIMARY KEY,\r\n        type TEXT NOT NULL,\r\n        description TEXT NOT NULL,\r\n        status TEXT NOT NULL,\r\n        priority INTEGER NOT NULL,\r\n        dependencies TEXT NOT NULL,\r\n        metadata TEXT NOT NULL,\r\n        assigned_agent TEXT,\r\n        progress INTEGER DEFAULT 0,\r\n        error TEXT,\r\n        created_at INTEGER NOT NULL,\r\n        completed_at INTEGER\r\n      )\r\n    `);\r\n\r\n    // Sessions table for terminal sessions\r\n    this.db.execute(`\r\n      CREATE TABLE IF NOT EXISTS sessions (\r\n        id TEXT PRIMARY KEY,\r\n        agent_id TEXT NOT NULL,\r\n        terminal_id TEXT NOT NULL,\r\n        status TEXT NOT NULL,\r\n        created_at INTEGER NOT NULL,\r\n        FOREIGN KEY (agent_id) REFERENCES agents(id)\r\n      )\r\n    `);\r\n  }\r\n\r\n  // Agent operations\r\n  async saveAgent(agent: PersistedAgent): Promise<void> {\r\n    const stmt = this.db.prepare(\r\n      `INSERT OR REPLACE INTO agents \r\n       (id, type, name, status, capabilities, system_prompt, max_concurrent_tasks, priority, created_at)\r\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,\r\n    );\r\n    stmt.run(\r\n      agent.id,\r\n      agent.type,\r\n      agent.name,\r\n      agent.status,\r\n      agent.capabilities,\r\n      agent.systemPrompt,\r\n      agent.maxConcurrentTasks,\r\n      agent.priority,\r\n      agent.createdAt,\r\n    );\r\n  }\r\n\r\n  async getAgent(id: string): Promise<PersistedAgent | null> {\r\n    const stmt = this.db.prepare('SELECT * FROM agents WHERE id = ?');\r\n    const row = stmt.get(id) as any;\r\n\r\n    if (!row) return null;\r\n\r\n    return {\r\n      id: row.id,\r\n      type: row.type,\r\n      name: row.name,\r\n      status: row.status,\r\n      capabilities: row.capabilities,\r\n      systemPrompt: row.system_prompt,\r\n      maxConcurrentTasks: row.max_concurrent_tasks,\r\n      priority: row.priority,\r\n      createdAt: row.created_at,\r\n    };\r\n  }\r\n\r\n  async getActiveAgents(): Promise<PersistedAgent[]> {\r\n    const stmt = this.db.prepare(\r\n      \"SELECT * FROM agents WHERE status IN ('active', 'idle') ORDER BY created_at DESC\",\r\n    );\r\n    const rows = stmt.all() as any[];\r\n\r\n    return rows.map((row) => ({\r\n      id: row.id,\r\n      type: row.type,\r\n      name: row.name,\r\n      status: row.status,\r\n      capabilities: row.capabilities,\r\n      systemPrompt: row.system_prompt,\r\n      maxConcurrentTasks: row.max_concurrent_tasks,\r\n      priority: row.priority,\r\n      createdAt: row.created_at,\r\n    }));\r\n  }\r\n\r\n  async updateAgentStatus(id: string, status: string): Promise<void> {\r\n    const stmt = this.db.prepare('UPDATE agents SET status = ? WHERE id = ?');\r\n    stmt.run(status, id);\r\n  }\r\n\r\n  // Task operations\r\n  async saveTask(task: PersistedTask): Promise<void> {\r\n    const stmt = this.db.prepare(\r\n      `INSERT OR REPLACE INTO tasks \r\n       (id, type, description, status, priority, dependencies, metadata, assigned_agent, progress, error, created_at, completed_at)\r\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\r\n    );\r\n    stmt.run(\r\n      task.id,\r\n      task.type,\r\n      task.description,\r\n      task.status,\r\n      task.priority,\r\n      task.dependencies,\r\n      task.metadata,\r\n      task.assignedAgent || null,\r\n      task.progress,\r\n      task.error || null,\r\n      task.createdAt,\r\n      task.completedAt || null,\r\n    );\r\n  }\r\n\r\n  async getTask(id: string): Promise<PersistedTask | null> {\r\n    const stmt = this.db.prepare('SELECT * FROM tasks WHERE id = ?');\r\n    const row = stmt.get(id) as any;\r\n\r\n    if (!row) return null;\r\n\r\n    return {\r\n      id: row.id,\r\n      type: row.type,\r\n      description: row.description,\r\n      status: row.status,\r\n      priority: row.priority,\r\n      dependencies: row.dependencies,\r\n      metadata: row.metadata,\r\n      assignedAgent: row.assigned_agent || undefined,\r\n      progress: row.progress,\r\n      error: row.error || undefined,\r\n      createdAt: row.created_at,\r\n      completedAt: row.completed_at || undefined,\r\n    };\r\n  }\r\n\r\n  async getActiveTasks(): Promise<PersistedTask[]> {\r\n    const stmt = this.db.prepare(\r\n      \"SELECT * FROM tasks WHERE status IN ('pending', 'in_progress', 'assigned') ORDER BY priority DESC, created_at ASC\",\r\n    );\r\n    const rows = stmt.all() as any[];\r\n\r\n    return rows.map((row) => ({\r\n      id: row.id,\r\n      type: row.type,\r\n      description: row.description,\r\n      status: row.status,\r\n      priority: row.priority,\r\n      dependencies: row.dependencies,\r\n      metadata: row.metadata,\r\n      assignedAgent: row.assigned_agent || undefined,\r\n      progress: row.progress,\r\n      error: row.error || undefined,\r\n      createdAt: row.created_at,\r\n      completedAt: row.completed_at || undefined,\r\n    }));\r\n  }\r\n\r\n  async updateTaskStatus(id: string, status: string, assignedAgent?: string): Promise<void> {\r\n    if (assignedAgent) {\r\n      const stmt = this.db.prepare('UPDATE tasks SET status = ?, assigned_agent = ? WHERE id = ?');\r\n      stmt.run(status, assignedAgent, id);\r\n    } else {\r\n      const stmt = this.db.prepare('UPDATE tasks SET status = ? WHERE id = ?');\r\n      stmt.run(status, id);\r\n    }\r\n  }\r\n\r\n  async updateTaskProgress(id: string, progress: number): Promise<void> {\r\n    const stmt = this.db.prepare('UPDATE tasks SET progress = ? WHERE id = ?');\r\n    stmt.run(progress, id);\r\n  }\r\n\r\n  // Statistics\r\n  async getStats(): Promise<{\r\n    totalAgents: number;\r\n    activeAgents: number;\r\n    totalTasks: number;\r\n    pendingTasks: number;\r\n    completedTasks: number;\r\n  }> {\r\n    const totalAgents = this.db.prepare('SELECT COUNT(*) as count FROM agents').get() as any;\r\n    const activeAgents = this.db\r\n      .prepare(\"SELECT COUNT(*) as count FROM agents WHERE status IN ('active', 'idle')\")\r\n      .get() as any;\r\n    const totalTasks = this.db.prepare('SELECT COUNT(*) as count FROM tasks').get() as any;\r\n    const pendingTasks = this.db\r\n      .prepare(\r\n        \"SELECT COUNT(*) as count FROM tasks WHERE status IN ('pending', 'in_progress', 'assigned')\",\r\n      )\r\n      .get() as any;\r\n    const completedTasks = this.db\r\n      .prepare(\"SELECT COUNT(*) as count FROM tasks WHERE status = 'completed'\")\r\n      .get() as any;\r\n\r\n    return {\r\n      totalAgents: totalAgents.count,\r\n      activeAgents: activeAgents.count,\r\n      totalTasks: totalTasks.count,\r\n      pendingTasks: pendingTasks.count,\r\n      completedTasks: completedTasks.count,\r\n    };\r\n  }\r\n\r\n  close(): void {\r\n    this.db.close();\r\n  }\r\n}\r\n"],"names":["Database","join","mkdir","PersistenceManager","db","dbPath","dataDir","initialize","recursive","createTables","execute","saveAgent","agent","stmt","prepare","run","id","type","name","status","capabilities","systemPrompt","maxConcurrentTasks","priority","createdAt","getAgent","row","get","system_prompt","max_concurrent_tasks","created_at","getActiveAgents","rows","all","map","updateAgentStatus","saveTask","task","description","dependencies","metadata","assignedAgent","progress","error","completedAt","getTask","assigned_agent","undefined","completed_at","getActiveTasks","updateTaskStatus","updateTaskProgress","getStats","totalAgents","activeAgents","totalTasks","pendingTasks","completedTasks","count","close"],"mappings":"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"}
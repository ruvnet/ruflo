{"version":3,"sources":["../../../../src/mcp/registry/mcp-registry-client-2025.ts"],"sourcesContent":["/**\r\n * MCP 2025-11 Registry Client\r\n *\r\n * Implements server registration and health reporting\r\n * per MCP 2025-11 specification\r\n */\r\n\r\nimport type { ILogger } from '../../interfaces/logger.js';\r\nimport type { MCPVersion, MCPCapability } from '../protocol/version-negotiation.js';\r\n\r\n/**\r\n * MCP Registry entry (2025-11 format)\r\n */\r\nexport interface MCPRegistryEntry {\r\n  server_id: string;\r\n  version: MCPVersion;\r\n  endpoint: string;\r\n  tools: string[];\r\n  auth: 'bearer' | 'mutual_tls' | 'none';\r\n  capabilities: MCPCapability[];\r\n  metadata: {\r\n    name: string;\r\n    description: string;\r\n    author: string;\r\n    homepage?: string;\r\n    documentation?: string;\r\n    repository?: string;\r\n  };\r\n  health: {\r\n    status: 'healthy' | 'degraded' | 'unhealthy';\r\n    last_check: string; // ISO 8601\r\n    latency_ms: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Registry search query\r\n */\r\nexport interface RegistrySearchQuery {\r\n  category?: string;\r\n  tags?: string[];\r\n  capabilities?: MCPCapability[];\r\n  limit?: number;\r\n}\r\n\r\n/**\r\n * Registry configuration\r\n */\r\nexport interface RegistryConfig {\r\n  enabled: boolean;\r\n  registryUrl?: string;\r\n  apiKey?: string;\r\n  serverId: string;\r\n  serverEndpoint: string;\r\n  authMethod: 'bearer' | 'mutual_tls' | 'none';\r\n  metadata: MCPRegistryEntry['metadata'];\r\n  healthCheckInterval?: number; // milliseconds\r\n}\r\n\r\n/**\r\n * MCP 2025-11 Registry Client\r\n */\r\nexport class MCPRegistryClient {\r\n  private registryUrl: string;\r\n  private healthCheckInterval?: NodeJS.Timeout;\r\n\r\n  constructor(\r\n    private config: RegistryConfig,\r\n    private logger: ILogger,\r\n    private getTools: () => Promise<string[]>,\r\n    private getCapabilities: () => MCPCapability[],\r\n    private getHealth: () => Promise<{ status: 'healthy' | 'degraded' | 'unhealthy'; latency_ms: number }>\r\n  ) {\r\n    this.registryUrl = config.registryUrl || 'https://registry.mcp.anthropic.com/api/v1';\r\n  }\r\n\r\n  /**\r\n   * Register server with MCP Registry\r\n   */\r\n  async register(): Promise<void> {\r\n    if (!this.config.enabled) {\r\n      this.logger.info('Registry registration disabled');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const entry = await this.buildRegistryEntry();\r\n\r\n      this.logger.info('Registering server with MCP Registry', {\r\n        server_id: entry.server_id,\r\n        endpoint: entry.endpoint,\r\n        capabilities: entry.capabilities,\r\n      });\r\n\r\n      const response = await fetch(`${this.registryUrl}/servers`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          ...(this.config.apiKey && {\r\n            'Authorization': `Bearer ${this.config.apiKey}`,\r\n          }),\r\n        },\r\n        body: JSON.stringify(entry),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text();\r\n        throw new Error(`Registration failed: ${response.status} - ${error}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      this.logger.info('Server registered successfully', {\r\n        server_id: result.server_id,\r\n      });\r\n\r\n      // Start periodic health reporting\r\n      this.startHealthReporting();\r\n    } catch (error) {\r\n      this.logger.error('Failed to register with MCP Registry', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update server metadata in registry\r\n   */\r\n  async updateMetadata(updates: Partial<MCPRegistryEntry>): Promise<void> {\r\n    if (!this.config.enabled) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.logger.info('Updating server metadata in registry', {\r\n        server_id: this.config.serverId,\r\n      });\r\n\r\n      const response = await fetch(\r\n        `${this.registryUrl}/servers/${this.config.serverId}`,\r\n        {\r\n          method: 'PATCH',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            ...(this.config.apiKey && {\r\n              'Authorization': `Bearer ${this.config.apiKey}`,\r\n            }),\r\n          },\r\n          body: JSON.stringify(updates),\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text();\r\n        throw new Error(`Update failed: ${response.status} - ${error}`);\r\n      }\r\n\r\n      this.logger.info('Server metadata updated successfully');\r\n    } catch (error) {\r\n      this.logger.error('Failed to update metadata', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Report health status to registry\r\n   */\r\n  async reportHealth(): Promise<void> {\r\n    if (!this.config.enabled) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const health = await this.getHealth();\r\n\r\n      const response = await fetch(\r\n        `${this.registryUrl}/servers/${this.config.serverId}/health`,\r\n        {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            ...(this.config.apiKey && {\r\n              'Authorization': `Bearer ${this.config.apiKey}`,\r\n            }),\r\n          },\r\n          body: JSON.stringify({\r\n            status: health.status,\r\n            last_check: new Date().toISOString(),\r\n            latency_ms: health.latency_ms,\r\n          }),\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        this.logger.warn('Health report failed', {\r\n          status: response.status,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      this.logger.error('Failed to report health', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search for servers in registry\r\n   */\r\n  async searchServers(query: RegistrySearchQuery): Promise<MCPRegistryEntry[]> {\r\n    try {\r\n      const params = new URLSearchParams();\r\n\r\n      if (query.category) {\r\n        params.set('category', query.category);\r\n      }\r\n      if (query.tags) {\r\n        params.set('tags', query.tags.join(','));\r\n      }\r\n      if (query.capabilities) {\r\n        params.set('capabilities', query.capabilities.join(','));\r\n      }\r\n      if (query.limit) {\r\n        params.set('limit', query.limit.toString());\r\n      }\r\n\r\n      const response = await fetch(`${this.registryUrl}/servers?${params}`);\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Search failed: ${response.status}`);\r\n      }\r\n\r\n      const results = await response.json();\r\n      return results.servers || [];\r\n    } catch (error) {\r\n      this.logger.error('Failed to search servers', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unregister from registry\r\n   */\r\n  async unregister(): Promise<void> {\r\n    if (!this.config.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Stop health reporting\r\n    this.stopHealthReporting();\r\n\r\n    try {\r\n      this.logger.info('Unregistering from MCP Registry', {\r\n        server_id: this.config.serverId,\r\n      });\r\n\r\n      const response = await fetch(\r\n        `${this.registryUrl}/servers/${this.config.serverId}`,\r\n        {\r\n          method: 'DELETE',\r\n          headers: {\r\n            ...(this.config.apiKey && {\r\n              'Authorization': `Bearer ${this.config.apiKey}`,\r\n            }),\r\n          },\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        this.logger.warn('Unregistration failed', {\r\n          status: response.status,\r\n        });\r\n      } else {\r\n        this.logger.info('Server unregistered successfully');\r\n      }\r\n    } catch (error) {\r\n      this.logger.error('Failed to unregister', {\r\n        error: error instanceof Error ? error.message : String(error),\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build registry entry from current server state\r\n   */\r\n  private async buildRegistryEntry(): Promise<MCPRegistryEntry> {\r\n    const tools = await this.getTools();\r\n    const capabilities = this.getCapabilities();\r\n    const health = await this.getHealth();\r\n\r\n    return {\r\n      server_id: this.config.serverId,\r\n      version: '2025-11',\r\n      endpoint: this.config.serverEndpoint,\r\n      tools,\r\n      auth: this.config.authMethod,\r\n      capabilities,\r\n      metadata: this.config.metadata,\r\n      health: {\r\n        status: health.status,\r\n        last_check: new Date().toISOString(),\r\n        latency_ms: health.latency_ms,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Start periodic health reporting\r\n   */\r\n  private startHealthReporting(): void {\r\n    const interval = this.config.healthCheckInterval || 60000; // Default: 60 seconds\r\n\r\n    this.healthCheckInterval = setInterval(async () => {\r\n      await this.reportHealth();\r\n    }, interval);\r\n\r\n    this.logger.info('Health reporting started', {\r\n      interval_ms: interval,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop health reporting\r\n   */\r\n  private stopHealthReporting(): void {\r\n    if (this.healthCheckInterval) {\r\n      clearInterval(this.healthCheckInterval);\r\n      this.healthCheckInterval = undefined;\r\n      this.logger.info('Health reporting stopped');\r\n    }\r\n  }\r\n}\r\n"],"names":["MCPRegistryClient","registryUrl","healthCheckInterval","config","logger","getTools","getCapabilities","getHealth","register","enabled","info","entry","buildRegistryEntry","server_id","endpoint","capabilities","response","fetch","method","headers","apiKey","body","JSON","stringify","ok","error","text","Error","status","result","json","startHealthReporting","message","String","updateMetadata","updates","serverId","reportHealth","health","last_check","Date","toISOString","latency_ms","warn","searchServers","query","params","URLSearchParams","category","set","tags","join","limit","toString","results","servers","unregister","stopHealthReporting","tools","version","serverEndpoint","auth","authMethod","metadata","interval","setInterval","interval_ms","clearInterval","undefined"],"mappings":"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"}
{"version":3,"sources":["../../../src/core/json-persistence.ts"],"sourcesContent":["/**\r\n * JSON-based persistence layer for Claude-Flow\r\n */\r\n\r\nimport { join } from 'path';\r\nimport { mkdir, access, readFile, writeFile } from 'fs/promises';\r\n\r\nexport interface PersistedAgent {\r\n  id: string;\r\n  type: string;\r\n  name: string;\r\n  status: string;\r\n  capabilities: string[];\r\n  systemPrompt: string;\r\n  maxConcurrentTasks: number;\r\n  priority: number;\r\n  createdAt: number;\r\n}\r\n\r\nexport interface PersistedTask {\r\n  id: string;\r\n  type: string;\r\n  description: string;\r\n  status: string;\r\n  priority: number;\r\n  dependencies: string[];\r\n  metadata: Record<string, unknown>;\r\n  assignedAgent?: string;\r\n  progress: number;\r\n  error?: string;\r\n  createdAt: number;\r\n  completedAt?: number;\r\n}\r\n\r\ninterface PersistenceData {\r\n  agents: PersistedAgent[];\r\n  tasks: PersistedTask[];\r\n  lastUpdated: number;\r\n}\r\n\r\nexport class JsonPersistenceManager {\r\n  private dataPath: string;\r\n  private data: PersistenceData;\r\n\r\n  constructor(dataDir: string = './memory') {\r\n    this.dataPath = join(dataDir, 'claude-flow-data.json');\r\n    this.data = {\r\n      agents: [],\r\n      tasks: [],\r\n      lastUpdated: Date.now(),\r\n    };\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    // Ensure directory exists\r\n    await mkdir(join(this.dataPath, '..'), { recursive: true });\r\n\r\n    // Load existing data if available\r\n    try {\r\n      await access(this.dataPath);\r\n      const content = await readFile(this.dataPath, 'utf-8');\r\n      this.data = JSON.parse(content);\r\n    } catch (error) {\r\n      // File doesn't exist or can't be read, keep default empty data\r\n      console.error('Failed to load persistence data:', error);\r\n    }\r\n  }\r\n\r\n  private async save(): Promise<void> {\r\n    this.data.lastUpdated = Date.now();\r\n    await writeFile(this.dataPath, JSON.stringify(this.data, null, 2));\r\n  }\r\n\r\n  // Agent operations\r\n  async saveAgent(agent: PersistedAgent): Promise<void> {\r\n    // Remove existing agent if updating\r\n    this.data.agents = this.data.agents.filter((a) => a.id !== agent.id);\r\n    this.data.agents.push(agent);\r\n    await this.save();\r\n  }\r\n\r\n  async getAgent(id: string): Promise<PersistedAgent | null> {\r\n    return this.data.agents.find((a) => a.id === id) || null;\r\n  }\r\n\r\n  async getActiveAgents(): Promise<PersistedAgent[]> {\r\n    return this.data.agents.filter((a) => a.status === 'active' || a.status === 'idle');\r\n  }\r\n\r\n  async getAllAgents(): Promise<PersistedAgent[]> {\r\n    return this.data.agents;\r\n  }\r\n\r\n  async updateAgentStatus(id: string, status: string): Promise<void> {\r\n    const agent = this.data.agents.find((a) => a.id === id);\r\n    if (agent) {\r\n      agent.status = status;\r\n      await this.save();\r\n    }\r\n  }\r\n\r\n  // Task operations\r\n  async saveTask(task: PersistedTask): Promise<void> {\r\n    // Remove existing task if updating\r\n    this.data.tasks = this.data.tasks.filter((t) => t.id !== task.id);\r\n    this.data.tasks.push(task);\r\n    await this.save();\r\n  }\r\n\r\n  async getTask(id: string): Promise<PersistedTask | null> {\r\n    return this.data.tasks.find((t) => t.id === id) || null;\r\n  }\r\n\r\n  async getActiveTasks(): Promise<PersistedTask[]> {\r\n    return this.data.tasks.filter(\r\n      (t) => t.status === 'pending' || t.status === 'in_progress' || t.status === 'assigned',\r\n    );\r\n  }\r\n\r\n  async getAllTasks(): Promise<PersistedTask[]> {\r\n    return this.data.tasks;\r\n  }\r\n\r\n  async updateTaskStatus(id: string, status: string, assignedAgent?: string): Promise<void> {\r\n    const task = this.data.tasks.find((t) => t.id === id);\r\n    if (task) {\r\n      task.status = status;\r\n      if (assignedAgent !== undefined) {\r\n        task.assignedAgent = assignedAgent;\r\n      }\r\n      if (status === 'completed') {\r\n        task.completedAt = Date.now();\r\n      }\r\n      await this.save();\r\n    }\r\n  }\r\n\r\n  async updateTaskProgress(id: string, progress: number): Promise<void> {\r\n    const task = this.data.tasks.find((t) => t.id === id);\r\n    if (task) {\r\n      task.progress = progress;\r\n      await this.save();\r\n    }\r\n  }\r\n\r\n  // Statistics\r\n  async getStats(): Promise<{\r\n    totalAgents: number;\r\n    activeAgents: number;\r\n    totalTasks: number;\r\n    pendingTasks: number;\r\n    completedTasks: number;\r\n  }> {\r\n    const activeAgents = this.data.agents.filter(\r\n      (a) => a.status === 'active' || a.status === 'idle',\r\n    ).length;\r\n\r\n    const pendingTasks = this.data.tasks.filter(\r\n      (t) => t.status === 'pending' || t.status === 'in_progress' || t.status === 'assigned',\r\n    ).length;\r\n\r\n    const completedTasks = this.data.tasks.filter((t) => t.status === 'completed').length;\r\n\r\n    return {\r\n      totalAgents: this.data.agents.length,\r\n      activeAgents,\r\n      totalTasks: this.data.tasks.length,\r\n      pendingTasks,\r\n      completedTasks,\r\n    };\r\n  }\r\n\r\n  close(): void {\r\n    // No-op for JSON persistence\r\n  }\r\n}\r\n"],"names":["join","mkdir","access","readFile","writeFile","JsonPersistenceManager","dataPath","data","dataDir","agents","tasks","lastUpdated","Date","now","initialize","recursive","content","JSON","parse","error","console","save","stringify","saveAgent","agent","filter","a","id","push","getAgent","find","getActiveAgents","status","getAllAgents","updateAgentStatus","saveTask","task","t","getTask","getActiveTasks","getAllTasks","updateTaskStatus","assignedAgent","undefined","completedAt","updateTaskProgress","progress","getStats","activeAgents","length","pendingTasks","completedTasks","totalAgents","totalTasks","close"],"mappings":"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"}
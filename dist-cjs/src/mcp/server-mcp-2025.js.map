{"version":3,"sources":["../../../src/mcp/server-mcp-2025.ts"],"sourcesContent":["/**\r\n * MCP 2025-11 Enhanced Server\r\n *\r\n * Integrates all MCP 2025-11 features with full backward compatibility:\r\n * - Version negotiation\r\n * - Async job support\r\n * - Registry integration\r\n * - JSON Schema 1.1 validation\r\n * - Dual-mode operation (2025-11 + legacy)\r\n */\r\n\r\nimport type { ILogger } from '../interfaces/logger.js';\r\nimport type { IEventBus } from '../interfaces/event-bus.js';\r\nimport { VersionNegotiator, BackwardCompatibilityAdapter, type MCPHandshake, type MCPVersion, type MCPCapability } from './protocol/version-negotiation.js';\r\nimport { MCPAsyncJobManager, type MCPToolRequest, type MCPJobHandle, type MCPJobResult } from './async/job-manager-mcp25.js';\r\nimport { MCPRegistryClient, type RegistryConfig } from './registry/mcp-registry-client-2025.js';\r\nimport { SchemaValidator, upgradeToolSchema } from './validation/schema-validator-2025.js';\r\nimport { ProgressiveToolRegistry } from './tool-registry-progressive.js';\r\n\r\n/**\r\n * MCP 2025-11 server configuration\r\n */\r\nexport interface MCP2025ServerConfig {\r\n  serverId: string;\r\n  transport: 'stdio' | 'http' | 'ws';\r\n\r\n  // Version & capabilities\r\n  enableMCP2025: boolean; // Feature flag for gradual rollout\r\n  supportLegacyClients: boolean; // Backward compatibility\r\n\r\n  // Async jobs\r\n  async: {\r\n    enabled: boolean;\r\n    maxJobs?: number;\r\n    jobTTL?: number;\r\n    persistence?: 'memory' | 'redis' | 'sqlite';\r\n  };\r\n\r\n  // Registry\r\n  registry: RegistryConfig;\r\n\r\n  // Schema validation\r\n  validation: {\r\n    enabled: boolean;\r\n    strictMode?: boolean;\r\n  };\r\n\r\n  // Tool registry\r\n  toolsDirectory?: string;\r\n\r\n  // Existing config\r\n  orchestratorContext?: any;\r\n}\r\n\r\n/**\r\n * MCP 2025-11 Enhanced Server\r\n */\r\nexport class MCP2025Server {\r\n  private versionNegotiator: VersionNegotiator;\r\n  private compatibilityAdapter: BackwardCompatibilityAdapter;\r\n  private jobManager?: MCPAsyncJobManager;\r\n  private registryClient?: MCPRegistryClient;\r\n  private schemaValidator: SchemaValidator;\r\n  private toolRegistry: ProgressiveToolRegistry;\r\n\r\n  // Session state\r\n  private sessions: Map<string, {\r\n    clientId: string;\r\n    version: MCPVersion;\r\n    capabilities: MCPCapability[];\r\n    isLegacy: boolean;\r\n    createdAt: number;\r\n    lastAccess: number;\r\n  }> = new Map();\r\n\r\n  // Session management constants\r\n  private readonly MAX_SESSIONS = 10000;\r\n  private readonly SESSION_TTL = 3600000; // 1 hour\r\n  private sessionCleanupInterval?: NodeJS.Timeout;\r\n\r\n  constructor(\r\n    private config: MCP2025ServerConfig,\r\n    private eventBus: IEventBus,\r\n    private logger: ILogger\r\n  ) {\r\n    // Initialize version negotiation\r\n    this.versionNegotiator = new VersionNegotiator(logger);\r\n    this.compatibilityAdapter = new BackwardCompatibilityAdapter(logger);\r\n\r\n    // Initialize schema validator\r\n    this.schemaValidator = new SchemaValidator(logger);\r\n\r\n    // Initialize tool registry (progressive)\r\n    this.toolRegistry = new ProgressiveToolRegistry({\r\n      enableInProcess: true,\r\n      enableMetrics: true,\r\n      enableCaching: true,\r\n      orchestratorContext: config.orchestratorContext,\r\n      toolsDirectory: config.toolsDirectory,\r\n    });\r\n\r\n    this.logger.info('MCP 2025-11 server created', {\r\n      serverId: config.serverId,\r\n      mcp2025Enabled: config.enableMCP2025,\r\n      legacySupport: config.supportLegacyClients,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initialize server\r\n   */\r\n  async initialize(): Promise<void> {\r\n    this.logger.info('Initializing MCP 2025-11 server');\r\n\r\n    // Initialize tool registry\r\n    await this.toolRegistry.initialize();\r\n\r\n    // Start session cleanup interval\r\n    this.sessionCleanupInterval = setInterval(\r\n      () => this.cleanupExpiredSessions(),\r\n      300000 // Every 5 minutes\r\n    );\r\n\r\n    // Initialize async job manager if enabled\r\n    if (this.config.async.enabled) {\r\n      this.jobManager = new MCPAsyncJobManager(\r\n        null, // Use memory persistence for now\r\n        this.logger,\r\n        {\r\n          maxJobs: this.config.async.maxJobs,\r\n          jobTTL: this.config.async.jobTTL,\r\n        }\r\n      );\r\n\r\n      this.logger.info('Async job manager initialized');\r\n    }\r\n\r\n    // Initialize registry client if enabled\r\n    if (this.config.registry.enabled) {\r\n      this.registryClient = new MCPRegistryClient(\r\n        this.config.registry,\r\n        this.logger,\r\n        () => this.toolRegistry.getToolNames(),\r\n        () => this.versionNegotiator.getServerCapabilities(),\r\n        async () => this.getHealthStatus()\r\n      );\r\n\r\n      // Register with MCP Registry\r\n      try {\r\n        await this.registryClient.register();\r\n      } catch (error) {\r\n        this.logger.error('Failed to register with MCP Registry', { error });\r\n        // Don't fail initialization if registry is unavailable\r\n      }\r\n    }\r\n\r\n    this.logger.info('MCP 2025-11 server initialized successfully');\r\n  }\r\n\r\n  /**\r\n   * Handle client connection/handshake\r\n   */\r\n  async handleHandshake(clientHandshake: any, sessionId: string): Promise<MCPHandshake> {\r\n    // Check if legacy client\r\n    const isLegacy = this.compatibilityAdapter.isLegacyRequest(clientHandshake);\r\n\r\n    let handshake: MCPHandshake;\r\n    if (isLegacy && this.config.supportLegacyClients) {\r\n      this.logger.info('Legacy client detected, enabling compatibility mode', { sessionId });\r\n      handshake = this.compatibilityAdapter.convertToModern(clientHandshake);\r\n    } else {\r\n      handshake = clientHandshake;\r\n    }\r\n\r\n    // Negotiate version and capabilities\r\n    const negotiation = await this.versionNegotiator.negotiate(handshake);\r\n\r\n    if (!negotiation.success) {\r\n      throw new Error(`Version negotiation failed: ${negotiation.error}`);\r\n    }\r\n\r\n    // Enforce session limit\r\n    if (this.sessions.size >= this.MAX_SESSIONS) {\r\n      // Remove oldest session\r\n      const oldestSession = Array.from(this.sessions.entries())\r\n        .sort((a, b) => a[1].createdAt - b[1].createdAt)[0];\r\n      if (oldestSession) {\r\n        this.sessions.delete(oldestSession[0]);\r\n        this.logger.warn('Session limit reached, removed oldest session', {\r\n          removedSessionId: oldestSession[0],\r\n        });\r\n      }\r\n    }\r\n\r\n    // Store session info\r\n    const now = Date.now();\r\n    this.sessions.set(sessionId, {\r\n      clientId: handshake.client_id || 'unknown',\r\n      version: negotiation.agreed_version,\r\n      capabilities: negotiation.agreed_capabilities,\r\n      isLegacy,\r\n      createdAt: now,\r\n      lastAccess: now,\r\n    });\r\n\r\n    // Create server handshake response\r\n    const serverHandshake = this.versionNegotiator.createServerHandshake(\r\n      this.config.serverId,\r\n      this.config.transport,\r\n      {\r\n        name: 'Claude Flow',\r\n        version: '2.7.32',\r\n        description: 'Enterprise AI orchestration with MCP 2025-11 support',\r\n      }\r\n    );\r\n\r\n    // Apply agreed version and capabilities\r\n    serverHandshake.mcp_version = negotiation.agreed_version;\r\n    serverHandshake.capabilities = negotiation.agreed_capabilities;\r\n\r\n    this.logger.info('Handshake completed', {\r\n      sessionId,\r\n      version: serverHandshake.mcp_version,\r\n      capabilities: serverHandshake.capabilities,\r\n      isLegacy,\r\n    });\r\n\r\n    return serverHandshake;\r\n  }\r\n\r\n  /**\r\n   * Handle tool call request (with async support)\r\n   */\r\n  async handleToolCall(\r\n    request: MCPToolRequest | any,\r\n    sessionId: string\r\n  ): Promise<MCPJobHandle | MCPJobResult | any> {\r\n    const session = this.sessions.get(sessionId);\r\n\r\n    // Update last access time\r\n    if (session) {\r\n      session.lastAccess = Date.now();\r\n    }\r\n\r\n    // Handle legacy request format\r\n    if (session?.isLegacy) {\r\n      return this.handleLegacyToolCall(request, sessionId);\r\n    }\r\n\r\n    // MCP 2025-11 format\r\n    const mcpRequest = request as MCPToolRequest;\r\n\r\n    // Validate request\r\n    if (!mcpRequest.tool_id) {\r\n      throw new Error('Missing tool_id in request');\r\n    }\r\n\r\n    // Get tool\r\n    const tool = await this.toolRegistry.getTool(mcpRequest.tool_id);\r\n    if (!tool) {\r\n      throw new Error(`Tool not found: ${mcpRequest.tool_id}`);\r\n    }\r\n\r\n    // Validate input if validation enabled\r\n    if (this.config.validation.enabled) {\r\n      const validation = this.schemaValidator.validateInput(\r\n        upgradeToolSchema(tool.inputSchema),\r\n        mcpRequest.arguments\r\n      );\r\n\r\n      if (!validation.valid) {\r\n        throw new Error(\r\n          `Invalid input: ${validation.errors?.map(e => e.message).join(', ')}`\r\n        );\r\n      }\r\n    }\r\n\r\n    // Check if async mode requested\r\n    const hasAsyncCapability = session?.capabilities.includes('async');\r\n    const isAsyncRequest = mcpRequest.mode === 'async' && hasAsyncCapability;\r\n\r\n    if (isAsyncRequest && this.jobManager) {\r\n      // Submit as async job\r\n      this.logger.info('Submitting async job', {\r\n        tool_id: mcpRequest.tool_id,\r\n        request_id: mcpRequest.request_id,\r\n      });\r\n\r\n      return await this.jobManager.submitJob(\r\n        mcpRequest,\r\n        async (args, onProgress) => {\r\n          // Execute tool with progress tracking\r\n          return await tool.handler(args, {\r\n            orchestrator: this.config.orchestratorContext,\r\n            sessionId,\r\n          });\r\n        }\r\n      );\r\n    } else {\r\n      // Execute synchronously\r\n      this.logger.info('Executing tool synchronously', {\r\n        tool_id: mcpRequest.tool_id,\r\n        request_id: mcpRequest.request_id,\r\n      });\r\n\r\n      const startTime = Date.now();\r\n      const result = await tool.handler(mcpRequest.arguments, {\r\n        orchestrator: this.config.orchestratorContext,\r\n        sessionId,\r\n      });\r\n\r\n      // Validate output if validation enabled\r\n      if (this.config.validation.enabled && tool.metadata?.outputSchema) {\r\n        const validation = this.schemaValidator.validateOutput(\r\n          tool.metadata.outputSchema,\r\n          result\r\n        );\r\n\r\n        if (!validation.valid) {\r\n          this.logger.warn('Output validation failed', {\r\n            tool_id: mcpRequest.tool_id,\r\n            errors: validation.errors,\r\n          });\r\n        }\r\n      }\r\n\r\n      // Return in MCP 2025-11 format\r\n      return {\r\n        request_id: mcpRequest.request_id,\r\n        status: 'success',\r\n        result,\r\n        metadata: {\r\n          duration_ms: Date.now() - startTime,\r\n        },\r\n      } as MCPJobResult;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle legacy tool call\r\n   */\r\n  private async handleLegacyToolCall(request: any, sessionId: string): Promise<any> {\r\n    this.logger.info('Handling legacy tool call', {\r\n      toolName: request.name || request.method,\r\n      sessionId,\r\n    });\r\n\r\n    // Convert to modern format internally\r\n    const toolId = request.name || request.method;\r\n    const args = request.arguments || request.params || {};\r\n\r\n    const tool = await this.toolRegistry.getTool(toolId);\r\n    if (!tool) {\r\n      throw new Error(`Tool not found: ${toolId}`);\r\n    }\r\n\r\n    const result = await tool.handler(args, {\r\n      orchestrator: this.config.orchestratorContext,\r\n      sessionId,\r\n    });\r\n\r\n    // Return in legacy format\r\n    return this.compatibilityAdapter.convertToLegacy(\r\n      { result, status: 'success' },\r\n      true\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Poll async job\r\n   */\r\n  async pollJob(job_id: string): Promise<MCPJobHandle> {\r\n    if (!this.jobManager) {\r\n      throw new Error('Async jobs not enabled');\r\n    }\r\n\r\n    return await this.jobManager.pollJob(job_id);\r\n  }\r\n\r\n  /**\r\n   * Resume async job (get results)\r\n   */\r\n  async resumeJob(job_id: string): Promise<MCPJobResult> {\r\n    if (!this.jobManager) {\r\n      throw new Error('Async jobs not enabled');\r\n    }\r\n\r\n    return await this.jobManager.resumeJob(job_id);\r\n  }\r\n\r\n  /**\r\n   * Cancel async job\r\n   */\r\n  async cancelJob(job_id: string): Promise<boolean> {\r\n    if (!this.jobManager) {\r\n      throw new Error('Async jobs not enabled');\r\n    }\r\n\r\n    return await this.jobManager.cancelJob(job_id);\r\n  }\r\n\r\n  /**\r\n   * List async jobs\r\n   */\r\n  async listJobs(filter?: { status?: string; limit?: number }) {\r\n    if (!this.jobManager) {\r\n      throw new Error('Async jobs not enabled');\r\n    }\r\n\r\n    return await this.jobManager.listJobs(filter);\r\n  }\r\n\r\n  /**\r\n   * Get health status\r\n   */\r\n  private async getHealthStatus(): Promise<{\r\n    status: 'healthy' | 'degraded' | 'unhealthy';\r\n    latency_ms: number;\r\n  }> {\r\n    const startTime = Date.now();\r\n\r\n    // Perform health checks\r\n    const latency = Date.now() - startTime;\r\n\r\n    // Determine status based on metrics\r\n    let status: 'healthy' | 'degraded' | 'unhealthy' = 'healthy';\r\n\r\n    if (latency > 100) {\r\n      status = 'degraded';\r\n    }\r\n    if (latency > 500) {\r\n      status = 'unhealthy';\r\n    }\r\n\r\n    return { status, latency_ms: latency };\r\n  }\r\n\r\n  /**\r\n   * Get metrics\r\n   */\r\n  getMetrics() {\r\n    return {\r\n      sessions: {\r\n        total: this.sessions.size,\r\n        byVersion: this.getSessionsByVersion(),\r\n        legacy: Array.from(this.sessions.values()).filter(s => s.isLegacy).length,\r\n      },\r\n      jobs: this.jobManager?.getMetrics(),\r\n      tools: this.toolRegistry.getMetrics(),\r\n      validation: this.schemaValidator.getCacheStats(),\r\n    };\r\n  }\r\n\r\n  private getSessionsByVersion() {\r\n    const counts: Record<string, number> = {};\r\n    for (const session of this.sessions.values()) {\r\n      counts[session.version] = (counts[session.version] || 0) + 1;\r\n    }\r\n    return counts;\r\n  }\r\n\r\n  /**\r\n   * Cleanup expired sessions\r\n   */\r\n  private cleanupExpiredSessions(): void {\r\n    const now = Date.now();\r\n    let cleaned = 0;\r\n\r\n    for (const [sessionId, session] of this.sessions.entries()) {\r\n      // Remove if last access was more than TTL ago\r\n      if (now - session.lastAccess > this.SESSION_TTL) {\r\n        this.sessions.delete(sessionId);\r\n        cleaned++;\r\n      }\r\n    }\r\n\r\n    if (cleaned > 0) {\r\n      this.logger.info('Cleaned up expired sessions', { count: cleaned });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  async cleanup(): Promise<void> {\r\n    this.logger.info('Cleaning up MCP 2025-11 server');\r\n\r\n    // Stop session cleanup interval\r\n    if (this.sessionCleanupInterval) {\r\n      clearInterval(this.sessionCleanupInterval);\r\n    }\r\n\r\n    // Unregister from registry\r\n    if (this.registryClient) {\r\n      await this.registryClient.unregister();\r\n    }\r\n\r\n    // Clear caches\r\n    this.schemaValidator.clearCache();\r\n    await this.toolRegistry.cleanup();\r\n\r\n    // Clear sessions\r\n    this.sessions.clear();\r\n\r\n    this.logger.info('Cleanup complete');\r\n  }\r\n}\r\n"],"names":["VersionNegotiator","BackwardCompatibilityAdapter","MCPAsyncJobManager","MCPRegistryClient","SchemaValidator","upgradeToolSchema","ProgressiveToolRegistry","MCP2025Server","versionNegotiator","compatibilityAdapter","jobManager","registryClient","schemaValidator","toolRegistry","sessions","Map","MAX_SESSIONS","SESSION_TTL","sessionCleanupInterval","config","eventBus","logger","enableInProcess","enableMetrics","enableCaching","orchestratorContext","toolsDirectory","info","serverId","mcp2025Enabled","enableMCP2025","legacySupport","supportLegacyClients","initialize","setInterval","cleanupExpiredSessions","async","enabled","maxJobs","jobTTL","registry","getToolNames","getServerCapabilities","getHealthStatus","register","error","handleHandshake","clientHandshake","sessionId","isLegacy","isLegacyRequest","handshake","convertToModern","negotiation","negotiate","success","Error","size","oldestSession","Array","from","entries","sort","a","b","createdAt","delete","warn","removedSessionId","now","Date","set","clientId","client_id","version","agreed_version","capabilities","agreed_capabilities","lastAccess","serverHandshake","createServerHandshake","transport","name","description","mcp_version","handleToolCall","request","session","get","handleLegacyToolCall","mcpRequest","tool_id","tool","getTool","validation","validateInput","inputSchema","arguments","valid","errors","map","e","message","join","hasAsyncCapability","includes","isAsyncRequest","mode","request_id","submitJob","args","onProgress","handler","orchestrator","startTime","result","metadata","outputSchema","validateOutput","status","duration_ms","toolName","method","toolId","params","convertToLegacy","pollJob","job_id","resumeJob","cancelJob","listJobs","filter","latency","latency_ms","getMetrics","total","byVersion","getSessionsByVersion","legacy","values","s","length","jobs","tools","getCacheStats","counts","cleaned","count","cleanup","clearInterval","unregister","clearCache","clear"],"mappings":"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"}
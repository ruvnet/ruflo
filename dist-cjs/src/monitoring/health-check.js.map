{"version":3,"sources":["../../../src/monitoring/health-check.ts"],"sourcesContent":["/**\r\n * Health Check System for Claude Flow v2.0.0\r\n */\r\n\r\nimport { EventBus } from '../core/event-bus.js';\r\nimport { Logger } from '../core/logger.js';\r\nimport { SystemIntegration } from '../integration/system-integration.js';\r\nimport type {\r\n  HealthCheckResult,\r\n  ComponentStatus,\r\n  SystemHealth,\r\n  SystemMetrics,\r\n} from '../integration/types.js';\r\nimport { getErrorMessage } from '../utils/error-handler.js';\r\n\r\nexport interface HealthCheckConfig {\r\n  interval?: number; // Health check interval in ms (default: 30000)\r\n  timeout?: number; // Health check timeout in ms (default: 5000)\r\n  retries?: number; // Number of retries for failed checks (default: 3)\r\n  enableMetrics?: boolean; // Collect system metrics (default: true)\r\n  enableAlerts?: boolean; // Send alerts on health issues (default: true)\r\n}\r\n\r\nexport interface AlertConfig {\r\n  webhook?: string;\r\n  email?: string;\r\n  slack?: string;\r\n  threshold?: number; // Alert threshold for unhealthy components\r\n}\r\n\r\nexport class HealthCheckManager {\r\n  private eventBus: EventBus;\r\n  private logger: Logger;\r\n  private systemIntegration: SystemIntegration;\r\n  private config: Required<HealthCheckConfig>;\r\n  private intervalId: NodeJS.Timeout | null = null;\r\n  private healthHistory: Map<string, HealthCheckResult[]> = new Map();\r\n  private isRunning = false;\r\n  private lastMetrics: SystemMetrics | null = null;\r\n\r\n  constructor(eventBus: EventBus, logger: Logger, config: HealthCheckConfig = {}) {\r\n    this.eventBus = eventBus;\r\n    this.logger = logger;\r\n    this.systemIntegration = SystemIntegration.getInstance();\r\n\r\n    this.config = {\r\n      interval: config.interval || 30000, // 30 seconds\r\n      timeout: config.timeout || 5000, // 5 seconds\r\n      retries: config.retries || 3,\r\n      enableMetrics: config.enableMetrics !== false,\r\n      enableAlerts: config.enableAlerts !== false,\r\n    };\r\n\r\n    this.setupEventHandlers();\r\n  }\r\n\r\n  /**\r\n   * Start health monitoring\r\n   */\r\n  start(): void {\r\n    if (this.isRunning) {\r\n      this.logger.warn('Health check manager already running');\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Starting health check monitoring');\r\n    this.isRunning = true;\r\n\r\n    // Perform initial health check\r\n    this.performHealthCheck();\r\n\r\n    // Set up periodic health checks\r\n    this.intervalId = setInterval(() => {\r\n      this.performHealthCheck();\r\n    }, this.config.interval);\r\n\r\n    this.eventBus.emit('health:monitor:started', {\r\n      interval: this.config.interval,\r\n      timestamp: Date.now(),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop health monitoring\r\n   */\r\n  stop(): void {\r\n    if (!this.isRunning) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Stopping health check monitoring');\r\n    this.isRunning = false;\r\n\r\n    if (this.intervalId) {\r\n      clearInterval(this.intervalId);\r\n      this.intervalId = null;\r\n    }\r\n\r\n    this.eventBus.emit('health:monitor:stopped', {\r\n      timestamp: Date.now(),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Perform comprehensive health check\r\n   */\r\n  async performHealthCheck(): Promise<SystemHealth> {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      this.logger.debug('Performing system health check');\r\n\r\n      // Get system health from integration manager\r\n      const systemHealth = await this.systemIntegration.getSystemHealth();\r\n\r\n      // Perform individual component checks\r\n      const componentChecks = await this.checkAllComponents();\r\n\r\n      // Collect system metrics if enabled\r\n      if (this.config.enableMetrics) {\r\n        this.lastMetrics = await this.collectSystemMetrics();\r\n      }\r\n\r\n      // Store health history\r\n      this.storeHealthHistory(componentChecks);\r\n\r\n      // Check for alerts\r\n      if (this.config.enableAlerts) {\r\n        await this.checkForAlerts(systemHealth);\r\n      }\r\n\r\n      const duration = Date.now() - startTime;\r\n      this.logger.debug(`Health check completed in ${duration}ms`);\r\n\r\n      // Emit health check event\r\n      this.eventBus.emit('health:check:completed', {\r\n        health: systemHealth,\r\n        metrics: this.lastMetrics,\r\n        duration,\r\n        timestamp: Date.now(),\r\n      });\r\n\r\n      return systemHealth;\r\n    } catch (error) {\r\n      const duration = Date.now() - startTime;\r\n      this.logger.error('Health check failed:', getErrorMessage(error));\r\n\r\n      this.eventBus.emit('health:check:failed', {\r\n        error: getErrorMessage(error),\r\n        duration,\r\n        timestamp: Date.now(),\r\n      });\r\n\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check all system components\r\n   */\r\n  private async checkAllComponents(): Promise<HealthCheckResult[]> {\r\n    const components = [\r\n      'orchestrator',\r\n      'configManager',\r\n      'memoryManager',\r\n      'agentManager',\r\n      'swarmCoordinator',\r\n      'taskEngine',\r\n      'monitor',\r\n      'mcpServer',\r\n    ];\r\n\r\n    const checks = await Promise.allSettled(\r\n      components.map((component) => this.checkComponent(component)),\r\n    );\r\n\r\n    return checks.map((result, index) => {\r\n      if (result.status === 'fulfilled') {\r\n        return result.value;\r\n      } else {\r\n        return {\r\n          component: components[index],\r\n          healthy: false,\r\n          message: getErrorMessage(result.reason),\r\n          timestamp: Date.now(),\r\n        };\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check individual component health\r\n   */\r\n  private async checkComponent(componentName: string): Promise<HealthCheckResult> {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      const component = this.systemIntegration.getComponent(componentName);\r\n\r\n      if (!component) {\r\n        return {\r\n          component: componentName,\r\n          healthy: false,\r\n          message: 'Component not found',\r\n          timestamp: Date.now(),\r\n        };\r\n      }\r\n\r\n      // Try to call health check method if available\r\n      if (typeof component.healthCheck === 'function') {\r\n        const result = await Promise.race([\r\n          component.healthCheck(),\r\n          new Promise((_, reject) =>\r\n            setTimeout(() => reject(new Error('Health check timeout')), this.config.timeout),\r\n          ),\r\n        ]);\r\n        return result as HealthCheckResult;\r\n      }\r\n\r\n      // Basic availability check\r\n      const duration = Date.now() - startTime;\r\n      return {\r\n        component: componentName,\r\n        healthy: true,\r\n        message: 'Component available',\r\n        metrics: { responseTime: duration },\r\n        timestamp: Date.now(),\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        component: componentName,\r\n        healthy: false,\r\n        message: getErrorMessage(error),\r\n        timestamp: Date.now(),\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Collect system metrics\r\n   */\r\n  private async collectSystemMetrics(): Promise<SystemMetrics> {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      // Get system resource usage\r\n      const memoryUsage = process.memoryUsage();\r\n      const cpuUsage = process.cpuUsage();\r\n\r\n      // Get component-specific metrics\r\n      const agentManager = this.systemIntegration.getComponent('agentManager');\r\n      const taskEngine = this.systemIntegration.getComponent('taskEngine');\r\n\r\n      let activeAgents = 0;\r\n      let activeTasks = 0;\r\n      let queuedTasks = 0;\r\n      let completedTasks = 0;\r\n\r\n      if (agentManager && typeof agentManager.getMetrics === 'function') {\r\n        const agentMetrics = await agentManager.getMetrics();\r\n        activeAgents = agentMetrics.activeAgents || 0;\r\n      }\r\n\r\n      if (taskEngine && typeof taskEngine.getMetrics === 'function') {\r\n        const taskMetrics = await taskEngine.getMetrics();\r\n        activeTasks = taskMetrics.activeTasks || 0;\r\n        queuedTasks = taskMetrics.queuedTasks || 0;\r\n        completedTasks = taskMetrics.completedTasks || 0;\r\n      }\r\n\r\n      return {\r\n        cpu: (cpuUsage.user + cpuUsage.system) / 1000000, // Convert to percentage\r\n        memory: (memoryUsage.heapUsed / memoryUsage.heapTotal) * 100,\r\n        network: 0, // Placeholder - would need additional monitoring\r\n        disk: 0, // Placeholder - would need additional monitoring\r\n        activeAgents,\r\n        activeTasks,\r\n        queuedTasks,\r\n        completedTasks,\r\n        errorCount: this.getErrorCount(),\r\n        uptime: process.uptime() * 1000,\r\n        timestamp: Date.now(),\r\n      };\r\n    } catch (error) {\r\n      this.logger.error('Failed to collect system metrics:', getErrorMessage(error));\r\n      return {\r\n        cpu: 0,\r\n        memory: 0,\r\n        network: 0,\r\n        disk: 0,\r\n        activeAgents: 0,\r\n        activeTasks: 0,\r\n        queuedTasks: 0,\r\n        completedTasks: 0,\r\n        errorCount: 0,\r\n        uptime: process.uptime() * 1000,\r\n        timestamp: Date.now(),\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Store health check history\r\n   */\r\n  private storeHealthHistory(results: HealthCheckResult[]): void {\r\n    const maxHistorySize = 100; // Keep last 100 health checks per component\r\n\r\n    results.forEach((result) => {\r\n      if (!this.healthHistory.has(result.component)) {\r\n        this.healthHistory.set(result.component, []);\r\n      }\r\n\r\n      const history = this.healthHistory.get(result.component)!;\r\n      history.push(result);\r\n\r\n      // Trim history if too large\r\n      if (history.length > maxHistorySize) {\r\n        history.splice(0, history.length - maxHistorySize);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check for alerts and send notifications\r\n   */\r\n  private async checkForAlerts(health: SystemHealth): Promise<void> {\r\n    const unhealthyComponents = Object.values(health.components).filter(\r\n      (component) => component.status === 'unhealthy',\r\n    );\r\n\r\n    if (unhealthyComponents.length > 0) {\r\n      const alert = {\r\n        type: 'component_failure',\r\n        severity: 'high',\r\n        message: `${unhealthyComponents.length} component(s) are unhealthy`,\r\n        components: unhealthyComponents.map((c) => c.component),\r\n        timestamp: Date.now(),\r\n      };\r\n\r\n      this.eventBus.emit('health:alert', alert);\r\n      this.logger.warn('Health alert triggered:', alert.message);\r\n    }\r\n\r\n    // Check system metrics for anomalies\r\n    if (this.lastMetrics) {\r\n      const alerts = [];\r\n\r\n      if (this.lastMetrics.cpu > 90) {\r\n        alerts.push({\r\n          type: 'high_cpu',\r\n          severity: 'medium',\r\n          message: `High CPU usage: ${this.lastMetrics.cpu.toFixed(1)}%`,\r\n          value: this.lastMetrics.cpu,\r\n        });\r\n      }\r\n\r\n      if (this.lastMetrics.memory > 90) {\r\n        alerts.push({\r\n          type: 'high_memory',\r\n          severity: 'medium',\r\n          message: `High memory usage: ${this.lastMetrics.memory.toFixed(1)}%`,\r\n          value: this.lastMetrics.memory,\r\n        });\r\n      }\r\n\r\n      if (this.lastMetrics.errorCount > 10) {\r\n        alerts.push({\r\n          type: 'high_errors',\r\n          severity: 'high',\r\n          message: `High error count: ${this.lastMetrics.errorCount}`,\r\n          value: this.lastMetrics.errorCount,\r\n        });\r\n      }\r\n\r\n      alerts.forEach((alert) => {\r\n        this.eventBus.emit('health:alert', {\r\n          ...alert,\r\n          timestamp: Date.now(),\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get component health history\r\n   */\r\n  getHealthHistory(component?: string): HealthCheckResult[] {\r\n    if (component) {\r\n      return this.healthHistory.get(component) || [];\r\n    }\r\n\r\n    // Return all history\r\n    const allHistory: HealthCheckResult[] = [];\r\n    for (const history of this.healthHistory.values()) {\r\n      allHistory.push(...history);\r\n    }\r\n\r\n    return allHistory.sort((a, b) => b.timestamp - a.timestamp);\r\n  }\r\n\r\n  /**\r\n   * Get current system metrics\r\n   */\r\n  getCurrentMetrics(): SystemMetrics | null {\r\n    return this.lastMetrics;\r\n  }\r\n\r\n  /**\r\n   * Get system health status\r\n   */\r\n  async getSystemHealth(): Promise<SystemHealth> {\r\n    return await this.systemIntegration.getSystemHealth();\r\n  }\r\n\r\n  /**\r\n   * Get error count from recent history\r\n   */\r\n  private getErrorCount(): number {\r\n    const recentTime = Date.now() - 300000; // Last 5 minutes\r\n    let errorCount = 0;\r\n\r\n    for (const history of this.healthHistory.values()) {\r\n      errorCount += history.filter(\r\n        (check) => check.timestamp > recentTime && !check.healthy,\r\n      ).length;\r\n    }\r\n\r\n    return errorCount;\r\n  }\r\n\r\n  /**\r\n   * Setup event handlers\r\n   */\r\n  private setupEventHandlers(): void {\r\n    // Listen for component status changes\r\n    this.eventBus.on('component:status:updated', (status: ComponentStatus) => {\r\n      if (status.status === 'unhealthy') {\r\n        this.logger.warn(`Component ${status.component} became unhealthy: ${status.message}`);\r\n      }\r\n    });\r\n\r\n    // Listen for system errors\r\n    this.eventBus.on('system:error', (error) => {\r\n      this.logger.error('System error detected:', error);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check if monitoring is running\r\n   */\r\n  isMonitoring(): boolean {\r\n    return this.isRunning;\r\n  }\r\n\r\n  /**\r\n   * Get monitoring configuration\r\n   */\r\n  getConfig(): Required<HealthCheckConfig> {\r\n    return { ...this.config };\r\n  }\r\n}\r\n"],"names":["SystemIntegration","getErrorMessage","HealthCheckManager","eventBus","logger","systemIntegration","config","intervalId","healthHistory","Map","isRunning","lastMetrics","getInstance","interval","timeout","retries","enableMetrics","enableAlerts","setupEventHandlers","start","warn","info","performHealthCheck","setInterval","emit","timestamp","Date","now","stop","clearInterval","startTime","debug","systemHealth","getSystemHealth","componentChecks","checkAllComponents","collectSystemMetrics","storeHealthHistory","checkForAlerts","duration","health","metrics","error","components","checks","Promise","allSettled","map","component","checkComponent","result","index","status","value","healthy","message","reason","componentName","getComponent","healthCheck","race","_","reject","setTimeout","Error","responseTime","memoryUsage","process","cpuUsage","agentManager","taskEngine","activeAgents","activeTasks","queuedTasks","completedTasks","getMetrics","agentMetrics","taskMetrics","cpu","user","system","memory","heapUsed","heapTotal","network","disk","errorCount","getErrorCount","uptime","results","maxHistorySize","forEach","has","set","history","get","push","length","splice","unhealthyComponents","Object","values","filter","alert","type","severity","c","alerts","toFixed","getHealthHistory","allHistory","sort","a","b","getCurrentMetrics","recentTime","check","on","isMonitoring","getConfig"],"mappings":"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"}
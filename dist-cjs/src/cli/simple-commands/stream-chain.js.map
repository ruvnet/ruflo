{"version":3,"sources":["../../../../src/cli/simple-commands/stream-chain.js"],"sourcesContent":["#!/usr/bin/env node\r\n/**\r\n * Stream Chain Command - Working implementation for Claude Code\r\n * Uses stream-json output but regular prompt input for compatibility\r\n */\r\n\r\nimport { spawn, execSync } from 'child_process';\r\n\r\n/**\r\n * Check if claude command is available\r\n */\r\nfunction checkClaudeAvailable() {\r\n  try {\r\n    execSync('which claude', { stdio: 'ignore' });\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Extract content from stream-json output\r\n */\r\nfunction extractContentFromStream(streamOutput) {\r\n  const lines = streamOutput.split('\\n').filter(line => line.trim());\r\n  let content = '';\r\n  \r\n  for (const line of lines) {\r\n    try {\r\n      const json = JSON.parse(line);\r\n      if (json.type === 'assistant' && json.message && json.message.content) {\r\n        for (const item of json.message.content) {\r\n          if (item.type === 'text' && item.text) {\r\n            content += item.text;\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      // Skip non-JSON lines\r\n    }\r\n  }\r\n  \r\n  return content.trim();\r\n}\r\n\r\n/**\r\n * Execute a single step with context from previous step\r\n */\r\nasync function executeStep(prompt, previousContent, stepNum, totalSteps, flags) {\r\n  return new Promise((resolve) => {\r\n    const startTime = Date.now();\r\n    const timeout = (flags.timeout || 30) * 1000;\r\n    \r\n    // Build the full prompt with context\r\n    let fullPrompt = prompt;\r\n    if (previousContent) {\r\n      fullPrompt = `Previous step output:\\n${previousContent}\\n\\nNext step: ${prompt}`;\r\n    }\r\n    \r\n    // Build command args\r\n    const args = ['-p'];\r\n    \r\n    // Always use stream-json output for parsing\r\n    args.push('--output-format', 'stream-json', '--verbose');\r\n    \r\n    // Add the prompt\r\n    args.push(fullPrompt);\r\n    \r\n    if (flags.verbose) {\r\n      console.log(`   Command: claude ${args[0]} ${args[1]} ${args[2]} \"${args[4].slice(0, 50)}...\"`);\r\n    }\r\n    \r\n    // Spawn Claude process\r\n    const claudeProcess = spawn('claude', args, {\r\n      stdio: ['pipe', 'pipe', 'pipe'],\r\n      env: process.env\r\n    });\r\n    \r\n    let output = '';\r\n    let stderr = '';\r\n    let completed = false;\r\n    \r\n    // Close stdin since we're not piping input\r\n    claudeProcess.stdin.end();\r\n    \r\n    // Capture output\r\n    claudeProcess.stdout.on('data', (chunk) => {\r\n      output += chunk.toString();\r\n    });\r\n    \r\n    // Capture errors\r\n    claudeProcess.stderr.on('data', (chunk) => {\r\n      stderr += chunk.toString();\r\n    });\r\n    \r\n    // Handle completion\r\n    claudeProcess.on('close', (code) => {\r\n      if (completed) return;\r\n      completed = true;\r\n      \r\n      const duration = Date.now() - startTime;\r\n      \r\n      if (code !== 0) {\r\n        console.error(`   Process exited with code ${code}`);\r\n        if (stderr && flags.verbose) {\r\n          console.error(`   stderr: ${stderr.slice(0, 200)}`);\r\n        }\r\n        resolve({\r\n          success: false,\r\n          duration,\r\n          content: null,\r\n          rawOutput: output\r\n        });\r\n        return;\r\n      }\r\n      \r\n      // Extract content from stream-json output\r\n      const content = extractContentFromStream(output);\r\n      \r\n      resolve({\r\n        success: true,\r\n        duration,\r\n        content,\r\n        rawOutput: output\r\n      });\r\n    });\r\n    \r\n    // Handle errors\r\n    claudeProcess.on('error', (error) => {\r\n      if (completed) return;\r\n      completed = true;\r\n      \r\n      console.error('   Process error:', error.message);\r\n      resolve({\r\n        success: false,\r\n        duration: Date.now() - startTime,\r\n        content: null,\r\n        rawOutput: null\r\n      });\r\n    });\r\n    \r\n    // Timeout\r\n    setTimeout(() => {\r\n      if (!completed) {\r\n        completed = true;\r\n        claudeProcess.kill('SIGTERM');\r\n        console.log('   ‚è±Ô∏è  Step timed out');\r\n        resolve({\r\n          success: false,\r\n          duration: timeout,\r\n          content: null,\r\n          rawOutput: null\r\n        });\r\n      }\r\n    }, timeout);\r\n  });\r\n}\r\n\r\n/**\r\n * Execute the chain\r\n */\r\nasync function executeChain(prompts, flags) {\r\n  const results = [];\r\n  let previousContent = null;\r\n  \r\n  for (let i = 0; i < prompts.length; i++) {\r\n    const prompt = prompts[i];\r\n    console.log(`\\nüîÑ Step ${i + 1}/${prompts.length}: ${prompt.slice(0, 50)}...`);\r\n    \r\n    const result = await executeStep(\r\n      prompt,\r\n      previousContent,\r\n      i + 1,\r\n      prompts.length,\r\n      flags\r\n    );\r\n    \r\n    results.push({\r\n      step: i + 1,\r\n      prompt: prompt.slice(0, 50),\r\n      success: result.success,\r\n      duration: result.duration,\r\n      content: result.content\r\n    });\r\n    \r\n    if (!result.success) {\r\n      console.error(`‚ùå Step ${i + 1} failed`);\r\n      break;\r\n    }\r\n    \r\n    console.log(`‚úÖ Step ${i + 1} completed (${result.duration}ms)`);\r\n    \r\n    if (result.content) {\r\n      previousContent = result.content;\r\n      if (flags.verbose) {\r\n        console.log(`   Content: ${result.content.slice(0, 100)}...`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Main command\r\n */\r\nexport async function streamChainCommand(args, flags) {\r\n  const subcommand = args[0] || 'help';\r\n  \r\n  if (subcommand === 'help') {\r\n    showHelp();\r\n    return;\r\n  }\r\n  \r\n  if (!checkClaudeAvailable()) {\r\n    console.error('‚ùå Claude Code not found');\r\n    console.log('Please ensure Claude Code is installed and available');\r\n    return;\r\n  }\r\n  \r\n  switch (subcommand) {\r\n    case 'demo':\r\n      await runDemo(flags);\r\n      break;\r\n      \r\n    case 'run':\r\n      await runCustom(args.slice(1), flags);\r\n      break;\r\n      \r\n    case 'test':\r\n      await runTest(flags);\r\n      break;\r\n      \r\n    case 'pipeline':\r\n      await runPipeline(args.slice(1), flags);\r\n      break;\r\n      \r\n    default:\r\n      console.error(`‚ùå Unknown subcommand: ${subcommand}`);\r\n      showHelp();\r\n  }\r\n}\r\n\r\nfunction showHelp() {\r\n  console.log(`\r\nüîó NAME\r\n    claude-flow stream-chain - Connect multiple Claude instances via stream-json for chained workflows\r\n\r\nüìã SYNOPSIS\r\n    claude-flow stream-chain <subcommand> [options]\r\n\r\nüìù DESCRIPTION\r\n    Stream chaining enables multi-step Claude workflows where each step receives the full\r\n    output from the previous step, creating powerful agent pipelines with context preservation.\r\n    \r\n    Uses Claude Code's --output-format stream-json to capture structured responses and\r\n    chains them together by injecting previous outputs into subsequent prompts.\r\n\r\nüìö SUBCOMMANDS\r\n    run <prompt1> <prompt2> [...]\r\n        Execute a custom stream chain with your own prompts\r\n        Minimum 2 prompts required for chaining\r\n        Each prompt receives the output from the previous step\r\n        \r\n    demo\r\n        Run a 3-step demonstration chain:\r\n        1. Write a Python function to reverse a string\r\n        2. Add type hints to the function\r\n        3. Add a docstring to the function\r\n        \r\n    pipeline <type>\r\n        Execute predefined pipelines for common workflows:\r\n        \r\n        analysis     - Code analysis and improvement pipeline\r\n                      Analyze ‚Üí Identify issues ‚Üí Generate report\r\n                      \r\n        refactor     - Automated refactoring workflow\r\n                      Find refactoring opportunities ‚Üí Create plan ‚Üí Apply changes\r\n                      \r\n        test         - Comprehensive test generation\r\n                      Analyze coverage ‚Üí Design test cases ‚Üí Generate tests\r\n                      \r\n        optimize     - Performance optimization pipeline\r\n                      Profile code ‚Üí Identify bottlenecks ‚Üí Apply optimizations\r\n    \r\n    test\r\n        Test stream chain connection and context preservation\r\n        Verifies that output from step 1 is received by step 2\r\n        \r\n    help\r\n        Display this comprehensive help message\r\n\r\n‚öôÔ∏è  OPTIONS\r\n    --verbose\r\n        Show detailed execution information including:\r\n        - Full command lines being executed\r\n        - Content preview from each step\r\n        - Stream-json parsing details\r\n        \r\n    --timeout <seconds>\r\n        Maximum time per step in seconds (default: 30)\r\n        Prevents hanging on long-running operations\r\n        \r\n    --debug\r\n        Enable debug mode with full stream-json output\r\n        Shows raw JSON messages between steps\r\n\r\nüí° EXAMPLES\r\n    # Run a custom 3-step code improvement chain\r\n    claude-flow stream-chain run \"analyze this code\" \"suggest improvements\" \"implement the top 3\"\r\n    \r\n    # Execute the demo chain to see stream chaining in action\r\n    claude-flow stream-chain demo\r\n    \r\n    # Run the analysis pipeline on your codebase\r\n    claude-flow stream-chain pipeline analysis\r\n    \r\n    # Test that stream chaining is working correctly\r\n    claude-flow stream-chain test --verbose\r\n    \r\n    # Custom refactoring workflow with extended timeout\r\n    claude-flow stream-chain run \"find code smells\" \"prioritize fixes\" \"refactor\" --timeout 60\r\n    \r\n    # Debug mode to see raw stream-json messages\r\n    claude-flow stream-chain demo --debug --verbose\r\n\r\nüîß HOW IT WORKS\r\n    1. Step 1 executes with --output-format stream-json to capture structured output\r\n    2. The assistant's response is extracted from the stream-json format\r\n    3. Step 2 receives the previous output as context in its prompt\r\n    4. This continues for all steps in the chain\r\n    5. Each step has full context of all previous outputs\r\n\r\nüìä STREAM-JSON FORMAT\r\n    Each step outputs newline-delimited JSON with message types:\r\n    {\"type\":\"system\",\"subtype\":\"init\",...}     - Session initialization\r\n    {\"type\":\"assistant\",\"message\":{...}}       - Claude's response\r\n    {\"type\":\"tool_use\",\"name\":\"...\",...}       - Tool invocations\r\n    {\"type\":\"result\",\"status\":\"success\",...}   - Completion status\r\n\r\n‚ö° PERFORMANCE\r\n    - Latency: ~10-30s per step depending on complexity\r\n    - Context: 100% preservation between steps\r\n    - Parallel: Steps run sequentially to maintain context\r\n    - Timeout: Default 30s per step, configurable\r\n\r\nüìã REQUIREMENTS\r\n    - Claude Code must be installed and available in PATH\r\n    - Valid Claude API configuration\r\n    - Sufficient API credits for multiple Claude calls\r\n\r\nüîç TROUBLESHOOTING\r\n    \"Command not found\"\r\n    ‚Üí Ensure Claude Code is installed: npm install -g @anthropic-ai/claude-code\r\n    \r\n    \"Step timed out\"\r\n    ‚Üí Increase timeout with --timeout flag\r\n    ‚Üí Check network connectivity\r\n    \r\n    \"Context not preserved\"\r\n    ‚Üí Verify stream-json output with --verbose\r\n    ‚Üí Check that all steps completed successfully\r\n    \r\n    \"Invalid JSON\"\r\n    ‚Üí Use --debug to see raw output\r\n    ‚Üí Report issue if stream format has changed\r\n\r\nüîó SEE ALSO\r\n    claude-flow swarm        - Multi-agent coordination\r\n    claude-flow hive-mind    - Collective intelligence mode\r\n    claude-flow sparc        - SPARC development methodology\r\n    \r\nüìñ DOCUMENTATION\r\n    Full docs: ./claude-flow-wiki/Stream-Chain-Command.md\r\n    Stream spec: ./docs/stream-chaining.md\r\n    GitHub: https://github.com/ruvnet/claude-flow\r\n\r\nüè∑Ô∏è VERSION\r\n    Claude Flow Alpha 89 - Stream Chain v2.0.0\r\n  `);\r\n}\r\n\r\nasync function runDemo(flags) {\r\n  console.log('üé≠ Running Stream Chain Demo');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const prompts = [\r\n    \"Write a simple Python function to reverse a string\",\r\n    \"Add type hints to the function\",\r\n    \"Add a docstring to the function\"\r\n  ];\r\n  \r\n  const results = await executeChain(prompts, flags);\r\n  showSummary(results);\r\n}\r\n\r\nasync function runCustom(prompts, flags) {\r\n  if (prompts.length < 2) {\r\n    console.error('‚ùå Need at least 2 prompts');\r\n    return;\r\n  }\r\n  \r\n  console.log('üîó Starting Custom Chain');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const results = await executeChain(prompts, flags);\r\n  showSummary(results);\r\n}\r\n\r\nasync function runTest(flags) {\r\n  console.log('üß™ Testing Stream Chain');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const prompts = [\r\n    \"Say exactly: 'Step 1 complete'\",\r\n    \"If the previous step said 'Step 1 complete', say 'Chain working!'\"\r\n  ];\r\n  \r\n  const results = await executeChain(prompts, { ...flags, verbose: true });\r\n  \r\n  const success = results.every(r => r.success);\r\n  console.log('\\n' + (success ? '‚úÖ Test passed!' : '‚ùå Test failed'));\r\n}\r\n\r\nasync function runPipeline(args, flags) {\r\n  const pipelineType = args[0];\r\n  \r\n  const pipelines = {\r\n    analysis: {\r\n      name: 'Code Analysis Pipeline',\r\n      prompts: [\r\n        \"Analyze the current directory structure and identify the main components\",\r\n        \"Based on the analysis, identify potential improvements and issues\",\r\n        \"Generate a detailed report with actionable recommendations\"\r\n      ]\r\n    },\r\n    refactor: {\r\n      name: 'Refactoring Workflow',\r\n      prompts: [\r\n        \"Identify code that could benefit from refactoring in the current project\",\r\n        \"Create a prioritized refactoring plan with specific changes\",\r\n        \"Provide refactored code examples for the top 3 priorities\"\r\n      ]\r\n    },\r\n    test: {\r\n      name: 'Test Generation Pipeline',\r\n      prompts: [\r\n        \"Analyze the codebase and identify areas lacking test coverage\",\r\n        \"Design comprehensive test cases for the critical functions\",\r\n        \"Generate unit test implementations with assertions\"\r\n      ]\r\n    },\r\n    optimize: {\r\n      name: 'Performance Optimization Pipeline',\r\n      prompts: [\r\n        \"Profile the codebase and identify performance bottlenecks\",\r\n        \"Analyze the bottlenecks and suggest optimization strategies\",\r\n        \"Provide optimized implementations for the main issues\"\r\n      ]\r\n    }\r\n  };\r\n  \r\n  if (!pipelineType || !pipelines[pipelineType]) {\r\n    console.error('‚ùå Invalid or missing pipeline type');\r\n    console.log('Available pipelines: ' + Object.keys(pipelines).join(', '));\r\n    console.log('Usage: claude-flow stream-chain pipeline <type>');\r\n    return;\r\n  }\r\n  \r\n  const pipeline = pipelines[pipelineType];\r\n  console.log(`üöÄ Running ${pipeline.name}`);\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  const results = await executeChain(pipeline.prompts, flags);\r\n  showSummary(results);\r\n}\r\n\r\nfunction showSummary(results) {\r\n  console.log('\\n' + '‚ïê'.repeat(50));\r\n  console.log('üìä Summary');\r\n  console.log('‚ïê'.repeat(50));\r\n  \r\n  for (const r of results) {\r\n    const status = r.success ? '‚úÖ' : '‚ùå';\r\n    console.log(`${status} Step ${r.step}: ${r.prompt}... (${r.duration}ms)`);\r\n  }\r\n  \r\n  const total = results.reduce((sum, r) => sum + r.duration, 0);\r\n  const success = results.filter(r => r.success).length;\r\n  \r\n  console.log(`\\n‚è±Ô∏è  Total: ${total}ms`);\r\n  console.log(`üìà Success: ${success}/${results.length}`);\r\n}\r\n\r\nexport default streamChainCommand;"],"names":["spawn","execSync","checkClaudeAvailable","stdio","extractContentFromStream","streamOutput","lines","split","filter","line","trim","content","json","JSON","parse","type","message","item","text","e","executeStep","prompt","previousContent","stepNum","totalSteps","flags","Promise","resolve","startTime","Date","now","timeout","fullPrompt","args","push","verbose","console","log","slice","claudeProcess","env","process","output","stderr","completed","stdin","end","stdout","on","chunk","toString","code","duration","error","success","rawOutput","setTimeout","kill","executeChain","prompts","results","i","length","result","step","streamChainCommand","subcommand","showHelp","runDemo","runCustom","runTest","runPipeline","repeat","showSummary","every","r","pipelineType","pipelines","analysis","name","refactor","test","optimize","Object","keys","join","pipeline","status","total","reduce","sum"],"mappings":"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"}
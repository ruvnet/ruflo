{
  "version": 3,
  "sources": ["../../src/providers/anthropic-provider.ts"],
  "sourcesContent": ["/**\n * Anthropic (Claude) Provider Implementation\n * Extends the existing Claude client with unified provider interface\n */\n\nimport { BaseProvider } from './base-provider.js';\nimport { ClaudeAPIClient, ClaudeModel as AnthropicModel } from '../api/claude-client.js';\nimport {\n  LLMProvider,\n  LLMModel,\n  LLMRequest,\n  LLMResponse,\n  LLMStreamEvent,\n  ModelInfo,\n  ProviderCapabilities,\n  HealthCheckResult,\n  LLMProviderError,\n} from './types.js';\n\nexport class AnthropicProvider extends BaseProvider {\n  readonly name: LLMProvider = 'anthropic';\n  readonly capabilities: ProviderCapabilities = {\n    supportedModels: [\n      'claude-3-opus-20240229',\n      'claude-3-sonnet-20240229',\n      'claude-3-haiku-20240307',\n      'claude-2.1',\n      'claude-2.0',\n      'claude-instant-1.2',\n    ],\n    maxContextLength: {\n      'claude-3-opus-20240229': 200000,\n      'claude-3-sonnet-20240229': 200000,\n      'claude-3-haiku-20240307': 200000,\n      'claude-2.1': 200000,\n      'claude-2.0': 100000,\n      'claude-instant-1.2': 100000,\n    } as Record<LLMModel, number>,\n    maxOutputTokens: {\n      'claude-3-opus-20240229': 4096,\n      'claude-3-sonnet-20240229': 4096,\n      'claude-3-haiku-20240307': 4096,\n      'claude-2.1': 4096,\n      'claude-2.0': 4096,\n      'claude-instant-1.2': 4096,\n    } as Record<LLMModel, number>,\n    supportsStreaming: true,\n    supportsFunctionCalling: false, // Claude doesn't have native function calling yet\n    supportsSystemMessages: true,\n    supportsVision: true, // Claude 3 models support vision\n    supportsAudio: false,\n    supportsTools: false,\n    supportsFineTuning: false,\n    supportsEmbeddings: false,\n    supportsLogprobs: false,\n    supportsBatching: false,\n    pricing: {\n      'claude-3-opus-20240229': {\n        promptCostPer1k: 0.015,\n        completionCostPer1k: 0.075,\n        currency: 'USD',\n      },\n      'claude-3-sonnet-20240229': {\n        promptCostPer1k: 0.003,\n        completionCostPer1k: 0.015,\n        currency: 'USD',\n      },\n      'claude-3-haiku-20240307': {\n        promptCostPer1k: 0.00025,\n        completionCostPer1k: 0.00125,\n        currency: 'USD',\n      },\n      'claude-2.1': {\n        promptCostPer1k: 0.008,\n        completionCostPer1k: 0.024,\n        currency: 'USD',\n      },\n      'claude-2.0': {\n        promptCostPer1k: 0.008,\n        completionCostPer1k: 0.024,\n        currency: 'USD',\n      },\n      'claude-instant-1.2': {\n        promptCostPer1k: 0.0008,\n        completionCostPer1k: 0.0024,\n        currency: 'USD',\n      },\n    },\n  };\n\n  private claudeClient!: ClaudeAPIClient;\n\n  protected async doInitialize(): Promise<void> {\n    // Create Claude client with our config\n    this.claudeClient = new ClaudeAPIClient(\n      this.logger,\n      { get: () => this.config } as any, // Mock config manager\n      {\n        apiKey: this.config.apiKey!,\n        model: this.mapToAnthropicModel(this.config.model),\n        temperature: this.config.temperature,\n        maxTokens: this.config.maxTokens,\n        topP: this.config.topP,\n        topK: this.config.topK,\n        timeout: this.config.timeout,\n        retryAttempts: this.config.retryAttempts,\n        retryDelay: this.config.retryDelay,\n      }\n    );\n  }\n\n  protected async doComplete(request: LLMRequest): Promise<LLMResponse> {\n    // Convert request to Claude format\n    const claudeMessages = request.messages.map((msg) => ({\n      role: msg.role === 'system' ? 'user' : msg.role as 'user' | 'assistant',\n      content: msg.role === 'system' ? `System: ${msg.content}` : msg.content,\n    }));\n\n    // Extract system message if present\n    const systemMessage = request.messages.find((m) => m.role === 'system');\n    \n    // Call Claude API\n    const response = await this.claudeClient.sendMessage(claudeMessages, {\n      model: request.model ? this.mapToAnthropicModel(request.model) : undefined,\n      temperature: request.temperature,\n      maxTokens: request.maxTokens,\n      systemPrompt: systemMessage?.content,\n      stream: false,\n    }) as any; // ClaudeResponse type\n\n    // Calculate cost\n    const pricing = this.capabilities.pricing![response.model];\n    const promptCost = (response.usage.input_tokens / 1000) * pricing.promptCostPer1k;\n    const completionCost = (response.usage.output_tokens / 1000) * pricing.completionCostPer1k;\n\n    // Convert to unified response format\n    return {\n      id: response.id,\n      model: this.mapFromAnthropicModel(response.model),\n      provider: 'anthropic',\n      content: response.content[0].text,\n      usage: {\n        promptTokens: response.usage.input_tokens,\n        completionTokens: response.usage.output_tokens,\n        totalTokens: response.usage.input_tokens + response.usage.output_tokens,\n      },\n      cost: {\n        promptCost,\n        completionCost,\n        totalCost: promptCost + completionCost,\n        currency: 'USD',\n      },\n      finishReason: response.stop_reason === 'end_turn' ? 'stop' : 'length',\n    };\n  }\n\n  protected async *doStreamComplete(request: LLMRequest): AsyncIterable<LLMStreamEvent> {\n    // Convert request to Claude format\n    const claudeMessages = request.messages.map((msg) => ({\n      role: msg.role === 'system' ? 'user' : msg.role as 'user' | 'assistant',\n      content: msg.role === 'system' ? `System: ${msg.content}` : msg.content,\n    }));\n\n    const systemMessage = request.messages.find((m) => m.role === 'system');\n    \n    // Get stream from Claude API\n    const stream = await this.claudeClient.sendMessage(claudeMessages, {\n      model: request.model ? this.mapToAnthropicModel(request.model) : undefined,\n      temperature: request.temperature,\n      maxTokens: request.maxTokens,\n      systemPrompt: systemMessage?.content,\n      stream: true,\n    }) as AsyncIterable<any>; // ClaudeStreamEvent type\n\n    let accumulatedContent = '';\n    let totalTokens = 0;\n\n    // Process stream events\n    for await (const event of stream) {\n      if (event.type === 'content_block_delta' && event.delta?.text) {\n        accumulatedContent += event.delta.text;\n        yield {\n          type: 'content',\n          delta: {\n            content: event.delta.text,\n          },\n        };\n      } else if (event.type === 'message_delta' && event.usage) {\n        totalTokens = event.usage.output_tokens;\n      } else if (event.type === 'message_stop') {\n        // Calculate final cost\n        const model = request.model || this.config.model;\n        const pricing = this.capabilities.pricing![model];\n        \n        // Estimate prompt tokens (rough approximation)\n        const promptTokens = this.estimateTokens(JSON.stringify(request.messages));\n        const completionTokens = totalTokens;\n        \n        const promptCost = (promptTokens / 1000) * pricing.promptCostPer1k;\n        const completionCost = (completionTokens / 1000) * pricing.completionCostPer1k;\n\n        yield {\n          type: 'done',\n          usage: {\n            promptTokens,\n            completionTokens,\n            totalTokens: promptTokens + completionTokens,\n          },\n          cost: {\n            promptCost,\n            completionCost,\n            totalCost: promptCost + completionCost,\n            currency: 'USD',\n          },\n        };\n      }\n    }\n  }\n\n  async listModels(): Promise<LLMModel[]> {\n    return this.capabilities.supportedModels;\n  }\n\n  async getModelInfo(model: LLMModel): Promise<ModelInfo> {\n    const anthropicModel = this.mapToAnthropicModel(model);\n    const info = this.claudeClient.getModelInfo(anthropicModel);\n    \n    return {\n      model,\n      name: info.name,\n      description: info.description,\n      contextLength: info.contextWindow,\n      maxOutputTokens: this.capabilities.maxOutputTokens[model] || 4096,\n      supportedFeatures: [\n        'chat',\n        'completion',\n        ...(model.startsWith('claude-3') ? ['vision'] : []),\n      ],\n      pricing: this.capabilities.pricing![model],\n    };\n  }\n\n  protected async doHealthCheck(): Promise<HealthCheckResult> {\n    try {\n      // Use a minimal request to check API availability\n      await this.claudeClient.complete('Hi', {\n        maxTokens: 1,\n      });\n      \n      return {\n        healthy: true,\n        timestamp: new Date(),\n      };\n    } catch (error) {\n      return {\n        healthy: false,\n        error: error instanceof Error ? error.message : 'Unknown error',\n        timestamp: new Date(),\n      };\n    }\n  }\n\n  /**\n   * Map unified model to Anthropic model\n   */\n  private mapToAnthropicModel(model: LLMModel): AnthropicModel {\n    // Direct mapping since we use the same model names\n    return model as AnthropicModel;\n  }\n\n  /**\n   * Map Anthropic model to unified model\n   */\n  private mapFromAnthropicModel(model: AnthropicModel): LLMModel {\n    return model as LLMModel;\n  }\n\n  destroy(): void {\n    super.destroy();\n    this.claudeClient?.destroy();\n  }\n}"],
  "mappings": "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",
  "names": []
}

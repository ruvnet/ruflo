{"version":3,"sources":["../../../../src/cli/simple-commands/hook-safety.js"],"sourcesContent":["/**\r\n * Hook Safety System - Prevents recursive hook execution and financial damage\r\n *\r\n * This system protects against infinite loops where Claude Code hooks call\r\n * 'claude' commands, which could bypass rate limits and cost thousands of dollars.\r\n *\r\n * Critical protections:\r\n * - Environment variable context detection\r\n * - Recursive call prevention\r\n * - Circuit breaker for Stop hooks\r\n * - Configuration validation\r\n * - Emergency override flags\r\n */\r\n\r\nimport { printError, printWarning, printSuccess } from '../utils.js';\r\nimport { existsSync, readFileSync } from 'fs';\r\nimport path from 'path';\r\n\r\n/**\r\n * Hook Safety Configuration\r\n */\r\nconst HOOK_SAFETY_CONFIG = {\r\n  // Maximum hook execution depth before blocking\r\n  MAX_HOOK_DEPTH: 3,\r\n\r\n  // Maximum Stop hook executions per session\r\n  MAX_STOP_HOOK_EXECUTIONS: 2,\r\n\r\n  // Circuit breaker timeout (milliseconds)\r\n  CIRCUIT_BREAKER_TIMEOUT: 60000, // 1 minute\r\n\r\n  // Environment variables for context detection\r\n  ENV_VARS: {\r\n    CONTEXT: 'CLAUDE_HOOK_CONTEXT',\r\n    DEPTH: 'CLAUDE_HOOK_DEPTH',\r\n    SESSION_ID: 'CLAUDE_HOOK_SESSION_ID',\r\n    SKIP_HOOKS: 'CLAUDE_SKIP_HOOKS',\r\n    SAFE_MODE: 'CLAUDE_SAFE_MODE',\r\n  },\r\n};\r\n\r\n/**\r\n * Global hook execution tracking\r\n */\r\nclass HookExecutionTracker {\r\n  constructor() {\r\n    this.executions = new Map();\r\n    this.sessionId = this.generateSessionId();\r\n    this.resetTimeout = null;\r\n  }\r\n\r\n  generateSessionId() {\r\n    return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  track(hookType) {\r\n    const key = `${this.sessionId}:${hookType}`;\r\n    const count = this.executions.get(key) || 0;\r\n    this.executions.set(key, count + 1);\r\n\r\n    // Auto-reset after timeout\r\n    if (this.resetTimeout) clearTimeout(this.resetTimeout);\r\n    this.resetTimeout = setTimeout(() => {\r\n      this.executions.clear();\r\n    }, HOOK_SAFETY_CONFIG.CIRCUIT_BREAKER_TIMEOUT);\r\n\r\n    return count + 1;\r\n  }\r\n\r\n  getExecutionCount(hookType) {\r\n    const key = `${this.sessionId}:${hookType}`;\r\n    return this.executions.get(key) || 0;\r\n  }\r\n\r\n  reset() {\r\n    this.executions.clear();\r\n    this.sessionId = this.generateSessionId();\r\n  }\r\n}\r\n\r\n// Global instance\r\nconst executionTracker = new HookExecutionTracker();\r\n\r\n/**\r\n * Hook Context Manager - Tracks hook execution context\r\n */\r\nexport class HookContextManager {\r\n  static setContext(hookType, depth = 1) {\r\n    process.env[HOOK_SAFETY_CONFIG.ENV_VARS.CONTEXT] = hookType;\r\n    process.env[HOOK_SAFETY_CONFIG.ENV_VARS.DEPTH] = depth.toString();\r\n    process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SESSION_ID] = executionTracker.sessionId;\r\n  }\r\n\r\n  static getContext() {\r\n    return {\r\n      type: process.env[HOOK_SAFETY_CONFIG.ENV_VARS.CONTEXT],\r\n      depth: parseInt(process.env[HOOK_SAFETY_CONFIG.ENV_VARS.DEPTH] || '0'),\r\n      sessionId: process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SESSION_ID],\r\n      skipHooks: process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SKIP_HOOKS] === 'true',\r\n      safeMode: process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SAFE_MODE] === 'true',\r\n    };\r\n  }\r\n\r\n  static clearContext() {\r\n    delete process.env[HOOK_SAFETY_CONFIG.ENV_VARS.CONTEXT];\r\n    delete process.env[HOOK_SAFETY_CONFIG.ENV_VARS.DEPTH];\r\n    delete process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SESSION_ID];\r\n  }\r\n\r\n  static isInHookContext() {\r\n    return !!process.env[HOOK_SAFETY_CONFIG.ENV_VARS.CONTEXT];\r\n  }\r\n\r\n  static setSafeMode(enabled = true) {\r\n    if (enabled) {\r\n      process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SAFE_MODE] = 'true';\r\n    } else {\r\n      delete process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SAFE_MODE];\r\n    }\r\n  }\r\n\r\n  static setSkipHooks(enabled = true) {\r\n    if (enabled) {\r\n      process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SKIP_HOOKS] = 'true';\r\n    } else {\r\n      delete process.env[HOOK_SAFETY_CONFIG.ENV_VARS.SKIP_HOOKS];\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Command Validator - Validates commands for hook safety\r\n */\r\nexport class HookCommandValidator {\r\n  /**\r\n   * Validate if a command is safe to execute from a hook\r\n   */\r\n  static validateCommand(command, hookType) {\r\n    const context = HookContextManager.getContext();\r\n    const warnings = [];\r\n    const errors = [];\r\n\r\n    // Critical check: Claude commands in Stop hooks\r\n    if (hookType === 'Stop' && this.isClaudeCommand(command)) {\r\n      errors.push({\r\n        type: 'CRITICAL_RECURSION_RISK',\r\n        message:\r\n          'üö® CRITICAL ERROR: Claude command detected in Stop hook!\\n' +\r\n          'This creates an INFINITE LOOP that can cost THOUSANDS OF DOLLARS.\\n' +\r\n          'Stop hooks that call \"claude\" commands bypass rate limits and\\n' +\r\n          'can result in massive unexpected API charges.\\n\\n' +\r\n          'BLOCKED FOR SAFETY - Use alternative patterns instead.',\r\n      });\r\n    }\r\n\r\n    // General recursion detection\r\n    if (context.type && this.isClaudeCommand(command)) {\r\n      const depth = context.depth;\r\n\r\n      if (depth >= HOOK_SAFETY_CONFIG.MAX_HOOK_DEPTH) {\r\n        errors.push({\r\n          type: 'HOOK_RECURSION_LIMIT',\r\n          message:\r\n            `üö® Hook recursion limit exceeded! (Depth: ${depth})\\n` +\r\n            `Hook type: ${context.type}\\n` +\r\n            'Blocking execution to prevent infinite loop.',\r\n        });\r\n      } else {\r\n        warnings.push({\r\n          type: 'POTENTIAL_RECURSION',\r\n          message:\r\n            `‚ö†Ô∏è  WARNING: Claude command in ${context.type} hook (depth: ${depth})\\n` +\r\n            'This could create recursion. Consider using --skip-hooks flag.',\r\n        });\r\n      }\r\n    }\r\n\r\n    // Check for other dangerous patterns\r\n    if (this.isDangerousPattern(command, hookType)) {\r\n      warnings.push({\r\n        type: 'DANGEROUS_PATTERN',\r\n        message:\r\n          `‚ö†Ô∏è  WARNING: Potentially dangerous hook pattern detected.\\n` +\r\n          'Review the command and consider safer alternatives.',\r\n      });\r\n    }\r\n\r\n    return { warnings, errors, safe: errors.length === 0 };\r\n  }\r\n\r\n  static isClaudeCommand(command) {\r\n    // Match various forms of claude command invocation\r\n    const claudePatterns = [\r\n      /\\bclaude\\b/, // Direct claude command\r\n      /claude-code\\b/, // claude-code command\r\n      /npx\\s+claude\\b/, // NPX claude\r\n      /\\.\\/claude\\b/, // Local claude wrapper\r\n      /claude\\.exe\\b/, // Windows executable\r\n    ];\r\n\r\n    return claudePatterns.some((pattern) => pattern.test(command));\r\n  }\r\n\r\n  static isDangerousPattern(command, hookType) {\r\n    const dangerousPatterns = [\r\n      // Commands that could trigger more hooks\r\n      /git\\s+commit.*--all/,\r\n      /git\\s+add\\s+\\./,\r\n      // File operations that might trigger watchers\r\n      /watch\\s+.*claude/,\r\n      /nodemon.*claude/,\r\n      // Recursive script execution\r\n      /bash.*hook/,\r\n      /sh.*hook/,\r\n    ];\r\n\r\n    return dangerousPatterns.some((pattern) => pattern.test(command));\r\n  }\r\n}\r\n\r\n/**\r\n * Circuit Breaker - Prevents runaway hook execution\r\n */\r\nexport class HookCircuitBreaker {\r\n  /**\r\n   * Check if hook execution should be allowed\r\n   */\r\n  static checkExecution(hookType) {\r\n    const executionCount = executionTracker.track(hookType);\r\n\r\n    // Stop hook protection - maximum 2 executions per session\r\n    if (hookType === 'Stop' && executionCount > HOOK_SAFETY_CONFIG.MAX_STOP_HOOK_EXECUTIONS) {\r\n      throw new Error(\r\n        `üö® CIRCUIT BREAKER ACTIVATED!\\n` +\r\n          `Stop hook has executed ${executionCount} times in this session.\\n` +\r\n          `This indicates a potential infinite loop that could cost thousands of dollars.\\n` +\r\n          `Execution blocked for financial protection.\\n\\n` +\r\n          `To reset: Use --reset-circuit-breaker flag or restart your session.`,\r\n      );\r\n    }\r\n\r\n    // General protection for any hook type\r\n    if (executionCount > 20) {\r\n      throw new Error(\r\n        `üö® CIRCUIT BREAKER: ${hookType} hook executed ${executionCount} times!\\n` +\r\n          `This is highly unusual and indicates a potential problem.\\n` +\r\n          `Execution blocked to prevent system overload.`,\r\n      );\r\n    }\r\n\r\n    // Log warnings for concerning patterns\r\n    if (hookType === 'Stop' && executionCount > 1) {\r\n      printWarning(`‚ö†Ô∏è  Stop hook execution #${executionCount} detected. Monitor for recursion.`);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  static reset() {\r\n    executionTracker.reset();\r\n    printSuccess('Circuit breaker reset successfully.');\r\n  }\r\n\r\n  static getStatus() {\r\n    return {\r\n      sessionId: executionTracker.sessionId,\r\n      executions: Array.from(executionTracker.executions.entries()).map(([key, count]) => {\r\n        const [sessionId, hookType] = key.split(':');\r\n        return { hookType, count };\r\n      }),\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Configuration Validator - Validates hook configurations for safety\r\n */\r\nexport class HookConfigValidator {\r\n  /**\r\n   * Validate Claude Code settings.json for dangerous hook configurations\r\n   */\r\n  static validateClaudeCodeConfig(configPath = null) {\r\n    if (!configPath) {\r\n      // Try to find Claude Code settings\r\n      const possiblePaths = [\r\n        path.join(process.env.HOME || '.', '.claude', 'settings.json'),\r\n        path.join(process.cwd(), '.claude', 'settings.json'),\r\n        path.join(process.cwd(), 'settings.json'),\r\n      ];\r\n\r\n      configPath = possiblePaths.find((p) => existsSync(p));\r\n\r\n      if (!configPath) {\r\n        return { safe: true, message: 'No Claude Code configuration found.' };\r\n      }\r\n    }\r\n\r\n    try {\r\n      const config = JSON.parse(readFileSync(configPath, 'utf8'));\r\n      const validation = this.validateHooksConfig(config.hooks || {});\r\n\r\n      return {\r\n        safe: validation.errors.length === 0,\r\n        configPath,\r\n        ...validation,\r\n      };\r\n    } catch (err) {\r\n      return {\r\n        safe: false,\r\n        error: `Failed to validate configuration: ${err.message}`,\r\n        configPath,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate hooks configuration object\r\n   */\r\n  static validateHooksConfig(hooksConfig) {\r\n    const warnings = [];\r\n    const errors = [];\r\n\r\n    // Check Stop hooks specifically\r\n    if (hooksConfig.Stop) {\r\n      for (const hookGroup of hooksConfig.Stop) {\r\n        for (const hook of hookGroup.hooks || []) {\r\n          if (hook.type === 'command' && hook.command) {\r\n            const result = HookCommandValidator.validateCommand(hook.command, 'Stop');\r\n            warnings.push(...result.warnings);\r\n            errors.push(...result.errors);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check other dangerous hook types\r\n    const dangerousHookTypes = ['SubagentStop', 'PostToolUse'];\r\n    for (const hookType of dangerousHookTypes) {\r\n      if (hooksConfig[hookType]) {\r\n        for (const hookGroup of hooksConfig[hookType]) {\r\n          for (const hook of hookGroup.hooks || []) {\r\n            if (hook.type === 'command' && hook.command) {\r\n              const result = HookCommandValidator.validateCommand(hook.command, hookType);\r\n              warnings.push(...result.warnings);\r\n              errors.push(...result.errors);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return { warnings, errors };\r\n  }\r\n\r\n  /**\r\n   * Generate safe configuration recommendations\r\n   */\r\n  static generateSafeAlternatives(dangerousConfig) {\r\n    const alternatives = [];\r\n\r\n    // Example: Stop hook calling claude\r\n    if (dangerousConfig.includes('claude')) {\r\n      alternatives.push({\r\n        pattern: 'Stop hook with claude command',\r\n        problem: 'Creates infinite recursion loop',\r\n        solution: 'Use flag-based approach instead',\r\n        example: `\r\n// Instead of this DANGEROUS pattern:\r\n{\r\n  \"Stop\": [{\r\n    \"hooks\": [{\"type\": \"command\", \"command\": \"claude -c -p 'Update history'\"}]\r\n  }]\r\n}\r\n\r\n// Use this SAFE pattern:\r\n{\r\n  \"Stop\": [{\r\n    \"hooks\": [{\"type\": \"command\", \"command\": \"touch ~/.claude/needs_update\"}]\r\n  }]\r\n}\r\n\r\n// Then manually run: claude -c -p \"Update history\" when needed\r\n        `,\r\n      });\r\n\r\n      alternatives.push({\r\n        pattern: 'PostToolUse hook alternative',\r\n        problem: 'Stop hooks execute too frequently',\r\n        solution: 'Use PostToolUse for specific tools',\r\n        example: `\r\n// SAFER: Use PostToolUse for specific operations\r\n{\r\n  \"PostToolUse\": [{\r\n    \"matcher\": \"Write|Edit|MultiEdit\",\r\n    \"hooks\": [{\"type\": \"command\", \"command\": \"echo 'File modified' >> ~/.claude/changes.log\"}]\r\n  }]\r\n}\r\n        `,\r\n      });\r\n    }\r\n\r\n    return alternatives;\r\n  }\r\n}\r\n\r\n/**\r\n * Safe Hook Execution Wrapper\r\n */\r\nexport class SafeHookExecutor {\r\n  /**\r\n   * Safely execute a hook command with all safety checks\r\n   */\r\n  static async executeHookCommand(command, hookType, options = {}) {\r\n    try {\r\n      // Skip if hooks are disabled\r\n      if (HookContextManager.getContext().skipHooks) {\r\n        console.log(`‚è≠Ô∏è  Skipping ${hookType} hook (hooks disabled)`);\r\n        return { success: true, skipped: true };\r\n      }\r\n\r\n      // Circuit breaker check\r\n      HookCircuitBreaker.checkExecution(hookType);\r\n\r\n      // Command validation\r\n      const validation = HookCommandValidator.validateCommand(command, hookType);\r\n\r\n      // Show warnings\r\n      for (const warning of validation.warnings) {\r\n        printWarning(warning.message);\r\n      }\r\n\r\n      // Block on errors\r\n      if (!validation.safe) {\r\n        for (const error of validation.errors) {\r\n          printError(error.message);\r\n        }\r\n        return { success: false, blocked: true, errors: validation.errors };\r\n      }\r\n\r\n      // Set hook context for nested calls\r\n      const currentContext = HookContextManager.getContext();\r\n      const newDepth = currentContext.depth + 1;\r\n      HookContextManager.setContext(hookType, newDepth);\r\n\r\n      // Execute the command with safety context\r\n      const result = await this.executeCommand(command, options);\r\n\r\n      return { success: true, result };\r\n    } catch (err) {\r\n      printError(`Hook execution failed: ${err.message}`);\r\n      return { success: false, error: err.message };\r\n    } finally {\r\n      // Clear context\r\n      HookContextManager.clearContext();\r\n    }\r\n  }\r\n\r\n  static async executeCommand(command, options = {}) {\r\n    // This would integrate with the actual command execution system\r\n    // For now, just log what would be executed\r\n    console.log(`üîó Executing hook command: ${command}`);\r\n\r\n    // Here you would actually execute the command\r\n    // return await execCommand(command, options);\r\n\r\n    return { stdout: '', stderr: '', exitCode: 0 };\r\n  }\r\n}\r\n\r\n/**\r\n * Hook Safety CLI Commands\r\n */\r\nexport async function hookSafetyCommand(subArgs, flags) {\r\n  const subcommand = subArgs[0];\r\n\r\n  switch (subcommand) {\r\n    case 'validate':\r\n      return await validateConfigCommand(subArgs, flags);\r\n    case 'status':\r\n      return await statusCommand(subArgs, flags);\r\n    case 'reset':\r\n      return await resetCommand(subArgs, flags);\r\n    case 'safe-mode':\r\n      return await safeModeCommand(subArgs, flags);\r\n    default:\r\n      showHookSafetyHelp();\r\n  }\r\n}\r\n\r\nasync function validateConfigCommand(subArgs, flags) {\r\n  const configPath = flags.config || flags.c;\r\n\r\n  console.log('üîç Validating hook configuration for safety...\\n');\r\n\r\n  const result = HookConfigValidator.validateClaudeCodeConfig(configPath);\r\n\r\n  if (result.safe) {\r\n    printSuccess('‚úÖ Hook configuration is safe!');\r\n    if (result.configPath) {\r\n      console.log(`üìÑ Validated: ${result.configPath}`);\r\n    }\r\n  } else {\r\n    printError('‚ùå DANGEROUS hook configuration detected!');\r\n\r\n    if (result.errors) {\r\n      console.log('\\nüö® CRITICAL ERRORS:');\r\n      for (const error of result.errors) {\r\n        console.log(`\\n${error.message}`);\r\n      }\r\n    }\r\n\r\n    if (result.warnings) {\r\n      console.log('\\n‚ö†Ô∏è  WARNINGS:');\r\n      for (const warning of result.warnings) {\r\n        console.log(`\\n${warning.message}`);\r\n      }\r\n    }\r\n\r\n    console.log('\\nüí° RECOMMENDATIONS:');\r\n    console.log('1. Remove claude commands from Stop hooks');\r\n    console.log('2. Use PostToolUse hooks for specific tools');\r\n    console.log('3. Implement flag-based update patterns');\r\n    console.log('4. Use claude --skip-hooks for manual updates');\r\n  }\r\n}\r\n\r\nasync function statusCommand(subArgs, flags) {\r\n  const context = HookContextManager.getContext();\r\n  const circuitStatus = HookCircuitBreaker.getStatus();\r\n\r\n  console.log('üîó Hook Safety Status\\n');\r\n\r\n  console.log('üìä Current Context:');\r\n  if (context.type) {\r\n    console.log(`  üîÑ Hook Type: ${context.type}`);\r\n    console.log(`  üìè Depth: ${context.depth}`);\r\n    console.log(`  üÜî Session: ${context.sessionId}`);\r\n    console.log(`  ‚è≠Ô∏è  Skip Hooks: ${context.skipHooks ? 'Yes' : 'No'}`);\r\n    console.log(`  üõ°Ô∏è  Safe Mode: ${context.safeMode ? 'Yes' : 'No'}`);\r\n  } else {\r\n    console.log('  ‚úÖ Not currently in hook context');\r\n  }\r\n\r\n  console.log('\\n‚ö° Circuit Breaker Status:');\r\n  console.log(`  üÜî Session: ${circuitStatus.sessionId}`);\r\n\r\n  if (circuitStatus.executions.length > 0) {\r\n    console.log('  üìä Hook Executions:');\r\n    for (const exec of circuitStatus.executions) {\r\n      console.log(`    ‚Ä¢ ${exec.hookType}: ${exec.count} times`);\r\n    }\r\n  } else {\r\n    console.log('  ‚úÖ No hook executions in current session');\r\n  }\r\n}\r\n\r\nasync function resetCommand(subArgs, flags) {\r\n  console.log('üîÑ Resetting hook safety systems...\\n');\r\n\r\n  HookCircuitBreaker.reset();\r\n  HookContextManager.clearContext();\r\n\r\n  printSuccess('‚úÖ Hook safety systems reset successfully!');\r\n  console.log('All execution counters and context cleared.');\r\n}\r\n\r\nasync function safeModeCommand(subArgs, flags) {\r\n  const enable = !flags.disable && !flags.off;\r\n\r\n  if (enable) {\r\n    HookContextManager.setSafeMode(true);\r\n    HookContextManager.setSkipHooks(true);\r\n    printSuccess('üõ°Ô∏è  Safe mode enabled!');\r\n    console.log('‚Ä¢ All hooks will be skipped');\r\n    console.log('‚Ä¢ Claude commands will show safety warnings');\r\n    console.log('‚Ä¢ Additional validation will be performed');\r\n  } else {\r\n    HookContextManager.setSafeMode(false);\r\n    HookContextManager.setSkipHooks(false);\r\n    printSuccess('‚ö° Safe mode disabled.');\r\n    console.log('Normal hook execution restored.');\r\n  }\r\n}\r\n\r\nfunction showHookSafetyHelp() {\r\n  console.log(`\r\nüõ°Ô∏è  Hook Safety System - Prevent Infinite Loops & Financial Damage\r\n\r\nUSAGE:\r\n  claude-flow hook-safety <command> [options]\r\n\r\nCOMMANDS:\r\n  validate      Validate hook configuration for dangerous patterns\r\n  status        Show current hook safety status and context\r\n  reset         Reset circuit breakers and execution counters\r\n  safe-mode     Enable/disable safe mode (skips all hooks)\r\n\r\nVALIDATE OPTIONS:\r\n  --config, -c <path>     Path to Claude Code settings.json\r\n\r\nSAFE-MODE OPTIONS:\r\n  --disable, --off        Disable safe mode\r\n\r\nEXAMPLES:\r\n  # Check your Claude Code hooks for dangerous patterns\r\n  claude-flow hook-safety validate\r\n\r\n  # Check specific configuration file\r\n  claude-flow hook-safety validate --config ~/.claude/settings.json\r\n\r\n  # View current safety status\r\n  claude-flow hook-safety status\r\n\r\n  # Reset if circuit breaker is triggered\r\n  claude-flow hook-safety reset\r\n\r\n  # Enable safe mode (skips all hooks)\r\n  claude-flow hook-safety safe-mode\r\n\r\n  # Disable safe mode\r\n  claude-flow hook-safety safe-mode --disable\r\n\r\nüö® CRITICAL WARNING:\r\nStop hooks that call 'claude' commands create INFINITE LOOPS that can:\r\n‚Ä¢ Bypass API rate limits\r\n‚Ä¢ Cost thousands of dollars per day\r\n‚Ä¢ Make your system unresponsive\r\n\r\nSAFE ALTERNATIVES:\r\n‚Ä¢ Use PostToolUse hooks instead of Stop hooks\r\n‚Ä¢ Implement flag-based update patterns\r\n‚Ä¢ Use 'claude --skip-hooks' for manual updates\r\n‚Ä¢ Create conditional execution scripts\r\n\r\nFor more information: https://github.com/ruvnet/claude-flow/issues/166\r\n`);\r\n}\r\n\r\n/**\r\n * Emergency CLI flags for Claude commands\r\n */\r\nexport function addSafetyFlags(command) {\r\n  // Add safety flags to any claude command\r\n  const context = HookContextManager.getContext();\r\n\r\n  if (context.type) {\r\n    // Automatically add --skip-hooks if in hook context\r\n    if (!command.includes('--skip-hooks')) {\r\n      command += ' --skip-hooks';\r\n    }\r\n  }\r\n\r\n  if (context.safeMode) {\r\n    // Add additional safety flags in safe mode\r\n    if (!command.includes('--dry-run')) {\r\n      command += ' --dry-run';\r\n    }\r\n  }\r\n\r\n  return command;\r\n}\r\n\r\nexport default {\r\n  HookContextManager,\r\n  HookCommandValidator,\r\n  HookCircuitBreaker,\r\n  HookConfigValidator,\r\n  SafeHookExecutor,\r\n  hookSafetyCommand,\r\n  addSafetyFlags,\r\n};\r\n"],"names":["printError","printWarning","printSuccess","existsSync","readFileSync","path","HOOK_SAFETY_CONFIG","MAX_HOOK_DEPTH","MAX_STOP_HOOK_EXECUTIONS","CIRCUIT_BREAKER_TIMEOUT","ENV_VARS","CONTEXT","DEPTH","SESSION_ID","SKIP_HOOKS","SAFE_MODE","HookExecutionTracker","executions","Map","sessionId","generateSessionId","resetTimeout","Date","now","Math","random","toString","substr","track","hookType","key","count","get","set","clearTimeout","setTimeout","clear","getExecutionCount","reset","executionTracker","HookContextManager","setContext","depth","process","env","getContext","type","parseInt","skipHooks","safeMode","clearContext","isInHookContext","setSafeMode","enabled","setSkipHooks","HookCommandValidator","validateCommand","command","context","warnings","errors","isClaudeCommand","push","message","isDangerousPattern","safe","length","claudePatterns","some","pattern","test","dangerousPatterns","HookCircuitBreaker","checkExecution","executionCount","Error","getStatus","Array","from","entries","map","split","HookConfigValidator","validateClaudeCodeConfig","configPath","possiblePaths","join","HOME","cwd","find","p","config","JSON","parse","validation","validateHooksConfig","hooks","err","error","hooksConfig","Stop","hookGroup","hook","result","dangerousHookTypes","generateSafeAlternatives","dangerousConfig","alternatives","includes","problem","solution","example","SafeHookExecutor","executeHookCommand","options","console","log","success","skipped","warning","blocked","currentContext","newDepth","executeCommand","stdout","stderr","exitCode","hookSafetyCommand","subArgs","flags","subcommand","validateConfigCommand","statusCommand","resetCommand","safeModeCommand","showHookSafetyHelp","c","circuitStatus","exec","enable","disable","off","addSafetyFlags"],"mappings":"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"}
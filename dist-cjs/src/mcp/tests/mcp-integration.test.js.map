{"version":3,"sources":["../../../../src/mcp/tests/mcp-integration.test.ts"],"sourcesContent":["import { getErrorMessage } from '../utils/error-handler.js';\r\n/**\r\n * Comprehensive MCP Integration Tests\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, afterEach, jest } from '@jest/globals';\r\ntype Mock = jest.MockedFunction<any>;\r\nimport { MCPServer } from '../server.js';\r\nimport { MCPLifecycleManager, LifecycleState } from '../lifecycle-manager.js';\r\nimport { MCPPerformanceMonitor } from '../performance-monitor.js';\r\nimport { MCPProtocolManager } from '../protocol-manager.js';\r\nimport { MCPOrchestrationIntegration } from '../orchestration-integration.js';\r\nimport { ToolRegistry } from '../tools.js';\r\nimport type { AuthManager } from '../auth.js';\r\nimport type { ILogger } from '../../core/logger.js';\r\nimport type { MCPConfig, MCPInitializeParams, MCPRequest, MCPSession } from '../../utils/types.js';\r\nimport { EventEmitter } from 'node:events';\r\n\r\n// Mock logger\r\nconst mockLogger: ILogger = {\r\n  debug: jest.fn(),\r\n  info: jest.fn(),\r\n  warn: jest.fn(),\r\n  error: jest.fn(),\r\n  configure: jest.fn(),\r\n};\r\n\r\n// Mock event bus\r\nconst mockEventBus = new EventEmitter();\r\n\r\n// Mock config\r\nconst mockMCPConfig: MCPConfig = {\r\n  transport: 'stdio',\r\n  enableMetrics: true,\r\n  auth: {\r\n    enabled: false,\r\n    method: 'token',\r\n  },\r\n};\r\n\r\ndescribe('MCP Server', () => {\r\n  let server: MCPServer;\r\n\r\n  beforeEach(() => {\r\n    server = new MCPServer(mockMCPConfig, mockEventBus, mockLogger);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    if (server) {\r\n      await server.stop();\r\n    }\r\n  });\r\n\r\n  describe('Lifecycle Management', () => {\r\n    it('should start and stop server successfully', async () => {\r\n      await server.start();\r\n      expect(mockLogger.info).toHaveBeenCalledWith('MCP server started successfully');\r\n\r\n      await server.stop();\r\n      expect(mockLogger.info).toHaveBeenCalledWith('MCP server stopped');\r\n    });\r\n\r\n    it('should handle initialization request', async () => {\r\n      await server.start();\r\n\r\n      const initParams: MCPInitializeParams = {\r\n        protocolVersion: { major: 2024, minor: 11, patch: 5 },\r\n        capabilities: {\r\n          tools: { listChanged: true },\r\n        },\r\n        clientInfo: {\r\n          name: 'test-client',\r\n          version: '1.0.0',\r\n        },\r\n      };\r\n\r\n      const request: MCPRequest = {\r\n        jsonrpc: '2.0',\r\n        id: 'test-init',\r\n        method: 'initialize',\r\n        params: initParams,\r\n      };\r\n\r\n      // Mock transport handler\r\n      const transport = (server as any).transport;\r\n      transport.onRequest = jest.fn();\r\n\r\n      const response = await (server as any).handleRequest(request);\r\n\r\n      expect(response.jsonrpc).toBe('2.0');\r\n      expect(response.id).toBe('test-init');\r\n      expect(response.result).toBeDefined();\r\n      expect(response.result.protocolVersion).toEqual({ major: 2024, minor: 11, patch: 5 });\r\n    });\r\n  });\r\n\r\n  describe('Tool Registration', () => {\r\n    beforeEach(async () => {\r\n      await server.start();\r\n    });\r\n\r\n    it('should register tools successfully', () => {\r\n      const tool = {\r\n        name: 'test/tool',\r\n        description: 'Test tool',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            input: { type: 'string' },\r\n          },\r\n        },\r\n        handler: jest.fn().mockResolvedValue('test result'),\r\n      };\r\n\r\n      server.registerTool(tool);\r\n      expect(mockLogger.info).toHaveBeenCalledWith('Tool registered', { name: 'test/tool' });\r\n    });\r\n\r\n    it('should list registered tools', async () => {\r\n      const tool1 = {\r\n        name: 'test/tool1',\r\n        description: 'Test tool 1',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: jest.fn(),\r\n      };\r\n\r\n      const tool2 = {\r\n        name: 'test/tool2',\r\n        description: 'Test tool 2',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: jest.fn(),\r\n      };\r\n\r\n      server.registerTool(tool1);\r\n      server.registerTool(tool2);\r\n\r\n      const tools = (server as any).toolRegistry.listTools();\r\n      expect(tools).toHaveLength(2 + 4); // 2 custom + 4 built-in tools\r\n      expect(tools.some((t: any) => t.name === 'test/tool1')).toBe(true);\r\n      expect(tools.some((t: any) => t.name === 'test/tool2')).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Health Checks', () => {\r\n    beforeEach(async () => {\r\n      await server.start();\r\n    });\r\n\r\n    it('should report healthy status when running', async () => {\r\n      const health = await server.getHealthStatus();\r\n\r\n      expect(health.healthy).toBe(true);\r\n      expect(health.metrics).toBeDefined();\r\n      expect(health.metrics?.registeredTools).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should include metrics in health status', async () => {\r\n      const health = await server.getHealthStatus();\r\n\r\n      expect(health.metrics).toBeDefined();\r\n      expect(typeof health.metrics?.registeredTools).toBe('number');\r\n      expect(typeof health.metrics?.totalRequests).toBe('number');\r\n      expect(typeof health.metrics?.successfulRequests).toBe('number');\r\n      expect(typeof health.metrics?.failedRequests).toBe('number');\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('MCP Lifecycle Manager', () => {\r\n  let lifecycleManager: MCPLifecycleManager;\r\n  let mockServerFactory: Mock;\r\n\r\n  beforeEach(() => {\r\n    mockServerFactory = jest.fn(() => new MCPServer(mockMCPConfig, mockEventBus, mockLogger));\r\n\r\n    lifecycleManager = new MCPLifecycleManager(mockMCPConfig, mockLogger, mockServerFactory);\r\n  });\r\n\r\n  afterEach(async () => {\r\n    if (lifecycleManager) {\r\n      await lifecycleManager.stop();\r\n    }\r\n  });\r\n\r\n  describe('State Management', () => {\r\n    it('should start in stopped state', () => {\r\n      expect(lifecycleManager.getState()).toBe(LifecycleState.STOPPED);\r\n    });\r\n\r\n    it('should transition to running state when started', async () => {\r\n      await lifecycleManager.start();\r\n      expect(lifecycleManager.getState()).toBe(LifecycleState.RUNNING);\r\n    });\r\n\r\n    it('should transition back to stopped when stopped', async () => {\r\n      await lifecycleManager.start();\r\n      await lifecycleManager.stop();\r\n      expect(lifecycleManager.getState()).toBe(LifecycleState.STOPPED);\r\n    });\r\n\r\n    it('should emit state change events', async () => {\r\n      const stateChanges: any[] = [];\r\n      lifecycleManager.on('stateChange', (event) => {\r\n        stateChanges.push(event);\r\n      });\r\n\r\n      await lifecycleManager.start();\r\n      await lifecycleManager.stop();\r\n\r\n      expect(stateChanges).toHaveLength(4); // starting -> running -> stopping -> stopped\r\n      expect(stateChanges[0].state).toBe(LifecycleState.STARTING);\r\n      expect(stateChanges[1].state).toBe(LifecycleState.RUNNING);\r\n      expect(stateChanges[2].state).toBe(LifecycleState.STOPPING);\r\n      expect(stateChanges[3].state).toBe(LifecycleState.STOPPED);\r\n    });\r\n  });\r\n\r\n  describe('Health Monitoring', () => {\r\n    it('should perform health checks when enabled', async () => {\r\n      const config = {\r\n        healthCheckInterval: 100,\r\n        enableHealthChecks: true,\r\n      };\r\n\r\n      lifecycleManager = new MCPLifecycleManager(\r\n        mockMCPConfig,\r\n        mockLogger,\r\n        mockServerFactory,\r\n        config,\r\n      );\r\n\r\n      await lifecycleManager.start();\r\n\r\n      // Wait for health check\r\n      await new Promise((resolve) => setTimeout(resolve, 150));\r\n\r\n      const health = await lifecycleManager.healthCheck();\r\n      expect(health).toBeDefined();\r\n      expect(health.state).toBeDefined();\r\n    });\r\n\r\n    it('should track uptime', async () => {\r\n      await lifecycleManager.start();\r\n\r\n      // Wait a bit\r\n      await new Promise((resolve) => setTimeout(resolve, 50));\r\n\r\n      const uptime = lifecycleManager.getUptime();\r\n      expect(uptime).toBeGreaterThan(0);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('MCP Performance Monitor', () => {\r\n  let performanceMonitor: MCPPerformanceMonitor;\r\n\r\n  beforeEach(() => {\r\n    performanceMonitor = new MCPPerformanceMonitor(mockLogger);\r\n  });\r\n\r\n  afterEach(() => {\r\n    if (performanceMonitor) {\r\n      performanceMonitor.stop();\r\n    }\r\n  });\r\n\r\n  describe('Request Tracking', () => {\r\n    it('should track request metrics', async () => {\r\n      const mockSession: MCPSession = {\r\n        id: 'test-session',\r\n        clientInfo: { name: 'test', version: '1.0' },\r\n        protocolVersion: { major: 2024, minor: 11, patch: 5 },\r\n        capabilities: {},\r\n        isInitialized: true,\r\n        createdAt: new Date(),\r\n        lastActivity: new Date(),\r\n        transport: 'stdio',\r\n        authenticated: false,\r\n      };\r\n\r\n      const mockRequest: MCPRequest = {\r\n        jsonrpc: '2.0',\r\n        id: 'test-request',\r\n        method: 'test/method',\r\n      };\r\n\r\n      const requestId = performanceMonitor.recordRequestStart(mockRequest, mockSession);\r\n      expect(requestId).toBeDefined();\r\n\r\n      // Simulate request completion\r\n      await new Promise((resolve) => setTimeout(resolve, 10));\r\n\r\n      performanceMonitor.recordRequestEnd(requestId, {\r\n        jsonrpc: '2.0',\r\n        id: 'test-request',\r\n        result: 'success',\r\n      });\r\n\r\n      const metrics = performanceMonitor.getCurrentMetrics();\r\n      expect(metrics.requestCount).toBe(1);\r\n      expect(metrics.averageResponseTime).toBeGreaterThan(0);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('MCP Protocol Manager', () => {\r\n  let protocolManager: MCPProtocolManager;\r\n\r\n  beforeEach(() => {\r\n    protocolManager = new MCPProtocolManager(mockLogger);\r\n  });\r\n\r\n  describe('Version Compatibility', () => {\r\n    it('should check version compatibility correctly', () => {\r\n      const clientVersion = { major: 2024, minor: 11, patch: 5 };\r\n      const compatibility = protocolManager.checkCompatibility(clientVersion);\r\n\r\n      expect(compatibility.compatible).toBe(true);\r\n      expect(compatibility.errors).toHaveLength(0);\r\n    });\r\n\r\n    it('should reject incompatible major versions', () => {\r\n      const clientVersion = { major: 2023, minor: 11, patch: 5 };\r\n      const compatibility = protocolManager.checkCompatibility(clientVersion);\r\n\r\n      expect(compatibility.compatible).toBe(false);\r\n      expect(compatibility.errors.length).toBeGreaterThan(0);\r\n    });\r\n  });\r\n\r\n  describe('Protocol Negotiation', () => {\r\n    it('should negotiate protocol successfully', async () => {\r\n      const clientParams: MCPInitializeParams = {\r\n        protocolVersion: { major: 2024, minor: 11, patch: 5 },\r\n        capabilities: {\r\n          tools: { listChanged: true },\r\n          logging: { level: 'info' },\r\n        },\r\n        clientInfo: {\r\n          name: 'test-client',\r\n          version: '1.0.0',\r\n        },\r\n      };\r\n\r\n      const result = await protocolManager.negotiateProtocol(clientParams);\r\n\r\n      expect(result.agreedVersion).toEqual(clientParams.protocolVersion);\r\n      expect(result.agreedCapabilities).toBeDefined();\r\n      expect(result.agreedCapabilities.tools?.listChanged).toBe(true);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('Tool Registry', () => {\r\n  let toolRegistry: ToolRegistry;\r\n\r\n  beforeEach(() => {\r\n    toolRegistry = new ToolRegistry(mockLogger);\r\n  });\r\n\r\n  describe('Tool Management', () => {\r\n    it('should register tools with capabilities', () => {\r\n      const tool = {\r\n        name: 'test/tool',\r\n        description: 'Test tool for registry',\r\n        inputSchema: {\r\n          type: 'object',\r\n          properties: {\r\n            input: { type: 'string' },\r\n          },\r\n        },\r\n        handler: jest.fn().mockResolvedValue('test result'),\r\n      };\r\n\r\n      const capability = {\r\n        name: 'test/tool',\r\n        version: '1.0.0',\r\n        description: 'Test capability',\r\n        category: 'test',\r\n        tags: ['testing', 'demo'],\r\n        supportedProtocolVersions: [{ major: 2024, minor: 11, patch: 5 }],\r\n      };\r\n\r\n      toolRegistry.register(tool, capability);\r\n\r\n      const registeredCapability = toolRegistry.getToolCapability('test/tool');\r\n      expect(registeredCapability).toEqual(capability);\r\n    });\r\n\r\n    it('should discover tools by criteria', () => {\r\n      const tool1 = {\r\n        name: 'file/read',\r\n        description: 'Read files',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: jest.fn(),\r\n      };\r\n\r\n      const tool2 = {\r\n        name: 'memory/query',\r\n        description: 'Query memory',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: jest.fn(),\r\n      };\r\n\r\n      toolRegistry.register(tool1);\r\n      toolRegistry.register(tool2);\r\n\r\n      const fileTools = toolRegistry.discoverTools({ category: 'file' });\r\n      expect(fileTools).toHaveLength(1);\r\n      expect(fileTools[0].tool.name).toBe('file/read');\r\n\r\n      const memoryTools = toolRegistry.discoverTools({ tags: ['memory'] });\r\n      expect(memoryTools).toHaveLength(1);\r\n      expect(memoryTools[0].tool.name).toBe('memory/query');\r\n    });\r\n\r\n    it('should track tool metrics', async () => {\r\n      const tool = {\r\n        name: 'test/metric-tool',\r\n        description: 'Tool for metrics testing',\r\n        inputSchema: { type: 'object', properties: {} },\r\n        handler: jest.fn().mockResolvedValue('success'),\r\n      };\r\n\r\n      toolRegistry.register(tool);\r\n\r\n      // Execute tool multiple times\r\n      await toolRegistry.executeTool('test/metric-tool', {});\r\n      await toolRegistry.executeTool('test/metric-tool', {});\r\n\r\n      const metrics = toolRegistry.getToolMetrics('test/metric-tool');\r\n      expect(Array.isArray(metrics) ? metrics[0].totalInvocations : metrics.totalInvocations).toBe(\r\n        2,\r\n      );\r\n      expect(\r\n        Array.isArray(metrics) ? metrics[0].successfulInvocations : metrics.successfulInvocations,\r\n      ).toBe(2);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('MCP Orchestration Integration', () => {\r\n  let integration: MCPOrchestrationIntegration;\r\n  let mockComponents: any;\r\n\r\n  beforeEach(() => {\r\n    mockComponents = {\r\n      orchestrator: {\r\n        getStatus: jest.fn().mockResolvedValue({ status: 'running' }),\r\n        listTasks: jest.fn().mockResolvedValue([]),\r\n      },\r\n      eventBus: new EventEmitter(),\r\n    };\r\n\r\n    integration = new MCPOrchestrationIntegration(\r\n      mockMCPConfig,\r\n      {\r\n        enabledIntegrations: {\r\n          orchestrator: true,\r\n          swarm: false,\r\n          agents: false,\r\n          resources: false,\r\n          memory: false,\r\n          monitoring: false,\r\n          terminals: false,\r\n        },\r\n        autoStart: false,\r\n        healthCheckInterval: 30000,\r\n        reconnectAttempts: 3,\r\n        reconnectDelay: 5000,\r\n        enableMetrics: true,\r\n        enableAlerts: true,\r\n      },\r\n      mockComponents,\r\n      mockLogger,\r\n    );\r\n  });\r\n\r\n  afterEach(async () => {\r\n    if (integration) {\r\n      await integration.stop();\r\n    }\r\n  });\r\n\r\n  describe('Integration Management', () => {\r\n    it('should start integration successfully', async () => {\r\n      await integration.start();\r\n\r\n      const status = integration.getIntegrationStatus();\r\n      expect(status).toHaveLength(7); // All component types\r\n\r\n      const orchestratorStatus = status.find((s) => s.component === 'orchestrator');\r\n      expect(orchestratorStatus?.enabled).toBe(true);\r\n    });\r\n\r\n    it('should register orchestrator tools when enabled', async () => {\r\n      await integration.start();\r\n\r\n      const server = integration.getServer();\r\n      expect(server).toBeDefined();\r\n\r\n      // Check that orchestrator tools are registered\r\n      const tools = (server as any).toolRegistry.listTools();\r\n      const orchestratorTools = tools.filter((t: any) => t.name.startsWith('orchestrator/'));\r\n      expect(orchestratorTools.length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should handle component connection failures gracefully', async () => {\r\n      // Mock a failing component\r\n      mockComponents.orchestrator.getStatus = jest\r\n        .fn()\r\n        .mockRejectedValue(new Error('Connection failed'));\r\n\r\n      await integration.start();\r\n\r\n      const status = integration.getComponentStatus('orchestrator');\r\n      expect(status).toBeDefined();\r\n      // Connection status can vary in test environment\r\n    });\r\n  });\r\n\r\n  describe('Health Monitoring', () => {\r\n    it('should monitor component health', async () => {\r\n      await integration.start();\r\n\r\n      // Wait for health check\r\n      await new Promise((resolve) => setTimeout(resolve, 100));\r\n\r\n      const status = integration.getIntegrationStatus();\r\n      const enabledComponents = status.filter((s) => s.enabled);\r\n\r\n      for (const component of enabledComponents) {\r\n        expect(component.lastCheck).toBeInstanceOf(Date);\r\n      }\r\n    });\r\n  });\r\n});\r\n"],"names":["describe","it","expect","beforeEach","afterEach","jest","MCPServer","MCPLifecycleManager","LifecycleState","MCPPerformanceMonitor","MCPProtocolManager","MCPOrchestrationIntegration","ToolRegistry","EventEmitter","mockLogger","debug","fn","info","warn","error","configure","mockEventBus","mockMCPConfig","transport","enableMetrics","auth","enabled","method","server","stop","start","toHaveBeenCalledWith","initParams","protocolVersion","major","minor","patch","capabilities","tools","listChanged","clientInfo","name","version","request","jsonrpc","id","params","onRequest","response","handleRequest","toBe","result","toBeDefined","toEqual","tool","description","inputSchema","type","properties","input","handler","mockResolvedValue","registerTool","tool1","tool2","toolRegistry","listTools","toHaveLength","some","t","health","getHealthStatus","healthy","metrics","registeredTools","toBeGreaterThan","totalRequests","successfulRequests","failedRequests","lifecycleManager","mockServerFactory","getState","STOPPED","RUNNING","stateChanges","on","event","push","state","STARTING","STOPPING","config","healthCheckInterval","enableHealthChecks","Promise","resolve","setTimeout","healthCheck","uptime","getUptime","performanceMonitor","mockSession","isInitialized","createdAt","Date","lastActivity","authenticated","mockRequest","requestId","recordRequestStart","recordRequestEnd","getCurrentMetrics","requestCount","averageResponseTime","protocolManager","clientVersion","compatibility","checkCompatibility","compatible","errors","length","clientParams","logging","level","negotiateProtocol","agreedVersion","agreedCapabilities","capability","category","tags","supportedProtocolVersions","register","registeredCapability","getToolCapability","fileTools","discoverTools","memoryTools","executeTool","getToolMetrics","Array","isArray","totalInvocations","successfulInvocations","integration","mockComponents","orchestrator","getStatus","status","listTasks","eventBus","enabledIntegrations","swarm","agents","resources","memory","monitoring","terminals","autoStart","reconnectAttempts","reconnectDelay","enableAlerts","getIntegrationStatus","orchestratorStatus","find","s","component","getServer","orchestratorTools","filter","startsWith","mockRejectedValue","Error","getComponentStatus","enabledComponents","lastCheck","toBeInstanceOf"],"mappings":"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"}
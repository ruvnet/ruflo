{"version":3,"sources":["../../../src/reasoningbank/reasoningbank-adapter.js"],"sourcesContent":["/**\r\n * ReasoningBank Adapter for Claude-Flow (Node.js Backend)\r\n *\r\n * Uses agentic-flow@1.5.13 Node.js backend with SQLite for persistent storage\r\n * Provides semantic search via embeddings and MMR ranking\r\n *\r\n * Backend: SQLite with better-sqlite3\r\n * Features: Persistent storage, semantic search, memory consolidation\r\n */\r\n\r\nimport * as ReasoningBank from 'agentic-flow/reasoningbank';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\n// Backend instance (singleton)\r\nlet backendInitialized = false;\r\nlet initPromise = null;\r\n\r\n// Query result cache (LRU)\r\nconst queryCache = new Map();\r\nconst CACHE_SIZE = 100;\r\nconst CACHE_TTL = 60000; // 60 seconds\r\n\r\n/**\r\n * Initialize ReasoningBank Node.js backend\r\n * @returns {Promise<boolean>}\r\n */\r\nasync function ensureInitialized() {\r\n  if (backendInitialized) {\r\n    return true;\r\n  }\r\n\r\n  if (initPromise) {\r\n    return initPromise;\r\n  }\r\n\r\n  initPromise = (async () => {\r\n    try {\r\n      // Initialize Node.js backend with SQLite database\r\n      await ReasoningBank.initialize();\r\n      backendInitialized = true;\r\n      console.log('[ReasoningBank] Node.js backend initialized successfully');\r\n      return true;\r\n    } catch (error) {\r\n      // Check if this is the better-sqlite3 missing error (npx issue)\r\n      const isSqliteError = error.message?.includes('BetterSqlite3 is not a constructor') ||\r\n                           error.message?.includes('better-sqlite3') ||\r\n                           error.message?.includes('could not run migrations');\r\n      const isNpx = process.env.npm_config_user_agent?.includes('npx') ||\r\n                    process.cwd().includes('_npx');\r\n\r\n      if (isSqliteError && isNpx) {\r\n        // NPX limitation - show helpful message but DON'T throw\r\n        // This allows the command to fall back to JSON mode\r\n        console.error('\\nâš ï¸  NPX LIMITATION DETECTED\\n');\r\n        console.error('ReasoningBank requires better-sqlite3, which is not available in npx temp directories.\\n');\r\n        console.error('ðŸ“š Solutions:\\n');\r\n        console.error('  1. LOCAL INSTALL (Recommended):');\r\n        console.error('     npm install && node_modules/.bin/claude-flow memory store \"key\" \"value\"\\n');\r\n        console.error('  2. USE MCP TOOLS instead:');\r\n        console.error('     mcp__claude-flow__memory_usage({ action: \"store\", key: \"test\", value: \"data\" })\\n');\r\n        console.error('  3. USE JSON FALLBACK (automatic):');\r\n        console.error('     Command will continue with JSON storage...\\n');\r\n        console.error('See: docs/MEMORY_COMMAND_FIX.md for details\\n');\r\n\r\n        // Return false to signal initialization failed but allow fallback\r\n        return false;\r\n      }\r\n\r\n      // Not npx or not SQLite error - log and throw\r\n      console.error('[ReasoningBank] Backend initialization failed:', error);\r\n      throw new Error(`Failed to initialize ReasoningBank: ${error.message}`);\r\n    }\r\n  })();\r\n\r\n  return initPromise;\r\n}\r\n\r\n/**\r\n * Initialize ReasoningBank database (Node.js version)\r\n * Returns true if initialized, false if failed (allows fallback)\r\n */\r\nexport async function initializeReasoningBank() {\r\n  // Initialize the Node.js backend\r\n  const result = await ensureInitialized();\r\n  return result;\r\n}\r\n\r\n/**\r\n * Store a memory in ReasoningBank (Node.js backend with SQLite)\r\n *\r\n * Maps claude-flow memory model to ReasoningBank pattern model:\r\n * - key -> title\r\n * - value -> content (searchable text)\r\n * - namespace -> domain\r\n * - confidence -> confidence score\r\n */\r\nexport async function storeMemory(key, value, options = {}) {\r\n  const initialized = await ensureInitialized();\r\n\r\n  // If initialization failed, throw with clear message\r\n  if (!initialized) {\r\n    throw new Error('ReasoningBank not available (better-sqlite3 missing). Use JSON mode instead.');\r\n  }\r\n\r\n  try {\r\n    const memoryId = options.id || uuidv4();\r\n\r\n    // Map our memory model to ReasoningBank pattern model\r\n    const memory = {\r\n      id: memoryId,\r\n      type: 'reasoning_memory',\r\n      pattern_data: {\r\n        title: key,\r\n        content: value,\r\n        domain: options.namespace || 'default',\r\n        agent: options.agent || 'memory-agent',\r\n        task_type: options.type || 'fact',\r\n        // Store original values for compatibility\r\n        original_key: key,\r\n        original_value: value,\r\n        namespace: options.namespace || 'default'\r\n      },\r\n      confidence: options.confidence || 0.8,\r\n      usage_count: 0\r\n    };\r\n\r\n    // Store memory using Node.js backend\r\n    ReasoningBank.db.upsertMemory(memory);\r\n\r\n    // Generate and store embedding for semantic search\r\n    try {\r\n      const embedding = await ReasoningBank.computeEmbedding(value);\r\n      ReasoningBank.db.upsertEmbedding({\r\n        id: memoryId,\r\n        model: 'text-embedding-3-small', // Default model\r\n        dims: embedding.length,\r\n        vector: embedding\r\n      });\r\n    } catch (embeddingError) {\r\n      console.warn('[ReasoningBank] Failed to generate embedding:', embeddingError.message);\r\n      // Continue without embedding - memory is still stored\r\n    }\r\n\r\n    // Invalidate query cache when new memory is added\r\n    queryCache.clear();\r\n\r\n    return memoryId;\r\n  } catch (error) {\r\n    console.error('[ReasoningBank] storeMemory failed:', error);\r\n    throw new Error(`Failed to store memory: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Query memories from ReasoningBank (Node.js backend with semantic search)\r\n *\r\n * Uses retrieveMemories for semantic search via embeddings and MMR ranking\r\n * Fallback to database query if semantic search fails\r\n */\r\nexport async function queryMemories(searchQuery, options = {}) {\r\n  // Check cache first\r\n  const cached = getCachedQuery(searchQuery, options);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n\r\n  const initialized = await ensureInitialized();\r\n\r\n  // If initialization failed, return empty results\r\n  if (!initialized) {\r\n    return [];\r\n  }\r\n  const limit = options.limit || 10;\r\n  // Accept both 'namespace' and 'domain' for compatibility\r\n  const namespace = options.namespace || options.domain || 'default';\r\n\r\n  try {\r\n    // Try semantic search first using retrieveMemories\r\n    const results = await ReasoningBank.retrieveMemories(searchQuery, {\r\n      domain: namespace,\r\n      agent: options.agent || 'query-agent',\r\n      k: limit,\r\n      minConfidence: options.minConfidence || 0.3\r\n    });\r\n\r\n    // Map backend results to our memory format\r\n    // retrieveMemories returns: { id, title, content, description, score, components }\r\n    const memories = results.map(memory => ({\r\n      id: memory.id,\r\n      key: memory.title || 'unknown',\r\n      value: memory.content || memory.description || '',\r\n      namespace: namespace, // Use the namespace from our query\r\n      confidence: memory.components?.reliability || 0.8,\r\n      usage_count: memory.usage_count || 0,\r\n      created_at: memory.created_at || new Date().toISOString(),\r\n      score: memory.score || 0,\r\n      // Include original pattern for debugging\r\n      _pattern: memory\r\n    }));\r\n\r\n    // If no results, try direct database query as fallback\r\n    if (memories.length === 0) {\r\n      console.warn('[ReasoningBank] Semantic search returned 0 results, trying database fallback');\r\n      const fallbackResults = ReasoningBank.db.fetchMemoryCandidates({\r\n        domain: namespace,\r\n        minConfidence: options.minConfidence || 0.3\r\n      });\r\n\r\n      const fallbackMemories = fallbackResults.slice(0, limit).map(memory => ({\r\n        id: memory.id,\r\n        key: memory.pattern_data?.title || memory.pattern_data?.original_key || 'unknown',\r\n        value: memory.pattern_data?.content || memory.pattern_data?.original_value || '',\r\n        namespace: memory.pattern_data?.domain || memory.pattern_data?.namespace || 'default',\r\n        confidence: memory.confidence || 0.8,\r\n        usage_count: memory.usage_count || 0,\r\n        created_at: memory.created_at || new Date().toISOString()\r\n      }));\r\n\r\n      // Cache and return fallback results\r\n      setCachedQuery(searchQuery, options, fallbackMemories);\r\n      return fallbackMemories;\r\n    }\r\n\r\n    // Cache successful results\r\n    setCachedQuery(searchQuery, options, memories);\r\n    return memories;\r\n  } catch (error) {\r\n    console.warn('[ReasoningBank] Query failed, trying database fallback:', error.message);\r\n\r\n    try {\r\n      // Final fallback: direct database query\r\n      const fallbackResults = ReasoningBank.db.fetchMemoryCandidates({\r\n        domain: namespace,\r\n        minConfidence: options.minConfidence || 0.3\r\n      });\r\n\r\n      const fallbackMemories = fallbackResults.slice(0, limit).map(memory => ({\r\n        id: memory.id,\r\n        key: memory.pattern_data?.title || 'unknown',\r\n        value: memory.pattern_data?.content || '',\r\n        namespace: memory.pattern_data?.domain || 'default',\r\n        confidence: memory.confidence || 0.8,\r\n        usage_count: memory.usage_count || 0,\r\n        created_at: memory.created_at || new Date().toISOString()\r\n      }));\r\n\r\n      setCachedQuery(searchQuery, options, fallbackMemories);\r\n      return fallbackMemories;\r\n    } catch (fallbackError) {\r\n      console.error('[ReasoningBank] All query methods failed:', fallbackError);\r\n      return [];\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * List all memories (using Node.js backend database query)\r\n */\r\nexport async function listMemories(options = {}) {\r\n  const initialized = await ensureInitialized();\r\n\r\n  // If initialization failed, return empty list\r\n  if (!initialized) {\r\n    return [];\r\n  }\r\n  const limit = options.limit || 10;\r\n  const namespace = options.namespace;\r\n\r\n  try {\r\n    let memories;\r\n\r\n    if (namespace && namespace !== 'default') {\r\n      // Filter by namespace/domain\r\n      const allMemories = ReasoningBank.db.getAllActiveMemories();\r\n      memories = allMemories\r\n        .filter(m => m.pattern_data?.domain === namespace)\r\n        .slice(0, limit);\r\n    } else {\r\n      // Get all active memories\r\n      memories = ReasoningBank.db.getAllActiveMemories().slice(0, limit);\r\n    }\r\n\r\n    return memories.map(memory => ({\r\n      id: memory.id,\r\n      key: memory.pattern_data?.title || memory.pattern_data?.original_key || 'unknown',\r\n      value: memory.pattern_data?.content || memory.pattern_data?.original_value || '',\r\n      namespace: memory.pattern_data?.domain || memory.pattern_data?.namespace || 'default',\r\n      confidence: memory.confidence || 0.8,\r\n      usage_count: memory.usage_count || 0,\r\n      created_at: memory.created_at || new Date().toISOString()\r\n    }));\r\n  } catch (error) {\r\n    console.error('[ReasoningBank] listMemories failed:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Get ReasoningBank statistics (Node.js backend)\r\n */\r\nexport async function getStatus() {\r\n  const initialized = await ensureInitialized();\r\n\r\n  // If initialization failed, return error status\r\n  if (!initialized) {\r\n    return {\r\n      total_memories: 0,\r\n      total_categories: 0,\r\n      storage_backend: 'Unavailable',\r\n      error: 'ReasoningBank initialization failed (better-sqlite3 not available)',\r\n      fallback_available: true\r\n    };\r\n  }\r\n\r\n  try {\r\n    const db = ReasoningBank.db.getDb();\r\n\r\n    // Count patterns\r\n    const patterns = db.prepare(\"SELECT COUNT(*) as count FROM patterns WHERE type = 'reasoning_memory'\").get();\r\n    const embeddings = db.prepare(\"SELECT COUNT(*) as count FROM pattern_embeddings\").get();\r\n    const trajectories = db.prepare(\"SELECT COUNT(*) as count FROM task_trajectories\").get();\r\n    const links = db.prepare(\"SELECT COUNT(*) as count FROM pattern_links\").get();\r\n\r\n    // Get average confidence\r\n    const avgConf = db.prepare(\"SELECT AVG(confidence) as avg FROM patterns WHERE type = 'reasoning_memory'\").get();\r\n\r\n    // Count unique domains\r\n    const domains = db.prepare(\"SELECT COUNT(DISTINCT json_extract(pattern_data, '$.domain')) as count FROM patterns WHERE type = 'reasoning_memory'\").get();\r\n\r\n    return {\r\n      total_memories: patterns.count || 0,\r\n      total_categories: domains.count || 0,\r\n      storage_backend: 'SQLite (Node.js)',\r\n      database_path: process.env.CLAUDE_FLOW_DB_PATH || '.swarm/memory.db',\r\n      performance: 'SQLite with persistent storage',\r\n      avg_confidence: avgConf.avg || 0.8,\r\n      total_embeddings: embeddings.count || 0,\r\n      total_trajectories: trajectories.count || 0,\r\n      total_links: links.count || 0\r\n    };\r\n  } catch (error) {\r\n    console.error('[ReasoningBank] getStatus failed:', error);\r\n    return {\r\n      total_memories: 0,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Check which ReasoningBank tables are present (Node.js backend)\r\n */\r\nexport async function checkReasoningBankTables() {\r\n  try {\r\n    await ensureInitialized();\r\n    const db = ReasoningBank.db.getDb();\r\n\r\n    const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'pattern%'\").all();\r\n    const tableNames = tables.map(t => t.name);\r\n\r\n    const requiredTables = ['patterns', 'pattern_embeddings', 'pattern_links', 'task_trajectories'];\r\n    const missingTables = requiredTables.filter(t => !tableNames.includes(t));\r\n\r\n    return {\r\n      exists: true,\r\n      existingTables: tableNames,\r\n      missingTables: missingTables,\r\n      requiredTables: requiredTables,\r\n      backend: 'SQLite (Node.js)',\r\n      note: missingTables.length > 0 ? 'Some tables are missing - run migrations' : 'All tables present'\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      exists: false,\r\n      existingTables: [],\r\n      missingTables: [],\r\n      requiredTables: [],\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Migrate existing database (Node.js backend - run migrations)\r\n */\r\nexport async function migrateReasoningBank() {\r\n  try {\r\n    await ReasoningBank.db.runMigrations();\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Database migrations completed successfully',\r\n      migrated: true,\r\n      database_path: process.env.CLAUDE_FLOW_DB_PATH || '.swarm/memory.db'\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      message: `Migration failed: ${error.message}`,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Get cached query results\r\n */\r\nfunction getCachedQuery(searchQuery, options) {\r\n  const cacheKey = JSON.stringify({ searchQuery, options });\r\n  const cached = queryCache.get(cacheKey);\r\n\r\n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\r\n    return cached.results;\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Set cached query results (LRU eviction)\r\n */\r\nfunction setCachedQuery(searchQuery, options, results) {\r\n  const cacheKey = JSON.stringify({ searchQuery, options });\r\n\r\n  // LRU eviction\r\n  if (queryCache.size >= CACHE_SIZE) {\r\n    const firstKey = queryCache.keys().next().value;\r\n    queryCache.delete(firstKey);\r\n  }\r\n\r\n  queryCache.set(cacheKey, {\r\n    results,\r\n    timestamp: Date.now()\r\n  });\r\n}\r\n\r\n/**\r\n * Close database connection and cleanup resources\r\n * Should be called when done with ReasoningBank operations\r\n */\r\nexport function cleanup() {\r\n  try {\r\n    if (backendInitialized) {\r\n      // Clear embedding cache (prevents memory leaks)\r\n      ReasoningBank.clearEmbeddingCache();\r\n\r\n      // Close database connection\r\n      ReasoningBank.db.closeDb();\r\n      backendInitialized = false;\r\n      initPromise = null;\r\n      console.log('[ReasoningBank] Database connection closed');\r\n    }\r\n  } catch (error) {\r\n    console.error('[ReasoningBank] Cleanup failed:', error.message);\r\n  }\r\n}\r\n"],"names":["ReasoningBank","v4","uuidv4","backendInitialized","initPromise","queryCache","Map","CACHE_SIZE","CACHE_TTL","ensureInitialized","initialize","console","log","error","isSqliteError","message","includes","isNpx","process","env","npm_config_user_agent","cwd","Error","initializeReasoningBank","result","storeMemory","key","value","options","initialized","memoryId","id","memory","type","pattern_data","title","content","domain","namespace","agent","task_type","original_key","original_value","confidence","usage_count","db","upsertMemory","embedding","computeEmbedding","upsertEmbedding","model","dims","length","vector","embeddingError","warn","clear","queryMemories","searchQuery","cached","getCachedQuery","limit","results","retrieveMemories","k","minConfidence","memories","map","description","components","reliability","created_at","Date","toISOString","score","_pattern","fallbackResults","fetchMemoryCandidates","fallbackMemories","slice","setCachedQuery","fallbackError","listMemories","allMemories","getAllActiveMemories","filter","m","getStatus","total_memories","total_categories","storage_backend","fallback_available","getDb","patterns","prepare","get","embeddings","trajectories","links","avgConf","domains","count","database_path","CLAUDE_FLOW_DB_PATH","performance","avg_confidence","avg","total_embeddings","total_trajectories","total_links","checkReasoningBankTables","tables","all","tableNames","t","name","requiredTables","missingTables","exists","existingTables","backend","note","migrateReasoningBank","runMigrations","success","migrated","cacheKey","JSON","stringify","now","timestamp","size","firstKey","keys","next","delete","set","cleanup","clearEmbeddingCache","closeDb"],"mappings":"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"}
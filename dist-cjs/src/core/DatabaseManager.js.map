{"version":3,"sources":["../../../src/core/DatabaseManager.ts"],"sourcesContent":["/**\r\n * DatabaseManager - Manages SQLite and JSON fallback storage\r\n * Provides a unified interface for persistent data storage with automatic fallback\r\n */\r\n\r\nimport * as fs from 'fs-extra';\r\nimport * as path from 'path';\r\nimport { IDatabaseProvider } from '../types/interfaces.js';\r\n\r\nexport class DatabaseManager implements IDatabaseProvider {\r\n  private provider: IDatabaseProvider;\r\n  private dbType: 'sqlite' | 'json';\r\n  private dbPath: string;\r\n  private initialized: boolean = false;\r\n  private retryCount: number = 0;\r\n  private maxRetries: number = 3;\r\n\r\n  constructor(dbType: 'sqlite' | 'json' = 'sqlite', dbPath?: string) {\r\n    this.dbType = dbType;\r\n    this.dbPath = dbPath || this.getDefaultPath();\r\n\r\n    // Try SQLite first, fallback to JSON if needed\r\n    if (this.dbType === 'sqlite') {\r\n      this.provider = this.initializeSQLiteWithRecovery();\r\n    } else {\r\n      this.provider = new JSONProvider(this.dbPath);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize SQLite with automatic error recovery\r\n   */\r\n  private initializeSQLiteWithRecovery(): IDatabaseProvider {\r\n    try {\r\n      return new SQLiteProvider(this.dbPath);\r\n    } catch (error) {\r\n      const errorMsg = error instanceof Error ? error.message : String(error);\r\n\r\n      // Check if it's an npm cache error\r\n      if (errorMsg.includes('ENOTEMPTY') || errorMsg.includes('better-sqlite3')) {\r\n        console.warn('‚ö†Ô∏è  SQLite initialization failed due to npm cache error');\r\n        console.warn('   Will attempt automatic recovery during initialize()');\r\n      } else {\r\n        console.warn('SQLite not available, falling back to JSON storage:', error);\r\n      }\r\n\r\n      // Fallback to JSON for now\r\n      this.provider = new JSONProvider(this.dbPath.replace('.sqlite', '.json'));\r\n      this.dbType = 'json';\r\n      return this.provider;\r\n    }\r\n  }\r\n\r\n  private getDefaultPath(): string {\r\n    const baseDir = path.join(process.cwd(), '.claude-flow');\r\n    return this.dbType === 'sqlite'\r\n      ? path.join(baseDir, 'database.sqlite')\r\n      : path.join(baseDir, 'database.json');\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    await fs.ensureDir(path.dirname(this.dbPath));\r\n\r\n    try {\r\n      await this.provider.initialize();\r\n      this.initialized = true;\r\n    } catch (error) {\r\n      // If JSON provider failed, just propagate the error\r\n      if (this.dbType === 'json') {\r\n        throw error;\r\n      }\r\n\r\n      // For SQLite errors, attempt recovery\r\n      const errorMsg = error instanceof Error ? error.message : String(error);\r\n      if (this.retryCount < this.maxRetries) {\r\n        console.warn(`‚ö†Ô∏è  Database initialization failed (attempt ${this.retryCount + 1}/${this.maxRetries})`);\r\n        console.warn(`   Error: ${errorMsg}`);\r\n\r\n        // Attempt to recover by switching to JSON\r\n        console.log('üîÑ Switching to JSON storage as fallback...');\r\n        this.provider = new JSONProvider(this.dbPath.replace('.sqlite', '.json'));\r\n        this.dbType = 'json';\r\n        this.retryCount++;\r\n\r\n        // Retry initialization with JSON provider\r\n        await this.initialize();\r\n      } else {\r\n        throw error;\r\n      }\r\n    }\r\n  }\r\n\r\n  async store(key: string, value: any, namespace: string = 'default'): Promise<void> {\r\n    if (!this.initialized) {\r\n      await this.initialize();\r\n    }\r\n    return this.provider.store(key, value, namespace);\r\n  }\r\n\r\n  async retrieve(key: string, namespace: string = 'default'): Promise<any> {\r\n    if (!this.initialized) {\r\n      await this.initialize();\r\n    }\r\n    return this.provider.retrieve(key, namespace);\r\n  }\r\n\r\n  async delete(key: string, namespace: string = 'default'): Promise<boolean> {\r\n    if (!this.initialized) {\r\n      await this.initialize();\r\n    }\r\n    return this.provider.delete(key, namespace);\r\n  }\r\n\r\n  async list(namespace: string = 'default'): Promise<string[]> {\r\n    if (!this.initialized) {\r\n      await this.initialize();\r\n    }\r\n    return this.provider.list(namespace);\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    if (this.provider) {\r\n      await this.provider.close();\r\n    }\r\n    this.initialized = false;\r\n  }\r\n\r\n  getDatabaseType(): 'sqlite' | 'json' {\r\n    return this.dbType;\r\n  }\r\n\r\n  getDatabasePath(): string {\r\n    return this.dbPath;\r\n  }\r\n\r\n  isInitialized(): boolean {\r\n    return this.initialized;\r\n  }\r\n\r\n  // Specialized methods for common operations\r\n  async storeJSON(key: string, data: object, namespace?: string): Promise<void> {\r\n    await this.store(key, JSON.stringify(data), namespace);\r\n  }\r\n\r\n  async retrieveJSON(key: string, namespace?: string): Promise<object | null> {\r\n    const data = await this.retrieve(key, namespace);\r\n    if (!data) return null;\r\n    try {\r\n      return typeof data === 'string' ? JSON.parse(data) : data;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async exists(key: string, namespace?: string): Promise<boolean> {\r\n    const data = await this.retrieve(key, namespace);\r\n    return data !== null && data !== undefined;\r\n  }\r\n\r\n  async clear(namespace?: string): Promise<void> {\r\n    const keys = await this.list(namespace);\r\n    await Promise.all(keys.map(key => this.delete(key, namespace)));\r\n  }\r\n}\r\n\r\n/**\r\n * SQLite implementation\r\n */\r\nclass SQLiteProvider implements IDatabaseProvider {\r\n  private db: any;\r\n  private dbPath: string;\r\n\r\n  constructor(dbPath: string) {\r\n    this.dbPath = dbPath;\r\n    // Dynamic import to handle optional dependency\r\n    try {\r\n      const Database = require('better-sqlite3');\r\n      this.db = new Database(dbPath);\r\n    } catch (error) {\r\n      throw new Error('better-sqlite3 not available. Install with: npm install better-sqlite3');\r\n    }\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    // Create tables\r\n    this.db.exec(`\r\n      CREATE TABLE IF NOT EXISTS storage (\r\n        namespace TEXT NOT NULL,\r\n        key TEXT NOT NULL,\r\n        value TEXT NOT NULL,\r\n        created_at INTEGER DEFAULT (strftime('%s', 'now')),\r\n        updated_at INTEGER DEFAULT (strftime('%s', 'now')),\r\n        PRIMARY KEY (namespace, key)\r\n      )\r\n    `);\r\n\r\n    this.db.exec(`\r\n      CREATE INDEX IF NOT EXISTS idx_storage_namespace ON storage(namespace);\r\n      CREATE INDEX IF NOT EXISTS idx_storage_created_at ON storage(created_at);\r\n    `);\r\n  }\r\n\r\n  async store(key: string, value: any, namespace: string = 'default'): Promise<void> {\r\n    const stmt = this.db.prepare(`\r\n      INSERT OR REPLACE INTO storage (namespace, key, value, updated_at)\r\n      VALUES (?, ?, ?, strftime('%s', 'now'))\r\n    `);\r\n\r\n    const serializedValue = typeof value === 'string' ? value : JSON.stringify(value);\r\n    stmt.run(namespace, key, serializedValue);\r\n  }\r\n\r\n  async retrieve(key: string, namespace: string = 'default'): Promise<any> {\r\n    const stmt = this.db.prepare('SELECT value FROM storage WHERE namespace = ? AND key = ?');\r\n    const row = stmt.get(namespace, key);\r\n\r\n    if (!row) return null;\r\n\r\n    try {\r\n      return JSON.parse(row.value);\r\n    } catch {\r\n      return row.value;\r\n    }\r\n  }\r\n\r\n  async delete(key: string, namespace: string = 'default'): Promise<boolean> {\r\n    const stmt = this.db.prepare('DELETE FROM storage WHERE namespace = ? AND key = ?');\r\n    const result = stmt.run(namespace, key);\r\n    return result.changes > 0;\r\n  }\r\n\r\n  async list(namespace: string = 'default'): Promise<string[]> {\r\n    const stmt = this.db.prepare('SELECT key FROM storage WHERE namespace = ? ORDER BY key');\r\n    const rows = stmt.all(namespace);\r\n    return rows.map((row: any) => row.key);\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    if (this.db) {\r\n      this.db.close();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * JSON file-based implementation\r\n */\r\nclass JSONProvider implements IDatabaseProvider {\r\n  private data: Record<string, Record<string, any>> = {};\r\n  private dbPath: string;\r\n\r\n  constructor(dbPath: string) {\r\n    this.dbPath = dbPath;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    try {\r\n      if (await fs.pathExists(this.dbPath)) {\r\n        const content = await fs.readJSON(this.dbPath);\r\n        this.data = content || {};\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to load JSON database, starting fresh:', error);\r\n      this.data = {};\r\n    }\r\n  }\r\n\r\n  async store(key: string, value: any, namespace: string = 'default'): Promise<void> {\r\n    if (!this.data[namespace]) {\r\n      this.data[namespace] = {};\r\n    }\r\n\r\n    this.data[namespace][key] = value;\r\n    await this.persist();\r\n  }\r\n\r\n  async retrieve(key: string, namespace: string = 'default'): Promise<any> {\r\n    if (!this.data[namespace]) {\r\n      return null;\r\n    }\r\n    return this.data[namespace][key] || null;\r\n  }\r\n\r\n  async delete(key: string, namespace: string = 'default'): Promise<boolean> {\r\n    if (!this.data[namespace] || !(key in this.data[namespace])) {\r\n      return false;\r\n    }\r\n\r\n    delete this.data[namespace][key];\r\n    await this.persist();\r\n    return true;\r\n  }\r\n\r\n  async list(namespace: string = 'default'): Promise<string[]> {\r\n    if (!this.data[namespace]) {\r\n      return [];\r\n    }\r\n    return Object.keys(this.data[namespace]).sort();\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    await this.persist();\r\n  }\r\n\r\n  private async persist(): Promise<void> {\r\n    try {\r\n      await fs.ensureDir(path.dirname(this.dbPath));\r\n      await fs.writeJSON(this.dbPath, this.data, { spaces: 2 });\r\n    } catch (error) {\r\n      console.error('Failed to persist JSON database:', error);\r\n    }\r\n  }\r\n}"],"names":["fs","path","DatabaseManager","provider","dbType","dbPath","initialized","retryCount","maxRetries","getDefaultPath","initializeSQLiteWithRecovery","JSONProvider","SQLiteProvider","error","errorMsg","Error","message","String","includes","console","warn","replace","baseDir","join","process","cwd","initialize","ensureDir","dirname","log","store","key","value","namespace","retrieve","delete","list","close","getDatabaseType","getDatabasePath","isInitialized","storeJSON","data","JSON","stringify","retrieveJSON","parse","exists","undefined","clear","keys","Promise","all","map","db","Database","require","exec","stmt","prepare","serializedValue","run","row","get","result","changes","rows","pathExists","content","readJSON","persist","Object","sort","writeJSON","spaces"],"mappings":"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"}
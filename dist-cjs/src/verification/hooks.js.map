{"version":3,"sources":["../../../src/verification/hooks.ts"],"sourcesContent":["/**\r\n * Verification Hooks Module\r\n * \r\n * Comprehensive verification and validation system for claude-flow operations.\r\n * Provides pre-task verification, post-task validation, integration testing,\r\n * truth telemetry, and rollback capabilities.\r\n */\r\n\r\nimport { Logger } from '../core/logger.js';\r\nimport { agenticHookManager } from '../services/agentic-flow-hooks/index.js';\r\nimport type {\r\n  AgenticHookContext,\r\n  HookHandlerResult,\r\n  HookRegistration,\r\n  WorkflowHookPayload,\r\n  PerformanceHookPayload,\r\n  MemoryHookPayload,\r\n} from '../services/agentic-flow-hooks/types.js';\r\n\r\nconst logger = new Logger({\r\n  level: 'info',\r\n  format: 'text',\r\n  destination: 'console'\r\n}, { prefix: 'VerificationHooks' });\r\n\r\n// ===== Types & Interfaces =====\r\n\r\nexport interface VerificationConfig {\r\n  preTask: {\r\n    enabled: boolean;\r\n    checkers: PreTaskChecker[];\r\n    failureStrategy: 'abort' | 'warn' | 'continue';\r\n  };\r\n  postTask: {\r\n    enabled: boolean;\r\n    validators: PostTaskValidator[];\r\n    accuracyThreshold: number;\r\n  };\r\n  integration: {\r\n    enabled: boolean;\r\n    testSuites: IntegrationTestSuite[];\r\n    parallel: boolean;\r\n  };\r\n  telemetry: {\r\n    enabled: boolean;\r\n    truthValidators: TruthValidator[];\r\n    reportingInterval: number;\r\n  };\r\n  rollback: {\r\n    enabled: boolean;\r\n    triggers: RollbackTrigger[];\r\n    snapshotStrategy: 'automatic' | 'manual' | 'selective';\r\n  };\r\n}\r\n\r\nexport interface PreTaskChecker {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  priority: number;\r\n  check: (context: VerificationContext) => Promise<VerificationResult>;\r\n}\r\n\r\nexport interface PostTaskValidator {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  priority: number;\r\n  validate: (context: VerificationContext, result: any) => Promise<ValidationResult>;\r\n}\r\n\r\nexport interface IntegrationTestSuite {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  tests: IntegrationTest[];\r\n  requirements: string[];\r\n}\r\n\r\nexport interface IntegrationTest {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  execute: (context: VerificationContext) => Promise<TestResult>;\r\n  cleanup?: (context: VerificationContext) => Promise<void>;\r\n}\r\n\r\nexport interface TruthValidator {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  validate: (data: any, expected: any) => Promise<TruthResult>;\r\n}\r\n\r\nexport interface RollbackTrigger {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  condition: (context: VerificationContext, error?: Error) => boolean;\r\n  action: RollbackAction;\r\n}\r\n\r\nexport interface VerificationContext {\r\n  taskId: string;\r\n  sessionId: string;\r\n  timestamp: number;\r\n  metadata: Record<string, any>;\r\n  state: VerificationState;\r\n  snapshots: StateSnapshot[];\r\n  metrics: VerificationMetrics;\r\n}\r\n\r\nexport interface VerificationState {\r\n  phase: 'pre-task' | 'execution' | 'post-task' | 'validation' | 'complete' | 'failed';\r\n  checksPassed: string[];\r\n  checksFailed: string[];\r\n  validationResults: ValidationResult[];\r\n  testResults: TestResult[];\r\n  truthResults: TruthResult[];\r\n  errors: VerificationError[];\r\n}\r\n\r\nexport interface StateSnapshot {\r\n  id: string;\r\n  timestamp: number;\r\n  phase: string;\r\n  state: any;\r\n  metadata: Record<string, any>;\r\n}\r\n\r\nexport interface VerificationMetrics {\r\n  totalChecks: number;\r\n  passedChecks: number;\r\n  failedChecks: number;\r\n  executionTime: number;\r\n  accuracyScore: number;\r\n  confidenceScore: number;\r\n}\r\n\r\nexport interface VerificationResult {\r\n  passed: boolean;\r\n  score: number;\r\n  message: string;\r\n  details?: any;\r\n  recommendations?: string[];\r\n}\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean;\r\n  accuracy: number;\r\n  confidence: number;\r\n  message: string;\r\n  details?: any;\r\n  evidence?: any[];\r\n}\r\n\r\nexport interface TestResult {\r\n  passed: boolean;\r\n  duration: number;\r\n  message: string;\r\n  details?: any;\r\n  logs?: string[];\r\n}\r\n\r\nexport interface TruthResult {\r\n  truthful: boolean;\r\n  accuracy: number;\r\n  confidence: number;\r\n  discrepancies: string[];\r\n  evidence: any[];\r\n}\r\n\r\nexport interface VerificationError {\r\n  type: 'check' | 'validation' | 'test' | 'truth' | 'system';\r\n  phase: string;\r\n  message: string;\r\n  details?: any;\r\n  recoverable: boolean;\r\n}\r\n\r\nexport type RollbackAction = \r\n  | 'restore-snapshot' \r\n  | 'revert-changes' \r\n  | 'reset-state' \r\n  | 'abort-task'\r\n  | 'retry-with-fallback';\r\n\r\n// ===== Default Configuration =====\r\n\r\nexport const DEFAULT_VERIFICATION_CONFIG: VerificationConfig = {\r\n  preTask: {\r\n    enabled: true,\r\n    checkers: [],\r\n    failureStrategy: 'abort',\r\n  },\r\n  postTask: {\r\n    enabled: true,\r\n    validators: [],\r\n    accuracyThreshold: 0.8,\r\n  },\r\n  integration: {\r\n    enabled: true,\r\n    testSuites: [],\r\n    parallel: true,\r\n  },\r\n  telemetry: {\r\n    enabled: true,\r\n    truthValidators: [],\r\n    reportingInterval: 30000, // 30 seconds\r\n  },\r\n  rollback: {\r\n    enabled: true,\r\n    triggers: [],\r\n    snapshotStrategy: 'automatic',\r\n  },\r\n};\r\n\r\n// ===== Verification Hook Manager =====\r\n\r\nexport class VerificationHookManager {\r\n  private config: VerificationConfig;\r\n  private contexts: Map<string, VerificationContext> = new Map();\r\n  private snapshots: Map<string, StateSnapshot[]> = new Map();\r\n\r\n  constructor(config: Partial<VerificationConfig> = {}) {\r\n    this.config = { ...DEFAULT_VERIFICATION_CONFIG, ...config };\r\n    this.registerHooks();\r\n    this.startTelemetryReporting();\r\n  }\r\n\r\n  /**\r\n   * Register all verification hooks with the agentic hook manager\r\n   */\r\n  private registerHooks(): void {\r\n    // Pre-task verification hook\r\n    this.registerPreTaskHook();\r\n    \r\n    // Post-task validation hook\r\n    this.registerPostTaskHook();\r\n    \r\n    // Integration test hook\r\n    this.registerIntegrationTestHook();\r\n    \r\n    // Truth telemetry hook\r\n    this.registerTruthTelemetryHook();\r\n    \r\n    // Rollback trigger hook\r\n    this.registerRollbackTriggerHook();\r\n\r\n    logger.info('Verification hooks registered successfully');\r\n  }\r\n\r\n  // ===== 1. Pre-Task Verification Hook =====\r\n\r\n  private registerPreTaskHook(): void {\r\n    const preTaskHook: HookRegistration = {\r\n      id: 'verification-pre-task',\r\n      type: 'workflow-start',\r\n      priority: 100, // High priority to run early\r\n      handler: async (payload: WorkflowHookPayload, context: AgenticHookContext): Promise<HookHandlerResult> => {\r\n        if (!this.config.preTask.enabled) {\r\n          return { continue: true };\r\n        }\r\n\r\n        const verificationContext = this.createVerificationContext(payload, context);\r\n        \r\n        try {\r\n          await this.executePreTaskChecks(verificationContext);\r\n          \r\n          const state = verificationContext.state;\r\n          if (state.checksFailed.length > 0) {\r\n            const strategy = this.config.preTask.failureStrategy;\r\n            \r\n            if (strategy === 'abort') {\r\n              return {\r\n                continue: false,\r\n                metadata: {\r\n                  verificationFailed: true,\r\n                  failedChecks: state.checksFailed,\r\n                  error: 'Pre-task verification failed'\r\n                }\r\n              };\r\n            } else if (strategy === 'warn') {\r\n              logger.warn('Pre-task verification warnings:', state.checksFailed);\r\n            }\r\n          }\r\n\r\n          // Create initial snapshot\r\n          await this.createSnapshot(verificationContext, 'pre-task-complete');\r\n\r\n          return {\r\n            continue: true,\r\n            modified: true,\r\n            payload: {\r\n              ...payload,\r\n              verificationContext: verificationContext.taskId\r\n            },\r\n            metadata: {\r\n              verificationPassed: true,\r\n              checksExecuted: state.checksPassed.length,\r\n              warnings: state.checksFailed.length\r\n            }\r\n          };\r\n        } catch (error) {\r\n          logger.error('Pre-task verification error:', error);\r\n          \r\n          return {\r\n            continue: this.config.preTask.failureStrategy !== 'abort',\r\n            metadata: {\r\n              verificationError: true,\r\n              error: (error as Error).message\r\n            }\r\n          };\r\n        }\r\n      },\r\n      options: {\r\n        timeout: 30000, // 30 second timeout\r\n        async: false,\r\n      }\r\n    };\r\n\r\n    agenticHookManager.register(preTaskHook);\r\n  }\r\n\r\n  private async executePreTaskChecks(context: VerificationContext): Promise<void> {\r\n    const checkers = this.config.preTask.checkers.sort((a, b) => b.priority - a.priority);\r\n    \r\n    for (const checker of checkers) {\r\n      try {\r\n        const result = await checker.check(context);\r\n        \r\n        if (result.passed) {\r\n          context.state.checksPassed.push(checker.id);\r\n        } else {\r\n          context.state.checksFailed.push(checker.id);\r\n          context.state.errors.push({\r\n            type: 'check',\r\n            phase: 'pre-task',\r\n            message: result.message,\r\n            details: result.details,\r\n            recoverable: true\r\n          });\r\n        }\r\n\r\n        // Update metrics\r\n        context.metrics.totalChecks++;\r\n        if (result.passed) {\r\n          context.metrics.passedChecks++;\r\n        } else {\r\n          context.metrics.failedChecks++;\r\n        }\r\n      } catch (error) {\r\n        logger.error(`Pre-task checker '${checker.id}' failed:`, error);\r\n        context.state.checksFailed.push(checker.id);\r\n        context.state.errors.push({\r\n          type: 'check',\r\n          phase: 'pre-task',\r\n          message: `Checker '${checker.id}' threw an error: ${(error as Error).message}`,\r\n          details: error,\r\n          recoverable: false\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  // ===== 2. Post-Task Validation Hook =====\r\n\r\n  private registerPostTaskHook(): void {\r\n    const postTaskHook: HookRegistration = {\r\n      id: 'verification-post-task',\r\n      type: 'workflow-complete',\r\n      priority: 90,\r\n      handler: async (payload: WorkflowHookPayload, context: AgenticHookContext): Promise<HookHandlerResult> => {\r\n        if (!this.config.postTask.enabled) {\r\n          return { continue: true };\r\n        }\r\n\r\n        const verificationContext = this.getVerificationContext(payload.workflowId) || \r\n                                   this.createVerificationContext(payload, context);\r\n        \r\n        try {\r\n          await this.executePostTaskValidation(verificationContext, payload);\r\n          \r\n          const accuracy = this.calculateAccuracy(verificationContext);\r\n          const meetsThreshold = accuracy >= this.config.postTask.accuracyThreshold;\r\n\r\n          // Create completion snapshot\r\n          await this.createSnapshot(verificationContext, 'post-task-complete');\r\n\r\n          return {\r\n            continue: true,\r\n            modified: true,\r\n            payload: {\r\n              ...payload,\r\n              validationResults: verificationContext.state.validationResults,\r\n              accuracy,\r\n              meetsThreshold\r\n            },\r\n            metadata: {\r\n              validationComplete: true,\r\n              accuracy,\r\n              meetsThreshold,\r\n              validationCount: verificationContext.state.validationResults.length\r\n            },\r\n            sideEffects: [{\r\n              type: 'metric',\r\n              action: 'update',\r\n              data: {\r\n                name: 'verification.accuracy',\r\n                value: accuracy\r\n              }\r\n            }]\r\n          };\r\n        } catch (error) {\r\n          logger.error('Post-task validation error:', error);\r\n          \r\n          return {\r\n            continue: true,\r\n            metadata: {\r\n              validationError: true,\r\n              error: (error as Error).message\r\n            }\r\n          };\r\n        }\r\n      },\r\n      options: {\r\n        timeout: 60000, // 60 second timeout\r\n        async: true,\r\n      }\r\n    };\r\n\r\n    agenticHookManager.register(postTaskHook);\r\n  }\r\n\r\n  private async executePostTaskValidation(\r\n    context: VerificationContext, \r\n    payload: WorkflowHookPayload\r\n  ): Promise<void> {\r\n    const validators = this.config.postTask.validators.sort((a, b) => b.priority - a.priority);\r\n    \r\n    for (const validator of validators) {\r\n      try {\r\n        const result = await validator.validate(context, payload.state);\r\n        context.state.validationResults.push(result);\r\n        \r\n        // Update metrics\r\n        if (result.valid) {\r\n          context.metrics.accuracyScore += result.accuracy;\r\n          context.metrics.confidenceScore += result.confidence;\r\n        }\r\n      } catch (error) {\r\n        logger.error(`Post-task validator '${validator.id}' failed:`, error);\r\n        context.state.errors.push({\r\n          type: 'validation',\r\n          phase: 'post-task',\r\n          message: `Validator '${validator.id}' threw an error: ${(error as Error).message}`,\r\n          details: error,\r\n          recoverable: false\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  // ===== 3. Integration Test Hook =====\r\n\r\n  private registerIntegrationTestHook(): void {\r\n    const integrationTestHook: HookRegistration = {\r\n      id: 'verification-integration-test',\r\n      type: 'workflow-step',\r\n      priority: 80,\r\n      filter: {\r\n        patterns: [/integration.*test/i, /test.*integration/i]\r\n      },\r\n      handler: async (payload: WorkflowHookPayload, context: AgenticHookContext): Promise<HookHandlerResult> => {\r\n        if (!this.config.integration.enabled) {\r\n          return { continue: true };\r\n        }\r\n\r\n        const verificationContext = this.getVerificationContext(payload.workflowId) || \r\n                                   this.createVerificationContext(payload, context);\r\n        \r\n        try {\r\n          await this.executeIntegrationTests(verificationContext);\r\n          \r\n          const allTestsPassed = verificationContext.state.testResults.every(r => r.passed);\r\n          const testCount = verificationContext.state.testResults.length;\r\n          const passedCount = verificationContext.state.testResults.filter(r => r.passed).length;\r\n\r\n          return {\r\n            continue: true,\r\n            modified: true,\r\n            payload: {\r\n              ...payload,\r\n              testResults: verificationContext.state.testResults,\r\n              allTestsPassed,\r\n              testSummary: {\r\n                total: testCount,\r\n                passed: passedCount,\r\n                failed: testCount - passedCount\r\n              }\r\n            },\r\n            metadata: {\r\n              integrationTestsComplete: true,\r\n              allTestsPassed,\r\n              testCount,\r\n              passedCount\r\n            },\r\n            sideEffects: [{\r\n              type: 'metric',\r\n              action: 'update',\r\n              data: {\r\n                name: 'verification.integration.success_rate',\r\n                value: passedCount / testCount\r\n              }\r\n            }]\r\n          };\r\n        } catch (error) {\r\n          logger.error('Integration test execution error:', error);\r\n          \r\n          return {\r\n            continue: true,\r\n            metadata: {\r\n              integrationTestError: true,\r\n              error: (error as Error).message\r\n            }\r\n          };\r\n        }\r\n      },\r\n      options: {\r\n        timeout: 120000, // 2 minute timeout for tests\r\n        async: true,\r\n      }\r\n    };\r\n\r\n    agenticHookManager.register(integrationTestHook);\r\n  }\r\n\r\n  private async executeIntegrationTests(context: VerificationContext): Promise<void> {\r\n    const testSuites = this.config.integration.testSuites;\r\n    \r\n    for (const suite of testSuites) {\r\n      // Check if requirements are met\r\n      const requirementsMet = await this.checkTestRequirements(suite.requirements, context);\r\n      if (!requirementsMet) {\r\n        logger.warn(`Skipping test suite '${suite.id}' - requirements not met`);\r\n        continue;\r\n      }\r\n\r\n      if (this.config.integration.parallel) {\r\n        // Execute tests in parallel\r\n        const testPromises = suite.tests.map(test => this.executeIntegrationTest(test, context));\r\n        const results = await Promise.allSettled(testPromises);\r\n        \r\n        results.forEach((result, index) => {\r\n          if (result.status === 'fulfilled') {\r\n            context.state.testResults.push(result.value);\r\n          } else {\r\n            context.state.testResults.push({\r\n              passed: false,\r\n              duration: 0,\r\n              message: `Test '${suite.tests[index].id}' failed: ${result.reason}`,\r\n              details: result.reason\r\n            });\r\n          }\r\n        });\r\n      } else {\r\n        // Execute tests sequentially\r\n        for (const test of suite.tests) {\r\n          try {\r\n            const result = await this.executeIntegrationTest(test, context);\r\n            context.state.testResults.push(result);\r\n          } catch (error) {\r\n            context.state.testResults.push({\r\n              passed: false,\r\n              duration: 0,\r\n              message: `Test '${test.id}' failed: ${(error as Error).message}`,\r\n              details: error\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async executeIntegrationTest(\r\n    test: IntegrationTest, \r\n    context: VerificationContext\r\n  ): Promise<TestResult> {\r\n    const startTime = Date.now();\r\n    \r\n    try {\r\n      const result = await test.execute(context);\r\n      result.duration = Date.now() - startTime;\r\n      \r\n      // Cleanup if provided\r\n      if (test.cleanup) {\r\n        try {\r\n          await test.cleanup(context);\r\n        } catch (cleanupError) {\r\n          logger.warn(`Test cleanup failed for '${test.id}':`, cleanupError);\r\n        }\r\n      }\r\n      \r\n      return result;\r\n    } catch (error) {\r\n      return {\r\n        passed: false,\r\n        duration: Date.now() - startTime,\r\n        message: `Test execution failed: ${(error as Error).message}`,\r\n        details: error\r\n      };\r\n    }\r\n  }\r\n\r\n  private async checkTestRequirements(\r\n    requirements: string[], \r\n    context: VerificationContext\r\n  ): Promise<boolean> {\r\n    // Simple requirement checking - can be extended\r\n    for (const requirement of requirements) {\r\n      if (requirement.startsWith('env:')) {\r\n        const envVar = requirement.substring(4);\r\n        if (!process.env[envVar]) {\r\n          return false;\r\n        }\r\n      } else if (requirement.startsWith('check:')) {\r\n        const checkId = requirement.substring(6);\r\n        if (!context.state.checksPassed.includes(checkId)) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  // ===== 4. Truth Telemetry Hook =====\r\n\r\n  private registerTruthTelemetryHook(): void {\r\n    const truthTelemetryHook: HookRegistration = {\r\n      id: 'verification-truth-telemetry',\r\n      type: 'performance-metric',\r\n      priority: 70,\r\n      handler: async (payload: PerformanceHookPayload, context: AgenticHookContext): Promise<HookHandlerResult> => {\r\n        if (!this.config.telemetry.enabled) {\r\n          return { continue: true };\r\n        }\r\n\r\n        const verificationContext = this.getOrCreateVerificationContext(payload, context);\r\n        \r\n        try {\r\n          await this.executeTruthValidation(verificationContext, payload);\r\n          \r\n          const truthfulness = this.calculateTruthfulness(verificationContext);\r\n          \r\n          return {\r\n            continue: true,\r\n            modified: true,\r\n            payload: {\r\n              ...payload,\r\n              truthResults: verificationContext.state.truthResults,\r\n              truthfulness\r\n            },\r\n            metadata: {\r\n              truthValidationComplete: true,\r\n              truthfulness,\r\n              validatorCount: this.config.telemetry.truthValidators.length\r\n            },\r\n            sideEffects: [\r\n              {\r\n                type: 'metric',\r\n                action: 'update',\r\n                data: {\r\n                  name: 'verification.truthfulness',\r\n                  value: truthfulness\r\n                }\r\n              },\r\n              {\r\n                type: 'memory',\r\n                action: 'store',\r\n                data: {\r\n                  key: `truth_telemetry_${Date.now()}`,\r\n                  value: {\r\n                    timestamp: Date.now(),\r\n                    truthfulness,\r\n                    results: verificationContext.state.truthResults\r\n                  }\r\n                }\r\n              }\r\n            ]\r\n          };\r\n        } catch (error) {\r\n          logger.error('Truth telemetry execution error:', error);\r\n          \r\n          return {\r\n            continue: true,\r\n            metadata: {\r\n              truthTelemetryError: true,\r\n              error: (error as Error).message\r\n            }\r\n          };\r\n        }\r\n      },\r\n      options: {\r\n        timeout: 45000, // 45 second timeout\r\n        async: true,\r\n      }\r\n    };\r\n\r\n    agenticHookManager.register(truthTelemetryHook);\r\n  }\r\n\r\n  private async executeTruthValidation(\r\n    context: VerificationContext, \r\n    payload: PerformanceHookPayload\r\n  ): Promise<void> {\r\n    const validators = this.config.telemetry.truthValidators;\r\n    \r\n    for (const validator of validators) {\r\n      try {\r\n        // Extract data and expected values from payload\r\n        const data = payload.context.metrics || payload.value;\r\n        const expected = payload.threshold; // Use threshold as expected value\r\n        \r\n        const result = await validator.validate(data, expected);\r\n        context.state.truthResults.push(result);\r\n      } catch (error) {\r\n        logger.error(`Truth validator '${validator.id}' failed:`, error);\r\n        context.state.errors.push({\r\n          type: 'truth',\r\n          phase: 'telemetry',\r\n          message: `Truth validator '${validator.id}' threw an error: ${(error as Error).message}`,\r\n          details: error,\r\n          recoverable: false\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  private calculateTruthfulness(context: VerificationContext): number {\r\n    const truthResults = context.state.truthResults;\r\n    if (truthResults.length === 0) return 1.0;\r\n    \r\n    const totalAccuracy = truthResults.reduce((sum, result) => sum + result.accuracy, 0);\r\n    return totalAccuracy / truthResults.length;\r\n  }\r\n\r\n  // ===== 5. Rollback Trigger Hook =====\r\n\r\n  private registerRollbackTriggerHook(): void {\r\n    const rollbackTriggerHook: HookRegistration = {\r\n      id: 'verification-rollback-trigger',\r\n      type: 'workflow-error',\r\n      priority: 95, // Very high priority for error handling\r\n      handler: async (payload: WorkflowHookPayload, context: AgenticHookContext): Promise<HookHandlerResult> => {\r\n        if (!this.config.rollback.enabled) {\r\n          return { continue: true };\r\n        }\r\n\r\n        const verificationContext = this.getVerificationContext(payload.workflowId);\r\n        if (!verificationContext) {\r\n          logger.warn('No verification context found for rollback evaluation');\r\n          return { continue: true };\r\n        }\r\n\r\n        try {\r\n          const shouldRollback = await this.evaluateRollbackTriggers(verificationContext, payload.error);\r\n          \r\n          if (shouldRollback) {\r\n            const rollbackResult = await this.executeRollback(verificationContext);\r\n            \r\n            return {\r\n              continue: rollbackResult.success,\r\n              modified: true,\r\n              payload: {\r\n                ...payload,\r\n                rollbackExecuted: true,\r\n                rollbackResult\r\n              },\r\n              metadata: {\r\n                rollbackTriggered: true,\r\n                rollbackSuccess: rollbackResult.success,\r\n                rollbackAction: rollbackResult.action\r\n              },\r\n              sideEffects: [\r\n                {\r\n                  type: 'log',\r\n                  action: 'warn',\r\n                  data: {\r\n                    level: 'warn',\r\n                    message: 'Rollback triggered due to verification failure',\r\n                    data: rollbackResult\r\n                  }\r\n                },\r\n                {\r\n                  type: 'metric',\r\n                  action: 'increment',\r\n                  data: {\r\n                    name: 'verification.rollbacks.triggered'\r\n                  }\r\n                }\r\n              ]\r\n            };\r\n          }\r\n\r\n          return { continue: true };\r\n        } catch (error) {\r\n          logger.error('Rollback trigger evaluation error:', error);\r\n          \r\n          return {\r\n            continue: true,\r\n            metadata: {\r\n              rollbackError: true,\r\n              error: (error as Error).message\r\n            }\r\n          };\r\n        }\r\n      },\r\n      options: {\r\n        timeout: 30000, // 30 second timeout\r\n        async: false, // Critical for error handling\r\n      }\r\n    };\r\n\r\n    agenticHookManager.register(rollbackTriggerHook);\r\n  }\r\n\r\n  private async evaluateRollbackTriggers(\r\n    context: VerificationContext, \r\n    error?: Error\r\n  ): Promise<boolean> {\r\n    const triggers = this.config.rollback.triggers;\r\n    \r\n    for (const trigger of triggers) {\r\n      try {\r\n        if (trigger.condition(context, error)) {\r\n          logger.info(`Rollback trigger '${trigger.id}' activated`);\r\n          return true;\r\n        }\r\n      } catch (triggerError) {\r\n        logger.error(`Rollback trigger '${trigger.id}' evaluation failed:`, triggerError);\r\n      }\r\n    }\r\n    \r\n    return false;\r\n  }\r\n\r\n  private async executeRollback(context: VerificationContext): Promise<{\r\n    success: boolean;\r\n    action: string;\r\n    details?: any;\r\n  }> {\r\n    try {\r\n      const snapshots = this.snapshots.get(context.taskId) || [];\r\n      const latestSnapshot = snapshots[snapshots.length - 1];\r\n      \r\n      if (!latestSnapshot) {\r\n        throw new Error('No snapshots available for rollback');\r\n      }\r\n\r\n      // Execute rollback based on strategy\r\n      switch (this.config.rollback.snapshotStrategy) {\r\n        case 'automatic':\r\n          await this.restoreSnapshot(context, latestSnapshot);\r\n          break;\r\n          \r\n        case 'selective':\r\n          // Find the best snapshot to restore to\r\n          const bestSnapshot = this.findBestRollbackSnapshot(snapshots);\r\n          await this.restoreSnapshot(context, bestSnapshot);\r\n          break;\r\n          \r\n        default:\r\n          await this.restoreSnapshot(context, latestSnapshot);\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        action: 'snapshot-restored',\r\n        details: {\r\n          snapshotId: latestSnapshot.id,\r\n          timestamp: latestSnapshot.timestamp\r\n        }\r\n      };\r\n    } catch (error) {\r\n      logger.error('Rollback execution failed:', error);\r\n      \r\n      return {\r\n        success: false,\r\n        action: 'rollback-failed',\r\n        details: (error as Error).message\r\n      };\r\n    }\r\n  }\r\n\r\n  // ===== Helper Methods =====\r\n\r\n  private createVerificationContext(\r\n    payload: WorkflowHookPayload, \r\n    context: AgenticHookContext\r\n  ): VerificationContext {\r\n    const verificationContext: VerificationContext = {\r\n      taskId: payload.workflowId,\r\n      sessionId: context.sessionId,\r\n      timestamp: Date.now(),\r\n      metadata: { ...payload.state, ...context.metadata },\r\n      state: {\r\n        phase: 'pre-task',\r\n        checksPassed: [],\r\n        checksFailed: [],\r\n        validationResults: [],\r\n        testResults: [],\r\n        truthResults: [],\r\n        errors: []\r\n      },\r\n      snapshots: [],\r\n      metrics: {\r\n        totalChecks: 0,\r\n        passedChecks: 0,\r\n        failedChecks: 0,\r\n        executionTime: 0,\r\n        accuracyScore: 0,\r\n        confidenceScore: 0\r\n      }\r\n    };\r\n\r\n    this.contexts.set(verificationContext.taskId, verificationContext);\r\n    return verificationContext;\r\n  }\r\n\r\n  private getVerificationContext(taskId: string): VerificationContext | undefined {\r\n    return this.contexts.get(taskId);\r\n  }\r\n\r\n  private getOrCreateVerificationContext(\r\n    payload: any, \r\n    context: AgenticHookContext\r\n  ): VerificationContext {\r\n    const taskId = payload.workflowId || payload.context?.taskId || context.correlationId;\r\n    \r\n    let verificationContext = this.contexts.get(taskId);\r\n    if (!verificationContext) {\r\n      verificationContext = this.createVerificationContext(\r\n        { workflowId: taskId, state: payload.context || {} } as WorkflowHookPayload,\r\n        context\r\n      );\r\n    }\r\n    \r\n    return verificationContext;\r\n  }\r\n\r\n  private async createSnapshot(\r\n    context: VerificationContext, \r\n    phase: string\r\n  ): Promise<void> {\r\n    const snapshot: StateSnapshot = {\r\n      id: `snapshot_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: Date.now(),\r\n      phase,\r\n      state: JSON.parse(JSON.stringify(context.state)),\r\n      metadata: JSON.parse(JSON.stringify(context.metadata))\r\n    };\r\n\r\n    if (!this.snapshots.has(context.taskId)) {\r\n      this.snapshots.set(context.taskId, []);\r\n    }\r\n\r\n    this.snapshots.get(context.taskId)!.push(snapshot);\r\n    context.snapshots.push(snapshot);\r\n\r\n    logger.debug(`Created snapshot '${snapshot.id}' for task '${context.taskId}' in phase '${phase}'`);\r\n  }\r\n\r\n  private async restoreSnapshot(\r\n    context: VerificationContext, \r\n    snapshot: StateSnapshot\r\n  ): Promise<void> {\r\n    context.state = JSON.parse(JSON.stringify(snapshot.state));\r\n    context.metadata = JSON.parse(JSON.stringify(snapshot.metadata));\r\n    \r\n    logger.info(`Restored snapshot '${snapshot.id}' for task '${context.taskId}'`);\r\n  }\r\n\r\n  private findBestRollbackSnapshot(snapshots: StateSnapshot[]): StateSnapshot {\r\n    // Find the latest snapshot with successful state\r\n    const successfulSnapshots = snapshots.filter(s => \r\n      s.phase.includes('complete') && !s.phase.includes('error')\r\n    );\r\n    \r\n    return successfulSnapshots.length > 0 \r\n      ? successfulSnapshots[successfulSnapshots.length - 1]\r\n      : snapshots[snapshots.length - 1];\r\n  }\r\n\r\n  private calculateAccuracy(context: VerificationContext): number {\r\n    const validationResults = context.state.validationResults;\r\n    if (validationResults.length === 0) return 1.0;\r\n    \r\n    const totalAccuracy = validationResults.reduce((sum, result) => sum + result.accuracy, 0);\r\n    return totalAccuracy / validationResults.length;\r\n  }\r\n\r\n  private startTelemetryReporting(): void {\r\n    if (!this.config.telemetry.enabled) return;\r\n\r\n    setInterval(() => {\r\n      this.generateTelemetryReport();\r\n    }, this.config.telemetry.reportingInterval);\r\n  }\r\n\r\n  private generateTelemetryReport(): void {\r\n    const report = {\r\n      timestamp: Date.now(),\r\n      activeContexts: this.contexts.size,\r\n      totalSnapshots: Array.from(this.snapshots.values()).reduce((sum, arr) => sum + arr.length, 0),\r\n      metrics: this.aggregateMetrics()\r\n    };\r\n\r\n    logger.info('Verification telemetry report:', report);\r\n    \r\n    // Emit telemetry event for external systems\r\n    agenticHookManager.emit('verification:telemetry', report);\r\n  }\r\n\r\n  private aggregateMetrics(): any {\r\n    const allContexts = Array.from(this.contexts.values());\r\n    \r\n    return {\r\n      totalChecks: allContexts.reduce((sum, ctx) => sum + ctx.metrics.totalChecks, 0),\r\n      totalPassed: allContexts.reduce((sum, ctx) => sum + ctx.metrics.passedChecks, 0),\r\n      totalFailed: allContexts.reduce((sum, ctx) => sum + ctx.metrics.failedChecks, 0),\r\n      averageAccuracy: allContexts.length > 0 \r\n        ? allContexts.reduce((sum, ctx) => sum + ctx.metrics.accuracyScore, 0) / allContexts.length\r\n        : 0,\r\n      averageConfidence: allContexts.length > 0\r\n        ? allContexts.reduce((sum, ctx) => sum + ctx.metrics.confidenceScore, 0) / allContexts.length\r\n        : 0\r\n    };\r\n  }\r\n\r\n  // ===== Public API =====\r\n\r\n  /**\r\n   * Add a pre-task checker\r\n   */\r\n  public addPreTaskChecker(checker: PreTaskChecker): void {\r\n    this.config.preTask.checkers.push(checker);\r\n    logger.info(`Added pre-task checker: ${checker.name}`);\r\n  }\r\n\r\n  /**\r\n   * Add a post-task validator\r\n   */\r\n  public addPostTaskValidator(validator: PostTaskValidator): void {\r\n    this.config.postTask.validators.push(validator);\r\n    logger.info(`Added post-task validator: ${validator.name}`);\r\n  }\r\n\r\n  /**\r\n   * Add an integration test suite\r\n   */\r\n  public addIntegrationTestSuite(testSuite: IntegrationTestSuite): void {\r\n    this.config.integration.testSuites.push(testSuite);\r\n    logger.info(`Added integration test suite: ${testSuite.name}`);\r\n  }\r\n\r\n  /**\r\n   * Add a truth validator\r\n   */\r\n  public addTruthValidator(validator: TruthValidator): void {\r\n    this.config.telemetry.truthValidators.push(validator);\r\n    logger.info(`Added truth validator: ${validator.name}`);\r\n  }\r\n\r\n  /**\r\n   * Add a rollback trigger\r\n   */\r\n  public addRollbackTrigger(trigger: RollbackTrigger): void {\r\n    this.config.rollback.triggers.push(trigger);\r\n    logger.info(`Added rollback trigger: ${trigger.name}`);\r\n  }\r\n\r\n  /**\r\n   * Get verification status for a task\r\n   */\r\n  public getVerificationStatus(taskId: string): VerificationContext | undefined {\r\n    return this.contexts.get(taskId);\r\n  }\r\n\r\n  /**\r\n   * Get verification metrics\r\n   */\r\n  public getMetrics(): any {\r\n    return this.aggregateMetrics();\r\n  }\r\n\r\n  /**\r\n   * Update configuration\r\n   */\r\n  public updateConfig(newConfig: Partial<VerificationConfig>): void {\r\n    this.config = { ...this.config, ...newConfig };\r\n    logger.info('Verification configuration updated');\r\n  }\r\n\r\n  /**\r\n   * Cleanup old contexts and snapshots\r\n   */\r\n  public cleanup(maxAge: number = 24 * 60 * 60 * 1000): void {\r\n    const cutoff = Date.now() - maxAge;\r\n    \r\n    // Cleanup contexts\r\n    for (const [taskId, context] of this.contexts.entries()) {\r\n      if (context.timestamp < cutoff) {\r\n        this.contexts.delete(taskId);\r\n        this.snapshots.delete(taskId);\r\n      }\r\n    }\r\n    \r\n    logger.info(`Cleaned up verification data older than ${maxAge}ms`);\r\n  }\r\n}\r\n\r\n// ===== Default Verification Components =====\r\n\r\nexport const DEFAULT_PRE_TASK_CHECKERS: PreTaskChecker[] = [\r\n  {\r\n    id: 'environment-check',\r\n    name: 'Environment Validation',\r\n    description: 'Validates that required environment variables and dependencies are available',\r\n    priority: 100,\r\n    check: async (context: VerificationContext): Promise<VerificationResult> => {\r\n      // Basic environment validation\r\n      const requiredEnvVars = ['NODE_ENV'];\r\n      const missing = requiredEnvVars.filter(envVar => !process.env[envVar]);\r\n      \r\n      return {\r\n        passed: missing.length === 0,\r\n        score: missing.length === 0 ? 1.0 : 0.5,\r\n        message: missing.length === 0 \r\n          ? 'Environment validation passed' \r\n          : `Missing environment variables: ${missing.join(', ')}`,\r\n        details: { missing, available: requiredEnvVars.filter(envVar => process.env[envVar]) },\r\n        recommendations: missing.length > 0 \r\n          ? [`Set missing environment variables: ${missing.join(', ')}`]\r\n          : undefined\r\n      };\r\n    }\r\n  },\r\n  {\r\n    id: 'resource-check',\r\n    name: 'Resource Availability',\r\n    description: 'Checks system resources and capacity',\r\n    priority: 90,\r\n    check: async (context: VerificationContext): Promise<VerificationResult> => {\r\n      // Simple memory check\r\n      const memUsage = process.memoryUsage();\r\n      const heapUsedMB = memUsage.heapUsed / 1024 / 1024;\r\n      const heapTotalMB = memUsage.heapTotal / 1024 / 1024;\r\n      const usageRatio = heapUsedMB / heapTotalMB;\r\n      \r\n      return {\r\n        passed: usageRatio < 0.9, // Less than 90% memory usage\r\n        score: Math.max(0, 1 - usageRatio),\r\n        message: `Memory usage: ${heapUsedMB.toFixed(2)}MB / ${heapTotalMB.toFixed(2)}MB (${(usageRatio * 100).toFixed(1)}%)`,\r\n        details: { memUsage, usageRatio },\r\n        recommendations: usageRatio > 0.8 \r\n          ? ['Consider freeing memory before proceeding']\r\n          : undefined\r\n      };\r\n    }\r\n  }\r\n];\r\n\r\nexport const DEFAULT_POST_TASK_VALIDATORS: PostTaskValidator[] = [\r\n  {\r\n    id: 'completion-validator',\r\n    name: 'Task Completion Validation',\r\n    description: 'Validates that the task completed successfully',\r\n    priority: 100,\r\n    validate: async (context: VerificationContext, result: any): Promise<ValidationResult> => {\r\n      const hasErrors = context.state.errors.length > 0;\r\n      const hasFailedChecks = context.state.checksFailed.length > 0;\r\n      \r\n      return {\r\n        valid: !hasErrors && !hasFailedChecks,\r\n        accuracy: hasErrors || hasFailedChecks ? 0.5 : 1.0,\r\n        confidence: 0.9,\r\n        message: hasErrors || hasFailedChecks \r\n          ? 'Task completed with errors or failed checks'\r\n          : 'Task completed successfully',\r\n        details: {\r\n          errorCount: context.state.errors.length,\r\n          failedCheckCount: context.state.checksFailed.length\r\n        }\r\n      };\r\n    }\r\n  }\r\n];\r\n\r\nexport const DEFAULT_TRUTH_VALIDATORS: TruthValidator[] = [\r\n  {\r\n    id: 'data-consistency-validator',\r\n    name: 'Data Consistency Validation',\r\n    description: 'Validates data consistency and integrity',\r\n    validate: async (data: any, expected: any): Promise<TruthResult> => {\r\n      // Simple JSON comparison for data consistency\r\n      const dataStr = JSON.stringify(data);\r\n      const expectedStr = JSON.stringify(expected);\r\n      const isEqual = dataStr === expectedStr;\r\n      \r\n      return {\r\n        truthful: isEqual,\r\n        accuracy: isEqual ? 1.0 : 0.0,\r\n        confidence: 0.95,\r\n        discrepancies: isEqual ? [] : ['Data does not match expected structure'],\r\n        evidence: [{ data, expected, match: isEqual }]\r\n      };\r\n    }\r\n  }\r\n];\r\n\r\nexport const DEFAULT_ROLLBACK_TRIGGERS: RollbackTrigger[] = [\r\n  {\r\n    id: 'error-threshold-trigger',\r\n    name: 'Error Threshold Trigger',\r\n    description: 'Triggers rollback when error count exceeds threshold',\r\n    condition: (context: VerificationContext, error?: Error): boolean => {\r\n      return context.state.errors.filter(e => !e.recoverable).length > 3;\r\n    },\r\n    action: 'restore-snapshot'\r\n  },\r\n  {\r\n    id: 'accuracy-threshold-trigger',\r\n    name: 'Accuracy Threshold Trigger',\r\n    description: 'Triggers rollback when accuracy falls below threshold',\r\n    condition: (context: VerificationContext, error?: Error): boolean => {\r\n      return context.metrics.accuracyScore < 0.5 && context.state.validationResults.length > 0;\r\n    },\r\n    action: 'restore-snapshot'\r\n  }\r\n];\r\n\r\n// ===== Export Singleton Instance =====\r\n\r\nexport const verificationHookManager = new VerificationHookManager({\r\n  preTask: {\r\n    enabled: true,\r\n    checkers: DEFAULT_PRE_TASK_CHECKERS,\r\n    failureStrategy: 'abort'\r\n  },\r\n  postTask: {\r\n    enabled: true,\r\n    validators: DEFAULT_POST_TASK_VALIDATORS,\r\n    accuracyThreshold: 0.8\r\n  },\r\n  integration: {\r\n    enabled: true,\r\n    testSuites: [],\r\n    parallel: true\r\n  },\r\n  telemetry: {\r\n    enabled: true,\r\n    truthValidators: DEFAULT_TRUTH_VALIDATORS,\r\n    reportingInterval: 30000\r\n  },\r\n  rollback: {\r\n    enabled: true,\r\n    triggers: DEFAULT_ROLLBACK_TRIGGERS,\r\n    snapshotStrategy: 'automatic'\r\n  }\r\n});\r\n\r\n// Initialize default components\r\nlogger.info('Verification hooks module initialized with default configuration');"],"names":["Logger","agenticHookManager","logger","level","format","destination","prefix","DEFAULT_VERIFICATION_CONFIG","preTask","enabled","checkers","failureStrategy","postTask","validators","accuracyThreshold","integration","testSuites","parallel","telemetry","truthValidators","reportingInterval","rollback","triggers","snapshotStrategy","VerificationHookManager","config","contexts","Map","snapshots","registerHooks","startTelemetryReporting","registerPreTaskHook","registerPostTaskHook","registerIntegrationTestHook","registerTruthTelemetryHook","registerRollbackTriggerHook","info","preTaskHook","id","type","priority","handler","payload","context","continue","verificationContext","createVerificationContext","executePreTaskChecks","state","checksFailed","length","strategy","metadata","verificationFailed","failedChecks","error","warn","createSnapshot","modified","taskId","verificationPassed","checksExecuted","checksPassed","warnings","verificationError","message","options","timeout","async","register","sort","a","b","checker","result","check","passed","push","errors","phase","details","recoverable","metrics","totalChecks","passedChecks","postTaskHook","getVerificationContext","workflowId","executePostTaskValidation","accuracy","calculateAccuracy","meetsThreshold","validationResults","validationComplete","validationCount","sideEffects","action","data","name","value","validationError","validator","validate","valid","accuracyScore","confidenceScore","confidence","integrationTestHook","filter","patterns","executeIntegrationTests","allTestsPassed","testResults","every","r","testCount","passedCount","testSummary","total","failed","integrationTestsComplete","integrationTestError","suite","requirementsMet","checkTestRequirements","requirements","testPromises","tests","map","test","executeIntegrationTest","results","Promise","allSettled","forEach","index","status","duration","reason","startTime","Date","now","execute","cleanup","cleanupError","requirement","startsWith","envVar","substring","process","env","checkId","includes","truthTelemetryHook","getOrCreateVerificationContext","executeTruthValidation","truthfulness","calculateTruthfulness","truthResults","truthValidationComplete","validatorCount","key","timestamp","truthTelemetryError","expected","threshold","totalAccuracy","reduce","sum","rollbackTriggerHook","shouldRollback","evaluateRollbackTriggers","rollbackResult","executeRollback","success","rollbackExecuted","rollbackTriggered","rollbackSuccess","rollbackAction","rollbackError","trigger","condition","triggerError","get","latestSnapshot","Error","restoreSnapshot","bestSnapshot","findBestRollbackSnapshot","snapshotId","sessionId","executionTime","set","correlationId","snapshot","Math","random","toString","substr","JSON","parse","stringify","has","debug","successfulSnapshots","s","setInterval","generateTelemetryReport","report","activeContexts","size","totalSnapshots","Array","from","values","arr","aggregateMetrics","emit","allContexts","ctx","totalPassed","totalFailed","averageAccuracy","averageConfidence","addPreTaskChecker","addPostTaskValidator","addIntegrationTestSuite","testSuite","addTruthValidator","addRollbackTrigger","getVerificationStatus","getMetrics","updateConfig","newConfig","maxAge","cutoff","entries","delete","DEFAULT_PRE_TASK_CHECKERS","description","requiredEnvVars","missing","score","join","available","recommendations","undefined","memUsage","memoryUsage","heapUsedMB","heapUsed","heapTotalMB","heapTotal","usageRatio","max","toFixed","DEFAULT_POST_TASK_VALIDATORS","hasErrors","hasFailedChecks","errorCount","failedCheckCount","DEFAULT_TRUTH_VALIDATORS","dataStr","expectedStr","isEqual","truthful","discrepancies","evidence","match","DEFAULT_ROLLBACK_TRIGGERS","e","verificationHookManager"],"mappings":"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"}
{"version":3,"sources":["../../../src/mcp/protocol-manager.ts"],"sourcesContent":["/**\r\n * MCP Protocol Version Management and Compatibility Checking\r\n */\r\n\r\nimport type { MCPProtocolVersion, MCPCapabilities, MCPInitializeParams } from '../utils/types.js';\r\nimport type { ILogger } from '../core/logger.js';\r\nimport { MCPError } from '../utils/errors.js';\r\n\r\nexport interface ProtocolVersionInfo {\r\n  version: MCPProtocolVersion;\r\n  name: string;\r\n  releaseDate: Date;\r\n  deprecated?: boolean;\r\n  deprecationDate?: Date;\r\n  supportedFeatures: string[];\r\n  breakingChanges?: string[];\r\n  migrationGuide?: string;\r\n}\r\n\r\nexport interface CompatibilityResult {\r\n  compatible: boolean;\r\n  warnings: string[];\r\n  errors: string[];\r\n  recommendedVersion?: MCPProtocolVersion;\r\n  missingFeatures?: string[];\r\n  deprecatedFeatures?: string[];\r\n}\r\n\r\nexport interface NegotiationResult {\r\n  agreedVersion: MCPProtocolVersion;\r\n  agreedCapabilities: MCPCapabilities;\r\n  clientCapabilities: MCPCapabilities;\r\n  serverCapabilities: MCPCapabilities;\r\n  warnings: string[];\r\n  limitations: string[];\r\n}\r\n\r\n/**\r\n * MCP Protocol Manager\r\n * Handles protocol version negotiation, compatibility checking, and feature management\r\n */\r\nexport class MCPProtocolManager {\r\n  private supportedVersions: Map<string, ProtocolVersionInfo> = new Map();\r\n  private currentVersion: MCPProtocolVersion;\r\n  private serverCapabilities: MCPCapabilities;\r\n\r\n  private readonly knownVersions: ProtocolVersionInfo[] = [\r\n    {\r\n      version: { major: 2024, minor: 11, patch: 5 },\r\n      name: 'MCP 2024.11.5',\r\n      releaseDate: new Date('2024-11-01'),\r\n      supportedFeatures: [\r\n        'tools',\r\n        'prompts',\r\n        'resources',\r\n        'logging',\r\n        'sampling',\r\n        'notifications',\r\n        'tool_list_changed',\r\n        'resource_list_changed',\r\n        'prompt_list_changed',\r\n      ],\r\n    },\r\n    {\r\n      version: { major: 2024, minor: 11, patch: 4 },\r\n      name: 'MCP 2024.11.4',\r\n      releaseDate: new Date('2024-10-15'),\r\n      supportedFeatures: [\r\n        'tools',\r\n        'prompts',\r\n        'resources',\r\n        'logging',\r\n        'notifications',\r\n        'tool_list_changed',\r\n        'resource_list_changed',\r\n      ],\r\n    },\r\n    {\r\n      version: { major: 2024, minor: 11, patch: 3 },\r\n      name: 'MCP 2024.11.3',\r\n      releaseDate: new Date('2024-10-01'),\r\n      supportedFeatures: ['tools', 'prompts', 'resources', 'logging', 'notifications'],\r\n    },\r\n    {\r\n      version: { major: 2024, minor: 10, patch: 0 },\r\n      name: 'MCP 2024.10.0',\r\n      releaseDate: new Date('2024-09-01'),\r\n      deprecated: true,\r\n      deprecationDate: new Date('2024-11-01'),\r\n      supportedFeatures: ['tools', 'prompts', 'resources', 'logging'],\r\n      breakingChanges: ['Changed tool response format', 'Modified error codes'],\r\n      migrationGuide: 'https://docs.mcp.io/migration/2024.10-to-2024.11',\r\n    },\r\n  ];\r\n\r\n  constructor(\r\n    private logger: ILogger,\r\n    preferredVersion?: MCPProtocolVersion,\r\n    serverCapabilities?: MCPCapabilities,\r\n  ) {\r\n    // Initialize supported versions\r\n    for (const versionInfo of this.knownVersions) {\r\n      const key = this.versionToString(versionInfo.version);\r\n      this.supportedVersions.set(key, versionInfo);\r\n    }\r\n\r\n    // Set current version (latest supported or preferred)\r\n    this.currentVersion = preferredVersion || this.getLatestSupportedVersion();\r\n\r\n    // Set server capabilities\r\n    this.serverCapabilities = serverCapabilities || this.getDefaultCapabilities();\r\n\r\n    this.logger.info('Protocol manager initialized', {\r\n      currentVersion: this.versionToString(this.currentVersion),\r\n      supportedVersions: this.getSupportedVersionStrings(),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Negotiate protocol version and capabilities with client\r\n   */\r\n  async negotiateProtocol(clientParams: MCPInitializeParams): Promise<NegotiationResult> {\r\n    this.logger.debug('Starting protocol negotiation', {\r\n      clientVersion: this.versionToString(clientParams.protocolVersion),\r\n      clientCapabilities: clientParams.capabilities,\r\n      clientInfo: clientParams.clientInfo,\r\n    });\r\n\r\n    const result: NegotiationResult = {\r\n      agreedVersion: this.currentVersion,\r\n      agreedCapabilities: { ...this.serverCapabilities },\r\n      clientCapabilities: clientParams.capabilities,\r\n      serverCapabilities: this.serverCapabilities,\r\n      warnings: [],\r\n      limitations: [],\r\n    };\r\n\r\n    try {\r\n      // Check version compatibility\r\n      const compatibility = this.checkCompatibility(clientParams.protocolVersion);\r\n\r\n      if (!compatibility.compatible) {\r\n        throw new MCPError(\r\n          `Protocol version ${this.versionToString(clientParams.protocolVersion)} is not compatible. ${compatibility.errors.join(', ')}`,\r\n        );\r\n      }\r\n\r\n      // Use client's version if it's supported and newer\r\n      if (this.isVersionSupported(clientParams.protocolVersion)) {\r\n        const clientVersionInfo = this.getVersionInfo(clientParams.protocolVersion);\r\n        const currentVersionInfo = this.getVersionInfo(this.currentVersion);\r\n\r\n        if (clientVersionInfo && currentVersionInfo) {\r\n          if (this.compareVersions(clientParams.protocolVersion, this.currentVersion) <= 0) {\r\n            result.agreedVersion = clientParams.protocolVersion;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Negotiate capabilities\r\n      result.agreedCapabilities = this.negotiateCapabilities(\r\n        clientParams.capabilities,\r\n        this.serverCapabilities,\r\n        result.agreedVersion,\r\n      );\r\n\r\n      // Add warnings from compatibility check\r\n      result.warnings.push(...compatibility.warnings);\r\n\r\n      // Check for deprecated features\r\n      const versionInfo = this.getVersionInfo(result.agreedVersion);\r\n      if (versionInfo?.deprecated) {\r\n        result.warnings.push(\r\n          `Protocol version ${this.versionToString(result.agreedVersion)} is deprecated. ` +\r\n            `Please upgrade to a newer version.`,\r\n        );\r\n      }\r\n\r\n      // Check for missing features\r\n      const missingFeatures = this.getMissingFeatures(\r\n        result.agreedVersion,\r\n        result.agreedCapabilities,\r\n      );\r\n\r\n      if (missingFeatures.length > 0) {\r\n        result.limitations.push(\r\n          `Some features may not be available: ${missingFeatures.join(', ')}`,\r\n        );\r\n      }\r\n\r\n      this.logger.info('Protocol negotiation completed', {\r\n        agreedVersion: this.versionToString(result.agreedVersion),\r\n        warnings: result.warnings.length,\r\n        limitations: result.limitations.length,\r\n      });\r\n\r\n      return result;\r\n    } catch (error) {\r\n      this.logger.error('Protocol negotiation failed', {\r\n        clientVersion: this.versionToString(clientParams.protocolVersion),\r\n        error,\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check compatibility between client and server versions\r\n   */\r\n  checkCompatibility(clientVersion: MCPProtocolVersion): CompatibilityResult {\r\n    const result: CompatibilityResult = {\r\n      compatible: false,\r\n      warnings: [],\r\n      errors: [],\r\n    };\r\n\r\n    const clientVersionInfo = this.getVersionInfo(clientVersion);\r\n    const serverVersionInfo = this.getVersionInfo(this.currentVersion);\r\n\r\n    // Check if version is known\r\n    if (!clientVersionInfo) {\r\n      result.errors.push(`Unknown protocol version: ${this.versionToString(clientVersion)}`);\r\n      result.recommendedVersion = this.getLatestSupportedVersion();\r\n      return result;\r\n    }\r\n\r\n    // Check major version compatibility\r\n    if (clientVersion.major !== this.currentVersion.major) {\r\n      result.errors.push(\r\n        `Major version mismatch: client ${clientVersion.major}, server ${this.currentVersion.major}`,\r\n      );\r\n      return result;\r\n    }\r\n\r\n    // Check if client version is too new\r\n    if (this.compareVersions(clientVersion, this.currentVersion) > 0) {\r\n      result.errors.push(\r\n        `Client version ${this.versionToString(clientVersion)} is newer than supported server version ${this.versionToString(this.currentVersion)}`,\r\n      );\r\n      result.recommendedVersion = this.currentVersion;\r\n      return result;\r\n    }\r\n\r\n    // Check for deprecated versions\r\n    if (clientVersionInfo.deprecated) {\r\n      result.warnings.push(\r\n        `Client is using deprecated version ${this.versionToString(clientVersion)}. ` +\r\n          `Support will be removed after ${clientVersionInfo.deprecationDate?.toISOString().split('T')[0]}`,\r\n      );\r\n      result.recommendedVersion = this.getLatestSupportedVersion();\r\n    }\r\n\r\n    // Check for missing features\r\n    const serverFeatures = serverVersionInfo?.supportedFeatures || [];\r\n    const clientFeatures = clientVersionInfo.supportedFeatures;\r\n    const missingFeatures = serverFeatures.filter((feature) => !clientFeatures.includes(feature));\r\n\r\n    if (missingFeatures.length > 0) {\r\n      result.missingFeatures = missingFeatures;\r\n      result.warnings.push(\r\n        `Client version lacks some server features: ${missingFeatures.join(', ')}`,\r\n      );\r\n    }\r\n\r\n    // Check for deprecated features being used\r\n    const deprecatedFeatures = this.getDeprecatedFeatures(clientVersion);\r\n    if (deprecatedFeatures.length > 0) {\r\n      result.deprecatedFeatures = deprecatedFeatures;\r\n      result.warnings.push(\r\n        `Client version uses deprecated features: ${deprecatedFeatures.join(', ')}`,\r\n      );\r\n    }\r\n\r\n    result.compatible = true;\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Get information about a specific protocol version\r\n   */\r\n  getVersionInfo(version: MCPProtocolVersion): ProtocolVersionInfo | undefined {\r\n    return this.supportedVersions.get(this.versionToString(version));\r\n  }\r\n\r\n  /**\r\n   * Check if a version is supported\r\n   */\r\n  isVersionSupported(version: MCPProtocolVersion): boolean {\r\n    return this.supportedVersions.has(this.versionToString(version));\r\n  }\r\n\r\n  /**\r\n   * Get the latest supported version\r\n   */\r\n  getLatestSupportedVersion(): MCPProtocolVersion {\r\n    const versions = Array.from(this.supportedVersions.values())\r\n      .filter((v) => !v.deprecated)\r\n      .sort((a, b) => this.compareVersions(b.version, a.version));\r\n\r\n    return versions[0]?.version || { major: 2024, minor: 11, patch: 5 };\r\n  }\r\n\r\n  /**\r\n   * Get all supported version strings\r\n   */\r\n  getSupportedVersionStrings(): string[] {\r\n    return Array.from(this.supportedVersions.keys());\r\n  }\r\n\r\n  /**\r\n   * Get current server capabilities\r\n   */\r\n  getServerCapabilities(): MCPCapabilities {\r\n    return { ...this.serverCapabilities };\r\n  }\r\n\r\n  /**\r\n   * Update server capabilities\r\n   */\r\n  updateServerCapabilities(capabilities: Partial<MCPCapabilities>): void {\r\n    this.serverCapabilities = { ...this.serverCapabilities, ...capabilities };\r\n    this.logger.info('Server capabilities updated', { capabilities: this.serverCapabilities });\r\n  }\r\n\r\n  /**\r\n   * Check if a feature is supported in a specific version\r\n   */\r\n  isFeatureSupported(version: MCPProtocolVersion, feature: string): boolean {\r\n    const versionInfo = this.getVersionInfo(version);\r\n    return versionInfo?.supportedFeatures.includes(feature) || false;\r\n  }\r\n\r\n  private versionToString(version: MCPProtocolVersion): string {\r\n    return `${version.major}.${version.minor}.${version.patch}`;\r\n  }\r\n\r\n  private compareVersions(a: MCPProtocolVersion, b: MCPProtocolVersion): number {\r\n    if (a.major !== b.major) return a.major - b.major;\r\n    if (a.minor !== b.minor) return a.minor - b.minor;\r\n    return a.patch - b.patch;\r\n  }\r\n\r\n  private getDefaultCapabilities(): MCPCapabilities {\r\n    return {\r\n      logging: {\r\n        level: 'info',\r\n      },\r\n      tools: {\r\n        listChanged: true,\r\n      },\r\n      resources: {\r\n        listChanged: true,\r\n        subscribe: false,\r\n      },\r\n      prompts: {\r\n        listChanged: true,\r\n      },\r\n    };\r\n  }\r\n\r\n  private negotiateCapabilities(\r\n    clientCapabilities: MCPCapabilities,\r\n    serverCapabilities: MCPCapabilities,\r\n    agreedVersion: MCPProtocolVersion,\r\n  ): MCPCapabilities {\r\n    const result: MCPCapabilities = {};\r\n\r\n    // Negotiate logging capabilities\r\n    if (clientCapabilities.logging && serverCapabilities.logging) {\r\n      result.logging = {\r\n        level: this.negotiateLogLevel(\r\n          clientCapabilities.logging.level,\r\n          serverCapabilities.logging.level,\r\n        ),\r\n      };\r\n    }\r\n\r\n    // Negotiate tools capabilities\r\n    if (clientCapabilities.tools && serverCapabilities.tools) {\r\n      result.tools = {\r\n        listChanged: clientCapabilities.tools.listChanged && serverCapabilities.tools.listChanged,\r\n      };\r\n    }\r\n\r\n    // Negotiate resources capabilities\r\n    if (clientCapabilities.resources && serverCapabilities.resources) {\r\n      result.resources = {\r\n        listChanged:\r\n          clientCapabilities.resources.listChanged && serverCapabilities.resources.listChanged,\r\n        subscribe: clientCapabilities.resources.subscribe && serverCapabilities.resources.subscribe,\r\n      };\r\n    }\r\n\r\n    // Negotiate prompts capabilities\r\n    if (clientCapabilities.prompts && serverCapabilities.prompts) {\r\n      result.prompts = {\r\n        listChanged:\r\n          clientCapabilities.prompts.listChanged && serverCapabilities.prompts.listChanged,\r\n      };\r\n    }\r\n\r\n    // Only include capabilities supported by the agreed version\r\n    return this.filterCapabilitiesByVersion(result, agreedVersion);\r\n  }\r\n\r\n  private negotiateLogLevel(\r\n    clientLevel?: 'debug' | 'info' | 'warn' | 'error',\r\n    serverLevel?: 'debug' | 'info' | 'warn' | 'error',\r\n  ): 'debug' | 'info' | 'warn' | 'error' {\r\n    const levels = ['debug', 'info', 'warn', 'error'];\r\n    const clientIndex = clientLevel ? levels.indexOf(clientLevel) : 1;\r\n    const serverIndex = serverLevel ? levels.indexOf(serverLevel) : 1;\r\n\r\n    // Use the more restrictive (higher) level\r\n    const chosenIndex = Math.max(clientIndex, serverIndex);\r\n    return levels[chosenIndex] as 'debug' | 'info' | 'warn' | 'error';\r\n  }\r\n\r\n  private filterCapabilitiesByVersion(\r\n    capabilities: MCPCapabilities,\r\n    version: MCPProtocolVersion,\r\n  ): MCPCapabilities {\r\n    const versionInfo = this.getVersionInfo(version);\r\n    if (!versionInfo) return capabilities;\r\n\r\n    const result: MCPCapabilities = {};\r\n\r\n    // Only include capabilities supported by this version\r\n    if (versionInfo.supportedFeatures.includes('logging') && capabilities.logging) {\r\n      result.logging = capabilities.logging;\r\n    }\r\n\r\n    if (versionInfo.supportedFeatures.includes('tools') && capabilities.tools) {\r\n      result.tools = capabilities.tools;\r\n    }\r\n\r\n    if (versionInfo.supportedFeatures.includes('resources') && capabilities.resources) {\r\n      result.resources = capabilities.resources;\r\n    }\r\n\r\n    if (versionInfo.supportedFeatures.includes('prompts') && capabilities.prompts) {\r\n      result.prompts = capabilities.prompts;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  private getMissingFeatures(version: MCPProtocolVersion, capabilities: MCPCapabilities): string[] {\r\n    const versionInfo = this.getVersionInfo(version);\r\n    if (!versionInfo) return [];\r\n\r\n    const missing: string[] = [];\r\n    const availableFeatures = versionInfo.supportedFeatures;\r\n\r\n    // Check what's missing compared to latest version\r\n    const latestVersion = this.getLatestSupportedVersion();\r\n    const latestVersionInfo = this.getVersionInfo(latestVersion);\r\n\r\n    if (latestVersionInfo) {\r\n      for (const feature of latestVersionInfo.supportedFeatures) {\r\n        if (!availableFeatures.includes(feature)) {\r\n          missing.push(feature);\r\n        }\r\n      }\r\n    }\r\n\r\n    return missing;\r\n  }\r\n\r\n  private getDeprecatedFeatures(version: MCPProtocolVersion): string[] {\r\n    const versionInfo = this.getVersionInfo(version);\r\n    return versionInfo?.breakingChanges || [];\r\n  }\r\n}\r\n"],"names":["MCPError","MCPProtocolManager","supportedVersions","Map","currentVersion","serverCapabilities","knownVersions","version","major","minor","patch","name","releaseDate","Date","supportedFeatures","deprecated","deprecationDate","breakingChanges","migrationGuide","logger","preferredVersion","versionInfo","key","versionToString","set","getLatestSupportedVersion","getDefaultCapabilities","info","getSupportedVersionStrings","negotiateProtocol","clientParams","debug","clientVersion","protocolVersion","clientCapabilities","capabilities","clientInfo","result","agreedVersion","agreedCapabilities","warnings","limitations","compatibility","checkCompatibility","compatible","errors","join","isVersionSupported","clientVersionInfo","getVersionInfo","currentVersionInfo","compareVersions","negotiateCapabilities","push","missingFeatures","getMissingFeatures","length","error","serverVersionInfo","recommendedVersion","toISOString","split","serverFeatures","clientFeatures","filter","feature","includes","deprecatedFeatures","getDeprecatedFeatures","get","has","versions","Array","from","values","v","sort","a","b","keys","getServerCapabilities","updateServerCapabilities","isFeatureSupported","logging","level","tools","listChanged","resources","subscribe","prompts","negotiateLogLevel","filterCapabilitiesByVersion","clientLevel","serverLevel","levels","clientIndex","indexOf","serverIndex","chosenIndex","Math","max","missing","availableFeatures","latestVersion","latestVersionInfo"],"mappings":"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"}
{
  "version": 3,
  "sources": ["../../src/swarm/json-output-aggregator.ts"],
  "sourcesContent": ["/**\n * JSON Output Aggregator for Non-Interactive Swarm Execution\n * Collects and formats swarm results into a comprehensive JSON structure\n */\n\nimport { EventEmitter } from 'events';\nimport { promises as fs } from 'node:fs';\nimport { generateId } from '../utils/helpers.js';\nimport { Logger } from '../core/logger.js';\nimport type {\n  SwarmId,\n  AgentId,\n  TaskId,\n  AgentState,\n  TaskDefinition,\n  SwarmResults,\n  SwarmMetrics,\n  TaskResult,\n} from './types.js';\n\nexport interface SwarmOutputAggregate {\n  swarmId: string;\n  objective: string;\n  startTime: string;\n  endTime: string;\n  duration: number;\n  status: 'completed' | 'failed' | 'timeout' | 'cancelled';\n  summary: {\n    totalAgents: number;\n    totalTasks: number;\n    completedTasks: number;\n    failedTasks: number;\n    successRate: number;\n  };\n  agents: AgentOutputData[];\n  tasks: TaskOutputData[];\n  results: {\n    artifacts: Record<string, any>;\n    outputs: string[];\n    errors: string[];\n    insights: string[];\n  };\n  metrics: SwarmMetrics;\n  metadata: {\n    strategy: string;\n    mode: string;\n    configuration: Record<string, any>;\n    version: string;\n  };\n}\n\nexport interface AgentOutputData {\n  agentId: string;\n  name: string;\n  type: string;\n  status: string;\n  startTime: string;\n  endTime?: string;\n  duration?: number;\n  tasksCompleted: number;\n  outputs: string[];\n  errors: string[];\n  metrics: {\n    tokensUsed?: number;\n    memoryAccess: number;\n    operationsPerformed: number;\n  };\n}\n\nexport interface TaskOutputData {\n  taskId: string;\n  name: string;\n  type: string;\n  status: string;\n  assignedAgent?: string;\n  startTime: string;\n  endTime?: string;\n  duration?: number;\n  priority: string;\n  output?: string;\n  result?: TaskResult;\n  artifacts?: Record<string, any>;\n  error?: string;\n}\n\nexport class SwarmJsonOutputAggregator extends EventEmitter {\n  private logger: Logger;\n  private swarmId: string;\n  private objective: string;\n  private startTime: Date;\n  private endTime?: Date;\n  private configuration: Record<string, any>;\n\n  // Data collection\n  private agents: Map<string, AgentOutputData> = new Map();\n  private tasks: Map<string, TaskOutputData> = new Map();\n  private outputs: string[] = [];\n  private errors: string[] = [];\n  private insights: string[] = [];\n  private artifacts: Record<string, any> = {};\n  private metrics: SwarmMetrics = this.initializeMetrics();\n\n  constructor(swarmId: string, objective: string, configuration: Record<string, any> = {}) {\n    super();\n    this.swarmId = swarmId;\n    this.objective = objective;\n    this.configuration = configuration;\n    this.startTime = new Date();\n\n    this.logger = new Logger(\n      { level: 'info', format: 'json', destination: 'console' },\n      { component: 'SwarmJsonAggregator' },\n    );\n\n    this.logger.info('JSON output aggregator initialized', {\n      swarmId,\n      objective,\n      timestamp: this.startTime.toISOString(),\n    });\n  }\n\n  // Agent tracking methods\n  addAgent(agent: AgentState): void {\n    // Handle null/undefined agent IDs gracefully\n    if (!agent || !agent.id) {\n      this.logger.warn('Attempted to add agent with null/undefined ID, skipping');\n      return;\n    }\n\n    const agentIdStr = typeof agent.id === 'string' ? agent.id : agent.id.id;\n    const agentData: AgentOutputData = {\n      agentId: agentIdStr,\n      name: agent.name || agentIdStr,\n      type: agent.type,\n      status: agent.status,\n      startTime: new Date().toISOString(),\n      tasksCompleted: 0,\n      outputs: [],\n      errors: [],\n      metrics: {\n        memoryAccess: 0,\n        operationsPerformed: 0,\n      },\n    };\n\n    this.agents.set(agentIdStr, agentData);\n    this.logger.debug('Agent added to output tracking', { agentId: agentIdStr });\n  }\n\n  updateAgent(agentId: string, updates: Partial<AgentOutputData>): void {\n    const agent = this.agents.get(agentId);\n    if (agent) {\n      Object.assign(agent, updates);\n      this.logger.debug('Agent updated in output tracking', { agentId, updates });\n    }\n  }\n\n  addAgentOutput(agentId: string, output: string): void {\n    const agent = this.agents.get(agentId);\n    if (agent) {\n      agent.outputs.push(output);\n      agent.metrics.operationsPerformed++;\n    }\n    this.outputs.push(`[${agentId}] ${output}`);\n  }\n\n  addAgentError(agentId: string, error: string): void {\n    const agent = this.agents.get(agentId);\n    if (agent) {\n      agent.errors.push(error);\n    }\n    this.errors.push(`[${agentId}] ${error}`);\n  }\n\n  // Task tracking methods\n  addTask(task: TaskDefinition): void {\n    // Handle null/undefined task IDs gracefully\n    if (!task || !task.id) {\n      this.logger.warn('Attempted to add task with null/undefined ID, skipping');\n      return;\n    }\n\n    const taskIdStr = typeof task.id === 'string' ? task.id : task.id.id;\n    const taskData: TaskOutputData = {\n      taskId: taskIdStr,\n      name: task.name || taskIdStr,\n      type: task.type,\n      status: task.status,\n      assignedAgent: task.assignedAt\n        ? typeof task.assignedAt === 'string'\n          ? task.assignedAt\n          : task.assignedAt.toString()\n        : undefined,\n      startTime: new Date().toISOString(),\n      priority: task.priority || 'normal',\n    };\n\n    this.tasks.set(taskIdStr, taskData);\n    this.logger.debug('Task added to output tracking', { taskId: taskIdStr });\n  }\n\n  updateTask(taskId: string, updates: Partial<TaskOutputData>): void {\n    const task = this.tasks.get(taskId);\n    if (task) {\n      Object.assign(task, updates);\n      this.logger.debug('Task updated in output tracking', { taskId, updates });\n    }\n  }\n\n  completeTask(taskId: string, result: TaskResult): void {\n    const task = this.tasks.get(taskId);\n    if (task) {\n      task.status = 'completed';\n      task.endTime = new Date().toISOString();\n      task.duration = task.startTime ? Date.now() - new Date(task.startTime).getTime() : 0;\n      task.result = result;\n      task.output = result.output;\n      task.artifacts = result.artifacts;\n\n      // Update agent completion count\n      if (task.assignedAgent) {\n        const agent = this.agents.get(task.assignedAgent);\n        if (agent) {\n          agent.tasksCompleted++;\n        }\n      }\n    }\n  }\n\n  // Global tracking methods\n  addInsight(insight: string): void {\n    this.insights.push(insight);\n    this.logger.debug('Insight added', { insight });\n  }\n\n  addArtifact(key: string, artifact: any): void {\n    this.artifacts[key] = artifact;\n    this.logger.debug('Artifact added', { key });\n  }\n\n  updateMetrics(updates: Partial<SwarmMetrics>): void {\n    Object.assign(this.metrics, updates);\n  }\n\n  // Finalization and output\n  finalize(\n    status: 'completed' | 'failed' | 'timeout' | 'cancelled' = 'completed',\n  ): SwarmOutputAggregate {\n    this.endTime = new Date();\n    const duration = this.endTime.getTime() - this.startTime.getTime();\n\n    // Calculate summary statistics\n    const totalTasks = this.tasks.size;\n    const completedTasks = Array.from(this.tasks.values()).filter(\n      (task) => task.status === 'completed',\n    ).length;\n    const failedTasks = Array.from(this.tasks.values()).filter(\n      (task) => task.status === 'failed',\n    ).length;\n    const successRate = totalTasks > 0 ? completedTasks / totalTasks : 0;\n\n    // Finalize agent data\n    this.agents.forEach((agent) => {\n      if (!agent.endTime) {\n        agent.endTime = this.endTime.toISOString();\n        agent.duration = Date.now() - new Date(agent.startTime).getTime();\n      }\n    });\n\n    const aggregate: SwarmOutputAggregate = {\n      swarmId: this.swarmId,\n      objective: this.objective,\n      startTime: this.startTime.toISOString(),\n      endTime: this.endTime.toISOString(),\n      duration,\n      status,\n      summary: {\n        totalAgents: this.agents.size,\n        totalTasks,\n        completedTasks,\n        failedTasks,\n        successRate,\n      },\n      agents: Array.from(this.agents.values()),\n      tasks: Array.from(this.tasks.values()),\n      results: {\n        artifacts: this.artifacts,\n        outputs: this.outputs,\n        errors: this.errors,\n        insights: this.insights,\n      },\n      metrics: this.metrics,\n      metadata: {\n        strategy: this.configuration.strategy || 'auto',\n        mode: this.configuration.mode || 'centralized',\n        configuration: this.configuration,\n        version: '2.0.0-alpha',\n      },\n    };\n\n    this.logger.info('Swarm output aggregation finalized', {\n      swarmId: this.swarmId,\n      status,\n      duration,\n      summary: aggregate.summary,\n    });\n\n    return aggregate;\n  }\n\n  async saveToFile(\n    filePath: string,\n    status: 'completed' | 'failed' | 'timeout' | 'cancelled' = 'completed',\n  ): Promise<void> {\n    const aggregate = this.finalize(status);\n    const json = JSON.stringify(aggregate, this.circularReplacer(), 2);\n    await fs.writeFile(filePath, json, 'utf8');\n    this.logger.info('Swarm output saved to file', { filePath, size: json.length });\n  }\n\n  getJsonOutput(status: 'completed' | 'failed' | 'timeout' | 'cancelled' = 'completed'): string {\n    const aggregate = this.finalize(status);\n    return JSON.stringify(aggregate, this.circularReplacer(), 2);\n  }\n\n  // Handle circular references in JSON serialization\n  private circularReplacer(): (key: string, value: any) => any {\n    const seen = new WeakSet();\n    return (key: string, value: any) => {\n      if (typeof value === 'object' && value !== null) {\n        if (seen.has(value)) {\n          return '[Circular]';\n        }\n        seen.add(value);\n      }\n      return value;\n    };\n  }\n\n  private initializeMetrics(): SwarmMetrics {\n    return {\n      // Performance metrics\n      throughput: 0,\n      latency: 0,\n      efficiency: 0,\n      reliability: 0,\n\n      // Quality metrics\n      averageQuality: 0,\n      defectRate: 0,\n      reworkRate: 0,\n\n      // Resource metrics\n      resourceUtilization: {\n        cpu: 0,\n        memory: 0,\n        disk: 0,\n        network: 0,\n      },\n      costEfficiency: 0,\n\n      // Agent metrics\n      agentUtilization: 0,\n      agentSatisfaction: 0,\n      collaborationEffectiveness: 0,\n\n      // Timeline metrics\n      scheduleVariance: 0,\n      deadlineAdherence: 0,\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["fs"]
}

{"version":3,"sources":["../../../../src/mcp/protocol/version-negotiation.ts"],"sourcesContent":["/**\r\n * MCP 2025-11 Version Negotiation Protocol\r\n *\r\n * Implements version negotiation and capability exchange\r\n * per MCP 2025-11 specification\r\n */\r\n\r\nimport type { ILogger } from '../../interfaces/logger.js';\r\n\r\n/**\r\n * MCP version in YYYY-MM format\r\n */\r\nexport type MCPVersion = '2025-11' | '2024-11' | '2024-10';\r\n\r\n/**\r\n * MCP capability flags\r\n */\r\nexport type MCPCapability =\r\n  | 'async'       // Job handles, poll/resume\r\n  | 'registry'    // Self-registration\r\n  | 'code_exec'   // External code execution\r\n  | 'stream'      // Streaming output\r\n  | 'sandbox'     // Isolated execution\r\n  | 'schema_ref'; // Shared schema references\r\n\r\n/**\r\n * MCP handshake request/response\r\n */\r\nexport interface MCPHandshake {\r\n  mcp_version: MCPVersion;\r\n  client_id?: string;\r\n  server_id?: string;\r\n  transport: 'stdio' | 'http' | 'ws';\r\n  capabilities: MCPCapability[];\r\n  metadata?: {\r\n    name?: string;\r\n    version?: string;\r\n    description?: string;\r\n  };\r\n}\r\n\r\n/**\r\n * Version negotiation result\r\n */\r\nexport interface NegotiationResult {\r\n  success: boolean;\r\n  agreed_version: MCPVersion;\r\n  agreed_capabilities: MCPCapability[];\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Version negotiation errors\r\n */\r\nexport class VersionNegotiationError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public code: 'VERSION_MISMATCH' | 'UNSUPPORTED_CAPABILITY' | 'INVALID_HANDSHAKE'\r\n  ) {\r\n    super(message);\r\n    this.name = 'VersionNegotiationError';\r\n  }\r\n}\r\n\r\n/**\r\n * MCP Version Negotiator\r\n *\r\n * Handles version compatibility checking and capability negotiation\r\n */\r\nexport class VersionNegotiator {\r\n  // Supported versions in order of preference\r\n  private supportedVersions: MCPVersion[] = ['2025-11', '2024-11'];\r\n\r\n  // Current server version\r\n  private serverVersion: MCPVersion = '2025-11';\r\n\r\n  // Server capabilities\r\n  private serverCapabilities: MCPCapability[] = [\r\n    'async',\r\n    'registry',\r\n    'code_exec',\r\n    'stream',\r\n  ];\r\n\r\n  constructor(private logger: ILogger) {}\r\n\r\n  /**\r\n   * Negotiate version with client\r\n   */\r\n  async negotiate(clientHandshake: MCPHandshake): Promise<NegotiationResult> {\r\n    this.logger.info('Starting version negotiation', {\r\n      clientVersion: clientHandshake.mcp_version,\r\n      serverVersion: this.serverVersion,\r\n      clientCapabilities: clientHandshake.capabilities,\r\n    });\r\n\r\n    // Validate handshake structure\r\n    if (!this.isValidHandshake(clientHandshake)) {\r\n      return {\r\n        success: false,\r\n        agreed_version: this.serverVersion,\r\n        agreed_capabilities: [],\r\n        error: 'Invalid handshake structure',\r\n      };\r\n    }\r\n\r\n    // Check version compatibility\r\n    const versionResult = this.checkVersionCompatibility(clientHandshake.mcp_version);\r\n    if (!versionResult.compatible) {\r\n      return {\r\n        success: false,\r\n        agreed_version: this.serverVersion,\r\n        agreed_capabilities: [],\r\n        error: versionResult.error,\r\n      };\r\n    }\r\n\r\n    // Negotiate capabilities\r\n    const agreedCapabilities = this.negotiateCapabilities(\r\n      clientHandshake.capabilities\r\n    );\r\n\r\n    this.logger.info('Version negotiation successful', {\r\n      agreedVersion: versionResult.version,\r\n      agreedCapabilities,\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      agreed_version: versionResult.version,\r\n      agreed_capabilities: agreedCapabilities,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check if handshake is valid\r\n   */\r\n  private isValidHandshake(handshake: MCPHandshake): boolean {\r\n    return !!(\r\n      handshake.mcp_version &&\r\n      handshake.transport &&\r\n      Array.isArray(handshake.capabilities)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Check version compatibility\r\n   */\r\n  private checkVersionCompatibility(clientVersion: MCPVersion): {\r\n    compatible: boolean;\r\n    version: MCPVersion;\r\n    error?: string;\r\n  } {\r\n    // Exact match - best case\r\n    if (clientVersion === this.serverVersion) {\r\n      return { compatible: true, version: clientVersion };\r\n    }\r\n\r\n    // Check if client version is supported\r\n    if (this.supportedVersions.includes(clientVersion)) {\r\n      this.logger.warn('Client using older version, but compatible', {\r\n        clientVersion,\r\n        serverVersion: this.serverVersion,\r\n      });\r\n      return { compatible: true, version: clientVersion };\r\n    }\r\n\r\n    // Check version gap\r\n    const clientDate = this.parseVersion(clientVersion);\r\n    const serverDate = this.parseVersion(this.serverVersion);\r\n    const monthsDiff = this.getMonthsDifference(clientDate, serverDate);\r\n\r\n    // Reject if more than 1 cycle (1 month) difference\r\n    if (Math.abs(monthsDiff) > 1) {\r\n      return {\r\n        compatible: false,\r\n        version: this.serverVersion,\r\n        error: `Version mismatch: client ${clientVersion}, server ${this.serverVersion}. Difference exceeds 1 cycle.`,\r\n      };\r\n    }\r\n\r\n    // Accept with warning for small differences\r\n    this.logger.warn('Version close enough, accepting', {\r\n      clientVersion,\r\n      serverVersion: this.serverVersion,\r\n      monthsDiff,\r\n    });\r\n    return { compatible: true, version: this.serverVersion };\r\n  }\r\n\r\n  /**\r\n   * Negotiate capabilities between client and server\r\n   */\r\n  private negotiateCapabilities(\r\n    clientCapabilities: MCPCapability[]\r\n  ): MCPCapability[] {\r\n    // Return intersection of client and server capabilities\r\n    return clientCapabilities.filter(cap =>\r\n      this.serverCapabilities.includes(cap)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Parse version string to date\r\n   */\r\n  private parseVersion(version: MCPVersion): Date {\r\n    const [year, month] = version.split('-').map(Number);\r\n    return new Date(year, month - 1, 1);\r\n  }\r\n\r\n  /**\r\n   * Calculate months difference between dates\r\n   */\r\n  private getMonthsDifference(date1: Date, date2: Date): number {\r\n    const months = (date2.getFullYear() - date1.getFullYear()) * 12;\r\n    return months + date2.getMonth() - date1.getMonth();\r\n  }\r\n\r\n  /**\r\n   * Create server handshake response\r\n   */\r\n  createServerHandshake(\r\n    serverId: string,\r\n    transport: 'stdio' | 'http' | 'ws',\r\n    metadata?: MCPHandshake['metadata']\r\n  ): MCPHandshake {\r\n    return {\r\n      mcp_version: this.serverVersion,\r\n      server_id: serverId,\r\n      transport,\r\n      capabilities: this.serverCapabilities,\r\n      metadata,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get current server version\r\n   */\r\n  getServerVersion(): MCPVersion {\r\n    return this.serverVersion;\r\n  }\r\n\r\n  /**\r\n   * Get server capabilities\r\n   */\r\n  getServerCapabilities(): MCPCapability[] {\r\n    return [...this.serverCapabilities];\r\n  }\r\n\r\n  /**\r\n   * Check if capability is supported\r\n   */\r\n  hasCapability(capability: MCPCapability): boolean {\r\n    return this.serverCapabilities.includes(capability);\r\n  }\r\n\r\n  /**\r\n   * Add capability (dynamic capability registration)\r\n   */\r\n  addCapability(capability: MCPCapability): void {\r\n    if (!this.serverCapabilities.includes(capability)) {\r\n      this.serverCapabilities.push(capability);\r\n      this.logger.info('Capability added', { capability });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove capability\r\n   */\r\n  removeCapability(capability: MCPCapability): void {\r\n    const index = this.serverCapabilities.indexOf(capability);\r\n    if (index > -1) {\r\n      this.serverCapabilities.splice(index, 1);\r\n      this.logger.info('Capability removed', { capability });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Backward compatibility helper\r\n * Converts legacy requests to MCP 2025-11 format\r\n */\r\nexport class BackwardCompatibilityAdapter {\r\n  constructor(private logger: ILogger) {}\r\n\r\n  /**\r\n   * Detect if request is legacy format\r\n   */\r\n  isLegacyRequest(request: any): boolean {\r\n    // Legacy requests don't have mcp_version field\r\n    return !request.mcp_version || request.version;\r\n  }\r\n\r\n  /**\r\n   * Convert legacy request to MCP 2025-11 format\r\n   */\r\n  convertToModern(legacyRequest: any): MCPHandshake {\r\n    this.logger.info('Converting legacy request to MCP 2025-11 format');\r\n\r\n    return {\r\n      mcp_version: '2025-11',\r\n      client_id: legacyRequest.clientId || 'legacy-client',\r\n      transport: legacyRequest.transport || 'stdio',\r\n      capabilities: legacyRequest.capabilities || [],\r\n      metadata: {\r\n        name: legacyRequest.name || 'Legacy Client',\r\n        version: legacyRequest.version || '1.0.0',\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Convert modern response to legacy format if needed\r\n   */\r\n  convertToLegacy(modernResponse: any, requestedLegacy: boolean): any {\r\n    if (!requestedLegacy) {\r\n      return modernResponse;\r\n    }\r\n\r\n    this.logger.info('Converting response to legacy format');\r\n\r\n    return {\r\n      version: modernResponse.mcp_version,\r\n      serverId: modernResponse.server_id,\r\n      capabilities: modernResponse.capabilities,\r\n      ...modernResponse,\r\n    };\r\n  }\r\n}\r\n"],"names":["VersionNegotiationError","Error","message","code","name","VersionNegotiator","supportedVersions","serverVersion","serverCapabilities","logger","negotiate","clientHandshake","info","clientVersion","mcp_version","clientCapabilities","capabilities","isValidHandshake","success","agreed_version","agreed_capabilities","error","versionResult","checkVersionCompatibility","compatible","agreedCapabilities","negotiateCapabilities","agreedVersion","version","handshake","transport","Array","isArray","includes","warn","clientDate","parseVersion","serverDate","monthsDiff","getMonthsDifference","Math","abs","filter","cap","year","month","split","map","Number","Date","date1","date2","months","getFullYear","getMonth","createServerHandshake","serverId","metadata","server_id","getServerVersion","getServerCapabilities","hasCapability","capability","addCapability","push","removeCapability","index","indexOf","splice","BackwardCompatibilityAdapter","isLegacyRequest","request","convertToModern","legacyRequest","client_id","clientId","convertToLegacy","modernResponse","requestedLegacy"],"mappings":"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"}
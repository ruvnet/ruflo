{"version":3,"sources":["../../../src/enterprise/analytics-manager.ts"],"sourcesContent":["import { EventEmitter } from 'events';\r\nimport { writeFile, readFile, mkdir, readdir } from 'fs/promises';\r\nimport { join } from 'path';\r\nimport { Logger } from '../core/logger.js';\r\nimport { ConfigManager } from '../core/config.js';\r\n\r\nexport interface AnalyticsMetric {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  type: 'counter' | 'gauge' | 'histogram' | 'summary';\r\n  category: 'performance' | 'usage' | 'business' | 'technical' | 'security' | 'cost';\r\n  unit: string;\r\n  value: number;\r\n  tags: Record<string, string>;\r\n  timestamp: Date;\r\n  source: string;\r\n  metadata: Record<string, any>;\r\n}\r\n\r\nexport interface AnalyticsDashboard {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  type: 'operational' | 'executive' | 'technical' | 'business' | 'security' | 'custom';\r\n  widgets: DashboardWidget[];\r\n  layout: DashboardLayout;\r\n  permissions: {\r\n    viewers: string[];\r\n    editors: string[];\r\n    public: boolean;\r\n  };\r\n  schedule: {\r\n    autoRefresh: boolean;\r\n    refreshInterval: number; // seconds\r\n    exportSchedule?: {\r\n      frequency: 'daily' | 'weekly' | 'monthly';\r\n      format: 'pdf' | 'png' | 'csv' | 'json';\r\n      recipients: string[];\r\n    };\r\n  };\r\n  filters: DashboardFilter[];\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  createdBy: string;\r\n}\r\n\r\nexport interface DashboardWidget {\r\n  id: string;\r\n  title: string;\r\n  type: 'chart' | 'table' | 'metric' | 'gauge' | 'map' | 'text' | 'alert';\r\n  size: 'small' | 'medium' | 'large' | 'full-width';\r\n  position: { x: number; y: number; width: number; height: number };\r\n  dataSource: {\r\n    query: string;\r\n    metrics: string[];\r\n    aggregation: 'sum' | 'avg' | 'min' | 'max' | 'count' | 'p95' | 'p99';\r\n    timeRange: string;\r\n    groupBy: string[];\r\n  };\r\n  visualization: {\r\n    chartType?: 'line' | 'bar' | 'pie' | 'scatter' | 'heatmap' | 'area';\r\n    options: Record<string, any>;\r\n    thresholds?: {\r\n      warning: number;\r\n      critical: number;\r\n    };\r\n  };\r\n  alerts: {\r\n    enabled: boolean;\r\n    conditions: AlertCondition[];\r\n  };\r\n}\r\n\r\nexport interface DashboardLayout {\r\n  columns: number;\r\n  rows: number;\r\n  grid: boolean;\r\n  responsive: boolean;\r\n}\r\n\r\nexport interface DashboardFilter {\r\n  id: string;\r\n  name: string;\r\n  type: 'dropdown' | 'multiselect' | 'daterange' | 'text' | 'number';\r\n  field: string;\r\n  values?: string[];\r\n  defaultValue?: any;\r\n  required: boolean;\r\n}\r\n\r\nexport interface AlertCondition {\r\n  metric: string;\r\n  operator: '>' | '<' | '>=' | '<=' | '==' | '!=';\r\n  threshold: number;\r\n  duration: number; // seconds\r\n  severity: 'info' | 'warning' | 'critical';\r\n}\r\n\r\nexport interface AnalyticsInsight {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  type: 'anomaly' | 'trend' | 'correlation' | 'prediction' | 'recommendation';\r\n  category: 'performance' | 'usage' | 'business' | 'technical' | 'security' | 'cost';\r\n  confidence: number; // 0-100\r\n  impact: 'low' | 'medium' | 'high';\r\n  priority: 'low' | 'medium' | 'high' | 'critical';\r\n  data: {\r\n    metrics: string[];\r\n    timeRange: { start: Date; end: Date };\r\n    values: Record<string, number>;\r\n    baseline?: Record<string, number>;\r\n    deviation?: number;\r\n  };\r\n  recommendations: {\r\n    action: string;\r\n    effort: 'low' | 'medium' | 'high';\r\n    impact: string;\r\n    implementation: string[];\r\n  }[];\r\n  status: 'new' | 'acknowledged' | 'investigating' | 'resolved' | 'dismissed';\r\n  assignedTo?: string;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  expiresAt?: Date;\r\n}\r\n\r\nexport interface PerformanceMetrics {\r\n  system: {\r\n    cpu: {\r\n      usage: number;\r\n      cores: number;\r\n      loadAverage: number[];\r\n    };\r\n    memory: {\r\n      used: number;\r\n      free: number;\r\n      total: number;\r\n      usage: number;\r\n    };\r\n    disk: {\r\n      used: number;\r\n      free: number;\r\n      total: number;\r\n      usage: number;\r\n      iops: number;\r\n    };\r\n    network: {\r\n      bytesIn: number;\r\n      bytesOut: number;\r\n      packetsIn: number;\r\n      packetsOut: number;\r\n      errors: number;\r\n    };\r\n  };\r\n  application: {\r\n    responseTime: {\r\n      avg: number;\r\n      p50: number;\r\n      p95: number;\r\n      p99: number;\r\n    };\r\n    throughput: {\r\n      requestsPerSecond: number;\r\n      transactionsPerSecond: number;\r\n    };\r\n    errors: {\r\n      rate: number;\r\n      count: number;\r\n      types: Record<string, number>;\r\n    };\r\n    availability: {\r\n      uptime: number;\r\n      sla: number;\r\n      incidents: number;\r\n    };\r\n  };\r\n  database: {\r\n    connections: {\r\n      active: number;\r\n      idle: number;\r\n      max: number;\r\n    };\r\n    queries: {\r\n      avgExecutionTime: number;\r\n      slowQueries: number;\r\n      deadlocks: number;\r\n    };\r\n    storage: {\r\n      size: number;\r\n      growth: number;\r\n      fragmentation: number;\r\n    };\r\n  };\r\n  infrastructure: {\r\n    containers: {\r\n      running: number;\r\n      stopped: number;\r\n      restarts: number;\r\n    };\r\n    services: {\r\n      healthy: number;\r\n      unhealthy: number;\r\n      degraded: number;\r\n    };\r\n  };\r\n}\r\n\r\nexport interface UsageMetrics {\r\n  users: {\r\n    total: number;\r\n    active: number;\r\n    new: number;\r\n    returning: number;\r\n    churn: number;\r\n  };\r\n  sessions: {\r\n    total: number;\r\n    duration: {\r\n      avg: number;\r\n      median: number;\r\n    };\r\n    bounceRate: number;\r\n    pagesPerSession: number;\r\n  };\r\n  features: {\r\n    adoption: Record<\r\n      string,\r\n      {\r\n        users: number;\r\n        usage: number;\r\n        retention: number;\r\n      }\r\n    >;\r\n    mostUsed: string[];\r\n    leastUsed: string[];\r\n  };\r\n  api: {\r\n    calls: number;\r\n    uniqueConsumers: number;\r\n    avgResponseTime: number;\r\n    errorRate: number;\r\n    rateLimits: {\r\n      hit: number;\r\n      consumed: number;\r\n    };\r\n  };\r\n  content: {\r\n    created: number;\r\n    modified: number;\r\n    deleted: number;\r\n    views: number;\r\n  };\r\n}\r\n\r\nexport interface BusinessMetrics {\r\n  revenue: {\r\n    total: number;\r\n    recurring: number;\r\n    growth: number;\r\n    arpu: number; // Average Revenue Per User\r\n    ltv: number; // Lifetime Value\r\n  };\r\n  customers: {\r\n    total: number;\r\n    new: number;\r\n    retained: number;\r\n    churned: number;\r\n    satisfaction: number;\r\n  };\r\n  conversion: {\r\n    leads: number;\r\n    qualified: number;\r\n    opportunities: number;\r\n    closed: number;\r\n    rate: number;\r\n  };\r\n  support: {\r\n    tickets: number;\r\n    resolved: number;\r\n    avgResolutionTime: number;\r\n    satisfaction: number;\r\n  };\r\n}\r\n\r\nexport interface PredictiveModel {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  type: 'regression' | 'classification' | 'time-series' | 'anomaly-detection';\r\n  algorithm: string;\r\n  features: string[];\r\n  target: string;\r\n  accuracy: number;\r\n  confidence: number;\r\n  trainedAt: Date;\r\n  lastPrediction?: Date;\r\n  trainingData: {\r\n    samples: number;\r\n    features: number;\r\n    timeRange: { start: Date; end: Date };\r\n  };\r\n  performance: {\r\n    precision: number;\r\n    recall: number;\r\n    f1Score: number;\r\n    mse?: number;\r\n    mae?: number;\r\n  };\r\n  predictions: PredictionResult[];\r\n  status: 'training' | 'ready' | 'needs-retraining' | 'error';\r\n}\r\n\r\nexport interface PredictionResult {\r\n  id: string;\r\n  modelId: string;\r\n  input: Record<string, any>;\r\n  prediction: any;\r\n  confidence: number;\r\n  timestamp: Date;\r\n  actual?: any; // For validation\r\n  accuracy?: number;\r\n}\r\n\r\nexport interface AnalyticsReport {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  type: 'performance' | 'usage' | 'business' | 'security' | 'compliance' | 'custom';\r\n  format: 'pdf' | 'html' | 'csv' | 'json' | 'xlsx';\r\n  schedule: {\r\n    frequency: 'manual' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'quarterly';\r\n    time?: string;\r\n    timezone?: string;\r\n    recipients: string[];\r\n  };\r\n  sections: ReportSection[];\r\n  filters: Record<string, any>;\r\n  lastGenerated?: Date;\r\n  nextGeneration?: Date;\r\n  generatedBy: string;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface ReportSection {\r\n  id: string;\r\n  title: string;\r\n  type: 'summary' | 'chart' | 'table' | 'text' | 'metrics';\r\n  content: {\r\n    query?: string;\r\n    visualization?: any;\r\n    text?: string;\r\n    metrics?: string[];\r\n  };\r\n  order: number;\r\n}\r\n\r\nexport interface AnalyticsConfiguration {\r\n  collection: {\r\n    enabled: boolean;\r\n    samplingRate: number;\r\n    batchSize: number;\r\n    flushInterval: number;\r\n  };\r\n  storage: {\r\n    retention: {\r\n      raw: string; // e.g., '7d'\r\n      aggregated: string; // e.g., '90d'\r\n      summary: string; // e.g., '1y'\r\n    };\r\n    compression: boolean;\r\n    encryption: boolean;\r\n  };\r\n  processing: {\r\n    realTime: boolean;\r\n    batchProcessing: boolean;\r\n    aggregationIntervals: string[];\r\n  };\r\n  alerts: {\r\n    enabled: boolean;\r\n    channels: string[];\r\n    escalation: {\r\n      levels: number;\r\n      intervals: number[];\r\n    };\r\n  };\r\n  privacy: {\r\n    anonymization: boolean;\r\n    gdprCompliant: boolean;\r\n    dataMinimization: boolean;\r\n  };\r\n  integrations: {\r\n    grafana?: { url: string; apiKey: string };\r\n    prometheus?: { url: string };\r\n    elasticsearch?: { url: string; index: string };\r\n    splunk?: { url: string; token: string };\r\n  };\r\n}\r\n\r\nexport class AnalyticsManager extends EventEmitter {\r\n  private metrics: Map<string, AnalyticsMetric[]> = new Map();\r\n  private dashboards: Map<string, AnalyticsDashboard> = new Map();\r\n  private insights: Map<string, AnalyticsInsight> = new Map();\r\n  private models: Map<string, PredictiveModel> = new Map();\r\n  private reports: Map<string, AnalyticsReport> = new Map();\r\n  private analyticsPath: string;\r\n  private logger: Logger;\r\n  private config: ConfigManager;\r\n  private configuration: AnalyticsConfiguration;\r\n\r\n  constructor(analyticsPath: string = './analytics', logger?: Logger, config?: ConfigManager) {\r\n    super();\r\n    this.analyticsPath = analyticsPath;\r\n    this.logger = logger || new Logger({ level: 'info', format: 'text', destination: 'console' });\r\n    this.config = config || ConfigManager.getInstance();\r\n    this.configuration = this.getDefaultConfiguration();\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    try {\r\n      await mkdir(this.analyticsPath, { recursive: true });\r\n      await mkdir(join(this.analyticsPath, 'metrics'), { recursive: true });\r\n      await mkdir(join(this.analyticsPath, 'dashboards'), { recursive: true });\r\n      await mkdir(join(this.analyticsPath, 'insights'), { recursive: true });\r\n      await mkdir(join(this.analyticsPath, 'models'), { recursive: true });\r\n      await mkdir(join(this.analyticsPath, 'reports'), { recursive: true });\r\n\r\n      await this.loadConfigurations();\r\n      await this.initializeDefaultDashboards();\r\n      await this.startMetricsCollection();\r\n\r\n      this.logger.info('Analytics Manager initialized successfully');\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize Analytics Manager', { error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async recordMetric(metric: Omit<AnalyticsMetric, 'id' | 'timestamp'>): Promise<void> {\r\n    const fullMetric: AnalyticsMetric = {\r\n      id: `metric-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: new Date(),\r\n      ...metric,\r\n    };\r\n\r\n    const key = `${metric.category}-${metric.name}`;\r\n    if (!this.metrics.has(key)) {\r\n      this.metrics.set(key, []);\r\n    }\r\n\r\n    const metricArray = this.metrics.get(key)!;\r\n    metricArray.push(fullMetric);\r\n\r\n    // Keep only recent metrics in memory (configurable retention)\r\n    const retentionPeriod = 24 * 60 * 60 * 1000; // 24 hours\r\n    const cutoff = Date.now() - retentionPeriod;\r\n    const filteredMetrics = metricArray.filter((m) => m.timestamp.getTime() > cutoff);\r\n    this.metrics.set(key, filteredMetrics);\r\n\r\n    // Persist to disk for longer-term storage\r\n    await this.persistMetric(fullMetric);\r\n\r\n    this.emit('metric:recorded', fullMetric);\r\n\r\n    // Check for anomalies and generate insights\r\n    await this.checkForAnomalies(key, fullMetric);\r\n  }\r\n\r\n  async queryMetrics(query: {\r\n    metrics: string[];\r\n    timeRange: { start: Date; end: Date };\r\n    aggregation?: 'sum' | 'avg' | 'min' | 'max' | 'count' | 'p95' | 'p99';\r\n    groupBy?: string[];\r\n    filters?: Record<string, any>;\r\n  }): Promise<Record<string, any[]>> {\r\n    const results: Record<string, any[]> = {};\r\n\r\n    for (const metricName of query.metrics) {\r\n      const key = metricName.includes('-') ? metricName : `*-${metricName}`;\r\n      const matchingKeys = Array.from(this.metrics.keys()).filter(\r\n        (k) => key === '*' || k.includes(key.replace('*-', '')) || k === key,\r\n      );\r\n\r\n      let allMetrics: AnalyticsMetric[] = [];\r\n      for (const k of matchingKeys) {\r\n        const keyMetrics = this.metrics.get(k) || [];\r\n        allMetrics.push(...keyMetrics);\r\n      }\r\n\r\n      // Filter by time range\r\n      allMetrics = allMetrics.filter(\r\n        (m) => m.timestamp >= query.timeRange.start && m.timestamp <= query.timeRange.end,\r\n      );\r\n\r\n      // Apply filters\r\n      if (query.filters) {\r\n        for (const [field, value] of Object.entries(query.filters)) {\r\n          allMetrics = allMetrics.filter((m) => {\r\n            if (field === 'tags') {\r\n              return Object.entries(value as Record<string, string>).every(\r\n                ([k, v]) => m.tags[k] === v,\r\n              );\r\n            }\r\n            return (m as any)[field] === value;\r\n          });\r\n        }\r\n      }\r\n\r\n      // Group by if specified\r\n      if (query.groupBy && query.groupBy.length > 0) {\r\n        const grouped = this.groupMetrics(allMetrics, query.groupBy);\r\n        for (const [group, metrics] of Object.entries(grouped)) {\r\n          const aggregated = this.aggregateMetrics(metrics, query.aggregation || 'avg');\r\n          results[`${metricName}-${group}`] = aggregated;\r\n        }\r\n      } else {\r\n        const aggregated = this.aggregateMetrics(allMetrics, query.aggregation || 'avg');\r\n        results[metricName] = aggregated;\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  async createDashboard(dashboardData: {\r\n    name: string;\r\n    description: string;\r\n    type: AnalyticsDashboard['type'];\r\n    widgets: Omit<DashboardWidget, 'id'>[];\r\n    permissions?: Partial<AnalyticsDashboard['permissions']>;\r\n  }): Promise<AnalyticsDashboard> {\r\n    const dashboard: AnalyticsDashboard = {\r\n      id: `dashboard-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: dashboardData.name,\r\n      description: dashboardData.description,\r\n      type: dashboardData.type,\r\n      widgets: dashboardData.widgets.map((widget, index) => ({\r\n        id: `widget-${Date.now()}-${index}`,\r\n        ...widget,\r\n      })),\r\n      layout: {\r\n        columns: 12,\r\n        rows: 8,\r\n        grid: true,\r\n        responsive: true,\r\n      },\r\n      permissions: {\r\n        viewers: [],\r\n        editors: [],\r\n        public: false,\r\n        ...dashboardData.permissions,\r\n      },\r\n      schedule: {\r\n        autoRefresh: true,\r\n        refreshInterval: 30,\r\n      },\r\n      filters: [],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      createdBy: 'system',\r\n    };\r\n\r\n    this.dashboards.set(dashboard.id, dashboard);\r\n    await this.saveDashboard(dashboard);\r\n\r\n    this.emit('dashboard:created', dashboard);\r\n    this.logger.info(`Dashboard created: ${dashboard.name} (${dashboard.id})`);\r\n\r\n    return dashboard;\r\n  }\r\n\r\n  async generateInsights(\r\n    scope: {\r\n      metrics?: string[];\r\n      timeRange?: { start: Date; end: Date };\r\n      categories?: string[];\r\n    } = {},\r\n  ): Promise<AnalyticsInsight[]> {\r\n    const insights: AnalyticsInsight[] = [];\r\n\r\n    // Default time range: last 24 hours\r\n    const timeRange = scope.timeRange || {\r\n      start: new Date(Date.now() - 24 * 60 * 60 * 1000),\r\n      end: new Date(),\r\n    };\r\n\r\n    // Anomaly detection\r\n    const anomalies = await this.detectAnomalies(timeRange, scope.metrics);\r\n    insights.push(...anomalies);\r\n\r\n    // Trend analysis\r\n    const trends = await this.analyzeTrends(timeRange, scope.metrics);\r\n    insights.push(...trends);\r\n\r\n    // Performance insights\r\n    const performance = await this.analyzePerformance(timeRange);\r\n    insights.push(...performance);\r\n\r\n    // Usage insights\r\n    const usage = await this.analyzeUsage(timeRange);\r\n    insights.push(...usage);\r\n\r\n    // Cost optimization insights\r\n    const costOptimizations = await this.analyzeCostOptimization(timeRange);\r\n    insights.push(...costOptimizations);\r\n\r\n    // Store insights\r\n    for (const insight of insights) {\r\n      this.insights.set(insight.id, insight);\r\n      await this.saveInsight(insight);\r\n    }\r\n\r\n    this.emit('insights:generated', { insights, scope });\r\n    this.logger.info(`Generated ${insights.length} insights`);\r\n\r\n    return insights;\r\n  }\r\n\r\n  async trainPredictiveModel(modelConfig: {\r\n    name: string;\r\n    description: string;\r\n    type: PredictiveModel['type'];\r\n    algorithm: string;\r\n    features: string[];\r\n    target: string;\r\n    trainingPeriod: { start: Date; end: Date };\r\n  }): Promise<PredictiveModel> {\r\n    const model: PredictiveModel = {\r\n      id: `model-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: modelConfig.name,\r\n      description: modelConfig.description,\r\n      type: modelConfig.type,\r\n      algorithm: modelConfig.algorithm,\r\n      features: modelConfig.features,\r\n      target: modelConfig.target,\r\n      accuracy: 0,\r\n      confidence: 0,\r\n      trainedAt: new Date(),\r\n      trainingData: {\r\n        samples: 0,\r\n        features: modelConfig.features.length,\r\n        timeRange: modelConfig.trainingPeriod,\r\n      },\r\n      performance: {\r\n        precision: 0,\r\n        recall: 0,\r\n        f1Score: 0,\r\n      },\r\n      predictions: [],\r\n      status: 'training',\r\n    };\r\n\r\n    try {\r\n      // Collect training data\r\n      const trainingData = await this.collectTrainingData(model);\r\n\r\n      // Train the model (simplified implementation)\r\n      const trained = await this.executeModelTraining(model, trainingData);\r\n\r\n      Object.assign(model, trained);\r\n      model.status = 'ready';\r\n\r\n      this.models.set(model.id, model);\r\n      await this.saveModel(model);\r\n\r\n      this.emit('model:trained', model);\r\n      this.logger.info(\r\n        `Predictive model trained: ${model.name} (${model.id}) - Accuracy: ${model.accuracy}%`,\r\n      );\r\n    } catch (error) {\r\n      model.status = 'error';\r\n      this.logger.error(`Model training failed: ${model.name}`, { error });\r\n      throw error;\r\n    }\r\n\r\n    return model;\r\n  }\r\n\r\n  async makePrediction(modelId: string, input: Record<string, any>): Promise<PredictionResult> {\r\n    const model = this.models.get(modelId);\r\n    if (!model) {\r\n      throw new Error(`Model not found: ${modelId}`);\r\n    }\r\n\r\n    if (model.status !== 'ready') {\r\n      throw new Error(`Model is not ready for predictions: ${model.status}`);\r\n    }\r\n\r\n    // Simple prediction logic (would be replaced with actual ML inference)\r\n    const prediction = await this.executePrediction(model, input);\r\n\r\n    const result: PredictionResult = {\r\n      id: `prediction-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      modelId,\r\n      input,\r\n      prediction: prediction.value,\r\n      confidence: prediction.confidence,\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    model.predictions.push(result);\r\n    model.lastPrediction = new Date();\r\n\r\n    await this.saveModel(model);\r\n\r\n    this.emit('prediction:made', { model, result });\r\n    this.logger.debug(`Prediction made: ${modelId} - ${JSON.stringify(result.prediction)}`);\r\n\r\n    return result;\r\n  }\r\n\r\n  async getPerformanceMetrics(timeRange?: { start: Date; end: Date }): Promise<PerformanceMetrics> {\r\n    const range = timeRange || {\r\n      start: new Date(Date.now() - 60 * 60 * 1000), // Last hour\r\n      end: new Date(),\r\n    };\r\n\r\n    const systemMetrics = await this.queryMetrics({\r\n      metrics: ['cpu-usage', 'memory-usage', 'disk-usage', 'network-io'],\r\n      timeRange: range,\r\n      aggregation: 'avg',\r\n    });\r\n\r\n    const appMetrics = await this.queryMetrics({\r\n      metrics: ['response-time', 'request-rate', 'error-rate', 'uptime'],\r\n      timeRange: range,\r\n      aggregation: 'avg',\r\n    });\r\n\r\n    const dbMetrics = await this.queryMetrics({\r\n      metrics: ['db-connections', 'query-time', 'db-size'],\r\n      timeRange: range,\r\n      aggregation: 'avg',\r\n    });\r\n\r\n    // Construct performance metrics (simplified)\r\n    return {\r\n      system: {\r\n        cpu: {\r\n          usage: this.getLatestValue(systemMetrics['cpu-usage']) || 0,\r\n          cores: 8, // Would be detected from system\r\n          loadAverage: [1.2, 1.5, 1.8], // Would be collected from system\r\n        },\r\n        memory: {\r\n          used: this.getLatestValue(systemMetrics['memory-usage']) || 0,\r\n          free: 4000000000, // Would be calculated\r\n          total: 8000000000,\r\n          usage: 50,\r\n        },\r\n        disk: {\r\n          used: this.getLatestValue(systemMetrics['disk-usage']) || 0,\r\n          free: 100000000000,\r\n          total: 500000000000,\r\n          usage: 20,\r\n          iops: 1000,\r\n        },\r\n        network: {\r\n          bytesIn: 1000000,\r\n          bytesOut: 2000000,\r\n          packetsIn: 5000,\r\n          packetsOut: 6000,\r\n          errors: 5,\r\n        },\r\n      },\r\n      application: {\r\n        responseTime: {\r\n          avg: this.getLatestValue(appMetrics['response-time']) || 0,\r\n          p50: 150,\r\n          p95: 500,\r\n          p99: 1000,\r\n        },\r\n        throughput: {\r\n          requestsPerSecond: this.getLatestValue(appMetrics['request-rate']) || 0,\r\n          transactionsPerSecond: 50,\r\n        },\r\n        errors: {\r\n          rate: this.getLatestValue(appMetrics['error-rate']) || 0,\r\n          count: 10,\r\n          types: { '500': 5, '404': 3, '400': 2 },\r\n        },\r\n        availability: {\r\n          uptime: this.getLatestValue(appMetrics['uptime']) || 0,\r\n          sla: 99.9,\r\n          incidents: 2,\r\n        },\r\n      },\r\n      database: {\r\n        connections: {\r\n          active: 25,\r\n          idle: 75,\r\n          max: 100,\r\n        },\r\n        queries: {\r\n          avgExecutionTime: this.getLatestValue(dbMetrics['query-time']) || 0,\r\n          slowQueries: 5,\r\n          deadlocks: 0,\r\n        },\r\n        storage: {\r\n          size: this.getLatestValue(dbMetrics['db-size']) || 0,\r\n          growth: 1000000, // bytes per day\r\n          fragmentation: 5,\r\n        },\r\n      },\r\n      infrastructure: {\r\n        containers: {\r\n          running: 12,\r\n          stopped: 2,\r\n          restarts: 3,\r\n        },\r\n        services: {\r\n          healthy: 15,\r\n          unhealthy: 1,\r\n          degraded: 0,\r\n        },\r\n      },\r\n    };\r\n  }\r\n\r\n  async getUsageMetrics(timeRange?: { start: Date; end: Date }): Promise<UsageMetrics> {\r\n    const range = timeRange || {\r\n      start: new Date(Date.now() - 24 * 60 * 60 * 1000), // Last 24 hours\r\n      end: new Date(),\r\n    };\r\n\r\n    const usageData = await this.queryMetrics({\r\n      metrics: ['active-users', 'sessions', 'api-calls', 'feature-usage'],\r\n      timeRange: range,\r\n      aggregation: 'sum',\r\n    });\r\n\r\n    return {\r\n      users: {\r\n        total: 10000,\r\n        active: this.getLatestValue(usageData['active-users']) || 0,\r\n        new: 50,\r\n        returning: 1500,\r\n        churn: 25,\r\n      },\r\n      sessions: {\r\n        total: this.getLatestValue(usageData['sessions']) || 0,\r\n        duration: {\r\n          avg: 15 * 60, // 15 minutes\r\n          median: 12 * 60,\r\n        },\r\n        bounceRate: 25,\r\n        pagesPerSession: 4.5,\r\n      },\r\n      features: {\r\n        adoption: {\r\n          dashboard: { users: 800, usage: 5000, retention: 85 },\r\n          reports: { users: 600, usage: 2000, retention: 70 },\r\n          analytics: { users: 400, usage: 1500, retention: 60 },\r\n        },\r\n        mostUsed: ['dashboard', 'reports', 'search'],\r\n        leastUsed: ['advanced-filters', 'export', 'integrations'],\r\n      },\r\n      api: {\r\n        calls: this.getLatestValue(usageData['api-calls']) || 0,\r\n        uniqueConsumers: 150,\r\n        avgResponseTime: 250,\r\n        errorRate: 2.5,\r\n        rateLimits: {\r\n          hit: 5,\r\n          consumed: 75,\r\n        },\r\n      },\r\n      content: {\r\n        created: 100,\r\n        modified: 250,\r\n        deleted: 25,\r\n        views: 5000,\r\n      },\r\n    };\r\n  }\r\n\r\n  async getBusinessMetrics(timeRange?: { start: Date; end: Date }): Promise<BusinessMetrics> {\r\n    // This would integrate with business systems (CRM, billing, etc.)\r\n    return {\r\n      revenue: {\r\n        total: 1000000,\r\n        recurring: 800000,\r\n        growth: 15,\r\n        arpu: 100,\r\n        ltv: 2400,\r\n      },\r\n      customers: {\r\n        total: 500,\r\n        new: 25,\r\n        retained: 450,\r\n        churned: 10,\r\n        satisfaction: 4.2,\r\n      },\r\n      conversion: {\r\n        leads: 1000,\r\n        qualified: 400,\r\n        opportunities: 200,\r\n        closed: 50,\r\n        rate: 5,\r\n      },\r\n      support: {\r\n        tickets: 150,\r\n        resolved: 140,\r\n        avgResolutionTime: 4 * 60 * 60, // 4 hours\r\n        satisfaction: 4.5,\r\n      },\r\n    };\r\n  }\r\n\r\n  // Private helper methods\r\n  private getDefaultConfiguration(): AnalyticsConfiguration {\r\n    return {\r\n      collection: {\r\n        enabled: true,\r\n        samplingRate: 1.0,\r\n        batchSize: 1000,\r\n        flushInterval: 60000,\r\n      },\r\n      storage: {\r\n        retention: {\r\n          raw: '7d',\r\n          aggregated: '90d',\r\n          summary: '1y',\r\n        },\r\n        compression: true,\r\n        encryption: false,\r\n      },\r\n      processing: {\r\n        realTime: true,\r\n        batchProcessing: true,\r\n        aggregationIntervals: ['1m', '5m', '1h', '1d'],\r\n      },\r\n      alerts: {\r\n        enabled: true,\r\n        channels: ['email', 'slack'],\r\n        escalation: {\r\n          levels: 3,\r\n          intervals: [5, 15, 30], // minutes\r\n        },\r\n      },\r\n      privacy: {\r\n        anonymization: true,\r\n        gdprCompliant: true,\r\n        dataMinimization: true,\r\n      },\r\n      integrations: {},\r\n    };\r\n  }\r\n\r\n  private async loadConfigurations(): Promise<void> {\r\n    try {\r\n      // Load dashboards\r\n      const dashboardFiles = await readdir(join(this.analyticsPath, 'dashboards'));\r\n      for (const file of dashboardFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.analyticsPath, 'dashboards', file), 'utf-8');\r\n        const dashboard: AnalyticsDashboard = JSON.parse(content);\r\n        this.dashboards.set(dashboard.id, dashboard);\r\n      }\r\n\r\n      // Load insights\r\n      const insightFiles = await readdir(join(this.analyticsPath, 'insights'));\r\n      for (const file of insightFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.analyticsPath, 'insights', file), 'utf-8');\r\n        const insight: AnalyticsInsight = JSON.parse(content);\r\n        this.insights.set(insight.id, insight);\r\n      }\r\n\r\n      // Load models\r\n      const modelFiles = await readdir(join(this.analyticsPath, 'models'));\r\n      for (const file of modelFiles.filter((f) => f.endsWith('.json'))) {\r\n        const content = await readFile(join(this.analyticsPath, 'models', file), 'utf-8');\r\n        const model: PredictiveModel = JSON.parse(content);\r\n        this.models.set(model.id, model);\r\n      }\r\n\r\n      this.logger.info(\r\n        `Loaded ${this.dashboards.size} dashboards, ${this.insights.size} insights, ${this.models.size} models`,\r\n      );\r\n    } catch (error) {\r\n      this.logger.warn('Failed to load some analytics configurations', { error });\r\n    }\r\n  }\r\n\r\n  private async initializeDefaultDashboards(): Promise<void> {\r\n    const defaultDashboards = [\r\n      {\r\n        name: 'System Performance',\r\n        description: 'Real-time system performance metrics',\r\n        type: 'operational' as const,\r\n        widgets: [\r\n          {\r\n            title: 'CPU Usage',\r\n            type: 'gauge' as const,\r\n            size: 'medium' as const,\r\n            position: { x: 0, y: 0, width: 6, height: 3 },\r\n            dataSource: {\r\n              query: 'cpu-usage',\r\n              metrics: ['cpu-usage'],\r\n              aggregation: 'avg' as const,\r\n              timeRange: '1h',\r\n              groupBy: [],\r\n            },\r\n            visualization: {\r\n              chartType: 'gauge' as const,\r\n              options: { max: 100, unit: '%' },\r\n              thresholds: { warning: 70, critical: 90 },\r\n            },\r\n            alerts: { enabled: true, conditions: [] },\r\n          },\r\n          {\r\n            title: 'Memory Usage',\r\n            type: 'gauge' as const,\r\n            size: 'medium' as const,\r\n            position: { x: 6, y: 0, width: 6, height: 3 },\r\n            dataSource: {\r\n              query: 'memory-usage',\r\n              metrics: ['memory-usage'],\r\n              aggregation: 'avg' as const,\r\n              timeRange: '1h',\r\n              groupBy: [],\r\n            },\r\n            visualization: {\r\n              chartType: 'gauge' as const,\r\n              options: { max: 100, unit: '%' },\r\n              thresholds: { warning: 80, critical: 95 },\r\n            },\r\n            alerts: { enabled: true, conditions: [] },\r\n          },\r\n          {\r\n            title: 'Response Time',\r\n            type: 'chart' as const,\r\n            size: 'large' as const,\r\n            position: { x: 0, y: 3, width: 12, height: 4 },\r\n            dataSource: {\r\n              query: 'response-time',\r\n              metrics: ['response-time'],\r\n              aggregation: 'avg' as const,\r\n              timeRange: '24h',\r\n              groupBy: ['service'],\r\n            },\r\n            visualization: {\r\n              chartType: 'line' as const,\r\n              options: { unit: 'ms' },\r\n            },\r\n            alerts: { enabled: false, conditions: [] },\r\n          },\r\n        ],\r\n      },\r\n      {\r\n        name: 'Business KPIs',\r\n        description: 'Key business performance indicators',\r\n        type: 'executive' as const,\r\n        widgets: [\r\n          {\r\n            title: 'Active Users',\r\n            type: 'metric' as const,\r\n            size: 'small' as const,\r\n            position: { x: 0, y: 0, width: 3, height: 2 },\r\n            dataSource: {\r\n              query: 'active-users',\r\n              metrics: ['active-users'],\r\n              aggregation: 'count' as const,\r\n              timeRange: '24h',\r\n              groupBy: [],\r\n            },\r\n            visualization: {\r\n              options: { unit: 'users' },\r\n            },\r\n            alerts: { enabled: false, conditions: [] },\r\n          },\r\n        ],\r\n      },\r\n    ];\r\n\r\n    for (const dashboardData of defaultDashboards) {\r\n      if (!Array.from(this.dashboards.values()).some((d) => d.name === dashboardData.name)) {\r\n        await this.createDashboard(dashboardData);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async startMetricsCollection(): Promise<void> {\r\n    // Start collecting system metrics\r\n    setInterval(async () => {\r\n      await this.collectSystemMetrics();\r\n    }, 60000); // Every minute\r\n\r\n    // Start collecting application metrics\r\n    setInterval(async () => {\r\n      await this.collectApplicationMetrics();\r\n    }, 30000); // Every 30 seconds\r\n\r\n    this.logger.info('Started automatic metrics collection');\r\n  }\r\n\r\n  private async collectSystemMetrics(): Promise<void> {\r\n    try {\r\n      // Mock system metrics collection\r\n      await this.recordMetric({\r\n        name: 'cpu-usage',\r\n        description: 'CPU usage percentage',\r\n        type: 'gauge',\r\n        category: 'performance',\r\n        unit: 'percent',\r\n        value: Math.random() * 100,\r\n        tags: { host: 'localhost', service: 'system' },\r\n        source: 'system-monitor',\r\n        metadata: {},\r\n      });\r\n\r\n      await this.recordMetric({\r\n        name: 'memory-usage',\r\n        description: 'Memory usage percentage',\r\n        type: 'gauge',\r\n        category: 'performance',\r\n        unit: 'percent',\r\n        value: Math.random() * 100,\r\n        tags: { host: 'localhost', service: 'system' },\r\n        source: 'system-monitor',\r\n        metadata: {},\r\n      });\r\n\r\n      await this.recordMetric({\r\n        name: 'disk-usage',\r\n        description: 'Disk usage percentage',\r\n        type: 'gauge',\r\n        category: 'performance',\r\n        unit: 'percent',\r\n        value: Math.random() * 100,\r\n        tags: { host: 'localhost', service: 'system' },\r\n        source: 'system-monitor',\r\n        metadata: {},\r\n      });\r\n    } catch (error) {\r\n      this.logger.error('Failed to collect system metrics', { error });\r\n    }\r\n  }\r\n\r\n  private async collectApplicationMetrics(): Promise<void> {\r\n    try {\r\n      // Mock application metrics collection\r\n      await this.recordMetric({\r\n        name: 'response-time',\r\n        description: 'Average response time',\r\n        type: 'gauge',\r\n        category: 'performance',\r\n        unit: 'milliseconds',\r\n        value: Math.random() * 1000 + 100,\r\n        tags: { service: 'api', endpoint: '/users' },\r\n        source: 'application',\r\n        metadata: {},\r\n      });\r\n\r\n      await this.recordMetric({\r\n        name: 'request-rate',\r\n        description: 'Requests per second',\r\n        type: 'counter',\r\n        category: 'usage',\r\n        unit: 'requests/sec',\r\n        value: Math.random() * 100 + 10,\r\n        tags: { service: 'api' },\r\n        source: 'application',\r\n        metadata: {},\r\n      });\r\n\r\n      await this.recordMetric({\r\n        name: 'error-rate',\r\n        description: 'Error rate percentage',\r\n        type: 'gauge',\r\n        category: 'performance',\r\n        unit: 'percent',\r\n        value: Math.random() * 5,\r\n        tags: { service: 'api' },\r\n        source: 'application',\r\n        metadata: {},\r\n      });\r\n    } catch (error) {\r\n      this.logger.error('Failed to collect application metrics', { error });\r\n    }\r\n  }\r\n\r\n  private async persistMetric(metric: AnalyticsMetric): Promise<void> {\r\n    const date = metric.timestamp.toISOString().split('T')[0];\r\n    const filePath = join(this.analyticsPath, 'metrics', `${date}.json`);\r\n\r\n    try {\r\n      let existingData: AnalyticsMetric[] = [];\r\n      try {\r\n        const content = await readFile(filePath, 'utf-8');\r\n        existingData = JSON.parse(content);\r\n      } catch {\r\n        // File doesn't exist yet\r\n      }\r\n\r\n      existingData.push(metric);\r\n      await writeFile(filePath, JSON.stringify(existingData, null, 2));\r\n    } catch (error) {\r\n      this.logger.error('Failed to persist metric', { error, metric: metric.id });\r\n    }\r\n  }\r\n\r\n  private async checkForAnomalies(metricKey: string, metric: AnalyticsMetric): Promise<void> {\r\n    const historical = this.metrics.get(metricKey) || [];\r\n    if (historical.length < 10) return; // Need enough data for baseline\r\n\r\n    const recent = historical.slice(-10);\r\n    const average = recent.reduce((sum, m) => sum + m.value, 0) / recent.length;\r\n    const stdDev = Math.sqrt(\r\n      recent.reduce((sum, m) => sum + Math.pow(m.value - average, 2), 0) / recent.length,\r\n    );\r\n\r\n    const threshold = 2; // 2 standard deviations\r\n    const deviation = Math.abs(metric.value - average) / stdDev;\r\n\r\n    if (deviation > threshold) {\r\n      const insight: AnalyticsInsight = {\r\n        id: `insight-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n        title: `Anomaly detected in ${metric.name}`,\r\n        description: `The metric ${metric.name} has deviated significantly from its normal pattern`,\r\n        type: 'anomaly',\r\n        category: metric.category,\r\n        confidence: Math.min(95, deviation * 20),\r\n        impact: deviation > 3 ? 'high' : 'medium',\r\n        priority: deviation > 3 ? 'high' : 'medium',\r\n        data: {\r\n          metrics: [metric.name],\r\n          timeRange: { start: recent[0].timestamp, end: metric.timestamp },\r\n          values: { current: metric.value, average, stdDev },\r\n          baseline: { average, stdDev },\r\n          deviation,\r\n        },\r\n        recommendations: [\r\n          {\r\n            action: 'Investigate the cause of the anomaly',\r\n            effort: 'medium',\r\n            impact: 'Identify potential issues before they become critical',\r\n            implementation: [\r\n              'Check recent deployments or configuration changes',\r\n              'Review system logs for errors or warnings',\r\n              'Monitor related metrics for correlation',\r\n            ],\r\n          },\r\n        ],\r\n        status: 'new',\r\n        createdAt: new Date(),\r\n        updatedAt: new Date(),\r\n      };\r\n\r\n      this.insights.set(insight.id, insight);\r\n      await this.saveInsight(insight);\r\n\r\n      this.emit('anomaly:detected', { metric, insight, deviation });\r\n      this.logger.warn(`Anomaly detected in ${metric.name}`, {\r\n        current: metric.value,\r\n        average,\r\n        deviation,\r\n      });\r\n    }\r\n  }\r\n\r\n  private async detectAnomalies(\r\n    timeRange: { start: Date; end: Date },\r\n    metrics?: string[],\r\n  ): Promise<AnalyticsInsight[]> {\r\n    // Simplified anomaly detection\r\n    return [];\r\n  }\r\n\r\n  private async analyzeTrends(\r\n    timeRange: { start: Date; end: Date },\r\n    metrics?: string[],\r\n  ): Promise<AnalyticsInsight[]> {\r\n    // Simplified trend analysis\r\n    return [];\r\n  }\r\n\r\n  private async analyzePerformance(timeRange: {\r\n    start: Date;\r\n    end: Date;\r\n  }): Promise<AnalyticsInsight[]> {\r\n    const insights: AnalyticsInsight[] = [];\r\n\r\n    // Check response time trends\r\n    const responseTimeData = await this.queryMetrics({\r\n      metrics: ['response-time'],\r\n      timeRange,\r\n      aggregation: 'avg',\r\n    });\r\n\r\n    if (responseTimeData['response-time']?.length > 0) {\r\n      const values = responseTimeData['response-time'].map((d: any) => d.value);\r\n      const recent = values.slice(-5);\r\n      const earlier = values.slice(0, -5);\r\n\r\n      if (recent.length > 0 && earlier.length > 0) {\r\n        const recentAvg = recent.reduce((sum, v) => sum + v, 0) / recent.length;\r\n        const earlierAvg = earlier.reduce((sum, v) => sum + v, 0) / earlier.length;\r\n        const change = ((recentAvg - earlierAvg) / earlierAvg) * 100;\r\n\r\n        if (Math.abs(change) > 20) {\r\n          insights.push({\r\n            id: `perf-insight-${Date.now()}`,\r\n            title: `Response time ${change > 0 ? 'increased' : 'decreased'} by ${Math.abs(change).toFixed(1)}%`,\r\n            description: `Response time has changed significantly in the recent period`,\r\n            type: 'trend',\r\n            category: 'performance',\r\n            confidence: 80,\r\n            impact: Math.abs(change) > 50 ? 'high' : 'medium',\r\n            priority: Math.abs(change) > 50 ? 'high' : 'medium',\r\n            data: {\r\n              metrics: ['response-time'],\r\n              timeRange,\r\n              values: { recent: recentAvg, earlier: earlierAvg, change },\r\n            },\r\n            recommendations:\r\n              change > 0\r\n                ? [\r\n                    {\r\n                      action: 'Investigate performance degradation',\r\n                      effort: 'medium',\r\n                      impact: 'Restore optimal response times',\r\n                      implementation: [\r\n                        'Check for increased load or traffic',\r\n                        'Review recent code deployments',\r\n                        'Analyze database query performance',\r\n                        'Monitor resource utilization',\r\n                      ],\r\n                    },\r\n                  ]\r\n                : [\r\n                    {\r\n                      action: 'Document performance improvement',\r\n                      effort: 'low',\r\n                      impact: 'Understand what caused the improvement',\r\n                      implementation: [\r\n                        'Identify recent optimizations',\r\n                        'Document best practices',\r\n                        'Monitor sustainability',\r\n                      ],\r\n                    },\r\n                  ],\r\n            status: 'new',\r\n            createdAt: new Date(),\r\n            updatedAt: new Date(),\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return insights;\r\n  }\r\n\r\n  private async analyzeUsage(timeRange: { start: Date; end: Date }): Promise<AnalyticsInsight[]> {\r\n    // Simplified usage analysis\r\n    return [];\r\n  }\r\n\r\n  private async analyzeCostOptimization(timeRange: {\r\n    start: Date;\r\n    end: Date;\r\n  }): Promise<AnalyticsInsight[]> {\r\n    // Simplified cost optimization analysis\r\n    return [];\r\n  }\r\n\r\n  private async collectTrainingData(model: PredictiveModel): Promise<any[]> {\r\n    // Collect historical data for training\r\n    const data = await this.queryMetrics({\r\n      metrics: model.features,\r\n      timeRange: model.trainingData.timeRange,\r\n      aggregation: 'avg',\r\n    });\r\n\r\n    // Transform data for ML training (simplified)\r\n    return Object.values(data).flat();\r\n  }\r\n\r\n  private async executeModelTraining(\r\n    model: PredictiveModel,\r\n    data: any[],\r\n  ): Promise<Partial<PredictiveModel>> {\r\n    // Simplified model training\r\n    return {\r\n      accuracy: 85 + Math.random() * 10,\r\n      confidence: 80 + Math.random() * 15,\r\n      performance: {\r\n        precision: 0.85,\r\n        recall: 0.82,\r\n        f1Score: 0.83,\r\n      },\r\n      trainingData: {\r\n        ...model.trainingData,\r\n        samples: data.length,\r\n      },\r\n    };\r\n  }\r\n\r\n  private async executePrediction(\r\n    model: PredictiveModel,\r\n    input: Record<string, any>,\r\n  ): Promise<{ value: any; confidence: number }> {\r\n    // Simplified prediction logic\r\n    const value = Math.random() * 100;\r\n    const confidence = 70 + Math.random() * 25;\r\n\r\n    return { value, confidence };\r\n  }\r\n\r\n  private groupMetrics(\r\n    metrics: AnalyticsMetric[],\r\n    groupBy: string[],\r\n  ): Record<string, AnalyticsMetric[]> {\r\n    const groups: Record<string, AnalyticsMetric[]> = {};\r\n\r\n    for (const metric of metrics) {\r\n      const key = groupBy\r\n        .map((field) => {\r\n          if (field === 'tags') {\r\n            return Object.entries(metric.tags)\r\n              .map(([k, v]) => `${k}:${v}`)\r\n              .join(',');\r\n          }\r\n          return (metric as any)[field] || 'unknown';\r\n        })\r\n        .join('-');\r\n\r\n      if (!groups[key]) {\r\n        groups[key] = [];\r\n      }\r\n      groups[key].push(metric);\r\n    }\r\n\r\n    return groups;\r\n  }\r\n\r\n  private aggregateMetrics(metrics: AnalyticsMetric[], aggregation: string): any[] {\r\n    if (metrics.length === 0) return [];\r\n\r\n    // Group by time buckets for time series aggregation\r\n    const buckets: Record<string, AnalyticsMetric[]> = {};\r\n\r\n    for (const metric of metrics) {\r\n      const bucket = new Date(Math.floor(metric.timestamp.getTime() / 60000) * 60000).toISOString();\r\n      if (!buckets[bucket]) {\r\n        buckets[bucket] = [];\r\n      }\r\n      buckets[bucket].push(metric);\r\n    }\r\n\r\n    return Object.entries(buckets)\r\n      .map(([timestamp, bucketMetrics]) => {\r\n        const values = bucketMetrics.map((m) => m.value);\r\n        let aggregatedValue: number;\r\n\r\n        switch (aggregation) {\r\n          case 'sum':\r\n            aggregatedValue = values.reduce((sum, v) => sum + v, 0);\r\n            break;\r\n          case 'min':\r\n            aggregatedValue = Math.min(...values);\r\n            break;\r\n          case 'max':\r\n            aggregatedValue = Math.max(...values);\r\n            break;\r\n          case 'count':\r\n            aggregatedValue = values.length;\r\n            break;\r\n          case 'p95':\r\n            values.sort((a, b) => a - b);\r\n            aggregatedValue = values[Math.floor(values.length * 0.95)];\r\n            break;\r\n          case 'p99':\r\n            values.sort((a, b) => a - b);\r\n            aggregatedValue = values[Math.floor(values.length * 0.99)];\r\n            break;\r\n          case 'avg':\r\n          default:\r\n            aggregatedValue = values.reduce((sum, v) => sum + v, 0) / values.length;\r\n        }\r\n\r\n        return {\r\n          timestamp: new Date(timestamp),\r\n          value: aggregatedValue,\r\n          count: values.length,\r\n        };\r\n      })\r\n      .sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());\r\n  }\r\n\r\n  private getLatestValue(dataPoints: any[]): number {\r\n    if (!dataPoints || dataPoints.length === 0) return 0;\r\n    return dataPoints[dataPoints.length - 1]?.value || 0;\r\n  }\r\n\r\n  private async saveDashboard(dashboard: AnalyticsDashboard): Promise<void> {\r\n    const filePath = join(this.analyticsPath, 'dashboards', `${dashboard.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(dashboard, null, 2));\r\n  }\r\n\r\n  private async saveInsight(insight: AnalyticsInsight): Promise<void> {\r\n    const filePath = join(this.analyticsPath, 'insights', `${insight.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(insight, null, 2));\r\n  }\r\n\r\n  private async saveModel(model: PredictiveModel): Promise<void> {\r\n    const filePath = join(this.analyticsPath, 'models', `${model.id}.json`);\r\n    await writeFile(filePath, JSON.stringify(model, null, 2));\r\n  }\r\n}\r\n"],"names":["EventEmitter","writeFile","readFile","mkdir","readdir","join","Logger","ConfigManager","AnalyticsManager","metrics","Map","dashboards","insights","models","reports","analyticsPath","logger","config","configuration","level","format","destination","getInstance","getDefaultConfiguration","initialize","recursive","loadConfigurations","initializeDefaultDashboards","startMetricsCollection","info","error","recordMetric","metric","fullMetric","id","Date","now","Math","random","toString","substr","timestamp","key","category","name","has","set","metricArray","get","push","retentionPeriod","cutoff","filteredMetrics","filter","m","getTime","persistMetric","emit","checkForAnomalies","queryMetrics","query","results","metricName","includes","matchingKeys","Array","from","keys","k","replace","allMetrics","keyMetrics","timeRange","start","end","filters","field","value","Object","entries","every","v","tags","groupBy","length","grouped","groupMetrics","group","aggregated","aggregateMetrics","aggregation","createDashboard","dashboardData","dashboard","description","type","widgets","map","widget","index","layout","columns","rows","grid","responsive","permissions","viewers","editors","public","schedule","autoRefresh","refreshInterval","createdAt","updatedAt","createdBy","saveDashboard","generateInsights","scope","anomalies","detectAnomalies","trends","analyzeTrends","performance","analyzePerformance","usage","analyzeUsage","costOptimizations","analyzeCostOptimization","insight","saveInsight","trainPredictiveModel","modelConfig","model","algorithm","features","target","accuracy","confidence","trainedAt","trainingData","samples","trainingPeriod","precision","recall","f1Score","predictions","status","collectTrainingData","trained","executeModelTraining","assign","saveModel","makePrediction","modelId","input","Error","prediction","executePrediction","result","lastPrediction","debug","JSON","stringify","getPerformanceMetrics","range","systemMetrics","appMetrics","dbMetrics","system","cpu","getLatestValue","cores","loadAverage","memory","used","free","total","disk","iops","network","bytesIn","bytesOut","packetsIn","packetsOut","errors","application","responseTime","avg","p50","p95","p99","throughput","requestsPerSecond","transactionsPerSecond","rate","count","types","availability","uptime","sla","incidents","database","connections","active","idle","max","queries","avgExecutionTime","slowQueries","deadlocks","storage","size","growth","fragmentation","infrastructure","containers","running","stopped","restarts","services","healthy","unhealthy","degraded","getUsageMetrics","usageData","users","new","returning","churn","sessions","duration","median","bounceRate","pagesPerSession","adoption","retention","analytics","mostUsed","leastUsed","api","calls","uniqueConsumers","avgResponseTime","errorRate","rateLimits","hit","consumed","content","created","modified","deleted","views","getBusinessMetrics","revenue","recurring","arpu","ltv","customers","retained","churned","satisfaction","conversion","leads","qualified","opportunities","closed","support","tickets","resolved","avgResolutionTime","collection","enabled","samplingRate","batchSize","flushInterval","raw","summary","compression","encryption","processing","realTime","batchProcessing","aggregationIntervals","alerts","channels","escalation","levels","intervals","privacy","anonymization","gdprCompliant","dataMinimization","integrations","dashboardFiles","file","f","endsWith","parse","insightFiles","modelFiles","warn","defaultDashboards","title","position","x","y","width","height","dataSource","visualization","chartType","options","unit","thresholds","warning","critical","conditions","values","some","d","setInterval","collectSystemMetrics","collectApplicationMetrics","host","service","source","metadata","endpoint","date","toISOString","split","filePath","existingData","metricKey","historical","recent","slice","average","reduce","sum","stdDev","sqrt","pow","threshold","deviation","abs","min","impact","priority","data","current","baseline","recommendations","action","effort","implementation","responseTimeData","earlier","recentAvg","earlierAvg","change","toFixed","flat","groups","buckets","bucket","floor","bucketMetrics","aggregatedValue","sort","a","b","dataPoints"],"mappings":"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"}
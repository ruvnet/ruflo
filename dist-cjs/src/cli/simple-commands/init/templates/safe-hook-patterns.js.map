{"version":3,"sources":["../../../../../../src/cli/simple-commands/init/templates/safe-hook-patterns.js"],"sourcesContent":["/**\r\n * Safe Hook Patterns - Templates for safe Claude Code hook configurations\r\n *\r\n * These patterns prevent infinite loops that could cost thousands of dollars\r\n * by avoiding recursive hook execution when hooks call 'claude' commands.\r\n */\r\n\r\n/**\r\n * DANGEROUS PATTERN - DO NOT USE\r\n * This creates an infinite loop that can cost thousands of dollars!\r\n */\r\nexport const DANGEROUS_PATTERN_EXAMPLE = {\r\n  name: 'DANGEROUS: Stop hook calling claude command',\r\n  description: '‚ùå NEVER USE THIS - Creates infinite recursion loop',\r\n  pattern: {\r\n    hooks: {\r\n      Stop: [\r\n        {\r\n          matcher: '',\r\n          hooks: [\r\n            {\r\n              type: 'command',\r\n              command: 'claude -c -p \"Update all changes to history.md\"',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  problems: [\r\n    'üö® Creates infinite loop: Stop ‚Üí claude command ‚Üí Stop ‚Üí claude command...',\r\n    'üí∞ Can cost $3600+ per day by bypassing rate limits',\r\n    'üö´ Makes system unresponsive',\r\n    '‚ö° No built-in protection in Claude Code',\r\n  ],\r\n};\r\n\r\n/**\r\n * SAFE PATTERN 1: Flag-based updates\r\n * Set a flag instead of calling claude directly\r\n */\r\nexport const SAFE_FLAG_PATTERN = {\r\n  name: 'Safe Pattern: Flag-based updates',\r\n  description: '‚úÖ Set flag when update needed, run manually',\r\n  pattern: {\r\n    hooks: {\r\n      Stop: [\r\n        {\r\n          matcher: '',\r\n          hooks: [\r\n            {\r\n              type: 'command',\r\n              command:\r\n                'bash -c \\'echo \"History update needed at $(date)\" > ~/.claude/needs_update && echo \"üìù History update flagged. Run: claude -c -p \\\\\"Update history.md\\\\\"\"\\'',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  benefits: [\r\n    '‚úÖ No recursion - just sets a flag',\r\n    'üí∞ Zero risk of infinite API calls',\r\n    'üîÑ User controls when update runs',\r\n    'üìù Clear instructions for manual execution',\r\n  ],\r\n  usage: [\r\n    '1. Hook sets flag when update is needed',\r\n    '2. User sees notification',\r\n    '3. User manually runs: claude -c -p \"Update history.md\"',\r\n    '4. Update runs once safely',\r\n  ],\r\n};\r\n\r\n/**\r\n * SAFE PATTERN 2: PostToolUse hooks instead of Stop hooks\r\n * React to specific tool usage rather than session end\r\n */\r\nexport const SAFE_POST_TOOL_PATTERN = {\r\n  name: 'Safe Pattern: PostToolUse hooks',\r\n  description: '‚úÖ React to specific file operations instead of Stop events',\r\n  pattern: {\r\n    hooks: {\r\n      PostToolUse: [\r\n        {\r\n          matcher: 'Write|Edit|MultiEdit',\r\n          hooks: [\r\n            {\r\n              type: 'command',\r\n              command: \"echo 'File modified: {file}' >> ~/.claude/modifications.log\",\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  benefits: [\r\n    '‚úÖ Only triggers on actual file changes',\r\n    'üéØ More precise than Stop hooks',\r\n    'üìù Logs specific modifications',\r\n    'üîÑ No risk of Stop hook recursion',\r\n  ],\r\n  usage: [\r\n    '1. Triggers only when files are written/edited',\r\n    '2. Logs the specific file that was modified',\r\n    '3. Can be used for change tracking',\r\n    '4. Safe to use with any logging command',\r\n  ],\r\n};\r\n\r\n/**\r\n * SAFE PATTERN 3: Conditional execution with skip-hooks\r\n * Check for hook context before executing claude commands\r\n */\r\nexport const SAFE_CONDITIONAL_PATTERN = {\r\n  name: 'Safe Pattern: Conditional execution with context check',\r\n  description: '‚úÖ Check if running in hook context before calling claude',\r\n  pattern: {\r\n    hooks: {\r\n      Stop: [\r\n        {\r\n          matcher: '',\r\n          hooks: [\r\n            {\r\n              type: 'command',\r\n              command:\r\n                'bash -c \\'if [ -z \"$CLAUDE_HOOK_CONTEXT\" ]; then claude -c -p \"Update history.md\" --skip-hooks; else echo \"Skipping update - in hook context\"; fi\\'',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  benefits: [\r\n    '‚úÖ Checks hook context before execution',\r\n    'üõ°Ô∏è Uses --skip-hooks flag for safety',\r\n    'üîÑ Prevents recursive hook calls',\r\n    'üìä Provides clear feedback',\r\n  ],\r\n  usage: [\r\n    '1. Checks CLAUDE_HOOK_CONTEXT environment variable',\r\n    '2. Only runs claude if not in hook context',\r\n    '3. Uses --skip-hooks to prevent triggering more hooks',\r\n    '4. Shows clear message when skipping',\r\n  ],\r\n};\r\n\r\n/**\r\n * SAFE PATTERN 4: Batch processing with scheduled execution\r\n * Accumulate changes and process them on a schedule\r\n */\r\nexport const SAFE_BATCH_PATTERN = {\r\n  name: 'Safe Pattern: Batch processing with scheduled execution',\r\n  description: '‚úÖ Accumulate changes and process them separately',\r\n  pattern: {\r\n    hooks: {\r\n      Stop: [\r\n        {\r\n          matcher: '',\r\n          hooks: [\r\n            {\r\n              type: 'command',\r\n              command: 'echo \"$(date): Session ended\" >> ~/.claude/session_log.txt',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  additionalSetup: {\r\n    cronJob: '# Add to crontab (run every hour):\\n# 0 * * * * /path/to/update-history.sh',\r\n    updateScript: `#!/bin/bash\r\n# update-history.sh - Safe batch update script\r\nLOCK_FILE=\"~/.claude/update.lock\"\r\nLOG_FILE=\"~/.claude/session_log.txt\"\r\n\r\n# Check if update is already running\r\nif [ -f \"$LOCK_FILE\" ]; then\r\n    echo \"Update already in progress\"\r\n    exit 1\r\nfi\r\n\r\n# Create lock file\r\ntouch \"$LOCK_FILE\"\r\n\r\n# Check if there are new sessions to process\r\nif [ -f \"$LOG_FILE\" ] && [ -s \"$LOG_FILE\" ]; then\r\n    echo \"Processing accumulated changes...\"\r\n    claude -c -p \"Update history.md with recent session data\" --skip-hooks\r\n    \r\n    # Archive the log\r\n    mv \"$LOG_FILE\" \"~/.claude/session_log_$(date +%Y%m%d_%H%M%S).txt\"\r\nfi\r\n\r\n# Remove lock file\r\nrm \"$LOCK_FILE\"`,\r\n  },\r\n  benefits: [\r\n    '‚úÖ No risk of recursion',\r\n    '‚è∞ Scheduled processing prevents overload',\r\n    'üîí Lock file prevents concurrent updates',\r\n    'üì¶ Batches multiple sessions efficiently',\r\n  ],\r\n};\r\n\r\n/**\r\n * SAFE PATTERN 5: Database/file-based queue system\r\n * Use external queue for processing commands\r\n */\r\nexport const SAFE_QUEUE_PATTERN = {\r\n  name: 'Safe Pattern: Queue-based command processing',\r\n  description: '‚úÖ Queue commands for external processing',\r\n  pattern: {\r\n    hooks: {\r\n      Stop: [\r\n        {\r\n          matcher: '',\r\n          hooks: [\r\n            {\r\n              type: 'command',\r\n              command:\r\n                'echo \\'{\"command\": \"update-history\", \"timestamp\": \"\\'$(date -Iseconds)\\'\", \"session\": \"\\'$CLAUDE_SESSION_ID\\'\"}\\' >> ~/.claude/command_queue.jsonl',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  processor: `#!/usr/bin/env python3\r\n# queue-processor.py - Safe command queue processor\r\nimport json\r\nimport subprocess\r\nimport time\r\nimport os\r\nfrom pathlib import Path\r\n\r\nQUEUE_FILE = Path.home() / '.claude' / 'command_queue.jsonl'\r\nPROCESSING_INTERVAL = 300  # 5 minutes\r\n\r\ndef process_queue():\r\n    if not QUEUE_FILE.exists():\r\n        return\r\n    \r\n    # Read and clear queue atomically\r\n    with open(QUEUE_FILE, 'r') as f:\r\n        lines = f.readlines()\r\n    \r\n    # Clear the queue\r\n    QUEUE_FILE.unlink()\r\n    \r\n    # Process commands\r\n    for line in lines:\r\n        try:\r\n            cmd_data = json.loads(line.strip())\r\n            if cmd_data['command'] == 'update-history':\r\n                print(f\"Processing history update for session {cmd_data['session']}\")\r\n                subprocess.run([\r\n                    'claude', '-c', '-p', 'Update history.md', '--skip-hooks'\r\n                ], check=True)\r\n                time.sleep(2)  # Rate limiting\r\n        except Exception as e:\r\n            print(f\"Error processing command: {e}\")\r\n\r\nif __name__ == '__main__':\r\n    while True:\r\n        try:\r\n            process_queue()\r\n            time.sleep(PROCESSING_INTERVAL)\r\n        except KeyboardInterrupt:\r\n            break`,\r\n  benefits: [\r\n    '‚úÖ Complete separation of hook and claude execution',\r\n    '‚è∞ Rate limited processing',\r\n    'üîÑ Handles multiple queued commands',\r\n    'üõ°Ô∏è No risk of infinite loops',\r\n  ],\r\n};\r\n\r\n/**\r\n * Get all safe patterns for documentation generation\r\n */\r\nexport const ALL_SAFE_PATTERNS = [\r\n  SAFE_FLAG_PATTERN,\r\n  SAFE_POST_TOOL_PATTERN,\r\n  SAFE_CONDITIONAL_PATTERN,\r\n  SAFE_BATCH_PATTERN,\r\n  SAFE_QUEUE_PATTERN,\r\n];\r\n\r\n/**\r\n * Generate safe hooks documentation\r\n */\r\nexport function generateSafeHooksGuide() {\r\n  return `# üõ°Ô∏è Safe Hook Patterns for Claude Code\r\n\r\n‚ö†Ô∏è **CRITICAL WARNING**: Stop hooks that call 'claude' commands create infinite loops that can cost thousands of dollars per day!\r\n\r\n## üö® DANGEROUS PATTERN (NEVER USE)\r\n\r\n${DANGEROUS_PATTERN_EXAMPLE.description}\r\n\r\n\\`\\`\\`json\r\n${JSON.stringify(DANGEROUS_PATTERN_EXAMPLE.pattern, null, 2)}\r\n\\`\\`\\`\r\n\r\n**Problems:**\r\n${DANGEROUS_PATTERN_EXAMPLE.problems.map((p) => `- ${p}`).join('\\n')}\r\n\r\n---\r\n\r\n## ‚úÖ SAFE PATTERNS\r\n\r\n${ALL_SAFE_PATTERNS.map(\r\n  (pattern) => `\r\n### ${pattern.name}\r\n\r\n${pattern.description}\r\n\r\n**Configuration:**\r\n\\`\\`\\`json\r\n${JSON.stringify(pattern.pattern, null, 2)}\r\n\\`\\`\\`\r\n\r\n**Benefits:**\r\n${pattern.benefits.map((b) => `- ${b}`).join('\\n')}\r\n\r\n${\r\n  pattern.usage\r\n    ? `**Usage:**\r\n${pattern.usage.map((u, i) => `${i + 1}. ${u}`).join('\\n')}`\r\n    : ''\r\n}\r\n\r\n${\r\n  pattern.additionalSetup\r\n    ? `**Additional Setup:**\r\n${\r\n  pattern.additionalSetup.cronJob\r\n    ? `\r\n**Cron Job:**\r\n\\`\\`\\`bash\r\n${pattern.additionalSetup.cronJob}\r\n\\`\\`\\`\r\n`\r\n    : ''\r\n}\r\n\r\n${\r\n  pattern.additionalSetup.updateScript\r\n    ? `\r\n**Update Script:**\r\n\\`\\`\\`bash\r\n${pattern.additionalSetup.updateScript}\r\n\\`\\`\\`\r\n`\r\n    : ''\r\n}`\r\n    : ''\r\n}\r\n\r\n${\r\n  pattern.processor\r\n    ? `\r\n**Queue Processor:**\r\n\\`\\`\\`python\r\n${pattern.processor}\r\n\\`\\`\\`\r\n`\r\n    : ''\r\n}\r\n\r\n---\r\n`,\r\n).join('')}\r\n\r\n## üöÄ Quick Migration Guide\r\n\r\n### If you currently have this DANGEROUS pattern:\r\n\\`\\`\\`json\r\n{\r\n  \"hooks\": {\r\n    \"Stop\": [{\"hooks\": [{\"type\": \"command\", \"command\": \"claude -c -p 'Update history'\"}]}]\r\n  }\r\n}\r\n\\`\\`\\`\r\n\r\n### Replace with this SAFE pattern:\r\n\\`\\`\\`json\r\n{\r\n  \"hooks\": {\r\n    \"Stop\": [{\"hooks\": [{\"type\": \"command\", \"command\": \"touch ~/.claude/needs_update && echo 'Run: claude -c -p \\\"Update history\\\"'\"}]}]\r\n  }\r\n}\r\n\\`\\`\\`\r\n\r\n## üõ°Ô∏è Hook Safety Tools\r\n\r\nUse claude-flow's built-in safety tools:\r\n\r\n\\`\\`\\`bash\r\n# Check your configuration for dangerous patterns\r\nclaude-flow hook-safety validate\r\n\r\n# Enable safe mode (skips all hooks)\r\nclaude-flow hook-safety safe-mode\r\n\r\n# Check current safety status\r\nclaude-flow hook-safety status\r\n\r\n# Reset circuit breakers if triggered\r\nclaude-flow hook-safety reset\r\n\\`\\`\\`\r\n\r\n## üìö Additional Resources\r\n\r\n- Issue #166: https://github.com/ruvnet/claude-flow/issues/166\r\n- Claude Code Hooks Documentation: https://docs.anthropic.com/en/docs/claude-code/hooks\r\n- Reddit Discussion: https://www.reddit.com/r/ClaudeAI/comments/1ltvi6x/anyone_else_accidentally_create_an_infinite_loop/\r\n\r\n---\r\n\r\n**Remember**: When in doubt, use flag-based patterns or PostToolUse hooks instead of Stop hooks!\r\n`;\r\n}\r\n\r\nexport default {\r\n  DANGEROUS_PATTERN_EXAMPLE,\r\n  ALL_SAFE_PATTERNS,\r\n  generateSafeHooksGuide,\r\n};\r\n"],"names":["DANGEROUS_PATTERN_EXAMPLE","name","description","pattern","hooks","Stop","matcher","type","command","problems","SAFE_FLAG_PATTERN","benefits","usage","SAFE_POST_TOOL_PATTERN","PostToolUse","SAFE_CONDITIONAL_PATTERN","SAFE_BATCH_PATTERN","additionalSetup","cronJob","updateScript","SAFE_QUEUE_PATTERN","processor","ALL_SAFE_PATTERNS","generateSafeHooksGuide","JSON","stringify","map","p","join","b","u","i"],"mappings":"AAWA,OAAO,MAAMA,4BAA4B;IACvCC,MAAM;IACNC,aAAa;IACbC,SAAS;QACPC,OAAO;YACLC,MAAM;gBACJ;oBACEC,SAAS;oBACTF,OAAO;wBACL;4BACEG,MAAM;4BACNC,SAAS;wBACX;qBACD;gBACH;aACD;QACH;IACF;IACAC,UAAU;QACR;QACA;QACA;QACA;KACD;AACH,EAAE;AAMF,OAAO,MAAMC,oBAAoB;IAC/BT,MAAM;IACNC,aAAa;IACbC,SAAS;QACPC,OAAO;YACLC,MAAM;gBACJ;oBACEC,SAAS;oBACTF,OAAO;wBACL;4BACEG,MAAM;4BACNC,SACE;wBACJ;qBACD;gBACH;aACD;QACH;IACF;IACAG,UAAU;QACR;QACA;QACA;QACA;KACD;IACDC,OAAO;QACL;QACA;QACA;QACA;KACD;AACH,EAAE;AAMF,OAAO,MAAMC,yBAAyB;IACpCZ,MAAM;IACNC,aAAa;IACbC,SAAS;QACPC,OAAO;YACLU,aAAa;gBACX;oBACER,SAAS;oBACTF,OAAO;wBACL;4BACEG,MAAM;4BACNC,SAAS;wBACX;qBACD;gBACH;aACD;QACH;IACF;IACAG,UAAU;QACR;QACA;QACA;QACA;KACD;IACDC,OAAO;QACL;QACA;QACA;QACA;KACD;AACH,EAAE;AAMF,OAAO,MAAMG,2BAA2B;IACtCd,MAAM;IACNC,aAAa;IACbC,SAAS;QACPC,OAAO;YACLC,MAAM;gBACJ;oBACEC,SAAS;oBACTF,OAAO;wBACL;4BACEG,MAAM;4BACNC,SACE;wBACJ;qBACD;gBACH;aACD;QACH;IACF;IACAG,UAAU;QACR;QACA;QACA;QACA;KACD;IACDC,OAAO;QACL;QACA;QACA;QACA;KACD;AACH,EAAE;AAMF,OAAO,MAAMI,qBAAqB;IAChCf,MAAM;IACNC,aAAa;IACbC,SAAS;QACPC,OAAO;YACLC,MAAM;gBACJ;oBACEC,SAAS;oBACTF,OAAO;wBACL;4BACEG,MAAM;4BACNC,SAAS;wBACX;qBACD;gBACH;aACD;QACH;IACF;IACAS,iBAAiB;QACfC,SAAS;QACTC,cAAc,CAAC;;;;;;;;;;;;;;;;;;;;;;;;eAwBJ,CAAC;IACd;IACAR,UAAU;QACR;QACA;QACA;QACA;KACD;AACH,EAAE;AAMF,OAAO,MAAMS,qBAAqB;IAChCnB,MAAM;IACNC,aAAa;IACbC,SAAS;QACPC,OAAO;YACLC,MAAM;gBACJ;oBACEC,SAAS;oBACTF,OAAO;wBACL;4BACEG,MAAM;4BACNC,SACE;wBACJ;qBACD;gBACH;aACD;QACH;IACF;IACAa,WAAW,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;iBAyCG,CAAC;IAChBV,UAAU;QACR;QACA;QACA;QACA;KACD;AACH,EAAE;AAKF,OAAO,MAAMW,oBAAoB;IAC/BZ;IACAG;IACAE;IACAC;IACAI;CACD,CAAC;AAKF,OAAO,SAASG;IACd,OAAO,CAAC;;;;;;AAMV,EAAEvB,0BAA0BE,WAAW,CAAC;;;AAGxC,EAAEsB,KAAKC,SAAS,CAACzB,0BAA0BG,OAAO,EAAE,MAAM,GAAG;;;;AAI7D,EAAEH,0BAA0BS,QAAQ,CAACiB,GAAG,CAAC,CAACC,IAAM,CAAC,EAAE,EAAEA,GAAG,EAAEC,IAAI,CAAC,MAAM;;;;;;AAMrE,EAAEN,kBAAkBI,GAAG,CACrB,CAACvB,UAAY,CAAC;IACZ,EAAEA,QAAQF,IAAI,CAAC;;AAEnB,EAAEE,QAAQD,WAAW,CAAC;;;;AAItB,EAAEsB,KAAKC,SAAS,CAACtB,QAAQA,OAAO,EAAE,MAAM,GAAG;;;;AAI3C,EAAEA,QAAQQ,QAAQ,CAACe,GAAG,CAAC,CAACG,IAAM,CAAC,EAAE,EAAEA,GAAG,EAAED,IAAI,CAAC,MAAM;;AAEnD,EACEzB,QAAQS,KAAK,GACT,CAAC;AACP,EAAET,QAAQS,KAAK,CAACc,GAAG,CAAC,CAACI,GAAGC,IAAM,GAAGA,IAAI,EAAE,EAAE,EAAED,GAAG,EAAEF,IAAI,CAAC,OAAO,GACtD,GACL;;AAED,EACEzB,QAAQc,eAAe,GACnB,CAAC;AACP,EACEd,QAAQc,eAAe,CAACC,OAAO,GAC3B,CAAC;;;AAGP,EAAEf,QAAQc,eAAe,CAACC,OAAO,CAAC;;AAElC,CAAC,GACK,GACL;;AAED,EACEf,QAAQc,eAAe,CAACE,YAAY,GAChC,CAAC;;;AAGP,EAAEhB,QAAQc,eAAe,CAACE,YAAY,CAAC;;AAEvC,CAAC,GACK,IACJ,GACI,GACL;;AAED,EACEhB,QAAQkB,SAAS,GACb,CAAC;;;AAGP,EAAElB,QAAQkB,SAAS,CAAC;;AAEpB,CAAC,GACK,GACL;;;AAGD,CAAC,EACCO,IAAI,CAAC,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiDX,CAAC;AACD;AAEA,eAAe;IACb5B;IACAsB;IACAC;AACF,EAAE"}
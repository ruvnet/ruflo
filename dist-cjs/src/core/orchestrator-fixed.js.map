{"version":3,"sources":["../../../src/core/orchestrator-fixed.ts"],"sourcesContent":["/**\r\n * Fixed orchestrator implementation for Claude-Flow\r\n */\r\n\r\nimport type { EventBus } from './event-bus.js';\r\nimport type { Logger } from './logger.js';\r\nimport type { ConfigManager } from './config.js';\r\nimport { JsonPersistenceManager } from './json-persistence.js';\r\n\r\nexport interface AgentInfo {\r\n  id: string;\r\n  type: string;\r\n  name: string;\r\n  status: string;\r\n  assignedTasks: string[];\r\n  createdAt: number;\r\n}\r\n\r\nexport interface TaskInfo {\r\n  id: string;\r\n  type: string;\r\n  description: string;\r\n  status: string;\r\n  progress: number;\r\n  assignedAgent?: string;\r\n  error?: string;\r\n}\r\n\r\nexport interface SessionInfo {\r\n  id: string;\r\n  type: string;\r\n  agentId: string;\r\n}\r\n\r\nexport interface WorkflowStatus {\r\n  status: string;\r\n  progress: number;\r\n  error?: string;\r\n}\r\n\r\nexport interface HealthCheckResult {\r\n  healthy: boolean;\r\n  memory: boolean;\r\n  terminalPool: boolean;\r\n  mcp: boolean;\r\n}\r\n\r\nexport class Orchestrator {\r\n  private agents: Map<string, AgentInfo> = new Map();\r\n  private tasks: Map<string, TaskInfo> = new Map();\r\n  private sessions: Map<string, SessionInfo> = new Map();\r\n  private persistence: JsonPersistenceManager;\r\n  private workflows: Map<string, WorkflowStatus> = new Map();\r\n  private started = false;\r\n\r\n  constructor(\r\n    private config: ConfigManager,\r\n    private eventBus: EventBus,\r\n    private logger: Logger,\r\n  ) {\r\n    this.persistence = new JsonPersistenceManager();\r\n  }\r\n\r\n  async start(): Promise<void> {\r\n    if (this.started) {\r\n      throw new Error('Orchestrator already started');\r\n    }\r\n\r\n    this.logger.info('Starting orchestrator...');\r\n\r\n    // Initialize persistence\r\n    await this.persistence.initialize();\r\n\r\n    // Load existing agents and tasks from database\r\n    await this.loadFromPersistence();\r\n\r\n    // Initialize components\r\n    this.eventBus.emit('system:ready', { timestamp: new Date() });\r\n\r\n    this.started = true;\r\n    this.logger.info('Orchestrator started successfully');\r\n  }\r\n\r\n  private async loadFromPersistence(): Promise<void> {\r\n    // Load agents\r\n    const persistedAgents = await this.persistence.getActiveAgents();\r\n    for (const agent of persistedAgents) {\r\n      this.agents.set(agent.id, {\r\n        id: agent.id,\r\n        type: agent.type,\r\n        name: agent.name,\r\n        status: agent.status,\r\n        assignedTasks: [],\r\n        createdAt: agent.createdAt,\r\n      });\r\n    }\r\n\r\n    // Load tasks\r\n    const persistedTasks = await this.persistence.getActiveTasks();\r\n    for (const task of persistedTasks) {\r\n      this.tasks.set(task.id, {\r\n        id: task.id,\r\n        type: task.type,\r\n        description: task.description,\r\n        status: task.status,\r\n        progress: task.progress,\r\n        assignedAgent: task.assignedAgent,\r\n        error: task.error,\r\n      });\r\n    }\r\n\r\n    this.logger.info(\r\n      `Loaded ${this.agents.size} agents and ${this.tasks.size} tasks from persistence`,\r\n    );\r\n  }\r\n\r\n  async stop(): Promise<void> {\r\n    if (!this.started) {\r\n      return;\r\n    }\r\n\r\n    this.logger.info('Stopping orchestrator...');\r\n\r\n    // Clean up resources\r\n    this.agents.clear();\r\n    this.tasks.clear();\r\n    this.sessions.clear();\r\n    this.workflows.clear();\r\n\r\n    // Close persistence\r\n    this.persistence.close();\r\n\r\n    this.started = false;\r\n    this.logger.info('Orchestrator stopped');\r\n  }\r\n\r\n  async spawnAgent(profile: {\r\n    type: string;\r\n    name: string;\r\n    capabilities: string[];\r\n    systemPrompt: string;\r\n    maxConcurrentTasks: number;\r\n    priority: number;\r\n  }): Promise<string> {\r\n    const agentId = `agent-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    const agent: AgentInfo = {\r\n      id: agentId,\r\n      type: profile.type,\r\n      name: profile.name,\r\n      status: 'active',\r\n      assignedTasks: [],\r\n      createdAt: Date.now(),\r\n    };\r\n\r\n    // Save to persistence\r\n    await this.persistence.saveAgent({\r\n      id: agentId,\r\n      type: profile.type,\r\n      name: profile.name,\r\n      status: 'active',\r\n      capabilities: profile.capabilities,\r\n      systemPrompt: profile.systemPrompt,\r\n      maxConcurrentTasks: profile.maxConcurrentTasks,\r\n      priority: profile.priority,\r\n      createdAt: Date.now(),\r\n    });\r\n\r\n    this.agents.set(agentId, agent);\r\n    this.eventBus.emit('agent:spawned', { agentId, profile });\r\n\r\n    return agentId;\r\n  }\r\n\r\n  async terminateAgent(agentId: string): Promise<void> {\r\n    const agent = this.agents.get(agentId);\r\n    if (!agent) {\r\n      throw new Error(`Agent ${agentId} not found`);\r\n    }\r\n\r\n    // Update persistence\r\n    await this.persistence.updateAgentStatus(agentId, 'terminated');\r\n\r\n    this.agents.delete(agentId);\r\n    this.eventBus.emit('agent:terminated', { agentId, reason: 'User requested' });\r\n  }\r\n\r\n  getActiveAgents(): AgentInfo[] {\r\n    return Array.from(this.agents.values());\r\n  }\r\n\r\n  getAgentInfo(agentId: string): AgentInfo | undefined {\r\n    return this.agents.get(agentId);\r\n  }\r\n\r\n  async submitTask(task: {\r\n    type: string;\r\n    description: string;\r\n    priority: number;\r\n    dependencies: string[];\r\n    metadata: Record<string, unknown>;\r\n  }): Promise<string> {\r\n    const taskId = `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    const taskInfo: TaskInfo = {\r\n      id: taskId,\r\n      type: task.type,\r\n      description: task.description,\r\n      status: 'pending',\r\n      progress: 0,\r\n    };\r\n\r\n    // Save to persistence\r\n    await this.persistence.saveTask({\r\n      id: taskId,\r\n      type: task.type,\r\n      description: task.description,\r\n      status: 'pending',\r\n      priority: task.priority,\r\n      dependencies: task.dependencies,\r\n      metadata: task.metadata,\r\n      progress: 0,\r\n      createdAt: Date.now(),\r\n    });\r\n\r\n    this.tasks.set(taskId, taskInfo);\r\n    this.eventBus.emit('task:created', { taskId, task });\r\n\r\n    // Simulate task assignment\r\n    const availableAgents = Array.from(this.agents.values()).filter((a) => a.status === 'active');\r\n    if (availableAgents.length > 0) {\r\n      const agent = availableAgents[0];\r\n      taskInfo.assignedAgent = agent.id;\r\n      taskInfo.status = 'assigned';\r\n      agent.assignedTasks.push(taskId);\r\n      this.eventBus.emit('task:assigned', { taskId, agentId: agent.id });\r\n\r\n      // Update persistence with assignment\r\n      await this.persistence.updateTaskStatus(taskId, 'assigned', agent.id);\r\n    }\r\n\r\n    return taskId;\r\n  }\r\n\r\n  getTaskQueue(): TaskInfo[] {\r\n    return Array.from(this.tasks.values());\r\n  }\r\n\r\n  getTaskStatus(taskId: string): TaskInfo | undefined {\r\n    return this.tasks.get(taskId);\r\n  }\r\n\r\n  async cancelTask(taskId: string): Promise<void> {\r\n    const task = this.tasks.get(taskId);\r\n    if (!task) {\r\n      throw new Error(`Task ${taskId} not found`);\r\n    }\r\n\r\n    task.status = 'cancelled';\r\n    this.eventBus.emit('task:cancelled', { taskId });\r\n  }\r\n\r\n  getActiveSessions(): SessionInfo[] {\r\n    return Array.from(this.sessions.values());\r\n  }\r\n\r\n  async terminateSession(sessionId: string): Promise<void> {\r\n    const session = this.sessions.get(sessionId);\r\n    if (!session) {\r\n      throw new Error(`Session ${sessionId} not found`);\r\n    }\r\n\r\n    this.sessions.delete(sessionId);\r\n    this.eventBus.emit('session:terminated', { sessionId });\r\n  }\r\n\r\n  async executeWorkflow(workflow: any): Promise<string> {\r\n    const workflowId = `workflow-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    const status: WorkflowStatus = {\r\n      status: 'running',\r\n      progress: 0,\r\n    };\r\n\r\n    this.workflows.set(workflowId, status);\r\n    this.eventBus.emit('workflow:started', { workflowId, workflow });\r\n\r\n    // Simulate workflow execution\r\n    setTimeout(() => {\r\n      status.status = 'completed';\r\n      status.progress = 100;\r\n      this.eventBus.emit('workflow:completed', { workflowId });\r\n    }, 5000);\r\n\r\n    return workflowId;\r\n  }\r\n\r\n  async getWorkflowStatus(workflowId: string): Promise<WorkflowStatus> {\r\n    const status = this.workflows.get(workflowId);\r\n    if (!status) {\r\n      throw new Error(`Workflow ${workflowId} not found`);\r\n    }\r\n    return status;\r\n  }\r\n\r\n  async healthCheck(): Promise<HealthCheckResult> {\r\n    return {\r\n      healthy: this.started,\r\n      memory: true,\r\n      terminalPool: true,\r\n      mcp: this.started,\r\n    };\r\n  }\r\n}\r\n"],"names":["JsonPersistenceManager","Orchestrator","agents","Map","tasks","sessions","persistence","workflows","started","config","eventBus","logger","start","Error","info","initialize","loadFromPersistence","emit","timestamp","Date","persistedAgents","getActiveAgents","agent","set","id","type","name","status","assignedTasks","createdAt","persistedTasks","getActiveTasks","task","description","progress","assignedAgent","error","size","stop","clear","close","spawnAgent","profile","agentId","now","Math","random","toString","substr","saveAgent","capabilities","systemPrompt","maxConcurrentTasks","priority","terminateAgent","get","updateAgentStatus","delete","reason","Array","from","values","getAgentInfo","submitTask","taskId","taskInfo","saveTask","dependencies","metadata","availableAgents","filter","a","length","push","updateTaskStatus","getTaskQueue","getTaskStatus","cancelTask","getActiveSessions","terminateSession","sessionId","session","executeWorkflow","workflow","workflowId","setTimeout","getWorkflowStatus","healthCheck","healthy","memory","terminalPool","mcp"],"mappings":"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"}
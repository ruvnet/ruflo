{"version":3,"sources":["../../../src/mcp/tool-filter.ts"],"sourcesContent":["/**\n * MCP Tool Filtering Implementation\n *\n * Provides configurable tool filtering for MCP servers to meet platform\n * tool limits (e.g., Cursor's limit on total tools across MCP servers).\n *\n * Supports:\n * - Allowlist mode: Only include tools that match patterns\n * - Denylist mode: Exclude tools that match patterns\n * - Glob pattern matching using minimatch (e.g., 'system/*', 'agents/spawn')\n * - Category-based filtering\n * - Maximum tool limiting with priority-based ordering\n * - Caching of filter results for performance optimization\n */\n\nimport { minimatch } from 'minimatch';\nimport type { MCPTool, MCPToolFilterConfig } from '../utils/types.js';\nimport type { ILogger } from '../core/logger.js';\n\n/**\n * Maximum allowed length for a glob pattern\n * Longer patterns increase regex compilation time and memory usage\n */\nexport const MAX_PATTERN_LENGTH = 200;\n\n/**\n * Result of pattern validation\n */\nexport interface PatternValidationResult {\n  /** Whether the pattern is valid */\n  valid: boolean;\n  /** Reason for invalidity (if invalid) */\n  reason?: string;\n}\n\n/**\n * Patterns that indicate potentially dangerous glob patterns\n * These can cause catastrophic backtracking in regex engines\n */\nconst DANGEROUS_PATTERN_CHECKS: Array<{\n  pattern: RegExp;\n  reason: string;\n}> = [\n  {\n    // Nested double stars: **/**, **/**/*, etc.\n    pattern: /\\*\\*[^/]*\\*\\*/,\n    reason: 'Nested double stars (**/**) can cause catastrophic backtracking',\n  },\n  {\n    // Multiple consecutive double stars: **/**\n    pattern: /\\*\\*\\/\\*\\*\\//,\n    reason: 'Consecutive double star segments (**/**/) can cause performance issues',\n  },\n  {\n    // Triple or more wildcards: ***, ****, etc.\n    pattern: /\\*{3,}/,\n    reason: 'Triple or more consecutive wildcards (***) are not valid glob patterns',\n  },\n  {\n    // Nested quantifiers in character classes that could be exploited\n    pattern: /\\[[^\\]]*\\*[^\\]]*\\*[^\\]]*\\]/,\n    reason: 'Multiple wildcards in character class can cause performance issues',\n  },\n  {\n    // Extremely repetitive patterns like /*/*/*/*/*/*\n    pattern: /(?:\\/\\*){5,}/,\n    reason: 'Excessive repeated wildcard segments can cause performance issues',\n  },\n  {\n    // Alternation with wildcards that could explode: {*,**,***}\n    pattern: /\\{[^}]*\\*[^}]*,[^}]*\\*[^}]*\\}/,\n    reason: 'Alternation with multiple wildcard options can cause performance issues',\n  },\n];\n\n/**\n * Validate a single glob pattern for safety and correctness\n *\n * Checks for:\n * - Non-empty string\n * - Maximum length limit\n * - Potentially dangerous patterns that could cause ReDoS\n *\n * @param pattern - The glob pattern to validate\n * @returns Validation result with reason if invalid\n */\nexport function validateGlobPattern(pattern: unknown): PatternValidationResult {\n  // Check if pattern is a string\n  if (typeof pattern !== 'string') {\n    return {\n      valid: false,\n      reason: `Pattern must be a string, got ${typeof pattern}`,\n    };\n  }\n\n  // Check for empty string\n  if (pattern.length === 0) {\n    return {\n      valid: false,\n      reason: 'Pattern cannot be empty',\n    };\n  }\n\n  // Check for whitespace-only string\n  if (pattern.trim().length === 0) {\n    return {\n      valid: false,\n      reason: 'Pattern cannot be whitespace only',\n    };\n  }\n\n  // Check maximum length\n  if (pattern.length > MAX_PATTERN_LENGTH) {\n    return {\n      valid: false,\n      reason: `Pattern exceeds maximum length of ${MAX_PATTERN_LENGTH} characters (got ${pattern.length})`,\n    };\n  }\n\n  // Check for dangerous patterns that could cause ReDoS\n  for (const check of DANGEROUS_PATTERN_CHECKS) {\n    if (check.pattern.test(pattern)) {\n      return {\n        valid: false,\n        reason: check.reason,\n      };\n    }\n  }\n\n  return { valid: true };\n}\n\n/**\n * Validate an array of glob patterns and return only valid ones\n * Logs warnings for invalid patterns\n *\n * @param patterns - Array of patterns to validate\n * @param logger - Logger for warning messages\n * @param context - Context string for log messages (e.g., 'tools', 'categories')\n * @returns Array of valid patterns\n */\nexport function validateAndFilterPatterns(\n  patterns: unknown[],\n  logger: ILogger,\n  context: string\n): string[] {\n  const validPatterns: string[] = [];\n\n  for (const pattern of patterns) {\n    const result = validateGlobPattern(pattern);\n\n    if (result.valid) {\n      validPatterns.push(pattern as string);\n    } else {\n      logger.warn(`Invalid ${context} pattern skipped: \"${String(pattern)}\"`, {\n        reason: result.reason,\n      });\n    }\n  }\n\n  return validPatterns;\n}\n\n/**\n * Core system tools that should typically not be excluded by maxTools limit\n * These are essential for basic swarm/agent functionality\n */\nconst CORE_SYSTEM_TOOLS = [\n  'system/info',\n  'system/health',\n  'swarm_init',\n  'swarm_status',\n  'agent_spawn',\n  'agent_list',\n];\n\n/**\n * Statistics about tool filtering operations\n */\nexport interface ToolFilterStats {\n  /** Total number of tools before filtering */\n  totalTools: number;\n  /** Number of tools after filtering */\n  filteredTools: number;\n  /** Number of tools excluded by allowlist/denylist filter */\n  excludedTools: number;\n  /** Number of tools excluded by maxTools limit */\n  truncatedTools: number;\n  /** Names of tools excluded by allowlist/denylist filter */\n  excludedToolNames: string[];\n  /** Names of tools excluded by maxTools limit */\n  truncatedToolNames: string[];\n  /** Names of core system tools excluded by maxTools limit */\n  excludedCoreTools: string[];\n  /** Filter mode used */\n  filterMode: 'allowlist' | 'denylist' | 'disabled';\n  /** Whether filtering is enabled */\n  enabled: boolean;\n  /** Timestamp of last filter operation */\n  lastFilterTimestamp: Date | null;\n  /** Number of cache hits (when caching is enabled) */\n  cacheHits: number;\n  /** Number of cache misses (when caching is enabled) */\n  cacheMisses: number;\n}\n\n/**\n * Interface for tool filtering implementations\n */\nexport interface IToolFilter {\n  /**\n   * Check if a tool should be included based on filter configuration\n   * Does not consider maxTools limit - only pattern matching\n   * @param toolName - Name of the tool to check\n   * @returns true if the tool should be included, false otherwise\n   */\n  shouldIncludeTool(toolName: string): boolean;\n\n  /**\n   * Filter a list of tools based on configuration\n   * Applies both pattern filtering and maxTools limiting\n   * @param tools - Array of MCP tools to filter\n   * @returns Filtered array of tools\n   */\n  filterTools(tools: MCPTool[]): MCPTool[];\n\n  /**\n   * Get statistics about the most recent filtering operation\n   * @returns Filter statistics\n   */\n  getFilterStats(): ToolFilterStats;\n\n  /**\n   * Update the filter configuration at runtime\n   * @param config - New filter configuration\n   */\n  updateConfig(config: MCPToolFilterConfig): void;\n\n  /**\n   * Clear the filter results cache\n   * Only relevant when caching is enabled\n   */\n  clearCache(): void;\n}\n\n/**\n * Default tool priorities for common tool categories\n * Higher values indicate higher priority (kept when maxTools limit is reached)\n */\nconst DEFAULT_PRIORITIES: Record<string, number> = {\n  // System tools - highest priority\n  'system/info': 100,\n  'system/health': 100,\n\n  // Core agent operations\n  'agents/spawn': 90,\n  'agents/list': 90,\n  'agents/status': 85,\n\n  // Core task operations\n  'tasks/create': 90,\n  'tasks/status': 85,\n  'tasks/list': 80,\n\n  // Core memory operations\n  'memory/store': 85,\n  'memory/retrieve': 85,\n  'memory/search': 80,\n\n  // Swarm coordination\n  'swarm/init': 80,\n  'swarm/status': 75,\n};\n\n/**\n * Default priority for tools not in the priority map\n */\nconst DEFAULT_TOOL_PRIORITY = 50;\n\n/**\n * Default cache TTL in milliseconds (60 seconds)\n */\nconst DEFAULT_CACHE_TTL = 60000;\n\n/**\n * Cache entry for storing filtered results\n */\ninterface CacheEntry {\n  /** Hash of the input tools (based on tool names) */\n  key: string;\n  /** Filtered result */\n  result: MCPTool[];\n  /** Timestamp when the entry was created */\n  timestamp: number;\n  /** Stats snapshot at cache time */\n  stats: ToolFilterStats;\n}\n\n/**\n * Tool Filter Implementation\n *\n * Filters MCP tools based on configuration settings including\n * allowlist/denylist modes, glob patterns, and priority-based limiting.\n *\n * @example\n * ```typescript\n * const filter = new ToolFilter(\n *   {\n *     enabled: true,\n *     mode: 'allowlist',\n *     tools: ['system/*', 'agents/spawn'],\n *     categories: ['memory'],\n *     maxTools: 20,\n *     priorities: { 'custom/tool': 95 }\n *   },\n *   logger\n * );\n *\n * const filteredTools = filter.filterTools(allTools);\n * const stats = filter.getFilterStats();\n * ```\n */\nexport class ToolFilter implements IToolFilter {\n  private config: MCPToolFilterConfig;\n  private logger: ILogger;\n  private stats: ToolFilterStats;\n  private cache: CacheEntry | null = null;\n  private cacheHits = 0;\n  private cacheMisses = 0;\n\n  /**\n   * Create a new ToolFilter instance\n   * @param config - Filter configuration (or undefined for no filtering)\n   * @param logger - Logger instance for debugging and info output\n   */\n  constructor(config: MCPToolFilterConfig | undefined, logger: ILogger) {\n    this.logger = logger;\n    this.config = config ?? {\n      enabled: false,\n      mode: 'allowlist',\n      tools: [],\n    };\n\n    // Validate and filter patterns during construction\n    if (this.config.enabled) {\n      this.config = this.validateConfigPatterns(this.config);\n    }\n\n    this.stats = this.createEmptyStats();\n\n    if (this.config.enabled) {\n      this.logger.info('Tool filter initialized', {\n        mode: this.config.mode,\n        toolPatterns: this.config.tools.length,\n        categories: this.config.categories?.length ?? 0,\n        maxTools: this.config.maxTools,\n        cacheEnabled: this.config.enableCache ?? false,\n        cacheTtl: this.config.cacheTtl ?? DEFAULT_CACHE_TTL,\n      });\n    } else {\n      this.logger.debug('Tool filtering disabled');\n    }\n  }\n\n  /**\n   * Validate and filter patterns in the configuration\n   * Returns a new config with only valid patterns\n   */\n  private validateConfigPatterns(config: MCPToolFilterConfig): MCPToolFilterConfig {\n    const validatedConfig = { ...config };\n\n    // Validate tool patterns\n    if (config.tools && config.tools.length > 0) {\n      validatedConfig.tools = validateAndFilterPatterns(config.tools, this.logger, 'tool');\n    }\n\n    // Validate category patterns\n    if (config.categories && config.categories.length > 0) {\n      validatedConfig.categories = validateAndFilterPatterns(\n        config.categories,\n        this.logger,\n        'category'\n      );\n    }\n\n    return validatedConfig;\n  }\n\n  /**\n   * Generate a cache key from an array of tools based on their names\n   * @param tools - Array of MCP tools\n   * @returns A string hash representing the tool set\n   */\n  private generateCacheKey(tools: MCPTool[]): string {\n    // Sort tool names for consistent hashing regardless of input order\n    const sortedNames = tools.map((t) => t.name).sort();\n    return sortedNames.join('|');\n  }\n\n  /**\n   * Check if a cached result is still valid\n   * @param key - Cache key to check\n   * @returns true if cache is valid, false if stale or missing\n   */\n  private isCacheValid(key: string): boolean {\n    if (!this.cache) {\n      return false;\n    }\n\n    if (this.cache.key !== key) {\n      return false;\n    }\n\n    const ttl = this.config.cacheTtl ?? DEFAULT_CACHE_TTL;\n    const elapsed = Date.now() - this.cache.timestamp;\n    return elapsed < ttl;\n  }\n\n  /**\n   * Create empty statistics object with current configuration state\n   */\n  private createEmptyStats(): ToolFilterStats {\n    return {\n      totalTools: 0,\n      filteredTools: 0,\n      excludedTools: 0,\n      truncatedTools: 0,\n      excludedToolNames: [],\n      truncatedToolNames: [],\n      excludedCoreTools: [],\n      filterMode: this.config.enabled ? this.config.mode : 'disabled',\n      enabled: this.config.enabled,\n      lastFilterTimestamp: null,\n      cacheHits: this.cacheHits,\n      cacheMisses: this.cacheMisses,\n    };\n  }\n\n  /**\n   * Check if a tool name matches any pattern in a list using minimatch\n   * @param toolName - Tool name to check\n   * @param patterns - Array of patterns (exact names or globs)\n   * @returns true if any pattern matches\n   */\n  private matchesPatterns(toolName: string, patterns: string[]): boolean {\n    for (const pattern of patterns) {\n      // Check for exact match first (faster)\n      if (pattern === toolName) {\n        return true;\n      }\n\n      // Check glob pattern match using minimatch\n      if (minimatch(toolName, pattern, { nocase: false })) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Check if a tool matches any category pattern\n   * Categories match tool name prefixes with common separators\n   * @param toolName - Tool name to check\n   * @param categories - Array of category prefixes\n   * @returns true if tool belongs to any category\n   */\n  private matchesCategories(toolName: string, categories: string[]): boolean {\n    for (const category of categories) {\n      // Category matches if tool name starts with \"category/\" or \"category_\" or \"category-\"\n      if (\n        toolName.startsWith(`${category}/`) ||\n        toolName.startsWith(`${category}_`) ||\n        toolName.startsWith(`${category}-`)\n      ) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Get priority for a tool, used for ordering when maxTools limit applies\n   * @param toolName - Tool name\n   * @returns Priority value (higher = more important, kept first when truncating)\n   */\n  private getToolPriority(toolName: string): number {\n    // Check configured priorities first\n    if (this.config.priorities?.[toolName] !== undefined) {\n      return this.config.priorities[toolName];\n    }\n\n    // Fall back to default priorities\n    if (DEFAULT_PRIORITIES[toolName] !== undefined) {\n      return DEFAULT_PRIORITIES[toolName];\n    }\n\n    // Extract category for category-based default priority\n    const category = toolName.split(/[/_-]/)[0];\n    const categoryPriorities = Object.entries(DEFAULT_PRIORITIES)\n      .filter(([key]) => key.startsWith(`${category}/`))\n      .map(([, value]) => value);\n\n    if (categoryPriorities.length > 0) {\n      // Return slightly lower than explicit category tools\n      return Math.min(...categoryPriorities) - 5;\n    }\n\n    return DEFAULT_TOOL_PRIORITY;\n  }\n\n  /**\n   * Check if a single tool should be included based on filter rules\n   * Does not consider maxTools limit - only pattern/category matching\n   */\n  shouldIncludeTool(toolName: string): boolean {\n    // If filtering is disabled, include all tools\n    if (!this.config.enabled) {\n      return true;\n    }\n\n    const { mode, tools, categories } = this.config;\n\n    // Check tool patterns\n    const matchesToolPattern = tools.length > 0 && this.matchesPatterns(toolName, tools);\n\n    // Check category patterns\n    const matchesCategory =\n      categories && categories.length > 0 && this.matchesCategories(toolName, categories);\n\n    // Combine matches - tool is matched if it matches patterns OR categories\n    const matches = matchesToolPattern || matchesCategory;\n\n    if (mode === 'allowlist') {\n      // In allowlist mode: include only if matches\n      return matches;\n    } else {\n      // In denylist mode: include only if NOT matches\n      return !matches;\n    }\n  }\n\n  /**\n   * Filter an array of tools based on configuration\n   * Applies pattern filtering first, then maxTools limit if configured\n   */\n  filterTools(tools: MCPTool[]): MCPTool[] {\n    // Check cache first if caching is enabled\n    if (this.config.enableCache) {\n      const cacheKey = this.generateCacheKey(tools);\n      if (this.isCacheValid(cacheKey)) {\n        this.cacheHits++;\n        this.stats = {\n          ...this.cache!.stats,\n          cacheHits: this.cacheHits,\n          cacheMisses: this.cacheMisses,\n        };\n        this.stats.lastFilterTimestamp = new Date();\n        this.logger.debug('Cache hit for tool filter', {\n          cacheKey: cacheKey.substring(0, 50) + '...',\n          resultCount: this.cache!.result.length,\n        });\n        return this.cache!.result;\n      }\n      this.cacheMisses++;\n    }\n\n    // Reset stats for this operation\n    this.stats = this.createEmptyStats();\n    this.stats.totalTools = tools.length;\n    this.stats.lastFilterTimestamp = new Date();\n\n    // If filtering is disabled, return all tools\n    if (!this.config.enabled) {\n      this.stats.filteredTools = tools.length;\n      this.logger.debug('Tool filtering disabled, returning all tools', {\n        count: tools.length,\n      });\n      return tools;\n    }\n\n    this.logger.debug('Filtering tools', {\n      mode: this.config.mode,\n      toolPatterns: this.config.tools,\n      categories: this.config.categories,\n      maxTools: this.config.maxTools,\n    });\n\n    // Step 1: Apply allowlist/denylist filtering\n    const filteredByPattern: MCPTool[] = [];\n    const excludedByPattern: string[] = [];\n\n    for (const tool of tools) {\n      if (this.shouldIncludeTool(tool.name)) {\n        filteredByPattern.push(tool);\n      } else {\n        excludedByPattern.push(tool.name);\n      }\n    }\n\n    this.stats.excludedToolNames = excludedByPattern;\n    this.stats.excludedTools = excludedByPattern.length;\n\n    this.logger.debug('Pattern filtering complete', {\n      included: filteredByPattern.length,\n      excluded: excludedByPattern.length,\n    });\n\n    // Log excluded tools at INFO level for user visibility\n    if (excludedByPattern.length > 0) {\n      const maxToolsToShow = 10;\n      const toolsToShow = excludedByPattern.slice(0, maxToolsToShow);\n      const remaining = excludedByPattern.length - maxToolsToShow;\n\n      let excludedMessage = toolsToShow.join(', ');\n      if (remaining > 0) {\n        excludedMessage += `, ... and ${remaining} more`;\n      }\n\n      this.logger.info(`Excluded tools by pattern filter: ${excludedMessage}`);\n    }\n\n    // Step 2: Apply maxTools limit with priority ordering\n    let result = filteredByPattern;\n\n    if (this.config.maxTools !== undefined && filteredByPattern.length > this.config.maxTools) {\n      // Sort by priority (descending), then by name for stable ordering\n      const toolsWithPriority = filteredByPattern.map((tool) => ({\n        tool,\n        priority: this.getToolPriority(tool.name),\n      }));\n\n      toolsWithPriority.sort((a, b) => {\n        if (b.priority !== a.priority) {\n          return b.priority - a.priority;\n        }\n        return a.tool.name.localeCompare(b.tool.name);\n      });\n\n      // Take top N tools based on maxTools limit\n      const keptTools = toolsWithPriority.slice(0, this.config.maxTools);\n      const truncatedTools = toolsWithPriority.slice(this.config.maxTools);\n\n      this.stats.truncatedToolNames = truncatedTools.map((t) => t.tool.name);\n      this.stats.truncatedTools = truncatedTools.length;\n\n      // Check for excluded core system tools\n      this.stats.excludedCoreTools = this.stats.truncatedToolNames.filter((toolName) =>\n        CORE_SYSTEM_TOOLS.includes(toolName)\n      );\n\n      result = keptTools.map((t) => t.tool);\n\n      this.logger.warn('Applied maxTools limit', {\n        maxTools: this.config.maxTools,\n        originalCount: filteredByPattern.length,\n        resultCount: result.length,\n        truncatedCount: this.stats.truncatedTools,\n      });\n\n      // Warn if core system tools were excluded\n      if (this.stats.excludedCoreTools.length > 0) {\n        this.logger.warn(\n          `Warning: maxTools limit excluded core system tools: [${this.stats.excludedCoreTools.join(', ')}]. Consider increasing maxTools or adding these to priorities.`\n        );\n      }\n    }\n\n    this.stats.filteredTools = result.length;\n\n    // Log summary at INFO level with clear format for user visibility\n    const modeLabel = this.config.mode === 'allowlist' ? 'allowlist' : 'denylist';\n    const patternsCount = this.config.tools.length + (this.config.categories?.length ?? 0);\n\n    this.logger.info(\n      `Tool filter applied (${modeLabel} mode): ${result.length} tools included, ${this.stats.excludedTools} excluded by pattern` +\n      (this.stats.truncatedTools > 0 ? `, ${this.stats.truncatedTools} truncated by maxTools limit` : '')\n    );\n\n    this.logger.debug('Tool filtering complete', {\n      total: this.stats.totalTools,\n      filtered: this.stats.filteredTools,\n      excluded: this.stats.excludedTools,\n      truncated: this.stats.truncatedTools,\n      patternsMatched: patternsCount,\n    });\n\n    // Store in cache if caching is enabled\n    if (this.config.enableCache) {\n      const cacheKey = this.generateCacheKey(tools);\n      this.cache = {\n        key: cacheKey,\n        result,\n        timestamp: Date.now(),\n        stats: { ...this.stats },\n      };\n      this.logger.debug('Cached filter result', {\n        cacheKey: cacheKey.substring(0, 50) + '...',\n        resultCount: result.length,\n        ttl: this.config.cacheTtl ?? DEFAULT_CACHE_TTL,\n      });\n    }\n\n    return result;\n  }\n\n  /**\n   * Get statistics from the most recent filter operation\n   * Returns a copy to prevent external modification\n   */\n  getFilterStats(): ToolFilterStats {\n    return {\n      ...this.stats,\n      excludedToolNames: [...this.stats.excludedToolNames],\n      truncatedToolNames: [...this.stats.truncatedToolNames],\n      excludedCoreTools: [...this.stats.excludedCoreTools],\n    };\n  }\n\n  /**\n   * Update the filter configuration at runtime\n   * Resets statistics and re-initializes with new config\n   * Invalidates the cache when configuration changes\n   */\n  updateConfig(config: MCPToolFilterConfig): void {\n    // Validate and filter patterns\n    this.config = config.enabled ? this.validateConfigPatterns(config) : config;\n    this.stats = this.createEmptyStats();\n    // Invalidate cache when config changes\n    this.clearCache();\n\n    this.logger.info('Tool filter configuration updated', {\n      enabled: this.config.enabled,\n      mode: this.config.mode,\n      toolPatterns: this.config.tools.length,\n      categories: this.config.categories?.length ?? 0,\n      maxTools: this.config.maxTools,\n      cacheEnabled: this.config.enableCache ?? false,\n      cacheTtl: this.config.cacheTtl ?? DEFAULT_CACHE_TTL,\n    });\n  }\n\n  /**\n   * Clear the filter results cache\n   * Resets cache entry and cache statistics\n   */\n  clearCache(): void {\n    if (this.cache) {\n      this.logger.debug('Clearing filter cache', {\n        previousHits: this.cacheHits,\n        previousMisses: this.cacheMisses,\n      });\n    }\n    this.cache = null;\n    this.cacheHits = 0;\n    this.cacheMisses = 0;\n  }\n}\n\n/**\n * Factory function to create a ToolFilter instance\n *\n * @param config - Filter configuration (optional, defaults to disabled filtering)\n * @param logger - Logger instance for output\n * @returns Configured IToolFilter instance\n *\n * @example\n * ```typescript\n * // Create with allowlist configuration\n * const filter = createToolFilter(\n *   {\n *     enabled: true,\n *     mode: 'allowlist',\n *     tools: ['system/*', 'agents/spawn', 'memory/*'],\n *     maxTools: 20\n *   },\n *   logger\n * );\n *\n * // Filter tools\n * const filteredTools = filter.filterTools(allTools);\n *\n * // Check statistics\n * const stats = filter.getFilterStats();\n * console.log(`Filtered ${stats.excludedTools} tools`);\n * ```\n *\n * @example\n * ```typescript\n * // Create with denylist configuration\n * const filter = createToolFilter(\n *   {\n *     enabled: true,\n *     mode: 'denylist',\n *     tools: ['debug/*', 'experimental/*'],\n *     categories: ['internal']\n *   },\n *   logger\n * );\n * ```\n */\nexport function createToolFilter(\n  config: MCPToolFilterConfig | undefined,\n  logger: ILogger\n): IToolFilter {\n  return new ToolFilter(config, logger);\n}\n"],"names":["minimatch","MAX_PATTERN_LENGTH","DANGEROUS_PATTERN_CHECKS","pattern","reason","validateGlobPattern","valid","length","trim","check","test","validateAndFilterPatterns","patterns","logger","context","validPatterns","result","push","warn","String","CORE_SYSTEM_TOOLS","DEFAULT_PRIORITIES","DEFAULT_TOOL_PRIORITY","DEFAULT_CACHE_TTL","ToolFilter","config","stats","cache","cacheHits","cacheMisses","enabled","mode","tools","validateConfigPatterns","createEmptyStats","info","toolPatterns","categories","maxTools","cacheEnabled","enableCache","cacheTtl","debug","validatedConfig","generateCacheKey","sortedNames","map","t","name","sort","join","isCacheValid","key","ttl","elapsed","Date","now","timestamp","totalTools","filteredTools","excludedTools","truncatedTools","excludedToolNames","truncatedToolNames","excludedCoreTools","filterMode","lastFilterTimestamp","matchesPatterns","toolName","nocase","matchesCategories","category","startsWith","getToolPriority","priorities","undefined","split","categoryPriorities","Object","entries","filter","value","Math","min","shouldIncludeTool","matchesToolPattern","matchesCategory","matches","filterTools","cacheKey","substring","resultCount","count","filteredByPattern","excludedByPattern","tool","included","excluded","maxToolsToShow","toolsToShow","slice","remaining","excludedMessage","toolsWithPriority","priority","a","b","localeCompare","keptTools","includes","originalCount","truncatedCount","modeLabel","patternsCount","total","filtered","truncated","patternsMatched","getFilterStats","updateConfig","clearCache","previousHits","previousMisses","createToolFilter"],"mappings":"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"}